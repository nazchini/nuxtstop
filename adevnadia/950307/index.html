<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>How to write performant React code: rules, patterns, do's and don'ts</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="Using Nuxt.js fetch() hook to build dev.to with a new look"><meta data-n-head="ssr" name="format-detection" content="telephone=no"><base href="/nuxtstop/"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,500,600&display=swap"><link rel="preload" href="/nuxtstop/_nuxt/f6e87fb.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/6474719.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/9b75090.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/18df600.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/dc9ce94.js" as="script"><style data-vue-ssr-id="c650fd98:0 af4684f0:0 a9c71758:0 dcafa518:0 4b9cec49:0 b093d766:0 9d98bcb4:0 6b6a11ea:0 0248ed80:0 ea8e4264:0">html{box-sizing:border-box;font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}*,:after,:before{box-sizing:inherit}html{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}*,:after,:before{border:0 solid #e0e0e0}blockquote,body,dd,dl,figure,h1,h2,h3,h4,h5,h6,p,pre{margin:0}button{background:0 0;padding:0}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}hr{border-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:inherit;opacity:.5}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:inherit;opacity:.5}input::placeholder,textarea::placeholder{color:inherit;opacity:.5}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit;font-family:sans-serif}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit;font-family:inherit;font-size:100%}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;overflow:auto;word-break:break-word;white-space:normal}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}html{height:100%;font-size:18px;-ms-overflow-style:scrollbar;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}@media(min-width:640px){html{font-size:20px}}body{height:100%;min-width:320px;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:400;line-height:1.5;color:#000;background-color:#eff4f7;-webkit-text-rendering:optimizeLegibility;text-rendering:optimizeLegibility;font-synthesis:none;font-kerning:normal;font-feature-settings:"normal","kern";-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-overflow-scrolling:touch;overflow-x:hidden;overflow-y:scroll}h1,h2,h3,h4,h5,h6{color:#000;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:600;font-feature-settings:"normal";line-height:1.2}pre{background:#29292e;border-radius:2px;overflow:auto;padding:1rem;color:#eff1f9;line-height:1.42em;font-size:13px}@media screen and (min-width:380px){pre{font-size:15px}}pre code{background:#29292e;color:#eff0f9;white-space:pre}div.highlight pre.highlight code{font-size:inherit;padding:0}div.inner-comment div.body div.highlight pre.highlight{background:#29292e}div.inner-comment div.body div.highlight pre.highlight code{font-size:inherit;white-space:inherit;background:inherit;color:inherit}.highlight .hll{background-color:#49483e}.highlight{background:#29292e;color:#f8f8f2}.highlight .c{color:grey}.highlight .err{text-shadow:0 0 7px #f9690e}.highlight .k{color:#f39c12}.highlight .l{color:plum}.highlight .n{color:#f8f8f2}.highlight .o{color:#f9690e}.highlight .p{color:#f8f8f2}.highlight .c1,.highlight .ch,.highlight .cm,.highlight .cp,.highlight .cpf,.highlight .cs{color:grey}.highlight .gd{color:#f9690e}.highlight .ge{font-style:italic}.highlight .gi{color:#7ed07e}.highlight .gs{font-weight:700}.highlight .gu{color:grey}.highlight .kc,.highlight .kd{color:#f39c12}.highlight .kn{color:#f9690e}.highlight .kp,.highlight .kr,.highlight .kt{color:#f39c12}.highlight .ld{color:#f2ca27}.highlight .m{color:plum}.highlight .s{color:#f2ca27}.highlight .na{color:#7ed07e}.highlight .nb{color:#f8f8f2}.highlight .nc{color:#7ed07e}.highlight .no{color:#f39c12}.highlight .nd{color:#7ed07e}.highlight .ni{color:#f8f8f2}.highlight .ne,.highlight .nf{color:#7ed07e}.highlight .nl,.highlight .nn{color:#f8f8f2}.highlight .nx{color:#7ed07e}.highlight .py{color:#f8f8f2}.highlight .nt{color:#f9690e}.highlight .nv{color:#f8f8f2}.highlight .ow{color:#f9690e}.highlight .w{color:#f8f8f2}.highlight .mb,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo{color:plum}.highlight .dl,.highlight .s2,.highlight .sa,.highlight .sb,.highlight .sc,.highlight .sd{color:#f2ca27}.highlight .se{color:plum}.highlight .s1,.highlight .sh,.highlight .si,.highlight .sr,.highlight .ss,.highlight .sx{color:#f2ca27}.highlight .bp{color:#f8f8f2}.highlight .fm{color:#7ed07e}.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{color:#f8f8f2}.highlight .il{color:plum}.vue-content-placeholders-heading__img,.vue-content-placeholders-heading__subtitle,.vue-content-placeholders-heading__title,.vue-content-placeholders-img,.vue-content-placeholders-text__line{background:#bfcdec!important}.vue-content-placeholders-is-animated .vue-content-placeholders-heading__img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__subtitle:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__title:before,.vue-content-placeholders-is-animated .vue-content-placeholders-img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-text__line:before{background:linear-gradient(90deg,transparent 0,#d3ddf9 15%,transparent 30%)!important}header[data-v-27046cca]{max-width:1280px;margin:auto;padding:1rem;height:6rem;border-bottom:1px solid rgba(0,0,0,.2)}header .logo-wrapper[data-v-27046cca],header[data-v-27046cca]{display:flex;align-items:center;justify-content:space-between}header .logo-wrapper[data-v-27046cca]{margin:0 .5rem}header .logo-wrapper svg[data-v-27046cca]{width:3rem;height:100%}header .logo-wrapper .name-wrapper[data-v-27046cca]{margin-left:.6em}header .logo-wrapper .name-wrapper .subtitle[data-v-27046cca]{font-size:1rem}header .logo-wrapper .name-wrapper .app-name[data-v-27046cca]{font-weight:700;font-size:2.25rem;line-height:1.25}header nav[data-v-27046cca]{letter-spacing:-.025rem;font-weight:600;text-transform:uppercase}header nav ul[data-v-27046cca]{display:flex}header nav ul li[data-v-27046cca]{margin:0 .5rem}header nav ul li a[data-v-27046cca]{box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;padding:.25rem 1rem;border-radius:.5rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}header nav ul li a[data-v-27046cca]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header nav ul li a.nuxt-link-exact-active[data-v-27046cca]{cursor:default}header nav ul li a.nuxt-link-exact-active[data-v-27046cca],header nav ul li a[data-v-27046cca]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}.page-wrapper[data-v-10d06ee8]{max-width:1280px;margin:auto;padding:1rem}.article-content-wrapper[data-v-10d06ee8]{display:flex;flex-direction:column;align-items:center;margin:auto auto 2rem}@media(min-width:1024px){.article-content-wrapper[data-v-10d06ee8]{align-items:normal;flex-direction:row}}.article-content-wrapper .article-block[data-v-10d06ee8]{width:100%;max-width:880px}@media(min-width:1024px){.article-content-wrapper .article-block[data-v-10d06ee8]{margin-right:1rem;width:66.66666%;margin-bottom:2rem}}.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{max-width:880px;width:100%;position:relative}@media(min-width:1024px){.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{display:block;width:33.33333%}}.article-content-wrapper .aside-username-wrapper .aside-username-block[data-v-10d06ee8]{position:-webkit-sticky;position:sticky;top:1rem}@media(min-width:1280px){.comments-block[data-v-10d06ee8]{margin:.5rem}}article[data-v-70afb46a]{padding:.5rem;border-radius:1rem}header h1[data-v-70afb46a],header[data-v-70afb46a]{margin-bottom:1rem}header h1[data-v-70afb46a]{font-size:2.25rem;letter-spacing:-.025rem}header .tags[data-v-70afb46a]{display:flex;flex-wrap:wrap;margin-bottom:1.5rem}header .tags .tag[data-v-70afb46a]{font-weight:500;line-height:1;padding:.5rem;margin:0 .5rem .5rem 0;border-radius:.25rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db}header .tags .tag[data-v-70afb46a]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header .tags .tag[data-v-70afb46a]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}header .image-wrapper[data-v-70afb46a]{position:relative;padding-bottom:56.25%;background-color:#d4dfe8;margin-bottom:1.5rem;border-radius:.5rem;overflow:hidden}@media(min-width:834px){header .image-wrapper[data-v-70afb46a]{margin-bottom:1.5rem}}header .image-wrapper img[data-v-70afb46a]{position:absolute;top:0;left:0;width:100%;height:100%;-o-object-fit:cover;object-fit:cover}header .meta[data-v-70afb46a]{line-height:1;font-size:.875rem;text-transform:uppercase;font-weight:500;letter-spacing:-.025rem;display:flex;align-items:center;justify-content:space-between}header .meta .scl[data-v-70afb46a]{display:flex}header .meta .scl span[data-v-70afb46a]{display:flex;align-items:center;margin-right:1rem}header .meta .scl span svg[data-v-70afb46a]{margin-right:.25rem}header .meta .scl .comments[data-v-70afb46a]{cursor:pointer}[data-v-70afb46a] .content .ltag__user{display:none}[data-v-70afb46a] .content iframe{max-width:100%}[data-v-70afb46a] .content h1{font-size:1.875rem}[data-v-70afb46a] .content h1,[data-v-70afb46a] .content h2{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h2{font-size:1.5rem}[data-v-70afb46a] .content h3{font-size:1.25rem}[data-v-70afb46a] .content h3,[data-v-70afb46a] .content h4{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h4{font-size:1rem}[data-v-70afb46a] .content a{color:#6e87d2}[data-v-70afb46a] .content p{margin-bottom:1rem;line-height:1.4}[data-v-70afb46a] .content p code{background-color:#d2f3e1;border-radius:.25rem;padding:.25rem}[data-v-70afb46a] .content img{width:100%;border-radius:.5rem}[data-v-70afb46a] .content .highlight{margin-bottom:1rem;border-radius:.5rem}[data-v-70afb46a] .content ul{list-style:numeral;margin-bottom:1rem}[data-v-70afb46a] .content ul li p{margin-bottom:0}[data-v-70afb46a] .content ol{margin-bottom:1rem}aside[data-v-37984f8c]{padding:1rem;background-color:#dfe8ef;border-radius:1rem}aside .username-heading[data-v-37984f8c]{display:flex;margin-bottom:1rem}aside .username-heading[data-v-37984f8c]:hover{color:#6e87d2}aside .username-heading img[data-v-37984f8c]{width:3rem;height:3rem;border-radius:50%;margin-right:1rem}aside .username-heading .text[data-v-37984f8c]{display:flex;flex-direction:column;justify-content:center}aside .username-heading .text a[data-v-37984f8c]{line-height:1}aside .username-heading .text a[data-v-37984f8c]:first-child{font-size:1.25rem;font-weight:500;letter-spacing:-.025rem;margin-bottom:.25rem}aside .username-heading .text a[data-v-37984f8c]:last-child{color:#999;font-size:.875rem}aside .username-heading.loading[data-v-37984f8c]{display:block}aside .f-button[data-v-37984f8c]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}aside .f-button[data-v-37984f8c]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}aside .f-button[data-v-37984f8c]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}aside .info>div[data-v-37984f8c]{margin-bottom:.5rem}aside .info .title[data-v-37984f8c]{font-size:.666666rem;letter-spacing:-.0125rem;font-weight:500;color:#999;text-transform:uppercase;margin-bottom:.1rem}aside .info .content[data-v-37984f8c]{font-size:.875rem;line-height:1.4}.add-comment[data-v-8c4375bc]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}.add-comment[data-v-8c4375bc]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}.add-comment[data-v-8c4375bc]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}footer[data-v-22cb8fd0]{padding:2rem;text-align:center;display:flex;align-items:center;justify-content:center}footer span[data-v-22cb8fd0]{display:inline-block;line-height:1;text-transform:uppercase;letter-spacing:-.025rem;font-size:.75rem;font-weight:500}footer a svg[data-v-22cb8fd0]{width:3rem;height:3rem;margin:0 .5rem}footer a .nuxt-icon[data-v-22cb8fd0]{width:2.5rem;height:2.5rem;margin:0 .25rem}</style>
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><div id="__layout"><div><header data-v-27046cca><a href="/nuxtstop/" class="logo-wrapper nuxt-link-active" data-v-27046cca><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-27046cca><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-27046cca></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-27046cca></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-27046cca></path></svg> <div class="name-wrapper" data-v-27046cca><span class="app-name" data-v-27046cca>Nuxtstop</span> <p class="subtitle" data-v-27046cca>For all things nuxt.js</p></div></a> <nav data-v-27046cca><ul data-v-27046cca><li data-v-27046cca><a href="/nuxtstop/" class="nuxt-link-active" data-v-27046cca>
          New
        </a></li><li data-v-27046cca><a href="/nuxtstop/top" data-v-27046cca>
          Top
        </a></li></ul></nav></header> <div class="page-wrapper" data-v-10d06ee8><div class="article-content-wrapper" data-v-10d06ee8><article data-fetch-key="data-v-70afb46a:0" class="article-block" data-v-70afb46a data-v-10d06ee8><header data-v-70afb46a><h1 data-v-70afb46a>How to write performant React code: rules, patterns, do's and don'ts</h1> <div class="tags" data-v-70afb46a><a href="/nuxtstop/t/react" class="tag" data-v-70afb46a>
          #react
        </a><a href="/nuxtstop/t/performance" class="tag" data-v-70afb46a>
          #performance
        </a><a href="/nuxtstop/t/webdev" class="tag" data-v-70afb46a>
          #webdev
        </a><a href="/nuxtstop/t/javascript" class="tag" data-v-70afb46a>
          #javascript
        </a></div> <!----> <div class="meta" data-v-70afb46a><div class="scl" data-v-70afb46a><span data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M16.4444 3C14.6733 3 13.0333 3.94162 12 5.34C10.9667 3.94162 9.32667 3 7.55556 3C4.49222 3 2 5.52338 2 8.625C2 14.8024 11.0267 20.586 11.4122 20.829C11.5922 20.9426 11.7956 21 12 21C12.2044 21 12.4078 20.9426 12.5878 20.829C12.9733 20.586 22 14.8024 22 8.625C22 5.52338 19.5078 3 16.4444 3Z" fill="#FF0000" data-v-70afb46a data-v-70afb46a></path></svg>
            93
          </span> <span class="comments" data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M6.11765 22H4.94118L5.64706 21.05C6.11765 20.3969 6.41176 19.5656 6.58824 18.5563C3.64706 17.1906 2 14.6375 2 11.3125C2 6.20625 5.82353 3 12 3C18.1765 3 22 6.20625 22 11.3125C22 16.5375 18.2353 19.625 12 19.625H11.5882C10.6471 20.7531 9 22 6.11765 22ZM12 4.1875C6.47059 4.1875 3.17647 6.85937 3.17647 11.3125C3.17647 15.1125 5.47059 16.8938 7.41177 17.6656L7.82353 17.8437L7.76471 18.3187C7.64706 19.2687 7.47059 20.1 7.11765 20.8125C9.05882 20.575 10.1765 19.5656 10.8235 18.7344L11 18.4969H12C19.9412 18.4969 20.8235 13.5094 20.8235 11.3719C20.8235 6.85938 17.5294 4.1875 12 4.1875Z" fill="black" data-v-70afb46a data-v-70afb46a></path></svg>
            9
          </span></div> <time data-v-70afb46a>Jan 10</time></div></header> <div class="content" data-v-70afb46a><p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--iAK9mjMw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/tr0t9ogsikrkl2rqgr3p.jpg" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--iAK9mjMw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/tr0t9ogsikrkl2rqgr3p.jpg" alt="Image description" loading="lazy" width="500" height="320"></a></p>

<p>Performance and React! Such a fun topic with so many controversial opinions and so many best practices flipping to be the opposite in just 6 months. Is it even possible to say anything definitive here or to make any generalized recommendations?</p>

<p>Usually, performance experts are the proponents of “premature optimisation is the root of all evil” and “measure first” rules. Which loosely translates into “don’t fix that is not broken” and is quite hard to argue with. But I’m going to anyway 😉</p>

<p>What I like about React, is that it makes implementing complicated UI interactions incredibly easy. What I don’t like about React, is that it also makes it incredibly easy to make mistakes with huge consequences that are not visible right away. The good news is, it’s also incredibly easy to prevent those mistakes and write code that is performant most of the time right away, thus significantly reducing the time and effort it takes to investigate performance problems since there will be much fewer of those. Basically, “premature optimisation”, when it comes to React and performance, can actually be a good thing and something that everyone should do 😉. You just need to know a few patterns to watch out for in order to do that meaningfully.</p>

<p>So this is exactly what I want to prove in this article 😊. I’m going to do that by implementing a “real-life” app step by step, first in a “normal” way, using the patterns that you’ll see practically everywhere and surely used multiple times by yourself. And then refactor each step with performance in mind, and extract a generalized rule from every step that can be applied to most apps most of the time. And then compare the result in the end.</p>

<p>Let’s begin!</p>

<p>We are going to write one of the “settings” page for an online shop (that we introduced into the previous “Advanced typescript for React developers” articles). On this page, users will be able to select a country from the list, see all the information available for this country (like currency, delivery methods, etc), and then save this country as their country of choice. The page would look something like this:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--NcFGI_IF--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/8mjrlrsd6ru0hawgdiwr.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--NcFGI_IF--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/8mjrlrsd6ru0hawgdiwr.png" alt="Image description" loading="lazy" width="880" height="449"></a></p>

<p>On the left we’ll have a list of countries, with “saved” and “selected” states, when an item in the list is clicked, in the column on the right the detailed information is shown. When the “save” button is pressed, the “selected” country becomes “saved”, with the different item colour.</p>

<p>Oh, and we’d want the dark mode there of course, it’s 2022 after all!</p>

<p>Also, considering that in 90% of the cases performance problems in React can be summarised as “too many re-renders”, we are going to focus mostly on reducing those in the article. (Another 10% are: “renders are too heavy” and “really weird stuff that need further investigation”.)</p>

<h2>
  <a name="lets-structure-our-app-first" href="#lets-structure-our-app-first">
  </a>
  Let's structure our app first
</h2>

<p>First of all, let's take a look at the design, draw imaginary boundaries, and draft the structure of our future app and which components we’d need to implement there:</p>

<ul>
<li>a root “Page” component, where we’d handle the “submit” logic and country selection logic</li>
<li>a “List of countries” component, that would render all the countries in a list, and in the future handle things like filtering and sorting</li>
<li>“Item” component, that renders the country in the “List of countries”</li>
<li>a “Selected country” component, that renders detailed information about the selected country and has the “Save” button</li>
</ul>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--906A80Ww--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/5hgwpox2cfo73rad3059.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--906A80Ww--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/5hgwpox2cfo73rad3059.png" alt="Image description" loading="lazy" width="880" height="449"></a></p>

<p>This is, of course, not the only possible way to implement this page, that’s the beauty and the curse of React: everything can be implemented in a million ways and there is no right or wrong answer for anything. But there are some patterns that in the long run in fast-growing or large already apps can definitely be called <strong>“never do this”</strong> or <strong>“this is a must-have”</strong>.</p>

<p>Let’s see whether we can figure them out together 🙂</p>

<h2>
  <a name="implementing-page-component" href="#implementing-page-component">
  </a>
  Implementing Page component
</h2>

<p>Now, finally, the time to get our hands dirty and do some coding. Let’s start from the “root” and implement the Page component.</p>

<p>First: we need a wrapper with some styles that renders page title, “List of countries” and “Selected country” components.</p>

<p>Second: out page should receive the list of countries from somewhere, and then pass it to the <code>CountriesList</code> component so that it could render those.</p>

<p>Third: our page should have an idea of a “selected” country, that will be received from the <code>CountriesList</code> component and passed to the <code>SelectedCountry</code> component.</p>

<p>And finally: our page should have an idea of a “saved” country, that will be received from the <code>SelectedCountry</code> component and passed to the <code>CountriesList</code> component (and be sent to the backend in the future).<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">selectedCountry</span><span class="p">,</span> <span class="nx">setSelectedCountry</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="nx">Country</span><span class="o">></span><span class="p">(</span><span class="nx">countries</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">savedCountry</span><span class="p">,</span> <span class="nx">setSavedCountry</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="nx">Country</span><span class="o">></span><span class="p">(</span><span class="nx">countries</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;></span>
      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">></span>Country settings<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">></span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">css</span><span class="p">=</span><span class="si">{</span><span class="nx">contentCss</span><span class="si">}</span><span class="p">></span>
        <span class="p">&lt;</span><span class="nc">CountriesList</span>
          <span class="na">countries</span><span class="p">=</span><span class="si">{</span><span class="nx">countries</span><span class="si">}</span>
          <span class="na">onCountryChanged</span><span class="p">=</span><span class="si">{</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="o">=></span> <span class="nx">setSelectedCountry</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span><span class="si">}</span>
          <span class="na">savedCountry</span><span class="p">=</span><span class="si">{</span><span class="nx">savedCountry</span><span class="si">}</span>
        <span class="p">/></span>
        <span class="p">&lt;</span><span class="nc">SelectedCountry</span>
          <span class="na">country</span><span class="p">=</span><span class="si">{</span><span class="nx">selectedCountry</span><span class="si">}</span>
          <span class="na">onCountrySaved</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=></span> <span class="nx">setSavedCountry</span><span class="p">(</span><span class="nx">selectedCountry</span><span class="p">)</span><span class="si">}</span>
        <span class="p">/></span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">></span>
    <span class="p">&lt;/></span>
  <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>That is the entire implementation of the “Page” component, it’s the most basic React that you can see everywhere, and there is absolutely nothing criminal in this implementation. Except for one thing. Curious, can you see it?</p>

<h3>
  <a name="refactoring-page-component-with-performance-in-mind" href="#refactoring-page-component-with-performance-in-mind">
  </a>
  Refactoring Page component - with performance in mind
</h3>

<p>I think it is common knowledge by now, that react re-renders components when there is a state or props change. In our Page component when <code>setSelectedCountry</code> or <code>setSavedCountry</code> is called, it will re-render. If the countries array (props) in our Page component changes, it will re-render. And the same goes for <code>CountriesList</code> and <code>SelectedCountry</code> components - when any of their props change, they will re-render.</p>

<p>Also, anyone, who spent some time with React, knows about javascript <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Equality_comparisons_and_sameness">equality comparison</a>, the fact that React does strict equality comparison for props, and the fact that inline functions create new value every time. This leads to the very common (and absolutely wrong btw) belief, that in order to reduce re-renders of <code>CountriesList</code> and <code>SelectedCountry</code> components we need to get rid of re-creating inline functions on every render by wrapping inline functions in <code>useCallback</code>. Even <a href="https://reactjs.org/docs/hooks-reference.html#usecallback">React docs</a> mention <code>useCallback</code> in the same sentence with “prevent unnecessary renders”! See whether this pattern looks familiar:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
  <span class="c1">// ... same as before</span>

  <span class="kd">const</span> <span class="nx">onCountryChanged</span> <span class="o">=</span> <span class="nx">useCallback</span><span class="p">((</span><span class="nx">c</span><span class="p">)</span> <span class="o">=></span> <span class="nx">setSelectedCountry</span><span class="p">(</span><span class="nx">c</span><span class="p">),</span> <span class="p">[]);</span>
  <span class="kd">const</span> <span class="nx">onCountrySaved</span> <span class="o">=</span> <span class="nx">useCallback</span><span class="p">(()</span> <span class="o">=></span> <span class="nx">setSavedCountry</span><span class="p">(</span><span class="nx">selectedCountry</span><span class="p">),</span> <span class="p">[]);</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;></span>
      ...
        <span class="p">&lt;</span><span class="nc">CountriesList</span>
          <span class="na">onCountryChanged</span><span class="p">=</span><span class="si">{</span><span class="nx">onCountryChange</span><span class="si">}</span>
        <span class="p">/></span>
        <span class="p">&lt;</span><span class="nc">SelectedCountry</span>
          <span class="na">onCountrySaved</span><span class="p">=</span><span class="si">{</span><span class="nx">onCountrySaved</span><span class="si">}</span>
        <span class="p">/></span>
      ...
    <span class="p">&lt;/></span>
  <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Do you know the funniest part about it? It actually <strong>doesn’t work</strong>. Because it doesn’t take into account the third reason why React components are re-rendered: <strong>when the parent component is re-rendered</strong>. Regardless of the props, <code>CountriesList</code> will always re-render if Page is re-rendered, even if it doesn’t have any props at all.</p>

<p>We can simplify the Page example into just this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">CountriesList</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=></span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Re-render!!!!!</span><span class="dl">"</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">div</span><span class="p">></span>countries list, always re-renders<span class="p">&lt;/</span><span class="nt">div</span><span class="p">>;</span>
<span class="p">};</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">counter</span><span class="p">,</span> <span class="nx">setCounter</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="kr">number</span><span class="o">></span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;></span>
      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">></span>Country settings<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">></span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=></span> <span class="nx">setCounter</span><span class="p">(</span><span class="nx">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="p">></span>
        Click here to re-render Countries list (open the console) <span class="si">{</span><span class="nx">counter</span><span class="si">}</span>
      <span class="p">&lt;/</span><span class="nt">button</span><span class="p">></span>
      <span class="p">&lt;</span><span class="nc">CountriesList</span> <span class="p">/></span>
    <span class="p">&lt;/></span>
  <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>And every time we click the button, we’ll see that <code>CountriesList</code> is re-rendered, <strong>even if it doesn’t have any props at all</strong>. <a href="https://codesandbox.io/s/re-renders-simplified-bad-1giei?file=/src/country-settings/page.tsx">Codesandbox code is here</a>.</p>

<p>And this, finally, allows us to solidify the very first rule of this article:</p>

<blockquote>
<p><b>Rule #1.</b> If the only reason you want to extract your inline functions in props into useCallback is to avoid re-renders of children<br>
  components: don’t. It doesn’t work.</p>
</blockquote>

<p>Now, there are <a href="https://overreacted.io/before-you-memo/">a few ways</a> to deal with situations like the above, I am going to use the simplest one for this particular occasion: <a href="https://reactjs.org/docs/hooks-reference.html#usememo">useMemo</a> hook. What it does is it’s essentially “caches” the results of whatever function you pass into it, and only refreshes them when a <em>dependency</em> of <code>useMemo</code> is changed. If I just extract the rendered <code>CountriesList</code> into a variable <code>const list = &lt;ComponentList />;</code> and then apply <code>useMemo</code> on it, the <code>ComponentList</code> component now will be re-rendered <strong>only when useMemo dependencies will change</strong>.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">counter</span><span class="p">,</span> <span class="nx">setCounter</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="kr">number</span><span class="o">></span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=></span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">&lt;</span><span class="nc">CountriesList</span> <span class="p">/>;</span>
  <span class="p">},</span> <span class="p">[]);</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;></span>
      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">></span>Country settings<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">></span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=></span> <span class="nx">setCounter</span><span class="p">(</span><span class="nx">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="p">></span>
        Click here to re-render Countries list (open the console) <span class="si">{</span><span class="nx">counter</span><span class="si">}</span>
      <span class="p">&lt;/</span><span class="nt">button</span><span class="p">></span>
      <span class="si">{</span><span class="nx">list</span><span class="si">}</span>
    <span class="p">&lt;/></span>
  <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Which in this case is never, since it doesn’t have any dependencies. This pattern basically allows me to break out of this “parent re-renders - re-render all the children regardless” loop and take control over it. Check out the <a href="https://codesandbox.io/s/re-renders-simplified-memo-xcv5f?file=/src/country-settings/page.tsx">full example in codesandbox</a>.</p>

<p>The most important thing there to be mindful of is the list of dependencies of <code>useMemo</code>. If it depends on exactly the same thing that causes the parent component to re-render, then it’s going to refresh its cache with every re-render, and essentially becomes useless. For example, if in this simplified example I pass the <code>counter</code> value as a dependency to the <code>list</code> variable (notice: not even a prop to the memoised component!), that will cause <code>useMemo</code> to refresh itself with every state change and will make <code>CountriesList</code> re-render again.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=></span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;></span>
      <span class="si">{</span><span class="nx">counter</span><span class="si">}</span>
      <span class="p">&lt;</span><span class="nc">CountriesList</span> <span class="p">/></span>
    <span class="p">&lt;/></span>
  <span class="p">);</span>
<span class="p">},</span> <span class="p">[</span><span class="nx">counter</span><span class="p">]);</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p><a href="https://codesandbox.io/s/re-renders-simplified-memo-with-dep-9h433?file=/src/country-settings/page.tsx:363-491"><br>
  See the codesandbox example.<br>
</a></p>

<p>Okay, so all of this is great, but how exactly it can be applied to our non-simplified Page component? Well, if we look closely to its implementation again<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">selectedCountry</span><span class="p">,</span> <span class="nx">setSelectedCountry</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="nx">Country</span><span class="o">></span><span class="p">(</span><span class="nx">countries</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">savedCountry</span><span class="p">,</span> <span class="nx">setSavedCountry</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="nx">Country</span><span class="o">></span><span class="p">(</span><span class="nx">countries</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;></span>
      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">></span>Country settings<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">></span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">css</span><span class="p">=</span><span class="si">{</span><span class="nx">contentCss</span><span class="si">}</span><span class="p">></span>
        <span class="p">&lt;</span><span class="nc">CountriesList</span>
          <span class="na">countries</span><span class="p">=</span><span class="si">{</span><span class="nx">countries</span><span class="si">}</span>
          <span class="na">onCountryChanged</span><span class="p">=</span><span class="si">{</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="o">=></span> <span class="nx">setSelectedCountry</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span><span class="si">}</span>
          <span class="na">savedCountry</span><span class="p">=</span><span class="si">{</span><span class="nx">savedCountry</span><span class="si">}</span>
        <span class="p">/></span>
        <span class="p">&lt;</span><span class="nc">SelectedCountry</span>
          <span class="na">country</span><span class="p">=</span><span class="si">{</span><span class="nx">selectedCountry</span><span class="si">}</span>
          <span class="na">onCountrySaved</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=></span> <span class="nx">setSavedCountry</span><span class="p">(</span><span class="nx">selectedCountry</span><span class="p">)</span><span class="si">}</span>
        <span class="p">/></span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">></span>
    <span class="p">&lt;/></span>
  <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>we’ll see that:</p>

<ul>
<li>
<code>selectedCountry</code> state is never used in <code>CountriesList</code> component</li>
<li>
<code>savedCountry</code> state is never used in <code>SelectedCountry</code> component</li>
</ul>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--BD8Pvr0g--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/r172i5nksygdf3zpukzb.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--BD8Pvr0g--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/r172i5nksygdf3zpukzb.png" alt="Image description" loading="lazy" width="880" height="571"></a></p>

<p>Which means that when <code>selectedCountry</code> state changes, <code>CountriesList</code> component doesn’t need to re-render at all! And the same story with <code>savedCountry</code> state and <code>SelectedCountry</code> component. And I can just extract both of them to variables and memoise them to prevent their unnecessary re-renders:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">selectedCountry</span><span class="p">,</span> <span class="nx">setSelectedCountry</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="nx">Country</span><span class="o">></span><span class="p">(</span><span class="nx">countries</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">savedCountry</span><span class="p">,</span> <span class="nx">setSavedCountry</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="nx">Country</span><span class="o">></span><span class="p">(</span><span class="nx">countries</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

  <span class="kd">const</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=></span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nc">CountriesList</span>
        <span class="na">countries</span><span class="p">=</span><span class="si">{</span><span class="nx">countries</span><span class="si">}</span>
        <span class="na">onCountryChanged</span><span class="p">=</span><span class="si">{</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="o">=></span> <span class="nx">setSelectedCountry</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span><span class="si">}</span>
        <span class="na">savedCountry</span><span class="p">=</span><span class="si">{</span><span class="nx">savedCountry</span><span class="si">}</span>
      <span class="p">/></span>
    <span class="p">);</span>
  <span class="p">},</span> <span class="p">[</span><span class="nx">savedCountry</span><span class="p">,</span> <span class="nx">countries</span><span class="p">]);</span>

  <span class="kd">const</span> <span class="nx">selected</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=></span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nc">SelectedCountry</span>
        <span class="na">country</span><span class="p">=</span><span class="si">{</span><span class="nx">selectedCountry</span><span class="si">}</span>
        <span class="na">onCountrySaved</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=></span> <span class="nx">setSavedCountry</span><span class="p">(</span><span class="nx">selectedCountry</span><span class="p">)</span><span class="si">}</span>
      <span class="p">/></span>
    <span class="p">);</span>
  <span class="p">},</span> <span class="p">[</span><span class="nx">selectedCountry</span><span class="p">]);</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;></span>
      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">></span>Country settings<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">></span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">css</span><span class="p">=</span><span class="si">{</span><span class="nx">contentCss</span><span class="si">}</span><span class="p">></span>
        <span class="si">{</span><span class="nx">list</span><span class="si">}</span>
        <span class="si">{</span><span class="nx">selected</span><span class="si">}</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">></span>
    <span class="p">&lt;/></span>
  <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>And this, finally, lets us formalize the second rule of this article:</p>

<blockquote>
<p><b>Rule #2</b>. If your component manages state, find parts of the render tree that don’t depend on the changed state and memoise them to<br>
  minimize their re-renders.</p>
</blockquote>

<h2>
  <a name="implementing-the-list-of-countries" href="#implementing-the-list-of-countries">
  </a>
  Implementing the list of countries
</h2>

<p>Now, that our Page component is ready and perfect, time to flesh out its children. First, let’s implement the complicated component: <code>CountriesList</code>. We already know, that this component should accept the list of countries, should trigger <code>onCountryChanged</code> callback when a country is selected in the list, and should highlight the <code>savedCountry</code> into a different color, according to design. So let’s start with the simplest approach:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="kd">type</span> <span class="nx">CountriesListProps</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[];</span>
  <span class="nl">onCountryChanged</span><span class="p">:</span> <span class="p">(</span><span class="na">country</span><span class="p">:</span> <span class="nx">Country</span><span class="p">)</span> <span class="o">=></span> <span class="k">void</span><span class="p">;</span>
  <span class="nl">savedCountry</span><span class="p">:</span> <span class="nx">Country</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">CountriesList</span> <span class="o">=</span> <span class="p">({</span>
  <span class="nx">countries</span><span class="p">,</span>
  <span class="nx">onCountryChanged</span><span class="p">,</span>
  <span class="nx">savedCountry</span>
<span class="p">}:</span> <span class="nx">CountriesListProps</span><span class="p">)</span> <span class="o">=></span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">Item</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">country</span> <span class="p">}:</span> <span class="p">{</span> <span class="na">country</span><span class="p">:</span> <span class="nx">Country</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
    <span class="c1">// different className based on whether this item is "saved" or not</span>
    <span class="kd">const</span> <span class="nx">className</span> <span class="o">=</span> <span class="nx">savedCountry</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">country</span><span class="p">.</span><span class="nx">id</span> <span class="p">?</span> <span class="dl">"</span><span class="s2">country-item saved</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">country-item</span><span class="dl">"</span><span class="p">;</span>

    <span class="c1">// when the item is clicked - trigger the callback from props with the correct country in the arguments</span>
    <span class="kd">const</span> <span class="nx">onItemClick</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=></span> <span class="nx">onCountryChanged</span><span class="p">(</span><span class="nx">country</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">className</span><span class="p">=</span><span class="si">{</span><span class="nx">className</span><span class="si">}</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="nx">onItemClick</span><span class="si">}</span><span class="p">></span>
        <span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="p">=</span><span class="si">{</span><span class="nx">country</span><span class="p">.</span><span class="nx">flagUrl</span><span class="si">}</span> <span class="p">/></span>
        <span class="p">&lt;</span><span class="nt">span</span><span class="p">></span><span class="si">{</span><span class="nx">country</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">span</span><span class="p">></span>
      <span class="p">&lt;/</span><span class="nt">button</span><span class="p">></span>
    <span class="p">);</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">></span>
      <span class="si">{</span><span class="nx">countries</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">country</span><span class="p">)</span> <span class="o">=></span> <span class="p">(</span>
        <span class="p">&lt;</span><span class="nc">Item</span> <span class="na">country</span><span class="p">=</span><span class="si">{</span><span class="nx">country</span><span class="si">}</span> <span class="na">key</span><span class="p">=</span><span class="si">{</span><span class="nx">country</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span> <span class="p">/></span>
      <span class="p">))</span><span class="si">}</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">></span>
  <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Again, the simplest component ever, only 2 things are happening there, really:</p>

<ul>
<li>we generate the <code>Item</code> based on the props we receive (it depends on both <code>onCountryChanged</code> and <code>savedCountry</code>)</li>
<li>we render that <code>Item</code> for all countries in a loop</li>
</ul>

<p>And again, there is nothing criminal about any of this <em>per se</em>, I have seen this pattern used pretty much everywhere.</p>

<h3>
  <a name="refactoring-list-of-countries-component-with-performance-in-mind" href="#refactoring-list-of-countries-component-with-performance-in-mind">
  </a>
  Refactoring List of countries component - with performance in mind
</h3>

<p>Time again to refresh a bit our knowledge of how React renders things, this time - what will happen if a component, like <code>Item</code> component from above, is created <em>during another component render</em>? Short answer - nothing good, really. From React’s perspective, this <code>Item</code> is just a function that is new on every render, and that returns a new result on every render. So what it will do, is on <strong>every render</strong> it will re-create results of this function from scratch, i.e. it will just compare the previous component state with the current one, like it happens during normal re-render. It will drop the previously generated component, including its DOM tree, remove it from the page, and will generate and mount a completely new component, with a completely new DOM tree every single time the parent component is re-rendered.</p>

<p>If we simplify the countries example to demonstrate this effect, it will be something like this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">CountriesList</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">Item</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">country</span> <span class="p">}:</span> <span class="p">{</span> <span class="na">country</span><span class="p">:</span> <span class="nx">Country</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
    <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=></span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Mounted!</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">},</span> <span class="p">[]);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Render</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">&lt;</span><span class="nt">div</span><span class="p">></span><span class="si">{</span><span class="nx">country</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">>;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;></span>
      <span class="si">{</span><span class="nx">countries</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">country</span><span class="p">)</span> <span class="o">=></span> <span class="p">(</span>
        <span class="p">&lt;</span><span class="nc">Item</span> <span class="na">country</span><span class="p">=</span><span class="si">{</span><span class="nx">country</span><span class="si">}</span> <span class="p">/></span>
      <span class="p">))</span><span class="si">}</span>
    <span class="p">&lt;/></span>
  <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>This is the heaviest operation from them all in React. 10 “normal” re-renders is nothing compared to the full re-mounting of a freshly created component from a performance perspective. In normal circumstances, <code>useEffect</code> with an empty dependencies array would be triggered only once - after the component finished its mounting and very first rendering. After that the light-weight re-rendering process in React kicks in, and component is not created from scratch, but only updated when needed (that’s what makes React so fast btw). Not in this scenario though - take a look at <a href="https://codesandbox.io/s/creating-components-in-render-bad-8otem?file=/src/country-settings/page.tsx">this codesandbox</a>, click on the “re-render” button with open console, and enjoy 250 renders AND mountings happening on every click.</p>

<p>The fix for this is obvious and easy: we just need to move the <code>Item</code> component outside of the render function.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">Item</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">country</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">country</span><span class="p">:</span> <span class="nx">Country</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=></span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Mounted!</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">},</span> <span class="p">[]);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Render</span><span class="dl">"</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">div</span><span class="p">></span><span class="si">{</span><span class="nx">country</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">>;</span>
<span class="p">};</span>

<span class="kd">const</span> <span class="nx">CountriesList</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;></span>
      <span class="si">{</span><span class="nx">countries</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">country</span><span class="p">)</span> <span class="o">=></span> <span class="p">(</span>
        <span class="p">&lt;</span><span class="nc">Item</span> <span class="na">country</span><span class="p">=</span><span class="si">{</span><span class="nx">country</span><span class="si">}</span> <span class="p">/></span>
      <span class="p">))</span><span class="si">}</span>
    <span class="p">&lt;/></span>
  <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Now in our <a href="https://codesandbox.io/s/creating-components-in-render-fixed-cs7pe?file=/src/country-settings/page.tsx">simplified codesandbox</a> mounting doesn’t happen on every re-render of the parent component.</p>

<p>As a bonus, refactoring like this helps maintain healthy boundaries between different components and keep the code cleaner and more concise. This is going to be especially visible when we apply this improvement to our “real” app. Before:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">CountriesList</span> <span class="o">=</span> <span class="p">({</span>
  <span class="nx">countries</span><span class="p">,</span>
  <span class="nx">onCountryChanged</span><span class="p">,</span>
  <span class="nx">savedCountry</span>
<span class="p">}:</span> <span class="nx">CountriesListProps</span><span class="p">)</span> <span class="o">=></span> <span class="p">{</span>

  <span class="c1">// only "country" in props</span>
  <span class="kd">const</span> <span class="nx">Item</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">country</span> <span class="p">}:</span> <span class="p">{</span> <span class="na">country</span><span class="p">:</span> <span class="nx">Country</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
    <span class="c1">// ... same code</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">></span>
      <span class="si">{</span><span class="nx">countries</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">country</span><span class="p">)</span> <span class="o">=></span> <span class="p">(</span>
        <span class="p">&lt;</span><span class="nc">Item</span> <span class="na">country</span><span class="p">=</span><span class="si">{</span><span class="nx">country</span><span class="si">}</span> <span class="na">key</span><span class="p">=</span><span class="si">{</span><span class="nx">country</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span> <span class="p">/></span>
      <span class="p">))</span><span class="si">}</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">></span>
  <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>After:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="kd">type</span> <span class="nx">ItemProps</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">country</span><span class="p">:</span> <span class="nx">Country</span><span class="p">;</span>
  <span class="nl">savedCountry</span><span class="p">:</span> <span class="nx">Country</span><span class="p">;</span>
  <span class="nl">onItemClick</span><span class="p">:</span> <span class="p">()</span> <span class="o">=></span> <span class="k">void</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// turned out savedCountry and onItemClick were also used</span>
<span class="c1">// but it was not obvious at all in the previous implementation</span>
<span class="kd">const</span> <span class="nx">Item</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">country</span><span class="p">,</span> <span class="nx">savedCountry</span><span class="p">,</span> <span class="nx">onItemClick</span> <span class="p">}:</span> <span class="nx">ItemProps</span><span class="p">)</span> <span class="o">=></span> <span class="p">{</span>
  <span class="c1">// ... same code</span>
<span class="p">};</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">CountriesList</span> <span class="o">=</span> <span class="p">({</span>
  <span class="nx">countries</span><span class="p">,</span>
  <span class="nx">onCountryChanged</span><span class="p">,</span>
  <span class="nx">savedCountry</span>
<span class="p">}:</span> <span class="nx">CountriesListProps</span><span class="p">)</span> <span class="o">=></span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">></span>
      <span class="si">{</span><span class="nx">countries</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">country</span><span class="p">)</span> <span class="o">=></span> <span class="p">(</span>
        <span class="p">&lt;</span><span class="nc">Item</span>
          <span class="na">country</span><span class="p">=</span><span class="si">{</span><span class="nx">country</span><span class="si">}</span>
          <span class="na">key</span><span class="p">=</span><span class="si">{</span><span class="nx">country</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span>
          <span class="na">savedCountry</span><span class="p">=</span><span class="si">{</span><span class="nx">savedCountry</span><span class="si">}</span>
          <span class="na">onItemClick</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=></span> <span class="nx">onCountryChanged</span><span class="p">(</span><span class="nx">country</span><span class="p">)</span><span class="si">}</span>
        <span class="p">/></span>
      <span class="p">))</span><span class="si">}</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">></span>
  <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Now, that we got rid of the re-mounting of <code>Item</code> component every time the parent component is re-rendered, we can extract the third rule of the article:</p>

<blockquote>
<p><b>Rule #3</b>. Never create new components inside the render function of another component.</p>
</blockquote>

<h2>
  <a name="implementing-selected-country" href="#implementing-selected-country">
  </a>
  Implementing selected country
</h2>

<p>Next step: the “selected country” component, which is going to be the shortest and the most boring part of the article, since there is nothing to show there really: it’s just a component that accepts a property and a callback, and renders a few strings:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">SelectedCountry</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">country</span><span class="p">,</span> <span class="nx">onSaveCountry</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">country</span><span class="p">:</span> <span class="nx">Country</span><span class="p">;</span> <span class="nl">onSaveCountry</span><span class="p">:</span> <span class="p">()</span> <span class="o">=></span> <span class="k">void</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;></span>
      <span class="p">&lt;</span><span class="nt">ul</span><span class="p">></span>
        <span class="p">&lt;</span><span class="nt">li</span><span class="p">></span>Country: <span class="si">{</span><span class="nx">country</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">></span>
        ... // whatever country's information we're going to render
      <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">></span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="nx">onSaveCountry</span><span class="si">}</span> <span class="na">type</span><span class="p">=</span><span class="s">"button"</span><span class="p">></span>Save<span class="p">&lt;/</span><span class="nt">button</span><span class="p">></span>
    <span class="p">&lt;/></span>
  <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>🤷🏽‍♀️ That’s it! It’s only here just to make the demo codesandbox more interesting 🙂</p>

<h2>
  <a name="final-polish-theming" href="#final-polish-theming">
  </a>
  Final polish: theming
</h2>

<p>And now the final step: dark mode! Who doesn’t love those? Considering that the current theme should be available in most components, passing it through props everywhere would be a nightmare, so React Context is the natural solution here.</p>

<p>Creating theme context first:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="kd">type</span> <span class="nx">Mode</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">light</span><span class="dl">'</span> <span class="o">|</span> <span class="dl">'</span><span class="s1">dark</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">type</span> <span class="nx">Theme</span> <span class="o">=</span> <span class="p">{</span> <span class="na">mode</span><span class="p">:</span> <span class="nx">Mode</span> <span class="p">};</span>
<span class="kd">const</span> <span class="nx">ThemeContext</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createContext</span><span class="o">&lt;</span><span class="nx">Theme</span><span class="o">></span><span class="p">({</span> <span class="na">mode</span><span class="p">:</span> <span class="dl">'</span><span class="s1">light</span><span class="dl">'</span> <span class="p">});</span>

<span class="kd">const</span> <span class="nx">useTheme</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=></span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">useContext</span><span class="p">(</span><span class="nx">ThemeContext</span><span class="p">);</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Adding context provider and the button to switch it to the Page component:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
  <span class="c1">// same as before</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">setMode</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="nx">Mode</span><span class="o">></span><span class="p">(</span><span class="dl">"</span><span class="s2">light</span><span class="dl">"</span><span class="p">);</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nc">ThemeContext</span><span class="p">.</span><span class="nc">Provider</span> <span class="na">value</span><span class="p">=</span><span class="si">{</span><span class="p">{</span> <span class="nx">mode</span> <span class="p">}</span><span class="si">}</span><span class="p">></span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=></span> <span class="nx">setMode</span><span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">light</span><span class="dl">'</span> <span class="p">?</span> <span class="dl">'</span><span class="s1">dark</span><span class="dl">'</span> <span class="p">:</span> <span class="dl">'</span><span class="s1">light</span><span class="dl">'</span><span class="p">)</span><span class="si">}</span><span class="p">></span>Toggle theme<span class="p">&lt;/</span><span class="nt">button</span><span class="p">></span>
      // the rest is the same as before
    <span class="p">&lt;/</span><span class="nc">ThemeContext</span><span class="p">.</span><span class="nc">Provider</span><span class="p">></span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>And then using the context hook to color our buttons in the appropriate theme:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">Item</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">country</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">country</span><span class="p">:</span> <span class="nx">Country</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">mode</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useTheme</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">className</span> <span class="o">=</span> <span class="s2">`country-item </span><span class="p">${</span><span class="nx">mode</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">dark</span><span class="dl">"</span> <span class="p">?</span> <span class="dl">"</span><span class="s2">dark</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">""</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
    <span class="c1">// the rest is the same</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Again, nothing criminal in this implementation, a very common pattern, especially for theming.</p>

<h3>
  <a name="refactoring-theming-with-performance-in-mind" href="#refactoring-theming-with-performance-in-mind">
  </a>
  Refactoring theming - with performance in mind.
</h3>

<p>Before we’ll be able to catch what’s wrong with the implementation above, time to look into a fourth reason why a React component can be re-rendered, that often is forgotten: <b>if a component uses context consumer, it will be re-rendered every time the context provider’s value is changed.</b></p>

<p>Remember our simplified example, where we memoised the render results to avoid their re-renders?<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">Item</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">country</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">country</span><span class="p">:</span> <span class="nx">Country</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">render</span><span class="dl">"</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">div</span><span class="p">></span><span class="si">{</span><span class="nx">country</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">>;</span>
<span class="p">};</span>

<span class="kd">const</span> <span class="nx">CountriesList</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;></span>
      <span class="si">{</span><span class="nx">countries</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">country</span><span class="p">)</span> <span class="o">=></span> <span class="p">(</span>
        <span class="p">&lt;</span><span class="nc">Item</span> <span class="na">country</span><span class="p">=</span><span class="si">{</span><span class="nx">country</span><span class="si">}</span> <span class="p">/></span>
      <span class="p">))</span><span class="si">}</span>
    <span class="p">&lt;/></span>
  <span class="p">);</span>
<span class="p">};</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">counter</span><span class="p">,</span> <span class="nx">setCounter</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="kr">number</span><span class="o">></span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=></span> <span class="p">&lt;</span><span class="nc">CountriesList</span> <span class="na">countries</span><span class="p">=</span><span class="si">{</span><span class="nx">countries</span><span class="si">}</span> <span class="p">/>,</span> <span class="p">[</span>
    <span class="nx">countries</span>
  <span class="p">]);</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;></span>
      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">></span>Country settings<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">></span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=></span> <span class="nx">setCounter</span><span class="p">(</span><span class="nx">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="p">></span>
        Click here to re-render Countries list (open the console) <span class="si">{</span><span class="nx">counter</span><span class="si">}</span>
      <span class="p">&lt;/</span><span class="nt">button</span><span class="p">></span>
      <span class="si">{</span><span class="nx">list</span><span class="si">}</span>
    <span class="p">&lt;/></span>
  <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p><code>Page</code> component will re-render every time we click the button since it updates the state on every click. But <code>CountriesList</code> is memoised and is independent of that state, so it won’t re-render, and as a result <code>Item</code> component won’t re-render as well. See the <a href="https://codesandbox.io/s/context-before-good-duhgf?file=/src/country-settings/page.tsx">codesandbox here</a>.</p>

<p>Now, what will happen if I add the Theme context here? Provider in the <code>Page</code> component:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
  <span class="c1">// everything else stays the same</span>

  <span class="c1">// memoised list is still memoised</span>
  <span class="kd">const</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=></span> <span class="p">&lt;</span><span class="nc">CountriesList</span> <span class="na">countries</span><span class="p">=</span><span class="si">{</span><span class="nx">countries</span><span class="si">}</span> <span class="p">/>,</span> <span class="p">[</span>
    <span class="nx">countries</span>
  <span class="p">]);</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nc">ThemeContext</span><span class="p">.</span><span class="nc">Provider</span> <span class="na">value</span><span class="p">=</span><span class="si">{</span><span class="p">{</span> <span class="nx">mode</span> <span class="p">}</span><span class="si">}</span><span class="p">></span>
      // same
    <span class="p">&lt;/</span><span class="nc">ThemeContext</span><span class="p">.</span><span class="nc">Provider</span><span class="p">></span>
  <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>And context in the Item component:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">Item</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">country</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">country</span><span class="p">:</span> <span class="nx">Country</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">theme</span> <span class="o">=</span> <span class="nx">useTheme</span><span class="p">();</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">render</span><span class="dl">"</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">div</span><span class="p">></span><span class="si">{</span><span class="nx">country</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">>;</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>If they were just normal components and hooks, nothing would’ve happened - <code>Item</code> is not a child of <code>Page</code> component, <code>CountriesList</code> won’t re-render because of memoisation, so <code>Item</code> wouldn’t either. Except, in this case, it’s a Provider-consumer combination, so every time the value on the provider changes, <strong>all</strong> of the consumers will re-render. And since we’re passing new object to the value all the time, <em><code>Items</code> will unnecessary re-render on every counter</em>. Context basically bypasses the memorisation we did and makes it pretty much useless. <a href="https://codesandbox.io/s/context-bad-4zou7?file=/src/country-settings/page.tsx">See the codesandbox.</a></p>

<p>The fix to it, as you might have already guessed, is just to make sure that the <code>value</code> in the provider doesn’t change more than it needs to. In our case, we just need to memoise it as well:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
  <span class="c1">// everything else stays the same</span>

  <span class="c1">// memoising the object!</span>
  <span class="kd">const</span> <span class="nx">theme</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=></span> <span class="p">({</span> <span class="nx">mode</span> <span class="p">}),</span> <span class="p">[</span><span class="nx">mode</span><span class="p">]);</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nc">ThemeContext</span><span class="p">.</span><span class="nc">Provider</span> <span class="na">value</span><span class="p">=</span><span class="si">{</span><span class="nx">theme</span><span class="si">}</span><span class="p">></span>
      // same
    <span class="p">&lt;/</span><span class="nc">ThemeContext</span><span class="p">.</span><span class="nc">Provider</span><span class="p">></span>
  <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>And now the counter will work without causing all the Items to re-render!</p>

<p>And absolutely the same solution for preventing unnecessary re-renders we can apply to our non-simplified <code>Page</code> component:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
  <span class="c1">// same as before</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">setMode</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="nx">Mode</span><span class="o">></span><span class="p">(</span><span class="dl">"</span><span class="s2">light</span><span class="dl">"</span><span class="p">);</span>

  <span class="c1">// memoising the object!</span>
  <span class="kd">const</span> <span class="nx">theme</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=></span> <span class="p">({</span> <span class="nx">mode</span> <span class="p">}),</span> <span class="p">[</span><span class="nx">mode</span><span class="p">]);</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nc">ThemeContext</span><span class="p">.</span><span class="nc">Provider</span> <span class="na">value</span><span class="p">=</span><span class="si">{</span><span class="nx">theme</span><span class="si">}</span><span class="p">></span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=></span> <span class="nx">setMode</span><span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">light</span><span class="dl">'</span> <span class="p">?</span> <span class="dl">'</span><span class="s1">dark</span><span class="dl">'</span> <span class="p">:</span> <span class="dl">'</span><span class="s1">light</span><span class="dl">'</span><span class="p">)</span><span class="si">}</span><span class="p">></span>Toggle theme<span class="p">&lt;/</span><span class="nt">button</span><span class="p">></span>
      // the rest is the same as before
    <span class="p">&lt;/</span><span class="nc">ThemeContext</span><span class="p">.</span><span class="nc">Provider</span><span class="p">></span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>And extract the new knowledge into the final rule of this article:</p>

<blockquote>
<p><b>Rule #4</b>: When using context, make sure that value property is always memoised if it’s not a number, string or boolean.</p>
</blockquote>

<h2>
  <a name="bringing-it-all-together" href="#bringing-it-all-together">
  </a>
  Bringing it all together
</h2>

<p>And finally, our app is complete! The entire implementation is <a href="https://codesandbox.io/s/re-renders-final-good-luz8s?file=/src/country-settings/page.tsx">available in this codesandbox</a>. Throttle your CPU if you’re on the latest MacBook, to experience the world as the usual customers are, and try to select between different countries on the list. Even with 6x CPU reduction, it’s still blazing fast! 🎉</p>

<p>And now, the big question that I suspect many people have the urge to ask: “But Nadia, React is blazing fast by itself anyway. Surely those ‘optimisations’ that you did won’t make much of a difference on a simple list of just 250 items? Aren’t you exaggerating the importance here?“.</p>

<p>Yeah, when I just started this article, I also thought so. But then I implemented that app in the “non-performant” way. <a href="https://codesandbox.io/s/re-renders-final-bad-4znwe?file=/src/country-settings/page.tsx">Check it out in the codesandbox</a>. I don’t even need to reduce the CPU to see the delay between selecting the items 😱. Reduce it by 6x, and it’s probably the slowest simple list on the planet that doesn’t even work properly (it has a focus bug that the “performant” app doesn’t have). And I haven’t even done anything outrageously and obviously evil there! 😅</p>

<p>So let’s refresh <strong>when React components re-render</strong>:</p>

<ul>
<li>when props or state have changed</li>
<li>when parent component re-renders</li>
<li>when a component uses context and the value of its provider changes</li>
</ul>

<p>And the rules we extracted:</p>

<p><strong>Rule #1</strong>: If the only reason why you want to extract your inline functions in props into <code>useCallback</code> is to avoid re-renders of children components: don’t. It doesn’t work.</p>

<p><strong>Rule #2</strong>: If your component manages state, find parts of the render tree that don’t depend on the changed state and memoise them to minimize their re-renders.</p>

<p><strong>Rule #3</strong>. <em>Never</em> create new components inside the render function of another component.</p>

<p><strong>Rule #4</strong>. When using context, make sure that <code>value</code> property is <em>always</em> memoised if it’s not a number, string or boolean.</p>

<p>That is it! Hope those rules will help to write more performant apps from the get-go and lead to happier customers who never had to experience slow products anymore.</p>

<h2>
  <a name="bonus-the-raw-usecallback-endraw-conundrum" href="#bonus-the-raw-usecallback-endraw-conundrum">
  </a>
  Bonus: the <code>useCallback</code> conundrum
</h2>

<p>I feel I need to resolve one mystery before I actually end this article: how can it be possible that <code>useCallback</code> is useless for reducing re-renders, and why then React docs literally say that “[useCallback] is useful when passing callbacks to optimized child components that rely on reference equality to prevent unnecessary renders”? 🤯</p>

<p>The answer is in this phrase: <em>“optimized child components that rely on reference equality”</em>.</p>

<p>There are 2 scenarios applicable here.</p>

<p><strong>First</strong>: the component that received the callback is wrapped in <code>React.memo</code> and has that callback as a dependency. Basically this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">MemoisedItem</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">memo</span><span class="p">(</span><span class="nx">Item</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">List</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=></span> <span class="p">{</span>
  <span class="c1">// this HAS TO be memoised, otherwise `React.memo` for the Item is useless</span>
  <span class="kd">const</span> <span class="nx">onClick</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=></span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">click!</span><span class="dl">'</span><span class="p">)};</span>

  <span class="k">return</span> <span class="p">&lt;</span><span class="nc">MemoisedItem</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="nx">onClick</span><span class="si">}</span> <span class="na">country</span><span class="p">=</span><span class="s">"Austria"</span> <span class="p">/></span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>or this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">MemoisedItem</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">memo</span><span class="p">(</span><span class="nx">Item</span><span class="p">,</span> <span class="p">(</span><span class="nx">prev</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=></span> <span class="nx">prev</span><span class="p">.</span><span class="nx">onClick</span> <span class="o">!==</span> <span class="nx">next</span><span class="p">.</span><span class="nx">onClick</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">List</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=></span> <span class="p">{</span>
  <span class="c1">// this HAS TO be memoised, otherwise `React.memo` for the Item is useless</span>
  <span class="kd">const</span> <span class="nx">onClick</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=></span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">click!</span><span class="dl">'</span><span class="p">)};</span>

  <span class="k">return</span> <span class="p">&lt;</span><span class="nc">MemoisedItem</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="nx">onClick</span><span class="si">}</span> <span class="na">country</span><span class="p">=</span><span class="s">"Austria"</span> <span class="p">/></span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p><strong>Second</strong>: if the component that received the callback has this callback as a dependency in hooks like <code>useMemo</code>, <code>useCallback</code> or <code>useEffect</code>.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">Item</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">onClick</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=></span> <span class="p">{</span>
    <span class="c1">// some heavy calculation here</span>
    <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">...</span>
    <span class="nx">onClick</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

  <span class="c1">// if onClick is not memoised, this will be triggered on every single render</span>
  <span class="p">},</span> <span class="p">[</span><span class="nx">onClick</span><span class="p">])</span>
  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">div</span><span class="p">></span>something<span class="p">&lt;/</span><span class="nt">div</span><span class="p">></span>
<span class="p">}</span>
<span class="kd">const</span> <span class="nx">List</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=></span> <span class="p">{</span>
  <span class="c1">// this HAS TO be memoised, otherwise `useEffect` in Item above</span>
  <span class="c1">// will be triggered on every single re-render</span>
  <span class="kd">const</span> <span class="nx">onClick</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=></span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">click!</span><span class="dl">'</span><span class="p">)};</span>

  <span class="k">return</span> <span class="p">&lt;</span><span class="nc">Item</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="nx">onClick</span><span class="si">}</span> <span class="na">country</span><span class="p">=</span><span class="s">"Austria"</span> <span class="p">/></span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>None of this can be generalised into a simple “do” or “don’t do”, it can only be used for solving the exact performance problem of the exact component, and not before.</p>

<p>And now the article is finally done, thank you for reading it so far and hope you found it useful! Bleib gesund and see ya next time ✌🏼</p>

<p>...</p>

<p>Originally published at <a href="https://www.developerway.com">https://www.developerway.com</a>. The website has more articles like this 😉</p>

<p><a href="https://www.developerway.com">Subscribe to the newsletter</a>, <a href="https://www.linkedin.com/in/adevnadia/">connect on LinkedIn</a> or <a href="https://twitter.com/adevnadia">follow on Twitter</a> to get notified as soon as the next article comes out.</p>

</div></article> <div class="aside-username-wrapper" data-v-10d06ee8><aside class="aside-username-block" data-v-37984f8c data-v-10d06ee8><div class="username-heading loading" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-heading" data-v-37984f8c><div class="vue-content-placeholders-heading__img"></div> <div class="vue-content-placeholders-heading__content"><div class="vue-content-placeholders-heading__title"></div> <div class="vue-content-placeholders-heading__subtitle"></div></div></div></div></div> <div class="info" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-text" data-v-37984f8c><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div></div></div></div></aside></div></div> <div class="comments-block" data-v-8c4375bc data-v-10d06ee8><!----> <a href="https://dev.to/adevnadia/how-to-write-performant-react-code-rules-patterns-dos-and-donts-40gk" target="_blank" rel="nofollow noopener noreferer" class="add-comment" data-v-8c4375bc>
    Add comment
  </a></div></div> <footer data-v-22cb8fd0><span data-v-22cb8fd0>Built with</span> <a href="https://nuxtjs.org" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="nuxt-icon" data-v-22cb8fd0 data-v-22cb8fd0><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a> <span data-v-22cb8fd0>&</span> <a href="https://docs.dev.to/api" rel="nofollow noopener" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-22cb8fd0 data-v-22cb8fd0><path d="M1.5726 5.13748C1.42945 5.20622 1.2411 5.36661 1.15822 5.48117C1 5.69503 1 5.74849 1 11.8739C1 17.9993 1 18.0528 1.15822 18.2667C1.2411 18.3812 1.42945 18.5416 1.5726 18.6104C1.8137 18.7402 2.46164 18.7478 12 18.7478C21.5384 18.7478 22.1863 18.7402 22.4274 18.6104C22.5706 18.5416 22.7589 18.3812 22.8418 18.2667C23 18.0528 23 17.9993 23 11.8739C23 5.74849 23 5.69503 22.8418 5.48117C22.7589 5.36661 22.5706 5.20622 22.4274 5.13748C22.1863 5.00764 21.5384 5 12 5C2.46164 5 1.8137 5.00764 1.5726 5.13748ZM7.7055 8.2613C8.0822 8.45989 8.59454 9.0098 8.77536 9.40694C8.89589 9.66664 8.91095 9.94922 8.91095 12.0649C8.91095 14.3104 8.90344 14.4478 8.75275 14.7839C8.51919 15.288 8.16506 15.6546 7.68288 15.899C7.26096 16.1052 7.22328 16.1128 5.7315 16.1358L4.20206 16.1663V12.1031V8.04744L5.80684 8.07035C7.27602 8.09327 7.42672 8.10854 7.7055 8.2613ZM13.6952 8.89521V9.73538H12.4521H11.2089V10.4991V11.2629H11.9623H12.7158V12.1031V12.9432H11.9623H11.2089V13.707V14.4708H12.4521H13.6952V15.3109V16.151H12C10.1315 16.151 10.0411 16.1358 9.67191 15.6928L9.47603 15.4484V12.1336C9.47603 8.46752 9.46851 8.49807 9.95069 8.20783C10.1692 8.07035 10.3425 8.05508 11.9473 8.05508H13.6952V8.89521ZM16.5658 10.3769C16.8897 11.6295 17.1685 12.6912 17.176 12.7293C17.1911 12.7675 17.4699 11.7441 17.8014 10.461C18.1254 9.17017 18.4343 8.1009 18.4795 8.08563C18.5247 8.06271 18.9541 8.06271 19.4288 8.07035L20.3028 8.09327L19.376 11.6219C18.8713 13.5542 18.4117 15.2269 18.3664 15.3261C18.0123 16.0135 17.274 16.3343 16.7164 16.0441C16.4528 15.899 16.0911 15.4865 15.9705 15.1887C15.9254 15.0665 15.4884 13.4549 15.0062 11.6142C14.524 9.76593 14.1171 8.20783 14.0945 8.15437C14.0644 8.07035 14.2301 8.05508 15.0212 8.07035L15.9856 8.09327L16.5658 10.3769Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M5.93491 12.103V14.4707H6.27394C6.66574 14.4707 7.01983 14.3103 7.1404 14.0965C7.18559 14.0048 7.21575 13.2105 7.21575 12.0648V10.1783L6.99725 9.95683C6.80133 9.76591 6.71847 9.73535 6.35683 9.73535H5.93491V12.103Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a></footer></div></div></div><script>window.__NUXT__=function(s,n,a,e){return e.type_of="article",e.id=950307,e.title="How to write performant React code: rules, patterns, do's and don'ts",e.description="Performance and React! Such a fun topic with so many controversial opinions and so many best...",e.readable_publish_date="Jan 10",e.slug="how-to-write-performant-react-code-rules-patterns-dos-and-donts-40gk",e.path="/adevnadia/how-to-write-performant-react-code-rules-patterns-dos-and-donts-40gk",e.url="https://dev.to/adevnadia/how-to-write-performant-react-code-rules-patterns-dos-and-donts-40gk",e.comments_count=9,e.public_reactions_count=93,e.collection_id=s,e.published_timestamp=n,e.positive_reactions_count=93,e.cover_image=s,e.social_image="https://dev.to/social_previews/article/950307.png",e.canonical_url="https://www.developerway.com/posts/how-to-write-performant-react-code",e.created_at=n,e.edited_at="2022-02-18T14:46:08Z",e.crossposted_at=s,e.published_at=n,e.last_comment_at="2022-02-28T07:45:59Z",e.reading_time_minutes=16,e.tag_list="react, performance, webdev, javascript",e.tags=["react","performance","webdev","javascript"],e.body_html='<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--iAK9mjMw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/tr0t9ogsikrkl2rqgr3p.jpg" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--iAK9mjMw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/tr0t9ogsikrkl2rqgr3p.jpg" alt="Image description" loading="lazy" width="500" height="320"></a></p>\n\n<p>Performance and React! Such a fun topic with so many controversial opinions and so many best practices flipping to be the opposite in just 6 months. Is it even possible to say anything definitive here or to make any generalized recommendations?</p>\n\n<p>Usually, performance experts are the proponents of “premature optimisation is the root of all evil” and “measure first” rules. Which loosely translates into “don’t fix that is not broken” and is quite hard to argue with. But I’m going to anyway 😉</p>\n\n<p>What I like about React, is that it makes implementing complicated UI interactions incredibly easy. What I don’t like about React, is that it also makes it incredibly easy to make mistakes with huge consequences that are not visible right away. The good news is, it’s also incredibly easy to prevent those mistakes and write code that is performant most of the time right away, thus significantly reducing the time and effort it takes to investigate performance problems since there will be much fewer of those. Basically, “premature optimisation”, when it comes to React and performance, can actually be a good thing and something that everyone should do 😉. You just need to know a few patterns to watch out for in order to do that meaningfully.</p>\n\n<p>So this is exactly what I want to prove in this article 😊. I’m going to do that by implementing a “real-life” app step by step, first in a “normal” way, using the patterns that you’ll see practically everywhere and surely used multiple times by yourself. And then refactor each step with performance in mind, and extract a generalized rule from every step that can be applied to most apps most of the time. And then compare the result in the end.</p>\n\n<p>Let’s begin!</p>\n\n<p>We are going to write one of the “settings” page for an online shop (that we introduced into the previous “Advanced typescript for React developers” articles). On this page, users will be able to select a country from the list, see all the information available for this country (like currency, delivery methods, etc), and then save this country as their country of choice. The page would look something like this:</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--NcFGI_IF--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/8mjrlrsd6ru0hawgdiwr.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--NcFGI_IF--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/8mjrlrsd6ru0hawgdiwr.png" alt="Image description" loading="lazy" width="880" height="449"></a></p>\n\n<p>On the left we’ll have a list of countries, with “saved” and “selected” states, when an item in the list is clicked, in the column on the right the detailed information is shown. When the “save” button is pressed, the “selected” country becomes “saved”, with the different item colour.</p>\n\n<p>Oh, and we’d want the dark mode there of course, it’s 2022 after all!</p>\n\n<p>Also, considering that in 90% of the cases performance problems in React can be summarised as “too many re-renders”, we are going to focus mostly on reducing those in the article. (Another 10% are: “renders are too heavy” and “really weird stuff that need further investigation”.)</p>\n\n<h2>\n  <a name="lets-structure-our-app-first" href="#lets-structure-our-app-first">\n  </a>\n  Let\'s structure our app first\n</h2>\n\n<p>First of all, let\'s take a look at the design, draw imaginary boundaries, and draft the structure of our future app and which components we’d need to implement there:</p>\n\n<ul>\n<li>a root “Page” component, where we’d handle the “submit” logic and country selection logic</li>\n<li>a “List of countries” component, that would render all the countries in a list, and in the future handle things like filtering and sorting</li>\n<li>“Item” component, that renders the country in the “List of countries”</li>\n<li>a “Selected country” component, that renders detailed information about the selected country and has the “Save” button</li>\n</ul>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--906A80Ww--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/5hgwpox2cfo73rad3059.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--906A80Ww--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/5hgwpox2cfo73rad3059.png" alt="Image description" loading="lazy" width="880" height="449"></a></p>\n\n<p>This is, of course, not the only possible way to implement this page, that’s the beauty and the curse of React: everything can be implemented in a million ways and there is no right or wrong answer for anything. But there are some patterns that in the long run in fast-growing or large already apps can definitely be called <strong>“never do this”</strong> or <strong>“this is a must-have”</strong>.</p>\n\n<p>Let’s see whether we can figure them out together 🙂</p>\n\n<h2>\n  <a name="implementing-page-component" href="#implementing-page-component">\n  </a>\n  Implementing Page component\n</h2>\n\n<p>Now, finally, the time to get our hands dirty and do some coding. Let’s start from the “root” and implement the Page component.</p>\n\n<p>First: we need a wrapper with some styles that renders page title, “List of countries” and “Selected country” components.</p>\n\n<p>Second: out page should receive the list of countries from somewhere, and then pass it to the <code>CountriesList</code> component so that it could render those.</p>\n\n<p>Third: our page should have an idea of a “selected” country, that will be received from the <code>CountriesList</code> component and passed to the <code>SelectedCountry</code> component.</p>\n\n<p>And finally: our page should have an idea of a “saved” country, that will be received from the <code>SelectedCountry</code> component and passed to the <code>CountriesList</code> component (and be sent to the backend in the future).<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="kd">const</span> <span class="p">[</span><span class="nx">selectedCountry</span><span class="p">,</span> <span class="nx">setSelectedCountry</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="nx">Country</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">countries</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>\n  <span class="kd">const</span> <span class="p">[</span><span class="nx">savedCountry</span><span class="p">,</span> <span class="nx">setSavedCountry</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="nx">Country</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">countries</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>\n\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;&gt;</span>\n      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Country settings<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>\n      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">css</span><span class="p">=</span><span class="si">{</span><span class="nx">contentCss</span><span class="si">}</span><span class="p">&gt;</span>\n        <span class="p">&lt;</span><span class="nc">CountriesList</span>\n          <span class="na">countries</span><span class="p">=</span><span class="si">{</span><span class="nx">countries</span><span class="si">}</span>\n          <span class="na">onCountryChanged</span><span class="p">=</span><span class="si">{</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">setSelectedCountry</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span><span class="si">}</span>\n          <span class="na">savedCountry</span><span class="p">=</span><span class="si">{</span><span class="nx">savedCountry</span><span class="si">}</span>\n        <span class="p">/&gt;</span>\n        <span class="p">&lt;</span><span class="nc">SelectedCountry</span>\n          <span class="na">country</span><span class="p">=</span><span class="si">{</span><span class="nx">selectedCountry</span><span class="si">}</span>\n          <span class="na">onCountrySaved</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">setSavedCountry</span><span class="p">(</span><span class="nx">selectedCountry</span><span class="p">)</span><span class="si">}</span>\n        <span class="p">/&gt;</span>\n      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>\n    <span class="p">&lt;/&gt;</span>\n  <span class="p">);</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>That is the entire implementation of the “Page” component, it’s the most basic React that you can see everywhere, and there is absolutely nothing criminal in this implementation. Except for one thing. Curious, can you see it?</p>\n\n<h3>\n  <a name="refactoring-page-component-with-performance-in-mind" href="#refactoring-page-component-with-performance-in-mind">\n  </a>\n  Refactoring Page component - with performance in mind\n</h3>\n\n<p>I think it is common knowledge by now, that react re-renders components when there is a state or props change. In our Page component when <code>setSelectedCountry</code> or <code>setSavedCountry</code> is called, it will re-render. If the countries array (props) in our Page component changes, it will re-render. And the same goes for <code>CountriesList</code> and <code>SelectedCountry</code> components - when any of their props change, they will re-render.</p>\n\n<p>Also, anyone, who spent some time with React, knows about javascript <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Equality_comparisons_and_sameness">equality comparison</a>, the fact that React does strict equality comparison for props, and the fact that inline functions create new value every time. This leads to the very common (and absolutely wrong btw) belief, that in order to reduce re-renders of <code>CountriesList</code> and <code>SelectedCountry</code> components we need to get rid of re-creating inline functions on every render by wrapping inline functions in <code>useCallback</code>. Even <a href="https://reactjs.org/docs/hooks-reference.html#usecallback">React docs</a> mention <code>useCallback</code> in the same sentence with “prevent unnecessary renders”! See whether this pattern looks familiar:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="c1">// ... same as before</span>\n\n  <span class="kd">const</span> <span class="nx">onCountryChanged</span> <span class="o">=</span> <span class="nx">useCallback</span><span class="p">((</span><span class="nx">c</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">setSelectedCountry</span><span class="p">(</span><span class="nx">c</span><span class="p">),</span> <span class="p">[]);</span>\n  <span class="kd">const</span> <span class="nx">onCountrySaved</span> <span class="o">=</span> <span class="nx">useCallback</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">setSavedCountry</span><span class="p">(</span><span class="nx">selectedCountry</span><span class="p">),</span> <span class="p">[]);</span>\n\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;&gt;</span>\n      ...\n        <span class="p">&lt;</span><span class="nc">CountriesList</span>\n          <span class="na">onCountryChanged</span><span class="p">=</span><span class="si">{</span><span class="nx">onCountryChange</span><span class="si">}</span>\n        <span class="p">/&gt;</span>\n        <span class="p">&lt;</span><span class="nc">SelectedCountry</span>\n          <span class="na">onCountrySaved</span><span class="p">=</span><span class="si">{</span><span class="nx">onCountrySaved</span><span class="si">}</span>\n        <span class="p">/&gt;</span>\n      ...\n    <span class="p">&lt;/&gt;</span>\n  <span class="p">);</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Do you know the funniest part about it? It actually <strong>doesn’t work</strong>. Because it doesn’t take into account the third reason why React components are re-rendered: <strong>when the parent component is re-rendered</strong>. Regardless of the props, <code>CountriesList</code> will always re-render if Page is re-rendered, even if it doesn’t have any props at all.</p>\n\n<p>We can simplify the Page example into just this:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">CountriesList</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Re-render!!!!!</span><span class="dl">"</span><span class="p">);</span>\n  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>countries list, always re-renders<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;;</span>\n<span class="p">};</span>\n\n<span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="kd">const</span> <span class="p">[</span><span class="nx">counter</span><span class="p">,</span> <span class="nx">setCounter</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="kr">number</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>\n\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;&gt;</span>\n      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Country settings<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>\n      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">setCounter</span><span class="p">(</span><span class="nx">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="p">&gt;</span>\n        Click here to re-render Countries list (open the console) <span class="si">{</span><span class="nx">counter</span><span class="si">}</span>\n      <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>\n      <span class="p">&lt;</span><span class="nc">CountriesList</span> <span class="p">/&gt;</span>\n    <span class="p">&lt;/&gt;</span>\n  <span class="p">);</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>And every time we click the button, we’ll see that <code>CountriesList</code> is re-rendered, <strong>even if it doesn’t have any props at all</strong>. <a href="https://codesandbox.io/s/re-renders-simplified-bad-1giei?file=/src/country-settings/page.tsx">Codesandbox code is here</a>.</p>\n\n<p>And this, finally, allows us to solidify the very first rule of this article:</p>\n\n<blockquote>\n<p><b>Rule #1.</b> If the only reason you want to extract your inline functions in props into useCallback is to avoid re-renders of children<br>\n  components: don’t. It doesn’t work.</p>\n</blockquote>\n\n<p>Now, there are <a href="https://overreacted.io/before-you-memo/">a few ways</a> to deal with situations like the above, I am going to use the simplest one for this particular occasion: <a href="https://reactjs.org/docs/hooks-reference.html#usememo">useMemo</a> hook. What it does is it’s essentially “caches” the results of whatever function you pass into it, and only refreshes them when a <em>dependency</em> of <code>useMemo</code> is changed. If I just extract the rendered <code>CountriesList</code> into a variable <code>const list = &lt;ComponentList /&gt;;</code> and then apply <code>useMemo</code> on it, the <code>ComponentList</code> component now will be re-rendered <strong>only when useMemo dependencies will change</strong>.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="kd">const</span> <span class="p">[</span><span class="nx">counter</span><span class="p">,</span> <span class="nx">setCounter</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="kr">number</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>\n\n  <span class="kd">const</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n    <span class="k">return</span> <span class="p">&lt;</span><span class="nc">CountriesList</span> <span class="p">/&gt;;</span>\n  <span class="p">},</span> <span class="p">[]);</span>\n\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;&gt;</span>\n      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Country settings<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>\n      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">setCounter</span><span class="p">(</span><span class="nx">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="p">&gt;</span>\n        Click here to re-render Countries list (open the console) <span class="si">{</span><span class="nx">counter</span><span class="si">}</span>\n      <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>\n      <span class="si">{</span><span class="nx">list</span><span class="si">}</span>\n    <span class="p">&lt;/&gt;</span>\n  <span class="p">);</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Which in this case is never, since it doesn’t have any dependencies. This pattern basically allows me to break out of this “parent re-renders - re-render all the children regardless” loop and take control over it. Check out the <a href="https://codesandbox.io/s/re-renders-simplified-memo-xcv5f?file=/src/country-settings/page.tsx">full example in codesandbox</a>.</p>\n\n<p>The most important thing there to be mindful of is the list of dependencies of <code>useMemo</code>. If it depends on exactly the same thing that causes the parent component to re-render, then it’s going to refresh its cache with every re-render, and essentially becomes useless. For example, if in this simplified example I pass the <code>counter</code> value as a dependency to the <code>list</code> variable (notice: not even a prop to the memoised component!), that will cause <code>useMemo</code> to refresh itself with every state change and will make <code>CountriesList</code> re-render again.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;&gt;</span>\n      <span class="si">{</span><span class="nx">counter</span><span class="si">}</span>\n      <span class="p">&lt;</span><span class="nc">CountriesList</span> <span class="p">/&gt;</span>\n    <span class="p">&lt;/&gt;</span>\n  <span class="p">);</span>\n<span class="p">},</span> <span class="p">[</span><span class="nx">counter</span><span class="p">]);</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p><a href="https://codesandbox.io/s/re-renders-simplified-memo-with-dep-9h433?file=/src/country-settings/page.tsx:363-491"><br>\n  See the codesandbox example.<br>\n</a></p>\n\n<p>Okay, so all of this is great, but how exactly it can be applied to our non-simplified Page component? Well, if we look closely to its implementation again<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="kd">const</span> <span class="p">[</span><span class="nx">selectedCountry</span><span class="p">,</span> <span class="nx">setSelectedCountry</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="nx">Country</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">countries</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>\n  <span class="kd">const</span> <span class="p">[</span><span class="nx">savedCountry</span><span class="p">,</span> <span class="nx">setSavedCountry</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="nx">Country</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">countries</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>\n\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;&gt;</span>\n      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Country settings<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>\n      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">css</span><span class="p">=</span><span class="si">{</span><span class="nx">contentCss</span><span class="si">}</span><span class="p">&gt;</span>\n        <span class="p">&lt;</span><span class="nc">CountriesList</span>\n          <span class="na">countries</span><span class="p">=</span><span class="si">{</span><span class="nx">countries</span><span class="si">}</span>\n          <span class="na">onCountryChanged</span><span class="p">=</span><span class="si">{</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">setSelectedCountry</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span><span class="si">}</span>\n          <span class="na">savedCountry</span><span class="p">=</span><span class="si">{</span><span class="nx">savedCountry</span><span class="si">}</span>\n        <span class="p">/&gt;</span>\n        <span class="p">&lt;</span><span class="nc">SelectedCountry</span>\n          <span class="na">country</span><span class="p">=</span><span class="si">{</span><span class="nx">selectedCountry</span><span class="si">}</span>\n          <span class="na">onCountrySaved</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">setSavedCountry</span><span class="p">(</span><span class="nx">selectedCountry</span><span class="p">)</span><span class="si">}</span>\n        <span class="p">/&gt;</span>\n      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>\n    <span class="p">&lt;/&gt;</span>\n  <span class="p">);</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>we’ll see that:</p>\n\n<ul>\n<li>\n<code>selectedCountry</code> state is never used in <code>CountriesList</code> component</li>\n<li>\n<code>savedCountry</code> state is never used in <code>SelectedCountry</code> component</li>\n</ul>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--BD8Pvr0g--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/r172i5nksygdf3zpukzb.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--BD8Pvr0g--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/r172i5nksygdf3zpukzb.png" alt="Image description" loading="lazy" width="880" height="571"></a></p>\n\n<p>Which means that when <code>selectedCountry</code> state changes, <code>CountriesList</code> component doesn’t need to re-render at all! And the same story with <code>savedCountry</code> state and <code>SelectedCountry</code> component. And I can just extract both of them to variables and memoise them to prevent their unnecessary re-renders:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="kd">const</span> <span class="p">[</span><span class="nx">selectedCountry</span><span class="p">,</span> <span class="nx">setSelectedCountry</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="nx">Country</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">countries</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>\n  <span class="kd">const</span> <span class="p">[</span><span class="nx">savedCountry</span><span class="p">,</span> <span class="nx">setSavedCountry</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="nx">Country</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">countries</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>\n\n  <span class="kd">const</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n    <span class="k">return</span> <span class="p">(</span>\n      <span class="p">&lt;</span><span class="nc">CountriesList</span>\n        <span class="na">countries</span><span class="p">=</span><span class="si">{</span><span class="nx">countries</span><span class="si">}</span>\n        <span class="na">onCountryChanged</span><span class="p">=</span><span class="si">{</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">setSelectedCountry</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span><span class="si">}</span>\n        <span class="na">savedCountry</span><span class="p">=</span><span class="si">{</span><span class="nx">savedCountry</span><span class="si">}</span>\n      <span class="p">/&gt;</span>\n    <span class="p">);</span>\n  <span class="p">},</span> <span class="p">[</span><span class="nx">savedCountry</span><span class="p">,</span> <span class="nx">countries</span><span class="p">]);</span>\n\n  <span class="kd">const</span> <span class="nx">selected</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n    <span class="k">return</span> <span class="p">(</span>\n      <span class="p">&lt;</span><span class="nc">SelectedCountry</span>\n        <span class="na">country</span><span class="p">=</span><span class="si">{</span><span class="nx">selectedCountry</span><span class="si">}</span>\n        <span class="na">onCountrySaved</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">setSavedCountry</span><span class="p">(</span><span class="nx">selectedCountry</span><span class="p">)</span><span class="si">}</span>\n      <span class="p">/&gt;</span>\n    <span class="p">);</span>\n  <span class="p">},</span> <span class="p">[</span><span class="nx">selectedCountry</span><span class="p">]);</span>\n\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;&gt;</span>\n      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Country settings<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>\n      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">css</span><span class="p">=</span><span class="si">{</span><span class="nx">contentCss</span><span class="si">}</span><span class="p">&gt;</span>\n        <span class="si">{</span><span class="nx">list</span><span class="si">}</span>\n        <span class="si">{</span><span class="nx">selected</span><span class="si">}</span>\n      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>\n    <span class="p">&lt;/&gt;</span>\n  <span class="p">);</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>And this, finally, lets us formalize the second rule of this article:</p>\n\n<blockquote>\n<p><b>Rule #2</b>. If your component manages state, find parts of the render tree that don’t depend on the changed state and memoise them to<br>\n  minimize their re-renders.</p>\n</blockquote>\n\n<h2>\n  <a name="implementing-the-list-of-countries" href="#implementing-the-list-of-countries">\n  </a>\n  Implementing the list of countries\n</h2>\n\n<p>Now, that our Page component is ready and perfect, time to flesh out its children. First, let’s implement the complicated component: <code>CountriesList</code>. We already know, that this component should accept the list of countries, should trigger <code>onCountryChanged</code> callback when a country is selected in the list, and should highlight the <code>savedCountry</code> into a different color, according to design. So let’s start with the simplest approach:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="kd">type</span> <span class="nx">CountriesListProps</span> <span class="o">=</span> <span class="p">{</span>\n  <span class="na">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[];</span>\n  <span class="nl">onCountryChanged</span><span class="p">:</span> <span class="p">(</span><span class="na">country</span><span class="p">:</span> <span class="nx">Country</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>\n  <span class="nl">savedCountry</span><span class="p">:</span> <span class="nx">Country</span><span class="p">;</span>\n<span class="p">};</span>\n\n<span class="k">export</span> <span class="kd">const</span> <span class="nx">CountriesList</span> <span class="o">=</span> <span class="p">({</span>\n  <span class="nx">countries</span><span class="p">,</span>\n  <span class="nx">onCountryChanged</span><span class="p">,</span>\n  <span class="nx">savedCountry</span>\n<span class="p">}:</span> <span class="nx">CountriesListProps</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="kd">const</span> <span class="nx">Item</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">country</span> <span class="p">}:</span> <span class="p">{</span> <span class="na">country</span><span class="p">:</span> <span class="nx">Country</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n    <span class="c1">// different className based on whether this item is "saved" or not</span>\n    <span class="kd">const</span> <span class="nx">className</span> <span class="o">=</span> <span class="nx">savedCountry</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">country</span><span class="p">.</span><span class="nx">id</span> <span class="p">?</span> <span class="dl">"</span><span class="s2">country-item saved</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">country-item</span><span class="dl">"</span><span class="p">;</span>\n\n    <span class="c1">// when the item is clicked - trigger the callback from props with the correct country in the arguments</span>\n    <span class="kd">const</span> <span class="nx">onItemClick</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">onCountryChanged</span><span class="p">(</span><span class="nx">country</span><span class="p">);</span>\n    <span class="k">return</span> <span class="p">(</span>\n      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">className</span><span class="p">=</span><span class="si">{</span><span class="nx">className</span><span class="si">}</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="nx">onItemClick</span><span class="si">}</span><span class="p">&gt;</span>\n        <span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="p">=</span><span class="si">{</span><span class="nx">country</span><span class="p">.</span><span class="nx">flagUrl</span><span class="si">}</span> <span class="p">/&gt;</span>\n        <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">country</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>\n      <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>\n    <span class="p">);</span>\n  <span class="p">};</span>\n\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>\n      <span class="si">{</span><span class="nx">countries</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">country</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span>\n        <span class="p">&lt;</span><span class="nc">Item</span> <span class="na">country</span><span class="p">=</span><span class="si">{</span><span class="nx">country</span><span class="si">}</span> <span class="na">key</span><span class="p">=</span><span class="si">{</span><span class="nx">country</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span> <span class="p">/&gt;</span>\n      <span class="p">))</span><span class="si">}</span>\n    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>\n  <span class="p">);</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Again, the simplest component ever, only 2 things are happening there, really:</p>\n\n<ul>\n<li>we generate the <code>Item</code> based on the props we receive (it depends on both <code>onCountryChanged</code> and <code>savedCountry</code>)</li>\n<li>we render that <code>Item</code> for all countries in a loop</li>\n</ul>\n\n<p>And again, there is nothing criminal about any of this <em>per se</em>, I have seen this pattern used pretty much everywhere.</p>\n\n<h3>\n  <a name="refactoring-list-of-countries-component-with-performance-in-mind" href="#refactoring-list-of-countries-component-with-performance-in-mind">\n  </a>\n  Refactoring List of countries component - with performance in mind\n</h3>\n\n<p>Time again to refresh a bit our knowledge of how React renders things, this time - what will happen if a component, like <code>Item</code> component from above, is created <em>during another component render</em>? Short answer - nothing good, really. From React’s perspective, this <code>Item</code> is just a function that is new on every render, and that returns a new result on every render. So what it will do, is on <strong>every render</strong> it will re-create results of this function from scratch, i.e. it will just compare the previous component state with the current one, like it happens during normal re-render. It will drop the previously generated component, including its DOM tree, remove it from the page, and will generate and mount a completely new component, with a completely new DOM tree every single time the parent component is re-rendered.</p>\n\n<p>If we simplify the countries example to demonstrate this effect, it will be something like this:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">CountriesList</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="kd">const</span> <span class="nx">Item</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">country</span> <span class="p">}:</span> <span class="p">{</span> <span class="na">country</span><span class="p">:</span> <span class="nx">Country</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n    <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Mounted!</span><span class="dl">"</span><span class="p">);</span>\n    <span class="p">},</span> <span class="p">[]);</span>\n    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Render</span><span class="dl">"</span><span class="p">);</span>\n    <span class="k">return</span> <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">country</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;;</span>\n  <span class="p">};</span>\n\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;&gt;</span>\n      <span class="si">{</span><span class="nx">countries</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">country</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span>\n        <span class="p">&lt;</span><span class="nc">Item</span> <span class="na">country</span><span class="p">=</span><span class="si">{</span><span class="nx">country</span><span class="si">}</span> <span class="p">/&gt;</span>\n      <span class="p">))</span><span class="si">}</span>\n    <span class="p">&lt;/&gt;</span>\n  <span class="p">);</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>This is the heaviest operation from them all in React. 10 “normal” re-renders is nothing compared to the full re-mounting of a freshly created component from a performance perspective. In normal circumstances, <code>useEffect</code> with an empty dependencies array would be triggered only once - after the component finished its mounting and very first rendering. After that the light-weight re-rendering process in React kicks in, and component is not created from scratch, but only updated when needed (that’s what makes React so fast btw). Not in this scenario though - take a look at <a href="https://codesandbox.io/s/creating-components-in-render-bad-8otem?file=/src/country-settings/page.tsx">this codesandbox</a>, click on the “re-render” button with open console, and enjoy 250 renders AND mountings happening on every click.</p>\n\n<p>The fix for this is obvious and easy: we just need to move the <code>Item</code> component outside of the render function.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">Item</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">country</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">country</span><span class="p">:</span> <span class="nx">Country</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Mounted!</span><span class="dl">"</span><span class="p">);</span>\n  <span class="p">},</span> <span class="p">[]);</span>\n  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Render</span><span class="dl">"</span><span class="p">);</span>\n  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">country</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;;</span>\n<span class="p">};</span>\n\n<span class="kd">const</span> <span class="nx">CountriesList</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;&gt;</span>\n      <span class="si">{</span><span class="nx">countries</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">country</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span>\n        <span class="p">&lt;</span><span class="nc">Item</span> <span class="na">country</span><span class="p">=</span><span class="si">{</span><span class="nx">country</span><span class="si">}</span> <span class="p">/&gt;</span>\n      <span class="p">))</span><span class="si">}</span>\n    <span class="p">&lt;/&gt;</span>\n  <span class="p">);</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Now in our <a href="https://codesandbox.io/s/creating-components-in-render-fixed-cs7pe?file=/src/country-settings/page.tsx">simplified codesandbox</a> mounting doesn’t happen on every re-render of the parent component.</p>\n\n<p>As a bonus, refactoring like this helps maintain healthy boundaries between different components and keep the code cleaner and more concise. This is going to be especially visible when we apply this improvement to our “real” app. Before:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">CountriesList</span> <span class="o">=</span> <span class="p">({</span>\n  <span class="nx">countries</span><span class="p">,</span>\n  <span class="nx">onCountryChanged</span><span class="p">,</span>\n  <span class="nx">savedCountry</span>\n<span class="p">}:</span> <span class="nx">CountriesListProps</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>\n\n  <span class="c1">// only "country" in props</span>\n  <span class="kd">const</span> <span class="nx">Item</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">country</span> <span class="p">}:</span> <span class="p">{</span> <span class="na">country</span><span class="p">:</span> <span class="nx">Country</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n    <span class="c1">// ... same code</span>\n  <span class="p">};</span>\n\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>\n      <span class="si">{</span><span class="nx">countries</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">country</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span>\n        <span class="p">&lt;</span><span class="nc">Item</span> <span class="na">country</span><span class="p">=</span><span class="si">{</span><span class="nx">country</span><span class="si">}</span> <span class="na">key</span><span class="p">=</span><span class="si">{</span><span class="nx">country</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span> <span class="p">/&gt;</span>\n      <span class="p">))</span><span class="si">}</span>\n    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>\n  <span class="p">);</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>After:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="kd">type</span> <span class="nx">ItemProps</span> <span class="o">=</span> <span class="p">{</span>\n  <span class="na">country</span><span class="p">:</span> <span class="nx">Country</span><span class="p">;</span>\n  <span class="nl">savedCountry</span><span class="p">:</span> <span class="nx">Country</span><span class="p">;</span>\n  <span class="nl">onItemClick</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>\n<span class="p">};</span>\n\n<span class="c1">// turned out savedCountry and onItemClick were also used</span>\n<span class="c1">// but it was not obvious at all in the previous implementation</span>\n<span class="kd">const</span> <span class="nx">Item</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">country</span><span class="p">,</span> <span class="nx">savedCountry</span><span class="p">,</span> <span class="nx">onItemClick</span> <span class="p">}:</span> <span class="nx">ItemProps</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="c1">// ... same code</span>\n<span class="p">};</span>\n\n<span class="k">export</span> <span class="kd">const</span> <span class="nx">CountriesList</span> <span class="o">=</span> <span class="p">({</span>\n  <span class="nx">countries</span><span class="p">,</span>\n  <span class="nx">onCountryChanged</span><span class="p">,</span>\n  <span class="nx">savedCountry</span>\n<span class="p">}:</span> <span class="nx">CountriesListProps</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>\n      <span class="si">{</span><span class="nx">countries</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">country</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span>\n        <span class="p">&lt;</span><span class="nc">Item</span>\n          <span class="na">country</span><span class="p">=</span><span class="si">{</span><span class="nx">country</span><span class="si">}</span>\n          <span class="na">key</span><span class="p">=</span><span class="si">{</span><span class="nx">country</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span>\n          <span class="na">savedCountry</span><span class="p">=</span><span class="si">{</span><span class="nx">savedCountry</span><span class="si">}</span>\n          <span class="na">onItemClick</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">onCountryChanged</span><span class="p">(</span><span class="nx">country</span><span class="p">)</span><span class="si">}</span>\n        <span class="p">/&gt;</span>\n      <span class="p">))</span><span class="si">}</span>\n    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>\n  <span class="p">);</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Now, that we got rid of the re-mounting of <code>Item</code> component every time the parent component is re-rendered, we can extract the third rule of the article:</p>\n\n<blockquote>\n<p><b>Rule #3</b>. Never create new components inside the render function of another component.</p>\n</blockquote>\n\n<h2>\n  <a name="implementing-selected-country" href="#implementing-selected-country">\n  </a>\n  Implementing selected country\n</h2>\n\n<p>Next step: the “selected country” component, which is going to be the shortest and the most boring part of the article, since there is nothing to show there really: it’s just a component that accepts a property and a callback, and renders a few strings:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">SelectedCountry</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">country</span><span class="p">,</span> <span class="nx">onSaveCountry</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">country</span><span class="p">:</span> <span class="nx">Country</span><span class="p">;</span> <span class="nl">onSaveCountry</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;&gt;</span>\n      <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>\n        <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>Country: <span class="si">{</span><span class="nx">country</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>\n        ... // whatever country\'s information we\'re going to render\n      <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>\n      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="nx">onSaveCountry</span><span class="si">}</span> <span class="na">type</span><span class="p">=</span><span class="s">"button"</span><span class="p">&gt;</span>Save<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>\n    <span class="p">&lt;/&gt;</span>\n  <span class="p">);</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>🤷🏽‍♀️ That’s it! It’s only here just to make the demo codesandbox more interesting 🙂</p>\n\n<h2>\n  <a name="final-polish-theming" href="#final-polish-theming">\n  </a>\n  Final polish: theming\n</h2>\n\n<p>And now the final step: dark mode! Who doesn’t love those? Considering that the current theme should be available in most components, passing it through props everywhere would be a nightmare, so React Context is the natural solution here.</p>\n\n<p>Creating theme context first:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="kd">type</span> <span class="nx">Mode</span> <span class="o">=</span> <span class="dl">\'</span><span class="s1">light</span><span class="dl">\'</span> <span class="o">|</span> <span class="dl">\'</span><span class="s1">dark</span><span class="dl">\'</span><span class="p">;</span>\n<span class="kd">type</span> <span class="nx">Theme</span> <span class="o">=</span> <span class="p">{</span> <span class="na">mode</span><span class="p">:</span> <span class="nx">Mode</span> <span class="p">};</span>\n<span class="kd">const</span> <span class="nx">ThemeContext</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createContext</span><span class="o">&lt;</span><span class="nx">Theme</span><span class="o">&gt;</span><span class="p">({</span> <span class="na">mode</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">light</span><span class="dl">\'</span> <span class="p">});</span>\n\n<span class="kd">const</span> <span class="nx">useTheme</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="k">return</span> <span class="nx">useContext</span><span class="p">(</span><span class="nx">ThemeContext</span><span class="p">);</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Adding context provider and the button to switch it to the Page component:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="c1">// same as before</span>\n  <span class="kd">const</span> <span class="p">[</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">setMode</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="nx">Mode</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">"</span><span class="s2">light</span><span class="dl">"</span><span class="p">);</span>\n\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;</span><span class="nc">ThemeContext</span><span class="p">.</span><span class="nc">Provider</span> <span class="na">value</span><span class="p">=</span><span class="si">{</span><span class="p">{</span> <span class="nx">mode</span> <span class="p">}</span><span class="si">}</span><span class="p">&gt;</span>\n      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">setMode</span><span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="dl">\'</span><span class="s1">light</span><span class="dl">\'</span> <span class="p">?</span> <span class="dl">\'</span><span class="s1">dark</span><span class="dl">\'</span> <span class="p">:</span> <span class="dl">\'</span><span class="s1">light</span><span class="dl">\'</span><span class="p">)</span><span class="si">}</span><span class="p">&gt;</span>Toggle theme<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>\n      // the rest is the same as before\n    <span class="p">&lt;/</span><span class="nc">ThemeContext</span><span class="p">.</span><span class="nc">Provider</span><span class="p">&gt;</span>\n  <span class="p">)</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>And then using the context hook to color our buttons in the appropriate theme:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">Item</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">country</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">country</span><span class="p">:</span> <span class="nx">Country</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n    <span class="kd">const</span> <span class="p">{</span> <span class="nx">mode</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useTheme</span><span class="p">();</span>\n    <span class="kd">const</span> <span class="nx">className</span> <span class="o">=</span> <span class="s2">`country-item </span><span class="p">${</span><span class="nx">mode</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">dark</span><span class="dl">"</span> <span class="p">?</span> <span class="dl">"</span><span class="s2">dark</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">""</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>\n    <span class="c1">// the rest is the same</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Again, nothing criminal in this implementation, a very common pattern, especially for theming.</p>\n\n<h3>\n  <a name="refactoring-theming-with-performance-in-mind" href="#refactoring-theming-with-performance-in-mind">\n  </a>\n  Refactoring theming - with performance in mind.\n</h3>\n\n<p>Before we’ll be able to catch what’s wrong with the implementation above, time to look into a fourth reason why a React component can be re-rendered, that often is forgotten: <b>if a component uses context consumer, it will be re-rendered every time the context provider’s value is changed.</b></p>\n\n<p>Remember our simplified example, where we memoised the render results to avoid their re-renders?<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">Item</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">country</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">country</span><span class="p">:</span> <span class="nx">Country</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">render</span><span class="dl">"</span><span class="p">);</span>\n  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">country</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;;</span>\n<span class="p">};</span>\n\n<span class="kd">const</span> <span class="nx">CountriesList</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;&gt;</span>\n      <span class="si">{</span><span class="nx">countries</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">country</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span>\n        <span class="p">&lt;</span><span class="nc">Item</span> <span class="na">country</span><span class="p">=</span><span class="si">{</span><span class="nx">country</span><span class="si">}</span> <span class="p">/&gt;</span>\n      <span class="p">))</span><span class="si">}</span>\n    <span class="p">&lt;/&gt;</span>\n  <span class="p">);</span>\n<span class="p">};</span>\n\n<span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="kd">const</span> <span class="p">[</span><span class="nx">counter</span><span class="p">,</span> <span class="nx">setCounter</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="kr">number</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>\n\n  <span class="kd">const</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">&lt;</span><span class="nc">CountriesList</span> <span class="na">countries</span><span class="p">=</span><span class="si">{</span><span class="nx">countries</span><span class="si">}</span> <span class="p">/&gt;,</span> <span class="p">[</span>\n    <span class="nx">countries</span>\n  <span class="p">]);</span>\n\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;&gt;</span>\n      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Country settings<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>\n      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">setCounter</span><span class="p">(</span><span class="nx">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="p">&gt;</span>\n        Click here to re-render Countries list (open the console) <span class="si">{</span><span class="nx">counter</span><span class="si">}</span>\n      <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>\n      <span class="si">{</span><span class="nx">list</span><span class="si">}</span>\n    <span class="p">&lt;/&gt;</span>\n  <span class="p">);</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p><code>Page</code> component will re-render every time we click the button since it updates the state on every click. But <code>CountriesList</code> is memoised and is independent of that state, so it won’t re-render, and as a result <code>Item</code> component won’t re-render as well. See the <a href="https://codesandbox.io/s/context-before-good-duhgf?file=/src/country-settings/page.tsx">codesandbox here</a>.</p>\n\n<p>Now, what will happen if I add the Theme context here? Provider in the <code>Page</code> component:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="c1">// everything else stays the same</span>\n\n  <span class="c1">// memoised list is still memoised</span>\n  <span class="kd">const</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">&lt;</span><span class="nc">CountriesList</span> <span class="na">countries</span><span class="p">=</span><span class="si">{</span><span class="nx">countries</span><span class="si">}</span> <span class="p">/&gt;,</span> <span class="p">[</span>\n    <span class="nx">countries</span>\n  <span class="p">]);</span>\n\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;</span><span class="nc">ThemeContext</span><span class="p">.</span><span class="nc">Provider</span> <span class="na">value</span><span class="p">=</span><span class="si">{</span><span class="p">{</span> <span class="nx">mode</span> <span class="p">}</span><span class="si">}</span><span class="p">&gt;</span>\n      // same\n    <span class="p">&lt;/</span><span class="nc">ThemeContext</span><span class="p">.</span><span class="nc">Provider</span><span class="p">&gt;</span>\n  <span class="p">);</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>And context in the Item component:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">Item</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">country</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">country</span><span class="p">:</span> <span class="nx">Country</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="kd">const</span> <span class="nx">theme</span> <span class="o">=</span> <span class="nx">useTheme</span><span class="p">();</span>\n  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">render</span><span class="dl">"</span><span class="p">);</span>\n  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">country</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;;</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>If they were just normal components and hooks, nothing would’ve happened - <code>Item</code> is not a child of <code>Page</code> component, <code>CountriesList</code> won’t re-render because of memoisation, so <code>Item</code> wouldn’t either. Except, in this case, it’s a Provider-consumer combination, so every time the value on the provider changes, <strong>all</strong> of the consumers will re-render. And since we’re passing new object to the value all the time, <em><code>Items</code> will unnecessary re-render on every counter</em>. Context basically bypasses the memorisation we did and makes it pretty much useless. <a href="https://codesandbox.io/s/context-bad-4zou7?file=/src/country-settings/page.tsx">See the codesandbox.</a></p>\n\n<p>The fix to it, as you might have already guessed, is just to make sure that the <code>value</code> in the provider doesn’t change more than it needs to. In our case, we just need to memoise it as well:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="c1">// everything else stays the same</span>\n\n  <span class="c1">// memoising the object!</span>\n  <span class="kd">const</span> <span class="nx">theme</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="nx">mode</span> <span class="p">}),</span> <span class="p">[</span><span class="nx">mode</span><span class="p">]);</span>\n\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;</span><span class="nc">ThemeContext</span><span class="p">.</span><span class="nc">Provider</span> <span class="na">value</span><span class="p">=</span><span class="si">{</span><span class="nx">theme</span><span class="si">}</span><span class="p">&gt;</span>\n      // same\n    <span class="p">&lt;/</span><span class="nc">ThemeContext</span><span class="p">.</span><span class="nc">Provider</span><span class="p">&gt;</span>\n  <span class="p">);</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>And now the counter will work without causing all the Items to re-render!</p>\n\n<p>And absolutely the same solution for preventing unnecessary re-renders we can apply to our non-simplified <code>Page</code> component:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="c1">// same as before</span>\n  <span class="kd">const</span> <span class="p">[</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">setMode</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="nx">Mode</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">"</span><span class="s2">light</span><span class="dl">"</span><span class="p">);</span>\n\n  <span class="c1">// memoising the object!</span>\n  <span class="kd">const</span> <span class="nx">theme</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="nx">mode</span> <span class="p">}),</span> <span class="p">[</span><span class="nx">mode</span><span class="p">]);</span>\n\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;</span><span class="nc">ThemeContext</span><span class="p">.</span><span class="nc">Provider</span> <span class="na">value</span><span class="p">=</span><span class="si">{</span><span class="nx">theme</span><span class="si">}</span><span class="p">&gt;</span>\n      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">setMode</span><span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="dl">\'</span><span class="s1">light</span><span class="dl">\'</span> <span class="p">?</span> <span class="dl">\'</span><span class="s1">dark</span><span class="dl">\'</span> <span class="p">:</span> <span class="dl">\'</span><span class="s1">light</span><span class="dl">\'</span><span class="p">)</span><span class="si">}</span><span class="p">&gt;</span>Toggle theme<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>\n      // the rest is the same as before\n    <span class="p">&lt;/</span><span class="nc">ThemeContext</span><span class="p">.</span><span class="nc">Provider</span><span class="p">&gt;</span>\n  <span class="p">)</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>And extract the new knowledge into the final rule of this article:</p>\n\n<blockquote>\n<p><b>Rule #4</b>: When using context, make sure that value property is always memoised if it’s not a number, string or boolean.</p>\n</blockquote>\n\n<h2>\n  <a name="bringing-it-all-together" href="#bringing-it-all-together">\n  </a>\n  Bringing it all together\n</h2>\n\n<p>And finally, our app is complete! The entire implementation is <a href="https://codesandbox.io/s/re-renders-final-good-luz8s?file=/src/country-settings/page.tsx">available in this codesandbox</a>. Throttle your CPU if you’re on the latest MacBook, to experience the world as the usual customers are, and try to select between different countries on the list. Even with 6x CPU reduction, it’s still blazing fast! 🎉</p>\n\n<p>And now, the big question that I suspect many people have the urge to ask: “But Nadia, React is blazing fast by itself anyway. Surely those ‘optimisations’ that you did won’t make much of a difference on a simple list of just 250 items? Aren’t you exaggerating the importance here?“.</p>\n\n<p>Yeah, when I just started this article, I also thought so. But then I implemented that app in the “non-performant” way. <a href="https://codesandbox.io/s/re-renders-final-bad-4znwe?file=/src/country-settings/page.tsx">Check it out in the codesandbox</a>. I don’t even need to reduce the CPU to see the delay between selecting the items 😱. Reduce it by 6x, and it’s probably the slowest simple list on the planet that doesn’t even work properly (it has a focus bug that the “performant” app doesn’t have). And I haven’t even done anything outrageously and obviously evil there! 😅</p>\n\n<p>So let’s refresh <strong>when React components re-render</strong>:</p>\n\n<ul>\n<li>when props or state have changed</li>\n<li>when parent component re-renders</li>\n<li>when a component uses context and the value of its provider changes</li>\n</ul>\n\n<p>And the rules we extracted:</p>\n\n<p><strong>Rule #1</strong>: If the only reason why you want to extract your inline functions in props into <code>useCallback</code> is to avoid re-renders of children components: don’t. It doesn’t work.</p>\n\n<p><strong>Rule #2</strong>: If your component manages state, find parts of the render tree that don’t depend on the changed state and memoise them to minimize their re-renders.</p>\n\n<p><strong>Rule #3</strong>. <em>Never</em> create new components inside the render function of another component.</p>\n\n<p><strong>Rule #4</strong>. When using context, make sure that <code>value</code> property is <em>always</em> memoised if it’s not a number, string or boolean.</p>\n\n<p>That is it! Hope those rules will help to write more performant apps from the get-go and lead to happier customers who never had to experience slow products anymore.</p>\n\n<h2>\n  <a name="bonus-the-raw-usecallback-endraw-conundrum" href="#bonus-the-raw-usecallback-endraw-conundrum">\n  </a>\n  Bonus: the <code>useCallback</code> conundrum\n</h2>\n\n<p>I feel I need to resolve one mystery before I actually end this article: how can it be possible that <code>useCallback</code> is useless for reducing re-renders, and why then React docs literally say that “[useCallback] is useful when passing callbacks to optimized child components that rely on reference equality to prevent unnecessary renders”? 🤯</p>\n\n<p>The answer is in this phrase: <em>“optimized child components that rely on reference equality”</em>.</p>\n\n<p>There are 2 scenarios applicable here.</p>\n\n<p><strong>First</strong>: the component that received the callback is wrapped in <code>React.memo</code> and has that callback as a dependency. Basically this:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">MemoisedItem</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">memo</span><span class="p">(</span><span class="nx">Item</span><span class="p">);</span>\n\n<span class="kd">const</span> <span class="nx">List</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="c1">// this HAS TO be memoised, otherwise `React.memo` for the Item is useless</span>\n  <span class="kd">const</span> <span class="nx">onClick</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">\'</span><span class="s1">click!</span><span class="dl">\'</span><span class="p">)};</span>\n\n  <span class="k">return</span> <span class="p">&lt;</span><span class="nc">MemoisedItem</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="nx">onClick</span><span class="si">}</span> <span class="na">country</span><span class="p">=</span><span class="s">"Austria"</span> <span class="p">/&gt;</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>or this:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">MemoisedItem</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">memo</span><span class="p">(</span><span class="nx">Item</span><span class="p">,</span> <span class="p">(</span><span class="nx">prev</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">prev</span><span class="p">.</span><span class="nx">onClick</span> <span class="o">!==</span> <span class="nx">next</span><span class="p">.</span><span class="nx">onClick</span><span class="p">);</span>\n\n<span class="kd">const</span> <span class="nx">List</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="c1">// this HAS TO be memoised, otherwise `React.memo` for the Item is useless</span>\n  <span class="kd">const</span> <span class="nx">onClick</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">\'</span><span class="s1">click!</span><span class="dl">\'</span><span class="p">)};</span>\n\n  <span class="k">return</span> <span class="p">&lt;</span><span class="nc">MemoisedItem</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="nx">onClick</span><span class="si">}</span> <span class="na">country</span><span class="p">=</span><span class="s">"Austria"</span> <span class="p">/&gt;</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p><strong>Second</strong>: if the component that received the callback has this callback as a dependency in hooks like <code>useMemo</code>, <code>useCallback</code> or <code>useEffect</code>.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">Item</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">onClick</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n    <span class="c1">// some heavy calculation here</span>\n    <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">...</span>\n    <span class="nx">onClick</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>\n\n  <span class="c1">// if onClick is not memoised, this will be triggered on every single render</span>\n  <span class="p">},</span> <span class="p">[</span><span class="nx">onClick</span><span class="p">])</span>\n  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>something<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>\n<span class="p">}</span>\n<span class="kd">const</span> <span class="nx">List</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="c1">// this HAS TO be memoised, otherwise `useEffect` in Item above</span>\n  <span class="c1">// will be triggered on every single re-render</span>\n  <span class="kd">const</span> <span class="nx">onClick</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">\'</span><span class="s1">click!</span><span class="dl">\'</span><span class="p">)};</span>\n\n  <span class="k">return</span> <span class="p">&lt;</span><span class="nc">Item</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="nx">onClick</span><span class="si">}</span> <span class="na">country</span><span class="p">=</span><span class="s">"Austria"</span> <span class="p">/&gt;</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>None of this can be generalised into a simple “do” or “don’t do”, it can only be used for solving the exact performance problem of the exact component, and not before.</p>\n\n<p>And now the article is finally done, thank you for reading it so far and hope you found it useful! Bleib gesund and see ya next time ✌🏼</p>\n\n<p>...</p>\n\n<p>Originally published at <a href="https://www.developerway.com">https://www.developerway.com</a>. The website has more articles like this 😉</p>\n\n<p><a href="https://www.developerway.com">Subscribe to the newsletter</a>, <a href="https://www.linkedin.com/in/adevnadia/">connect on LinkedIn</a> or <a href="https://twitter.com/adevnadia">follow on Twitter</a> to get notified as soon as the next article comes out.</p>\n\n',e.body_markdown='\n![Image description](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/tr0t9ogsikrkl2rqgr3p.jpg)\n\n\nPerformance and React! Such a fun topic with so many controversial opinions and so many best practices flipping to be the opposite in just 6 months. Is it even possible to say anything definitive here or to make any generalized recommendations?\n\nUsually, performance experts are the proponents of “premature optimisation is the root of all evil” and “measure first” rules. Which loosely translates into “don’t fix that is not broken” and is quite hard to argue with. But I’m going to anyway 😉\n\nWhat I like about React, is that it makes implementing complicated UI interactions incredibly easy. What I don’t like about React, is that it also makes it incredibly easy to make mistakes with huge consequences that are not visible right away. The good news is, it’s also incredibly easy to prevent those mistakes and write code that is performant most of the time right away, thus significantly reducing the time and effort it takes to investigate performance problems since there will be much fewer of those. Basically, “premature optimisation”, when it comes to React and performance, can actually be a good thing and something that everyone should do 😉. You just need to know a few patterns to watch out for in order to do that meaningfully.\n\nSo this is exactly what I want to prove in this article 😊. I’m going to do that by implementing a “real-life” app step by step, first in a “normal” way, using the patterns that you’ll see practically everywhere and surely used multiple times by yourself. And then refactor each step with performance in mind, and extract a generalized rule from every step that can be applied to most apps most of the time. And then compare the result in the end.\n\nLet’s begin!\n\nWe are going to write one of the “settings” page for an online shop (that we introduced into the previous “Advanced typescript for React developers” articles). On this page, users will be able to select a country from the list, see all the information available for this country (like currency, delivery methods, etc), and then save this country as their country of choice. The page would look something like this:\n\n\n![Image description](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/8mjrlrsd6ru0hawgdiwr.png)\n\n\nOn the left we’ll have a list of countries, with “saved” and “selected” states, when an item in the list is clicked, in the column on the right the detailed information is shown. When the “save” button is pressed, the “selected” country becomes “saved”, with the different item colour.\n\nOh, and we’d want the dark mode there of course, it’s 2022 after all!\n\nAlso, considering that in 90% of the cases performance problems in React can be summarised as “too many re-renders”, we are going to focus mostly on reducing those in the article. (Another 10% are: “renders are too heavy” and “really weird stuff that need further investigation”.)\n\n## Let\'s structure our app first\n\nFirst of all, let\'s take a look at the design, draw imaginary boundaries, and draft the structure of our future app and which components we’d need to implement there:\n\n- a root “Page” component, where we’d handle the “submit” logic and country selection logic\n- a “List of countries” component, that would render all the countries in a list, and in the future handle things like filtering and sorting\n- “Item” component, that renders the country in the “List of countries”\n- a “Selected country” component, that renders detailed information about the selected country and has the “Save” button\n\n\n![Image description](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/5hgwpox2cfo73rad3059.png)\n\n\nThis is, of course, not the only possible way to implement this page, that’s the beauty and the curse of React: everything can be implemented in a million ways and there is no right or wrong answer for anything. But there are some patterns that in the long run in fast-growing or large already apps can definitely be called **“never do this”** or **“this is a must-have”**.\n\nLet’s see whether we can figure them out together 🙂\n\n\n## Implementing Page component\n\nNow, finally, the time to get our hands dirty and do some coding. Let’s start from the “root” and implement the Page component.\n\nFirst: we need a wrapper with some styles that renders page title, “List of countries” and “Selected country” components.\n\nSecond: out page should receive the list of countries from somewhere, and then pass it to the `CountriesList` component so that it could render those.\n\nThird: our page should have an idea of a “selected” country, that will be received from the `CountriesList` component and passed to the `SelectedCountry` component.\n\nAnd finally: our page should have an idea of a “saved” country, that will be received from the `SelectedCountry` component and passed to the `CountriesList` component (and be sent to the backend in the future).\n\n```tsx\nexport const Page = ({ countries }: { countries: Country[] }) => {\n  const [selectedCountry, setSelectedCountry] = useState<Country>(countries[0]);\n  const [savedCountry, setSavedCountry] = useState<Country>(countries[0]);\n\n  return (\n    <>\n      <h1>Country settings</h1>\n      <div css={contentCss}>\n        <CountriesList\n          countries={countries}\n          onCountryChanged={(c) => setSelectedCountry(c)}\n          savedCountry={savedCountry}\n        />\n        <SelectedCountry\n          country={selectedCountry}\n          onCountrySaved={() => setSavedCountry(selectedCountry)}\n        />\n      </div>\n    </>\n  );\n};\n```\n\nThat is the entire implementation of the “Page” component, it’s the most basic React that you can see everywhere, and there is absolutely nothing criminal in this implementation. Except for one thing. Curious, can you see it?\n\n### Refactoring Page component - with performance in mind\n\nI think it is common knowledge by now, that react re-renders components when there is a state or props change. In our Page component when `setSelectedCountry` or `setSavedCountry` is called, it will re-render. If the countries array (props) in our Page component changes, it will re-render. And the same goes for `CountriesList` and `SelectedCountry` components - when any of their props change, they will re-render.\n\nAlso, anyone, who spent some time with React, knows about javascript <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Equality_comparisons_and_sameness">equality comparison</a>, the fact that React does strict equality comparison for props, and the fact that inline functions create new value every time. This leads to the very common (and absolutely wrong btw) belief, that in order to reduce re-renders of `CountriesList` and `SelectedCountry` components we need to get rid of re-creating inline functions on every render by wrapping inline functions in `useCallback`. Even <a href="https://reactjs.org/docs/hooks-reference.html#usecallback">React docs</a> mention `useCallback` in the same sentence with “prevent unnecessary renders”! See whether this pattern looks familiar:\n\n```tsx\nexport const Page = ({ countries }: { countries: Country[] }) => {\n  // ... same as before\n\n  const onCountryChanged = useCallback((c) => setSelectedCountry(c), []);\n  const onCountrySaved = useCallback(() => setSavedCountry(selectedCountry), []);\n\n  return (\n    <>\n      ...\n        <CountriesList\n          onCountryChanged={onCountryChange}\n        />\n        <SelectedCountry\n          onCountrySaved={onCountrySaved}\n        />\n      ...\n    </>\n  );\n};\n```\n\nDo you know the funniest part about it? It actually **doesn’t work**. Because it doesn’t take into account the third reason why React components are re-rendered: **when the parent component is re-rendered**. Regardless of the props, `CountriesList` will always re-render if Page is re-rendered, even if it doesn’t have any props at all.\n\nWe can simplify the Page example into just this:\n\n```tsx\nconst CountriesList = () => {\n  console.log("Re-render!!!!!");\n  return <div>countries list, always re-renders</div>;\n};\n\nexport const Page = ({ countries }: { countries: Country[] }) => {\n  const [counter, setCounter] = useState<number>(1);\n\n  return (\n    <>\n      <h1>Country settings</h1>\n      <button onClick={() => setCounter(counter + 1)}>\n        Click here to re-render Countries list (open the console) {counter}\n      </button>\n      <CountriesList />\n    </>\n  );\n};\n```\n\nAnd every time we click the button, we’ll see that `CountriesList` is re-rendered, **even if it doesn’t have any props at all**. <a href="https://codesandbox.io/s/re-renders-simplified-bad-1giei?file=/src/country-settings/page.tsx">Codesandbox code is here</a>.\n\nAnd this, finally, allows us to solidify the very first rule of this article:\n\n> <b>Rule #1.</b> If the only reason you want to extract your inline functions in props into useCallback is to avoid re-renders of children\n  components: don’t. It doesn’t work.\n\nNow, there are <a href="https://overreacted.io/before-you-memo/">a few ways</a> to deal with situations like the above, I am going to use the simplest one for this particular occasion: <a href="https://reactjs.org/docs/hooks-reference.html#usememo">useMemo</a> hook. What it does is it’s essentially “caches” the results of whatever function you pass into it, and only refreshes them when a _dependency_ of `useMemo` is changed. If I just extract the rendered `CountriesList` into a variable `const list = <ComponentList />;` and then apply `useMemo` on it, the `ComponentList` component now will be re-rendered **only when useMemo dependencies will change**.\n\n```tsx\nexport const Page = ({ countries }: { countries: Country[] }) => {\n  const [counter, setCounter] = useState<number>(1);\n\n  const list = useMemo(() => {\n    return <CountriesList />;\n  }, []);\n\n  return (\n    <>\n      <h1>Country settings</h1>\n      <button onClick={() => setCounter(counter + 1)}>\n        Click here to re-render Countries list (open the console) {counter}\n      </button>\n      {list}\n    </>\n  );\n};\n```\n\nWhich in this case is never, since it doesn’t have any dependencies. This pattern basically allows me to break out of this “parent re-renders - re-render all the children regardless” loop and take control over it. Check out the <a href="https://codesandbox.io/s/re-renders-simplified-memo-xcv5f?file=/src/country-settings/page.tsx">full example in codesandbox</a>.\n\nThe most important thing there to be mindful of is the list of dependencies of `useMemo`. If it depends on exactly the same thing that causes the parent component to re-render, then it’s going to refresh its cache with every re-render, and essentially becomes useless. For example, if in this simplified example I pass the `counter` value as a dependency to the `list` variable (notice: not even a prop to the memoised component!), that will cause `useMemo` to refresh itself with every state change and will make `CountriesList` re-render again.\n\n```tsx\nconst list = useMemo(() => {\n  return (\n    <>\n      {counter}\n      <CountriesList />\n    </>\n  );\n}, [counter]);\n```\n\n<a href="https://codesandbox.io/s/re-renders-simplified-memo-with-dep-9h433?file=/src/country-settings/page.tsx:363-491">\n  See the codesandbox example.\n</a>\n\nOkay, so all of this is great, but how exactly it can be applied to our non-simplified Page component? Well, if we look closely to its implementation again\n\n```tsx\nexport const Page = ({ countries }: { countries: Country[] }) => {\n  const [selectedCountry, setSelectedCountry] = useState<Country>(countries[0]);\n  const [savedCountry, setSavedCountry] = useState<Country>(countries[0]);\n\n  return (\n    <>\n      <h1>Country settings</h1>\n      <div css={contentCss}>\n        <CountriesList\n          countries={countries}\n          onCountryChanged={(c) => setSelectedCountry(c)}\n          savedCountry={savedCountry}\n        />\n        <SelectedCountry\n          country={selectedCountry}\n          onCountrySaved={() => setSavedCountry(selectedCountry)}\n        />\n      </div>\n    </>\n  );\n};\n```\n\nwe’ll see that:\n\n- `selectedCountry` state is never used in `CountriesList` component\n- `savedCountry` state is never used in `SelectedCountry` component\n\n\n![Image description](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/r172i5nksygdf3zpukzb.png)\n\n\nWhich means that when `selectedCountry` state changes, `CountriesList` component doesn’t need to re-render at all! And the same story with `savedCountry` state and `SelectedCountry` component. And I can just extract both of them to variables and memoise them to prevent their unnecessary re-renders:\n\n```tsx\nexport const Page = ({ countries }: { countries: Country[] }) => {\n  const [selectedCountry, setSelectedCountry] = useState<Country>(countries[0]);\n  const [savedCountry, setSavedCountry] = useState<Country>(countries[0]);\n\n  const list = useMemo(() => {\n    return (\n      <CountriesList\n        countries={countries}\n        onCountryChanged={(c) => setSelectedCountry(c)}\n        savedCountry={savedCountry}\n      />\n    );\n  }, [savedCountry, countries]);\n\n  const selected = useMemo(() => {\n    return (\n      <SelectedCountry\n        country={selectedCountry}\n        onCountrySaved={() => setSavedCountry(selectedCountry)}\n      />\n    );\n  }, [selectedCountry]);\n\n  return (\n    <>\n      <h1>Country settings</h1>\n      <div css={contentCss}>\n        {list}\n        {selected}\n      </div>\n    </>\n  );\n};\n```\n\nAnd this, finally, lets us formalize the second rule of this article:\n\n> <b>Rule #2</b>. If your component manages state, find parts of the render tree that don’t depend on the changed state and memoise them to\n  minimize their re-renders.\n\n\n## Implementing the list of countries\n\nNow, that our Page component is ready and perfect, time to flesh out its children. First, let’s implement the complicated component: `CountriesList`. We already know, that this component should accept the list of countries, should trigger `onCountryChanged` callback when a country is selected in the list, and should highlight the `savedCountry` into a different color, according to design. So let’s start with the simplest approach:\n\n```tsx\ntype CountriesListProps = {\n  countries: Country[];\n  onCountryChanged: (country: Country) => void;\n  savedCountry: Country;\n};\n\nexport const CountriesList = ({\n  countries,\n  onCountryChanged,\n  savedCountry\n}: CountriesListProps) => {\n  const Item = ({ country }: { country: Country }) => {\n    // different className based on whether this item is "saved" or not\n    const className = savedCountry.id === country.id ? "country-item saved" : "country-item";\n\n    // when the item is clicked - trigger the callback from props with the correct country in the arguments\n    const onItemClick = () => onCountryChanged(country);\n    return (\n      <button className={className} onClick={onItemClick}>\n        <img src={country.flagUrl} />\n        <span>{country.name}</span>\n      </button>\n    );\n  };\n\n  return (\n    <div>\n      {countries.map((country) => (\n        <Item country={country} key={country.id} />\n      ))}\n    </div>\n  );\n};\n```\n\nAgain, the simplest component ever, only 2 things are happening there, really:\n\n- we generate the `Item` based on the props we receive (it depends on both `onCountryChanged` and `savedCountry`)\n- we render that `Item` for all countries in a loop\n\nAnd again, there is nothing criminal about any of this _per se_, I have seen this pattern used pretty much everywhere.\n\n### Refactoring List of countries component - with performance in mind\n\nTime again to refresh a bit our knowledge of how React renders things, this time - what will happen if a component, like `Item` component from above, is created _during another component render_? Short answer - nothing good, really. From React’s perspective, this `Item` is just a function that is new on every render, and that returns a new result on every render. So what it will do, is on **every render** it will re-create results of this function from scratch, i.e. it will just compare the previous component state with the current one, like it happens during normal re-render. It will drop the previously generated component, including its DOM tree, remove it from the page, and will generate and mount a completely new component, with a completely new DOM tree every single time the parent component is re-rendered.\n\nIf we simplify the countries example to demonstrate this effect, it will be something like this:\n\n```tsx\nconst CountriesList = ({ countries }: { countries: Country[] }) => {\n  const Item = ({ country }: { country: Country }) => {\n    useEffect(() => {\n      console.log("Mounted!");\n    }, []);\n    console.log("Render");\n    return <div>{country.name}</div>;\n  };\n\n  return (\n    <>\n      {countries.map((country) => (\n        <Item country={country} />\n      ))}\n    </>\n  );\n};\n```\n\nThis is the heaviest operation from them all in React. 10 “normal” re-renders is nothing compared to the full re-mounting of a freshly created component from a performance perspective. In normal circumstances, `useEffect` with an empty dependencies array would be triggered only once - after the component finished its mounting and very first rendering. After that the light-weight re-rendering process in React kicks in, and component is not created from scratch, but only updated when needed (that’s what makes React so fast btw). Not in this scenario though - take a look at <a href="https://codesandbox.io/s/creating-components-in-render-bad-8otem?file=/src/country-settings/page.tsx">this codesandbox</a>, click on the “re-render” button with open console, and enjoy 250 renders AND mountings happening on every click.\n\nThe fix for this is obvious and easy: we just need to move the `Item` component outside of the render function.\n\n```tsx\nconst Item = ({ country }: { country: Country }) => {\n  useEffect(() => {\n    console.log("Mounted!");\n  }, []);\n  console.log("Render");\n  return <div>{country.name}</div>;\n};\n\nconst CountriesList = ({ countries }: { countries: Country[] }) => {\n  return (\n    <>\n      {countries.map((country) => (\n        <Item country={country} />\n      ))}\n    </>\n  );\n};\n```\n\nNow in our <a href="https://codesandbox.io/s/creating-components-in-render-fixed-cs7pe?file=/src/country-settings/page.tsx">simplified codesandbox</a> mounting doesn’t happen on every re-render of the parent component.\n\nAs a bonus, refactoring like this helps maintain healthy boundaries between different components and keep the code cleaner and more concise. This is going to be especially visible when we apply this improvement to our “real” app. Before:\n\n```tsx\nexport const CountriesList = ({\n  countries,\n  onCountryChanged,\n  savedCountry\n}: CountriesListProps) => {\n\n  // only "country" in props\n  const Item = ({ country }: { country: Country }) => {\n    // ... same code\n  };\n\n  return (\n    <div>\n      {countries.map((country) => (\n        <Item country={country} key={country.id} />\n      ))}\n    </div>\n  );\n};\n```\n\nAfter:\n\n```tsx\ntype ItemProps = {\n  country: Country;\n  savedCountry: Country;\n  onItemClick: () => void;\n};\n\n// turned out savedCountry and onItemClick were also used\n// but it was not obvious at all in the previous implementation\nconst Item = ({ country, savedCountry, onItemClick }: ItemProps) => {\n  // ... same code\n};\n\nexport const CountriesList = ({\n  countries,\n  onCountryChanged,\n  savedCountry\n}: CountriesListProps) => {\n  return (\n    <div>\n      {countries.map((country) => (\n        <Item\n          country={country}\n          key={country.id}\n          savedCountry={savedCountry}\n          onItemClick={() => onCountryChanged(country)}\n        />\n      ))}\n    </div>\n  );\n};\n```\n\nNow, that we got rid of the re-mounting of `Item` component every time the parent component is re-rendered, we can extract the third rule of the article:\n\n> <b>Rule #3</b>. Never create new components inside the render function of another component.\n\n\n## Implementing selected country\n\nNext step: the “selected country” component, which is going to be the shortest and the most boring part of the article, since there is nothing to show there really: it’s just a component that accepts a property and a callback, and renders a few strings:\n\n```tsx\nconst SelectedCountry = ({ country, onSaveCountry }: { country: Country; onSaveCountry: () => void }) => {\n  return (\n    <>\n      <ul>\n        <li>Country: {country.name}</li>\n        ... // whatever country\'s information we\'re going to render\n      </ul>\n      <button onClick={onSaveCountry} type="button">Save</button>\n    </>\n  );\n};\n```\n\n🤷🏽‍♀️ That’s it! It’s only here just to make the demo codesandbox more interesting 🙂\n\n## Final polish: theming\n\nAnd now the final step: dark mode! Who doesn’t love those? Considering that the current theme should be available in most components, passing it through props everywhere would be a nightmare, so React Context is the natural solution here.\n\nCreating theme context first:\n\n```tsx\ntype Mode = \'light\' | \'dark\';\ntype Theme = { mode: Mode };\nconst ThemeContext = React.createContext<Theme>({ mode: \'light\' });\n\nconst useTheme = () => {\n  return useContext(ThemeContext);\n};\n```\n\nAdding context provider and the button to switch it to the Page component:\n\n```tsx\nexport const Page = ({ countries }: { countries: Country[] }) => {\n  // same as before\n  const [mode, setMode] = useState<Mode>("light");\n\n  return (\n    <ThemeContext.Provider value={{ mode }}>\n      <button onClick={() => setMode(mode === \'light\' ? \'dark\' : \'light\')}>Toggle theme</button>\n      // the rest is the same as before\n    </ThemeContext.Provider>\n  )\n}\n```\n\nAnd then using the context hook to color our buttons in the appropriate theme:\n\n```tsx\nconst Item = ({ country }: { country: Country }) => {\n    const { mode } = useTheme();\n    const className = `country-item ${mode === "dark" ? "dark" : ""}`;\n    // the rest is the same\n}\n```\n\nAgain, nothing criminal in this implementation, a very common pattern, especially for theming.\n\n### Refactoring theming - with performance in mind.\n\nBefore we’ll be able to catch what’s wrong with the implementation above, time to look into a fourth reason why a React component can be re-rendered, that often is forgotten: <b>if a component uses context consumer, it will be re-rendered every time the context provider’s value is changed.</b>\n\nRemember our simplified example, where we memoised the render results to avoid their re-renders?\n\n```tsx\nconst Item = ({ country }: { country: Country }) => {\n  console.log("render");\n  return <div>{country.name}</div>;\n};\n\nconst CountriesList = ({ countries }: { countries: Country[] }) => {\n  return (\n    <>\n      {countries.map((country) => (\n        <Item country={country} />\n      ))}\n    </>\n  );\n};\n\nexport const Page = ({ countries }: { countries: Country[] }) => {\n  const [counter, setCounter] = useState<number>(1);\n\n  const list = useMemo(() => <CountriesList countries={countries} />, [\n    countries\n  ]);\n\n  return (\n    <>\n      <h1>Country settings</h1>\n      <button onClick={() => setCounter(counter + 1)}>\n        Click here to re-render Countries list (open the console) {counter}\n      </button>\n      {list}\n    </>\n  );\n};\n```\n\n`Page` component will re-render every time we click the button since it updates the state on every click. But `CountriesList` is memoised and is independent of that state, so it won’t re-render, and as a result `Item` component won’t re-render as well. See the <a href="https://codesandbox.io/s/context-before-good-duhgf?file=/src/country-settings/page.tsx">codesandbox here</a>.\n\nNow, what will happen if I add the Theme context here? Provider in the `Page` component:\n\n```tsx\nexport const Page = ({ countries }: { countries: Country[] }) => {\n  // everything else stays the same\n\n  // memoised list is still memoised\n  const list = useMemo(() => <CountriesList countries={countries} />, [\n    countries\n  ]);\n\n  return (\n    <ThemeContext.Provider value={{ mode }}>\n      // same\n    </ThemeContext.Provider>\n  );\n};\n```\n\nAnd context in the Item component:\n\n```tsx\nconst Item = ({ country }: { country: Country }) => {\n  const theme = useTheme();\n  console.log("render");\n  return <div>{country.name}</div>;\n};\n```\n\nIf they were just normal components and hooks, nothing would’ve happened - `Item` is not a child of `Page` component, `CountriesList` won’t re-render because of memoisation, so `Item` wouldn’t either. Except, in this case, it’s a Provider-consumer combination, so every time the value on the provider changes, **all** of the consumers will re-render. And since we’re passing new object to the value all the time, _`Items` will unnecessary re-render on every counter_. Context basically bypasses the memorisation we did and makes it pretty much useless. <a href="https://codesandbox.io/s/context-bad-4zou7?file=/src/country-settings/page.tsx">See the codesandbox.</a>\n\nThe fix to it, as you might have already guessed, is just to make sure that the `value` in the provider doesn’t change more than it needs to. In our case, we just need to memoise it as well:\n\n```tsx\nexport const Page = ({ countries }: { countries: Country[] }) => {\n  // everything else stays the same\n\n  // memoising the object!\n  const theme = useMemo(() => ({ mode }), [mode]);\n\n  return (\n    <ThemeContext.Provider value={theme}>\n      // same\n    </ThemeContext.Provider>\n  );\n};\n```\n\nAnd now the counter will work without causing all the Items to re-render!\n\nAnd absolutely the same solution for preventing unnecessary re-renders we can apply to our non-simplified `Page` component:\n\n```tsx\nexport const Page = ({ countries }: { countries: Country[] }) => {\n  // same as before\n  const [mode, setMode] = useState<Mode>("light");\n\n  // memoising the object!\n  const theme = useMemo(() => ({ mode }), [mode]);\n\n  return (\n    <ThemeContext.Provider value={theme}>\n      <button onClick={() => setMode(mode === \'light\' ? \'dark\' : \'light\')}>Toggle theme</button>\n      // the rest is the same as before\n    </ThemeContext.Provider>\n  )\n}\n```\n\nAnd extract the new knowledge into the final rule of this article:\n\n> <b>Rule #4</b>: When using context, make sure that value property is always memoised if it’s not a number, string or boolean.\n\n\n## Bringing it all together\n\nAnd finally, our app is complete! The entire implementation is <a href="https://codesandbox.io/s/re-renders-final-good-luz8s?file=/src/country-settings/page.tsx">available in this codesandbox</a>. Throttle your CPU if you’re on the latest MacBook, to experience the world as the usual customers are, and try to select between different countries on the list. Even with 6x CPU reduction, it’s still blazing fast! 🎉\n\nAnd now, the big question that I suspect many people have the urge to ask: “But Nadia, React is blazing fast by itself anyway. Surely those ‘optimisations’ that you did won’t make much of a difference on a simple list of just 250 items? Aren’t you exaggerating the importance here?“.\n\nYeah, when I just started this article, I also thought so. But then I implemented that app in the “non-performant” way. <a href="https://codesandbox.io/s/re-renders-final-bad-4znwe?file=/src/country-settings/page.tsx">Check it out in the codesandbox</a>. I don’t even need to reduce the CPU to see the delay between selecting the items 😱. Reduce it by 6x, and it’s probably the slowest simple list on the planet that doesn’t even work properly (it has a focus bug that the “performant” app doesn’t have). And I haven’t even done anything outrageously and obviously evil there! 😅\n\nSo let’s refresh **when React components re-render**:\n\n- when props or state have changed\n- when parent component re-renders\n- when a component uses context and the value of its provider changes\n\nAnd the rules we extracted:\n\n**Rule #1**: If the only reason why you want to extract your inline functions in props into `useCallback` is to avoid re-renders of children components: don’t. It doesn’t work.\n\n**Rule #2**: If your component manages state, find parts of the render tree that don’t depend on the changed state and memoise them to minimize their re-renders.\n\n**Rule #3**. _Never_ create new components inside the render function of another component.\n\n**Rule #4**. When using context, make sure that `value` property is _always_ memoised if it’s not a number, string or boolean.\n\nThat is it! Hope those rules will help to write more performant apps from the get-go and lead to happier customers who never had to experience slow products anymore.\n\n## Bonus: the `useCallback` conundrum\n\nI feel I need to resolve one mystery before I actually end this article: how can it be possible that `useCallback` is useless for reducing re-renders, and why then React docs literally say that “[useCallback] is useful when passing callbacks to optimized child components that rely on reference equality to prevent unnecessary renders”? 🤯\n\nThe answer is in this phrase: _“optimized child components that rely on reference equality”_.\n\nThere are 2 scenarios applicable here.\n\n**First**: the component that received the callback is wrapped in `React.memo` and has that callback as a dependency. Basically this:\n\n```tsx\nconst MemoisedItem = React.memo(Item);\n\nconst List = () => {\n  // this HAS TO be memoised, otherwise `React.memo` for the Item is useless\n  const onClick = () => {console.log(\'click!\')};\n\n  return <MemoisedItem onClick={onClick} country="Austria" />\n}\n```\n\nor this:\n\n```tsx\nconst MemoisedItem = React.memo(Item, (prev, next) => prev.onClick !== next.onClick);\n\nconst List = () => {\n  // this HAS TO be memoised, otherwise `React.memo` for the Item is useless\n  const onClick = () => {console.log(\'click!\')};\n\n  return <MemoisedItem onClick={onClick} country="Austria" />\n}\n```\n\n**Second**: if the component that received the callback has this callback as a dependency in hooks like `useMemo`, `useCallback` or `useEffect`.\n\n```tsx\nconst Item = ({ onClick }) => {\n  useEffect(() => {\n    // some heavy calculation here\n    const data = ...\n    onClick(data);\n\n  // if onClick is not memoised, this will be triggered on every single render\n  }, [onClick])\n  return <div>something</div>\n}\nconst List = () => {\n  // this HAS TO be memoised, otherwise `useEffect` in Item above\n  // will be triggered on every single re-render\n  const onClick = () => {console.log(\'click!\')};\n\n  return <Item onClick={onClick} country="Austria" />\n}\n```\n\nNone of this can be generalised into a simple “do” or “don’t do”, it can only be used for solving the exact performance problem of the exact component, and not before.\n\nAnd now the article is finally done, thank you for reading it so far and hope you found it useful! Bleib gesund and see ya next time ✌🏼\n\n...\n\nOriginally published at [https://www.developerway.com](https://www.developerway.com). The website has more articles like this 😉\n\n[Subscribe to the newsletter](https://www.developerway.com), [connect on LinkedIn](https://www.linkedin.com/in/adevnadia/) or [follow on Twitter](https://twitter.com/adevnadia) to get notified as soon as the next article comes out.',e.user={name:"Nadia Makarevich",username:a,twitter_username:a,github_username:a,website_url:"https://www.developerway.com",profile_image:"https://res.cloudinary.com/practicaldev/image/fetch/s--JnKvtJkQ--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/762035/1f7fe6e4-1e60-4c01-80cc-532142263682.jpg",profile_image_90:"https://res.cloudinary.com/practicaldev/image/fetch/s--j3FZXwJO--/c_fill,f_auto,fl_progressive,h_90,q_auto,w_90/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/762035/1f7fe6e4-1e60-4c01-80cc-532142263682.jpg"},{layout:"default",data:[{}],fetch:{"data-v-70afb46a:0":{article:e}},error:s,state:{currentArticle:e},serverRendered:!0,routePath:"/adevnadia/950307",config:{_app:{basePath:"/nuxtstop/",assetsPath:"/nuxtstop/_nuxt/",cdnURL:s}}}}(null,"2022-01-10T11:27:53Z","adevnadia",{})</script><script src="/nuxtstop/_nuxt/f6e87fb.js" defer></script><script src="/nuxtstop/_nuxt/dc9ce94.js" defer></script><script src="/nuxtstop/_nuxt/6474719.js" defer></script><script src="/nuxtstop/_nuxt/9b75090.js" defer></script><script src="/nuxtstop/_nuxt/18df600.js" defer></script>
  </body>
</html>
