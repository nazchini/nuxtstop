<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Why custom react hooks could destroy your app performance</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="Using Nuxt.js fetch() hook to build dev.to with a new look"><meta data-n-head="ssr" name="format-detection" content="telephone=no"><base href="/nuxtstop/"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,500,600&display=swap"><link rel="preload" href="/nuxtstop/_nuxt/f6e87fb.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/6474719.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/9b75090.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/18df600.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/dc9ce94.js" as="script"><style data-vue-ssr-id="c650fd98:0 af4684f0:0 a9c71758:0 dcafa518:0 4b9cec49:0 b093d766:0 9d98bcb4:0 6b6a11ea:0 0248ed80:0 ea8e4264:0">html{box-sizing:border-box;font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}*,:after,:before{box-sizing:inherit}html{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}*,:after,:before{border:0 solid #e0e0e0}blockquote,body,dd,dl,figure,h1,h2,h3,h4,h5,h6,p,pre{margin:0}button{background:0 0;padding:0}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}hr{border-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:inherit;opacity:.5}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:inherit;opacity:.5}input::placeholder,textarea::placeholder{color:inherit;opacity:.5}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit;font-family:sans-serif}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit;font-family:inherit;font-size:100%}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;overflow:auto;word-break:break-word;white-space:normal}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}html{height:100%;font-size:18px;-ms-overflow-style:scrollbar;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}@media(min-width:640px){html{font-size:20px}}body{height:100%;min-width:320px;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:400;line-height:1.5;color:#000;background-color:#eff4f7;-webkit-text-rendering:optimizeLegibility;text-rendering:optimizeLegibility;font-synthesis:none;font-kerning:normal;font-feature-settings:"normal","kern";-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-overflow-scrolling:touch;overflow-x:hidden;overflow-y:scroll}h1,h2,h3,h4,h5,h6{color:#000;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:600;font-feature-settings:"normal";line-height:1.2}pre{background:#29292e;border-radius:2px;overflow:auto;padding:1rem;color:#eff1f9;line-height:1.42em;font-size:13px}@media screen and (min-width:380px){pre{font-size:15px}}pre code{background:#29292e;color:#eff0f9;white-space:pre}div.highlight pre.highlight code{font-size:inherit;padding:0}div.inner-comment div.body div.highlight pre.highlight{background:#29292e}div.inner-comment div.body div.highlight pre.highlight code{font-size:inherit;white-space:inherit;background:inherit;color:inherit}.highlight .hll{background-color:#49483e}.highlight{background:#29292e;color:#f8f8f2}.highlight .c{color:grey}.highlight .err{text-shadow:0 0 7px #f9690e}.highlight .k{color:#f39c12}.highlight .l{color:plum}.highlight .n{color:#f8f8f2}.highlight .o{color:#f9690e}.highlight .p{color:#f8f8f2}.highlight .c1,.highlight .ch,.highlight .cm,.highlight .cp,.highlight .cpf,.highlight .cs{color:grey}.highlight .gd{color:#f9690e}.highlight .ge{font-style:italic}.highlight .gi{color:#7ed07e}.highlight .gs{font-weight:700}.highlight .gu{color:grey}.highlight .kc,.highlight .kd{color:#f39c12}.highlight .kn{color:#f9690e}.highlight .kp,.highlight .kr,.highlight .kt{color:#f39c12}.highlight .ld{color:#f2ca27}.highlight .m{color:plum}.highlight .s{color:#f2ca27}.highlight .na{color:#7ed07e}.highlight .nb{color:#f8f8f2}.highlight .nc{color:#7ed07e}.highlight .no{color:#f39c12}.highlight .nd{color:#7ed07e}.highlight .ni{color:#f8f8f2}.highlight .ne,.highlight .nf{color:#7ed07e}.highlight .nl,.highlight .nn{color:#f8f8f2}.highlight .nx{color:#7ed07e}.highlight .py{color:#f8f8f2}.highlight .nt{color:#f9690e}.highlight .nv{color:#f8f8f2}.highlight .ow{color:#f9690e}.highlight .w{color:#f8f8f2}.highlight .mb,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo{color:plum}.highlight .dl,.highlight .s2,.highlight .sa,.highlight .sb,.highlight .sc,.highlight .sd{color:#f2ca27}.highlight .se{color:plum}.highlight .s1,.highlight .sh,.highlight .si,.highlight .sr,.highlight .ss,.highlight .sx{color:#f2ca27}.highlight .bp{color:#f8f8f2}.highlight .fm{color:#7ed07e}.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{color:#f8f8f2}.highlight .il{color:plum}.vue-content-placeholders-heading__img,.vue-content-placeholders-heading__subtitle,.vue-content-placeholders-heading__title,.vue-content-placeholders-img,.vue-content-placeholders-text__line{background:#bfcdec!important}.vue-content-placeholders-is-animated .vue-content-placeholders-heading__img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__subtitle:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__title:before,.vue-content-placeholders-is-animated .vue-content-placeholders-img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-text__line:before{background:linear-gradient(90deg,transparent 0,#d3ddf9 15%,transparent 30%)!important}header[data-v-27046cca]{max-width:1280px;margin:auto;padding:1rem;height:6rem;border-bottom:1px solid rgba(0,0,0,.2)}header .logo-wrapper[data-v-27046cca],header[data-v-27046cca]{display:flex;align-items:center;justify-content:space-between}header .logo-wrapper[data-v-27046cca]{margin:0 .5rem}header .logo-wrapper svg[data-v-27046cca]{width:3rem;height:100%}header .logo-wrapper .name-wrapper[data-v-27046cca]{margin-left:.6em}header .logo-wrapper .name-wrapper .subtitle[data-v-27046cca]{font-size:1rem}header .logo-wrapper .name-wrapper .app-name[data-v-27046cca]{font-weight:700;font-size:2.25rem;line-height:1.25}header nav[data-v-27046cca]{letter-spacing:-.025rem;font-weight:600;text-transform:uppercase}header nav ul[data-v-27046cca]{display:flex}header nav ul li[data-v-27046cca]{margin:0 .5rem}header nav ul li a[data-v-27046cca]{box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;padding:.25rem 1rem;border-radius:.5rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}header nav ul li a[data-v-27046cca]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header nav ul li a.nuxt-link-exact-active[data-v-27046cca]{cursor:default}header nav ul li a.nuxt-link-exact-active[data-v-27046cca],header nav ul li a[data-v-27046cca]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}.page-wrapper[data-v-10d06ee8]{max-width:1280px;margin:auto;padding:1rem}.article-content-wrapper[data-v-10d06ee8]{display:flex;flex-direction:column;align-items:center;margin:auto auto 2rem}@media(min-width:1024px){.article-content-wrapper[data-v-10d06ee8]{align-items:normal;flex-direction:row}}.article-content-wrapper .article-block[data-v-10d06ee8]{width:100%;max-width:880px}@media(min-width:1024px){.article-content-wrapper .article-block[data-v-10d06ee8]{margin-right:1rem;width:66.66666%;margin-bottom:2rem}}.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{max-width:880px;width:100%;position:relative}@media(min-width:1024px){.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{display:block;width:33.33333%}}.article-content-wrapper .aside-username-wrapper .aside-username-block[data-v-10d06ee8]{position:-webkit-sticky;position:sticky;top:1rem}@media(min-width:1280px){.comments-block[data-v-10d06ee8]{margin:.5rem}}article[data-v-70afb46a]{padding:.5rem;border-radius:1rem}header h1[data-v-70afb46a],header[data-v-70afb46a]{margin-bottom:1rem}header h1[data-v-70afb46a]{font-size:2.25rem;letter-spacing:-.025rem}header .tags[data-v-70afb46a]{display:flex;flex-wrap:wrap;margin-bottom:1.5rem}header .tags .tag[data-v-70afb46a]{font-weight:500;line-height:1;padding:.5rem;margin:0 .5rem .5rem 0;border-radius:.25rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db}header .tags .tag[data-v-70afb46a]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header .tags .tag[data-v-70afb46a]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}header .image-wrapper[data-v-70afb46a]{position:relative;padding-bottom:56.25%;background-color:#d4dfe8;margin-bottom:1.5rem;border-radius:.5rem;overflow:hidden}@media(min-width:834px){header .image-wrapper[data-v-70afb46a]{margin-bottom:1.5rem}}header .image-wrapper img[data-v-70afb46a]{position:absolute;top:0;left:0;width:100%;height:100%;-o-object-fit:cover;object-fit:cover}header .meta[data-v-70afb46a]{line-height:1;font-size:.875rem;text-transform:uppercase;font-weight:500;letter-spacing:-.025rem;display:flex;align-items:center;justify-content:space-between}header .meta .scl[data-v-70afb46a]{display:flex}header .meta .scl span[data-v-70afb46a]{display:flex;align-items:center;margin-right:1rem}header .meta .scl span svg[data-v-70afb46a]{margin-right:.25rem}header .meta .scl .comments[data-v-70afb46a]{cursor:pointer}[data-v-70afb46a] .content .ltag__user{display:none}[data-v-70afb46a] .content iframe{max-width:100%}[data-v-70afb46a] .content h1{font-size:1.875rem}[data-v-70afb46a] .content h1,[data-v-70afb46a] .content h2{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h2{font-size:1.5rem}[data-v-70afb46a] .content h3{font-size:1.25rem}[data-v-70afb46a] .content h3,[data-v-70afb46a] .content h4{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h4{font-size:1rem}[data-v-70afb46a] .content a{color:#6e87d2}[data-v-70afb46a] .content p{margin-bottom:1rem;line-height:1.4}[data-v-70afb46a] .content p code{background-color:#d2f3e1;border-radius:.25rem;padding:.25rem}[data-v-70afb46a] .content img{width:100%;border-radius:.5rem}[data-v-70afb46a] .content .highlight{margin-bottom:1rem;border-radius:.5rem}[data-v-70afb46a] .content ul{list-style:numeral;margin-bottom:1rem}[data-v-70afb46a] .content ul li p{margin-bottom:0}[data-v-70afb46a] .content ol{margin-bottom:1rem}aside[data-v-37984f8c]{padding:1rem;background-color:#dfe8ef;border-radius:1rem}aside .username-heading[data-v-37984f8c]{display:flex;margin-bottom:1rem}aside .username-heading[data-v-37984f8c]:hover{color:#6e87d2}aside .username-heading img[data-v-37984f8c]{width:3rem;height:3rem;border-radius:50%;margin-right:1rem}aside .username-heading .text[data-v-37984f8c]{display:flex;flex-direction:column;justify-content:center}aside .username-heading .text a[data-v-37984f8c]{line-height:1}aside .username-heading .text a[data-v-37984f8c]:first-child{font-size:1.25rem;font-weight:500;letter-spacing:-.025rem;margin-bottom:.25rem}aside .username-heading .text a[data-v-37984f8c]:last-child{color:#999;font-size:.875rem}aside .username-heading.loading[data-v-37984f8c]{display:block}aside .f-button[data-v-37984f8c]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}aside .f-button[data-v-37984f8c]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}aside .f-button[data-v-37984f8c]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}aside .info>div[data-v-37984f8c]{margin-bottom:.5rem}aside .info .title[data-v-37984f8c]{font-size:.666666rem;letter-spacing:-.0125rem;font-weight:500;color:#999;text-transform:uppercase;margin-bottom:.1rem}aside .info .content[data-v-37984f8c]{font-size:.875rem;line-height:1.4}.add-comment[data-v-8c4375bc]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}.add-comment[data-v-8c4375bc]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}.add-comment[data-v-8c4375bc]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}footer[data-v-22cb8fd0]{padding:2rem;text-align:center;display:flex;align-items:center;justify-content:center}footer span[data-v-22cb8fd0]{display:inline-block;line-height:1;text-transform:uppercase;letter-spacing:-.025rem;font-size:.75rem;font-weight:500}footer a svg[data-v-22cb8fd0]{width:3rem;height:3rem;margin:0 .5rem}footer a .nuxt-icon[data-v-22cb8fd0]{width:2.5rem;height:2.5rem;margin:0 .25rem}</style>
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><div id="__layout"><div><header data-v-27046cca><a href="/nuxtstop/" class="logo-wrapper nuxt-link-active" data-v-27046cca><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-27046cca><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-27046cca></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-27046cca></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-27046cca></path></svg> <div class="name-wrapper" data-v-27046cca><span class="app-name" data-v-27046cca>Nuxtstop</span> <p class="subtitle" data-v-27046cca>For all things nuxt.js</p></div></a> <nav data-v-27046cca><ul data-v-27046cca><li data-v-27046cca><a href="/nuxtstop/" class="nuxt-link-active" data-v-27046cca>
          New
        </a></li><li data-v-27046cca><a href="/nuxtstop/top" data-v-27046cca>
          Top
        </a></li></ul></nav></header> <div class="page-wrapper" data-v-10d06ee8><div class="article-content-wrapper" data-v-10d06ee8><article data-fetch-key="data-v-70afb46a:0" class="article-block" data-v-70afb46a data-v-10d06ee8><header data-v-70afb46a><h1 data-v-70afb46a>Why custom react hooks could destroy your app performance</h1> <div class="tags" data-v-70afb46a><a href="/nuxtstop/t/react" class="tag" data-v-70afb46a>
          #react
        </a><a href="/nuxtstop/t/performance" class="tag" data-v-70afb46a>
          #performance
        </a><a href="/nuxtstop/t/webdev" class="tag" data-v-70afb46a>
          #webdev
        </a><a href="/nuxtstop/t/javascript" class="tag" data-v-70afb46a>
          #javascript
        </a></div> <!----> <div class="meta" data-v-70afb46a><div class="scl" data-v-70afb46a><span data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M16.4444 3C14.6733 3 13.0333 3.94162 12 5.34C10.9667 3.94162 9.32667 3 7.55556 3C4.49222 3 2 5.52338 2 8.625C2 14.8024 11.0267 20.586 11.4122 20.829C11.5922 20.9426 11.7956 21 12 21C12.2044 21 12.4078 20.9426 12.5878 20.829C12.9733 20.586 22 14.8024 22 8.625C22 5.52338 19.5078 3 16.4444 3Z" fill="#FF0000" data-v-70afb46a data-v-70afb46a></path></svg>
            85
          </span> <span class="comments" data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M6.11765 22H4.94118L5.64706 21.05C6.11765 20.3969 6.41176 19.5656 6.58824 18.5563C3.64706 17.1906 2 14.6375 2 11.3125C2 6.20625 5.82353 3 12 3C18.1765 3 22 6.20625 22 11.3125C22 16.5375 18.2353 19.625 12 19.625H11.5882C10.6471 20.7531 9 22 6.11765 22ZM12 4.1875C6.47059 4.1875 3.17647 6.85937 3.17647 11.3125C3.17647 15.1125 5.47059 16.8938 7.41177 17.6656L7.82353 17.8437L7.76471 18.3187C7.64706 19.2687 7.47059 20.1 7.11765 20.8125C9.05882 20.575 10.1765 19.5656 10.8235 18.7344L11 18.4969H12C19.9412 18.4969 20.8235 13.5094 20.8235 11.3719C20.8235 6.85938 17.5294 4.1875 12 4.1875Z" fill="black" data-v-70afb46a data-v-70afb46a></path></svg>
            14
          </span></div> <time data-v-70afb46a>Jan 24</time></div></header> <div class="content" data-v-70afb46a><p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--UVgD9GuN--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/y9d2ys6t8v55ah82fz3b.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--UVgD9GuN--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/y9d2ys6t8v55ah82fz3b.png" alt="Image description" loading="lazy" width="880" height="563"></a></p>

<p>Scary title, isn’t it? The sad part is that it’s true: for performance-sensitive apps custom React hooks can very easily turn into the biggest performance killer, if not written and used very carefully.</p>

<p>I’m not going to explain how to build and use hooks here, if you never built a hook before, the React docs have a <a href="https://reactjs.org/docs/hooks-custom.html">pretty good introduction</a> into it. What I want to focus on today is their performance implication for complicated apps.</p>

<h2>
  <a name="lets-build-a-modal-dialog-on-custom-hooks" href="#lets-build-a-modal-dialog-on-custom-hooks">
  </a>
  Let’s build a modal dialog on custom hooks
</h2>

<p>Essentially, hooks are just advanced functions that allow developers to use things like state and context without creating new components. They are super useful when you need to share the same piece of logic that needs state between different parts of the app. With hooks came a new era in React development: never before our components were as slim and neat as with hooks, and separation of different concerns was as easy to achieve as with hooks.</p>

<p>Let’s for example, implement a modal dialog. With custom hooks, we can create a piece of beauty here.</p>

<p>First, let’s implement a “base” component, that doesn’t have any state, but just renders the dialog when <code>isOpen</code> prop is provided and triggers <code>onClose</code> callback when a click on a blanket underneath the dialog happens.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="kd">type</span> <span class="nx">ModalProps</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">isOpen</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">;</span>
  <span class="nl">onClosed</span><span class="p">:</span> <span class="p">()</span> <span class="o">=></span> <span class="k">void</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">ModalBase</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">isOpen</span><span class="p">,</span> <span class="nx">onClosed</span> <span class="p">}:</span> <span class="nx">ModalProps</span><span class="p">)</span> <span class="o">=></span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">isOpen</span> <span class="p">?</span> <span class="p">(</span>
    <span class="p">&lt;></span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">css</span><span class="p">=</span><span class="si">{</span><span class="nx">modalBlanketCss</span><span class="si">}</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="nx">onClosed</span><span class="si">}</span> <span class="p">/></span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">css</span><span class="p">=</span><span class="si">{</span><span class="nx">modalBodyCss</span><span class="si">}</span><span class="p">></span>Modal dialog content<span class="p">&lt;/</span><span class="nt">div</span><span class="p">></span>
    <span class="p">&lt;/></span>
  <span class="p">)</span> <span class="p">:</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Now to the state management, i.e. the “open dialog/close dialog” logic. In the “old” way we would usually implement a “smart” version of it, which handles the state management and accepts a component that is supposed to trigger the opening of the dialog as a prop. Something like this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">ModalDialog</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">trigger</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">isOpen</span><span class="p">,</span> <span class="nx">setIsOpen</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;></span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=></span> <span class="nx">setIsOpen</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="si">}</span><span class="p">></span><span class="si">{</span><span class="nx">trigger</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">></span>
      <span class="p">&lt;</span><span class="nc">ModalBase</span> <span class="na">isOpen</span><span class="p">=</span><span class="si">{</span><span class="nx">isOpen</span><span class="si">}</span> <span class="na">onClosed</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=></span> <span class="nx">setIsOpen</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="si">}</span> <span class="p">/></span>
    <span class="p">&lt;/></span>
  <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Which then will be used like this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="p">&lt;</span><span class="nc">ModalDialog</span> <span class="na">trigger</span><span class="p">=</span><span class="si">{</span><span class="p">&lt;</span><span class="nt">button</span><span class="p">></span>Click me<span class="p">&lt;/</span><span class="nt">button</span><span class="p">></span><span class="si">}</span> <span class="p">/></span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>This is not a particularly pretty solution, we’re messing with the position and accessibility of the trigger component inside our modal dialog by wrapping it in a div. Not to mention that this unnecessary div will result in a slightly larger and messier DOM.</p>

<p>And now watch the magic. If we extract the “open/close” logic into a custom hook, render this component <strong>inside</strong> the hook, and expose API to control it as a return value from the hook, we can have the best of both worlds. In the hook we’ll have the “smart” dialog that handles its own state, but doesn’t mess with the trigger nor does it need one:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">useModal</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=></span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">isOpen</span><span class="p">,</span> <span class="nx">setIsOpen</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">open</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=></span> <span class="nx">setIsOpen</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">close</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=></span> <span class="nx">setIsOpen</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">Dialog</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=></span> <span class="p">&lt;</span><span class="nc">ModalBase</span> <span class="na">onClosed</span><span class="p">=</span><span class="si">{</span><span class="nx">close</span><span class="si">}</span> <span class="na">isOpen</span><span class="p">=</span><span class="si">{</span><span class="nx">isOpen</span><span class="si">}</span> <span class="p">/>;</span>

  <span class="k">return</span> <span class="p">{</span> <span class="nx">isOpen</span><span class="p">,</span> <span class="nx">Dialog</span><span class="p">,</span> <span class="nx">open</span><span class="p">,</span> <span class="nx">close</span> <span class="p">};</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>And on the consumer side we’ll have a minimal amount of code while having the full control over what triggers the dialog:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">ConsumerComponent</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=></span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">Dialog</span><span class="p">,</span> <span class="nx">open</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useModal</span><span class="p">();</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;></span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="nx">open</span><span class="si">}</span><span class="p">></span>Click me<span class="p">&lt;/</span><span class="nt">button</span><span class="p">></span>
      <span class="p">&lt;</span><span class="nc">Dialog</span> <span class="p">/></span>
    <span class="p">&lt;/></span>
  <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>If this isn’t perfection, I don’t know what is! 😍 <a href="https://codesandbox.io/s/modal-dialog-example1-9ds2c?file=/src/App.tsx">See this beauty in codesandbox</a>. Only don’t rush to use it in your apps right away, not until you read about its dark side 😅</p>

<h2>
  <a name="performance-implications" href="#performance-implications">
  </a>
  Performance implications
</h2>

<p>In the <a href="https://developerway.com/posts/how-to-write-performant-react-code">previous article</a>, where I covered in detail various patterns that lead to poor performance, I implemented a “slow” app: just a simple not optimized list of ~250 countries rendered on the page. But every interaction there causes the entire page to re-render, which makes it probably the slowest simple list ever existed. <a href="https://codesandbox.io/s/re-renders-final-bad-4znwe">Here is the codesandbox</a>, click on different countries in the list to see what I mean (if you’re on the latest Mac throttle your CPU a bit to get a better impression).</p>

<blockquote>
<p><b>How to throttle CPU</b>: in Chrome developer tools open “Performance” tab, and click on the “cog wheel” icon in the top right corner -<br>
  it will open a small additional panel with throttling options.</p>
</blockquote>

<p>I’m going to use our new perfect modal dialog there and see what happens. The code of the main <code>Page</code> component is relatively simple and looks like this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">selectedCountry</span><span class="p">,</span> <span class="nx">setSelectedCountry</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="nx">Country</span><span class="o">></span><span class="p">(</span><span class="nx">countries</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">savedCountry</span><span class="p">,</span> <span class="nx">setSavedCountry</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="nx">Country</span><span class="o">></span><span class="p">(</span><span class="nx">countries</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">setMode</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="nx">Mode</span><span class="o">></span><span class="p">(</span><span class="dl">'</span><span class="s1">light</span><span class="dl">'</span><span class="p">);</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nc">ThemeProvider</span> <span class="na">value</span><span class="p">=</span><span class="si">{</span><span class="p">{</span> <span class="nx">mode</span> <span class="p">}</span><span class="si">}</span><span class="p">></span>
      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">></span>Country settings<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">></span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=></span> <span class="nx">setMode</span><span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">light</span><span class="dl">'</span> <span class="p">?</span> <span class="dl">'</span><span class="s1">dark</span><span class="dl">'</span> <span class="p">:</span> <span class="dl">'</span><span class="s1">light</span><span class="dl">'</span><span class="p">)</span><span class="si">}</span><span class="p">></span>Toggle theme<span class="p">&lt;/</span><span class="nt">button</span><span class="p">></span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="p">=</span><span class="s">"content"</span><span class="p">></span>
        <span class="p">&lt;</span><span class="nc">CountriesList</span> <span class="na">countries</span><span class="p">=</span><span class="si">{</span><span class="nx">countries</span><span class="si">}</span> <span class="na">onCountryChanged</span><span class="p">=</span><span class="si">{</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="o">=></span> <span class="nx">setSelectedCountry</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span><span class="si">}</span> <span class="na">savedCountry</span><span class="p">=</span><span class="si">{</span><span class="nx">savedCountry</span><span class="si">}</span> <span class="p">/></span>
        <span class="p">&lt;</span><span class="nc">SelectedCountry</span> <span class="na">country</span><span class="p">=</span><span class="si">{</span><span class="nx">selectedCountry</span><span class="si">}</span> <span class="na">onCountrySaved</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=></span> <span class="nx">setSavedCountry</span><span class="p">(</span><span class="nx">selectedCountry</span><span class="p">)</span><span class="si">}</span> <span class="p">/></span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">></span>
    <span class="p">&lt;/</span><span class="nc">ThemeProvider</span><span class="p">></span>
  <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>And now I need a button near the “Toggle theme” button that would open a modal dialog with some future additional settings for this page. Luckily, now it can’t be simpler: add <code>useModal</code> hook at the top, add the button where it needs to be, and pass <code>open</code> callback to the button. The <code>Page</code> component barely changes and is still quite simple:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s---wcsG7EU--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/6kkynx9hikon0mnn8g3i.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s---wcsG7EU--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/6kkynx9hikon0mnn8g3i.png" alt="Image description" loading="lazy" width="880" height="616"></a></p>

<p>You probably already guessed the result 🙂 The slowest appearance of 2 empty divs ever existed 😱. <a href="https://codesandbox.io/s/re-renders-bad-with-dialog-6egnq?file=/src/country-settings/page.tsx">See the codesandbox.</a></p>

<p>You see, what is happening here, is our <code>useModal</code> hook uses state. And as we know, state changes are one of the reasons why a component would re-render itself. This also applies to hooks - if the hook's state changes, the "host" component will re-render. And it makes total sense. If we look closely inside <code>useModal</code> hook, we’ll see that it’s just a nice abstraction around <code>setState</code>, it exists <strong>outside</strong> of the <code>Dialog</code> component. Essentially it’s no different than calling <code>setState</code> in the <code>Page</code> component directly.</p>

<p>And this is where the big danger of hooks is: yes, they help us make the API really nice. But what we did as a result, and the way of hooks is pretty much encouraging it, is essentially <strong>lifted state up</strong> from where it was supposed to be. And it’s entirely not noticeable unless you go inside the <code>useModal</code> implementation or have lots of experience with hooks and re-renders. I’m not even using the state directly in <code>Page</code> component, all I'm doing from its perspective is rendering a <code>Dialog</code> component and calling an imperative API to open it.</p>

<p>In the “old world”, the state would’ve been encapsulated in the slightly ugly <code>Modal</code> dialog with the <code>trigger</code> prop, and the <code>Page</code> component would’ve stayed intact when the button is clicked. Now the click on the button changes the state of <strong>the entire Page component</strong>, which causes it to re-render (which is super slow for this app). And the dialog can only appear when React is done with all the re-renders it caused, hence the big delay.</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--AYTSLLex--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ycwdve22u34dgq81cz6a.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--AYTSLLex--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ycwdve22u34dgq81cz6a.png" alt="Image description" loading="lazy" width="880" height="660"></a></p>

<p>So, what can we do about it? We probably won’t have time and resources to fix the underlying performance of the <code>Page</code> component, as it would usually happen with the “real” apps. But at least we can make sure that the new feature doesn’t add to the performance problems and is fast by itself. All that we need to do here is just move the modal state “down”, away from the slow <code>Page</code> component:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">SettingsButton</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=></span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">Dialog</span><span class="p">,</span> <span class="nx">open</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useModal</span><span class="p">();</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;></span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="nx">open</span><span class="si">}</span><span class="p">></span>Open settings<span class="p">&lt;/</span><span class="nt">button</span><span class="p">></span>
      <span class="p">&lt;</span><span class="nc">Dialog</span> <span class="p">/></span>
    <span class="p">&lt;/></span>
  <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>And in <code>Page</code> just render the <code>SettingsButton</code>:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
  <span class="c1">// same as original page state</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nc">ThemeProvider</span> <span class="na">value</span><span class="p">=</span><span class="si">{</span><span class="p">{</span> <span class="nx">mode</span> <span class="p">}</span><span class="si">}</span><span class="p">></span>
      // stays the same
      <span class="p">&lt;</span><span class="nc">SettingsButton</span> <span class="p">/></span>
      // stays the same
    <span class="p">&lt;/</span><span class="nc">ThemeProvider</span><span class="p">></span>
  <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Now, when the button is clicked, only <code>SettingsButton</code> component will re-render, the slow <code>Page</code> component is unaffected. Essentially, we’re imitating the state model as it would’ve been in the “old” world while preserving the nice hooks-based API. See the <a href="https://codesandbox.io/s/re-renders-bad-with-dialog-fixed-rrfey?file=/src/country-settings/page.tsx">codesandbox</a> with the solution.</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--DylaYHgx--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/rdodquvil85v7hble1xt.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--DylaYHgx--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/rdodquvil85v7hble1xt.png" alt="Image description" loading="lazy" width="880" height="660"></a></p>

<h2>
  <a name="adding-more-functionality-to-the-raw-usemodal-endraw-hook" href="#adding-more-functionality-to-the-raw-usemodal-endraw-hook">
  </a>
  Adding more functionality to the <code>useModal</code> hook
</h2>

<p>Let’s make our hooks performance conversation slightly darker 🙂. Imagine, for example, you need to track the scroll event in the modal content. Maybe you want to send some analytics events when the users scroll through the text, to track reads. What will happen if I don’t want to introduce “smart” functionality to the <code>BaseModal</code> and do it in the <code>useModal</code> hook?</p>

<p>Relatively easy to achieve. We can just introduce a new state there to track scroll position, add event listeners in <code>useEffect</code> hook and pass ref to the <code>BaseModal</code> to get the content element to attach the listeners to. Something like this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">ModalBase</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">forwardRef</span><span class="p">(({</span> <span class="nx">isOpen</span><span class="p">,</span> <span class="nx">onClosed</span> <span class="p">}:</span> <span class="nx">ModalProps</span><span class="p">,</span> <span class="nx">ref</span><span class="p">:</span> <span class="nx">RefObject</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">></span><span class="p">)</span> <span class="o">=></span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">isOpen</span> <span class="p">?</span> <span class="p">(</span>
    <span class="p">&lt;></span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">css</span><span class="p">=</span><span class="si">{</span><span class="nx">modalBlanketCss</span><span class="si">}</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="nx">onClosed</span><span class="si">}</span> <span class="p">/></span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">css</span><span class="p">=</span><span class="si">{</span><span class="nx">modalBodyCss</span><span class="si">}</span> <span class="na">ref</span><span class="p">=</span><span class="si">{</span><span class="nx">ref</span><span class="si">}</span><span class="p">></span>
        // add a lot of content here
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">></span>
    <span class="p">&lt;/></span>
  <span class="p">)</span> <span class="p">:</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">});</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">useModal</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=></span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">isOpen</span><span class="p">,</span> <span class="nx">setIsOpen</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">ref</span> <span class="o">=</span> <span class="nx">useRef</span><span class="o">&lt;</span><span class="nx">HTMLElement</span><span class="o">></span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">scroll</span><span class="p">,</span> <span class="nx">setScroll</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

  <span class="c1">// same as before</span>

  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=></span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">current</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">element</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="kd">const</span> <span class="nx">handleScroll</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=></span> <span class="p">{</span>
      <span class="nx">setScroll</span><span class="p">(</span><span class="nx">element</span><span class="p">?.</span><span class="nx">scrollTop</span> <span class="o">||</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="nx">element</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">scroll</span><span class="dl">'</span><span class="p">,</span> <span class="nx">handleScroll</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">()</span> <span class="o">=></span> <span class="p">{</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">scroll</span><span class="dl">'</span><span class="p">,</span> <span class="nx">handleScroll</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">});</span>

  <span class="kd">const</span> <span class="nx">Dialog</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=></span> <span class="p">&lt;</span><span class="nc">ModalBase</span> <span class="na">onClosed</span><span class="p">=</span><span class="si">{</span><span class="nx">close</span><span class="si">}</span> <span class="na">isOpen</span><span class="p">=</span><span class="si">{</span><span class="nx">isOpen</span><span class="si">}</span> <span class="na">ref</span><span class="p">=</span><span class="si">{</span><span class="nx">ref</span><span class="si">}</span> <span class="p">/>;</span>

  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">isOpen</span><span class="p">,</span>
    <span class="nx">Dialog</span><span class="p">,</span>
    <span class="nx">open</span><span class="p">,</span>
    <span class="nx">close</span><span class="p">,</span>
  <span class="p">};</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>And now we can do whatever with this state. Now let’s pretend that the previous performance problems are not that big of a deal, and use again this hook directly in the slow Page component. <a href="https://codesandbox.io/s/re-renders-bad-with-dialog-with-scroll-p9wi8?file=/src/country-settings/page.tsx">See codesandbox</a>.</p>

<p>The scrolling doesn’t even work properly! 😱 Every time I try to scroll the dialog content it resets to the top!</p>

<p>Okay, let’s think logically. <a href="https://www.developerway.com/posts/how-to-write-performant-react-code">We know already</a>, that creating components inside render functions is evil, since React will re-create and re-mount them on every re-render. And we know that hooks change with every state change. That means now, when we introduced scroll state, on every scroll change we’re changing state, which causes the hook to re-render, which causes <code>Dialog</code> component to re-create itself. Exactly the same problem, as with creating components inside render functions, with exactly the same fix: we need to extract this component outside of the hook or just memoise it.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">Dialog</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=></span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">()</span> <span class="o">=></span> <span class="p">&lt;</span><span class="nc">ModalBase</span> <span class="na">onClosed</span><span class="p">=</span><span class="si">{</span><span class="nx">close</span><span class="si">}</span> <span class="na">isOpen</span><span class="p">=</span><span class="si">{</span><span class="nx">isOpen</span><span class="si">}</span> <span class="na">ref</span><span class="p">=</span><span class="si">{</span><span class="nx">ref</span><span class="si">}</span> <span class="p">/>;</span>
<span class="p">},</span> <span class="p">[</span><span class="nx">isOpen</span><span class="p">]);</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>The focus behaviour is fixed, but there is another problem here: the slow <code>Page</code> component re-renders on every scroll! That one is a bit hard to notice since the dialog content is just text. Try, for example, to reduce the CPU by 6x, scroll, and then just highlight the text in the dialog right away. The browser won’t even allow that, since it’s too busy with re-renders of the underneath <code>Page</code> component! <a href="https://codesandbox.io/s/re-renders-bad-with-dialog-with-scroll-fixed-scroll-0s5g3?file=/src/country-settings/page.tsx">See the codesandbox.</a> And after a few scrolls, your laptop will probably try to take off to the Moon due to 100% CPU load 😅</p>

<p>Yeah, we definitely need to fix that before releasing it to production. Let’s take another look at our component, especially at this part:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="k">return</span> <span class="p">{</span>
  <span class="nx">isOpen</span><span class="p">,</span>
  <span class="nx">Dialog</span><span class="p">,</span>
  <span class="nx">open</span><span class="p">,</span>
  <span class="nx">close</span><span class="p">,</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>We’re returning a new object on every re-render, and since we re-render our hook on every scroll now, that means that object changes on every scroll as well. But we’re not using the scroll state here, it’s entirely internal for the <code>useModal</code> hook. Surely just memoising that object will solve the problem?<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="k">return</span> <span class="nx">useMemo</span><span class="p">(</span>
  <span class="p">()</span> <span class="o">=></span> <span class="p">({</span>
    <span class="nx">isOpen</span><span class="p">,</span>
    <span class="nx">Dialog</span><span class="p">,</span>
    <span class="nx">open</span><span class="p">,</span>
    <span class="nx">close</span><span class="p">,</span>
  <span class="p">}),</span>
  <span class="p">[</span><span class="nx">isOpen</span><span class="p">,</span> <span class="nx">Dialog</span><span class="p">],</span>
<span class="p">);</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>You know the best (or the scariest) part of this? IT DIDN’T! 😱 <a href="https://codesandbox.io/s/re-renders-bad-with-dialog-with-scroll-fixed-scroll-and-memo-35lqx?file=/src/country-settings/modal-dialog.tsx">See the codesandbox</a>.</p>

<p>And this is another huge performance-related bummer with hooks. Turns out, it doesn’t really matter, whether the state change in hooks is “internal” or not. <strong>Every state change in a hook, whether it affects its return value or not, will cause the “host” component to re-render.</strong></p>

<p>And of course exactly the same story with chaining hooks: if a hook’s state changes, it will cause its “host” hook change as well, which will propagate up through the whole chain of hooks until it reaches the “host” component and re-renders it (which will cause another chain reaction of re-renders, only downstream now), <strong>regardless of any memoisation</strong> applied in between.</p>

<p>Extracting the “scrolling” functionality into a hook will make absolutely no difference, the slow Page component will re-render 😔.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">useScroll</span> <span class="o">=</span> <span class="p">(</span><span class="nx">ref</span><span class="p">:</span> <span class="nx">RefObject</span><span class="p">)</span> <span class="o">=></span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">scroll</span><span class="p">,</span> <span class="nx">setScroll</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=></span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">current</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">element</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="kd">const</span> <span class="nx">handleScroll</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=></span> <span class="p">{</span>
      <span class="nx">setScroll</span><span class="p">(</span><span class="nx">element</span><span class="p">?.</span><span class="nx">scrollTop</span> <span class="o">||</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="nx">element</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">scroll</span><span class="dl">'</span><span class="p">,</span> <span class="nx">handleScroll</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">()</span> <span class="o">=></span> <span class="p">{</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">scroll</span><span class="dl">'</span><span class="p">,</span> <span class="nx">handleScroll</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">scroll</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">useModal</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=></span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">isOpen</span><span class="p">,</span> <span class="nx">setIsOpen</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">ref</span> <span class="o">=</span> <span class="nx">useRef</span><span class="o">&lt;</span><span class="nx">HTMLElement</span><span class="o">></span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">scroll</span> <span class="o">=</span> <span class="nx">useScroll</span><span class="p">(</span><span class="nx">ref</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">open</span> <span class="o">=</span> <span class="nx">useCallback</span><span class="p">(()</span> <span class="o">=></span> <span class="p">{</span>
    <span class="nx">setIsOpen</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
  <span class="p">},</span> <span class="p">[]);</span>

  <span class="kd">const</span> <span class="nx">close</span> <span class="o">=</span> <span class="nx">useCallback</span><span class="p">(()</span> <span class="o">=></span> <span class="p">{</span>
    <span class="nx">setIsOpen</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
  <span class="p">},</span> <span class="p">[]);</span>

  <span class="kd">const</span> <span class="nx">Dialog</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=></span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">()</span> <span class="o">=></span> <span class="p">&lt;</span><span class="nc">ModalBase</span> <span class="na">onClosed</span><span class="p">=</span><span class="si">{</span><span class="nx">close</span><span class="si">}</span> <span class="na">isOpen</span><span class="p">=</span><span class="si">{</span><span class="nx">isOpen</span><span class="si">}</span> <span class="na">ref</span><span class="p">=</span><span class="si">{</span><span class="nx">ref</span><span class="si">}</span> <span class="p">/>;</span>
  <span class="p">},</span> <span class="p">[</span><span class="nx">isOpen</span><span class="p">,</span> <span class="nx">close</span><span class="p">]);</span>

  <span class="k">return</span> <span class="nx">useMemo</span><span class="p">(</span>
    <span class="p">()</span> <span class="o">=></span> <span class="p">({</span>
      <span class="nx">isOpen</span><span class="p">,</span>
      <span class="nx">Dialog</span><span class="p">,</span>
      <span class="nx">open</span><span class="p">,</span>
      <span class="nx">close</span><span class="p">,</span>
    <span class="p">}),</span>
    <span class="p">[</span><span class="nx">isOpen</span><span class="p">,</span> <span class="nx">Dialog</span><span class="p">,</span> <span class="nx">open</span><span class="p">,</span> <span class="nx">close</span><span class="p">],</span>
  <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p><a href="https://codesandbox.io/s/re-renders-bad-with-dialog-with-scroll-extracted-woeer?file=/src/country-settings/modal-dialog.tsx">See the codesandbox.</a></p>

<p>How to fix it? Well, the only thing to do here is to move the scroll tracking hook outside of the <code>useModal</code> hook and use it somewhere where it won’t cause the chain of re-renders. Can introduce <code>ModalBaseWithAnalytics</code> component for example:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">ModalBaseWithAnalytics</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">:</span> <span class="nx">ModalProps</span><span class="p">)</span> <span class="o">=></span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">ref</span> <span class="o">=</span> <span class="nx">useRef</span><span class="o">&lt;</span><span class="nx">HTMLElement</span><span class="o">></span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">scroll</span> <span class="o">=</span> <span class="nx">useScroll</span><span class="p">(</span><span class="nx">ref</span><span class="p">);</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">scroll</span><span class="p">);</span>

  <span class="k">return</span> <span class="p">&lt;</span><span class="nc">ModalBase</span> <span class="si">{</span><span class="p">...</span><span class="nx">props</span><span class="si">}</span> <span class="na">ref</span><span class="p">=</span><span class="si">{</span><span class="nx">ref</span><span class="si">}</span> <span class="p">/>;</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>And then use it in the <code>useModal</code> hook instead of the <code>ModalBase</code>:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">useModal</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=></span> <span class="p">{</span>
  <span class="c1">// the rest is the same as in the original useModal hook</span>

  <span class="kd">const</span> <span class="nx">Dialog</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=></span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">()</span> <span class="o">=></span> <span class="p">&lt;</span><span class="nc">ModalBaseWithAnalytics</span> <span class="na">onClosed</span><span class="p">=</span><span class="si">{</span><span class="nx">close</span><span class="si">}</span> <span class="na">isOpen</span><span class="p">=</span><span class="si">{</span><span class="nx">isOpen</span><span class="si">}</span> <span class="na">ref</span><span class="p">=</span><span class="si">{</span><span class="nx">ref</span><span class="si">}</span> <span class="p">/>;</span>
  <span class="p">},</span> <span class="p">[</span><span class="nx">isOpen</span><span class="p">,</span> <span class="nx">close</span><span class="p">]);</span>

  <span class="k">return</span> <span class="nx">useMemo</span><span class="p">(</span>
    <span class="p">()</span> <span class="o">=></span> <span class="p">({</span>
      <span class="nx">isOpen</span><span class="p">,</span>
      <span class="nx">Dialog</span><span class="p">,</span>
      <span class="nx">open</span><span class="p">,</span>
      <span class="nx">close</span><span class="p">,</span>
    <span class="p">}),</span>
    <span class="p">[</span><span class="nx">isOpen</span><span class="p">,</span> <span class="nx">Dialog</span><span class="p">,</span> <span class="nx">open</span><span class="p">,</span> <span class="nx">close</span><span class="p">],</span>
  <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Now the state changes due to the scrolling will be scoped to the <code>ModalBaseWithAnalytics</code> component and won’t affect the slow <code>Page</code> component. <a href="https://codesandbox.io/s/re-renders-bad-with-dialog-scroll-fixed-for-good-v6ohp?file=/src/country-settings/modal-dialog.tsx">See the codesandbox.</a></p>

<p>That is all for today! Hope this article scared you enough helped you to feel more comfortable with custom hooks and how to write and use them without compromising the performance of your apps. Let’s recap the rules of performant hooks before leaving:</p>

<ul>
<li>every state change in a hook will cause its “host” component to re-render, regardless of whether this state is returned in the hook value and memoised or not</li>
<li>the same with chained hooks, every state change in a hook will cause all “parent” hooks to change until it reaches the “host” component, which again will trigger the re-render</li>
</ul>

<p>And the things to watch out for, when writing or using custom hooks:</p>

<ul>
<li>when using a custom hook, make sure that the state that this hook encapsulates is not used on the level it wouldn’t have been used with the components approach. Move it “down” to a smaller component if necessary</li>
<li>never implement “independent” state in a hook or use hooks with the independent state</li>
<li>when using a custom hook, make sure it doesn’t perform some independent state operations, that are not exposed in its return value</li>
<li>when using a custom hook, make sure that all hooks that it uses also follow the rules from the above</li>
</ul>

<p>Stay safe and may your apps be blazing fast from now on! ✌🏼</p>

<p>...</p>

<p>Originally published at <a href="https://www.developerway.com">https://www.developerway.com</a>. The website has more articles like this 😉</p>

<p><a href="https://www.developerway.com">Subscribe to the newsletter</a>, <a href="https://www.linkedin.com/in/adevnadia/">connect on LinkedIn</a> or <a href="https://twitter.com/adevnadia">follow on Twitter</a> to get notified as soon as the next article comes out.</p>

</div></article> <div class="aside-username-wrapper" data-v-10d06ee8><aside class="aside-username-block" data-v-37984f8c data-v-10d06ee8><div class="username-heading loading" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-heading" data-v-37984f8c><div class="vue-content-placeholders-heading__img"></div> <div class="vue-content-placeholders-heading__content"><div class="vue-content-placeholders-heading__title"></div> <div class="vue-content-placeholders-heading__subtitle"></div></div></div></div></div> <div class="info" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-text" data-v-37984f8c><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div></div></div></div></aside></div></div> <div class="comments-block" data-v-8c4375bc data-v-10d06ee8><!----> <a href="https://dev.to/adevnadia/why-custom-react-hooks-could-destroy-your-app-performance-nid" target="_blank" rel="nofollow noopener noreferer" class="add-comment" data-v-8c4375bc>
    Add comment
  </a></div></div> <footer data-v-22cb8fd0><span data-v-22cb8fd0>Built with</span> <a href="https://nuxtjs.org" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="nuxt-icon" data-v-22cb8fd0 data-v-22cb8fd0><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a> <span data-v-22cb8fd0>&</span> <a href="https://docs.dev.to/api" rel="nofollow noopener" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-22cb8fd0 data-v-22cb8fd0><path d="M1.5726 5.13748C1.42945 5.20622 1.2411 5.36661 1.15822 5.48117C1 5.69503 1 5.74849 1 11.8739C1 17.9993 1 18.0528 1.15822 18.2667C1.2411 18.3812 1.42945 18.5416 1.5726 18.6104C1.8137 18.7402 2.46164 18.7478 12 18.7478C21.5384 18.7478 22.1863 18.7402 22.4274 18.6104C22.5706 18.5416 22.7589 18.3812 22.8418 18.2667C23 18.0528 23 17.9993 23 11.8739C23 5.74849 23 5.69503 22.8418 5.48117C22.7589 5.36661 22.5706 5.20622 22.4274 5.13748C22.1863 5.00764 21.5384 5 12 5C2.46164 5 1.8137 5.00764 1.5726 5.13748ZM7.7055 8.2613C8.0822 8.45989 8.59454 9.0098 8.77536 9.40694C8.89589 9.66664 8.91095 9.94922 8.91095 12.0649C8.91095 14.3104 8.90344 14.4478 8.75275 14.7839C8.51919 15.288 8.16506 15.6546 7.68288 15.899C7.26096 16.1052 7.22328 16.1128 5.7315 16.1358L4.20206 16.1663V12.1031V8.04744L5.80684 8.07035C7.27602 8.09327 7.42672 8.10854 7.7055 8.2613ZM13.6952 8.89521V9.73538H12.4521H11.2089V10.4991V11.2629H11.9623H12.7158V12.1031V12.9432H11.9623H11.2089V13.707V14.4708H12.4521H13.6952V15.3109V16.151H12C10.1315 16.151 10.0411 16.1358 9.67191 15.6928L9.47603 15.4484V12.1336C9.47603 8.46752 9.46851 8.49807 9.95069 8.20783C10.1692 8.07035 10.3425 8.05508 11.9473 8.05508H13.6952V8.89521ZM16.5658 10.3769C16.8897 11.6295 17.1685 12.6912 17.176 12.7293C17.1911 12.7675 17.4699 11.7441 17.8014 10.461C18.1254 9.17017 18.4343 8.1009 18.4795 8.08563C18.5247 8.06271 18.9541 8.06271 19.4288 8.07035L20.3028 8.09327L19.376 11.6219C18.8713 13.5542 18.4117 15.2269 18.3664 15.3261C18.0123 16.0135 17.274 16.3343 16.7164 16.0441C16.4528 15.899 16.0911 15.4865 15.9705 15.1887C15.9254 15.0665 15.4884 13.4549 15.0062 11.6142C14.524 9.76593 14.1171 8.20783 14.0945 8.15437C14.0644 8.07035 14.2301 8.05508 15.0212 8.07035L15.9856 8.09327L16.5658 10.3769Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M5.93491 12.103V14.4707H6.27394C6.66574 14.4707 7.01983 14.3103 7.1404 14.0965C7.18559 14.0048 7.21575 13.2105 7.21575 12.0648V10.1783L6.99725 9.95683C6.80133 9.76591 6.71847 9.73535 6.35683 9.73535H5.93491V12.103Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a></footer></div></div></div><script>window.__NUXT__=function(s,n,a,e){return e.type_of="article",e.id=965581,e.title="Why custom react hooks could destroy your app performance",e.description="Scary title, isn’t it? The sad part is that it’s true: for performance-sensitive apps custom React...",e.readable_publish_date="Jan 24",e.slug="why-custom-react-hooks-could-destroy-your-app-performance-nid",e.path="/adevnadia/why-custom-react-hooks-could-destroy-your-app-performance-nid",e.url="https://dev.to/adevnadia/why-custom-react-hooks-could-destroy-your-app-performance-nid",e.comments_count=14,e.public_reactions_count=85,e.collection_id=s,e.published_timestamp=n,e.positive_reactions_count=85,e.cover_image=s,e.social_image="https://dev.to/social_previews/article/965581.png",e.canonical_url="https://www.developerway.com/posts/why-custom-react-hooks-could-destroy-your-app-performance",e.created_at=n,e.edited_at="2022-02-18T14:45:21Z",e.crossposted_at=s,e.published_at=n,e.last_comment_at="2022-03-28T12:08:25Z",e.reading_time_minutes=11,e.tag_list="react, performance, webdev, javascript",e.tags=["react","performance","webdev","javascript"],e.body_html='<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--UVgD9GuN--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/y9d2ys6t8v55ah82fz3b.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--UVgD9GuN--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/y9d2ys6t8v55ah82fz3b.png" alt="Image description" loading="lazy" width="880" height="563"></a></p>\n\n<p>Scary title, isn’t it? The sad part is that it’s true: for performance-sensitive apps custom React hooks can very easily turn into the biggest performance killer, if not written and used very carefully.</p>\n\n<p>I’m not going to explain how to build and use hooks here, if you never built a hook before, the React docs have a <a href="https://reactjs.org/docs/hooks-custom.html">pretty good introduction</a> into it. What I want to focus on today is their performance implication for complicated apps.</p>\n\n<h2>\n  <a name="lets-build-a-modal-dialog-on-custom-hooks" href="#lets-build-a-modal-dialog-on-custom-hooks">\n  </a>\n  Let’s build a modal dialog on custom hooks\n</h2>\n\n<p>Essentially, hooks are just advanced functions that allow developers to use things like state and context without creating new components. They are super useful when you need to share the same piece of logic that needs state between different parts of the app. With hooks came a new era in React development: never before our components were as slim and neat as with hooks, and separation of different concerns was as easy to achieve as with hooks.</p>\n\n<p>Let’s for example, implement a modal dialog. With custom hooks, we can create a piece of beauty here.</p>\n\n<p>First, let’s implement a “base” component, that doesn’t have any state, but just renders the dialog when <code>isOpen</code> prop is provided and triggers <code>onClose</code> callback when a click on a blanket underneath the dialog happens.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="kd">type</span> <span class="nx">ModalProps</span> <span class="o">=</span> <span class="p">{</span>\n  <span class="na">isOpen</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">;</span>\n  <span class="nl">onClosed</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>\n<span class="p">};</span>\n\n<span class="k">export</span> <span class="kd">const</span> <span class="nx">ModalBase</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">isOpen</span><span class="p">,</span> <span class="nx">onClosed</span> <span class="p">}:</span> <span class="nx">ModalProps</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="k">return</span> <span class="nx">isOpen</span> <span class="p">?</span> <span class="p">(</span>\n    <span class="p">&lt;&gt;</span>\n      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">css</span><span class="p">=</span><span class="si">{</span><span class="nx">modalBlanketCss</span><span class="si">}</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="nx">onClosed</span><span class="si">}</span> <span class="p">/&gt;</span>\n      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">css</span><span class="p">=</span><span class="si">{</span><span class="nx">modalBodyCss</span><span class="si">}</span><span class="p">&gt;</span>Modal dialog content<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>\n    <span class="p">&lt;/&gt;</span>\n  <span class="p">)</span> <span class="p">:</span> <span class="kc">null</span><span class="p">;</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Now to the state management, i.e. the “open dialog/close dialog” logic. In the “old” way we would usually implement a “smart” version of it, which handles the state management and accepts a component that is supposed to trigger the opening of the dialog as a prop. Something like this:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">ModalDialog</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">trigger</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="kd">const</span> <span class="p">[</span><span class="nx">isOpen</span><span class="p">,</span> <span class="nx">setIsOpen</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>\n\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;&gt;</span>\n      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">setIsOpen</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="si">}</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">trigger</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>\n      <span class="p">&lt;</span><span class="nc">ModalBase</span> <span class="na">isOpen</span><span class="p">=</span><span class="si">{</span><span class="nx">isOpen</span><span class="si">}</span> <span class="na">onClosed</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">setIsOpen</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="si">}</span> <span class="p">/&gt;</span>\n    <span class="p">&lt;/&gt;</span>\n  <span class="p">);</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Which then will be used like this:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="p">&lt;</span><span class="nc">ModalDialog</span> <span class="na">trigger</span><span class="p">=</span><span class="si">{</span><span class="p">&lt;</span><span class="nt">button</span><span class="p">&gt;</span>Click me<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span><span class="si">}</span> <span class="p">/&gt;</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>This is not a particularly pretty solution, we’re messing with the position and accessibility of the trigger component inside our modal dialog by wrapping it in a div. Not to mention that this unnecessary div will result in a slightly larger and messier DOM.</p>\n\n<p>And now watch the magic. If we extract the “open/close” logic into a custom hook, render this component <strong>inside</strong> the hook, and expose API to control it as a return value from the hook, we can have the best of both worlds. In the hook we’ll have the “smart” dialog that handles its own state, but doesn’t mess with the trigger nor does it need one:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">useModal</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="kd">const</span> <span class="p">[</span><span class="nx">isOpen</span><span class="p">,</span> <span class="nx">setIsOpen</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>\n\n  <span class="kd">const</span> <span class="nx">open</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">setIsOpen</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>\n  <span class="kd">const</span> <span class="nx">close</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">setIsOpen</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>\n  <span class="kd">const</span> <span class="nx">Dialog</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">&lt;</span><span class="nc">ModalBase</span> <span class="na">onClosed</span><span class="p">=</span><span class="si">{</span><span class="nx">close</span><span class="si">}</span> <span class="na">isOpen</span><span class="p">=</span><span class="si">{</span><span class="nx">isOpen</span><span class="si">}</span> <span class="p">/&gt;;</span>\n\n  <span class="k">return</span> <span class="p">{</span> <span class="nx">isOpen</span><span class="p">,</span> <span class="nx">Dialog</span><span class="p">,</span> <span class="nx">open</span><span class="p">,</span> <span class="nx">close</span> <span class="p">};</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>And on the consumer side we’ll have a minimal amount of code while having the full control over what triggers the dialog:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">ConsumerComponent</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="kd">const</span> <span class="p">{</span> <span class="nx">Dialog</span><span class="p">,</span> <span class="nx">open</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useModal</span><span class="p">();</span>\n\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;&gt;</span>\n      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="nx">open</span><span class="si">}</span><span class="p">&gt;</span>Click me<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>\n      <span class="p">&lt;</span><span class="nc">Dialog</span> <span class="p">/&gt;</span>\n    <span class="p">&lt;/&gt;</span>\n  <span class="p">);</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>If this isn’t perfection, I don’t know what is! 😍 <a href="https://codesandbox.io/s/modal-dialog-example1-9ds2c?file=/src/App.tsx">See this beauty in codesandbox</a>. Only don’t rush to use it in your apps right away, not until you read about its dark side 😅</p>\n\n<h2>\n  <a name="performance-implications" href="#performance-implications">\n  </a>\n  Performance implications\n</h2>\n\n<p>In the <a href="https://developerway.com/posts/how-to-write-performant-react-code">previous article</a>, where I covered in detail various patterns that lead to poor performance, I implemented a “slow” app: just a simple not optimized list of ~250 countries rendered on the page. But every interaction there causes the entire page to re-render, which makes it probably the slowest simple list ever existed. <a href="https://codesandbox.io/s/re-renders-final-bad-4znwe">Here is the codesandbox</a>, click on different countries in the list to see what I mean (if you’re on the latest Mac throttle your CPU a bit to get a better impression).</p>\n\n<blockquote>\n<p><b>How to throttle CPU</b>: in Chrome developer tools open “Performance” tab, and click on the “cog wheel” icon in the top right corner -<br>\n  it will open a small additional panel with throttling options.</p>\n</blockquote>\n\n<p>I’m going to use our new perfect modal dialog there and see what happens. The code of the main <code>Page</code> component is relatively simple and looks like this:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="kd">const</span> <span class="p">[</span><span class="nx">selectedCountry</span><span class="p">,</span> <span class="nx">setSelectedCountry</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="nx">Country</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">countries</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>\n  <span class="kd">const</span> <span class="p">[</span><span class="nx">savedCountry</span><span class="p">,</span> <span class="nx">setSavedCountry</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="nx">Country</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">countries</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>\n  <span class="kd">const</span> <span class="p">[</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">setMode</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span><span class="nx">Mode</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">\'</span><span class="s1">light</span><span class="dl">\'</span><span class="p">);</span>\n\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;</span><span class="nc">ThemeProvider</span> <span class="na">value</span><span class="p">=</span><span class="si">{</span><span class="p">{</span> <span class="nx">mode</span> <span class="p">}</span><span class="si">}</span><span class="p">&gt;</span>\n      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Country settings<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>\n      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">setMode</span><span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="dl">\'</span><span class="s1">light</span><span class="dl">\'</span> <span class="p">?</span> <span class="dl">\'</span><span class="s1">dark</span><span class="dl">\'</span> <span class="p">:</span> <span class="dl">\'</span><span class="s1">light</span><span class="dl">\'</span><span class="p">)</span><span class="si">}</span><span class="p">&gt;</span>Toggle theme<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>\n      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="p">=</span><span class="s">"content"</span><span class="p">&gt;</span>\n        <span class="p">&lt;</span><span class="nc">CountriesList</span> <span class="na">countries</span><span class="p">=</span><span class="si">{</span><span class="nx">countries</span><span class="si">}</span> <span class="na">onCountryChanged</span><span class="p">=</span><span class="si">{</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">setSelectedCountry</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span><span class="si">}</span> <span class="na">savedCountry</span><span class="p">=</span><span class="si">{</span><span class="nx">savedCountry</span><span class="si">}</span> <span class="p">/&gt;</span>\n        <span class="p">&lt;</span><span class="nc">SelectedCountry</span> <span class="na">country</span><span class="p">=</span><span class="si">{</span><span class="nx">selectedCountry</span><span class="si">}</span> <span class="na">onCountrySaved</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">setSavedCountry</span><span class="p">(</span><span class="nx">selectedCountry</span><span class="p">)</span><span class="si">}</span> <span class="p">/&gt;</span>\n      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>\n    <span class="p">&lt;/</span><span class="nc">ThemeProvider</span><span class="p">&gt;</span>\n  <span class="p">);</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>And now I need a button near the “Toggle theme” button that would open a modal dialog with some future additional settings for this page. Luckily, now it can’t be simpler: add <code>useModal</code> hook at the top, add the button where it needs to be, and pass <code>open</code> callback to the button. The <code>Page</code> component barely changes and is still quite simple:</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s---wcsG7EU--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/6kkynx9hikon0mnn8g3i.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s---wcsG7EU--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/6kkynx9hikon0mnn8g3i.png" alt="Image description" loading="lazy" width="880" height="616"></a></p>\n\n<p>You probably already guessed the result 🙂 The slowest appearance of 2 empty divs ever existed 😱. <a href="https://codesandbox.io/s/re-renders-bad-with-dialog-6egnq?file=/src/country-settings/page.tsx">See the codesandbox.</a></p>\n\n<p>You see, what is happening here, is our <code>useModal</code> hook uses state. And as we know, state changes are one of the reasons why a component would re-render itself. This also applies to hooks - if the hook\'s state changes, the "host" component will re-render. And it makes total sense. If we look closely inside <code>useModal</code> hook, we’ll see that it’s just a nice abstraction around <code>setState</code>, it exists <strong>outside</strong> of the <code>Dialog</code> component. Essentially it’s no different than calling <code>setState</code> in the <code>Page</code> component directly.</p>\n\n<p>And this is where the big danger of hooks is: yes, they help us make the API really nice. But what we did as a result, and the way of hooks is pretty much encouraging it, is essentially <strong>lifted state up</strong> from where it was supposed to be. And it’s entirely not noticeable unless you go inside the <code>useModal</code> implementation or have lots of experience with hooks and re-renders. I’m not even using the state directly in <code>Page</code> component, all I\'m doing from its perspective is rendering a <code>Dialog</code> component and calling an imperative API to open it.</p>\n\n<p>In the “old world”, the state would’ve been encapsulated in the slightly ugly <code>Modal</code> dialog with the <code>trigger</code> prop, and the <code>Page</code> component would’ve stayed intact when the button is clicked. Now the click on the button changes the state of <strong>the entire Page component</strong>, which causes it to re-render (which is super slow for this app). And the dialog can only appear when React is done with all the re-renders it caused, hence the big delay.</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--AYTSLLex--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ycwdve22u34dgq81cz6a.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--AYTSLLex--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ycwdve22u34dgq81cz6a.png" alt="Image description" loading="lazy" width="880" height="660"></a></p>\n\n<p>So, what can we do about it? We probably won’t have time and resources to fix the underlying performance of the <code>Page</code> component, as it would usually happen with the “real” apps. But at least we can make sure that the new feature doesn’t add to the performance problems and is fast by itself. All that we need to do here is just move the modal state “down”, away from the slow <code>Page</code> component:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">SettingsButton</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="kd">const</span> <span class="p">{</span> <span class="nx">Dialog</span><span class="p">,</span> <span class="nx">open</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useModal</span><span class="p">();</span>\n\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;&gt;</span>\n      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="nx">open</span><span class="si">}</span><span class="p">&gt;</span>Open settings<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>\n      <span class="p">&lt;</span><span class="nc">Dialog</span> <span class="p">/&gt;</span>\n    <span class="p">&lt;/&gt;</span>\n  <span class="p">);</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>And in <code>Page</code> just render the <code>SettingsButton</code>:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">Page</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">countries</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">countries</span><span class="p">:</span> <span class="nx">Country</span><span class="p">[]</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="c1">// same as original page state</span>\n  <span class="k">return</span> <span class="p">(</span>\n    <span class="p">&lt;</span><span class="nc">ThemeProvider</span> <span class="na">value</span><span class="p">=</span><span class="si">{</span><span class="p">{</span> <span class="nx">mode</span> <span class="p">}</span><span class="si">}</span><span class="p">&gt;</span>\n      // stays the same\n      <span class="p">&lt;</span><span class="nc">SettingsButton</span> <span class="p">/&gt;</span>\n      // stays the same\n    <span class="p">&lt;/</span><span class="nc">ThemeProvider</span><span class="p">&gt;</span>\n  <span class="p">);</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Now, when the button is clicked, only <code>SettingsButton</code> component will re-render, the slow <code>Page</code> component is unaffected. Essentially, we’re imitating the state model as it would’ve been in the “old” world while preserving the nice hooks-based API. See the <a href="https://codesandbox.io/s/re-renders-bad-with-dialog-fixed-rrfey?file=/src/country-settings/page.tsx">codesandbox</a> with the solution.</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--DylaYHgx--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/rdodquvil85v7hble1xt.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--DylaYHgx--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/rdodquvil85v7hble1xt.png" alt="Image description" loading="lazy" width="880" height="660"></a></p>\n\n<h2>\n  <a name="adding-more-functionality-to-the-raw-usemodal-endraw-hook" href="#adding-more-functionality-to-the-raw-usemodal-endraw-hook">\n  </a>\n  Adding more functionality to the <code>useModal</code> hook\n</h2>\n\n<p>Let’s make our hooks performance conversation slightly darker 🙂. Imagine, for example, you need to track the scroll event in the modal content. Maybe you want to send some analytics events when the users scroll through the text, to track reads. What will happen if I don’t want to introduce “smart” functionality to the <code>BaseModal</code> and do it in the <code>useModal</code> hook?</p>\n\n<p>Relatively easy to achieve. We can just introduce a new state there to track scroll position, add event listeners in <code>useEffect</code> hook and pass ref to the <code>BaseModal</code> to get the content element to attach the listeners to. Something like this:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">ModalBase</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">forwardRef</span><span class="p">(({</span> <span class="nx">isOpen</span><span class="p">,</span> <span class="nx">onClosed</span> <span class="p">}:</span> <span class="nx">ModalProps</span><span class="p">,</span> <span class="nx">ref</span><span class="p">:</span> <span class="nx">RefObject</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="k">return</span> <span class="nx">isOpen</span> <span class="p">?</span> <span class="p">(</span>\n    <span class="p">&lt;&gt;</span>\n      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">css</span><span class="p">=</span><span class="si">{</span><span class="nx">modalBlanketCss</span><span class="si">}</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="nx">onClosed</span><span class="si">}</span> <span class="p">/&gt;</span>\n      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">css</span><span class="p">=</span><span class="si">{</span><span class="nx">modalBodyCss</span><span class="si">}</span> <span class="na">ref</span><span class="p">=</span><span class="si">{</span><span class="nx">ref</span><span class="si">}</span><span class="p">&gt;</span>\n        // add a lot of content here\n      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>\n    <span class="p">&lt;/&gt;</span>\n  <span class="p">)</span> <span class="p">:</span> <span class="kc">null</span><span class="p">;</span>\n<span class="p">});</span>\n\n<span class="k">export</span> <span class="kd">const</span> <span class="nx">useModal</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="kd">const</span> <span class="p">[</span><span class="nx">isOpen</span><span class="p">,</span> <span class="nx">setIsOpen</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>\n  <span class="kd">const</span> <span class="nx">ref</span> <span class="o">=</span> <span class="nx">useRef</span><span class="o">&lt;</span><span class="nx">HTMLElement</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>\n  <span class="kd">const</span> <span class="p">[</span><span class="nx">scroll</span><span class="p">,</span> <span class="nx">setScroll</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>\n\n  <span class="c1">// same as before</span>\n\n  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n    <span class="kd">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">current</span><span class="p">;</span>\n    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">element</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>\n\n    <span class="kd">const</span> <span class="nx">handleScroll</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n      <span class="nx">setScroll</span><span class="p">(</span><span class="nx">element</span><span class="p">?.</span><span class="nx">scrollTop</span> <span class="o">||</span> <span class="mi">0</span><span class="p">);</span>\n    <span class="p">};</span>\n\n    <span class="nx">element</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">\'</span><span class="s1">scroll</span><span class="dl">\'</span><span class="p">,</span> <span class="nx">handleScroll</span><span class="p">);</span>\n    <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n      <span class="nx">element</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="dl">\'</span><span class="s1">scroll</span><span class="dl">\'</span><span class="p">,</span> <span class="nx">handleScroll</span><span class="p">);</span>\n    <span class="p">};</span>\n  <span class="p">});</span>\n\n  <span class="kd">const</span> <span class="nx">Dialog</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">&lt;</span><span class="nc">ModalBase</span> <span class="na">onClosed</span><span class="p">=</span><span class="si">{</span><span class="nx">close</span><span class="si">}</span> <span class="na">isOpen</span><span class="p">=</span><span class="si">{</span><span class="nx">isOpen</span><span class="si">}</span> <span class="na">ref</span><span class="p">=</span><span class="si">{</span><span class="nx">ref</span><span class="si">}</span> <span class="p">/&gt;;</span>\n\n  <span class="k">return</span> <span class="p">{</span>\n    <span class="nx">isOpen</span><span class="p">,</span>\n    <span class="nx">Dialog</span><span class="p">,</span>\n    <span class="nx">open</span><span class="p">,</span>\n    <span class="nx">close</span><span class="p">,</span>\n  <span class="p">};</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>And now we can do whatever with this state. Now let’s pretend that the previous performance problems are not that big of a deal, and use again this hook directly in the slow Page component. <a href="https://codesandbox.io/s/re-renders-bad-with-dialog-with-scroll-p9wi8?file=/src/country-settings/page.tsx">See codesandbox</a>.</p>\n\n<p>The scrolling doesn’t even work properly! 😱 Every time I try to scroll the dialog content it resets to the top!</p>\n\n<p>Okay, let’s think logically. <a href="https://www.developerway.com/posts/how-to-write-performant-react-code">We know already</a>, that creating components inside render functions is evil, since React will re-create and re-mount them on every re-render. And we know that hooks change with every state change. That means now, when we introduced scroll state, on every scroll change we’re changing state, which causes the hook to re-render, which causes <code>Dialog</code> component to re-create itself. Exactly the same problem, as with creating components inside render functions, with exactly the same fix: we need to extract this component outside of the hook or just memoise it.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">Dialog</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">&lt;</span><span class="nc">ModalBase</span> <span class="na">onClosed</span><span class="p">=</span><span class="si">{</span><span class="nx">close</span><span class="si">}</span> <span class="na">isOpen</span><span class="p">=</span><span class="si">{</span><span class="nx">isOpen</span><span class="si">}</span> <span class="na">ref</span><span class="p">=</span><span class="si">{</span><span class="nx">ref</span><span class="si">}</span> <span class="p">/&gt;;</span>\n<span class="p">},</span> <span class="p">[</span><span class="nx">isOpen</span><span class="p">]);</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>The focus behaviour is fixed, but there is another problem here: the slow <code>Page</code> component re-renders on every scroll! That one is a bit hard to notice since the dialog content is just text. Try, for example, to reduce the CPU by 6x, scroll, and then just highlight the text in the dialog right away. The browser won’t even allow that, since it’s too busy with re-renders of the underneath <code>Page</code> component! <a href="https://codesandbox.io/s/re-renders-bad-with-dialog-with-scroll-fixed-scroll-0s5g3?file=/src/country-settings/page.tsx">See the codesandbox.</a> And after a few scrolls, your laptop will probably try to take off to the Moon due to 100% CPU load 😅</p>\n\n<p>Yeah, we definitely need to fix that before releasing it to production. Let’s take another look at our component, especially at this part:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="k">return</span> <span class="p">{</span>\n  <span class="nx">isOpen</span><span class="p">,</span>\n  <span class="nx">Dialog</span><span class="p">,</span>\n  <span class="nx">open</span><span class="p">,</span>\n  <span class="nx">close</span><span class="p">,</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>We’re returning a new object on every re-render, and since we re-render our hook on every scroll now, that means that object changes on every scroll as well. But we’re not using the scroll state here, it’s entirely internal for the <code>useModal</code> hook. Surely just memoising that object will solve the problem?<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="k">return</span> <span class="nx">useMemo</span><span class="p">(</span>\n  <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">({</span>\n    <span class="nx">isOpen</span><span class="p">,</span>\n    <span class="nx">Dialog</span><span class="p">,</span>\n    <span class="nx">open</span><span class="p">,</span>\n    <span class="nx">close</span><span class="p">,</span>\n  <span class="p">}),</span>\n  <span class="p">[</span><span class="nx">isOpen</span><span class="p">,</span> <span class="nx">Dialog</span><span class="p">],</span>\n<span class="p">);</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>You know the best (or the scariest) part of this? IT DIDN’T! 😱 <a href="https://codesandbox.io/s/re-renders-bad-with-dialog-with-scroll-fixed-scroll-and-memo-35lqx?file=/src/country-settings/modal-dialog.tsx">See the codesandbox</a>.</p>\n\n<p>And this is another huge performance-related bummer with hooks. Turns out, it doesn’t really matter, whether the state change in hooks is “internal” or not. <strong>Every state change in a hook, whether it affects its return value or not, will cause the “host” component to re-render.</strong></p>\n\n<p>And of course exactly the same story with chaining hooks: if a hook’s state changes, it will cause its “host” hook change as well, which will propagate up through the whole chain of hooks until it reaches the “host” component and re-renders it (which will cause another chain reaction of re-renders, only downstream now), <strong>regardless of any memoisation</strong> applied in between.</p>\n\n<p>Extracting the “scrolling” functionality into a hook will make absolutely no difference, the slow Page component will re-render 😔.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">useScroll</span> <span class="o">=</span> <span class="p">(</span><span class="nx">ref</span><span class="p">:</span> <span class="nx">RefObject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="kd">const</span> <span class="p">[</span><span class="nx">scroll</span><span class="p">,</span> <span class="nx">setScroll</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>\n\n  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n    <span class="kd">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">current</span><span class="p">;</span>\n    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">element</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>\n\n    <span class="kd">const</span> <span class="nx">handleScroll</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n      <span class="nx">setScroll</span><span class="p">(</span><span class="nx">element</span><span class="p">?.</span><span class="nx">scrollTop</span> <span class="o">||</span> <span class="mi">0</span><span class="p">);</span>\n    <span class="p">};</span>\n\n    <span class="nx">element</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">\'</span><span class="s1">scroll</span><span class="dl">\'</span><span class="p">,</span> <span class="nx">handleScroll</span><span class="p">);</span>\n    <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n      <span class="nx">element</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="dl">\'</span><span class="s1">scroll</span><span class="dl">\'</span><span class="p">,</span> <span class="nx">handleScroll</span><span class="p">);</span>\n    <span class="p">};</span>\n  <span class="p">});</span>\n\n  <span class="k">return</span> <span class="nx">scroll</span><span class="p">;</span>\n<span class="p">};</span>\n\n<span class="k">export</span> <span class="kd">const</span> <span class="nx">useModal</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="kd">const</span> <span class="p">[</span><span class="nx">isOpen</span><span class="p">,</span> <span class="nx">setIsOpen</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>\n  <span class="kd">const</span> <span class="nx">ref</span> <span class="o">=</span> <span class="nx">useRef</span><span class="o">&lt;</span><span class="nx">HTMLElement</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>\n  <span class="kd">const</span> <span class="nx">scroll</span> <span class="o">=</span> <span class="nx">useScroll</span><span class="p">(</span><span class="nx">ref</span><span class="p">);</span>\n\n  <span class="kd">const</span> <span class="nx">open</span> <span class="o">=</span> <span class="nx">useCallback</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n    <span class="nx">setIsOpen</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>\n  <span class="p">},</span> <span class="p">[]);</span>\n\n  <span class="kd">const</span> <span class="nx">close</span> <span class="o">=</span> <span class="nx">useCallback</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n    <span class="nx">setIsOpen</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>\n  <span class="p">},</span> <span class="p">[]);</span>\n\n  <span class="kd">const</span> <span class="nx">Dialog</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n    <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">&lt;</span><span class="nc">ModalBase</span> <span class="na">onClosed</span><span class="p">=</span><span class="si">{</span><span class="nx">close</span><span class="si">}</span> <span class="na">isOpen</span><span class="p">=</span><span class="si">{</span><span class="nx">isOpen</span><span class="si">}</span> <span class="na">ref</span><span class="p">=</span><span class="si">{</span><span class="nx">ref</span><span class="si">}</span> <span class="p">/&gt;;</span>\n  <span class="p">},</span> <span class="p">[</span><span class="nx">isOpen</span><span class="p">,</span> <span class="nx">close</span><span class="p">]);</span>\n\n  <span class="k">return</span> <span class="nx">useMemo</span><span class="p">(</span>\n    <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">({</span>\n      <span class="nx">isOpen</span><span class="p">,</span>\n      <span class="nx">Dialog</span><span class="p">,</span>\n      <span class="nx">open</span><span class="p">,</span>\n      <span class="nx">close</span><span class="p">,</span>\n    <span class="p">}),</span>\n    <span class="p">[</span><span class="nx">isOpen</span><span class="p">,</span> <span class="nx">Dialog</span><span class="p">,</span> <span class="nx">open</span><span class="p">,</span> <span class="nx">close</span><span class="p">],</span>\n  <span class="p">);</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p><a href="https://codesandbox.io/s/re-renders-bad-with-dialog-with-scroll-extracted-woeer?file=/src/country-settings/modal-dialog.tsx">See the codesandbox.</a></p>\n\n<p>How to fix it? Well, the only thing to do here is to move the scroll tracking hook outside of the <code>useModal</code> hook and use it somewhere where it won’t cause the chain of re-renders. Can introduce <code>ModalBaseWithAnalytics</code> component for example:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="kd">const</span> <span class="nx">ModalBaseWithAnalytics</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">:</span> <span class="nx">ModalProps</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="kd">const</span> <span class="nx">ref</span> <span class="o">=</span> <span class="nx">useRef</span><span class="o">&lt;</span><span class="nx">HTMLElement</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>\n  <span class="kd">const</span> <span class="nx">scroll</span> <span class="o">=</span> <span class="nx">useScroll</span><span class="p">(</span><span class="nx">ref</span><span class="p">);</span>\n\n  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">scroll</span><span class="p">);</span>\n\n  <span class="k">return</span> <span class="p">&lt;</span><span class="nc">ModalBase</span> <span class="si">{</span><span class="p">...</span><span class="nx">props</span><span class="si">}</span> <span class="na">ref</span><span class="p">=</span><span class="si">{</span><span class="nx">ref</span><span class="si">}</span> <span class="p">/&gt;;</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>And then use it in the <code>useModal</code> hook instead of the <code>ModalBase</code>:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight tsx"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">useModal</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="c1">// the rest is the same as in the original useModal hook</span>\n\n  <span class="kd">const</span> <span class="nx">Dialog</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n    <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">&lt;</span><span class="nc">ModalBaseWithAnalytics</span> <span class="na">onClosed</span><span class="p">=</span><span class="si">{</span><span class="nx">close</span><span class="si">}</span> <span class="na">isOpen</span><span class="p">=</span><span class="si">{</span><span class="nx">isOpen</span><span class="si">}</span> <span class="na">ref</span><span class="p">=</span><span class="si">{</span><span class="nx">ref</span><span class="si">}</span> <span class="p">/&gt;;</span>\n  <span class="p">},</span> <span class="p">[</span><span class="nx">isOpen</span><span class="p">,</span> <span class="nx">close</span><span class="p">]);</span>\n\n  <span class="k">return</span> <span class="nx">useMemo</span><span class="p">(</span>\n    <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">({</span>\n      <span class="nx">isOpen</span><span class="p">,</span>\n      <span class="nx">Dialog</span><span class="p">,</span>\n      <span class="nx">open</span><span class="p">,</span>\n      <span class="nx">close</span><span class="p">,</span>\n    <span class="p">}),</span>\n    <span class="p">[</span><span class="nx">isOpen</span><span class="p">,</span> <span class="nx">Dialog</span><span class="p">,</span> <span class="nx">open</span><span class="p">,</span> <span class="nx">close</span><span class="p">],</span>\n  <span class="p">);</span>\n<span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Now the state changes due to the scrolling will be scoped to the <code>ModalBaseWithAnalytics</code> component and won’t affect the slow <code>Page</code> component. <a href="https://codesandbox.io/s/re-renders-bad-with-dialog-scroll-fixed-for-good-v6ohp?file=/src/country-settings/modal-dialog.tsx">See the codesandbox.</a></p>\n\n<p>That is all for today! Hope this article scared you enough helped you to feel more comfortable with custom hooks and how to write and use them without compromising the performance of your apps. Let’s recap the rules of performant hooks before leaving:</p>\n\n<ul>\n<li>every state change in a hook will cause its “host” component to re-render, regardless of whether this state is returned in the hook value and memoised or not</li>\n<li>the same with chained hooks, every state change in a hook will cause all “parent” hooks to change until it reaches the “host” component, which again will trigger the re-render</li>\n</ul>\n\n<p>And the things to watch out for, when writing or using custom hooks:</p>\n\n<ul>\n<li>when using a custom hook, make sure that the state that this hook encapsulates is not used on the level it wouldn’t have been used with the components approach. Move it “down” to a smaller component if necessary</li>\n<li>never implement “independent” state in a hook or use hooks with the independent state</li>\n<li>when using a custom hook, make sure it doesn’t perform some independent state operations, that are not exposed in its return value</li>\n<li>when using a custom hook, make sure that all hooks that it uses also follow the rules from the above</li>\n</ul>\n\n<p>Stay safe and may your apps be blazing fast from now on! ✌🏼</p>\n\n<p>...</p>\n\n<p>Originally published at <a href="https://www.developerway.com">https://www.developerway.com</a>. The website has more articles like this 😉</p>\n\n<p><a href="https://www.developerway.com">Subscribe to the newsletter</a>, <a href="https://www.linkedin.com/in/adevnadia/">connect on LinkedIn</a> or <a href="https://twitter.com/adevnadia">follow on Twitter</a> to get notified as soon as the next article comes out.</p>\n\n',e.body_markdown='![Image description](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/y9d2ys6t8v55ah82fz3b.png)\n\nScary title, isn’t it? The sad part is that it’s true: for performance-sensitive apps custom React hooks can very easily turn into the biggest performance killer, if not written and used very carefully.\n\nI’m not going to explain how to build and use hooks here, if you never built a hook before, the React docs have a <a href="https://reactjs.org/docs/hooks-custom.html">pretty good introduction</a> into it. What I want to focus on today is their performance implication for complicated apps.\n\n## Let’s build a modal dialog on custom hooks\n\nEssentially, hooks are just advanced functions that allow developers to use things like state and context without creating new components. They are super useful when you need to share the same piece of logic that needs state between different parts of the app. With hooks came a new era in React development: never before our components were as slim and neat as with hooks, and separation of different concerns was as easy to achieve as with hooks.\n\nLet’s for example, implement a modal dialog. With custom hooks, we can create a piece of beauty here.\n\nFirst, let’s implement a “base” component, that doesn’t have any state, but just renders the dialog when `isOpen` prop is provided and triggers `onClose` callback when a click on a blanket underneath the dialog happens.\n\n```tsx\ntype ModalProps = {\n  isOpen: boolean;\n  onClosed: () => void;\n};\n\nexport const ModalBase = ({ isOpen, onClosed }: ModalProps) => {\n  return isOpen ? (\n    <>\n      <div css={modalBlanketCss} onClick={onClosed} />\n      <div css={modalBodyCss}>Modal dialog content</div>\n    </>\n  ) : null;\n};\n```\n\nNow to the state management, i.e. the “open dialog/close dialog” logic. In the “old” way we would usually implement a “smart” version of it, which handles the state management and accepts a component that is supposed to trigger the opening of the dialog as a prop. Something like this:\n\n```tsx\nexport const ModalDialog = ({ trigger }) => {\n  const [isOpen, setIsOpen] = useState(false);\n\n  return (\n    <>\n      <div onClick={() => setIsOpen(true)}>{trigger}</div>\n      <ModalBase isOpen={isOpen} onClosed={() => setIsOpen(false)} />\n    </>\n  );\n};\n```\n\nWhich then will be used like this:\n\n```tsx\n<ModalDialog trigger={<button>Click me</button>} />\n```\n\nThis is not a particularly pretty solution, we’re messing with the position and accessibility of the trigger component inside our modal dialog by wrapping it in a div. Not to mention that this unnecessary div will result in a slightly larger and messier DOM.\n\nAnd now watch the magic. If we extract the “open/close” logic into a custom hook, render this component **inside** the hook, and expose API to control it as a return value from the hook, we can have the best of both worlds. In the hook we’ll have the “smart” dialog that handles its own state, but doesn’t mess with the trigger nor does it need one:\n\n```tsx\nexport const useModal = () => {\n  const [isOpen, setIsOpen] = useState(false);\n\n  const open = () => setIsOpen(true);\n  const close = () => setIsOpen(false);\n  const Dialog = () => <ModalBase onClosed={close} isOpen={isOpen} />;\n\n  return { isOpen, Dialog, open, close };\n};\n```\n\nAnd on the consumer side we’ll have a minimal amount of code while having the full control over what triggers the dialog:\n\n```tsx\nconst ConsumerComponent = () => {\n  const { Dialog, open } = useModal();\n\n  return (\n    <>\n      <button onClick={open}>Click me</button>\n      <Dialog />\n    </>\n  );\n};\n```\n\nIf this isn’t perfection, I don’t know what is! 😍 <a href="https://codesandbox.io/s/modal-dialog-example1-9ds2c?file=/src/App.tsx">See this beauty in codesandbox</a>. Only don’t rush to use it in your apps right away, not until you read about its dark side 😅\n\n## Performance implications\n\nIn the <a href="https://developerway.com/posts/how-to-write-performant-react-code">previous article</a>, where I covered in detail various patterns that lead to poor performance, I implemented a “slow” app: just a simple not optimized list of ~250 countries rendered on the page. But every interaction there causes the entire page to re-render, which makes it probably the slowest simple list ever existed. <a href="https://codesandbox.io/s/re-renders-final-bad-4znwe">Here is the codesandbox</a>, click on different countries in the list to see what I mean (if you’re on the latest Mac throttle your CPU a bit to get a better impression).\n\n\n>   <b>How to throttle CPU</b>: in Chrome developer tools open “Performance” tab, and click on the “cog wheel” icon in the top right corner -\n>   it will open a small additional panel with throttling options.\n\n\nI’m going to use our new perfect modal dialog there and see what happens. The code of the main `Page` component is relatively simple and looks like this:\n\n```tsx\nexport const Page = ({ countries }: { countries: Country[] }) => {\n  const [selectedCountry, setSelectedCountry] = useState<Country>(countries[0]);\n  const [savedCountry, setSavedCountry] = useState<Country>(countries[0]);\n  const [mode, setMode] = useState<Mode>(\'light\');\n\n  return (\n    <ThemeProvider value={{ mode }}>\n      <h1>Country settings</h1>\n      <button onClick={() => setMode(mode === \'light\' ? \'dark\' : \'light\')}>Toggle theme</button>\n      <div className="content">\n        <CountriesList countries={countries} onCountryChanged={(c) => setSelectedCountry(c)} savedCountry={savedCountry} />\n        <SelectedCountry country={selectedCountry} onCountrySaved={() => setSavedCountry(selectedCountry)} />\n      </div>\n    </ThemeProvider>\n  );\n};\n```\n\nAnd now I need a button near the “Toggle theme” button that would open a modal dialog with some future additional settings for this page. Luckily, now it can’t be simpler: add `useModal` hook at the top, add the button where it needs to be, and pass `open` callback to the button. The `Page` component barely changes and is still quite simple:\n\n\n![Image description](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/6kkynx9hikon0mnn8g3i.png)\n\n\nYou probably already guessed the result 🙂 The slowest appearance of 2 empty divs ever existed 😱. <a href="https://codesandbox.io/s/re-renders-bad-with-dialog-6egnq?file=/src/country-settings/page.tsx">See the codesandbox.</a>\n\nYou see, what is happening here, is our `useModal` hook uses state. And as we know, state changes are one of the reasons why a component would re-render itself. This also applies to hooks - if the hook\'s state changes, the "host" component will re-render. And it makes total sense. If we look closely inside `useModal` hook, we’ll see that it’s just a nice abstraction around `setState`, it exists **outside** of the `Dialog` component. Essentially it’s no different than calling `setState` in the `Page` component directly.\n\nAnd this is where the big danger of hooks is: yes, they help us make the API really nice. But what we did as a result, and the way of hooks is pretty much encouraging it, is essentially **lifted state up** from where it was supposed to be. And it’s entirely not noticeable unless you go inside the `useModal` implementation or have lots of experience with hooks and re-renders. I’m not even using the state directly in `Page` component, all I\'m doing from its perspective is rendering a `Dialog` component and calling an imperative API to open it.\n\nIn the “old world”, the state would’ve been encapsulated in the slightly ugly `Modal` dialog with the `trigger` prop, and the `Page` component would’ve stayed intact when the button is clicked. Now the click on the button changes the state of **the entire Page component**, which causes it to re-render (which is super slow for this app). And the dialog can only appear when React is done with all the re-renders it caused, hence the big delay.\n\n![Image description](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ycwdve22u34dgq81cz6a.png)\n\nSo, what can we do about it? We probably won’t have time and resources to fix the underlying performance of the `Page` component, as it would usually happen with the “real” apps. But at least we can make sure that the new feature doesn’t add to the performance problems and is fast by itself. All that we need to do here is just move the modal state “down”, away from the slow `Page` component:\n\n```tsx\nconst SettingsButton = () => {\n  const { Dialog, open } = useModal();\n\n  return (\n    <>\n      <button onClick={open}>Open settings</button>\n      <Dialog />\n    </>\n  );\n};\n```\n\nAnd in `Page` just render the `SettingsButton`:\n\n```tsx\nexport const Page = ({ countries }: { countries: Country[] }) => {\n  // same as original page state\n  return (\n    <ThemeProvider value={{ mode }}>\n      // stays the same\n      <SettingsButton />\n      // stays the same\n    </ThemeProvider>\n  );\n};\n```\n\nNow, when the button is clicked, only `SettingsButton` component will re-render, the slow `Page` component is unaffected. Essentially, we’re imitating the state model as it would’ve been in the “old” world while preserving the nice hooks-based API. See the <a href="https://codesandbox.io/s/re-renders-bad-with-dialog-fixed-rrfey?file=/src/country-settings/page.tsx">codesandbox</a> with the solution.\n\n![Image description](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/rdodquvil85v7hble1xt.png)\n\n## Adding more functionality to the `useModal` hook\n\nLet’s make our hooks performance conversation slightly darker 🙂. Imagine, for example, you need to track the scroll event in the modal content. Maybe you want to send some analytics events when the users scroll through the text, to track reads. What will happen if I don’t want to introduce “smart” functionality to the `BaseModal` and do it in the `useModal` hook?\n\nRelatively easy to achieve. We can just introduce a new state there to track scroll position, add event listeners in `useEffect` hook and pass ref to the `BaseModal` to get the content element to attach the listeners to. Something like this:\n\n```tsx\nexport const ModalBase = React.forwardRef(({ isOpen, onClosed }: ModalProps, ref: RefObject<any>) => {\n  return isOpen ? (\n    <>\n      <div css={modalBlanketCss} onClick={onClosed} />\n      <div css={modalBodyCss} ref={ref}>\n        // add a lot of content here\n      </div>\n    </>\n  ) : null;\n});\n\nexport const useModal = () => {\n  const [isOpen, setIsOpen] = useState(false);\n  const ref = useRef<HTMLElement>(null);\n  const [scroll, setScroll] = useState(0);\n\n  // same as before\n\n  useEffect(() => {\n    const element = ref.current;\n    if (!element) return;\n\n    const handleScroll = () => {\n      setScroll(element?.scrollTop || 0);\n    };\n\n    element.addEventListener(\'scroll\', handleScroll);\n    return () => {\n      element.removeEventListener(\'scroll\', handleScroll);\n    };\n  });\n\n  const Dialog = () => <ModalBase onClosed={close} isOpen={isOpen} ref={ref} />;\n\n  return {\n    isOpen,\n    Dialog,\n    open,\n    close,\n  };\n};\n```\n\nAnd now we can do whatever with this state. Now let’s pretend that the previous performance problems are not that big of a deal, and use again this hook directly in the slow Page component. <a href="https://codesandbox.io/s/re-renders-bad-with-dialog-with-scroll-p9wi8?file=/src/country-settings/page.tsx">See codesandbox</a>.\n\nThe scrolling doesn’t even work properly! 😱 Every time I try to scroll the dialog content it resets to the top!\n\nOkay, let’s think logically. <a href="https://www.developerway.com/posts/how-to-write-performant-react-code">We know already</a>, that creating components inside render functions is evil, since React will re-create and re-mount them on every re-render. And we know that hooks change with every state change. That means now, when we introduced scroll state, on every scroll change we’re changing state, which causes the hook to re-render, which causes `Dialog` component to re-create itself. Exactly the same problem, as with creating components inside render functions, with exactly the same fix: we need to extract this component outside of the hook or just memoise it.\n\n```tsx\nconst Dialog = useMemo(() => {\n  return () => <ModalBase onClosed={close} isOpen={isOpen} ref={ref} />;\n}, [isOpen]);\n```\n\nThe focus behaviour is fixed, but there is another problem here: the slow `Page` component re-renders on every scroll! That one is a bit hard to notice since the dialog content is just text. Try, for example, to reduce the CPU by 6x, scroll, and then just highlight the text in the dialog right away. The browser won’t even allow that, since it’s too busy with re-renders of the underneath `Page` component! <a href="https://codesandbox.io/s/re-renders-bad-with-dialog-with-scroll-fixed-scroll-0s5g3?file=/src/country-settings/page.tsx">See the codesandbox.</a> And after a few scrolls, your laptop will probably try to take off to the Moon due to 100% CPU load 😅\n\nYeah, we definitely need to fix that before releasing it to production. Let’s take another look at our component, especially at this part:\n\n```tsx\nreturn {\n  isOpen,\n  Dialog,\n  open,\n  close,\n};\n```\n\nWe’re returning a new object on every re-render, and since we re-render our hook on every scroll now, that means that object changes on every scroll as well. But we’re not using the scroll state here, it’s entirely internal for the `useModal` hook. Surely just memoising that object will solve the problem?\n\n```tsx\nreturn useMemo(\n  () => ({\n    isOpen,\n    Dialog,\n    open,\n    close,\n  }),\n  [isOpen, Dialog],\n);\n```\n\nYou know the best (or the scariest) part of this? IT DIDN’T! 😱 <a href="https://codesandbox.io/s/re-renders-bad-with-dialog-with-scroll-fixed-scroll-and-memo-35lqx?file=/src/country-settings/modal-dialog.tsx">See the codesandbox</a>.\n\nAnd this is another huge performance-related bummer with hooks. Turns out, it doesn’t really matter, whether the state change in hooks is “internal” or not. **Every state change in a hook, whether it affects its return value or not, will cause the “host” component to re-render.**\n\nAnd of course exactly the same story with chaining hooks: if a hook’s state changes, it will cause its “host” hook change as well, which will propagate up through the whole chain of hooks until it reaches the “host” component and re-renders it (which will cause another chain reaction of re-renders, only downstream now), **regardless of any memoisation** applied in between.\n\nExtracting the “scrolling” functionality into a hook will make absolutely no difference, the slow Page component will re-render 😔.\n\n```tsx\nconst useScroll = (ref: RefObject) => {\n  const [scroll, setScroll] = useState(0);\n\n  useEffect(() => {\n    const element = ref.current;\n    if (!element) return;\n\n    const handleScroll = () => {\n      setScroll(element?.scrollTop || 0);\n    };\n\n    element.addEventListener(\'scroll\', handleScroll);\n    return () => {\n      element.removeEventListener(\'scroll\', handleScroll);\n    };\n  });\n\n  return scroll;\n};\n\nexport const useModal = () => {\n  const [isOpen, setIsOpen] = useState(false);\n  const ref = useRef<HTMLElement>(null);\n  const scroll = useScroll(ref);\n\n  const open = useCallback(() => {\n    setIsOpen(true);\n  }, []);\n\n  const close = useCallback(() => {\n    setIsOpen(false);\n  }, []);\n\n  const Dialog = useMemo(() => {\n    return () => <ModalBase onClosed={close} isOpen={isOpen} ref={ref} />;\n  }, [isOpen, close]);\n\n  return useMemo(\n    () => ({\n      isOpen,\n      Dialog,\n      open,\n      close,\n    }),\n    [isOpen, Dialog, open, close],\n  );\n};\n```\n\n<a href="https://codesandbox.io/s/re-renders-bad-with-dialog-with-scroll-extracted-woeer?file=/src/country-settings/modal-dialog.tsx">See the codesandbox.</a>\n\nHow to fix it? Well, the only thing to do here is to move the scroll tracking hook outside of the `useModal` hook and use it somewhere where it won’t cause the chain of re-renders. Can introduce `ModalBaseWithAnalytics` component for example:\n\n```tsx\nconst ModalBaseWithAnalytics = (props: ModalProps) => {\n  const ref = useRef<HTMLElement>(null);\n  const scroll = useScroll(ref);\n\n  console.log(scroll);\n\n  return <ModalBase {...props} ref={ref} />;\n};\n```\n\nAnd then use it in the `useModal` hook instead of the `ModalBase`:\n\n```tsx\nexport const useModal = () => {\n  // the rest is the same as in the original useModal hook\n\n  const Dialog = useMemo(() => {\n    return () => <ModalBaseWithAnalytics onClosed={close} isOpen={isOpen} ref={ref} />;\n  }, [isOpen, close]);\n\n  return useMemo(\n    () => ({\n      isOpen,\n      Dialog,\n      open,\n      close,\n    }),\n    [isOpen, Dialog, open, close],\n  );\n};\n```\n\nNow the state changes due to the scrolling will be scoped to the `ModalBaseWithAnalytics` component and won’t affect the slow `Page` component. <a href="https://codesandbox.io/s/re-renders-bad-with-dialog-scroll-fixed-for-good-v6ohp?file=/src/country-settings/modal-dialog.tsx">See the codesandbox.</a>\n\nThat is all for today! Hope this article <s>scared you enough</s> helped you to feel more comfortable with custom hooks and how to write and use them without compromising the performance of your apps. Let’s recap the rules of performant hooks before leaving:\n\n- every state change in a hook will cause its “host” component to re-render, regardless of whether this state is returned in the hook value and memoised or not\n- the same with chained hooks, every state change in a hook will cause all “parent” hooks to change until it reaches the “host” component, which again will trigger the re-render\n\nAnd the things to watch out for, when writing or using custom hooks:\n\n- when using a custom hook, make sure that the state that this hook encapsulates is not used on the level it wouldn’t have been used with the components approach. Move it “down” to a smaller component if necessary\n- never implement “independent” state in a hook or use hooks with the independent state\n- when using a custom hook, make sure it doesn’t perform some independent state operations, that are not exposed in its return value\n- when using a custom hook, make sure that all hooks that it uses also follow the rules from the above\n\nStay safe and may your apps be blazing fast from now on! ✌🏼\n\n...\n\nOriginally published at [https://www.developerway.com](https://www.developerway.com). The website has more articles like this 😉\n\n[Subscribe to the newsletter](https://www.developerway.com), [connect on LinkedIn](https://www.linkedin.com/in/adevnadia/) or [follow on Twitter](https://twitter.com/adevnadia) to get notified as soon as the next article comes out.',e.user={name:"Nadia Makarevich",username:a,twitter_username:a,github_username:a,website_url:"https://www.developerway.com",profile_image:"https://res.cloudinary.com/practicaldev/image/fetch/s--JnKvtJkQ--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/762035/1f7fe6e4-1e60-4c01-80cc-532142263682.jpg",profile_image_90:"https://res.cloudinary.com/practicaldev/image/fetch/s--j3FZXwJO--/c_fill,f_auto,fl_progressive,h_90,q_auto,w_90/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/762035/1f7fe6e4-1e60-4c01-80cc-532142263682.jpg"},{layout:"default",data:[{}],fetch:{"data-v-70afb46a:0":{article:e}},error:s,state:{currentArticle:e},serverRendered:!0,routePath:"/adevnadia/965581",config:{_app:{basePath:"/nuxtstop/",assetsPath:"/nuxtstop/_nuxt/",cdnURL:s}}}}(null,"2022-01-24T08:49:37Z","adevnadia",{})</script><script src="/nuxtstop/_nuxt/f6e87fb.js" defer></script><script src="/nuxtstop/_nuxt/dc9ce94.js" defer></script><script src="/nuxtstop/_nuxt/6474719.js" defer></script><script src="/nuxtstop/_nuxt/9b75090.js" defer></script><script src="/nuxtstop/_nuxt/18df600.js" defer></script>
  </body>
</html>
