<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>ESP32 MicroPython MQTT TLS</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="Using Nuxt.js fetch() hook to build dev.to with a new look"><meta data-n-head="ssr" name="format-detection" content="telephone=no"><base href="/nuxtstop/"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,500,600&display=swap"><link rel="preload" href="/nuxtstop/_nuxt/f6e87fb.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/6474719.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/9b75090.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/18df600.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/dc9ce94.js" as="script"><style data-vue-ssr-id="c650fd98:0 af4684f0:0 a9c71758:0 dcafa518:0 4b9cec49:0 b093d766:0 9d98bcb4:0 6b6a11ea:0 0248ed80:0 ea8e4264:0">html{box-sizing:border-box;font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}*,:after,:before{box-sizing:inherit}html{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}*,:after,:before{border:0 solid #e0e0e0}blockquote,body,dd,dl,figure,h1,h2,h3,h4,h5,h6,p,pre{margin:0}button{background:0 0;padding:0}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}hr{border-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:inherit;opacity:.5}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:inherit;opacity:.5}input::placeholder,textarea::placeholder{color:inherit;opacity:.5}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit;font-family:sans-serif}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit;font-family:inherit;font-size:100%}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;overflow:auto;word-break:break-word;white-space:normal}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}html{height:100%;font-size:18px;-ms-overflow-style:scrollbar;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}@media(min-width:640px){html{font-size:20px}}body{height:100%;min-width:320px;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:400;line-height:1.5;color:#000;background-color:#eff4f7;-webkit-text-rendering:optimizeLegibility;text-rendering:optimizeLegibility;font-synthesis:none;font-kerning:normal;font-feature-settings:"normal","kern";-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-overflow-scrolling:touch;overflow-x:hidden;overflow-y:scroll}h1,h2,h3,h4,h5,h6{color:#000;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:600;font-feature-settings:"normal";line-height:1.2}pre{background:#29292e;border-radius:2px;overflow:auto;padding:1rem;color:#eff1f9;line-height:1.42em;font-size:13px}@media screen and (min-width:380px){pre{font-size:15px}}pre code{background:#29292e;color:#eff0f9;white-space:pre}div.highlight pre.highlight code{font-size:inherit;padding:0}div.inner-comment div.body div.highlight pre.highlight{background:#29292e}div.inner-comment div.body div.highlight pre.highlight code{font-size:inherit;white-space:inherit;background:inherit;color:inherit}.highlight .hll{background-color:#49483e}.highlight{background:#29292e;color:#f8f8f2}.highlight .c{color:grey}.highlight .err{text-shadow:0 0 7px #f9690e}.highlight .k{color:#f39c12}.highlight .l{color:plum}.highlight .n{color:#f8f8f2}.highlight .o{color:#f9690e}.highlight .p{color:#f8f8f2}.highlight .c1,.highlight .ch,.highlight .cm,.highlight .cp,.highlight .cpf,.highlight .cs{color:grey}.highlight .gd{color:#f9690e}.highlight .ge{font-style:italic}.highlight .gi{color:#7ed07e}.highlight .gs{font-weight:700}.highlight .gu{color:grey}.highlight .kc,.highlight .kd{color:#f39c12}.highlight .kn{color:#f9690e}.highlight .kp,.highlight .kr,.highlight .kt{color:#f39c12}.highlight .ld{color:#f2ca27}.highlight .m{color:plum}.highlight .s{color:#f2ca27}.highlight .na{color:#7ed07e}.highlight .nb{color:#f8f8f2}.highlight .nc{color:#7ed07e}.highlight .no{color:#f39c12}.highlight .nd{color:#7ed07e}.highlight .ni{color:#f8f8f2}.highlight .ne,.highlight .nf{color:#7ed07e}.highlight .nl,.highlight .nn{color:#f8f8f2}.highlight .nx{color:#7ed07e}.highlight .py{color:#f8f8f2}.highlight .nt{color:#f9690e}.highlight .nv{color:#f8f8f2}.highlight .ow{color:#f9690e}.highlight .w{color:#f8f8f2}.highlight .mb,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo{color:plum}.highlight .dl,.highlight .s2,.highlight .sa,.highlight .sb,.highlight .sc,.highlight .sd{color:#f2ca27}.highlight .se{color:plum}.highlight .s1,.highlight .sh,.highlight .si,.highlight .sr,.highlight .ss,.highlight .sx{color:#f2ca27}.highlight .bp{color:#f8f8f2}.highlight .fm{color:#7ed07e}.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{color:#f8f8f2}.highlight .il{color:plum}.vue-content-placeholders-heading__img,.vue-content-placeholders-heading__subtitle,.vue-content-placeholders-heading__title,.vue-content-placeholders-img,.vue-content-placeholders-text__line{background:#bfcdec!important}.vue-content-placeholders-is-animated .vue-content-placeholders-heading__img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__subtitle:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__title:before,.vue-content-placeholders-is-animated .vue-content-placeholders-img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-text__line:before{background:linear-gradient(90deg,transparent 0,#d3ddf9 15%,transparent 30%)!important}header[data-v-27046cca]{max-width:1280px;margin:auto;padding:1rem;height:6rem;border-bottom:1px solid rgba(0,0,0,.2)}header .logo-wrapper[data-v-27046cca],header[data-v-27046cca]{display:flex;align-items:center;justify-content:space-between}header .logo-wrapper[data-v-27046cca]{margin:0 .5rem}header .logo-wrapper svg[data-v-27046cca]{width:3rem;height:100%}header .logo-wrapper .name-wrapper[data-v-27046cca]{margin-left:.6em}header .logo-wrapper .name-wrapper .subtitle[data-v-27046cca]{font-size:1rem}header .logo-wrapper .name-wrapper .app-name[data-v-27046cca]{font-weight:700;font-size:2.25rem;line-height:1.25}header nav[data-v-27046cca]{letter-spacing:-.025rem;font-weight:600;text-transform:uppercase}header nav ul[data-v-27046cca]{display:flex}header nav ul li[data-v-27046cca]{margin:0 .5rem}header nav ul li a[data-v-27046cca]{box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;padding:.25rem 1rem;border-radius:.5rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}header nav ul li a[data-v-27046cca]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header nav ul li a.nuxt-link-exact-active[data-v-27046cca]{cursor:default}header nav ul li a.nuxt-link-exact-active[data-v-27046cca],header nav ul li a[data-v-27046cca]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}.page-wrapper[data-v-10d06ee8]{max-width:1280px;margin:auto;padding:1rem}.article-content-wrapper[data-v-10d06ee8]{display:flex;flex-direction:column;align-items:center;margin:auto auto 2rem}@media(min-width:1024px){.article-content-wrapper[data-v-10d06ee8]{align-items:normal;flex-direction:row}}.article-content-wrapper .article-block[data-v-10d06ee8]{width:100%;max-width:880px}@media(min-width:1024px){.article-content-wrapper .article-block[data-v-10d06ee8]{margin-right:1rem;width:66.66666%;margin-bottom:2rem}}.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{max-width:880px;width:100%;position:relative}@media(min-width:1024px){.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{display:block;width:33.33333%}}.article-content-wrapper .aside-username-wrapper .aside-username-block[data-v-10d06ee8]{position:-webkit-sticky;position:sticky;top:1rem}@media(min-width:1280px){.comments-block[data-v-10d06ee8]{margin:.5rem}}article[data-v-70afb46a]{padding:.5rem;border-radius:1rem}header h1[data-v-70afb46a],header[data-v-70afb46a]{margin-bottom:1rem}header h1[data-v-70afb46a]{font-size:2.25rem;letter-spacing:-.025rem}header .tags[data-v-70afb46a]{display:flex;flex-wrap:wrap;margin-bottom:1.5rem}header .tags .tag[data-v-70afb46a]{font-weight:500;line-height:1;padding:.5rem;margin:0 .5rem .5rem 0;border-radius:.25rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db}header .tags .tag[data-v-70afb46a]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header .tags .tag[data-v-70afb46a]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}header .image-wrapper[data-v-70afb46a]{position:relative;padding-bottom:56.25%;background-color:#d4dfe8;margin-bottom:1.5rem;border-radius:.5rem;overflow:hidden}@media(min-width:834px){header .image-wrapper[data-v-70afb46a]{margin-bottom:1.5rem}}header .image-wrapper img[data-v-70afb46a]{position:absolute;top:0;left:0;width:100%;height:100%;-o-object-fit:cover;object-fit:cover}header .meta[data-v-70afb46a]{line-height:1;font-size:.875rem;text-transform:uppercase;font-weight:500;letter-spacing:-.025rem;display:flex;align-items:center;justify-content:space-between}header .meta .scl[data-v-70afb46a]{display:flex}header .meta .scl span[data-v-70afb46a]{display:flex;align-items:center;margin-right:1rem}header .meta .scl span svg[data-v-70afb46a]{margin-right:.25rem}header .meta .scl .comments[data-v-70afb46a]{cursor:pointer}[data-v-70afb46a] .content .ltag__user{display:none}[data-v-70afb46a] .content iframe{max-width:100%}[data-v-70afb46a] .content h1{font-size:1.875rem}[data-v-70afb46a] .content h1,[data-v-70afb46a] .content h2{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h2{font-size:1.5rem}[data-v-70afb46a] .content h3{font-size:1.25rem}[data-v-70afb46a] .content h3,[data-v-70afb46a] .content h4{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h4{font-size:1rem}[data-v-70afb46a] .content a{color:#6e87d2}[data-v-70afb46a] .content p{margin-bottom:1rem;line-height:1.4}[data-v-70afb46a] .content p code{background-color:#d2f3e1;border-radius:.25rem;padding:.25rem}[data-v-70afb46a] .content img{width:100%;border-radius:.5rem}[data-v-70afb46a] .content .highlight{margin-bottom:1rem;border-radius:.5rem}[data-v-70afb46a] .content ul{list-style:numeral;margin-bottom:1rem}[data-v-70afb46a] .content ul li p{margin-bottom:0}[data-v-70afb46a] .content ol{margin-bottom:1rem}aside[data-v-37984f8c]{padding:1rem;background-color:#dfe8ef;border-radius:1rem}aside .username-heading[data-v-37984f8c]{display:flex;margin-bottom:1rem}aside .username-heading[data-v-37984f8c]:hover{color:#6e87d2}aside .username-heading img[data-v-37984f8c]{width:3rem;height:3rem;border-radius:50%;margin-right:1rem}aside .username-heading .text[data-v-37984f8c]{display:flex;flex-direction:column;justify-content:center}aside .username-heading .text a[data-v-37984f8c]{line-height:1}aside .username-heading .text a[data-v-37984f8c]:first-child{font-size:1.25rem;font-weight:500;letter-spacing:-.025rem;margin-bottom:.25rem}aside .username-heading .text a[data-v-37984f8c]:last-child{color:#999;font-size:.875rem}aside .username-heading.loading[data-v-37984f8c]{display:block}aside .f-button[data-v-37984f8c]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}aside .f-button[data-v-37984f8c]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}aside .f-button[data-v-37984f8c]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}aside .info>div[data-v-37984f8c]{margin-bottom:.5rem}aside .info .title[data-v-37984f8c]{font-size:.666666rem;letter-spacing:-.0125rem;font-weight:500;color:#999;text-transform:uppercase;margin-bottom:.1rem}aside .info .content[data-v-37984f8c]{font-size:.875rem;line-height:1.4}.add-comment[data-v-8c4375bc]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}.add-comment[data-v-8c4375bc]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}.add-comment[data-v-8c4375bc]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}footer[data-v-22cb8fd0]{padding:2rem;text-align:center;display:flex;align-items:center;justify-content:center}footer span[data-v-22cb8fd0]{display:inline-block;line-height:1;text-transform:uppercase;letter-spacing:-.025rem;font-size:.75rem;font-weight:500}footer a svg[data-v-22cb8fd0]{width:3rem;height:3rem;margin:0 .5rem}footer a .nuxt-icon[data-v-22cb8fd0]{width:2.5rem;height:2.5rem;margin:0 .25rem}</style>
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><div id="__layout"><div><header data-v-27046cca><a href="/nuxtstop/" class="logo-wrapper nuxt-link-active" data-v-27046cca><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-27046cca><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-27046cca></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-27046cca></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-27046cca></path></svg> <div class="name-wrapper" data-v-27046cca><span class="app-name" data-v-27046cca>Nuxtstop</span> <p class="subtitle" data-v-27046cca>For all things nuxt.js</p></div></a> <nav data-v-27046cca><ul data-v-27046cca><li data-v-27046cca><a href="/nuxtstop/" class="nuxt-link-active" data-v-27046cca>
          New
        </a></li><li data-v-27046cca><a href="/nuxtstop/top" data-v-27046cca>
          Top
        </a></li></ul></nav></header> <div class="page-wrapper" data-v-10d06ee8><div class="article-content-wrapper" data-v-10d06ee8><article data-fetch-key="data-v-70afb46a:0" class="article-block" data-v-70afb46a data-v-10d06ee8><header data-v-70afb46a><h1 data-v-70afb46a>ESP32 MicroPython MQTT TLS</h1> <div class="tags" data-v-70afb46a><a href="/nuxtstop/t/micropython" class="tag" data-v-70afb46a>
          #micropython
        </a><a href="/nuxtstop/t/mqtt" class="tag" data-v-70afb46a>
          #mqtt
        </a><a href="/nuxtstop/t/esp32" class="tag" data-v-70afb46a>
          #esp32
        </a></div> <!----> <div class="meta" data-v-70afb46a><div class="scl" data-v-70afb46a><span data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M16.4444 3C14.6733 3 13.0333 3.94162 12 5.34C10.9667 3.94162 9.32667 3 7.55556 3C4.49222 3 2 5.52338 2 8.625C2 14.8024 11.0267 20.586 11.4122 20.829C11.5922 20.9426 11.7956 21 12 21C12.2044 21 12.4078 20.9426 12.5878 20.829C12.9733 20.586 22 14.8024 22 8.625C22 5.52338 19.5078 3 16.4444 3Z" fill="#FF0000" data-v-70afb46a data-v-70afb46a></path></svg>
            9
          </span> <span class="comments" data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M6.11765 22H4.94118L5.64706 21.05C6.11765 20.3969 6.41176 19.5656 6.58824 18.5563C3.64706 17.1906 2 14.6375 2 11.3125C2 6.20625 5.82353 3 12 3C18.1765 3 22 6.20625 22 11.3125C22 16.5375 18.2353 19.625 12 19.625H11.5882C10.6471 20.7531 9 22 6.11765 22ZM12 4.1875C6.47059 4.1875 3.17647 6.85937 3.17647 11.3125C3.17647 15.1125 5.47059 16.8938 7.41177 17.6656L7.82353 17.8437L7.76471 18.3187C7.64706 19.2687 7.47059 20.1 7.11765 20.8125C9.05882 20.575 10.1765 19.5656 10.8235 18.7344L11 18.4969H12C19.9412 18.4969 20.8235 13.5094 20.8235 11.3719C20.8235 6.85938 17.5294 4.1875 12 4.1875Z" fill="black" data-v-70afb46a data-v-70afb46a></path></svg>
            0
          </span></div> <time data-v-70afb46a>Jan 16</time></div></header> <div class="content" data-v-70afb46a><h1>
  <a name="implementation-of-an-encrypted-mqtt-connection-with-micropython-on-a-esp32" href="#implementation-of-an-encrypted-mqtt-connection-with-micropython-on-a-esp32">
  </a>
  <h1 id="3">Implementation of an encrypted MQTT connection with MicroPython on a ESP32</h1>
</h1>

<h1>
  <a name="table-of-contents" href="#table-of-contents">
  </a>
  Table of Contents
</h1>

<ol>
<li>
<a href="#paragraph0">Introduction: ESP32 MicroPython MQTT TLS</a>
</li>
<li><a href="#paragraph1">Installing MicroPython</a></li>
<li><a href="#paragraph2">Using MicroPython</a></li>
<li><a href="#paragraph3">Wifi and MQTT Connection</a></li>
<li><a href="#paragraph4">MQTT and TLS</a></li>
</ol>

<h1>
  <a name="introduction-esp32-micropython-mqtt-tls" href="#introduction-esp32-micropython-mqtt-tls">
  </a>
  Introduction: ESP32 MicroPython MQTT TLS <a name="paragraph0"></a>
</h1>

<p>by: Bass Paranoya</p>


<hr>

<h2>
  <a name="overview" href="#overview">
  </a>
  Overview
</h2>

<p>In this tutorial you will learn how to program the ESP32 using MicroPython. At first we will connect the device to the Internet via WIFI. Furthermore we will use this knowledge to implement a MQTT connection to send internal sensor data. In the last steps we will discuss data security and use it to authenticate and encrypt our MQTT connection over TLS. </p>

<h2>
  <a name="prerequisites-and-required-equipment" href="#prerequisites-and-required-equipment">
  </a>
  Prerequisites and required Equipment
</h2>

<ul>
<li>Computer</li>
<li>Visual Studio Code</li>
<li>ESP32 DevKitC</li>
<li>USB-Cable which allows to transfer data </li>
</ul>

<blockquote>
<p>The tutorial was made on a Windows system. Nevertheless, I will also present the commands for Ubuntu. If you use a Mac or another system you'll find the necessary commands most of the time in the presented external links (APIs) at the end of each lesson under "Hints and pitfalls", "Useful Resources for Own Searches" and "Sources"). I recommend to use Visual Studio Code.</p>
</blockquote>


<hr>

<h1>
  <a name="lesson-1-installing-micropython" href="#lesson-1-installing-micropython">
  </a>
  Lesson 1: Installing MicroPython <a name="paragraph1"></a>
</h1>

<h2>
  <a name="objectives" href="#objectives">
  </a>
  Objectives
</h2>

<p>Our first lesson will be flashing the ESP32 with MicroPython.</p>

<h2>
  <a name="prerequisites-and-required-equipment" href="#prerequisites-and-required-equipment">
  </a>
  Prerequisites and required Equipment
</h2>

<ul>
<li>ESP32 DevKitC</li>
<li>USB-Cable which allows to transfer data </li>
<li>Computer </li>
</ul>


<hr>

<h2>
  <a name="solution-steps" href="#solution-steps">
  </a>
  Solution Steps
</h2>

<ol>
<li><p>Download the latest MicroPython firmware:<br><br>
<a href="https://micropython.org/download/esp32/">Click <strong>here</strong> for downloading the latest .bin file</a> (e.g.:  v1.17 (2021-09-02) .bin) </p></li>
<li><p>Connect the ESP32 with the USB cable to your computer. </p></li>
<li><p>Install the esptool extension using <code>pip</code> in a terminal or the powershell in VS Code:  </p></li>
</ol>

<blockquote>
<p><a href="https://pip.pypa.io/en/stable/installation/">Click <strong>here</strong> if you have not installed pip.</a><br>
</p>
</blockquote>

<div class="highlight js-code-highlight">
<pre class="highlight console"><code><span class="go">pip install esptool
</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<ul>
<li>alternatively you can use <a href="https://github.com/espressif/esptool/">this <strong>GitHub Link</strong></a>.</li>
</ul>

<blockquote>
<p>You need to look up the port used for the ESP32 in the Device Manager. Adjust the COMx for your command in the next step.<br><br>
If the ESP32 does not connect to any port, the chance is high that your USB cable is not suitable for exchanging data (it is a power supply only). Use a suitable one instead. </p>
</blockquote>

<ol>
<li>Erase the flash under Windows with:
</li>
</ol>

<div class="highlight js-code-highlight">
<pre class="highlight console"><code><span class="go">python -m esptool --port COMx erase_flash 
</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<ul>
<li>Or on Linux
</li>
</ul>

<div class="highlight js-code-highlight">
<pre class="highlight console"><code><span class="go">esptool.py --port /dev/ttyUSBx erase_flash
</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<ul>
<li>If the command output says something similar to "no permission", then it is likely the ESP32 is connected somewhere else. Disconnect it.</li>
</ul>

<ol>
<li>Next we will deploy the new firmware with this example command on Windows which worked best on my system (use your port and path):
</li>
</ol>

<div class="highlight js-code-highlight">
<pre class="highlight console"><code><span class="go">python -m esptool --chip esp32 --port COMx write_flash -z 0x1000 C:\path_to_firmware\esp32-20210902-v1.17.bin 
</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<ul>
<li>If you use Linux:
</li>
</ul>

<div class="highlight js-code-highlight">
<pre class="highlight console"><code><span class="go">esptool.py --chip esp32 --port /dev/ttyUSBx write_flash -z 0x1000 esp32-20180511-v1.9.4.bin
</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<ol>
<li>If the above commands run without error then MicroPython should be installed on your board.
</li>
</ol>


<hr>

<h2>
  <a name="hints-and-pitfalls" href="#hints-and-pitfalls">
  </a>
  Hints and pitfalls
</h2>

<ul>
<li>You may need to reduce the baudrate if you get errors while flashing (e.g. down to 115200 by adding <code>--baud 115200</code> into the command) or (<code>-b 9600</code> is a very slow value that you can use to verify it is not a baud rate problem)</li>
<li>For some boards with a particular FlashROM configuration you may need to change the flash mode (e.g. by adding <code>-fm dio</code> into the command)</li>
<li>Check if you have permissions to access the serial port, and if other software (such as modem-manager on Linux) is trying to interact with it. A common pitfall is leaving a serial terminal accessing this port open in another window and forgetting about it.</li>
<li>for more tips check out the following links:</li>
</ul>


<hr>

<h2>
  <a name="useful-resources-for-own-searches" href="#useful-resources-for-own-searches">
  </a>
  Useful Resources for Own Searches
</h2>

<p><a href="https://docs.micropython.org/en/latest/esp32/tutorial/intro.html">Click here for the <strong>Getting Started with MicroPython on the ESP32</strong> from the MicroPython API</a><br><br>
<a href="https://docs.espressif.com/projects/esptool/en/latest/esp32/installation.html">Click here for the <strong>Installation and Dependencies</strong> tutorial from ESPRESSIF</a><br><br>
<a href="https://docs.espressif.com/projects/esptool/en/latest/esp32/troubleshooting.html#troubleshooting">Check out the <strong>Troubleshooting</strong> from ESPRESSIF if you still get Errors</a></p>

<hr>
<h2>
  <a name="whats-next" href="#whats-next">
  </a>
  What's next
</h2>

<p>Using MicroPython</p>

<hr>
<h2>
  <a name="sources" href="#sources">
  </a>
  Source(s)
</h2>

<ul>
<li>Micropython API for ESP32 Boards: <a href="https://docs.micropython.org/en/latest/esp32/quickref.html">https://docs.micropython.org/en/latest/esp32/quickref.html</a>
</li>
<li>ESPRESSIF documentation: <a href="https://docs.espressif.com/projects/esptool/en/latest/esp32/index.html#">https://docs.espressif.com/projects/esptool/en/latest/esp32/index.html#</a>
</li>
</ul>


<h1>
  <a name="lesson-2-using-micropython" href="#lesson-2-using-micropython">
  </a>
  Lesson 2: Using MicroPython <a name="paragraph2"></a>
</h1>
<h2>
  <a name="objectives" href="#objectives">
  </a>
  Objectives
</h2>

<p>Next, we will get a REPL promt in which we can use MicroPython on the ESP32.</p>
<h2>
  <a name="prerequisites-and-required-equipment" href="#prerequisites-and-required-equipment">
  </a>
  Prerequisites and required Equipment
</h2>

<ul>
<li>ESP32 DevKitC</li>
<li>Computer</li>
<li>USB-Cable which allows data transfer </li>
<li>Visual Studio Code</li>
</ul>

<hr>
<h2>
  <a name="solution-steps" href="#solution-steps">
  </a>
  Solution Steps
</h2>

<ol>
<li><p>In order to use Pymakr extension on VS Code, you need node.js installed on your computer. <a href="https://nodejs.org/en/download/">Use this link to get to the download page.</a> </p></li>
<li><p>Open Visual Studio Code and install the Pymakr Extension (ID: pycom.pymakr)</p></li>
<li><p>If you have any trouble, <a href="https://randomnerdtutorials.com/micropython-esp32-esp8266-vs-code-pymakr/#pymakr">here is a detailed manual</a> (at the top of the page you can also follow the manual for installing VS Code)</p></li>
<li><p>Edit the pymakr.json file which opens automatically after installing Pymakr, in case it did not: Hit the "ALL commands" button at the very bottom of the VS Code window and click on "Global Setting".</p></li>
</ol>

<ul>
<li><p>Pymakr has a list of USB devices it will connect to. You need to make sure that your device is on the list in the pymakr.json configuration file. You need to add the USB Manufacturer that the device uses to connect to the PC. In our case, the ESP32 uses the "Silicon Labs" USB drivers.</p></li>
<li><p>To find out which drivers your board uses, open your computer’s Device Manager (with the board connected to your computer) and search for connected USB devices. Under "General" you find the "Manufacturer". Now, edit the file to add the Silicon Labs manufacturer (or other) to the <code>autoconnect_comport_manufacturers</code><br><br>
section. Then, save the file. The section should look like this:<br>
</p></li>
</ul>
<div class="highlight js-code-highlight">
<pre class="highlight json"><code><span class="nl">"autoconnect_comport_manufacturers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
  </span><span class="s2">"Pycom"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"Pycom Ltd."</span><span class="p">,</span><span class="w">
  </span><span class="s2">"FTDI"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"Microsoft"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"Microchip Technology, Inc."</span><span class="p">,</span><span class="w">
  </span><span class="s2">"Silicon Labs"</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<ol>
<li>Connect your flashed ESP32 to your computer and hit the "Pymakr Console" button at the very bottom left of the VS Code window. Navigate to the Pymakr Console (similar to powershell in VS Code). You will get the MicroPython REPL indicated by <code>>>></code>.</li>
</ol>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--K7Sb6kHP--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/v1/./files/1.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--K7Sb6kHP--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/v1/./files/1.png" loading="lazy" width="" height=""></a>  </p>

<ol>
<li>You can now test the REPL promt by entering:
</li>
</ol>
<div class="highlight js-code-highlight">
<pre class="highlight python"><code><span class="k">print</span><span class="p">(</span><span class="s">'Hallo Studierende!'</span><span class="p">)</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<div class="highlight js-code-highlight">
<pre class="highlight python"><code><span class="mi">1</span><span class="o">+</span><span class="mi">2</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<ul>
<li>Your output should look like this:
</li>
</ul>
<div class="highlight js-code-highlight">
<pre class="highlight python"><code><span class="o">>>></span> <span class="k">print</span><span class="p">(</span><span class="s">'Hallo Studierende!'</span><span class="p">)</span>
<span class="n">Hallo</span> <span class="n">Studierende</span><span class="err">!</span>
<span class="o">>>></span> <span class="mi">1</span><span class="o">+</span><span class="mi">2</span>
<span class="mi">3</span>
<span class="o">>>></span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<ul>
<li>If it does, congratulations, you are using MicroPython on your ESP32 🎉🥳
&lt;!--- einfach reinkopieren z.B. von <a href="https://emojipedia.org/party-popper/">https://emojipedia.org/party-popper/</a> ---></li>
</ul>
<h3>
  <a name="for-a-warmup-try" href="#for-a-warmup-try">
  </a>
  For a Warm-Up try:
</h3>


<div class="highlight js-code-highlight">
<pre class="highlight python"><code><span class="o">>>></span> <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'data.txt'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
<span class="o">>>></span> <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'some data'</span><span class="p">)</span>
<span class="mi">9</span>
<span class="o">>>></span> <span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
<span class="o">>>></span> 
<span class="o">>>></span> <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'data.txt'</span><span class="p">)</span>
<span class="o">>>></span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
<span class="s">'some data'</span>
<span class="o">>>></span> <span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
<span class="o">>>></span> 
<span class="o">>>></span> <span class="kn">import</span> <span class="nn">os</span>
<span class="o">>>></span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">()</span>
<span class="p">[</span><span class="s">'boot.py'</span><span class="p">,</span> <span class="s">'main.py'</span><span class="p">,</span> <span class="s">'data.txt'</span><span class="p">]</span>
<span class="o">>>></span> 
<span class="o">>>></span> <span class="n">os</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s">'dir'</span><span class="p">)</span>
<span class="o">>>></span> 
<span class="o">>>></span> <span class="n">os</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="s">'data.txt'</span><span class="p">)</span>
<span class="o">>>></span> <span class="n">os</span><span class="p">.</span><span class="n">remoce</span><span class="p">(</span><span class="s">"dir"</span><span class="p">)</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<ul>
<li>There are two files that are treated specially by the ESP32 (and ESP8266) when it starts up: boot.py and main.py. The boot.py script is executed first (if it exists) and then once it is completed the main.py script is executed. You can create these files yourself and populate them with the code that you want to run when the device starts up.</li>
</ul>
<h3>
  <a name="repl-promt-tips" href="#repl-promt-tips">
  </a>
  REPL promt tips:
</h3>

<ul>
<li>Pressing ctrl-E will enter a special paste mode. This allows you to copy and paste a chunk of text into the REPL. If you press ctrl-E you will see the paste-mode prompt:
</li>
</ul>
<div class="highlight js-code-highlight">
<pre class="highlight python"><code><span class="n">paste</span> <span class="n">mode</span><span class="p">;</span> <span class="n">Ctrl</span><span class="o">-</span><span class="n">C</span> <span class="n">to</span> <span class="n">cancel</span><span class="p">,</span> <span class="n">Ctrl</span><span class="o">-</span><span class="n">D</span> <span class="n">to</span> <span class="n">finish</span>
<span class="o">===</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<ul>
<li><p>You can then paste (or type) your text in. Note that none of the special keys or commands work in paste mode (e.g. Tab or backspace), they are just accepted as-is. Press ctrl-D to finish entering the text and execute it.</p></li>
<li>
<p>There are four other control commands:</p>

<ul>
<li>Ctrl-A on a blank line will enter raw REPL mode. This is like a permanent paste mode, except that characters are not echoed back.</li>
<li>Ctrl-B on a blank like goes to normal REPL mode.</li>
<li>Ctrl-C cancels any input, or interrupts the currently running code.</li>
<li>Ctrl-D on a blank line will do a soft reset.</li>
</ul>
</li>
</ul>

<hr>
<h2>
  <a name="hints-and-pitfalls" href="#hints-and-pitfalls">
  </a>
  Hints and pitfalls
</h2>

<ul>
<li>Regarding pymakr.json: put your COMx in the address setting and set auto_correct to <code>False</code>.</li>
<li>Regarding pymakr.json: For automatic connect, let the address setting empty, and set the auto_connect to <code>True</code>. Play around with these settings if you encounter problems.</li>
<li>If you can't get the Pymakr Console after opening VS Code make sure your computer is not running on a battery saving mode or similar. Set it to high performance mode and open VS Code again.</li>
<li>If you cannot get the REPL promt indicated by <code>>>></code>, perform a keyboard interrupt or click the "Upload" or "Run" button at the very bottom of the VS Code window. Play around, that was sometimes necessary on my system.</li>
<li>If you cannot connect your ESP32, you can try it with TeraTerm or <code>picocom</code> on Linux. <a href="https://randomnerdtutorials.com/micropython-esp32-esp8266-vs-code-pymakr/#pymakr">Read here for a detailed tutorial</a>. Don not forget to set the baudrate to <code>115200</code>.</li>
</ul>

<hr>
<h2>
  <a name="useful-resources-for-own-searches" href="#useful-resources-for-own-searches">
  </a>
  Useful Resources for Own Searches
</h2>

<p><a href="https://randomnerdtutorials.com/micropython-esp32-esp8266-vs-code-pymakr/#pymakr">Click here for a <strong>detailed tutorial</strong> on how to install VS Code and the Pymakr extension</a>  </p>

<p><a href="https://docs.micropython.org/en/latest/esp8266/tutorial/index.html">Click here for a <strong>MicroPython tutorial</strong> for the ESP8266 (most of them also work on your ESP32)</a></p>
<h2>
  <a name="whats-next" href="#whats-next">
  </a>
  What's next
</h2>

<p>Setting up you Wifi connection and connect to a public test MQTT broker.</p>

<hr>
<h2>
  <a name="sources" href="#sources">
  </a>
  Source(s)
</h2>

<ul>
<li>Micropython API: <a href="https://docs.micropython.org/en/latest/index.html">https://docs.micropython.org/en/latest/index.html</a>
</li>
<li>Random nerd tutorials: <a href="https://randomnerdtutorials.com/micropython-esp32-esp8266-vs-code-pymakr/#pymakr">https://randomnerdtutorials.com/micropython-esp32-esp8266-vs-code-pymakr/#pymakr</a>
</li>
</ul>


<h1>
  <a name="lesson-3-wifi-and-mqtt-connection" href="#lesson-3-wifi-and-mqtt-connection">
  </a>
  Lesson 3: Wifi and MQTT Connection <a name="paragraph3"></a>
</h1>
<h2>
  <a name="objectives" href="#objectives">
  </a>
  Objectives
</h2>

<p>In this lesson you will set up a connection to your Wifi. Followed by connecting your ESP32 as a client to a public testing broker. Moreover we will subscribe to a topic and publish some data to get familiar with MQTT.</p>
<h2>
  <a name="prerequisites-and-required-equipment" href="#prerequisites-and-required-equipment">
  </a>
  Prerequisites and required Equipment
</h2>

<ul>
<li>ESP32 DevKitC</li>
<li>Computer</li>
<li>USB-Cable which allows data transfer</li>
<li>Visual Studio Code</li>
</ul>

<hr>
<h2>
  <a name="solution-steps" href="#solution-steps">
  </a>
  Solution Steps
</h2>

<ol>
<li>First, we will implement an automatic Wifi connection. This is done by writing the code into the <code>boot.py</code> file. Create a new file in the explorer (from VS Code on the left side of the window and name it <code>boot.py</code>). The code in this file will be executed automatically after every start of the module. (For testing purposes you can also first enter the code one by one into the REPL promt and see if your connection works.) To do so write the following lines (in the <code>boot.py</code>):
</li>
</ol>
<div class="highlight js-code-highlight">
<pre class="highlight python"><code><span class="kn">import</span> <span class="nn">network</span>

<span class="n">ssid</span> <span class="o">=</span> <span class="s">'Your SSID'</span>
<span class="n">password</span> <span class="o">=</span> <span class="s">'Your password'</span> 

<span class="n">station</span> <span class="o">=</span> <span class="n">network</span><span class="p">.</span><span class="n">WLAN</span><span class="p">(</span><span class="n">network</span><span class="p">.</span><span class="n">STA_IF</span><span class="p">)</span> <span class="c1"># creates station interface
</span>
<span class="n">station</span><span class="p">.</span><span class="n">active</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span> <span class="c1"># activates the interface
</span><span class="n">station</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="c1"># connects to wifi
</span>
<span class="k">while</span> <span class="n">station</span><span class="p">.</span><span class="n">isconnected</span><span class="p">()</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
  <span class="k">pass</span> <span class="c1"># waits till module is connected
</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Connection successful'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">station</span><span class="p">.</span><span class="n">ifconfig</span><span class="p">())</span> 
<span class="c1"># prints the interface's IP/netmask/gw/DNS addresses
</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<ul>
<li><p>Save the boot.py file and click the "Upload" button at the very bottom of the VS Code window. The whole project will be uploaded to your ESP32 and executed afterwards. If you just want to upload the boot.py file you can do that by clicking -> "All commands" -> "Upload current file only" (at the bottom of VS Code).</p></li>
<li>
<p>When executed successfully, your terminal should print something like:   <code>Connection successful<br>
('194.xxx.xxx.xxx', '254.xxx.xxx.xxx', '194.xxx.xxx.xxx', '194.xxx.xxx.xxx')</code>  </p>

<p>If that is the case, congratulations 🎉 you connected the ESP32 with your Wifi.   </p>

<p>Lets move on with MQTT:</p>
</li>
</ul>

<ol>
<li>
<p>Create a new file named <code>umqttsimple.py</code> and copy the umqttsimple library code into it. You can access the umqttsimple library code via the following link:</p>

<p><a href="https://raw.githubusercontent.com/RuiSantosdotme/ESP-MicroPython/master/code/MQTT/umqttsimple.py">https://raw.githubusercontent.com/RuiSantosdotme/ESP-MicroPython/master/code/MQTT/umqttsimple.py</a></p>

<p>Don't forget to save the file.</p>
</li>
<li><p>Moving on you will have to <strong>extend</strong> the <code>boot.py</code> by <strong>adding</strong> the following lines:<br>
</p></li>
</ol>
<div class="highlight js-code-highlight">
<pre class="highlight python"><code><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">umqttsimple</span> <span class="kn">import</span> <span class="n">MQTTClient</span>
<span class="kn">import</span> <span class="nn">ubinascii</span>
<span class="kn">import</span> <span class="nn">machine</span>
<span class="kn">import</span> <span class="nn">micropython</span>
<span class="kn">import</span> <span class="nn">esp</span>
<span class="kn">import</span> <span class="nn">esp32</span>          <span class="c1"># import all needed libraries
</span><span class="n">esp</span><span class="p">.</span><span class="n">osdebug</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>     <span class="c1"># debug set to none
</span><span class="kn">import</span> <span class="nn">gc</span>             <span class="c1"># garbage collector
</span><span class="n">gc</span><span class="p">.</span><span class="n">collect</span><span class="p">()</span>

<span class="n">mqtt_server</span> <span class="o">=</span> <span class="s">'YOUR MQTT BROKER'</span>
<span class="c1">#mqtt_server = "broker.emqx.io"     # works best for me
#mqtt_server = "broker.hivemq.com"
#mqtt_server = '3.65.154.195:1883'  #broker.hivemq.com
#mqtt_server = '5.196.95.208'       #test.mosquitto.org
</span>
<span class="n">client_id</span> <span class="o">=</span> <span class="n">ubinascii</span><span class="p">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">machine</span><span class="p">.</span><span class="n">unique_id</span><span class="p">())</span> <span class="c1"># gets ID
</span><span class="n">topic_sub</span> <span class="o">=</span> <span class="sa">b</span><span class="s">'OnBoard_Temp'</span> <span class="c1"># toppic name
</span>
<span class="n">last_message</span> <span class="o">=</span> <span class="mi">0</span> 
<span class="n">message_interval</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>             <span class="c1"># variables needed for improved timing
</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<ul>
<li>
<p>Don't forget to save.</p>

<ul>
<li>The <code>last_message</code> variable will hold the last time a message was sent. The <code>message_interval</code> is the time between each message sent. Here we are setting it to 5 seconds (this means a new message will be sent every 5 seconds). The <code>counter</code> variable is simply a counter to be added to the message.</li>
</ul>
</li>
</ul>

<ol>
<li>We will create the <code>main.py</code> now. To do so, copy the following code into it:
</li>
</ol>
<div class="highlight js-code-highlight">
<pre class="highlight python"><code><span class="c1"># Callback func handles what happens when message is received on a certain topic
</span><span class="k">def</span> <span class="nf">sub_cb</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
  <span class="k">print</span><span class="p">((</span><span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>

<span class="c1"># responsible for connecting to broker as well as to subscribe to a topic
</span><span class="k">def</span> <span class="nf">connect_and_subscribe</span><span class="p">():</span>
  <span class="k">global</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">mqtt_server</span><span class="p">,</span> <span class="n">topic_sub</span>
  <span class="n">client</span> <span class="o">=</span> <span class="n">MQTTClient</span><span class="p">(</span><span class="n">client_id</span><span class="p">,</span> <span class="n">mqtt_server</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">1883</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="sa">b</span><span class="s">"emqx"</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="sa">b</span><span class="s">"0815"</span><span class="p">)</span>

  <span class="n">client</span><span class="p">.</span><span class="n">set_callback</span><span class="p">(</span><span class="n">sub_cb</span><span class="p">)</span>
  <span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">()</span>
  <span class="n">client</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">topic_sub</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="s">'Connected to %s MQTT broker, subscribed to %s topic'</span> <span class="o">%</span> <span class="p">(</span><span class="n">mqtt_server</span><span class="p">,</span> <span class="n">topic_sub</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">client</span>

<span class="k">def</span> <span class="nf">restart_and_reconnect</span><span class="p">():</span>
  <span class="k">print</span><span class="p">(</span><span class="s">'Failed to connect to MQTT broker. Reconnecting...'</span><span class="p">)</span>
  <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
  <span class="n">machine</span><span class="p">.</span><span class="n">reset</span><span class="p">()</span>

<span class="k">try</span><span class="p">:</span>
  <span class="n">client</span> <span class="o">=</span> <span class="n">connect_and_subscribe</span><span class="p">()</span>
<span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
  <span class="n">restart_and_reconnect</span><span class="p">()</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">client</span><span class="p">.</span><span class="n">check_msg</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_message</span><span class="p">)</span> <span class="o">></span> <span class="n">message_interval</span><span class="p">:</span>
      <span class="n">tf</span> <span class="o">=</span> <span class="n">esp32</span><span class="p">.</span><span class="n">raw_temperature</span><span class="p">()</span>
      <span class="n">tc</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">tf</span><span class="o">-</span><span class="mf">32.0</span><span class="p">)</span><span class="o">/</span><span class="mf">1.8</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="sa">b</span><span class="s">'Message #%d'</span> <span class="o">%</span> <span class="p">(</span><span class="n">counter</span><span class="p">)</span> <span class="o">+</span> <span class="s">": Temperature: %s degree Celsius"</span> <span class="o">%</span> <span class="p">(</span><span class="n">tc</span><span class="p">)</span>
      <span class="n">client</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">topic_sub</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
      <span class="n">last_message</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
      <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">restart_and_reconnect</span><span class="p">()</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<ul>
<li><p>Don't forget to save.</p></li>
<li><p>We will receive and publish messages in the while loop. We use <code>try</code> and <code>except</code> statements to prevent the ESP from crashing in case something goes wrong.</p></li>
<li><p>Inside the <code>try</code> block we start by applying the <code>check_msg()</code> method on the client.</p></li>
<li><p>The <code>check_msg()</code> method checks whether a pending message from the server is available. It waits for a single incoming MQTT message and process it. The subscribed messages are delivered to the callback function we have defined earlier (the <code>sub_cb()</code> function). If there is not a pending message, it returns with <code>None</code>.</p></li>
<li><p>Then we add an if statement to check whether 5 seconds (<code>message_interval</code>) have passed since the last message was sent.</p></li>
<li><p>We prepare the data we want to send. In our case I have chosen the internal temperature (there is also an internal hall sensor). We format the data as we need it and put it in the <code>msg</code> variable.</p></li>
<li><p>To publish a message on a certain topic, you just need to apply the <code>publish()</code> method on the client and pass as arguments the topic and the message.</p></li>
<li><p>After sending the message, we update the last time a message was received by setting the <code>last_message</code> variable to the current time.<br>
Finally, we increase the <code>counter</code> variable in every loop.<br>
If something unexpected happens, we call the <code>restart_and_reconnect()</code> function.</p></li>
</ul>

<ol>
<li>Finally, we can upload the files to the ESP32 ("Upload" button at the bottom). Your device will execute the code automatically when the upload succeeds.</li>
</ol>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--UeZEoNbt--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/v1/./files/2.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--UeZEoNbt--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/v1/./files/2.png" loading="lazy" width="" height=""></a>  </p>

<ol>
<li>If your output looks like in the picture above, you are done with this lesson 🥳💃🏽🕺🏽</li>
</ol>

<blockquote>
<p>Question for you: What temperature is measured?</p>
</blockquote>

<hr>
<h2>
  <a name="hints-and-pitfalls" href="#hints-and-pitfalls">
  </a>
  Hints and pitfalls
</h2>

<ul>
<li><p>You may need to open the port 1883 in your firewall.</p></li>
<li><p>As you may have noticed, I am giving you a few options to play with regarding the <code>mqtt_server</code> variable. On my system the "broker.emqx.io" works best. Additionally I encountered that the <strong>IP address written in letters</strong> works "better" than written in numbers. </p></li>
<li><p>Connecting to a MQTT broker worked on my system after providing a <code>user</code> and <code>password</code> within the <code>MQTTClient()</code>. What you write in those variables is not crucial for now.</p></li>
<li><p>When your device will not connect, try to connect to test.mosquitto.org via the terminal. </p></li>
<li><p>When your device will not connect but connecting to test.mosquitto.org in the terminal(s) worked, you can try to make it work with Arduino first...</p></li>
</ul>

<hr>
<h2>
  <a name="useful-resources-for-own-searches" href="#useful-resources-for-own-searches">
  </a>
  Useful Resources for Own Searches
</h2>

<p><a href="https://boneskull.com/micropython-on-esp32-part-2/">Click here to <strong>get on the Good Foot with MicroPython on the ESP32</strong></a></p>

<p><a href="https://github.com/gloveboxes/ESP32-MicroPython-BME280-MQTT-Sample/blob/master/Micropython.md">Click here for <strong>another approach for streaming data from ESP32 using MicroPython and MQTT</strong> (umqtt.robust)</a></p>

<p><a href="https://stackoverflow.com/questions/26716279/how-to-test-the-mosquitto-server">Click here for <strong>testing mosquitto in the terminal(s)</strong></a>  </p>

<p><a href="https://www.emqx.com/en/blog/esp32-connects-to-the-free-public-mqtt-broker">Click here for a <strong>Arduino tutorial</strong></a></p>

<hr>
<h2>
  <a name="whats-next" href="#whats-next">
  </a>
  What's next
</h2>

<p>Encrypted connection to a MQTT broker.</p>

<hr>
<h2>
  <a name="further-inputs" href="#further-inputs">
  </a>
  Further Inputs
</h2>

<blockquote>
<p>Play around with the hall sensor data or maybe you have another external sensor you can connect to your ESP32.</p>

<p>For that check out the possibilities the ESP32 has to offer:</p>
</blockquote>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--XG3ThKeO--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/v1/./files/ESP32_Function_Block_Diagram.svg" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--XG3ThKeO--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/v1/./files/ESP32_Function_Block_Diagram.svg" loading="lazy" width="" height=""></a></p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--3BDFEXmp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://components101.com/sites/default/files/component_pin/ESP32-Pinout.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--3BDFEXmp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://components101.com/sites/default/files/component_pin/ESP32-Pinout.png" alt="DevKitC" loading="lazy" width="880" height="440"></a></p>

<hr>
<h2>
  <a name="sources" href="#sources">
  </a>
  Source(s)
</h2>

<ul>
<li><p>MicroPython Hackathon: <a href="https://micropython-iot-hackathon.readthedocs.io/en/latest/mqtt.html">https://micropython-iot-hackathon.readthedocs.io/en/latest/mqtt.html</a></p></li>
<li><p>Random nerd tutorials 2: <a href="https://randomnerdtutorials.com/micropython-mqtt-esp32-esp8266/">https://randomnerdtutorials.com/micropython-mqtt-esp32-esp8266/</a></p></li>
<li><p>Quick reference for the ESP32 - Micropython API: <a href="https://docs.micropython.org/en/latest/esp32/quickref.html#networking">https://docs.micropython.org/en/latest/esp32/quickref.html#networking</a></p></li>
</ul>


<h1>
  <a name="lesson-4-mqtt-and-tls" href="#lesson-4-mqtt-and-tls">
  </a>
  Lesson 4: MQTT and TLS <a name="paragraph4"></a>
</h1>
<h2>
  <a name="objectives" href="#objectives">
  </a>
  Objectives
</h2>

<p>In this final lesson you will establish a secured connection with a public test broker. MQTT provides security, but it is not enabled by default. MQTT has the option for Transport Layer Security (TLS) encryption, just as used with HTTPS. It is recommended using that for any system you put into production.<br>
MQTT also provides username/password authentication. Note that the password is transmitted in clear text. Thus, be sure to use TLS encryption if you are using authentication. In our case we already provided the authentication (unencrypted). Nevertheless, it was just to improve the system flow. Another popular way of authenticating is via certificates and can be used in addition to using user name and password authentication. <a href="http://www.steves-internet-guide.com/ssl-certificates-explained/">Refer to <strong>this</strong> explanation in order to learn more about TLS/SSL.</a>  </p>
<h2>
  <a name="prerequisites-and-required-equipment" href="#prerequisites-and-required-equipment">
  </a>
  Prerequisites and required Equipment
</h2>

<ul>
<li>ESP32 DevKitC</li>
<li>Computer</li>
<li>USB-Cable which allows data transfer</li>
<li>Visual Studio Code</li>
</ul>

<hr>
<h2>
  <a name="solution-steps" href="#solution-steps">
  </a>
  Solution Steps
</h2>

<ol>
<li><p>We first need to install OpenSSL in order to create our certificates and keys. Click <a href="https://github.com/openssl/openssl">here for GitHub</a> or <a href="https://slproweb.com/products/Win32OpenSSL.html">here for the exe</a>.</p></li>
<li><p>Create CA key pair: Navigate to the Windows start and search OpenSSL. Hit enter on "OpenSSL Command Promt". Make sure you run the following commands as administrator.<br>
</p></li>
</ol>
<div class="highlight js-code-highlight">
<pre class="highlight console"><code><span class="go">openssl genrsa -des3 -out ca.key 2048
</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<blockquote>
<p><strong>genrsa</strong>: generates a RSA private key<br><br>
<strong>des3</strong>: Using DES3 cipher for the key generation<br><br>
<strong>out</strong>: specifies the output file name (.key)<br><br>
<strong>2048</strong>: number of bits for the private key    </p>
</blockquote>

<ul>
<li>Your output should look like this:
</li>
</ul>
<div class="highlight js-code-highlight">
<pre class="highlight console"><code><span class="gp">C:\Users\schue></span>openssl genrsa <span class="nt">-des3</span> <span class="nt">-out</span> ca.key 2048
<span class="go">Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:

</span><span class="gp">C:\Users\schue></span><span class="w">
</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<ul>
<li><p>Enter any password. But remember it, we will need it in a moment again.</p></li>
<li><p>The pass phrase is used to protect the private key. The generated private file ca.key has both the private and public key.</p></li>
</ul>

<ol>
<li>Create CA certificate: Next we are creating a certificate for the CA, using the key pair created in the step before:
</li>
</ol>
<div class="highlight js-code-highlight">
<pre class="highlight console"><code><span class="go">openssl req -new -x509 -days 1826 -key ca.key -out ca.crt
</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<blockquote>
<p><strong>req</strong>: certificate request and certification utility<br><br>
<strong>new</strong>: generate new certificate, it will prompt user for several input fields<br><br>
<strong>x509</strong>: create a self signed certificate<br><br>
<strong>days</strong>: specify the number of days the certificate is valid<br><br>
<strong>key</strong>: key file with private key to be used for signing<br><br>
<strong>out</strong>: specifies the file name for the certificate (.crt)  </p>
</blockquote>

<ul>
<li>You should get something like this:
</li>
</ul>
<div class="highlight js-code-highlight">
<pre class="highlight console"><code><span class="gp">C:\Users\schue></span>openssl req <span class="nt">-new</span> <span class="nt">-x509</span> <span class="nt">-days</span> 3650 <span class="nt">-key</span> ca.key <span class="nt">-out</span> ca.crt
<span class="go">Enter pass phrase for ca.key:
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:DE
State or Province Name (full name) [Some-State]:Bavaria
Locality Name (eg, city) []:Munich
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Uni
Organizational Unit Name (eg, section) []:Master
Common Name (e.g. server FQDN or YOUR name) []:schue
Email Address []:.

</span><span class="gp">C:\Users\schue></span><span class="w">
</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<blockquote>
<p>As Common Name use your user name like "schue" in my case. </p>
</blockquote>

<ol>
<li> Create broker key pair: Next, we are creating a private key for the server with:
</li>
</ol>
<div class="highlight js-code-highlight">
<pre class="highlight console"><code><span class="go">openssl genrsa -out server.pem 2048
</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<blockquote>
<p><strong>genrsa</strong>: generate a RSA private key<br><br>
<strong>out</strong>: specifies the output file name (.pem)<br><br>
<strong>2048</strong>: number of bits for the private key  </p>
</blockquote>

<ol>
<li>Create certificate request from CA: That key needs to be certified, so we create a certificate request for it, and the certificate needs to be signed by the CA:
</li>
</ol>
<div class="highlight js-code-highlight">
<pre class="highlight console"><code><span class="go">openssl req -new -out server.csr -key server.pem
</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<blockquote>
<p><strong>req</strong>: certificate request and certification utility<br><br>
<strong>new</strong>: create new request file file<br><br>
<strong>out</strong>: file name for the certificate signing request (.csr)<br><br>
<strong>key</strong>: file name of the key to be certified  </p>
</blockquote>

<ul>
<li>Your output should look like this:
</li>
</ul>
<div class="highlight js-code-highlight">
<pre class="highlight console"><code><span class="gp">C:\Users\schue></span>openssl req <span class="nt">-new</span> <span class="nt">-out</span> server.csr <span class="nt">-key</span> server.pem
<span class="go">You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:DE
State or Province Name (full name) [Some-State]:Bavaria
Locality Name (eg, city) []:Munich
Organization Name (eg, company) [Internet Widgits Pty Ltd]:UniMuni
Organizational Unit Name (eg, section) []:EL
Common Name (e.g. server FQDN or YOUR name) []:schue
Email Address []:.

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:0815
An optional company name []:IT

</span><span class="gp">C:\Users\schue></span><span class="w">
</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<ol>
<li>Verify and sign the certificate request: The last step with OpenSSL is to sign the server request through the CA to get the broker certificate:
</li>
</ol>
<div class="highlight js-code-highlight">
<pre class="highlight console"><code><span class="go">openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out cert.der -days 360
</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<blockquote>
<p><strong>x509</strong>: certificate display and signing utility<br><br>
<strong>req</strong>: a certificate request is expected as input<br><br>
<strong>in</strong>: input file for the certificate<br><br>
<strong>CA</strong>: specifies the file to be signed<br><br>
<strong>CAkey</strong>: CA private key to sign the certificate with<br><br>
<strong>Cacreateserial</strong>: the serial number file gets created if it does not exist<br><br>
<strong>out</strong>: output file name<br><br>
<strong>days</strong>: how long the certificate shall be valid  </p>
</blockquote>

<ol>
<li>Convert your .pem file to .der file:
</li>
</ol>
<div class="highlight js-code-highlight">
<pre class="highlight console"><code><span class="go">openssl rsa -inform pem -in server.pem -outform der -out key.der
</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<ol>
<li>Finally move the created files to the ESP32: To do so get mpfshell:</li>
</ol>

<blockquote>
<p><a href="https://gist.github.com/hardye/657385210c5d613e69cb5ba95e8c57a7">Click here if the command below does not work.</a><br>
</p>


</blockquote>

<div class="highlight js-code-highlight">
<pre class="highlight console"><code><span class="go">pip3 install mpfshell
</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<ul>
<li>Make sure your device is not connected via a Pymakr console or anywhere else. Then enter (on Windows) (and insert YOUR port number):
</li>
</ul>

<div class="highlight js-code-highlight">
<pre class="highlight console"><code><span class="go">mpfshell -c "open COMx"
</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<ul>
<li>and on Linux:
</li>
</ul>

<div class="highlight js-code-highlight">
<pre class="highlight console"><code><span class="go">mpfshell -c "open ttyUSBx"
</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<ul>
<li>Now you can list the files on the device with:
</li>
</ul>

<div class="highlight js-code-highlight">
<pre class="highlight console"><code><span class="gp">mpfs></span><span class="w"> </span><span class="nb">ls</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<ul>
<li>To upload e.g. the local file <code>boot.py</code> to the device use:
</li>
</ul>

<div class="highlight js-code-highlight">
<pre class="highlight console"><code><span class="gp">mpfs></span><span class="w"> </span>put boot.py
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<ul>
<li>You need to navigate to the directory  (<code>cd</code>) which contains the <code>boot.py</code> first.</li>
</ul>

<blockquote>
<p><a href="https://github.com/wendlers/mpfshell">Get more mpf commands <strong>here</strong></a></p>
</blockquote>

<ol>
<li>Lastly, we can adjust our code to use the "secured" connection (we are still connectiong to a public test broker! But you get the main idea, in case you would like to implement a TLS connection to your own broker).
</li>
</ol>

<ul>
<li>
<strong>Add</strong> the following lines to your <code>boot.py</code>:
</li>
</ul>

<div class="highlight js-code-highlight">
<pre class="highlight python"><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'key.der'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">key_data</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'cert.der'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">cert_data</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<ul>
<li>
<strong>Change</strong> the <code>connect_and_subscribe()</code> in your <code>main.py</code>:
</li>
</ul>

<div class="highlight js-code-highlight">
<pre class="highlight python"><code><span class="k">def</span> <span class="nf">connect_and_subscribe</span><span class="p">():</span>
  <span class="k">global</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">mqtt_server</span><span class="p">,</span> <span class="n">topic_sub</span><span class="p">,</span> <span class="n">key_data</span><span class="p">,</span> <span class="n">cert_data</span>
  <span class="n">client</span> <span class="o">=</span> <span class="n">MQTTClient</span><span class="p">(</span><span class="n">client_id</span><span class="p">,</span> <span class="n">mqtt_server</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">8883</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="sa">b</span><span class="s">"emqx"</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="sa">b</span><span class="s">"0815"</span>
                      <span class="p">,</span> <span class="n">ssl</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ssl_params</span><span class="o">=</span><span class="p">{</span><span class="s">'key'</span><span class="p">:</span> <span class="n">key_data</span><span class="p">,</span> <span class="s">'cert'</span><span class="p">:</span> <span class="n">cert_data</span><span class="p">})</span>
  <span class="n">client</span><span class="p">.</span><span class="n">set_callback</span><span class="p">(</span><span class="n">sub_cb</span><span class="p">)</span>
  <span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">()</span>
  <span class="n">client</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">topic_sub</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="s">'Connected to %s MQTT broker, subscribed to %s topic'</span> <span class="o">%</span> <span class="p">(</span><span class="n">mqtt_server</span><span class="p">,</span> <span class="n">topic_sub</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">client</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<blockquote>
<p>My output:<br>
</p>
</blockquote>

<div class="highlight js-code-highlight">
<pre class="highlight console"><code><span class="go">Uploading project (main folder)...
Not safe booting, disabled in settings

Uploading to /...
Reading file status
No files to upload
Upload done, resetting board...
OKets Jun  8 2016 00:22:57

rst:0xc (SW_CPU_RESET),boot:0x13 (SPI_FAST_FLASH_BOOT)
configsip: 0, SPIWP:0xee
clk_drv:0x00,q_drv:0x00,d_drv:0x00,cs0_drv:0x00,hd_drv:0x00,wp_drv:0x00
mode:DIO, clock div:2
load:0x3fff0030,len:5656
load:0x40078000,len:12696
load:0x40080400,len:4292
entry 0x400806b0
Connection successful
('194.xxx.xxx.xxx', '254.xxx.xxx.xxx', '194.xxx.xxx.xxx', '194.xxx.xxx.xxx')
Connected to broker.emqx.io MQTT broker, subscribed to b'OnBoard_Temp' topic
</span><span class="gp">(b'OnBoard_Temp', b'Message #</span>0: Temperature: 40.0 degree Celsius<span class="s1">')
</span><span class="gp">(b'OnBoard_Temp', b'Message #</span><span class="s1">1: Temperature: 40.0 degree Celsius'</span><span class="o">)</span>
<span class="gp">(b'OnBoard_Temp', b'Message #</span>2: Temperature: 40.0 degree Celsius<span class="s1">')
</span><span class="gp">(b'OnBoard_Temp', b'Message #</span><span class="s1">3: Temperature: 40.0 degree Celsius'</span><span class="o">)</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<ul>
<li>Yeay, we are publishing our data over TLS.</li>
</ul>


<hr>

<h2>
  <a name="hints-and-pitfalls" href="#hints-and-pitfalls">
  </a>
  Hints and pitfalls
</h2>

<ul>
<li><p>You may need to open the port 8883 in your firewall.</p></li>
<li><p>You can move the cert files to your VS Code workspace and hit the upload button. But it will not upload the certificates to your device!</p></li>
<li><p>You can also use ampy to move files to the ESP32. This is the most common way online. Nevertheless, ampy did not work on my system.</p></li>
<li><p>Since my colleagues encountered problems with mpfshell and ampy on their systems, I am giving you a last option: You can use the uPyCraft IDE to transfer files to your ESP32. Installation instructions for: <a href="https://randomnerdtutorials.com/install-upycraft-ide-windows-pc-instructions/">Windows</a>, <a href="https://randomnerdtutorials.com/install-upycraft-ide-mac-os-x-instructions/">MacOS X</a> and <a href="https://randomnerdtutorials.com/install-upycraft-ide-linux-ubuntu-instructions/">Linux</a>.</p></li>
</ul>


<hr>

<h2>
  <a name="useful-resources-for-own-searches" href="#useful-resources-for-own-searches">
  </a>
  Useful Resources for Own Searches
</h2>

<p><a href="https://mcuoneclipse.com/2017/04/14/introduction-to-security-and-tls-transport-security-layer/">Click here for <strong>another introduction to TLS</strong></a></p>

<p><a href="https://github.com/gloveboxes/ESP32-MicroPython-BME280-MQTT-Sample/blob/master/Micropython.md">Click here for <strong>another approach for streaming data from ESP32 using MicroPython and MQTT</strong> (umqtt.robust)</a></p>

<p><a href="https://github.com/micropython/micropython-esp32/issues/90">ENOENT ERROR</a></p>


<hr>

<h2>
  <a name="further-inputs" href="#further-inputs">
  </a>
  Further Inputs
</h2>

<p>You can also encrypt your message before sending it. In our case it will not work. Can you find out why? It would work with a separate broker (with own code). Here are two useful links to begin with:<br>
<a href="https://forum.micropython.org/viewtopic.php?t=6726">https://forum.micropython.org/viewtopic.php?t=6726</a><br>
<a href="https://docs.micropython.org/en/latest/library/cryptolib.html">https://docs.micropython.org/en/latest/library/cryptolib.html</a></p>

<blockquote>
<p>Steve: "Encrypting the MQTT payload rather than the link has the advantage that the data is encrypted end to end and not just between the broker and the client.<br><br>
It also means that the intermediate brokers don’t need to support SSL and that you don’t need to obtain and install certificates."<br><br>
Unknown: "It is always a good idea to use further security mechanisms such as payload encryption, payload signature verifications, and authorization mechanisms. In general, more security never hurts."<br><br>
Do you agree?<br>
What do you think about these quotations?</p>
</blockquote>


<hr>

<p>Congratulations! You are at the end of my tutorial. Maybe you would like to set up your own broker on a Rpy next?</p>


<hr>

<h2>
  <a name="sources" href="#sources">
  </a>
  Source(s)
</h2>

<ul>
<li><p>Enable Secure Communication with TLS and the Mosquitto Broker: <a href="https://mcuoneclipse.com/2017/04/14/enable-secure-communication-with-tls-and-the-mosquitto-broker/">https://mcuoneclipse.com/2017/04/14/enable-secure-communication-with-tls-and-the-mosquitto-broker/</a></p></li>
<li><p>Mosquitto SSL Configuration: <a href="http://www.steves-internet-guide.com/mosquitto-tls/">http://www.steves-internet-guide.com/mosquitto-tls/</a></p></li>
<li><p>OpenSSL Command Line Utilities: <a href="https://wiki.openssl.org/index.php/Command_Line_Utilities">https://wiki.openssl.org/index.php/Command_Line_Utilities</a></p></li>
</ul>

</div></article> <div class="aside-username-wrapper" data-v-10d06ee8><aside class="aside-username-block" data-v-37984f8c data-v-10d06ee8><div class="username-heading loading" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-heading" data-v-37984f8c><div class="vue-content-placeholders-heading__img"></div> <div class="vue-content-placeholders-heading__content"><div class="vue-content-placeholders-heading__title"></div> <div class="vue-content-placeholders-heading__subtitle"></div></div></div></div></div> <div class="info" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-text" data-v-37984f8c><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div></div></div></div></aside></div></div> <div class="comments-block" data-v-8c4375bc data-v-10d06ee8><!----> <a href="https://dev.to/bassparanoya/esp32-micropython-mqtt-tls-28fd" target="_blank" rel="nofollow noopener noreferer" class="add-comment" data-v-8c4375bc>
    Add comment
  </a></div></div> <footer data-v-22cb8fd0><span data-v-22cb8fd0>Built with</span> <a href="https://nuxtjs.org" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="nuxt-icon" data-v-22cb8fd0 data-v-22cb8fd0><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a> <span data-v-22cb8fd0>&</span> <a href="https://docs.dev.to/api" rel="nofollow noopener" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-22cb8fd0 data-v-22cb8fd0><path d="M1.5726 5.13748C1.42945 5.20622 1.2411 5.36661 1.15822 5.48117C1 5.69503 1 5.74849 1 11.8739C1 17.9993 1 18.0528 1.15822 18.2667C1.2411 18.3812 1.42945 18.5416 1.5726 18.6104C1.8137 18.7402 2.46164 18.7478 12 18.7478C21.5384 18.7478 22.1863 18.7402 22.4274 18.6104C22.5706 18.5416 22.7589 18.3812 22.8418 18.2667C23 18.0528 23 17.9993 23 11.8739C23 5.74849 23 5.69503 22.8418 5.48117C22.7589 5.36661 22.5706 5.20622 22.4274 5.13748C22.1863 5.00764 21.5384 5 12 5C2.46164 5 1.8137 5.00764 1.5726 5.13748ZM7.7055 8.2613C8.0822 8.45989 8.59454 9.0098 8.77536 9.40694C8.89589 9.66664 8.91095 9.94922 8.91095 12.0649C8.91095 14.3104 8.90344 14.4478 8.75275 14.7839C8.51919 15.288 8.16506 15.6546 7.68288 15.899C7.26096 16.1052 7.22328 16.1128 5.7315 16.1358L4.20206 16.1663V12.1031V8.04744L5.80684 8.07035C7.27602 8.09327 7.42672 8.10854 7.7055 8.2613ZM13.6952 8.89521V9.73538H12.4521H11.2089V10.4991V11.2629H11.9623H12.7158V12.1031V12.9432H11.9623H11.2089V13.707V14.4708H12.4521H13.6952V15.3109V16.151H12C10.1315 16.151 10.0411 16.1358 9.67191 15.6928L9.47603 15.4484V12.1336C9.47603 8.46752 9.46851 8.49807 9.95069 8.20783C10.1692 8.07035 10.3425 8.05508 11.9473 8.05508H13.6952V8.89521ZM16.5658 10.3769C16.8897 11.6295 17.1685 12.6912 17.176 12.7293C17.1911 12.7675 17.4699 11.7441 17.8014 10.461C18.1254 9.17017 18.4343 8.1009 18.4795 8.08563C18.5247 8.06271 18.9541 8.06271 19.4288 8.07035L20.3028 8.09327L19.376 11.6219C18.8713 13.5542 18.4117 15.2269 18.3664 15.3261C18.0123 16.0135 17.274 16.3343 16.7164 16.0441C16.4528 15.899 16.0911 15.4865 15.9705 15.1887C15.9254 15.0665 15.4884 13.4549 15.0062 11.6142C14.524 9.76593 14.1171 8.20783 14.0945 8.15437C14.0644 8.07035 14.2301 8.05508 15.0212 8.07035L15.9856 8.09327L16.5658 10.3769Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M5.93491 12.103V14.4707H6.27394C6.66574 14.4707 7.01983 14.3103 7.1404 14.0965C7.18559 14.0048 7.21575 13.2105 7.21575 12.0648V10.1783L6.99725 9.95683C6.80133 9.76591 6.71847 9.73535 6.35683 9.73535H5.93491V12.103Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a></footer></div></div></div><script>window.__NUXT__=function(n,e,s,t,a){return s.type_of="article",s.id=957505,s.title="ESP32 MicroPython MQTT TLS",s.description="Implementation of an encrypted MQTT connection with MicroPython on a ESP32            Table...",s.readable_publish_date="Jan 16",s.slug="esp32-micropython-mqtt-tls-28fd",s.path="/bassparanoya/esp32-micropython-mqtt-tls-28fd",s.url=t,s.comments_count=0,s.public_reactions_count=9,s.collection_id=n,s.published_timestamp=e,s.positive_reactions_count=9,s.cover_image=n,s.social_image="https://dev.to/social_previews/article/957505.png",s.canonical_url=t,s.created_at=e,s.edited_at="2022-01-17T15:49:46Z",s.crossposted_at=n,s.published_at=e,s.last_comment_at=e,s.reading_time_minutes=18,s.tag_list="micropython, mqtt, esp32",s.tags=["micropython","mqtt","esp32"],s.body_html='<h1>\n  <a name="implementation-of-an-encrypted-mqtt-connection-with-micropython-on-a-esp32" href="#implementation-of-an-encrypted-mqtt-connection-with-micropython-on-a-esp32">\n  </a>\n  <h1 id="3">Implementation of an encrypted MQTT connection with MicroPython on a ESP32</h1>\n</h1>\n\n<h1>\n  <a name="table-of-contents" href="#table-of-contents">\n  </a>\n  Table of Contents\n</h1>\n\n<ol>\n<li>\n<a href="#paragraph0">Introduction: ESP32 MicroPython MQTT TLS</a>\n</li>\n<li><a href="#paragraph1">Installing MicroPython</a></li>\n<li><a href="#paragraph2">Using MicroPython</a></li>\n<li><a href="#paragraph3">Wifi and MQTT Connection</a></li>\n<li><a href="#paragraph4">MQTT and TLS</a></li>\n</ol>\n\n<h1>\n  <a name="introduction-esp32-micropython-mqtt-tls" href="#introduction-esp32-micropython-mqtt-tls">\n  </a>\n  Introduction: ESP32 MicroPython MQTT TLS <a name="paragraph0"></a>\n</h1>\n\n<p>by: Bass Paranoya</p>\n\n\n<hr>\n\n<h2>\n  <a name="overview" href="#overview">\n  </a>\n  Overview\n</h2>\n\n<p>In this tutorial you will learn how to program the ESP32 using MicroPython. At first we will connect the device to the Internet via WIFI. Furthermore we will use this knowledge to implement a MQTT connection to send internal sensor data. In the last steps we will discuss data security and use it to authenticate and encrypt our MQTT connection over TLS. </p>\n\n<h2>\n  <a name="prerequisites-and-required-equipment" href="#prerequisites-and-required-equipment">\n  </a>\n  Prerequisites and required Equipment\n</h2>\n\n<ul>\n<li>Computer</li>\n<li>Visual Studio Code</li>\n<li>ESP32 DevKitC</li>\n<li>USB-Cable which allows to transfer data </li>\n</ul>\n\n<blockquote>\n<p>The tutorial was made on a Windows system. Nevertheless, I will also present the commands for Ubuntu. If you use a Mac or another system you\'ll find the necessary commands most of the time in the presented external links (APIs) at the end of each lesson under "Hints and pitfalls", "Useful Resources for Own Searches" and "Sources"). I recommend to use Visual Studio Code.</p>\n</blockquote>\n\n\n<hr>\n\n<h1>\n  <a name="lesson-1-installing-micropython" href="#lesson-1-installing-micropython">\n  </a>\n  Lesson 1: Installing MicroPython <a name="paragraph1"></a>\n</h1>\n\n<h2>\n  <a name="objectives" href="#objectives">\n  </a>\n  Objectives\n</h2>\n\n<p>Our first lesson will be flashing the ESP32 with MicroPython.</p>\n\n<h2>\n  <a name="prerequisites-and-required-equipment" href="#prerequisites-and-required-equipment">\n  </a>\n  Prerequisites and required Equipment\n</h2>\n\n<ul>\n<li>ESP32 DevKitC</li>\n<li>USB-Cable which allows to transfer data </li>\n<li>Computer </li>\n</ul>\n\n\n<hr>\n\n<h2>\n  <a name="solution-steps" href="#solution-steps">\n  </a>\n  Solution Steps\n</h2>\n\n<ol>\n<li><p>Download the latest MicroPython firmware:<br><br>\n<a href="https://micropython.org/download/esp32/">Click <strong>here</strong> for downloading the latest .bin file</a> (e.g.:  v1.17 (2021-09-02) .bin) </p></li>\n<li><p>Connect the ESP32 with the USB cable to your computer. </p></li>\n<li><p>Install the esptool extension using <code>pip</code> in a terminal or the powershell in VS Code:  </p></li>\n</ol>\n\n<blockquote>\n<p><a href="https://pip.pypa.io/en/stable/installation/">Click <strong>here</strong> if you have not installed pip.</a><br>\n</p>\n</blockquote>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight console"><code><span class="go">pip install esptool\n</span></code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<ul>\n<li>alternatively you can use <a href="https://github.com/espressif/esptool/">this <strong>GitHub Link</strong></a>.</li>\n</ul>\n\n<blockquote>\n<p>You need to look up the port used for the ESP32 in the Device Manager. Adjust the COMx for your command in the next step.<br><br>\nIf the ESP32 does not connect to any port, the chance is high that your USB cable is not suitable for exchanging data (it is a power supply only). Use a suitable one instead. </p>\n</blockquote>\n\n<ol>\n<li>Erase the flash under Windows with:\n</li>\n</ol>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight console"><code><span class="go">python -m esptool --port COMx erase_flash \n</span></code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<ul>\n<li>Or on Linux\n</li>\n</ul>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight console"><code><span class="go">esptool.py --port /dev/ttyUSBx erase_flash\n</span></code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<ul>\n<li>If the command output says something similar to "no permission", then it is likely the ESP32 is connected somewhere else. Disconnect it.</li>\n</ul>\n\n<ol>\n<li>Next we will deploy the new firmware with this example command on Windows which worked best on my system (use your port and path):\n</li>\n</ol>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight console"><code><span class="go">python -m esptool --chip esp32 --port COMx write_flash -z 0x1000 C:\\path_to_firmware\\esp32-20210902-v1.17.bin \n</span></code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<ul>\n<li>If you use Linux:\n</li>\n</ul>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight console"><code><span class="go">esptool.py --chip esp32 --port /dev/ttyUSBx write_flash -z 0x1000 esp32-20180511-v1.9.4.bin\n</span></code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<ol>\n<li>If the above commands run without error then MicroPython should be installed on your board.\n</li>\n</ol>\n\n\n<hr>\n\n<h2>\n  <a name="hints-and-pitfalls" href="#hints-and-pitfalls">\n  </a>\n  Hints and pitfalls\n</h2>\n\n<ul>\n<li>You may need to reduce the baudrate if you get errors while flashing (e.g. down to 115200 by adding <code>--baud 115200</code> into the command) or (<code>-b 9600</code> is a very slow value that you can use to verify it is not a baud rate problem)</li>\n<li>For some boards with a particular FlashROM configuration you may need to change the flash mode (e.g. by adding <code>-fm dio</code> into the command)</li>\n<li>Check if you have permissions to access the serial port, and if other software (such as modem-manager on Linux) is trying to interact with it. A common pitfall is leaving a serial terminal accessing this port open in another window and forgetting about it.</li>\n<li>for more tips check out the following links:</li>\n</ul>\n\n\n<hr>\n\n<h2>\n  <a name="useful-resources-for-own-searches" href="#useful-resources-for-own-searches">\n  </a>\n  Useful Resources for Own Searches\n</h2>\n\n<p><a href="https://docs.micropython.org/en/latest/esp32/tutorial/intro.html">Click here for the <strong>Getting Started with MicroPython on the ESP32</strong> from the MicroPython API</a><br><br>\n<a href="https://docs.espressif.com/projects/esptool/en/latest/esp32/installation.html">Click here for the <strong>Installation and Dependencies</strong> tutorial from ESPRESSIF</a><br><br>\n<a href="https://docs.espressif.com/projects/esptool/en/latest/esp32/troubleshooting.html#troubleshooting">Check out the <strong>Troubleshooting</strong> from ESPRESSIF if you still get Errors</a></p>\n\n<hr>\n<h2>\n  <a name="whats-next" href="#whats-next">\n  </a>\n  What\'s next\n</h2>\n\n<p>Using MicroPython</p>\n\n<hr>\n<h2>\n  <a name="sources" href="#sources">\n  </a>\n  Source(s)\n</h2>\n\n<ul>\n<li>Micropython API for ESP32 Boards: <a href="https://docs.micropython.org/en/latest/esp32/quickref.html">https://docs.micropython.org/en/latest/esp32/quickref.html</a>\n</li>\n<li>ESPRESSIF documentation: <a href="https://docs.espressif.com/projects/esptool/en/latest/esp32/index.html#">https://docs.espressif.com/projects/esptool/en/latest/esp32/index.html#</a>\n</li>\n</ul>\n\n\n<h1>\n  <a name="lesson-2-using-micropython" href="#lesson-2-using-micropython">\n  </a>\n  Lesson 2: Using MicroPython <a name="paragraph2"></a>\n</h1>\n<h2>\n  <a name="objectives" href="#objectives">\n  </a>\n  Objectives\n</h2>\n\n<p>Next, we will get a REPL promt in which we can use MicroPython on the ESP32.</p>\n<h2>\n  <a name="prerequisites-and-required-equipment" href="#prerequisites-and-required-equipment">\n  </a>\n  Prerequisites and required Equipment\n</h2>\n\n<ul>\n<li>ESP32 DevKitC</li>\n<li>Computer</li>\n<li>USB-Cable which allows data transfer </li>\n<li>Visual Studio Code</li>\n</ul>\n\n<hr>\n<h2>\n  <a name="solution-steps" href="#solution-steps">\n  </a>\n  Solution Steps\n</h2>\n\n<ol>\n<li><p>In order to use Pymakr extension on VS Code, you need node.js installed on your computer. <a href="https://nodejs.org/en/download/">Use this link to get to the download page.</a> </p></li>\n<li><p>Open Visual Studio Code and install the Pymakr Extension (ID: pycom.pymakr)</p></li>\n<li><p>If you have any trouble, <a href="https://randomnerdtutorials.com/micropython-esp32-esp8266-vs-code-pymakr/#pymakr">here is a detailed manual</a> (at the top of the page you can also follow the manual for installing VS Code)</p></li>\n<li><p>Edit the pymakr.json file which opens automatically after installing Pymakr, in case it did not: Hit the "ALL commands" button at the very bottom of the VS Code window and click on "Global Setting".</p></li>\n</ol>\n\n<ul>\n<li><p>Pymakr has a list of USB devices it will connect to. You need to make sure that your device is on the list in the pymakr.json configuration file. You need to add the USB Manufacturer that the device uses to connect to the PC. In our case, the ESP32 uses the "Silicon Labs" USB drivers.</p></li>\n<li><p>To find out which drivers your board uses, open your computer’s Device Manager (with the board connected to your computer) and search for connected USB devices. Under "General" you find the "Manufacturer". Now, edit the file to add the Silicon Labs manufacturer (or other) to the <code>autoconnect_comport_manufacturers</code><br><br>\nsection. Then, save the file. The section should look like this:<br>\n</p></li>\n</ul>\n<div class="highlight js-code-highlight">\n<pre class="highlight json"><code><span class="nl">"autoconnect_comport_manufacturers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">\n  </span><span class="s2">"Pycom"</span><span class="p">,</span><span class="w">\n  </span><span class="s2">"Pycom Ltd."</span><span class="p">,</span><span class="w">\n  </span><span class="s2">"FTDI"</span><span class="p">,</span><span class="w">\n  </span><span class="s2">"Microsoft"</span><span class="p">,</span><span class="w">\n  </span><span class="s2">"Microchip Technology, Inc."</span><span class="p">,</span><span class="w">\n  </span><span class="s2">"Silicon Labs"</span><span class="w">\n</span><span class="p">]</span><span class="w">\n</span></code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<ol>\n<li>Connect your flashed ESP32 to your computer and hit the "Pymakr Console" button at the very bottom left of the VS Code window. Navigate to the Pymakr Console (similar to powershell in VS Code). You will get the MicroPython REPL indicated by <code>&gt;&gt;&gt;</code>.</li>\n</ol>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--K7Sb6kHP--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/v1/./files/1.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--K7Sb6kHP--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/v1/./files/1.png" loading="lazy" width="" height=""></a>  </p>\n\n<ol>\n<li>You can now test the REPL promt by entering:\n</li>\n</ol>\n<div class="highlight js-code-highlight">\n<pre class="highlight python"><code><span class="k">print</span><span class="p">(</span><span class="s">\'Hallo Studierende!\'</span><span class="p">)</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<div class="highlight js-code-highlight">\n<pre class="highlight python"><code><span class="mi">1</span><span class="o">+</span><span class="mi">2</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<ul>\n<li>Your output should look like this:\n</li>\n</ul>\n<div class="highlight js-code-highlight">\n<pre class="highlight python"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="s">\'Hallo Studierende!\'</span><span class="p">)</span>\n<span class="n">Hallo</span> <span class="n">Studierende</span><span class="err">!</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">+</span><span class="mi">2</span>\n<span class="mi">3</span>\n<span class="o">&gt;&gt;&gt;</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<ul>\n<li>If it does, congratulations, you are using MicroPython on your ESP32 🎉🥳\n&lt;!--- einfach reinkopieren z.B. von <a href="https://emojipedia.org/party-popper/">https://emojipedia.org/party-popper/</a> ---&gt;</li>\n</ul>\n<h3>\n  <a name="for-a-warmup-try" href="#for-a-warmup-try">\n  </a>\n  For a Warm-Up try:\n</h3>\n\n\n<div class="highlight js-code-highlight">\n<pre class="highlight python"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">\'data.txt\'</span><span class="p">,</span> <span class="s">\'w\'</span><span class="p">)</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">\'some data\'</span><span class="p">)</span>\n<span class="mi">9</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>\n<span class="o">&gt;&gt;&gt;</span> \n<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">\'data.txt\'</span><span class="p">)</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>\n<span class="s">\'some data\'</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>\n<span class="o">&gt;&gt;&gt;</span> \n<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">os</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">()</span>\n<span class="p">[</span><span class="s">\'boot.py\'</span><span class="p">,</span> <span class="s">\'main.py\'</span><span class="p">,</span> <span class="s">\'data.txt\'</span><span class="p">]</span>\n<span class="o">&gt;&gt;&gt;</span> \n<span class="o">&gt;&gt;&gt;</span> <span class="n">os</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s">\'dir\'</span><span class="p">)</span>\n<span class="o">&gt;&gt;&gt;</span> \n<span class="o">&gt;&gt;&gt;</span> <span class="n">os</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="s">\'data.txt\'</span><span class="p">)</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="n">os</span><span class="p">.</span><span class="n">remoce</span><span class="p">(</span><span class="s">"dir"</span><span class="p">)</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<ul>\n<li>There are two files that are treated specially by the ESP32 (and ESP8266) when it starts up: boot.py and main.py. The boot.py script is executed first (if it exists) and then once it is completed the main.py script is executed. You can create these files yourself and populate them with the code that you want to run when the device starts up.</li>\n</ul>\n<h3>\n  <a name="repl-promt-tips" href="#repl-promt-tips">\n  </a>\n  REPL promt tips:\n</h3>\n\n<ul>\n<li>Pressing ctrl-E will enter a special paste mode. This allows you to copy and paste a chunk of text into the REPL. If you press ctrl-E you will see the paste-mode prompt:\n</li>\n</ul>\n<div class="highlight js-code-highlight">\n<pre class="highlight python"><code><span class="n">paste</span> <span class="n">mode</span><span class="p">;</span> <span class="n">Ctrl</span><span class="o">-</span><span class="n">C</span> <span class="n">to</span> <span class="n">cancel</span><span class="p">,</span> <span class="n">Ctrl</span><span class="o">-</span><span class="n">D</span> <span class="n">to</span> <span class="n">finish</span>\n<span class="o">===</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<ul>\n<li><p>You can then paste (or type) your text in. Note that none of the special keys or commands work in paste mode (e.g. Tab or backspace), they are just accepted as-is. Press ctrl-D to finish entering the text and execute it.</p></li>\n<li>\n<p>There are four other control commands:</p>\n\n<ul>\n<li>Ctrl-A on a blank line will enter raw REPL mode. This is like a permanent paste mode, except that characters are not echoed back.</li>\n<li>Ctrl-B on a blank like goes to normal REPL mode.</li>\n<li>Ctrl-C cancels any input, or interrupts the currently running code.</li>\n<li>Ctrl-D on a blank line will do a soft reset.</li>\n</ul>\n</li>\n</ul>\n\n<hr>\n<h2>\n  <a name="hints-and-pitfalls" href="#hints-and-pitfalls">\n  </a>\n  Hints and pitfalls\n</h2>\n\n<ul>\n<li>Regarding pymakr.json: put your COMx in the address setting and set auto_correct to <code>False</code>.</li>\n<li>Regarding pymakr.json: For automatic connect, let the address setting empty, and set the auto_connect to <code>True</code>. Play around with these settings if you encounter problems.</li>\n<li>If you can\'t get the Pymakr Console after opening VS Code make sure your computer is not running on a battery saving mode or similar. Set it to high performance mode and open VS Code again.</li>\n<li>If you cannot get the REPL promt indicated by <code>&gt;&gt;&gt;</code>, perform a keyboard interrupt or click the "Upload" or "Run" button at the very bottom of the VS Code window. Play around, that was sometimes necessary on my system.</li>\n<li>If you cannot connect your ESP32, you can try it with TeraTerm or <code>picocom</code> on Linux. <a href="https://randomnerdtutorials.com/micropython-esp32-esp8266-vs-code-pymakr/#pymakr">Read here for a detailed tutorial</a>. Don not forget to set the baudrate to <code>115200</code>.</li>\n</ul>\n\n<hr>\n<h2>\n  <a name="useful-resources-for-own-searches" href="#useful-resources-for-own-searches">\n  </a>\n  Useful Resources for Own Searches\n</h2>\n\n<p><a href="https://randomnerdtutorials.com/micropython-esp32-esp8266-vs-code-pymakr/#pymakr">Click here for a <strong>detailed tutorial</strong> on how to install VS Code and the Pymakr extension</a>  </p>\n\n<p><a href="https://docs.micropython.org/en/latest/esp8266/tutorial/index.html">Click here for a <strong>MicroPython tutorial</strong> for the ESP8266 (most of them also work on your ESP32)</a></p>\n<h2>\n  <a name="whats-next" href="#whats-next">\n  </a>\n  What\'s next\n</h2>\n\n<p>Setting up you Wifi connection and connect to a public test MQTT broker.</p>\n\n<hr>\n<h2>\n  <a name="sources" href="#sources">\n  </a>\n  Source(s)\n</h2>\n\n<ul>\n<li>Micropython API: <a href="https://docs.micropython.org/en/latest/index.html">https://docs.micropython.org/en/latest/index.html</a>\n</li>\n<li>Random nerd tutorials: <a href="https://randomnerdtutorials.com/micropython-esp32-esp8266-vs-code-pymakr/#pymakr">https://randomnerdtutorials.com/micropython-esp32-esp8266-vs-code-pymakr/#pymakr</a>\n</li>\n</ul>\n\n\n<h1>\n  <a name="lesson-3-wifi-and-mqtt-connection" href="#lesson-3-wifi-and-mqtt-connection">\n  </a>\n  Lesson 3: Wifi and MQTT Connection <a name="paragraph3"></a>\n</h1>\n<h2>\n  <a name="objectives" href="#objectives">\n  </a>\n  Objectives\n</h2>\n\n<p>In this lesson you will set up a connection to your Wifi. Followed by connecting your ESP32 as a client to a public testing broker. Moreover we will subscribe to a topic and publish some data to get familiar with MQTT.</p>\n<h2>\n  <a name="prerequisites-and-required-equipment" href="#prerequisites-and-required-equipment">\n  </a>\n  Prerequisites and required Equipment\n</h2>\n\n<ul>\n<li>ESP32 DevKitC</li>\n<li>Computer</li>\n<li>USB-Cable which allows data transfer</li>\n<li>Visual Studio Code</li>\n</ul>\n\n<hr>\n<h2>\n  <a name="solution-steps" href="#solution-steps">\n  </a>\n  Solution Steps\n</h2>\n\n<ol>\n<li>First, we will implement an automatic Wifi connection. This is done by writing the code into the <code>boot.py</code> file. Create a new file in the explorer (from VS Code on the left side of the window and name it <code>boot.py</code>). The code in this file will be executed automatically after every start of the module. (For testing purposes you can also first enter the code one by one into the REPL promt and see if your connection works.) To do so write the following lines (in the <code>boot.py</code>):\n</li>\n</ol>\n<div class="highlight js-code-highlight">\n<pre class="highlight python"><code><span class="kn">import</span> <span class="nn">network</span>\n\n<span class="n">ssid</span> <span class="o">=</span> <span class="s">\'Your SSID\'</span>\n<span class="n">password</span> <span class="o">=</span> <span class="s">\'Your password\'</span> \n\n<span class="n">station</span> <span class="o">=</span> <span class="n">network</span><span class="p">.</span><span class="n">WLAN</span><span class="p">(</span><span class="n">network</span><span class="p">.</span><span class="n">STA_IF</span><span class="p">)</span> <span class="c1"># creates station interface\n</span>\n<span class="n">station</span><span class="p">.</span><span class="n">active</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span> <span class="c1"># activates the interface\n</span><span class="n">station</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="c1"># connects to wifi\n</span>\n<span class="k">while</span> <span class="n">station</span><span class="p">.</span><span class="n">isconnected</span><span class="p">()</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>\n  <span class="k">pass</span> <span class="c1"># waits till module is connected\n</span>\n<span class="k">print</span><span class="p">(</span><span class="s">\'Connection successful\'</span><span class="p">)</span>\n<span class="k">print</span><span class="p">(</span><span class="n">station</span><span class="p">.</span><span class="n">ifconfig</span><span class="p">())</span> \n<span class="c1"># prints the interface\'s IP/netmask/gw/DNS addresses\n</span></code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<ul>\n<li><p>Save the boot.py file and click the "Upload" button at the very bottom of the VS Code window. The whole project will be uploaded to your ESP32 and executed afterwards. If you just want to upload the boot.py file you can do that by clicking -&gt; "All commands" -&gt; "Upload current file only" (at the bottom of VS Code).</p></li>\n<li>\n<p>When executed successfully, your terminal should print something like:   <code>Connection successful<br>\n(\'194.xxx.xxx.xxx\', \'254.xxx.xxx.xxx\', \'194.xxx.xxx.xxx\', \'194.xxx.xxx.xxx\')</code>  </p>\n\n<p>If that is the case, congratulations 🎉 you connected the ESP32 with your Wifi.   </p>\n\n<p>Lets move on with MQTT:</p>\n</li>\n</ul>\n\n<ol>\n<li>\n<p>Create a new file named <code>umqttsimple.py</code> and copy the umqttsimple library code into it. You can access the umqttsimple library code via the following link:</p>\n\n<p><a href="https://raw.githubusercontent.com/RuiSantosdotme/ESP-MicroPython/master/code/MQTT/umqttsimple.py">https://raw.githubusercontent.com/RuiSantosdotme/ESP-MicroPython/master/code/MQTT/umqttsimple.py</a></p>\n\n<p>Don\'t forget to save the file.</p>\n</li>\n<li><p>Moving on you will have to <strong>extend</strong> the <code>boot.py</code> by <strong>adding</strong> the following lines:<br>\n</p></li>\n</ol>\n<div class="highlight js-code-highlight">\n<pre class="highlight python"><code><span class="kn">import</span> <span class="nn">time</span>\n<span class="kn">from</span> <span class="nn">umqttsimple</span> <span class="kn">import</span> <span class="n">MQTTClient</span>\n<span class="kn">import</span> <span class="nn">ubinascii</span>\n<span class="kn">import</span> <span class="nn">machine</span>\n<span class="kn">import</span> <span class="nn">micropython</span>\n<span class="kn">import</span> <span class="nn">esp</span>\n<span class="kn">import</span> <span class="nn">esp32</span>          <span class="c1"># import all needed libraries\n</span><span class="n">esp</span><span class="p">.</span><span class="n">osdebug</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>     <span class="c1"># debug set to none\n</span><span class="kn">import</span> <span class="nn">gc</span>             <span class="c1"># garbage collector\n</span><span class="n">gc</span><span class="p">.</span><span class="n">collect</span><span class="p">()</span>\n\n<span class="n">mqtt_server</span> <span class="o">=</span> <span class="s">\'YOUR MQTT BROKER\'</span>\n<span class="c1">#mqtt_server = "broker.emqx.io"     # works best for me\n#mqtt_server = "broker.hivemq.com"\n#mqtt_server = \'3.65.154.195:1883\'  #broker.hivemq.com\n#mqtt_server = \'5.196.95.208\'       #test.mosquitto.org\n</span>\n<span class="n">client_id</span> <span class="o">=</span> <span class="n">ubinascii</span><span class="p">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">machine</span><span class="p">.</span><span class="n">unique_id</span><span class="p">())</span> <span class="c1"># gets ID\n</span><span class="n">topic_sub</span> <span class="o">=</span> <span class="sa">b</span><span class="s">\'OnBoard_Temp\'</span> <span class="c1"># toppic name\n</span>\n<span class="n">last_message</span> <span class="o">=</span> <span class="mi">0</span> \n<span class="n">message_interval</span> <span class="o">=</span> <span class="mi">5</span>\n<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>             <span class="c1"># variables needed for improved timing\n</span></code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<ul>\n<li>\n<p>Don\'t forget to save.</p>\n\n<ul>\n<li>The <code>last_message</code> variable will hold the last time a message was sent. The <code>message_interval</code> is the time between each message sent. Here we are setting it to 5 seconds (this means a new message will be sent every 5 seconds). The <code>counter</code> variable is simply a counter to be added to the message.</li>\n</ul>\n</li>\n</ul>\n\n<ol>\n<li>We will create the <code>main.py</code> now. To do so, copy the following code into it:\n</li>\n</ol>\n<div class="highlight js-code-highlight">\n<pre class="highlight python"><code><span class="c1"># Callback func handles what happens when message is received on a certain topic\n</span><span class="k">def</span> <span class="nf">sub_cb</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>\n  <span class="k">print</span><span class="p">((</span><span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>\n\n<span class="c1"># responsible for connecting to broker as well as to subscribe to a topic\n</span><span class="k">def</span> <span class="nf">connect_and_subscribe</span><span class="p">():</span>\n  <span class="k">global</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">mqtt_server</span><span class="p">,</span> <span class="n">topic_sub</span>\n  <span class="n">client</span> <span class="o">=</span> <span class="n">MQTTClient</span><span class="p">(</span><span class="n">client_id</span><span class="p">,</span> <span class="n">mqtt_server</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">1883</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="sa">b</span><span class="s">"emqx"</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="sa">b</span><span class="s">"0815"</span><span class="p">)</span>\n\n  <span class="n">client</span><span class="p">.</span><span class="n">set_callback</span><span class="p">(</span><span class="n">sub_cb</span><span class="p">)</span>\n  <span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">()</span>\n  <span class="n">client</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">topic_sub</span><span class="p">)</span>\n  <span class="k">print</span><span class="p">(</span><span class="s">\'Connected to %s MQTT broker, subscribed to %s topic\'</span> <span class="o">%</span> <span class="p">(</span><span class="n">mqtt_server</span><span class="p">,</span> <span class="n">topic_sub</span><span class="p">))</span>\n  <span class="k">return</span> <span class="n">client</span>\n\n<span class="k">def</span> <span class="nf">restart_and_reconnect</span><span class="p">():</span>\n  <span class="k">print</span><span class="p">(</span><span class="s">\'Failed to connect to MQTT broker. Reconnecting...\'</span><span class="p">)</span>\n  <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>\n  <span class="n">machine</span><span class="p">.</span><span class="n">reset</span><span class="p">()</span>\n\n<span class="k">try</span><span class="p">:</span>\n  <span class="n">client</span> <span class="o">=</span> <span class="n">connect_and_subscribe</span><span class="p">()</span>\n<span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>\n  <span class="n">restart_and_reconnect</span><span class="p">()</span>\n\n<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>\n  <span class="k">try</span><span class="p">:</span>\n    <span class="n">client</span><span class="p">.</span><span class="n">check_msg</span><span class="p">()</span>\n    <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_message</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">message_interval</span><span class="p">:</span>\n      <span class="n">tf</span> <span class="o">=</span> <span class="n">esp32</span><span class="p">.</span><span class="n">raw_temperature</span><span class="p">()</span>\n      <span class="n">tc</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">tf</span><span class="o">-</span><span class="mf">32.0</span><span class="p">)</span><span class="o">/</span><span class="mf">1.8</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>\n      <span class="n">msg</span> <span class="o">=</span> <span class="sa">b</span><span class="s">\'Message #%d\'</span> <span class="o">%</span> <span class="p">(</span><span class="n">counter</span><span class="p">)</span> <span class="o">+</span> <span class="s">": Temperature: %s degree Celsius"</span> <span class="o">%</span> <span class="p">(</span><span class="n">tc</span><span class="p">)</span>\n      <span class="n">client</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">topic_sub</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>\n      <span class="n">last_message</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>\n      <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>\n  <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>\n    <span class="n">restart_and_reconnect</span><span class="p">()</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<ul>\n<li><p>Don\'t forget to save.</p></li>\n<li><p>We will receive and publish messages in the while loop. We use <code>try</code> and <code>except</code> statements to prevent the ESP from crashing in case something goes wrong.</p></li>\n<li><p>Inside the <code>try</code> block we start by applying the <code>check_msg()</code> method on the client.</p></li>\n<li><p>The <code>check_msg()</code> method checks whether a pending message from the server is available. It waits for a single incoming MQTT message and process it. The subscribed messages are delivered to the callback function we have defined earlier (the <code>sub_cb()</code> function). If there is not a pending message, it returns with <code>None</code>.</p></li>\n<li><p>Then we add an if statement to check whether 5 seconds (<code>message_interval</code>) have passed since the last message was sent.</p></li>\n<li><p>We prepare the data we want to send. In our case I have chosen the internal temperature (there is also an internal hall sensor). We format the data as we need it and put it in the <code>msg</code> variable.</p></li>\n<li><p>To publish a message on a certain topic, you just need to apply the <code>publish()</code> method on the client and pass as arguments the topic and the message.</p></li>\n<li><p>After sending the message, we update the last time a message was received by setting the <code>last_message</code> variable to the current time.<br>\nFinally, we increase the <code>counter</code> variable in every loop.<br>\nIf something unexpected happens, we call the <code>restart_and_reconnect()</code> function.</p></li>\n</ul>\n\n<ol>\n<li>Finally, we can upload the files to the ESP32 ("Upload" button at the bottom). Your device will execute the code automatically when the upload succeeds.</li>\n</ol>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--UeZEoNbt--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/v1/./files/2.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--UeZEoNbt--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/v1/./files/2.png" loading="lazy" width="" height=""></a>  </p>\n\n<ol>\n<li>If your output looks like in the picture above, you are done with this lesson 🥳💃🏽🕺🏽</li>\n</ol>\n\n<blockquote>\n<p>Question for you: What temperature is measured?</p>\n</blockquote>\n\n<hr>\n<h2>\n  <a name="hints-and-pitfalls" href="#hints-and-pitfalls">\n  </a>\n  Hints and pitfalls\n</h2>\n\n<ul>\n<li><p>You may need to open the port 1883 in your firewall.</p></li>\n<li><p>As you may have noticed, I am giving you a few options to play with regarding the <code>mqtt_server</code> variable. On my system the "broker.emqx.io" works best. Additionally I encountered that the <strong>IP address written in letters</strong> works "better" than written in numbers. </p></li>\n<li><p>Connecting to a MQTT broker worked on my system after providing a <code>user</code> and <code>password</code> within the <code>MQTTClient()</code>. What you write in those variables is not crucial for now.</p></li>\n<li><p>When your device will not connect, try to connect to test.mosquitto.org via the terminal. </p></li>\n<li><p>When your device will not connect but connecting to test.mosquitto.org in the terminal(s) worked, you can try to make it work with Arduino first...</p></li>\n</ul>\n\n<hr>\n<h2>\n  <a name="useful-resources-for-own-searches" href="#useful-resources-for-own-searches">\n  </a>\n  Useful Resources for Own Searches\n</h2>\n\n<p><a href="https://boneskull.com/micropython-on-esp32-part-2/">Click here to <strong>get on the Good Foot with MicroPython on the ESP32</strong></a></p>\n\n<p><a href="https://github.com/gloveboxes/ESP32-MicroPython-BME280-MQTT-Sample/blob/master/Micropython.md">Click here for <strong>another approach for streaming data from ESP32 using MicroPython and MQTT</strong> (umqtt.robust)</a></p>\n\n<p><a href="https://stackoverflow.com/questions/26716279/how-to-test-the-mosquitto-server">Click here for <strong>testing mosquitto in the terminal(s)</strong></a>  </p>\n\n<p><a href="https://www.emqx.com/en/blog/esp32-connects-to-the-free-public-mqtt-broker">Click here for a <strong>Arduino tutorial</strong></a></p>\n\n<hr>\n<h2>\n  <a name="whats-next" href="#whats-next">\n  </a>\n  What\'s next\n</h2>\n\n<p>Encrypted connection to a MQTT broker.</p>\n\n<hr>\n<h2>\n  <a name="further-inputs" href="#further-inputs">\n  </a>\n  Further Inputs\n</h2>\n\n<blockquote>\n<p>Play around with the hall sensor data or maybe you have another external sensor you can connect to your ESP32.</p>\n\n<p>For that check out the possibilities the ESP32 has to offer:</p>\n</blockquote>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--XG3ThKeO--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/v1/./files/ESP32_Function_Block_Diagram.svg" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--XG3ThKeO--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/v1/./files/ESP32_Function_Block_Diagram.svg" loading="lazy" width="" height=""></a></p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--3BDFEXmp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://components101.com/sites/default/files/component_pin/ESP32-Pinout.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--3BDFEXmp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://components101.com/sites/default/files/component_pin/ESP32-Pinout.png" alt="DevKitC" loading="lazy" width="880" height="440"></a></p>\n\n<hr>\n<h2>\n  <a name="sources" href="#sources">\n  </a>\n  Source(s)\n</h2>\n\n<ul>\n<li><p>MicroPython Hackathon: <a href="https://micropython-iot-hackathon.readthedocs.io/en/latest/mqtt.html">https://micropython-iot-hackathon.readthedocs.io/en/latest/mqtt.html</a></p></li>\n<li><p>Random nerd tutorials 2: <a href="https://randomnerdtutorials.com/micropython-mqtt-esp32-esp8266/">https://randomnerdtutorials.com/micropython-mqtt-esp32-esp8266/</a></p></li>\n<li><p>Quick reference for the ESP32 - Micropython API: <a href="https://docs.micropython.org/en/latest/esp32/quickref.html#networking">https://docs.micropython.org/en/latest/esp32/quickref.html#networking</a></p></li>\n</ul>\n\n\n<h1>\n  <a name="lesson-4-mqtt-and-tls" href="#lesson-4-mqtt-and-tls">\n  </a>\n  Lesson 4: MQTT and TLS <a name="paragraph4"></a>\n</h1>\n<h2>\n  <a name="objectives" href="#objectives">\n  </a>\n  Objectives\n</h2>\n\n<p>In this final lesson you will establish a secured connection with a public test broker. MQTT provides security, but it is not enabled by default. MQTT has the option for Transport Layer Security (TLS) encryption, just as used with HTTPS. It is recommended using that for any system you put into production.<br>\nMQTT also provides username/password authentication. Note that the password is transmitted in clear text. Thus, be sure to use TLS encryption if you are using authentication. In our case we already provided the authentication (unencrypted). Nevertheless, it was just to improve the system flow. Another popular way of authenticating is via certificates and can be used in addition to using user name and password authentication. <a href="http://www.steves-internet-guide.com/ssl-certificates-explained/">Refer to <strong>this</strong> explanation in order to learn more about TLS/SSL.</a>  </p>\n<h2>\n  <a name="prerequisites-and-required-equipment" href="#prerequisites-and-required-equipment">\n  </a>\n  Prerequisites and required Equipment\n</h2>\n\n<ul>\n<li>ESP32 DevKitC</li>\n<li>Computer</li>\n<li>USB-Cable which allows data transfer</li>\n<li>Visual Studio Code</li>\n</ul>\n\n<hr>\n<h2>\n  <a name="solution-steps" href="#solution-steps">\n  </a>\n  Solution Steps\n</h2>\n\n<ol>\n<li><p>We first need to install OpenSSL in order to create our certificates and keys. Click <a href="https://github.com/openssl/openssl">here for GitHub</a> or <a href="https://slproweb.com/products/Win32OpenSSL.html">here for the exe</a>.</p></li>\n<li><p>Create CA key pair: Navigate to the Windows start and search OpenSSL. Hit enter on "OpenSSL Command Promt". Make sure you run the following commands as administrator.<br>\n</p></li>\n</ol>\n<div class="highlight js-code-highlight">\n<pre class="highlight console"><code><span class="go">openssl genrsa -des3 -out ca.key 2048\n</span></code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<blockquote>\n<p><strong>genrsa</strong>: generates a RSA private key<br><br>\n<strong>des3</strong>: Using DES3 cipher for the key generation<br><br>\n<strong>out</strong>: specifies the output file name (.key)<br><br>\n<strong>2048</strong>: number of bits for the private key    </p>\n</blockquote>\n\n<ul>\n<li>Your output should look like this:\n</li>\n</ul>\n<div class="highlight js-code-highlight">\n<pre class="highlight console"><code><span class="gp">C:\\Users\\schue&gt;</span>openssl genrsa <span class="nt">-des3</span> <span class="nt">-out</span> ca.key 2048\n<span class="go">Enter PEM pass phrase:\nVerifying - Enter PEM pass phrase:\n\n</span><span class="gp">C:\\Users\\schue&gt;</span><span class="w">\n</span></code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<ul>\n<li><p>Enter any password. But remember it, we will need it in a moment again.</p></li>\n<li><p>The pass phrase is used to protect the private key. The generated private file ca.key has both the private and public key.</p></li>\n</ul>\n\n<ol>\n<li>Create CA certificate: Next we are creating a certificate for the CA, using the key pair created in the step before:\n</li>\n</ol>\n<div class="highlight js-code-highlight">\n<pre class="highlight console"><code><span class="go">openssl req -new -x509 -days 1826 -key ca.key -out ca.crt\n</span></code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<blockquote>\n<p><strong>req</strong>: certificate request and certification utility<br><br>\n<strong>new</strong>: generate new certificate, it will prompt user for several input fields<br><br>\n<strong>x509</strong>: create a self signed certificate<br><br>\n<strong>days</strong>: specify the number of days the certificate is valid<br><br>\n<strong>key</strong>: key file with private key to be used for signing<br><br>\n<strong>out</strong>: specifies the file name for the certificate (.crt)  </p>\n</blockquote>\n\n<ul>\n<li>You should get something like this:\n</li>\n</ul>\n<div class="highlight js-code-highlight">\n<pre class="highlight console"><code><span class="gp">C:\\Users\\schue&gt;</span>openssl req <span class="nt">-new</span> <span class="nt">-x509</span> <span class="nt">-days</span> 3650 <span class="nt">-key</span> ca.key <span class="nt">-out</span> ca.crt\n<span class="go">Enter pass phrase for ca.key:\nYou are about to be asked to enter information that will be incorporated\ninto your certificate request.\nWhat you are about to enter is what is called a Distinguished Name or a DN.\nThere are quite a few fields but you can leave some blank\nFor some fields there will be a default value,\nIf you enter \'.\', the field will be left blank.\n-----\nCountry Name (2 letter code) [AU]:DE\nState or Province Name (full name) [Some-State]:Bavaria\nLocality Name (eg, city) []:Munich\nOrganization Name (eg, company) [Internet Widgits Pty Ltd]:Uni\nOrganizational Unit Name (eg, section) []:Master\nCommon Name (e.g. server FQDN or YOUR name) []:schue\nEmail Address []:.\n\n</span><span class="gp">C:\\Users\\schue&gt;</span><span class="w">\n</span></code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<blockquote>\n<p>As Common Name use your user name like "schue" in my case. </p>\n</blockquote>\n\n<ol>\n<li> Create broker key pair: Next, we are creating a private key for the server with:\n</li>\n</ol>\n<div class="highlight js-code-highlight">\n<pre class="highlight console"><code><span class="go">openssl genrsa -out server.pem 2048\n</span></code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<blockquote>\n<p><strong>genrsa</strong>: generate a RSA private key<br><br>\n<strong>out</strong>: specifies the output file name (.pem)<br><br>\n<strong>2048</strong>: number of bits for the private key  </p>\n</blockquote>\n\n<ol>\n<li>Create certificate request from CA: That key needs to be certified, so we create a certificate request for it, and the certificate needs to be signed by the CA:\n</li>\n</ol>\n<div class="highlight js-code-highlight">\n<pre class="highlight console"><code><span class="go">openssl req -new -out server.csr -key server.pem\n</span></code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<blockquote>\n<p><strong>req</strong>: certificate request and certification utility<br><br>\n<strong>new</strong>: create new request file file<br><br>\n<strong>out</strong>: file name for the certificate signing request (.csr)<br><br>\n<strong>key</strong>: file name of the key to be certified  </p>\n</blockquote>\n\n<ul>\n<li>Your output should look like this:\n</li>\n</ul>\n<div class="highlight js-code-highlight">\n<pre class="highlight console"><code><span class="gp">C:\\Users\\schue&gt;</span>openssl req <span class="nt">-new</span> <span class="nt">-out</span> server.csr <span class="nt">-key</span> server.pem\n<span class="go">You are about to be asked to enter information that will be incorporated\ninto your certificate request.\nWhat you are about to enter is what is called a Distinguished Name or a DN.\nThere are quite a few fields but you can leave some blank\nFor some fields there will be a default value,\nIf you enter \'.\', the field will be left blank.\n-----\nCountry Name (2 letter code) [AU]:DE\nState or Province Name (full name) [Some-State]:Bavaria\nLocality Name (eg, city) []:Munich\nOrganization Name (eg, company) [Internet Widgits Pty Ltd]:UniMuni\nOrganizational Unit Name (eg, section) []:EL\nCommon Name (e.g. server FQDN or YOUR name) []:schue\nEmail Address []:.\n\nPlease enter the following \'extra\' attributes\nto be sent with your certificate request\nA challenge password []:0815\nAn optional company name []:IT\n\n</span><span class="gp">C:\\Users\\schue&gt;</span><span class="w">\n</span></code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<ol>\n<li>Verify and sign the certificate request: The last step with OpenSSL is to sign the server request through the CA to get the broker certificate:\n</li>\n</ol>\n<div class="highlight js-code-highlight">\n<pre class="highlight console"><code><span class="go">openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out cert.der -days 360\n</span></code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<blockquote>\n<p><strong>x509</strong>: certificate display and signing utility<br><br>\n<strong>req</strong>: a certificate request is expected as input<br><br>\n<strong>in</strong>: input file for the certificate<br><br>\n<strong>CA</strong>: specifies the file to be signed<br><br>\n<strong>CAkey</strong>: CA private key to sign the certificate with<br><br>\n<strong>Cacreateserial</strong>: the serial number file gets created if it does not exist<br><br>\n<strong>out</strong>: output file name<br><br>\n<strong>days</strong>: how long the certificate shall be valid  </p>\n</blockquote>\n\n<ol>\n<li>Convert your .pem file to .der file:\n</li>\n</ol>\n<div class="highlight js-code-highlight">\n<pre class="highlight console"><code><span class="go">openssl rsa -inform pem -in server.pem -outform der -out key.der\n</span></code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<ol>\n<li>Finally move the created files to the ESP32: To do so get mpfshell:</li>\n</ol>\n\n<blockquote>\n<p><a href="https://gist.github.com/hardye/657385210c5d613e69cb5ba95e8c57a7">Click here if the command below does not work.</a><br>\n</p>\n\n\n</blockquote>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight console"><code><span class="go">pip3 install mpfshell\n</span></code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<ul>\n<li>Make sure your device is not connected via a Pymakr console or anywhere else. Then enter (on Windows) (and insert YOUR port number):\n</li>\n</ul>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight console"><code><span class="go">mpfshell -c "open COMx"\n</span></code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<ul>\n<li>and on Linux:\n</li>\n</ul>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight console"><code><span class="go">mpfshell -c "open ttyUSBx"\n</span></code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<ul>\n<li>Now you can list the files on the device with:\n</li>\n</ul>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight console"><code><span class="gp">mpfs&gt;</span><span class="w"> </span><span class="nb">ls</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<ul>\n<li>To upload e.g. the local file <code>boot.py</code> to the device use:\n</li>\n</ul>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight console"><code><span class="gp">mpfs&gt;</span><span class="w"> </span>put boot.py\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<ul>\n<li>You need to navigate to the directory  (<code>cd</code>) which contains the <code>boot.py</code> first.</li>\n</ul>\n\n<blockquote>\n<p><a href="https://github.com/wendlers/mpfshell">Get more mpf commands <strong>here</strong></a></p>\n</blockquote>\n\n<ol>\n<li>Lastly, we can adjust our code to use the "secured" connection (we are still connectiong to a public test broker! But you get the main idea, in case you would like to implement a TLS connection to your own broker).\n</li>\n</ol>\n\n<ul>\n<li>\n<strong>Add</strong> the following lines to your <code>boot.py</code>:\n</li>\n</ul>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight python"><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">\'key.der\'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>\n  <span class="n">key_data</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>\n<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">\'cert.der\'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>\n  <span class="n">cert_data</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<ul>\n<li>\n<strong>Change</strong> the <code>connect_and_subscribe()</code> in your <code>main.py</code>:\n</li>\n</ul>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight python"><code><span class="k">def</span> <span class="nf">connect_and_subscribe</span><span class="p">():</span>\n  <span class="k">global</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">mqtt_server</span><span class="p">,</span> <span class="n">topic_sub</span><span class="p">,</span> <span class="n">key_data</span><span class="p">,</span> <span class="n">cert_data</span>\n  <span class="n">client</span> <span class="o">=</span> <span class="n">MQTTClient</span><span class="p">(</span><span class="n">client_id</span><span class="p">,</span> <span class="n">mqtt_server</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">8883</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="sa">b</span><span class="s">"emqx"</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="sa">b</span><span class="s">"0815"</span>\n                      <span class="p">,</span> <span class="n">ssl</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ssl_params</span><span class="o">=</span><span class="p">{</span><span class="s">\'key\'</span><span class="p">:</span> <span class="n">key_data</span><span class="p">,</span> <span class="s">\'cert\'</span><span class="p">:</span> <span class="n">cert_data</span><span class="p">})</span>\n  <span class="n">client</span><span class="p">.</span><span class="n">set_callback</span><span class="p">(</span><span class="n">sub_cb</span><span class="p">)</span>\n  <span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">()</span>\n  <span class="n">client</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">topic_sub</span><span class="p">)</span>\n  <span class="k">print</span><span class="p">(</span><span class="s">\'Connected to %s MQTT broker, subscribed to %s topic\'</span> <span class="o">%</span> <span class="p">(</span><span class="n">mqtt_server</span><span class="p">,</span> <span class="n">topic_sub</span><span class="p">))</span>\n  <span class="k">return</span> <span class="n">client</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<blockquote>\n<p>My output:<br>\n</p>\n</blockquote>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight console"><code><span class="go">Uploading project (main folder)...\nNot safe booting, disabled in settings\n\nUploading to /...\nReading file status\nNo files to upload\nUpload done, resetting board...\nOKets Jun  8 2016 00:22:57\n\nrst:0xc (SW_CPU_RESET),boot:0x13 (SPI_FAST_FLASH_BOOT)\nconfigsip: 0, SPIWP:0xee\nclk_drv:0x00,q_drv:0x00,d_drv:0x00,cs0_drv:0x00,hd_drv:0x00,wp_drv:0x00\nmode:DIO, clock div:2\nload:0x3fff0030,len:5656\nload:0x40078000,len:12696\nload:0x40080400,len:4292\nentry 0x400806b0\nConnection successful\n(\'194.xxx.xxx.xxx\', \'254.xxx.xxx.xxx\', \'194.xxx.xxx.xxx\', \'194.xxx.xxx.xxx\')\nConnected to broker.emqx.io MQTT broker, subscribed to b\'OnBoard_Temp\' topic\n</span><span class="gp">(b\'OnBoard_Temp\', b\'Message #</span>0: Temperature: 40.0 degree Celsius<span class="s1">\')\n</span><span class="gp">(b\'OnBoard_Temp\', b\'Message #</span><span class="s1">1: Temperature: 40.0 degree Celsius\'</span><span class="o">)</span>\n<span class="gp">(b\'OnBoard_Temp\', b\'Message #</span>2: Temperature: 40.0 degree Celsius<span class="s1">\')\n</span><span class="gp">(b\'OnBoard_Temp\', b\'Message #</span><span class="s1">3: Temperature: 40.0 degree Celsius\'</span><span class="o">)</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<ul>\n<li>Yeay, we are publishing our data over TLS.</li>\n</ul>\n\n\n<hr>\n\n<h2>\n  <a name="hints-and-pitfalls" href="#hints-and-pitfalls">\n  </a>\n  Hints and pitfalls\n</h2>\n\n<ul>\n<li><p>You may need to open the port 8883 in your firewall.</p></li>\n<li><p>You can move the cert files to your VS Code workspace and hit the upload button. But it will not upload the certificates to your device!</p></li>\n<li><p>You can also use ampy to move files to the ESP32. This is the most common way online. Nevertheless, ampy did not work on my system.</p></li>\n<li><p>Since my colleagues encountered problems with mpfshell and ampy on their systems, I am giving you a last option: You can use the uPyCraft IDE to transfer files to your ESP32. Installation instructions for: <a href="https://randomnerdtutorials.com/install-upycraft-ide-windows-pc-instructions/">Windows</a>, <a href="https://randomnerdtutorials.com/install-upycraft-ide-mac-os-x-instructions/">MacOS X</a> and <a href="https://randomnerdtutorials.com/install-upycraft-ide-linux-ubuntu-instructions/">Linux</a>.</p></li>\n</ul>\n\n\n<hr>\n\n<h2>\n  <a name="useful-resources-for-own-searches" href="#useful-resources-for-own-searches">\n  </a>\n  Useful Resources for Own Searches\n</h2>\n\n<p><a href="https://mcuoneclipse.com/2017/04/14/introduction-to-security-and-tls-transport-security-layer/">Click here for <strong>another introduction to TLS</strong></a></p>\n\n<p><a href="https://github.com/gloveboxes/ESP32-MicroPython-BME280-MQTT-Sample/blob/master/Micropython.md">Click here for <strong>another approach for streaming data from ESP32 using MicroPython and MQTT</strong> (umqtt.robust)</a></p>\n\n<p><a href="https://github.com/micropython/micropython-esp32/issues/90">ENOENT ERROR</a></p>\n\n\n<hr>\n\n<h2>\n  <a name="further-inputs" href="#further-inputs">\n  </a>\n  Further Inputs\n</h2>\n\n<p>You can also encrypt your message before sending it. In our case it will not work. Can you find out why? It would work with a separate broker (with own code). Here are two useful links to begin with:<br>\n<a href="https://forum.micropython.org/viewtopic.php?t=6726">https://forum.micropython.org/viewtopic.php?t=6726</a><br>\n<a href="https://docs.micropython.org/en/latest/library/cryptolib.html">https://docs.micropython.org/en/latest/library/cryptolib.html</a></p>\n\n<blockquote>\n<p>Steve: "Encrypting the MQTT payload rather than the link has the advantage that the data is encrypted end to end and not just between the broker and the client.<br><br>\nIt also means that the intermediate brokers don’t need to support SSL and that you don’t need to obtain and install certificates."<br><br>\nUnknown: "It is always a good idea to use further security mechanisms such as payload encryption, payload signature verifications, and authorization mechanisms. In general, more security never hurts."<br><br>\nDo you agree?<br>\nWhat do you think about these quotations?</p>\n</blockquote>\n\n\n<hr>\n\n<p>Congratulations! You are at the end of my tutorial. Maybe you would like to set up your own broker on a Rpy next?</p>\n\n\n<hr>\n\n<h2>\n  <a name="sources" href="#sources">\n  </a>\n  Source(s)\n</h2>\n\n<ul>\n<li><p>Enable Secure Communication with TLS and the Mosquitto Broker: <a href="https://mcuoneclipse.com/2017/04/14/enable-secure-communication-with-tls-and-the-mosquitto-broker/">https://mcuoneclipse.com/2017/04/14/enable-secure-communication-with-tls-and-the-mosquitto-broker/</a></p></li>\n<li><p>Mosquitto SSL Configuration: <a href="http://www.steves-internet-guide.com/mosquitto-tls/">http://www.steves-internet-guide.com/mosquitto-tls/</a></p></li>\n<li><p>OpenSSL Command Line Utilities: <a href="https://wiki.openssl.org/index.php/Command_Line_Utilities">https://wiki.openssl.org/index.php/Command_Line_Utilities</a></p></li>\n</ul>\n\n',s.body_markdown='# <h1 align="center" id="3">Implementation of an encrypted MQTT connection with MicroPython on a ESP32</h1>\n\n# Table of Contents\n\n0. [Introduction: ESP32 MicroPython MQTT TLS](#paragraph0)   \n1. [Installing MicroPython](#paragraph1)\n2. [Using MicroPython](#paragraph2)\n3. [Wifi and MQTT Connection](#paragraph3)\n4. [MQTT and TLS](#paragraph4)\n\n# Introduction: ESP32 MicroPython MQTT TLS <a name="paragraph0"></a>\n\nby: Bass Paranoya\n***\n\n## Overview\n\nIn this tutorial you will learn how to program the ESP32 using MicroPython. At first we will connect the device to the Internet via WIFI. Furthermore we will use this knowledge to implement a MQTT connection to send internal sensor data. In the last steps we will discuss data security and use it to authenticate and encrypt our MQTT connection over TLS. \n\n## Prerequisites and required Equipment\n\n- Computer\n- Visual Studio Code\n- ESP32 DevKitC\n- USB-Cable which allows to transfer data \n\n> The tutorial was made on a Windows system. Nevertheless, I will also present the commands for Ubuntu. If you use a Mac or another system you\'ll find the necessary commands most of the time in the presented external links (APIs) at the end of each lesson under "Hints and pitfalls", "Useful Resources for Own Searches" and "Sources"). I recommend to use Visual Studio Code.\n\n___________________   \n\n<div style="page-break-after: always;"></div>\n\n\n\n\n# Lesson 1: Installing MicroPython <a name="paragraph1"></a>\n\n\n## Objectives\n\nOur first lesson will be flashing the ESP32 with MicroPython.\n\n## Prerequisites and required Equipment\n\n- ESP32 DevKitC\n- USB-Cable which allows to transfer data \n- Computer \n\n___________________   \n   \n## Solution Steps\n\n1. Download the latest MicroPython firmware:     \n[Click **here** for downloading the latest .bin file](https://micropython.org/download/esp32/) (e.g.:  v1.17 (2021-09-02) .bin) \n\n2. Connect the ESP32 with the USB cable to your computer. \n\n3. Install the esptool extension using `pip` in a terminal or the powershell in VS Code:  \n\n> [Click **here** if you have not installed pip.](https://pip.pypa.io/en/stable/installation/)  \n\n\n```console\npip install esptool\n```       \n\n* alternatively you can use [this **GitHub Link**](https://github.com/espressif/esptool/).\n\n> You need to look up the port used for the ESP32 in the Device Manager. Adjust the COMx for your command in the next step.  \nIf the ESP32 does not connect to any port, the chance is high that your USB cable is not suitable for exchanging data (it is a power supply only). Use a suitable one instead. \n\n4. Erase the flash under Windows with:  \n\n```console\npython -m esptool --port COMx erase_flash \n``` \n  \n+ Or on Linux\n\n```console\nesptool.py --port /dev/ttyUSBx erase_flash\n```  \n\n+ If the command output says something similar to "no permission", then it is likely the ESP32 is connected somewhere else. Disconnect it.\n\n5. Next we will deploy the new firmware with this example command on Windows which worked best on my system (use your port and path):\n\n```console\npython -m esptool --chip esp32 --port COMx write_flash -z 0x1000 C:\\path_to_firmware\\esp32-20210902-v1.17.bin \n```  \n* If you use Linux:  \n```console\nesptool.py --chip esp32 --port /dev/ttyUSBx write_flash -z 0x1000 esp32-20180511-v1.9.4.bin\n```  \n\n6. If the above commands run without error then MicroPython should be installed on your board.  \n\n_________________________  \n\n  \n## Hints and pitfalls\n\n- You may need to reduce the baudrate if you get errors while flashing (e.g. down to 115200 by adding `--baud 115200` into the command) or (`-b 9600` is a very slow value that you can use to verify it is not a baud rate problem)\n- For some boards with a particular FlashROM configuration you may need to change the flash mode (e.g. by adding `-fm dio` into the command)\n- Check if you have permissions to access the serial port, and if other software (such as modem-manager on Linux) is trying to interact with it. A common pitfall is leaving a serial terminal accessing this port open in another window and forgetting about it.\n- for more tips check out the following links:\n\n___________________  \n\n## Useful Resources for Own Searches\n\n[Click here for the **Getting Started with MicroPython on the ESP32** from the MicroPython API](https://docs.micropython.org/en/latest/esp32/tutorial/intro.html)  \n[Click here for the **Installation and Dependencies** tutorial from ESPRESSIF](https://docs.espressif.com/projects/esptool/en/latest/esp32/installation.html)  \n[Check out the **Troubleshooting** from ESPRESSIF if you still get Errors](https://docs.espressif.com/projects/esptool/en/latest/esp32/troubleshooting.html#troubleshooting)\n\n___________________\n## What\'s next\n\nUsing MicroPython\n\n_______________________  \n\n\n## Source(s)\n\n- Micropython API for ESP32 Boards: https://docs.micropython.org/en/latest/esp32/quickref.html\n- ESPRESSIF documentation: https://docs.espressif.com/projects/esptool/en/latest/esp32/index.html#\n\n\n<div style="page-break-after: always;"></div>\n\n\n# Lesson 2: Using MicroPython <a name="paragraph2"></a>\n\n\n## Objectives\n\nNext, we will get a REPL promt in which we can use MicroPython on the ESP32.\n\n## Prerequisites and required Equipment\n\n- ESP32 DevKitC\n- Computer\n- USB-Cable which allows data transfer \n- Visual Studio Code\n\n___________________   \n\n## Solution Steps\n\n1. In order to use Pymakr extension on VS Code, you need node.js installed on your computer. [Use this link to get to the download page.](https://nodejs.org/en/download/) \n\n2. Open Visual Studio Code and install the Pymakr Extension (ID: pycom.pymakr)\n\n3. If you have any trouble, [here is a detailed manual](https://randomnerdtutorials.com/micropython-esp32-esp8266-vs-code-pymakr/#pymakr) (at the top of the page you can also follow the manual for installing VS Code)\n\n4. Edit the pymakr.json file which opens automatically after installing Pymakr, in case it did not: Hit the "ALL commands" button at the very bottom of the VS Code window and click on "Global Setting".\n  \n+ Pymakr has a list of USB devices it will connect to. You need to make sure that your device is on the list in the pymakr.json configuration file. You need to add the USB Manufacturer that the device uses to connect to the PC. In our case, the ESP32 uses the "Silicon Labs" USB drivers.\n\n+ To find out which drivers your board uses, open your computer’s Device Manager (with the board connected to your computer) and search for connected USB devices. Under "General" you find the "Manufacturer". Now, edit the file to add the Silicon Labs manufacturer (or other) to the `autoconnect_comport_manufacturers`  \nsection. Then, save the file. The section should look like this:\n\n```json\n"autoconnect_comport_manufacturers": [\n  "Pycom",\n  "Pycom Ltd.",\n  "FTDI",\n  "Microsoft",\n  "Microchip Technology, Inc.",\n  "Silicon Labs"\n]\n```\n\n5. Connect your flashed ESP32 to your computer and hit the "Pymakr Console" button at the very bottom left of the VS Code window. Navigate to the Pymakr Console (similar to powershell in VS Code). You will get the MicroPython REPL indicated by `>>>`.\n\n<img style="float:middle" src="./files/1.png" width="800">  \n\n6. You can now test the REPL promt by entering:\n\n```python\nprint(\'Hallo Studierende!\')\n```\n\n```python\n1+2\n```\n\n+ Your output should look like this:\n\n```python\n>>> print(\'Hallo Studierende!\')\nHallo Studierende!\n>>> 1+2\n3\n>>>\n```\n\n+ If it does, congratulations, you are using MicroPython on your ESP32 🎉🥳\n\x3c!--- einfach reinkopieren z.B. von https://emojipedia.org/party-popper/ ---\x3e\n\n### For a Warm-Up try:\n\n```python\n>>> f = open(\'data.txt\', \'w\')\n>>> f.write(\'some data\')\n9\n>>> f.close()\n>>> \n>>> f = open(\'data.txt\')\n>>> f.read()\n\'some data\'\n>>> f.close()\n>>> \n>>> import os\n>>> os.listdir()\n[\'boot.py\', \'main.py\', \'data.txt\']\n>>> \n>>> os.mkdir(\'dir\')\n>>> \n>>> os.remove(\'data.txt\')\n>>> os.remoce("dir")\n```\n\n+ There are two files that are treated specially by the ESP32 (and ESP8266) when it starts up: boot.py and main.py. The boot.py script is executed first (if it exists) and then once it is completed the main.py script is executed. You can create these files yourself and populate them with the code that you want to run when the device starts up.\n\n### REPL promt tips:\n\n+ Pressing ctrl-E will enter a special paste mode. This allows you to copy and paste a chunk of text into the REPL. If you press ctrl-E you will see the paste-mode prompt:\n\n```python\npaste mode; Ctrl-C to cancel, Ctrl-D to finish\n===\n```\n+ You can then paste (or type) your text in. Note that none of the special keys or commands work in paste mode (e.g. Tab or backspace), they are just accepted as-is. Press ctrl-D to finish entering the text and execute it.\n\n+ There are four other control commands:\n\n    + Ctrl-A on a blank line will enter raw REPL mode. This is like a permanent paste mode, except that characters are not echoed back.\n\n    + Ctrl-B on a blank like goes to normal REPL mode.\n\n    + Ctrl-C cancels any input, or interrupts the currently running code.\n\n    + Ctrl-D on a blank line will do a soft reset.\n\n___________________   \n\n\n## Hints and pitfalls \n\n- Regarding pymakr.json: put your COMx in the address setting and set auto_correct to `False`.\n- Regarding pymakr.json: For automatic connect, let the address setting empty, and set the auto_connect to `True`. Play around with these settings if you encounter problems.\n- If you can\'t get the Pymakr Console after opening VS Code make sure your computer is not running on a battery saving mode or similar. Set it to high performance mode and open VS Code again.\n- If you cannot get the REPL promt indicated by `>>>`, perform a keyboard interrupt or click the "Upload" or "Run" button at the very bottom of the VS Code window. Play around, that was sometimes necessary on my system.\n- If you cannot connect your ESP32, you can try it with TeraTerm or `picocom` on Linux. [Read here for a detailed tutorial](https://randomnerdtutorials.com/micropython-esp32-esp8266-vs-code-pymakr/#pymakr). Don not forget to set the baudrate to `115200`.\n\n___________________\n\n## Useful Resources for Own Searches\n\n[Click here for a **detailed tutorial** on how to install VS Code and the Pymakr extension](https://randomnerdtutorials.com/micropython-esp32-esp8266-vs-code-pymakr/#pymakr)  \n\n[Click here for a **MicroPython tutorial** for the ESP8266 (most of them also work on your ESP32)](https://docs.micropython.org/en/latest/esp8266/tutorial/index.html)\n## What\'s next\n\nSetting up you Wifi connection and connect to a public test MQTT broker.\n\n___________________    \n\n\n## Source(s)\n\n- Micropython API: https://docs.micropython.org/en/latest/index.html\n- Random nerd tutorials: https://randomnerdtutorials.com/micropython-esp32-esp8266-vs-code-pymakr/#pymakr\n\n<div style="page-break-after: always;"></div>\n\n# Lesson 3: Wifi and MQTT Connection <a name="paragraph3"></a>\n\n\n## Objectives\n\nIn this lesson you will set up a connection to your Wifi. Followed by connecting your ESP32 as a client to a public testing broker. Moreover we will subscribe to a topic and publish some data to get familiar with MQTT.\n\n## Prerequisites and required Equipment\n\n- ESP32 DevKitC\n- Computer\n- USB-Cable which allows data transfer\n- Visual Studio Code\n\n___________________   \n\n\n## Solution Steps\n\n1. First, we will implement an automatic Wifi connection. This is done by writing the code into the `boot.py` file. Create a new file in the explorer (from VS Code on the left side of the window and name it `boot.py`). The code in this file will be executed automatically after every start of the module. (For testing purposes you can also first enter the code one by one into the REPL promt and see if your connection works.) To do so write the following lines (in the `boot.py`):\n\n```python\nimport network\n\nssid = \'Your SSID\'\npassword = \'Your password\' \n\nstation = network.WLAN(network.STA_IF) # creates station interface\n\nstation.active(True) # activates the interface\nstation.connect(ssid, password) # connects to wifi\n\nwhile station.isconnected() == False:\n  pass # waits till module is connected\n\nprint(\'Connection successful\')\nprint(station.ifconfig()) \n# prints the interface\'s IP/netmask/gw/DNS addresses\n```\n\n+ Save the boot.py file and click the "Upload" button at the very bottom of the VS Code window. The whole project will be uploaded to your ESP32 and executed afterwards. If you just want to upload the boot.py file you can do that by clicking -> "All commands" -> "Upload current file only" (at the bottom of VS Code).\n\n+ When executed successfully, your terminal should print something like:   `Connection successful\n(\'194.xxx.xxx.xxx\', \'254.xxx.xxx.xxx\', \'194.xxx.xxx.xxx\', \'194.xxx.xxx.xxx\')`  \n    \n    If that is the case, congratulations 🎉 you connected the ESP32 with your Wifi.   \n\n    Lets move on with MQTT:\n\n2. Create a new file named `umqttsimple.py` and copy the umqttsimple library code into it. You can access the umqttsimple library code via the following link:\n\n    https://raw.githubusercontent.com/RuiSantosdotme/ESP-MicroPython/master/code/MQTT/umqttsimple.py\n\n    Don\'t forget to save the file.\n \n\n3. Moving on you will have to **extend** the `boot.py` by **adding** the following lines:\n\n```python\nimport time\nfrom umqttsimple import MQTTClient\nimport ubinascii\nimport machine\nimport micropython\nimport esp\nimport esp32          # import all needed libraries\nesp.osdebug(None)     # debug set to none\nimport gc             # garbage collector\ngc.collect()\n\nmqtt_server = \'YOUR MQTT BROKER\'\n#mqtt_server = "broker.emqx.io"     # works best for me\n#mqtt_server = "broker.hivemq.com"\n#mqtt_server = \'3.65.154.195:1883\'  #broker.hivemq.com\n#mqtt_server = \'5.196.95.208\'       #test.mosquitto.org\n\nclient_id = ubinascii.hexlify(machine.unique_id()) # gets ID\ntopic_sub = b\'OnBoard_Temp\' # toppic name\n\nlast_message = 0 \nmessage_interval = 5\ncounter = 0             # variables needed for improved timing\n```   \n+ Don\'t forget to save.\n \n + The `last_message` variable will hold the last time a message was sent. The `message_interval` is the time between each message sent. Here we are setting it to 5 seconds (this means a new message will be sent every 5 seconds). The `counter` variable is simply a counter to be added to the message.\n\n4. We will create the `main.py` now. To do so, copy the following code into it:\n\n```python\n# Callback func handles what happens when message is received on a certain topic\ndef sub_cb(topic, msg):\n  print((topic, msg))\n\n# responsible for connecting to broker as well as to subscribe to a topic\ndef connect_and_subscribe():\n  global client_id, mqtt_server, topic_sub\n  client = MQTTClient(client_id, mqtt_server, port = 1883, user=b"emqx", password=b"0815")\n\n  client.set_callback(sub_cb)\n  client.connect()\n  client.subscribe(topic_sub)\n  print(\'Connected to %s MQTT broker, subscribed to %s topic\' % (mqtt_server, topic_sub))\n  return client\n\ndef restart_and_reconnect():\n  print(\'Failed to connect to MQTT broker. Reconnecting...\')\n  time.sleep(10)\n  machine.reset()\n\ntry:\n  client = connect_and_subscribe()\nexcept OSError as e:\n  restart_and_reconnect()\n\nwhile True:\n  try:\n    client.check_msg()\n    if (time.time() - last_message) > message_interval:\n      tf = esp32.raw_temperature()\n      tc = round((tf-32.0)/1.8, 2)\n      msg = b\'Message #%d\' % (counter) + ": Temperature: %s degree Celsius" % (tc)\n      client.publish(topic_sub, msg)\n      last_message = time.time()\n      counter += 1\n  except OSError as e:\n    restart_and_reconnect()\n```\n+ Don\'t forget to save.\n\n+ We will receive and publish messages in the while loop. We use `try` and `except` statements to prevent the ESP from crashing in case something goes wrong.\n\n+ Inside the `try` block we start by applying the `check_msg()` method on the client.\n\n+ The `check_msg()` method checks whether a pending message from the server is available. It waits for a single incoming MQTT message and process it. The subscribed messages are delivered to the callback function we have defined earlier (the `sub_cb()` function). If there is not a pending message, it returns with `None`.\n\n+ Then we add an if statement to check whether 5 seconds (`message_interval`) have passed since the last message was sent.\n\n+ We prepare the data we want to send. In our case I have chosen the internal temperature (there is also an internal hall sensor). We format the data as we need it and put it in the `msg` variable.\n\n+ To publish a message on a certain topic, you just need to apply the `publish()` method on the client and pass as arguments the topic and the message.\n\n+ After sending the message, we update the last time a message was received by setting the `last_message` variable to the current time.\nFinally, we increase the `counter` variable in every loop.\nIf something unexpected happens, we call the `restart_and_reconnect()` function.\n\n\n5. Finally, we can upload the files to the ESP32 ("Upload" button at the bottom). Your device will execute the code automatically when the upload succeeds.\n\n\n\n<img style="float:middle" src="./files/2.png" width="800">  \n\n\n\n6. If your output looks like in the picture above, you are done with this lesson 🥳💃🏽🕺🏽\n\n> Question for you: What temperature is measured?\n\n_________________________\n\n## Hints and pitfalls\n\n- You may need to open the port 1883 in your firewall.\n\n- As you may have noticed, I am giving you a few options to play with regarding the `mqtt_server` variable. On my system the "broker.emqx.io" works best. Additionally I encountered that the **IP address written in letters** works "better" than written in numbers. \n\n- Connecting to a MQTT broker worked on my system after providing a `user` and `password` within the `MQTTClient()`. What you write in those variables is not crucial for now.\n\n- When your device will not connect, try to connect to test.mosquitto.org via the terminal. \n\n- When your device will not connect but connecting to test.mosquitto.org in the terminal(s) worked, you can try to make it work with Arduino first...\n\n_________________________\n\n## Useful Resources for Own Searches\n\n\n[Click here to **get on the Good Foot with MicroPython on the ESP32**](https://boneskull.com/micropython-on-esp32-part-2/)\n\n[Click here for **another approach for streaming data from ESP32 using MicroPython and MQTT** (umqtt.robust)](https://github.com/gloveboxes/ESP32-MicroPython-BME280-MQTT-Sample/blob/master/Micropython.md)\n\n[Click here for **testing mosquitto in the terminal(s)**](https://stackoverflow.com/questions/26716279/how-to-test-the-mosquitto-server)  \n\n[Click here for a **Arduino tutorial**](https://www.emqx.com/en/blog/esp32-connects-to-the-free-public-mqtt-broker)\n\n_________________________\n\n## What\'s next\n\nEncrypted connection to a MQTT broker.\n\n\n_________________________\n\n## Further Inputs\n\n> Play around with the hall sensor data or maybe you have another external sensor you can connect to your ESP32.\n\n> For that check out the possibilities the ESP32 has to offer:\n  \n<img src="./files/ESP32_Function_Block_Diagram.svg" width="300">\n\n![DevKitC](https://components101.com/sites/default/files/component_pin/ESP32-Pinout.png)\n\n\n_________________________    \n\n\n## Source(s)\n\n- MicroPython Hackathon: https://micropython-iot-hackathon.readthedocs.io/en/latest/mqtt.html\n\n- Random nerd tutorials 2: https://randomnerdtutorials.com/micropython-mqtt-esp32-esp8266/\n\n- Quick reference for the ESP32 - Micropython API: https://docs.micropython.org/en/latest/esp32/quickref.html#networking\n\n<div style="page-break-after: always;"></div>\n\n# Lesson 4: MQTT and TLS <a name="paragraph4"></a>\n\n\n## Objectives\n\nIn this final lesson you will establish a secured connection with a public test broker. MQTT provides security, but it is not enabled by default. MQTT has the option for Transport Layer Security (TLS) encryption, just as used with HTTPS. It is recommended using that for any system you put into production.\nMQTT also provides username/password authentication. Note that the password is transmitted in clear text. Thus, be sure to use TLS encryption if you are using authentication. In our case we already provided the authentication (unencrypted). Nevertheless, it was just to improve the system flow. Another popular way of authenticating is via certificates and can be used in addition to using user name and password authentication. [Refer to **this** explanation in order to learn more about TLS/SSL.](http://www.steves-internet-guide.com/ssl-certificates-explained/)  \n\n## Prerequisites and required Equipment\n\n- ESP32 DevKitC\n- Computer\n- USB-Cable which allows data transfer\n- Visual Studio Code\n\n_________________________    \n\n\n## Solution Steps\n\n1. We first need to install OpenSSL in order to create our certificates and keys. Click [here for GitHub](https://github.com/openssl/openssl) or [here for the exe](https://slproweb.com/products/Win32OpenSSL.html).\n\n2. Create CA key pair: Navigate to the Windows start and search OpenSSL. Hit enter on "OpenSSL Command Promt". Make sure you run the following commands as administrator.\n\n```console\nopenssl genrsa -des3 -out ca.key 2048\n```\n\n> **genrsa**: generates a RSA private key  \n> **des3**: Using DES3 cipher for the key generation  \n> **out**: specifies the output file name (.key)  \n> **2048**: number of bits for the private key    \n\n+ Your output should look like this:\n\n```console\nC:\\Users\\schue>openssl genrsa -des3 -out ca.key 2048\nEnter PEM pass phrase:\nVerifying - Enter PEM pass phrase:\n\nC:\\Users\\schue>\n```\n+ Enter any password. But remember it, we will need it in a moment again.\n\n+ The pass phrase is used to protect the private key. The generated private file ca.key has both the private and public key.\n\n3. Create CA certificate: Next we are creating a certificate for the CA, using the key pair created in the step before:\n\n```console\nopenssl req -new -x509 -days 1826 -key ca.key -out ca.crt\n```\n> **req**: certificate request and certification utility  \n> **new**: generate new certificate, it will prompt user for several input fields  \n> **x509**: create a self signed certificate  \n> **days**: specify the number of days the certificate is valid  \n> **key**: key file with private key to be used for signing  \n> **out**: specifies the file name for the certificate (.crt)  \n\n+ You should get something like this:\n\n```console\nC:\\Users\\schue>openssl req -new -x509 -days 3650 -key ca.key -out ca.crt\nEnter pass phrase for ca.key:\nYou are about to be asked to enter information that will be incorporated\ninto your certificate request.\nWhat you are about to enter is what is called a Distinguished Name or a DN.\nThere are quite a few fields but you can leave some blank\nFor some fields there will be a default value,\nIf you enter \'.\', the field will be left blank.\n-----\nCountry Name (2 letter code) [AU]:DE\nState or Province Name (full name) [Some-State]:Bavaria\nLocality Name (eg, city) []:Munich\nOrganization Name (eg, company) [Internet Widgits Pty Ltd]:Uni\nOrganizational Unit Name (eg, section) []:Master\nCommon Name (e.g. server FQDN or YOUR name) []:schue\nEmail Address []:.\n\nC:\\Users\\schue>\n```\n\n> As Common Name use your user name like "schue" in my case. \n\n4.  Create broker key pair: Next, we are creating a private key for the server with:\n\n```console\nopenssl genrsa -out server.pem 2048\n```\n> **genrsa**: generate a RSA private key  \n> **out**: specifies the output file name (.pem)  \n> **2048**: number of bits for the private key  \n\n\n5. Create certificate request from CA: That key needs to be certified, so we create a certificate request for it, and the certificate needs to be signed by the CA:\n\n```console\nopenssl req -new -out server.csr -key server.pem\n```\n>**req**: certificate request and certification utility  \n>**new**: create new request file file  \n>**out**: file name for the certificate signing request (.csr)  \n> **key**: file name of the key to be certified  \n\n\n+ Your output should look like this:\n\n\n```console\nC:\\Users\\schue>openssl req -new -out server.csr -key server.pem\nYou are about to be asked to enter information that will be incorporated\ninto your certificate request.\nWhat you are about to enter is what is called a Distinguished Name or a DN.\nThere are quite a few fields but you can leave some blank\nFor some fields there will be a default value,\nIf you enter \'.\', the field will be left blank.\n-----\nCountry Name (2 letter code) [AU]:DE\nState or Province Name (full name) [Some-State]:Bavaria\nLocality Name (eg, city) []:Munich\nOrganization Name (eg, company) [Internet Widgits Pty Ltd]:UniMuni\nOrganizational Unit Name (eg, section) []:EL\nCommon Name (e.g. server FQDN or YOUR name) []:schue\nEmail Address []:.\n\nPlease enter the following \'extra\' attributes\nto be sent with your certificate request\nA challenge password []:0815\nAn optional company name []:IT\n\nC:\\Users\\schue>\n```\n\n6. Verify and sign the certificate request: The last step with OpenSSL is to sign the server request through the CA to get the broker certificate:\n\n```console\nopenssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out cert.der -days 360\n```\n\n>**x509**: certificate display and signing utility  \n>**req**: a certificate request is expected as input  \n>**in**: input file for the certificate  \n>**CA**: specifies the file to be signed  \n>**CAkey**: CA private key to sign the certificate with  \n>**Cacreateserial**: the serial number file gets created if it does not exist  \n>**out**: output file name  \n>**days**: how long the certificate shall be valid  \n\n7. Convert your .pem file to .der file:\n\n```console\nopenssl rsa -inform pem -in server.pem -outform der -out key.der\n```\n\n8. Finally move the created files to the ESP32: To do so get mpfshell:\n\n> [Click here if the command below does not work.](https://gist.github.com/hardye/657385210c5d613e69cb5ba95e8c57a7)\n\n```console\npip3 install mpfshell\n```\n\n+ Make sure your device is not connected via a Pymakr console or anywhere else. Then enter (on Windows) (and insert YOUR port number):\n\n```console\nmpfshell -c "open COMx"\n```\n* and on Linux:\n```console\nmpfshell -c "open ttyUSBx"\n```\n\n* Now you can list the files on the device with:\n\n```console\nmpfs> ls\n```\n\n* To upload e.g. the local file `boot.py` to the device use:\n\n```console\nmpfs> put boot.py\n```\n\n+ You need to navigate to the directory  (`cd`) which contains the `boot.py` first.\n\n> [Get more mpf commands **here**](https://github.com/wendlers/mpfshell)\n\n9. Lastly, we can adjust our code to use the "secured" connection (we are still connectiong to a public test broker! But you get the main idea, in case you would like to implement a TLS connection to your own broker).  \n\n+ **Add** the following lines to your `boot.py`:\n\n```python\nwith open(\'key.der\') as f:\n  key_data = f.read()\nwith open(\'cert.der\') as f:\n  cert_data = f.read()\n```\n+ **Change** the `connect_and_subscribe()` in your `main.py`:\n\n```python\ndef connect_and_subscribe():\n  global client_id, mqtt_server, topic_sub, key_data, cert_data\n  client = MQTTClient(client_id, mqtt_server, port = 8883, user=b"emqx", password=b"0815"\n                      , ssl=True, ssl_params={\'key\': key_data, \'cert\': cert_data})\n  client.set_callback(sub_cb)\n  client.connect()\n  client.subscribe(topic_sub)\n  print(\'Connected to %s MQTT broker, subscribed to %s topic\' % (mqtt_server, topic_sub))\n  return client\n```\n\n> My output:\n```console\nUploading project (main folder)...\nNot safe booting, disabled in settings\n\nUploading to /...\nReading file status\nNo files to upload\nUpload done, resetting board...\nOKets Jun  8 2016 00:22:57\n\nrst:0xc (SW_CPU_RESET),boot:0x13 (SPI_FAST_FLASH_BOOT)\nconfigsip: 0, SPIWP:0xee\nclk_drv:0x00,q_drv:0x00,d_drv:0x00,cs0_drv:0x00,hd_drv:0x00,wp_drv:0x00\nmode:DIO, clock div:2\nload:0x3fff0030,len:5656\nload:0x40078000,len:12696\nload:0x40080400,len:4292\nentry 0x400806b0\nConnection successful\n(\'194.xxx.xxx.xxx\', \'254.xxx.xxx.xxx\', \'194.xxx.xxx.xxx\', \'194.xxx.xxx.xxx\')\nConnected to broker.emqx.io MQTT broker, subscribed to b\'OnBoard_Temp\' topic\n(b\'OnBoard_Temp\', b\'Message #0: Temperature: 40.0 degree Celsius\')\n(b\'OnBoard_Temp\', b\'Message #1: Temperature: 40.0 degree Celsius\')\n(b\'OnBoard_Temp\', b\'Message #2: Temperature: 40.0 degree Celsius\')\n(b\'OnBoard_Temp\', b\'Message #3: Temperature: 40.0 degree Celsius\')\n```\n\n+ Yeay, we are publishing our data over TLS.\n\n_________________________   \n\n## Hints and pitfalls\n\n- You may need to open the port 8883 in your firewall.\n\n- You can move the cert files to your VS Code workspace and hit the upload button. But it will not upload the certificates to your device!\n\n- You can also use ampy to move files to the ESP32. This is the most common way online. Nevertheless, ampy did not work on my system.\n\n- Since my colleagues encountered problems with mpfshell and ampy on their systems, I am giving you a last option: You can use the uPyCraft IDE to transfer files to your ESP32. Installation instructions for: [Windows](https://randomnerdtutorials.com/install-upycraft-ide-windows-pc-instructions/), [MacOS X](https://randomnerdtutorials.com/install-upycraft-ide-mac-os-x-instructions/) and [Linux](https://randomnerdtutorials.com/install-upycraft-ide-linux-ubuntu-instructions/).\n\n_________________________\n\n## Useful Resources for Own Searches\n\n[Click here for **another introduction to TLS**](https://mcuoneclipse.com/2017/04/14/introduction-to-security-and-tls-transport-security-layer/)\n\n[Click here for **another approach for streaming data from ESP32 using MicroPython and MQTT** (umqtt.robust)](https://github.com/gloveboxes/ESP32-MicroPython-BME280-MQTT-Sample/blob/master/Micropython.md)\n\n[ENOENT ERROR](https://github.com/micropython/micropython-esp32/issues/90)\n\n_________________________    \n\n\n## Further Inputs\n\nYou can also encrypt your message before sending it. In our case it will not work. Can you find out why? It would work with a separate broker (with own code). Here are two useful links to begin with:\nhttps://forum.micropython.org/viewtopic.php?t=6726\nhttps://docs.micropython.org/en/latest/library/cryptolib.html\n\n> Steve: "Encrypting the MQTT payload rather than the link has the advantage that the data is encrypted end to end and not just between the broker and the client.  \nIt also means that the intermediate brokers don’t need to support SSL and that you don’t need to obtain and install certificates."    \n> Unknown: "It is always a good idea to use further security mechanisms such as payload encryption, payload signature verifications, and authorization mechanisms. In general, more security never hurts."  \nDo you agree?\nWhat do you think about these quotations?\n\n_____________________\n\nCongratulations! You are at the end of my tutorial. Maybe you would like to set up your own broker on a Rpy next?\n\n_________________________\n\n## Source(s)\n\n- Enable Secure Communication with TLS and the Mosquitto Broker: https://mcuoneclipse.com/2017/04/14/enable-secure-communication-with-tls-and-the-mosquitto-broker/\n\n- Mosquitto SSL Configuration: http://www.steves-internet-guide.com/mosquitto-tls/\n\n- OpenSSL Command Line Utilities: https://wiki.openssl.org/index.php/Command_Line_Utilities\n\n\n\n\n',s.user={name:a,username:"bassparanoya",twitter_username:n,github_username:a,website_url:n,profile_image:"https://res.cloudinary.com/practicaldev/image/fetch/s--k92eBTs9--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/795000/c871ef54-83cb-402e-9af7-2c7b2757be51.png",profile_image_90:"https://res.cloudinary.com/practicaldev/image/fetch/s--9ye_tiWF--/c_fill,f_auto,fl_progressive,h_90,q_auto,w_90/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/795000/c871ef54-83cb-402e-9af7-2c7b2757be51.png"},{layout:"default",data:[{}],fetch:{"data-v-70afb46a:0":{article:s}},error:n,state:{currentArticle:s},serverRendered:!0,routePath:"/bassparanoya/957505",config:{_app:{basePath:"/nuxtstop/",assetsPath:"/nuxtstop/_nuxt/",cdnURL:n}}}}(null,"2022-01-16T19:24:41Z",{},"https://dev.to/bassparanoya/esp32-micropython-mqtt-tls-28fd","BoozTheBoss")</script><script src="/nuxtstop/_nuxt/f6e87fb.js" defer></script><script src="/nuxtstop/_nuxt/dc9ce94.js" defer></script><script src="/nuxtstop/_nuxt/6474719.js" defer></script><script src="/nuxtstop/_nuxt/9b75090.js" defer></script><script src="/nuxtstop/_nuxt/18df600.js" defer></script>
  </body>
</html>
