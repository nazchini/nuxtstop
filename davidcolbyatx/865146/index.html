<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Filter, search, and sort tables with Rails and Turbo Frames</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="Using Nuxt.js fetch() hook to build dev.to with a new look"><meta data-n-head="ssr" name="format-detection" content="telephone=no"><base href="/nuxtstop/"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,500,600&display=swap"><link rel="preload" href="/nuxtstop/_nuxt/f6e87fb.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/6474719.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/9b75090.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/18df600.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/dc9ce94.js" as="script"><style data-vue-ssr-id="c650fd98:0 af4684f0:0 a9c71758:0 dcafa518:0 4b9cec49:0 b093d766:0 9d98bcb4:0 6b6a11ea:0 0248ed80:0 ea8e4264:0">html{box-sizing:border-box;font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}*,:after,:before{box-sizing:inherit}html{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}*,:after,:before{border:0 solid #e0e0e0}blockquote,body,dd,dl,figure,h1,h2,h3,h4,h5,h6,p,pre{margin:0}button{background:0 0;padding:0}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}hr{border-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:inherit;opacity:.5}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:inherit;opacity:.5}input::placeholder,textarea::placeholder{color:inherit;opacity:.5}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit;font-family:sans-serif}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit;font-family:inherit;font-size:100%}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;overflow:auto;word-break:break-word;white-space:normal}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}html{height:100%;font-size:18px;-ms-overflow-style:scrollbar;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}@media(min-width:640px){html{font-size:20px}}body{height:100%;min-width:320px;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:400;line-height:1.5;color:#000;background-color:#eff4f7;-webkit-text-rendering:optimizeLegibility;text-rendering:optimizeLegibility;font-synthesis:none;font-kerning:normal;font-feature-settings:"normal","kern";-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-overflow-scrolling:touch;overflow-x:hidden;overflow-y:scroll}h1,h2,h3,h4,h5,h6{color:#000;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:600;font-feature-settings:"normal";line-height:1.2}pre{background:#29292e;border-radius:2px;overflow:auto;padding:1rem;color:#eff1f9;line-height:1.42em;font-size:13px}@media screen and (min-width:380px){pre{font-size:15px}}pre code{background:#29292e;color:#eff0f9;white-space:pre}div.highlight pre.highlight code{font-size:inherit;padding:0}div.inner-comment div.body div.highlight pre.highlight{background:#29292e}div.inner-comment div.body div.highlight pre.highlight code{font-size:inherit;white-space:inherit;background:inherit;color:inherit}.highlight .hll{background-color:#49483e}.highlight{background:#29292e;color:#f8f8f2}.highlight .c{color:grey}.highlight .err{text-shadow:0 0 7px #f9690e}.highlight .k{color:#f39c12}.highlight .l{color:plum}.highlight .n{color:#f8f8f2}.highlight .o{color:#f9690e}.highlight .p{color:#f8f8f2}.highlight .c1,.highlight .ch,.highlight .cm,.highlight .cp,.highlight .cpf,.highlight .cs{color:grey}.highlight .gd{color:#f9690e}.highlight .ge{font-style:italic}.highlight .gi{color:#7ed07e}.highlight .gs{font-weight:700}.highlight .gu{color:grey}.highlight .kc,.highlight .kd{color:#f39c12}.highlight .kn{color:#f9690e}.highlight .kp,.highlight .kr,.highlight .kt{color:#f39c12}.highlight .ld{color:#f2ca27}.highlight .m{color:plum}.highlight .s{color:#f2ca27}.highlight .na{color:#7ed07e}.highlight .nb{color:#f8f8f2}.highlight .nc{color:#7ed07e}.highlight .no{color:#f39c12}.highlight .nd{color:#7ed07e}.highlight .ni{color:#f8f8f2}.highlight .ne,.highlight .nf{color:#7ed07e}.highlight .nl,.highlight .nn{color:#f8f8f2}.highlight .nx{color:#7ed07e}.highlight .py{color:#f8f8f2}.highlight .nt{color:#f9690e}.highlight .nv{color:#f8f8f2}.highlight .ow{color:#f9690e}.highlight .w{color:#f8f8f2}.highlight .mb,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo{color:plum}.highlight .dl,.highlight .s2,.highlight .sa,.highlight .sb,.highlight .sc,.highlight .sd{color:#f2ca27}.highlight .se{color:plum}.highlight .s1,.highlight .sh,.highlight .si,.highlight .sr,.highlight .ss,.highlight .sx{color:#f2ca27}.highlight .bp{color:#f8f8f2}.highlight .fm{color:#7ed07e}.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{color:#f8f8f2}.highlight .il{color:plum}.vue-content-placeholders-heading__img,.vue-content-placeholders-heading__subtitle,.vue-content-placeholders-heading__title,.vue-content-placeholders-img,.vue-content-placeholders-text__line{background:#bfcdec!important}.vue-content-placeholders-is-animated .vue-content-placeholders-heading__img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__subtitle:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__title:before,.vue-content-placeholders-is-animated .vue-content-placeholders-img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-text__line:before{background:linear-gradient(90deg,transparent 0,#d3ddf9 15%,transparent 30%)!important}header[data-v-27046cca]{max-width:1280px;margin:auto;padding:1rem;height:6rem;border-bottom:1px solid rgba(0,0,0,.2)}header .logo-wrapper[data-v-27046cca],header[data-v-27046cca]{display:flex;align-items:center;justify-content:space-between}header .logo-wrapper[data-v-27046cca]{margin:0 .5rem}header .logo-wrapper svg[data-v-27046cca]{width:3rem;height:100%}header .logo-wrapper .name-wrapper[data-v-27046cca]{margin-left:.6em}header .logo-wrapper .name-wrapper .subtitle[data-v-27046cca]{font-size:1rem}header .logo-wrapper .name-wrapper .app-name[data-v-27046cca]{font-weight:700;font-size:2.25rem;line-height:1.25}header nav[data-v-27046cca]{letter-spacing:-.025rem;font-weight:600;text-transform:uppercase}header nav ul[data-v-27046cca]{display:flex}header nav ul li[data-v-27046cca]{margin:0 .5rem}header nav ul li a[data-v-27046cca]{box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;padding:.25rem 1rem;border-radius:.5rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}header nav ul li a[data-v-27046cca]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header nav ul li a.nuxt-link-exact-active[data-v-27046cca]{cursor:default}header nav ul li a.nuxt-link-exact-active[data-v-27046cca],header nav ul li a[data-v-27046cca]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}.page-wrapper[data-v-10d06ee8]{max-width:1280px;margin:auto;padding:1rem}.article-content-wrapper[data-v-10d06ee8]{display:flex;flex-direction:column;align-items:center;margin:auto auto 2rem}@media(min-width:1024px){.article-content-wrapper[data-v-10d06ee8]{align-items:normal;flex-direction:row}}.article-content-wrapper .article-block[data-v-10d06ee8]{width:100%;max-width:880px}@media(min-width:1024px){.article-content-wrapper .article-block[data-v-10d06ee8]{margin-right:1rem;width:66.66666%;margin-bottom:2rem}}.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{max-width:880px;width:100%;position:relative}@media(min-width:1024px){.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{display:block;width:33.33333%}}.article-content-wrapper .aside-username-wrapper .aside-username-block[data-v-10d06ee8]{position:-webkit-sticky;position:sticky;top:1rem}@media(min-width:1280px){.comments-block[data-v-10d06ee8]{margin:.5rem}}article[data-v-70afb46a]{padding:.5rem;border-radius:1rem}header h1[data-v-70afb46a],header[data-v-70afb46a]{margin-bottom:1rem}header h1[data-v-70afb46a]{font-size:2.25rem;letter-spacing:-.025rem}header .tags[data-v-70afb46a]{display:flex;flex-wrap:wrap;margin-bottom:1.5rem}header .tags .tag[data-v-70afb46a]{font-weight:500;line-height:1;padding:.5rem;margin:0 .5rem .5rem 0;border-radius:.25rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db}header .tags .tag[data-v-70afb46a]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header .tags .tag[data-v-70afb46a]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}header .image-wrapper[data-v-70afb46a]{position:relative;padding-bottom:56.25%;background-color:#d4dfe8;margin-bottom:1.5rem;border-radius:.5rem;overflow:hidden}@media(min-width:834px){header .image-wrapper[data-v-70afb46a]{margin-bottom:1.5rem}}header .image-wrapper img[data-v-70afb46a]{position:absolute;top:0;left:0;width:100%;height:100%;-o-object-fit:cover;object-fit:cover}header .meta[data-v-70afb46a]{line-height:1;font-size:.875rem;text-transform:uppercase;font-weight:500;letter-spacing:-.025rem;display:flex;align-items:center;justify-content:space-between}header .meta .scl[data-v-70afb46a]{display:flex}header .meta .scl span[data-v-70afb46a]{display:flex;align-items:center;margin-right:1rem}header .meta .scl span svg[data-v-70afb46a]{margin-right:.25rem}header .meta .scl .comments[data-v-70afb46a]{cursor:pointer}[data-v-70afb46a] .content .ltag__user{display:none}[data-v-70afb46a] .content iframe{max-width:100%}[data-v-70afb46a] .content h1{font-size:1.875rem}[data-v-70afb46a] .content h1,[data-v-70afb46a] .content h2{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h2{font-size:1.5rem}[data-v-70afb46a] .content h3{font-size:1.25rem}[data-v-70afb46a] .content h3,[data-v-70afb46a] .content h4{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h4{font-size:1rem}[data-v-70afb46a] .content a{color:#6e87d2}[data-v-70afb46a] .content p{margin-bottom:1rem;line-height:1.4}[data-v-70afb46a] .content p code{background-color:#d2f3e1;border-radius:.25rem;padding:.25rem}[data-v-70afb46a] .content img{width:100%;border-radius:.5rem}[data-v-70afb46a] .content .highlight{margin-bottom:1rem;border-radius:.5rem}[data-v-70afb46a] .content ul{list-style:numeral;margin-bottom:1rem}[data-v-70afb46a] .content ul li p{margin-bottom:0}[data-v-70afb46a] .content ol{margin-bottom:1rem}aside[data-v-37984f8c]{padding:1rem;background-color:#dfe8ef;border-radius:1rem}aside .username-heading[data-v-37984f8c]{display:flex;margin-bottom:1rem}aside .username-heading[data-v-37984f8c]:hover{color:#6e87d2}aside .username-heading img[data-v-37984f8c]{width:3rem;height:3rem;border-radius:50%;margin-right:1rem}aside .username-heading .text[data-v-37984f8c]{display:flex;flex-direction:column;justify-content:center}aside .username-heading .text a[data-v-37984f8c]{line-height:1}aside .username-heading .text a[data-v-37984f8c]:first-child{font-size:1.25rem;font-weight:500;letter-spacing:-.025rem;margin-bottom:.25rem}aside .username-heading .text a[data-v-37984f8c]:last-child{color:#999;font-size:.875rem}aside .username-heading.loading[data-v-37984f8c]{display:block}aside .f-button[data-v-37984f8c]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}aside .f-button[data-v-37984f8c]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}aside .f-button[data-v-37984f8c]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}aside .info>div[data-v-37984f8c]{margin-bottom:.5rem}aside .info .title[data-v-37984f8c]{font-size:.666666rem;letter-spacing:-.0125rem;font-weight:500;color:#999;text-transform:uppercase;margin-bottom:.1rem}aside .info .content[data-v-37984f8c]{font-size:.875rem;line-height:1.4}.add-comment[data-v-8c4375bc]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}.add-comment[data-v-8c4375bc]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}.add-comment[data-v-8c4375bc]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}footer[data-v-22cb8fd0]{padding:2rem;text-align:center;display:flex;align-items:center;justify-content:center}footer span[data-v-22cb8fd0]{display:inline-block;line-height:1;text-transform:uppercase;letter-spacing:-.025rem;font-size:.75rem;font-weight:500}footer a svg[data-v-22cb8fd0]{width:3rem;height:3rem;margin:0 .5rem}footer a .nuxt-icon[data-v-22cb8fd0]{width:2.5rem;height:2.5rem;margin:0 .25rem}</style>
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><div id="__layout"><div><header data-v-27046cca><a href="/nuxtstop/" class="logo-wrapper nuxt-link-active" data-v-27046cca><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-27046cca><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-27046cca></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-27046cca></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-27046cca></path></svg> <div class="name-wrapper" data-v-27046cca><span class="app-name" data-v-27046cca>Nuxtstop</span> <p class="subtitle" data-v-27046cca>For all things nuxt.js</p></div></a> <nav data-v-27046cca><ul data-v-27046cca><li data-v-27046cca><a href="/nuxtstop/" class="nuxt-link-active" data-v-27046cca>
          New
        </a></li><li data-v-27046cca><a href="/nuxtstop/top" data-v-27046cca>
          Top
        </a></li></ul></nav></header> <div class="page-wrapper" data-v-10d06ee8><div class="article-content-wrapper" data-v-10d06ee8><article data-fetch-key="data-v-70afb46a:0" class="article-block" data-v-70afb46a data-v-10d06ee8><header data-v-70afb46a><h1 data-v-70afb46a>Filter, search, and sort tables with Rails and Turbo Frames</h1> <div class="tags" data-v-70afb46a><a href="/nuxtstop/t/rails" class="tag" data-v-70afb46a>
          #rails
        </a><a href="/nuxtstop/t/tutorial" class="tag" data-v-70afb46a>
          #tutorial
        </a><a href="/nuxtstop/t/ruby" class="tag" data-v-70afb46a>
          #ruby
        </a><a href="/nuxtstop/t/hotwire" class="tag" data-v-70afb46a>
          #hotwire
        </a></div> <div class="image-wrapper" data-v-70afb46a><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--fqAGZQsZ--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jiw86poahdi4mzq2xonj.png" alt="Filter, search, and sort tables with Rails and Turbo Frames" data-v-70afb46a></div> <div class="meta" data-v-70afb46a><div class="scl" data-v-70afb46a><span data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M16.4444 3C14.6733 3 13.0333 3.94162 12 5.34C10.9667 3.94162 9.32667 3 7.55556 3C4.49222 3 2 5.52338 2 8.625C2 14.8024 11.0267 20.586 11.4122 20.829C11.5922 20.9426 11.7956 21 12 21C12.2044 21 12.4078 20.9426 12.5878 20.829C12.9733 20.586 22 14.8024 22 8.625C22 5.52338 19.5078 3 16.4444 3Z" fill="#FF0000" data-v-70afb46a data-v-70afb46a></path></svg>
            40
          </span> <span class="comments" data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M6.11765 22H4.94118L5.64706 21.05C6.11765 20.3969 6.41176 19.5656 6.58824 18.5563C3.64706 17.1906 2 14.6375 2 11.3125C2 6.20625 5.82353 3 12 3C18.1765 3 22 6.20625 22 11.3125C22 16.5375 18.2353 19.625 12 19.625H11.5882C10.6471 20.7531 9 22 6.11765 22ZM12 4.1875C6.47059 4.1875 3.17647 6.85937 3.17647 11.3125C3.17647 15.1125 5.47059 16.8938 7.41177 17.6656L7.82353 17.8437L7.76471 18.3187C7.64706 19.2687 7.47059 20.1 7.11765 20.8125C9.05882 20.575 10.1765 19.5656 10.8235 18.7344L11 18.4969H12C19.9412 18.4969 20.8235 13.5094 20.8235 11.3719C20.8235 6.85938 17.5294 4.1875 12 4.1875Z" fill="black" data-v-70afb46a data-v-70afb46a></path></svg>
            2
          </span></div> <time data-v-70afb46a>Oct 15 '21</time></div></header> <div class="content" data-v-70afb46a><p>Today we are going to build a table that can be sorted, searched, and filtered all at once, using Ruby on Rails, Turbo Frames, a tiny Stimulus controller, and a little bit of Tailwind for styling.</p>

<p>We will start with a sortable, Turbo Frame-powered table that displays a list of Players from a database. We built this sortable table in a <a href="https://www.colby.so/posts/sortable-table-with-rails-and-turbo-frames">previous article</a> — you might find it helpful to start with that article, especially if you are new to Turbo.</p>

<p>When we are finished, users will be able to search for players by name, filter them by their team, and sort the table. Sorting, searching, and filtering all work together, in any combination, and they each occur without a full page turn. The end result will work like this:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--ULha2HzU--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/abgabcu9q2wbxwc0dukx.gif" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--ULha2HzU--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/abgabcu9q2wbxwc0dukx.gif" alt="A screen recording of a user interacting with a table on a website. They click column headers to sort the table, use a drop down menu to filter the table by a specific team, and type in a search box to filter the table by name" loading="lazy" width="880" height="503" data-animated="true"></a></p>

<p>This article is intended for folks who are comfortable with Ruby and Rails code. You won’t need any prior experience with Turbo Frames or Stimulus.</p>

<p>Let’s dive in!</p>

<h2>
  <a name="project-setup" href="#project-setup">
  </a>
  Project setup
</h2>

<p>If you want to follow along with this article and you haven’t already completed the <a href="https://www.colby.so/posts/sortable-table-with-rails-and-turbo-frames">sortable table article</a> locally, you’ll want to begin by cloning <a href="https://github.com/DavidColby/player_sorting_frames">this Github repo</a>. If you have completed the sortable table article, this one picks up exactly where that one ends, so go ahead and work from where that article finished.</p>

<p>To set up the application after cloning from Github, from your terminal:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>bundle install
yarn install
rails db:setup
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Once the application is ready, checkout the <a href="https://github.com/DavidColby/player_sorting_frames/tree/sortable">sortable branch</a>, where this article picks up, and then run <code>bin/dev</code> to compile assets and start your development server.</p>

<p>After you start the server, head to <a href="http://localhost:3000">http://localhost:3000</a> and see that you have a seeded database of players and that you can sort the table by clicking on each column header.</p>

<p>If you’re curious how the the sorting works, the sortable tables article goes through the frame-powered sorting mechanism in detail.</p>

<p>With setup complete, let's start building!</p>

<h2>
  <a name="add-a-search-form" href="#add-a-search-form">
  </a>
  Add a search form
</h2>

<p>We’ll start with a simple search form, added inside the <code>players</code> turbo frame in  <code>app/views/players/_players.html.erb</code>.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight erb"><code><span class="cp">&lt;%=</span> <span class="n">turbo_frame_tag</span> <span class="s2">"players"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"shadow overflow-hidden rounded border-b border-gray-200"</span> <span class="k">do</span> <span class="cp">%></span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"flex justify-end mb-1"</span><span class="nt">></span>
    <span class="cp">&lt;%=</span> <span class="n">form_with</span> <span class="ss">url: </span><span class="n">list_players_path</span><span class="p">,</span> <span class="ss">method: :get</span> <span class="k">do</span> <span class="o">|</span><span class="n">form</span><span class="o">|</span> <span class="cp">%></span>
      <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">placeholder: </span><span class="s2">"Search by name"</span><span class="p">,</span> <span class="ss">value: </span><span class="n">params</span><span class="p">[</span><span class="ss">:name</span><span class="p">],</span> <span class="ss">class: </span><span class="s2">"border border-blue-500 rounded p-2"</span> <span class="cp">%></span>
      <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">button</span> <span class="s2">"Search"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"bg-blue-500 text-white p-2 rounded-sm"</span> <span class="cp">%></span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%></span>
  <span class="nt">&lt;/div></span>
  <span class="c">&lt;!-- Snip the table --></span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%></span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>This is a standard-issue Rails search form. When the form is submitted, a GET request is dispatched and <code>PlayersController#list</code> responds to the request. For now, the form requires the user to click the Search button to submit the search request.</p>

<p>Next, we’ll update the <code>list</code> method in <code>app/controllers/players_controller.rb</code> to filter the list of players when the search form is submitted:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">list</span>
  <span class="n">players</span> <span class="o">=</span> <span class="no">Player</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:team</span><span class="p">)</span>
  <span class="n">players</span> <span class="o">=</span> <span class="n">players</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'name ilike ?'</span><span class="p">,</span> <span class="s2">"%</span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="ss">:name</span><span class="p">]</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:name</span><span class="p">].</span><span class="nf">present?</span>
  <span class="n">players</span> <span class="o">=</span> <span class="n">players</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="ss">:column</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="ss">:direction</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="n">render</span><span class="p">(</span><span class="ss">partial: </span><span class="s1">'players'</span><span class="p">,</span> <span class="ss">locals: </span><span class="p">{</span> <span class="ss">players: </span><span class="n">players</span> <span class="p">})</span>
<span class="k">end</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Here we’ve got a clunky, functional implementation of searching by name — when the <code>name</code> parameter from the form’s text_field is present, we run a case insensitive query for players in the database with a name that matches the search query.</p>

<p>With these changes in place, refresh the page, type a query into the search form and submit it. You should see the players list update with the results of your query.</p>

<p>You’ll notice right away that searching clears any previously applied sorting on the table, and sorting the table clears out any search. So we’ve got a search form, but we have to click to submit the form and doing so clears out the user’s sorting preference.</p>

<p>We’ll fix both of those issues, starting with remove the submit button and searching as the user types instead.</p>

<h3>
  <a name="realtime-searching" href="#realtime-searching">
  </a>
  Real-time searching
</h3>

<p>We’ll use a small Stimulus controller to submit the search form as the user types. First, generate the Stimulus controller with the generator built in to <code>stimulus-rails</code>. From your terminal:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>rails g stimulus search_form
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Then, fill that controller in with:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight javascript"><code><span class="c1">// app/javascript/controllers/search_form_controller.js</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Controller</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@hotwired/stimulus</span><span class="dl">"</span>

<span class="k">export</span> <span class="k">default</span> <span class="kd">class</span> <span class="kd">extends</span> <span class="nx">Controller</span> <span class="p">{</span>
  <span class="kd">static</span> <span class="nx">targets</span> <span class="o">=</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">form</span><span class="dl">"</span> <span class="p">]</span>

  <span class="nx">search</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">timeout</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=></span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">formTarget</span><span class="p">.</span><span class="nx">requestSubmit</span><span class="p">()</span>
    <span class="p">},</span> <span class="mi">200</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>This controller’s <code>search</code> function calls <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLFormElement/requestSubmit">requestSubmit</a> on a <code>form</code> target. Since we’ll call this <code>search</code> function as the user is typing in a text input, we’ve add <code>clearTimeout</code> and <code>setTimeout</code> to ensure that the form isn’t submitted every time the user types a new character.</p>

<p>Note that <code>requestSubmit</code> needs a <a href="https://github.com/javan/form-request-submit-polyfill">polyfill</a> for support on Safari and IE11. As an alternative to <code>requestSubmit</code>, if you are using <code>Rails/ujs</code> in your application, <code>Rails.fire(this.formTarget, 'submit')</code> works without a polyfill.</p>

<p>With the Stimulus controller ready to go, next we’ll connect that controller the search form:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight erb"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"flex justify-end mb-1"</span><span class="nt">></span>
  <span class="cp">&lt;%=</span> <span class="n">form_with</span> <span class="ss">url: </span><span class="n">list_players_path</span><span class="p">,</span> <span class="ss">method: :get</span><span class="p">,</span> <span class="ss">data: </span><span class="p">{</span> <span class="ss">controller: </span><span class="s2">"search-form"</span><span class="p">,</span> <span class="ss">search_form_target: </span><span class="s2">"form"</span><span class="p">,</span> <span class="ss">turbo_frame: </span><span class="s2">"players"</span> <span class="p">}</span> <span class="k">do</span> <span class="o">|</span><span class="n">form</span><span class="o">|</span> <span class="cp">%></span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:name</span><span class="p">,</span>
      <span class="ss">placeholder: </span><span class="s2">"Search by name"</span><span class="p">,</span>
      <span class="ss">class: </span><span class="s2">"border border-blue-500 rounded p-2"</span><span class="p">,</span>
      <span class="ss">autocomplete: </span><span class="s2">"off"</span><span class="p">,</span>
      <span class="ss">data: </span><span class="p">{</span> <span class="ss">action: </span><span class="s2">"input->search-form#search"</span> <span class="p">}</span>
    <span class="cp">%></span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%></span>
<span class="nt">&lt;/div></span>
<span class="cp">&lt;%=</span> <span class="n">turbo_frame_tag</span> <span class="s2">"players"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"shadow overflow-hidden rounded border-b border-gray-200"</span> <span class="k">do</span> <span class="cp">%></span>
<span class="c">&lt;!-- Snip table --></span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%></span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Here we first moved the search form outside of the <code>players</code> <code>turbo-frame</code>. This is necessary because if the search form is inside of the turbo frame, the search input will be reset every time the <code>players</code> frame is rerendered (meaning every time our search form is submitted), like this:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--idbe90EG--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/99ptawtf1q9kjuqgp718.gif" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--idbe90EG--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/99ptawtf1q9kjuqgp718.gif" alt="A screen recording of a user typing in a search form above a table with a list of players. When they finish typing the table updates based on their query and the search form they were typing is reset" loading="lazy" width="880" height="502" data-animated="true"></a></p>

<p>Because the form is now outside of the frame, we add a <code>data-turbo-frame</code> to target the <code>players</code> frame. This <a href="https://turbo.hotwired.dev/handbook/frames#targeting-navigation-into-or-out-of-a-frame">tells Turbo</a> to use the response from the form submission to replace the content of the players frame.</p>

<p>We also added <code>data-controller="search-form"</code> and <code>data-search_form_target="form"</code> to the form element. These Stimulus attributes <a href="https://stimulus.hotwired.dev/reference/controllers#identifiers">connect</a> the <code>search-form</code> controller to the DOM and set the <code>form</code> <a href="https://stimulus.hotwired.dev/reference/targets#attributes-and-names">target</a>.</p>

<p>Finally, we add <code>data-action=“input->search-form#search”</code> to the <code>name</code> field, which tells Stimulus to call the <code>search</code> function each time the <code>input</code> <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/input_event">event</a> is fired on the name field.</p>

<p>We moved fairly quickly through some core Stimulus concepts here. The <a href="https://stimulus.hotwired.dev/handbook/introduction">Stimulus handbook</a> is a great reference point if you need to spend more time with any of these concepts.</p>

<p>With these changes in place, we can refresh the page and see that search results update as the user types. We still cannot sort and search at the same time though, so let’s tackle that next.</p>

<h2>
  <a name="sorting-and-searching-at-the-same-time" href="#sorting-and-searching-at-the-same-time">
  </a>
  Sorting and searching at the same time
</h2>

<p>The reason we can’t search and sort at the same time is because the <code>list</code> method relies on URL parameters to apply search and filter options. Because the search form doesn’t include the sort parameters and sorting doesn’t include the search parameter, <code>list</code> has no way of retaining sort and search options across requests — every new request to <code>list</code> starts from scratch.</p>

<p>There are a variety of ways to address this issue. The most direct is to move from using <code>params</code> to storing filter options in the <code>session</code>.</p>

<p>Our basic approach will be to use <code>params</code> to update a <code>filters</code> hash in the <code>session</code> object. Since <code>session</code> is maintained across requests, as long as we update the session <code>filters</code> hash with the search and sort <code>params</code> on each request, we can persist search and sort options across requests.</p>

<p>A very ugly implementation of this concept, done directly in the <code>list</code> method looks like this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">list</span>
  <span class="n">session</span><span class="p">[</span><span class="s1">'filters'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">'filters'</span><span class="p">].</span><span class="nf">blank?</span>

  <span class="n">session</span><span class="p">[</span><span class="s1">'filters'</span><span class="p">].</span><span class="nf">merge!</span><span class="p">(</span><span class="n">filter_params</span><span class="p">)</span>
  <span class="n">players</span> <span class="o">=</span> <span class="no">Player</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:team</span><span class="p">)</span>
  <span class="n">players</span> <span class="o">=</span> <span class="n">players</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'players.name ilike ?'</span><span class="p">,</span> <span class="s2">"%</span><span class="si">#{</span><span class="n">session</span><span class="p">[</span><span class="s1">'filters'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">]</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span> <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">'filters'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">].</span><span class="nf">present?</span>
  <span class="n">players</span> <span class="o">=</span> <span class="n">players</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">session</span><span class="p">[</span><span class="s1">'filters'</span><span class="p">][</span><span class="s1">'column'</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">session</span><span class="p">[</span><span class="s1">'filters'</span><span class="p">][</span><span class="s1">'direction'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

  <span class="n">render</span><span class="p">(</span><span class="ss">partial: </span><span class="s1">'players'</span><span class="p">,</span> <span class="ss">locals: </span><span class="p">{</span> <span class="ss">players: </span><span class="n">players</span> <span class="p">})</span>
<span class="k">end</span>

<span class="kp">private</span>

<span class="k">def</span> <span class="nf">filter_params</span>
  <span class="n">params</span><span class="p">.</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:column</span><span class="p">,</span> <span class="ss">:direction</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Here we ensure that <code>session['filters']</code> is a hash, update its value by merging in whitelisted <code>filter_params</code> and then use the the <code>filters</code> hash to search for players by name and order the list of players, as appropriate.</p>

<p>This ugly code is fully functional — if you update the <code>list</code> method and add the <code>filter_params</code> method to your controller you will be able to search and sort at the same time; however, this code is clunky, difficult to follow, and quickly becomes unmaintainable as your application grows.</p>

<p>So, if this code is ugly and unmaintainable, why are we looking at it?</p>

<p>Because we are going to refactor it into something neater and more scalable. Before we do that it is helpful to see what the most direct implementation can be so we can understand what is happening at a basic level.</p>

<p>When we’re done, we’ll still store <code>params</code> in a hash in the <code>session</code> object, and we’ll still use the hash values to query the database based on the user’s preferences. Our code will be nicer, but it’ll still be the same basic concept.</p>

<p>Let’s refactor this code next.</p>

<h2>
  <a name="building-a-filterable-concern" href="#building-a-filterable-concern">
  </a>
  Building a Filterable concern
</h2>

<p>To make our filtering code more scalable and less error prone, we are going to start with a generalized <code>Filterable</code> <a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveSupport/Concern.html">concern</a>. We’ll include <code>Filterable</code> in the <code>PlayersController</code> and use it to filter <code>players</code>.</p>

<p><code>Filterable</code> won’t know anything about the specifics of querying <code>Players</code>, instead it will just implement logic to store query parameters in the session. Once the values are stored, they’ll be used to apply filters.</p>

<p>First, create the filterable concern. From your terminal:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>touch app/controllers/concerns/filterable.rb
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Then, fill in <code>filterable.rb</code> with the following:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight ruby"><code><span class="k">module</span> <span class="nn">Filterable</span>
  <span class="k">def</span> <span class="nf">filter!</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
    <span class="n">store_filters</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
    <span class="n">apply_filters</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">store_filters</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
    <span class="n">session</span><span class="p">[</span><span class="s2">"</span><span class="si">#{</span><span class="n">resource</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">underscore</span><span class="si">}</span><span class="s2">_filters"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">unless</span> <span class="n">session</span><span class="p">.</span><span class="nf">key?</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">resource</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">underscore</span><span class="si">}</span><span class="s2">_filters"</span><span class="p">)</span>

    <span class="n">session</span><span class="p">[</span><span class="s2">"</span><span class="si">#{</span><span class="n">resource</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">underscore</span><span class="si">}</span><span class="s2">_filters"</span><span class="p">].</span><span class="nf">merge!</span><span class="p">(</span><span class="n">filter_params_for</span><span class="p">(</span><span class="n">resource</span><span class="p">))</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">filter_params_for</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">permit</span><span class="p">(</span><span class="n">resource</span><span class="o">::</span><span class="no">FILTER_PARAMS</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">apply_filters</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
    <span class="n">resource</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s2">"</span><span class="si">#{</span><span class="n">resource</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">underscore</span><span class="si">}</span><span class="s2">_filters"</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>There’s a lot of code here, let’s break it down.</p>

<p>The <code>filter!</code> method is what we’ll call from the controller to apply filters in response to a request from a user. It takes a <code>resource</code> argument. <code>resource</code> will be an ActiveRecord class, like <code>Player</code>. <code>filter!</code> simply calls out to two internal methods, <code>store_filters</code> and <code>apply_filters</code>, which do the heavy lifting.</p>

<p><code>store_filters</code> ensures that <code>session['class_name_filters']</code> exists, and then writes whitelisted parameters into the session key, replicating the first two lines of our ugly implementation directly in the <code>list</code> method in the last section.</p>

<p>Once the filters are stored, <code>apply_filters</code> calls a <code>filter</code> class method from the class we’re interested in which should return a list of ActiveRecord objects.</p>

<p>You’ll notice here that <code>Filterable</code> isn’t doing much on its own. Instead, it is relying on methods to exist on the class passed in to <code>filter!</code>. This is by design — in a real application, we would likely need to build filtering mechanisms for many different ActiveRecord classes, and each will need to be able to filter by a unique set of columns. Trying to build all of that logic into the <code>Filterable</code> module would quickly become even harder to maintain than tossing everything in the controller.</p>

<p>Rather than building all of that complexity in to <code>Filterable</code>, we instead just rely on the target class to define <code>FILTER_PARAMS</code> and a <code>filter</code> method in whatever way works for that particular class.</p>

<p>Let’s see this in action by updating <code>app/models/player.rb</code> to work with our new <code>Filterable</code> concern.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Player</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:team</span>

  <span class="no">FILTER_PARAMS</span> <span class="o">=</span> <span class="sx">%i[name column direction]</span><span class="p">.</span><span class="nf">freeze</span>

  <span class="n">scope</span> <span class="ss">:by_name</span><span class="p">,</span> <span class="o">-></span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s1">'players.name ilike ?'</span><span class="p">,</span> <span class="s2">"%</span><span class="si">#{</span><span class="n">query</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span> <span class="p">}</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
    <span class="no">Player</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:team</span><span class="p">)</span>
          <span class="p">.</span><span class="nf">by_name</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span>
          <span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">filters</span><span class="p">[</span><span class="s1">'column'</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">filters</span><span class="p">[</span><span class="s1">'direction'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Here we’ve defined the <code>FILTER_PARAMS</code> constant with the three filtering we support on the players table.</p>

<p>Next, we added the <code>by_name</code> scope to handle searching the players table by name.</p>

<p>Finally, we implement <code>filter</code>, which replaces the queries that we previously built in <code>PlayersController#list</code> and makes use of the new <code>by_name</code> scope to be a bit more readable.</p>

<p>With <code>Player</code> set up for filtering, we can update <code>PlayersController</code> to include <code>Filterable</code> and replace the filtering logic in <code>list</code> with the new <code>filter!</code> method.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">PlayersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="kp">include</span> <span class="no">Filterable</span>
  <span class="c1"># snip</span>
  <span class="k">def</span> <span class="nf">list</span>
    <span class="n">players</span> <span class="o">=</span> <span class="n">filter!</span><span class="p">(</span><span class="no">Player</span><span class="p">)</span>
    <span class="n">render</span><span class="p">(</span><span class="ss">partial: </span><span class="s1">'players'</span><span class="p">,</span> <span class="ss">locals: </span><span class="p">{</span> <span class="ss">players: </span><span class="n">players</span> <span class="p">})</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Here we simply include <code>Filterable</code> in the controller and then set the value of <code>players</code> using the <code>filter!</code> method provided by <code>Filterable</code>.</p>

<p>Much nicer, right?</p>

<p>Before moving on, you'll also notice that <code>Filterable</code> is in the <code>controller/concerns</code> directory, but it isn't truly a <a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveSupport/Concern.html">Concern</a>. In our case, controller concerns is the simplest place for this module to live, but we don't need the full functionality of a true concern. You could just as easily place this module in another place if you prefer.</p>

<p>Our last step is to update the views to read values from the session instead of params so that we always display the correct set of applied filters to users. </p>

<p>First, update the table header in <code>_players</code> like this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight erb"><code><span class="nt">&lt;tr></span>
  <span class="nt">&lt;th</span> <span class="na">id=</span><span class="s">"players-name"</span> <span class="na">class=</span><span class="s">"text-left py-3 px-6 uppercase font-semibold text-sm hover:cursor-pointer relative"</span><span class="nt">></span>
    <span class="cp">&lt;%=</span> <span class="n">sort_indicator</span> <span class="k">if</span> <span class="n">session</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="s1">'player_filters'</span><span class="p">,</span> <span class="s1">'column'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"name"</span> <span class="cp">%></span>
    <span class="cp">&lt;%=</span> <span class="n">build_order_link</span><span class="p">(</span><span class="ss">column: </span><span class="s2">"name"</span><span class="p">,</span> <span class="ss">label: </span><span class="s2">"Name"</span><span class="p">)</span> <span class="cp">%></span>
  <span class="nt">&lt;/th></span>
  <span class="nt">&lt;th</span> <span class="na">id=</span><span class="s">"players-team"</span> <span class="na">class=</span><span class="s">"text-left py-3 px-6 uppercase font-semibold text-sm hover:cursor-pointer relative"</span><span class="nt">></span>
    <span class="cp">&lt;%=</span> <span class="n">sort_indicator</span> <span class="k">if</span> <span class="n">session</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="s1">'player_filters'</span><span class="p">,</span> <span class="s1">'column'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"teams.name"</span> <span class="cp">%></span>
    <span class="cp">&lt;%=</span> <span class="n">build_order_link</span><span class="p">(</span><span class="ss">column: </span><span class="s2">"teams.name"</span><span class="p">,</span> <span class="ss">label: </span><span class="s2">"Team"</span><span class="p">)</span> <span class="cp">%></span>
  <span class="nt">&lt;/th></span>
  <span class="nt">&lt;th</span> <span class="na">id=</span><span class="s">"players-seasons"</span> <span class="na">class=</span><span class="s">"text-left py-3 px-6 uppercase font-semibold text-sm hover:cursor-pointer relative"</span><span class="nt">></span>
    <span class="cp">&lt;%=</span> <span class="n">sort_indicator</span> <span class="k">if</span> <span class="n">session</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="s1">'player_filters'</span><span class="p">,</span> <span class="s1">'column'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"seasons"</span> <span class="cp">%></span>
    <span class="cp">&lt;%=</span> <span class="n">build_order_link</span><span class="p">(</span><span class="ss">column: </span><span class="s2">"seasons"</span><span class="p">,</span> <span class="ss">label: </span><span class="s2">"Seasons"</span><span class="p">)</span> <span class="cp">%></span>
  <span class="nt">&lt;/th></span>
<span class="nt">&lt;/tr></span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>We’ve replaced references to <code>params</code> with <code>session.dig</code> calls with this change. When no filters have been applied, <code>session['player_filters']</code> won’t exist, so we use <code>dig</code> to avoid nil errors in those cases.</p>

<p>Next, update <code>app/heleprs/players_helper.rb</code> like this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight ruby"><code><span class="k">module</span> <span class="nn">PlayersHelper</span>
  <span class="k">def</span> <span class="nf">build_order_link</span><span class="p">(</span><span class="n">column</span><span class="p">:,</span> <span class="n">label</span><span class="p">:)</span>
    <span class="k">if</span> <span class="n">column</span> <span class="o">==</span> <span class="n">session</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="s1">'player_filters'</span><span class="p">,</span> <span class="s1">'column'</span><span class="p">)</span>
      <span class="n">link_to</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">list_players_path</span><span class="p">(</span><span class="ss">column: </span><span class="n">column</span><span class="p">,</span> <span class="ss">direction: </span><span class="n">next_direction</span><span class="p">))</span>
    <span class="k">else</span>
      <span class="n">link_to</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">list_players_path</span><span class="p">(</span><span class="ss">column: </span><span class="n">column</span><span class="p">,</span> <span class="ss">direction: </span><span class="s1">'asc'</span><span class="p">))</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">next_direction</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">'player_filters'</span><span class="p">][</span><span class="s1">'direction'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'asc'</span> <span class="p">?</span> <span class="s1">'desc'</span> <span class="p">:</span> <span class="s1">'asc'</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">sort_indicator</span>
    <span class="n">tag</span><span class="p">.</span><span class="nf">span</span><span class="p">(</span><span class="ss">class: </span><span class="s2">"sort sort-</span><span class="si">#{</span><span class="n">session</span><span class="p">[</span><span class="s1">'player_filters'</span><span class="p">][</span><span class="s1">'direction'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Again we’re just replacing params with the equivalent session values so that sorting works correctly all the time and visual indicators are shown consistently.</p>

<p>With those changes in place, refresh the page and see that you can search and sort the table at the same time, and the UI always shows the proper sort indicator.</p>

<p>Nice work making it this far! We spent a good amount of time building a more scalable filtering solution, so let’s wrap up this article by putting that scalable solution to use by adding a filtering option to the table.</p>

<h3>
  <a name="add-filtering-by-team" href="#add-filtering-by-team">
  </a>
  Add filtering by team
</h3>

<p>Right now users can search by player name and sort the table, but they can’t filter by team or season. Let’s add filtering by team to the filter options.</p>

<p>We’re going to use a select input for the Team filter, since <code>team</code> is a <code>belongs_to</code> relationship on the <code>Player</code> class — we’ll have a dropdown menu that displays all available teams by name, each dropdown option will have <code>team_id</code> as the value sent back to the server.</p>

<p>Since we’re using a select input, let’s make it look nice by taking a slight detour to install Tailwind’s forms plugin:</p>

<p>From your terminal:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>yarn add @tailwindcss/forms
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>And then update <code>tailwind.config.js</code> to include the plugin:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight javascript"><code><span class="nx">plugins</span><span class="p">:</span> <span class="p">[</span>
  <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">@tailwindcss/forms</span><span class="dl">'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Incredible stuff.</p>

<p>Back to adding the team filter. We’ll start by adding the team filter to the UI. In the <code>players</code> partial:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight erb"><code><span class="cp">&lt;%=</span> <span class="n">form_with</span> <span class="ss">url: </span><span class="n">list_players_path</span><span class="p">,</span> <span class="ss">method: :get</span><span class="p">,</span> <span class="ss">data: </span><span class="p">{</span> <span class="ss">controller: </span><span class="s2">"search-form"</span><span class="p">,</span> <span class="ss">search_form_target: </span><span class="s2">"form"</span><span class="p">,</span> <span class="ss">turbo_frame: </span><span class="s2">"players"</span> <span class="p">}</span> <span class="k">do</span> <span class="o">|</span><span class="n">form</span><span class="o">|</span> <span class="cp">%></span>
  <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">select</span> <span class="ss">:team_id</span><span class="p">,</span>
    <span class="n">options_for_select</span><span class="p">(</span>
      <span class="no">Team</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">pluck</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:id</span><span class="p">),</span>
      <span class="n">session</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="s1">'player_filters'</span><span class="p">,</span> <span class="s1">'team_id'</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="p">{</span> <span class="ss">include_blank: </span><span class="s1">'All Teams'</span> <span class="p">},</span>
    <span class="ss">class: </span><span class="s2">"border-blue-500 rounded"</span><span class="p">,</span>
    <span class="ss">data: </span><span class="p">{</span> 
      <span class="ss">action: </span><span class="s2">"change->search-form#search"</span> 
    <span class="p">}</span> 
  <span class="cp">%></span>
<span class="c">&lt;!-- Snip the search input --></span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%></span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>This is a regular Rails <code>select</code> helper. In it, we build a list of all teams in the database, set the selected value when one is present (<code>session.dig</code>, again) and fire the <code>search</code> function of the <code>search-form</code> controller each time the select input changes.</p>

<p>Refresh the page, change the team input and see that it doesn't work yet. We haven’t updated <code>Player</code> to support filtering by team yet.</p>

<p>Head to <code>app/models/player.rb</code> and update it like this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight ruby"><code><span class="no">FILTER_PARAMS</span> <span class="o">=</span> <span class="sx">%i[name team_id column direction]</span><span class="p">.</span><span class="nf">freeze</span>

<span class="n">scope</span> <span class="ss">:by_team</span><span class="p">,</span> <span class="o">-></span><span class="p">(</span><span class="n">team_id</span><span class="p">)</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">team_id: </span><span class="n">team_id</span><span class="p">)</span> <span class="k">if</span> <span class="n">team_id</span><span class="p">.</span><span class="nf">present?</span> <span class="p">}</span>

<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
  <span class="no">Player</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:team</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">by_name</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span>
        <span class="p">.</span><span class="nf">by_team</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="s1">'team_id'</span><span class="p">])</span>
        <span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">filters</span><span class="p">[</span><span class="s1">'column'</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">filters</span><span class="p">[</span><span class="s1">'direction'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Now we can start to see the benefit of the work we did in the last section. We can add filtering by a new option with just a few simple changes to the model.</p>

<p>We updated the model to add <code>team_id</code> to the list of valid <code>FILTER_PARAMS</code>, added the <code>by_team</code> scope, and then added <code>by_team</code> to the <code>filters</code> method.</p>

<p>No need to change our controller or touch the <code>Filterable</code> module — updating the model is all we need.</p>

<p>Refresh the page, apply a team filter and see that filtering by team works along with searching by name and sorting. Great work!</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--vBeVhmq9--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/6b7qgskgktg5814w0bmo.gif" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--vBeVhmq9--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/6b7qgskgktg5814w0bmo.gif" alt="A screen recording of a user interacting with a table on a website. They click column headers to sort the table, use a drop down menu to filter the table by a specific team, and type in a search box to filter the table by name" loading="lazy" width="880" height="503" data-animated="true"></a></p>

<h2>
  <a name="filtering-the-index-action" href="#filtering-the-index-action">
  </a>
  Filtering the index action
</h2>

<p>We’ll wrap up this exercise by make a few more small adjustments to avoid weirdness when a user visits the <code>/players</code> with filtering values already saved in their session.</p>

<p>First, now that we have access to the <code>filter!</code> method, we can update the <code>index</code> action to use that method instead of always setting the value of <code>players</code> to all players in the database.</p>

<p>To do that, update <code>index</code> in <code>app/controllers/players_controller.rb</code> like this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">index</span>
  <span class="vi">@players</span> <span class="o">=</span> <span class="n">filter!</span><span class="p">(</span><span class="no">Player</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>With that change in place, we’ll now filter the list of players properly when a user reloads players page after applying filters in a previous request, making the experience on the index page a bit more consistent.</p>

<p>Finally, since we’re using the session values to restore previously applied filters, we need to update the <code>name</code> search field to set its <code>value</code> from the session. Without this change, when the user applies a name search and then refreshes the page, the list of players will be filtered by name, but the search term won’t be visible in the name field.</p>

<p>To fix this issue,  update the name field in the <code>players</code> partial like this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight erb"><code><span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:name</span><span class="p">,</span>
  <span class="ss">placeholder: </span><span class="s2">"Search by name"</span><span class="p">,</span>
  <span class="ss">value: </span><span class="n">session</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="s1">'player_filters'</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">),</span>
  <span class="ss">class: </span><span class="s2">"border border-blue-500 rounded p-2"</span><span class="p">,</span>
  <span class="ss">autocomplete: </span><span class="s2">"off"</span><span class="p">,</span>
  <span class="ss">data: </span><span class="p">{</span> <span class="ss">action: </span><span class="s2">"input->search-form#search"</span> <span class="p">}</span>
<span class="cp">%></span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>With <code>value</code> added to the <code>name</code> field, we’ll always show the correct value to users, even on the initial page load.</p>

<p>With these small changes in places, we’ve now got consistent filtering experience that persists cleanly across requests and can be extended with new options as our user experience requirements change.</p>

<p>Nice work making it this far!</p>

<p>You've reached the end of the tutorial portion of the article, we'll finish up by discussing a few ways we could improve this implementation in a production application.</p>

<h2>
  <a name="productiongrade-considerations" href="#productiongrade-considerations">
  </a>
  Production-grade considerations
</h2>

<p>While what we built today works fine, there are some things to consider if we were building a real, consumer-facing application.</p>

<p>Our code works and is pretty easy to maintain, but before we go, let’s touch on a few points to think about for production-grade applications. These are intended simply as things to think about as you build, and we won’t be going through any code here:</p>

<h3>
  <a name="session-storage-limitations" href="#session-storage-limitations">
  </a>
  Session storage limitations
</h3>

<p>We are relying on the <code>session</code> object to store filter options. This is fine for small applications, but as you grow, you may run into the limits of storing options like this in the session.</p>

<p>By default, Rails stores the session in a cookie which can only be ~4kb before it will start raising errors. You can use a <a href="https://guides.rubyonrails.org/v4.1.4/action_controller_overview.html#session">different session store</a> but you may want to consider a more flexible solution for storing filter options.</p>

<p>One option here is to use <a href="https://github.com/rails/kredis">Kredis</a>, a Redis-based solution that provides a nice interface for solving problems like our session persistance problem today.</p>

<h3>
  <a name="replace-helper-methods" href="#replace-helper-methods">
  </a>
  Replace helper methods
</h3>

<p>The helper methods we are using to render sorting links and indicators could be implemented as <a href="https://viewcomponent.org/">ViewComponents</a>.</p>

<p>This pattern allows us to write more testable and reusable view code and excels in cases like our example application. As this application grows, we should expect to have multiple tables across our application that all need sort links.</p>

<p>Rather than implementing them as helpers that are very specific to the players table, we could create them as generic components that can be thoroughly tested and then reused throughout the code base.</p>

<h3>
  <a name="expand-filterable-implementation" href="#expand-filterable-implementation">
  </a>
  Expand Filterable implementation
</h3>

<p>Right now, <code>Filterable</code> relies on each model to define <code>FILTER_PARAMS</code> and a <code>filter</code> method from scratch.</p>

<p>In the real world, there would likely be enough overlap between the different implementations of <code>filter</code> in each model that we would benefit from moving <code>filter</code> out of each model and into a <code>Filter</code> class that defines some shared logic, like applying <code>order</code>, which is likely to be the same for every class.</p>

<p>For a really detailed implementation of a <code>Filterable</code> pattern, take a look at the <a href="https://www.stimulusreflexpatterns.com/patterns/filterable_reflex/">filterable_reflex</a> from StimulusReflex Patterns.</p>

<h2>
  <a name="wrapping-up" href="#wrapping-up">
  </a>
  Wrapping up
</h2>

<p>Today we built on a Turbo Frame foundation to expand a sortable table view to a table that can be searched, filtered, and sorted without full page turns or lots of custom JavaScript.</p>

<p>Because frames are so powerful, we were able to easily hook into our existing frame code and add in searching and filtering without thinking too much about the front end implementation. It mostly just worked, once we built the filtering logic on the server.</p>

<p>This is the power of Turbo Frames — we can build fast, efficient user interfaces without stepping much outside of standard Rails code. The client side code stays light and maintainable, while our server looks and feels familiar to any level of Rails developer.</p>

<p>To dig deeper into Turbo and building modern Ruby on Rails applications with the Hotwire stack:</p>

<ul>
<li>Read my articles on <a href="https://www.colby.so/posts/turbo-frames-on-rails">Turbo Frames</a> and <a href="https://www.colby.so/posts/turbo-streams-on-rails">Turbo Streams</a> on Rails</li>
<li>Dive into the <a href="https://github.com/hotwired/turbo">Turbo</a> and <a href="https://github.com/hotwired/turbo-rails">turbo-rails</a> source and follow along with the Github activity for both</li>
<li>Join the <a href="https://discuss.hotwired.dev/">hotwire discussion forums</a>
</li>
<li>(Shameless plug) Sign up for my monthly newsletter, <a href="https://landing.mailerlite.com/webforms/landing/d7z0n0">Hotwiring Rails</a>, to stay up to date on the latest developments in Rails-land</li>
</ul>

<p>That’s all for today. As always, thanks for reading!</p>

</div></article> <div class="aside-username-wrapper" data-v-10d06ee8><aside class="aside-username-block" data-v-37984f8c data-v-10d06ee8><div class="username-heading loading" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-heading" data-v-37984f8c><div class="vue-content-placeholders-heading__img"></div> <div class="vue-content-placeholders-heading__content"><div class="vue-content-placeholders-heading__title"></div> <div class="vue-content-placeholders-heading__subtitle"></div></div></div></div></div> <div class="info" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-text" data-v-37984f8c><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div></div></div></div></aside></div></div> <div class="comments-block" data-v-8c4375bc data-v-10d06ee8><!----> <a href="https://dev.to/davidcolbyatx/filter-search-and-sort-tables-with-rails-and-turbo-frames-1ea2" target="_blank" rel="nofollow noopener noreferer" class="add-comment" data-v-8c4375bc>
    Add comment
  </a></div></div> <footer data-v-22cb8fd0><span data-v-22cb8fd0>Built with</span> <a href="https://nuxtjs.org" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="nuxt-icon" data-v-22cb8fd0 data-v-22cb8fd0><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a> <span data-v-22cb8fd0>&</span> <a href="https://docs.dev.to/api" rel="nofollow noopener" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-22cb8fd0 data-v-22cb8fd0><path d="M1.5726 5.13748C1.42945 5.20622 1.2411 5.36661 1.15822 5.48117C1 5.69503 1 5.74849 1 11.8739C1 17.9993 1 18.0528 1.15822 18.2667C1.2411 18.3812 1.42945 18.5416 1.5726 18.6104C1.8137 18.7402 2.46164 18.7478 12 18.7478C21.5384 18.7478 22.1863 18.7402 22.4274 18.6104C22.5706 18.5416 22.7589 18.3812 22.8418 18.2667C23 18.0528 23 17.9993 23 11.8739C23 5.74849 23 5.69503 22.8418 5.48117C22.7589 5.36661 22.5706 5.20622 22.4274 5.13748C22.1863 5.00764 21.5384 5 12 5C2.46164 5 1.8137 5.00764 1.5726 5.13748ZM7.7055 8.2613C8.0822 8.45989 8.59454 9.0098 8.77536 9.40694C8.89589 9.66664 8.91095 9.94922 8.91095 12.0649C8.91095 14.3104 8.90344 14.4478 8.75275 14.7839C8.51919 15.288 8.16506 15.6546 7.68288 15.899C7.26096 16.1052 7.22328 16.1128 5.7315 16.1358L4.20206 16.1663V12.1031V8.04744L5.80684 8.07035C7.27602 8.09327 7.42672 8.10854 7.7055 8.2613ZM13.6952 8.89521V9.73538H12.4521H11.2089V10.4991V11.2629H11.9623H12.7158V12.1031V12.9432H11.9623H11.2089V13.707V14.4708H12.4521H13.6952V15.3109V16.151H12C10.1315 16.151 10.0411 16.1358 9.67191 15.6928L9.47603 15.4484V12.1336C9.47603 8.46752 9.46851 8.49807 9.95069 8.20783C10.1692 8.07035 10.3425 8.05508 11.9473 8.05508H13.6952V8.89521ZM16.5658 10.3769C16.8897 11.6295 17.1685 12.6912 17.176 12.7293C17.1911 12.7675 17.4699 11.7441 17.8014 10.461C18.1254 9.17017 18.4343 8.1009 18.4795 8.08563C18.5247 8.06271 18.9541 8.06271 19.4288 8.07035L20.3028 8.09327L19.376 11.6219C18.8713 13.5542 18.4117 15.2269 18.3664 15.3261C18.0123 16.0135 17.274 16.3343 16.7164 16.0441C16.4528 15.899 16.0911 15.4865 15.9705 15.1887C15.9254 15.0665 15.4884 13.4549 15.0062 11.6142C14.524 9.76593 14.1171 8.20783 14.0945 8.15437C14.0644 8.07035 14.2301 8.05508 15.0212 8.07035L15.9856 8.09327L16.5658 10.3769Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M5.93491 12.103V14.4707H6.27394C6.66574 14.4707 7.01983 14.3103 7.1404 14.0965C7.18559 14.0048 7.21575 13.2105 7.21575 12.0648V10.1783L6.99725 9.95683C6.80133 9.76591 6.71847 9.73535 6.35683 9.73535H5.93491V12.103Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a></footer></div></div></div><script>window.__NUXT__=function(s,a,e,n){return e.type_of="article",e.id=865146,e.title="Filter, search, and sort tables with Rails and Turbo Frames",e.description="Today we are going to build a table that can be sorted, searched, and filtered all at once, using...",e.readable_publish_date="Oct 15 '21",e.slug="filter-search-and-sort-tables-with-rails-and-turbo-frames-1ea2",e.path="/davidcolbyatx/filter-search-and-sort-tables-with-rails-and-turbo-frames-1ea2",e.url="https://dev.to/davidcolbyatx/filter-search-and-sort-tables-with-rails-and-turbo-frames-1ea2",e.comments_count=2,e.public_reactions_count=40,e.collection_id=15038,e.published_timestamp=s,e.positive_reactions_count=40,e.cover_image="https://res.cloudinary.com/practicaldev/image/fetch/s--fqAGZQsZ--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jiw86poahdi4mzq2xonj.png",e.social_image="https://res.cloudinary.com/practicaldev/image/fetch/s--WWDMdEbJ--/c_imagga_scale,f_auto,fl_progressive,h_500,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jiw86poahdi4mzq2xonj.png",e.canonical_url="https://www.colby.so/posts/filtering-tables-with-rails-and-hotwire",e.created_at=s,e.edited_at="2021-10-15T19:40:56Z",e.crossposted_at=a,e.published_at=s,e.last_comment_at="2021-10-21T22:50:16Z",e.reading_time_minutes=16,e.tag_list="rails, tutorial, ruby, hotwire",e.tags=["rails","tutorial","ruby","hotwire"],e.body_html='<p>Today we are going to build a table that can be sorted, searched, and filtered all at once, using Ruby on Rails, Turbo Frames, a tiny Stimulus controller, and a little bit of Tailwind for styling.</p>\n\n<p>We will start with a sortable, Turbo Frame-powered table that displays a list of Players from a database. We built this sortable table in a <a href="https://www.colby.so/posts/sortable-table-with-rails-and-turbo-frames">previous article</a> — you might find it helpful to start with that article, especially if you are new to Turbo.</p>\n\n<p>When we are finished, users will be able to search for players by name, filter them by their team, and sort the table. Sorting, searching, and filtering all work together, in any combination, and they each occur without a full page turn. The end result will work like this:</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--ULha2HzU--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/abgabcu9q2wbxwc0dukx.gif" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--ULha2HzU--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/abgabcu9q2wbxwc0dukx.gif" alt="A screen recording of a user interacting with a table on a website. They click column headers to sort the table, use a drop down menu to filter the table by a specific team, and type in a search box to filter the table by name" loading="lazy" width="880" height="503" data-animated="true"></a></p>\n\n<p>This article is intended for folks who are comfortable with Ruby and Rails code. You won’t need any prior experience with Turbo Frames or Stimulus.</p>\n\n<p>Let’s dive in!</p>\n\n<h2>\n  <a name="project-setup" href="#project-setup">\n  </a>\n  Project setup\n</h2>\n\n<p>If you want to follow along with this article and you haven’t already completed the <a href="https://www.colby.so/posts/sortable-table-with-rails-and-turbo-frames">sortable table article</a> locally, you’ll want to begin by cloning <a href="https://github.com/DavidColby/player_sorting_frames">this Github repo</a>. If you have completed the sortable table article, this one picks up exactly where that one ends, so go ahead and work from where that article finished.</p>\n\n<p>To set up the application after cloning from Github, from your terminal:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>bundle install\nyarn install\nrails db:setup\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Once the application is ready, checkout the <a href="https://github.com/DavidColby/player_sorting_frames/tree/sortable">sortable branch</a>, where this article picks up, and then run <code>bin/dev</code> to compile assets and start your development server.</p>\n\n<p>After you start the server, head to <a href="http://localhost:3000">http://localhost:3000</a> and see that you have a seeded database of players and that you can sort the table by clicking on each column header.</p>\n\n<p>If you’re curious how the the sorting works, the sortable tables article goes through the frame-powered sorting mechanism in detail.</p>\n\n<p>With setup complete, let\'s start building!</p>\n\n<h2>\n  <a name="add-a-search-form" href="#add-a-search-form">\n  </a>\n  Add a search form\n</h2>\n\n<p>We’ll start with a simple search form, added inside the <code>players</code> turbo frame in  <code>app/views/players/_players.html.erb</code>.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight erb"><code><span class="cp">&lt;%=</span> <span class="n">turbo_frame_tag</span> <span class="s2">"players"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"shadow overflow-hidden rounded border-b border-gray-200"</span> <span class="k">do</span> <span class="cp">%&gt;</span>\n  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"flex justify-end mb-1"</span><span class="nt">&gt;</span>\n    <span class="cp">&lt;%=</span> <span class="n">form_with</span> <span class="ss">url: </span><span class="n">list_players_path</span><span class="p">,</span> <span class="ss">method: :get</span> <span class="k">do</span> <span class="o">|</span><span class="n">form</span><span class="o">|</span> <span class="cp">%&gt;</span>\n      <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">placeholder: </span><span class="s2">"Search by name"</span><span class="p">,</span> <span class="ss">value: </span><span class="n">params</span><span class="p">[</span><span class="ss">:name</span><span class="p">],</span> <span class="ss">class: </span><span class="s2">"border border-blue-500 rounded p-2"</span> <span class="cp">%&gt;</span>\n      <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">button</span> <span class="s2">"Search"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"bg-blue-500 text-white p-2 rounded-sm"</span> <span class="cp">%&gt;</span>\n    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>\n  <span class="nt">&lt;/div&gt;</span>\n  <span class="c">&lt;!-- Snip the table --&gt;</span>\n<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>This is a standard-issue Rails search form. When the form is submitted, a GET request is dispatched and <code>PlayersController#list</code> responds to the request. For now, the form requires the user to click the Search button to submit the search request.</p>\n\n<p>Next, we’ll update the <code>list</code> method in <code>app/controllers/players_controller.rb</code> to filter the list of players when the search form is submitted:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">list</span>\n  <span class="n">players</span> <span class="o">=</span> <span class="no">Player</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:team</span><span class="p">)</span>\n  <span class="n">players</span> <span class="o">=</span> <span class="n">players</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">\'name ilike ?\'</span><span class="p">,</span> <span class="s2">"%</span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="ss">:name</span><span class="p">]</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:name</span><span class="p">].</span><span class="nf">present?</span>\n  <span class="n">players</span> <span class="o">=</span> <span class="n">players</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="ss">:column</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="ss">:direction</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>\n  <span class="n">render</span><span class="p">(</span><span class="ss">partial: </span><span class="s1">\'players\'</span><span class="p">,</span> <span class="ss">locals: </span><span class="p">{</span> <span class="ss">players: </span><span class="n">players</span> <span class="p">})</span>\n<span class="k">end</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Here we’ve got a clunky, functional implementation of searching by name — when the <code>name</code> parameter from the form’s text_field is present, we run a case insensitive query for players in the database with a name that matches the search query.</p>\n\n<p>With these changes in place, refresh the page, type a query into the search form and submit it. You should see the players list update with the results of your query.</p>\n\n<p>You’ll notice right away that searching clears any previously applied sorting on the table, and sorting the table clears out any search. So we’ve got a search form, but we have to click to submit the form and doing so clears out the user’s sorting preference.</p>\n\n<p>We’ll fix both of those issues, starting with remove the submit button and searching as the user types instead.</p>\n\n<h3>\n  <a name="realtime-searching" href="#realtime-searching">\n  </a>\n  Real-time searching\n</h3>\n\n<p>We’ll use a small Stimulus controller to submit the search form as the user types. First, generate the Stimulus controller with the generator built in to <code>stimulus-rails</code>. From your terminal:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>rails g stimulus search_form\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Then, fill that controller in with:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight javascript"><code><span class="c1">// app/javascript/controllers/search_form_controller.js</span>\n<span class="k">import</span> <span class="p">{</span> <span class="nx">Controller</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@hotwired/stimulus</span><span class="dl">"</span>\n\n<span class="k">export</span> <span class="k">default</span> <span class="kd">class</span> <span class="kd">extends</span> <span class="nx">Controller</span> <span class="p">{</span>\n  <span class="kd">static</span> <span class="nx">targets</span> <span class="o">=</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">form</span><span class="dl">"</span> <span class="p">]</span>\n\n  <span class="nx">search</span><span class="p">()</span> <span class="p">{</span>\n    <span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">timeout</span><span class="p">)</span>\n    <span class="k">this</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n      <span class="k">this</span><span class="p">.</span><span class="nx">formTarget</span><span class="p">.</span><span class="nx">requestSubmit</span><span class="p">()</span>\n    <span class="p">},</span> <span class="mi">200</span><span class="p">)</span>\n  <span class="p">}</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>This controller’s <code>search</code> function calls <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLFormElement/requestSubmit">requestSubmit</a> on a <code>form</code> target. Since we’ll call this <code>search</code> function as the user is typing in a text input, we’ve add <code>clearTimeout</code> and <code>setTimeout</code> to ensure that the form isn’t submitted every time the user types a new character.</p>\n\n<p>Note that <code>requestSubmit</code> needs a <a href="https://github.com/javan/form-request-submit-polyfill">polyfill</a> for support on Safari and IE11. As an alternative to <code>requestSubmit</code>, if you are using <code>Rails/ujs</code> in your application, <code>Rails.fire(this.formTarget, \'submit\')</code> works without a polyfill.</p>\n\n<p>With the Stimulus controller ready to go, next we’ll connect that controller the search form:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight erb"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"flex justify-end mb-1"</span><span class="nt">&gt;</span>\n  <span class="cp">&lt;%=</span> <span class="n">form_with</span> <span class="ss">url: </span><span class="n">list_players_path</span><span class="p">,</span> <span class="ss">method: :get</span><span class="p">,</span> <span class="ss">data: </span><span class="p">{</span> <span class="ss">controller: </span><span class="s2">"search-form"</span><span class="p">,</span> <span class="ss">search_form_target: </span><span class="s2">"form"</span><span class="p">,</span> <span class="ss">turbo_frame: </span><span class="s2">"players"</span> <span class="p">}</span> <span class="k">do</span> <span class="o">|</span><span class="n">form</span><span class="o">|</span> <span class="cp">%&gt;</span>\n    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:name</span><span class="p">,</span>\n      <span class="ss">placeholder: </span><span class="s2">"Search by name"</span><span class="p">,</span>\n      <span class="ss">class: </span><span class="s2">"border border-blue-500 rounded p-2"</span><span class="p">,</span>\n      <span class="ss">autocomplete: </span><span class="s2">"off"</span><span class="p">,</span>\n      <span class="ss">data: </span><span class="p">{</span> <span class="ss">action: </span><span class="s2">"input-&gt;search-form#search"</span> <span class="p">}</span>\n    <span class="cp">%&gt;</span>\n  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>\n<span class="nt">&lt;/div&gt;</span>\n<span class="cp">&lt;%=</span> <span class="n">turbo_frame_tag</span> <span class="s2">"players"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"shadow overflow-hidden rounded border-b border-gray-200"</span> <span class="k">do</span> <span class="cp">%&gt;</span>\n<span class="c">&lt;!-- Snip table --&gt;</span>\n<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Here we first moved the search form outside of the <code>players</code> <code>turbo-frame</code>. This is necessary because if the search form is inside of the turbo frame, the search input will be reset every time the <code>players</code> frame is rerendered (meaning every time our search form is submitted), like this:</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--idbe90EG--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/99ptawtf1q9kjuqgp718.gif" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--idbe90EG--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/99ptawtf1q9kjuqgp718.gif" alt="A screen recording of a user typing in a search form above a table with a list of players. When they finish typing the table updates based on their query and the search form they were typing is reset" loading="lazy" width="880" height="502" data-animated="true"></a></p>\n\n<p>Because the form is now outside of the frame, we add a <code>data-turbo-frame</code> to target the <code>players</code> frame. This <a href="https://turbo.hotwired.dev/handbook/frames#targeting-navigation-into-or-out-of-a-frame">tells Turbo</a> to use the response from the form submission to replace the content of the players frame.</p>\n\n<p>We also added <code>data-controller="search-form"</code> and <code>data-search_form_target="form"</code> to the form element. These Stimulus attributes <a href="https://stimulus.hotwired.dev/reference/controllers#identifiers">connect</a> the <code>search-form</code> controller to the DOM and set the <code>form</code> <a href="https://stimulus.hotwired.dev/reference/targets#attributes-and-names">target</a>.</p>\n\n<p>Finally, we add <code>data-action=“input-&gt;search-form#search”</code> to the <code>name</code> field, which tells Stimulus to call the <code>search</code> function each time the <code>input</code> <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/input_event">event</a> is fired on the name field.</p>\n\n<p>We moved fairly quickly through some core Stimulus concepts here. The <a href="https://stimulus.hotwired.dev/handbook/introduction">Stimulus handbook</a> is a great reference point if you need to spend more time with any of these concepts.</p>\n\n<p>With these changes in place, we can refresh the page and see that search results update as the user types. We still cannot sort and search at the same time though, so let’s tackle that next.</p>\n\n<h2>\n  <a name="sorting-and-searching-at-the-same-time" href="#sorting-and-searching-at-the-same-time">\n  </a>\n  Sorting and searching at the same time\n</h2>\n\n<p>The reason we can’t search and sort at the same time is because the <code>list</code> method relies on URL parameters to apply search and filter options. Because the search form doesn’t include the sort parameters and sorting doesn’t include the search parameter, <code>list</code> has no way of retaining sort and search options across requests — every new request to <code>list</code> starts from scratch.</p>\n\n<p>There are a variety of ways to address this issue. The most direct is to move from using <code>params</code> to storing filter options in the <code>session</code>.</p>\n\n<p>Our basic approach will be to use <code>params</code> to update a <code>filters</code> hash in the <code>session</code> object. Since <code>session</code> is maintained across requests, as long as we update the session <code>filters</code> hash with the search and sort <code>params</code> on each request, we can persist search and sort options across requests.</p>\n\n<p>A very ugly implementation of this concept, done directly in the <code>list</code> method looks like this:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">list</span>\n  <span class="n">session</span><span class="p">[</span><span class="s1">\'filters\'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">\'filters\'</span><span class="p">].</span><span class="nf">blank?</span>\n\n  <span class="n">session</span><span class="p">[</span><span class="s1">\'filters\'</span><span class="p">].</span><span class="nf">merge!</span><span class="p">(</span><span class="n">filter_params</span><span class="p">)</span>\n  <span class="n">players</span> <span class="o">=</span> <span class="no">Player</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:team</span><span class="p">)</span>\n  <span class="n">players</span> <span class="o">=</span> <span class="n">players</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">\'players.name ilike ?\'</span><span class="p">,</span> <span class="s2">"%</span><span class="si">#{</span><span class="n">session</span><span class="p">[</span><span class="s1">\'filters\'</span><span class="p">][</span><span class="s1">\'name\'</span><span class="p">]</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span> <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">\'filters\'</span><span class="p">][</span><span class="s1">\'name\'</span><span class="p">].</span><span class="nf">present?</span>\n  <span class="n">players</span> <span class="o">=</span> <span class="n">players</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">session</span><span class="p">[</span><span class="s1">\'filters\'</span><span class="p">][</span><span class="s1">\'column\'</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">session</span><span class="p">[</span><span class="s1">\'filters\'</span><span class="p">][</span><span class="s1">\'direction\'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>\n\n  <span class="n">render</span><span class="p">(</span><span class="ss">partial: </span><span class="s1">\'players\'</span><span class="p">,</span> <span class="ss">locals: </span><span class="p">{</span> <span class="ss">players: </span><span class="n">players</span> <span class="p">})</span>\n<span class="k">end</span>\n\n<span class="kp">private</span>\n\n<span class="k">def</span> <span class="nf">filter_params</span>\n  <span class="n">params</span><span class="p">.</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:column</span><span class="p">,</span> <span class="ss">:direction</span><span class="p">)</span>\n<span class="k">end</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Here we ensure that <code>session[\'filters\']</code> is a hash, update its value by merging in whitelisted <code>filter_params</code> and then use the the <code>filters</code> hash to search for players by name and order the list of players, as appropriate.</p>\n\n<p>This ugly code is fully functional — if you update the <code>list</code> method and add the <code>filter_params</code> method to your controller you will be able to search and sort at the same time; however, this code is clunky, difficult to follow, and quickly becomes unmaintainable as your application grows.</p>\n\n<p>So, if this code is ugly and unmaintainable, why are we looking at it?</p>\n\n<p>Because we are going to refactor it into something neater and more scalable. Before we do that it is helpful to see what the most direct implementation can be so we can understand what is happening at a basic level.</p>\n\n<p>When we’re done, we’ll still store <code>params</code> in a hash in the <code>session</code> object, and we’ll still use the hash values to query the database based on the user’s preferences. Our code will be nicer, but it’ll still be the same basic concept.</p>\n\n<p>Let’s refactor this code next.</p>\n\n<h2>\n  <a name="building-a-filterable-concern" href="#building-a-filterable-concern">\n  </a>\n  Building a Filterable concern\n</h2>\n\n<p>To make our filtering code more scalable and less error prone, we are going to start with a generalized <code>Filterable</code> <a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveSupport/Concern.html">concern</a>. We’ll include <code>Filterable</code> in the <code>PlayersController</code> and use it to filter <code>players</code>.</p>\n\n<p><code>Filterable</code> won’t know anything about the specifics of querying <code>Players</code>, instead it will just implement logic to store query parameters in the session. Once the values are stored, they’ll be used to apply filters.</p>\n\n<p>First, create the filterable concern. From your terminal:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>touch app/controllers/concerns/filterable.rb\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Then, fill in <code>filterable.rb</code> with the following:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight ruby"><code><span class="k">module</span> <span class="nn">Filterable</span>\n  <span class="k">def</span> <span class="nf">filter!</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>\n    <span class="n">store_filters</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>\n    <span class="n">apply_filters</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>\n  <span class="k">end</span>\n\n  <span class="kp">private</span>\n\n  <span class="k">def</span> <span class="nf">store_filters</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>\n    <span class="n">session</span><span class="p">[</span><span class="s2">"</span><span class="si">#{</span><span class="n">resource</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">underscore</span><span class="si">}</span><span class="s2">_filters"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">unless</span> <span class="n">session</span><span class="p">.</span><span class="nf">key?</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">resource</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">underscore</span><span class="si">}</span><span class="s2">_filters"</span><span class="p">)</span>\n\n    <span class="n">session</span><span class="p">[</span><span class="s2">"</span><span class="si">#{</span><span class="n">resource</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">underscore</span><span class="si">}</span><span class="s2">_filters"</span><span class="p">].</span><span class="nf">merge!</span><span class="p">(</span><span class="n">filter_params_for</span><span class="p">(</span><span class="n">resource</span><span class="p">))</span>\n  <span class="k">end</span>\n\n  <span class="k">def</span> <span class="nf">filter_params_for</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>\n    <span class="n">params</span><span class="p">.</span><span class="nf">permit</span><span class="p">(</span><span class="n">resource</span><span class="o">::</span><span class="no">FILTER_PARAMS</span><span class="p">)</span>\n  <span class="k">end</span>\n\n  <span class="k">def</span> <span class="nf">apply_filters</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>\n    <span class="n">resource</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s2">"</span><span class="si">#{</span><span class="n">resource</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">underscore</span><span class="si">}</span><span class="s2">_filters"</span><span class="p">])</span>\n  <span class="k">end</span>\n<span class="k">end</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>There’s a lot of code here, let’s break it down.</p>\n\n<p>The <code>filter!</code> method is what we’ll call from the controller to apply filters in response to a request from a user. It takes a <code>resource</code> argument. <code>resource</code> will be an ActiveRecord class, like <code>Player</code>. <code>filter!</code> simply calls out to two internal methods, <code>store_filters</code> and <code>apply_filters</code>, which do the heavy lifting.</p>\n\n<p><code>store_filters</code> ensures that <code>session[\'class_name_filters\']</code> exists, and then writes whitelisted parameters into the session key, replicating the first two lines of our ugly implementation directly in the <code>list</code> method in the last section.</p>\n\n<p>Once the filters are stored, <code>apply_filters</code> calls a <code>filter</code> class method from the class we’re interested in which should return a list of ActiveRecord objects.</p>\n\n<p>You’ll notice here that <code>Filterable</code> isn’t doing much on its own. Instead, it is relying on methods to exist on the class passed in to <code>filter!</code>. This is by design — in a real application, we would likely need to build filtering mechanisms for many different ActiveRecord classes, and each will need to be able to filter by a unique set of columns. Trying to build all of that logic into the <code>Filterable</code> module would quickly become even harder to maintain than tossing everything in the controller.</p>\n\n<p>Rather than building all of that complexity in to <code>Filterable</code>, we instead just rely on the target class to define <code>FILTER_PARAMS</code> and a <code>filter</code> method in whatever way works for that particular class.</p>\n\n<p>Let’s see this in action by updating <code>app/models/player.rb</code> to work with our new <code>Filterable</code> concern.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Player</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>\n  <span class="n">belongs_to</span> <span class="ss">:team</span>\n\n  <span class="no">FILTER_PARAMS</span> <span class="o">=</span> <span class="sx">%i[name column direction]</span><span class="p">.</span><span class="nf">freeze</span>\n\n  <span class="n">scope</span> <span class="ss">:by_name</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s1">\'players.name ilike ?\'</span><span class="p">,</span> <span class="s2">"%</span><span class="si">#{</span><span class="n">query</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span> <span class="p">}</span>\n\n  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>\n    <span class="no">Player</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:team</span><span class="p">)</span>\n          <span class="p">.</span><span class="nf">by_name</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="s1">\'name\'</span><span class="p">])</span>\n          <span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">filters</span><span class="p">[</span><span class="s1">\'column\'</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">filters</span><span class="p">[</span><span class="s1">\'direction\'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>\n  <span class="k">end</span>\n<span class="k">end</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Here we’ve defined the <code>FILTER_PARAMS</code> constant with the three filtering we support on the players table.</p>\n\n<p>Next, we added the <code>by_name</code> scope to handle searching the players table by name.</p>\n\n<p>Finally, we implement <code>filter</code>, which replaces the queries that we previously built in <code>PlayersController#list</code> and makes use of the new <code>by_name</code> scope to be a bit more readable.</p>\n\n<p>With <code>Player</code> set up for filtering, we can update <code>PlayersController</code> to include <code>Filterable</code> and replace the filtering logic in <code>list</code> with the new <code>filter!</code> method.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">PlayersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>\n  <span class="kp">include</span> <span class="no">Filterable</span>\n  <span class="c1"># snip</span>\n  <span class="k">def</span> <span class="nf">list</span>\n    <span class="n">players</span> <span class="o">=</span> <span class="n">filter!</span><span class="p">(</span><span class="no">Player</span><span class="p">)</span>\n    <span class="n">render</span><span class="p">(</span><span class="ss">partial: </span><span class="s1">\'players\'</span><span class="p">,</span> <span class="ss">locals: </span><span class="p">{</span> <span class="ss">players: </span><span class="n">players</span> <span class="p">})</span>\n  <span class="k">end</span>\n<span class="k">end</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Here we simply include <code>Filterable</code> in the controller and then set the value of <code>players</code> using the <code>filter!</code> method provided by <code>Filterable</code>.</p>\n\n<p>Much nicer, right?</p>\n\n<p>Before moving on, you\'ll also notice that <code>Filterable</code> is in the <code>controller/concerns</code> directory, but it isn\'t truly a <a href="https://api.rubyonrails.org/v6.1.4/classes/ActiveSupport/Concern.html">Concern</a>. In our case, controller concerns is the simplest place for this module to live, but we don\'t need the full functionality of a true concern. You could just as easily place this module in another place if you prefer.</p>\n\n<p>Our last step is to update the views to read values from the session instead of params so that we always display the correct set of applied filters to users. </p>\n\n<p>First, update the table header in <code>_players</code> like this:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight erb"><code><span class="nt">&lt;tr&gt;</span>\n  <span class="nt">&lt;th</span> <span class="na">id=</span><span class="s">"players-name"</span> <span class="na">class=</span><span class="s">"text-left py-3 px-6 uppercase font-semibold text-sm hover:cursor-pointer relative"</span><span class="nt">&gt;</span>\n    <span class="cp">&lt;%=</span> <span class="n">sort_indicator</span> <span class="k">if</span> <span class="n">session</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="s1">\'player_filters\'</span><span class="p">,</span> <span class="s1">\'column\'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"name"</span> <span class="cp">%&gt;</span>\n    <span class="cp">&lt;%=</span> <span class="n">build_order_link</span><span class="p">(</span><span class="ss">column: </span><span class="s2">"name"</span><span class="p">,</span> <span class="ss">label: </span><span class="s2">"Name"</span><span class="p">)</span> <span class="cp">%&gt;</span>\n  <span class="nt">&lt;/th&gt;</span>\n  <span class="nt">&lt;th</span> <span class="na">id=</span><span class="s">"players-team"</span> <span class="na">class=</span><span class="s">"text-left py-3 px-6 uppercase font-semibold text-sm hover:cursor-pointer relative"</span><span class="nt">&gt;</span>\n    <span class="cp">&lt;%=</span> <span class="n">sort_indicator</span> <span class="k">if</span> <span class="n">session</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="s1">\'player_filters\'</span><span class="p">,</span> <span class="s1">\'column\'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"teams.name"</span> <span class="cp">%&gt;</span>\n    <span class="cp">&lt;%=</span> <span class="n">build_order_link</span><span class="p">(</span><span class="ss">column: </span><span class="s2">"teams.name"</span><span class="p">,</span> <span class="ss">label: </span><span class="s2">"Team"</span><span class="p">)</span> <span class="cp">%&gt;</span>\n  <span class="nt">&lt;/th&gt;</span>\n  <span class="nt">&lt;th</span> <span class="na">id=</span><span class="s">"players-seasons"</span> <span class="na">class=</span><span class="s">"text-left py-3 px-6 uppercase font-semibold text-sm hover:cursor-pointer relative"</span><span class="nt">&gt;</span>\n    <span class="cp">&lt;%=</span> <span class="n">sort_indicator</span> <span class="k">if</span> <span class="n">session</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="s1">\'player_filters\'</span><span class="p">,</span> <span class="s1">\'column\'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"seasons"</span> <span class="cp">%&gt;</span>\n    <span class="cp">&lt;%=</span> <span class="n">build_order_link</span><span class="p">(</span><span class="ss">column: </span><span class="s2">"seasons"</span><span class="p">,</span> <span class="ss">label: </span><span class="s2">"Seasons"</span><span class="p">)</span> <span class="cp">%&gt;</span>\n  <span class="nt">&lt;/th&gt;</span>\n<span class="nt">&lt;/tr&gt;</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>We’ve replaced references to <code>params</code> with <code>session.dig</code> calls with this change. When no filters have been applied, <code>session[\'player_filters\']</code> won’t exist, so we use <code>dig</code> to avoid nil errors in those cases.</p>\n\n<p>Next, update <code>app/heleprs/players_helper.rb</code> like this:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight ruby"><code><span class="k">module</span> <span class="nn">PlayersHelper</span>\n  <span class="k">def</span> <span class="nf">build_order_link</span><span class="p">(</span><span class="n">column</span><span class="p">:,</span> <span class="n">label</span><span class="p">:)</span>\n    <span class="k">if</span> <span class="n">column</span> <span class="o">==</span> <span class="n">session</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="s1">\'player_filters\'</span><span class="p">,</span> <span class="s1">\'column\'</span><span class="p">)</span>\n      <span class="n">link_to</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">list_players_path</span><span class="p">(</span><span class="ss">column: </span><span class="n">column</span><span class="p">,</span> <span class="ss">direction: </span><span class="n">next_direction</span><span class="p">))</span>\n    <span class="k">else</span>\n      <span class="n">link_to</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">list_players_path</span><span class="p">(</span><span class="ss">column: </span><span class="n">column</span><span class="p">,</span> <span class="ss">direction: </span><span class="s1">\'asc\'</span><span class="p">))</span>\n    <span class="k">end</span>\n  <span class="k">end</span>\n\n  <span class="k">def</span> <span class="nf">next_direction</span>\n    <span class="n">session</span><span class="p">[</span><span class="s1">\'player_filters\'</span><span class="p">][</span><span class="s1">\'direction\'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">\'asc\'</span> <span class="p">?</span> <span class="s1">\'desc\'</span> <span class="p">:</span> <span class="s1">\'asc\'</span>\n  <span class="k">end</span>\n\n  <span class="k">def</span> <span class="nf">sort_indicator</span>\n    <span class="n">tag</span><span class="p">.</span><span class="nf">span</span><span class="p">(</span><span class="ss">class: </span><span class="s2">"sort sort-</span><span class="si">#{</span><span class="n">session</span><span class="p">[</span><span class="s1">\'player_filters\'</span><span class="p">][</span><span class="s1">\'direction\'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>\n  <span class="k">end</span>\n<span class="k">end</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Again we’re just replacing params with the equivalent session values so that sorting works correctly all the time and visual indicators are shown consistently.</p>\n\n<p>With those changes in place, refresh the page and see that you can search and sort the table at the same time, and the UI always shows the proper sort indicator.</p>\n\n<p>Nice work making it this far! We spent a good amount of time building a more scalable filtering solution, so let’s wrap up this article by putting that scalable solution to use by adding a filtering option to the table.</p>\n\n<h3>\n  <a name="add-filtering-by-team" href="#add-filtering-by-team">\n  </a>\n  Add filtering by team\n</h3>\n\n<p>Right now users can search by player name and sort the table, but they can’t filter by team or season. Let’s add filtering by team to the filter options.</p>\n\n<p>We’re going to use a select input for the Team filter, since <code>team</code> is a <code>belongs_to</code> relationship on the <code>Player</code> class — we’ll have a dropdown menu that displays all available teams by name, each dropdown option will have <code>team_id</code> as the value sent back to the server.</p>\n\n<p>Since we’re using a select input, let’s make it look nice by taking a slight detour to install Tailwind’s forms plugin:</p>\n\n<p>From your terminal:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>yarn add @tailwindcss/forms\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>And then update <code>tailwind.config.js</code> to include the plugin:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight javascript"><code><span class="nx">plugins</span><span class="p">:</span> <span class="p">[</span>\n  <span class="nx">require</span><span class="p">(</span><span class="dl">\'</span><span class="s1">@tailwindcss/forms</span><span class="dl">\'</span><span class="p">),</span>\n<span class="p">]</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Incredible stuff.</p>\n\n<p>Back to adding the team filter. We’ll start by adding the team filter to the UI. In the <code>players</code> partial:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight erb"><code><span class="cp">&lt;%=</span> <span class="n">form_with</span> <span class="ss">url: </span><span class="n">list_players_path</span><span class="p">,</span> <span class="ss">method: :get</span><span class="p">,</span> <span class="ss">data: </span><span class="p">{</span> <span class="ss">controller: </span><span class="s2">"search-form"</span><span class="p">,</span> <span class="ss">search_form_target: </span><span class="s2">"form"</span><span class="p">,</span> <span class="ss">turbo_frame: </span><span class="s2">"players"</span> <span class="p">}</span> <span class="k">do</span> <span class="o">|</span><span class="n">form</span><span class="o">|</span> <span class="cp">%&gt;</span>\n  <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">select</span> <span class="ss">:team_id</span><span class="p">,</span>\n    <span class="n">options_for_select</span><span class="p">(</span>\n      <span class="no">Team</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">pluck</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:id</span><span class="p">),</span>\n      <span class="n">session</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="s1">\'player_filters\'</span><span class="p">,</span> <span class="s1">\'team_id\'</span><span class="p">)</span>\n    <span class="p">),</span>\n    <span class="p">{</span> <span class="ss">include_blank: </span><span class="s1">\'All Teams\'</span> <span class="p">},</span>\n    <span class="ss">class: </span><span class="s2">"border-blue-500 rounded"</span><span class="p">,</span>\n    <span class="ss">data: </span><span class="p">{</span> \n      <span class="ss">action: </span><span class="s2">"change-&gt;search-form#search"</span> \n    <span class="p">}</span> \n  <span class="cp">%&gt;</span>\n<span class="c">&lt;!-- Snip the search input --&gt;</span>\n<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>This is a regular Rails <code>select</code> helper. In it, we build a list of all teams in the database, set the selected value when one is present (<code>session.dig</code>, again) and fire the <code>search</code> function of the <code>search-form</code> controller each time the select input changes.</p>\n\n<p>Refresh the page, change the team input and see that it doesn\'t work yet. We haven’t updated <code>Player</code> to support filtering by team yet.</p>\n\n<p>Head to <code>app/models/player.rb</code> and update it like this:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight ruby"><code><span class="no">FILTER_PARAMS</span> <span class="o">=</span> <span class="sx">%i[name team_id column direction]</span><span class="p">.</span><span class="nf">freeze</span>\n\n<span class="n">scope</span> <span class="ss">:by_team</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">team_id</span><span class="p">)</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">team_id: </span><span class="n">team_id</span><span class="p">)</span> <span class="k">if</span> <span class="n">team_id</span><span class="p">.</span><span class="nf">present?</span> <span class="p">}</span>\n\n<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>\n  <span class="no">Player</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:team</span><span class="p">)</span>\n        <span class="p">.</span><span class="nf">by_name</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="s1">\'name\'</span><span class="p">])</span>\n        <span class="p">.</span><span class="nf">by_team</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="s1">\'team_id\'</span><span class="p">])</span>\n        <span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">filters</span><span class="p">[</span><span class="s1">\'column\'</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">filters</span><span class="p">[</span><span class="s1">\'direction\'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>\n<span class="k">end</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Now we can start to see the benefit of the work we did in the last section. We can add filtering by a new option with just a few simple changes to the model.</p>\n\n<p>We updated the model to add <code>team_id</code> to the list of valid <code>FILTER_PARAMS</code>, added the <code>by_team</code> scope, and then added <code>by_team</code> to the <code>filters</code> method.</p>\n\n<p>No need to change our controller or touch the <code>Filterable</code> module — updating the model is all we need.</p>\n\n<p>Refresh the page, apply a team filter and see that filtering by team works along with searching by name and sorting. Great work!</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--vBeVhmq9--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/6b7qgskgktg5814w0bmo.gif" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--vBeVhmq9--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/6b7qgskgktg5814w0bmo.gif" alt="A screen recording of a user interacting with a table on a website. They click column headers to sort the table, use a drop down menu to filter the table by a specific team, and type in a search box to filter the table by name" loading="lazy" width="880" height="503" data-animated="true"></a></p>\n\n<h2>\n  <a name="filtering-the-index-action" href="#filtering-the-index-action">\n  </a>\n  Filtering the index action\n</h2>\n\n<p>We’ll wrap up this exercise by make a few more small adjustments to avoid weirdness when a user visits the <code>/players</code> with filtering values already saved in their session.</p>\n\n<p>First, now that we have access to the <code>filter!</code> method, we can update the <code>index</code> action to use that method instead of always setting the value of <code>players</code> to all players in the database.</p>\n\n<p>To do that, update <code>index</code> in <code>app/controllers/players_controller.rb</code> like this:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">index</span>\n  <span class="vi">@players</span> <span class="o">=</span> <span class="n">filter!</span><span class="p">(</span><span class="no">Player</span><span class="p">)</span>\n<span class="k">end</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>With that change in place, we’ll now filter the list of players properly when a user reloads players page after applying filters in a previous request, making the experience on the index page a bit more consistent.</p>\n\n<p>Finally, since we’re using the session values to restore previously applied filters, we need to update the <code>name</code> search field to set its <code>value</code> from the session. Without this change, when the user applies a name search and then refreshes the page, the list of players will be filtered by name, but the search term won’t be visible in the name field.</p>\n\n<p>To fix this issue,  update the name field in the <code>players</code> partial like this:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight erb"><code><span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:name</span><span class="p">,</span>\n  <span class="ss">placeholder: </span><span class="s2">"Search by name"</span><span class="p">,</span>\n  <span class="ss">value: </span><span class="n">session</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="s1">\'player_filters\'</span><span class="p">,</span> <span class="s1">\'name\'</span><span class="p">),</span>\n  <span class="ss">class: </span><span class="s2">"border border-blue-500 rounded p-2"</span><span class="p">,</span>\n  <span class="ss">autocomplete: </span><span class="s2">"off"</span><span class="p">,</span>\n  <span class="ss">data: </span><span class="p">{</span> <span class="ss">action: </span><span class="s2">"input-&gt;search-form#search"</span> <span class="p">}</span>\n<span class="cp">%&gt;</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>With <code>value</code> added to the <code>name</code> field, we’ll always show the correct value to users, even on the initial page load.</p>\n\n<p>With these small changes in places, we’ve now got consistent filtering experience that persists cleanly across requests and can be extended with new options as our user experience requirements change.</p>\n\n<p>Nice work making it this far!</p>\n\n<p>You\'ve reached the end of the tutorial portion of the article, we\'ll finish up by discussing a few ways we could improve this implementation in a production application.</p>\n\n<h2>\n  <a name="productiongrade-considerations" href="#productiongrade-considerations">\n  </a>\n  Production-grade considerations\n</h2>\n\n<p>While what we built today works fine, there are some things to consider if we were building a real, consumer-facing application.</p>\n\n<p>Our code works and is pretty easy to maintain, but before we go, let’s touch on a few points to think about for production-grade applications. These are intended simply as things to think about as you build, and we won’t be going through any code here:</p>\n\n<h3>\n  <a name="session-storage-limitations" href="#session-storage-limitations">\n  </a>\n  Session storage limitations\n</h3>\n\n<p>We are relying on the <code>session</code> object to store filter options. This is fine for small applications, but as you grow, you may run into the limits of storing options like this in the session.</p>\n\n<p>By default, Rails stores the session in a cookie which can only be ~4kb before it will start raising errors. You can use a <a href="https://guides.rubyonrails.org/v4.1.4/action_controller_overview.html#session">different session store</a> but you may want to consider a more flexible solution for storing filter options.</p>\n\n<p>One option here is to use <a href="https://github.com/rails/kredis">Kredis</a>, a Redis-based solution that provides a nice interface for solving problems like our session persistance problem today.</p>\n\n<h3>\n  <a name="replace-helper-methods" href="#replace-helper-methods">\n  </a>\n  Replace helper methods\n</h3>\n\n<p>The helper methods we are using to render sorting links and indicators could be implemented as <a href="https://viewcomponent.org/">ViewComponents</a>.</p>\n\n<p>This pattern allows us to write more testable and reusable view code and excels in cases like our example application. As this application grows, we should expect to have multiple tables across our application that all need sort links.</p>\n\n<p>Rather than implementing them as helpers that are very specific to the players table, we could create them as generic components that can be thoroughly tested and then reused throughout the code base.</p>\n\n<h3>\n  <a name="expand-filterable-implementation" href="#expand-filterable-implementation">\n  </a>\n  Expand Filterable implementation\n</h3>\n\n<p>Right now, <code>Filterable</code> relies on each model to define <code>FILTER_PARAMS</code> and a <code>filter</code> method from scratch.</p>\n\n<p>In the real world, there would likely be enough overlap between the different implementations of <code>filter</code> in each model that we would benefit from moving <code>filter</code> out of each model and into a <code>Filter</code> class that defines some shared logic, like applying <code>order</code>, which is likely to be the same for every class.</p>\n\n<p>For a really detailed implementation of a <code>Filterable</code> pattern, take a look at the <a href="https://www.stimulusreflexpatterns.com/patterns/filterable_reflex/">filterable_reflex</a> from StimulusReflex Patterns.</p>\n\n<h2>\n  <a name="wrapping-up" href="#wrapping-up">\n  </a>\n  Wrapping up\n</h2>\n\n<p>Today we built on a Turbo Frame foundation to expand a sortable table view to a table that can be searched, filtered, and sorted without full page turns or lots of custom JavaScript.</p>\n\n<p>Because frames are so powerful, we were able to easily hook into our existing frame code and add in searching and filtering without thinking too much about the front end implementation. It mostly just worked, once we built the filtering logic on the server.</p>\n\n<p>This is the power of Turbo Frames — we can build fast, efficient user interfaces without stepping much outside of standard Rails code. The client side code stays light and maintainable, while our server looks and feels familiar to any level of Rails developer.</p>\n\n<p>To dig deeper into Turbo and building modern Ruby on Rails applications with the Hotwire stack:</p>\n\n<ul>\n<li>Read my articles on <a href="https://www.colby.so/posts/turbo-frames-on-rails">Turbo Frames</a> and <a href="https://www.colby.so/posts/turbo-streams-on-rails">Turbo Streams</a> on Rails</li>\n<li>Dive into the <a href="https://github.com/hotwired/turbo">Turbo</a> and <a href="https://github.com/hotwired/turbo-rails">turbo-rails</a> source and follow along with the Github activity for both</li>\n<li>Join the <a href="https://discuss.hotwired.dev/">hotwire discussion forums</a>\n</li>\n<li>(Shameless plug) Sign up for my monthly newsletter, <a href="https://landing.mailerlite.com/webforms/landing/d7z0n0">Hotwiring Rails</a>, to stay up to date on the latest developments in Rails-land</li>\n</ul>\n\n<p>That’s all for today. As always, thanks for reading!</p>\n\n',e.body_markdown='Today we are going to build a table that can be sorted, searched, and filtered all at once, using Ruby on Rails, Turbo Frames, a tiny Stimulus controller, and a little bit of Tailwind for styling.\n\nWe will start with a sortable, Turbo Frame-powered table that displays a list of Players from a database. We built this sortable table in a [previous article](https://www.colby.so/posts/sortable-table-with-rails-and-turbo-frames) — you might find it helpful to start with that article, especially if you are new to Turbo.\n\nWhen we are finished, users will be able to search for players by name, filter them by their team, and sort the table. Sorting, searching, and filtering all work together, in any combination, and they each occur without a full page turn. The end result will work like this:\n\n![A screen recording of a user interacting with a table on a website. They click column headers to sort the table, use a drop down menu to filter the table by a specific team, and type in a search box to filter the table by name](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/abgabcu9q2wbxwc0dukx.gif)\n\nThis article is intended for folks who are comfortable with Ruby and Rails code. You won’t need any prior experience with Turbo Frames or Stimulus.\n\nLet’s dive in!\n\n## Project setup\nIf you want to follow along with this article and you haven’t already completed the [sortable table article](https://www.colby.so/posts/sortable-table-with-rails-and-turbo-frames) locally, you’ll want to begin by cloning [this Github repo](https://github.com/DavidColby/player_sorting_frames). If you have completed the sortable table article, this one picks up exactly where that one ends, so go ahead and work from where that article finished.\n\nTo set up the application after cloning from Github, from your terminal:\n\n```\nbundle install\nyarn install\nrails db:setup\n```\n\nOnce the application is ready, checkout the [sortable branch](https://github.com/DavidColby/player_sorting_frames/tree/sortable), where this article picks up, and then run `bin/dev` to compile assets and start your development server.\n\nAfter you start the server, head to [http://localhost:3000](http://localhost:3000) and see that you have a seeded database of players and that you can sort the table by clicking on each column header.\n\nIf you’re curious how the the sorting works, the sortable tables article goes through the frame-powered sorting mechanism in detail.\n\nWith setup complete, let\'s start building!\n\n## Add a search form\nWe’ll start with a simple search form, added inside the `players` turbo frame in  `app/views/players/_players.html.erb`.\n\n```erb\n<%= turbo_frame_tag "players", class: "shadow overflow-hidden rounded border-b border-gray-200" do %>\n  <div class="flex justify-end mb-1">\n    <%= form_with url: list_players_path, method: :get do |form| %>\n      <%= form.text_field :name, placeholder: "Search by name", value: params[:name], class: "border border-blue-500 rounded p-2" %>\n      <%= form.button "Search", class: "bg-blue-500 text-white p-2 rounded-sm" %>\n    <% end %>\n  </div>\n  \x3c!-- Snip the table --\x3e\n<% end %>\n```\n\nThis is a standard-issue Rails search form. When the form is submitted, a GET request is dispatched and `PlayersController#list` responds to the request. For now, the form requires the user to click the Search button to submit the search request.\n\nNext, we’ll update the `list` method in `app/controllers/players_controller.rb` to filter the list of players when the search form is submitted:\n\n```ruby\ndef list\n  players = Player.includes(:team)\n  players = players.where(\'name ilike ?\', "%#{params[:name]}%") if params[:name].present?\n  players = players.order("#{params[:column]} #{params[:direction]}")\n  render(partial: \'players\', locals: { players: players })\nend\n```\n\nHere we’ve got a clunky, functional implementation of searching by name — when the `name` parameter from the form’s text_field is present, we run a case insensitive query for players in the database with a name that matches the search query.\n\nWith these changes in place, refresh the page, type a query into the search form and submit it. You should see the players list update with the results of your query.\n\nYou’ll notice right away that searching clears any previously applied sorting on the table, and sorting the table clears out any search. So we’ve got a search form, but we have to click to submit the form and doing so clears out the user’s sorting preference.\n\nWe’ll fix both of those issues, starting with remove the submit button and searching as the user types instead.\n\n### Real-time searching\nWe’ll use a small Stimulus controller to submit the search form as the user types. First, generate the Stimulus controller with the generator built in to `stimulus-rails`. From your terminal:\n\n```\nrails g stimulus search_form\n```\n\nThen, fill that controller in with:\n\n```javascript\n// app/javascript/controllers/search_form_controller.js\nimport { Controller } from "@hotwired/stimulus"\n\nexport default class extends Controller {\n  static targets = [ "form" ]\n\n  search() {\n    clearTimeout(this.timeout)\n    this.timeout = setTimeout(() => {\n      this.formTarget.requestSubmit()\n    }, 200)\n  }\n}\n```\n\nThis controller’s `search` function calls [requestSubmit](https://developer.mozilla.org/en-US/docs/Web/API/HTMLFormElement/requestSubmit) on a `form` target. Since we’ll call this `search` function as the user is typing in a text input, we’ve add `clearTimeout` and `setTimeout` to ensure that the form isn’t submitted every time the user types a new character.\n\nNote that `requestSubmit` needs a [polyfill](https://github.com/javan/form-request-submit-polyfill) for support on Safari and IE11. As an alternative to `requestSubmit`, if you are using `Rails/ujs` in your application, `Rails.fire(this.formTarget, \'submit\')` works without a polyfill.\n\nWith the Stimulus controller ready to go, next we’ll connect that controller the search form:\n\n```erb\n<div class="flex justify-end mb-1">\n  <%= form_with url: list_players_path, method: :get, data: { controller: "search-form", search_form_target: "form", turbo_frame: "players" } do |form| %>\n    <%= form.text_field :name,\n      placeholder: "Search by name",\n      class: "border border-blue-500 rounded p-2",\n      autocomplete: "off",\n      data: { action: "input->search-form#search" }\n    %>\n  <% end %>\n</div>\n<%= turbo_frame_tag "players", class: "shadow overflow-hidden rounded border-b border-gray-200" do %>\n\x3c!-- Snip table --\x3e\n<% end %>\n```\n\nHere we first moved the search form outside of the `players` `turbo-frame`. This is necessary because if the search form is inside of the turbo frame, the search input will be reset every time the `players` frame is rerendered (meaning every time our search form is submitted), like this:\n\n![A screen recording of a user typing in a search form above a table with a list of players. When they finish typing the table updates based on their query and the search form they were typing is reset](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/99ptawtf1q9kjuqgp718.gif)\n\nBecause the form is now outside of the frame, we add a `data-turbo-frame` to target the `players` frame. This [tells Turbo](https://turbo.hotwired.dev/handbook/frames#targeting-navigation-into-or-out-of-a-frame) to use the response from the form submission to replace the content of the players frame.\n\nWe also added `data-controller="search-form"` and `data-search_form_target="form"` to the form element. These Stimulus attributes [connect](https://stimulus.hotwired.dev/reference/controllers#identifiers) the `search-form` controller to the DOM and set the `form` [target](https://stimulus.hotwired.dev/reference/targets#attributes-and-names).\n\nFinally, we add `data-action=“input->search-form#search”` to the `name` field, which tells Stimulus to call the `search` function each time the `input` [event](https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/input_event) is fired on the name field.\n\nWe moved fairly quickly through some core Stimulus concepts here. The [Stimulus handbook](https://stimulus.hotwired.dev/handbook/introduction) is a great reference point if you need to spend more time with any of these concepts.\n\nWith these changes in place, we can refresh the page and see that search results update as the user types. We still cannot sort and search at the same time though, so let’s tackle that next.\n\n## Sorting and searching at the same time\nThe reason we can’t search and sort at the same time is because the `list` method relies on URL parameters to apply search and filter options. Because the search form doesn’t include the sort parameters and sorting doesn’t include the search parameter, `list` has no way of retaining sort and search options across requests — every new request to `list` starts from scratch.\n\nThere are a variety of ways to address this issue. The most direct is to move from using `params` to storing filter options in the `session`.\n\nOur basic approach will be to use `params` to update a `filters` hash in the `session` object. Since `session` is maintained across requests, as long as we update the session `filters` hash with the search and sort `params` on each request, we can persist search and sort options across requests.\n\nA very ugly implementation of this concept, done directly in the `list` method looks like this:\n\n```ruby\ndef list\n  session[\'filters\'] = {} if session[\'filters\'].blank?\n\n  session[\'filters\'].merge!(filter_params)\n  players = Player.includes(:team)\n  players = players.where(\'players.name ilike ?\', "%#{session[\'filters\'][\'name\']}%") if session[\'filters\'][\'name\'].present?\n  players = players.order("#{session[\'filters\'][\'column\']} #{session[\'filters\'][\'direction\']}")\n  \n  render(partial: \'players\', locals: { players: players })\nend\n\nprivate\n\ndef filter_params\n  params.permit(:name, :column, :direction)\nend\n```\n\nHere we ensure that `session[\'filters\']` is a hash, update its value by merging in whitelisted `filter_params` and then use the the `filters` hash to search for players by name and order the list of players, as appropriate.\n\nThis ugly code is fully functional — if you update the `list` method and add the `filter_params` method to your controller you will be able to search and sort at the same time; however, this code is clunky, difficult to follow, and quickly becomes unmaintainable as your application grows.\n\nSo, if this code is ugly and unmaintainable, why are we looking at it?\n\nBecause we are going to refactor it into something neater and more scalable. Before we do that it is helpful to see what the most direct implementation can be so we can understand what is happening at a basic level.\n\nWhen we’re done, we’ll still store `params` in a hash in the `session` object, and we’ll still use the hash values to query the database based on the user’s preferences. Our code will be nicer, but it’ll still be the same basic concept.\n\nLet’s refactor this code next.\n\n## Building a Filterable concern\nTo make our filtering code more scalable and less error prone, we are going to start with a generalized `Filterable` [concern](https://api.rubyonrails.org/v6.1.4/classes/ActiveSupport/Concern.html). We’ll include `Filterable` in the `PlayersController` and use it to filter `players`.\n\n`Filterable` won’t know anything about the specifics of querying `Players`, instead it will just implement logic to store query parameters in the session. Once the values are stored, they’ll be used to apply filters.\n\nFirst, create the filterable concern. From your terminal:\n\n```\ntouch app/controllers/concerns/filterable.rb\n```\n\nThen, fill in `filterable.rb` with the following:\n\n```ruby\nmodule Filterable\n  def filter!(resource)\n    store_filters(resource)\n    apply_filters(resource)\n  end\n\n  private\n\n  def store_filters(resource)\n    session["#{resource.to_s.underscore}_filters"] = {} unless session.key?("#{resource.to_s.underscore}_filters")\n\n    session["#{resource.to_s.underscore}_filters"].merge!(filter_params_for(resource))\n  end\n\n  def filter_params_for(resource)\n    params.permit(resource::FILTER_PARAMS)\n  end\n\n  def apply_filters(resource)\n    resource.filter(session["#{resource.to_s.underscore}_filters"])\n  end\nend\n```\n\nThere’s a lot of code here, let’s break it down.\n\nThe `filter!` method is what we’ll call from the controller to apply filters in response to a request from a user. It takes a `resource` argument. `resource` will be an ActiveRecord class, like `Player`. `filter!` simply calls out to two internal methods, `store_filters` and `apply_filters`, which do the heavy lifting.\n\n`store_filters` ensures that `session[\'class_name_filters\']` exists, and then writes whitelisted parameters into the session key, replicating the first two lines of our ugly implementation directly in the `list` method in the last section.\n\nOnce the filters are stored, `apply_filters` calls a `filter` class method from the class we’re interested in which should return a list of ActiveRecord objects.\n\nYou’ll notice here that `Filterable` isn’t doing much on its own. Instead, it is relying on methods to exist on the class passed in to `filter!`. This is by design — in a real application, we would likely need to build filtering mechanisms for many different ActiveRecord classes, and each will need to be able to filter by a unique set of columns. Trying to build all of that logic into the `Filterable` module would quickly become even harder to maintain than tossing everything in the controller.\n\nRather than building all of that complexity in to `Filterable`, we instead just rely on the target class to define `FILTER_PARAMS` and a `filter` method in whatever way works for that particular class.\n\nLet’s see this in action by updating `app/models/player.rb` to work with our new `Filterable` concern.\n\n```ruby\nclass Player < ApplicationRecord\n  belongs_to :team\n\n  FILTER_PARAMS = %i[name column direction].freeze\n\n  scope :by_name, ->(query) { where(\'players.name ilike ?\', "%#{query}%") }\n\n  def self.filter(filters)\n    Player.includes(:team)\n          .by_name(filters[\'name\'])\n          .order("#{filters[\'column\']} #{filters[\'direction\']}")\n  end\nend\n```\n\nHere we’ve defined the `FILTER_PARAMS` constant with the three filtering we support on the players table.\n\nNext, we added the `by_name` scope to handle searching the players table by name.\n\nFinally, we implement `filter`, which replaces the queries that we previously built in `PlayersController#list` and makes use of the new `by_name` scope to be a bit more readable.\n\nWith `Player` set up for filtering, we can update `PlayersController` to include `Filterable` and replace the filtering logic in `list` with the new `filter!` method.\n\n```ruby\nclass PlayersController < ApplicationController\n  include Filterable\n  # snip\n  def list\n    players = filter!(Player)\n    render(partial: \'players\', locals: { players: players })\n  end\nend\n```\n\nHere we simply include `Filterable` in the controller and then set the value of `players` using the `filter!` method provided by `Filterable`.\n\nMuch nicer, right?\n\nBefore moving on, you\'ll also notice that `Filterable` is in the `controller/concerns` directory, but it isn\'t truly a [Concern](https://api.rubyonrails.org/v6.1.4/classes/ActiveSupport/Concern.html). In our case, controller concerns is the simplest place for this module to live, but we don\'t need the full functionality of a true concern. You could just as easily place this module in another place if you prefer.\n\nOur last step is to update the views to read values from the session instead of params so that we always display the correct set of applied filters to users. \n\nFirst, update the table header in `_players` like this:\n\n```erb\n<tr>\n  <th id="players-name" class="text-left py-3 px-6 uppercase font-semibold text-sm hover:cursor-pointer relative">\n    <%= sort_indicator if session.dig(\'player_filters\', \'column\') == "name" %>\n    <%= build_order_link(column: "name", label: "Name") %>\n  </th>\n  <th id="players-team" class="text-left py-3 px-6 uppercase font-semibold text-sm hover:cursor-pointer relative">\n    <%= sort_indicator if session.dig(\'player_filters\', \'column\') == "teams.name" %>\n    <%= build_order_link(column: "teams.name", label: "Team") %>\n  </th>\n  <th id="players-seasons" class="text-left py-3 px-6 uppercase font-semibold text-sm hover:cursor-pointer relative">\n    <%= sort_indicator if session.dig(\'player_filters\', \'column\') == "seasons" %>\n    <%= build_order_link(column: "seasons", label: "Seasons") %>\n  </th>\n</tr>\n```\n\nWe’ve replaced references to `params` with `session.dig` calls with this change. When no filters have been applied, `session[\'player_filters\']` won’t exist, so we use `dig` to avoid nil errors in those cases.\n\nNext, update `app/heleprs/players_helper.rb` like this:\n\n```ruby\nmodule PlayersHelper\n  def build_order_link(column:, label:)\n    if column == session.dig(\'player_filters\', \'column\')\n      link_to(label, list_players_path(column: column, direction: next_direction))\n    else\n      link_to(label, list_players_path(column: column, direction: \'asc\'))\n    end\n  end\n\n  def next_direction\n    session[\'player_filters\'][\'direction\'] == \'asc\' ? \'desc\' : \'asc\'\n  end\n\n  def sort_indicator\n    tag.span(class: "sort sort-#{session[\'player_filters\'][\'direction\']}")\n  end\nend\n```\n\nAgain we’re just replacing params with the equivalent session values so that sorting works correctly all the time and visual indicators are shown consistently.\n\nWith those changes in place, refresh the page and see that you can search and sort the table at the same time, and the UI always shows the proper sort indicator.\n\nNice work making it this far! We spent a good amount of time building a more scalable filtering solution, so let’s wrap up this article by putting that scalable solution to use by adding a filtering option to the table.\n\n### Add filtering by team\nRight now users can search by player name and sort the table, but they can’t filter by team or season. Let’s add filtering by team to the filter options.\n\nWe’re going to use a select input for the Team filter, since `team` is a `belongs_to` relationship on the `Player` class — we’ll have a dropdown menu that displays all available teams by name, each dropdown option will have `team_id` as the value sent back to the server.\n\nSince we’re using a select input, let’s make it look nice by taking a slight detour to install Tailwind’s forms plugin:\n\nFrom your terminal:\n\n```\nyarn add @tailwindcss/forms\n```\n\nAnd then update `tailwind.config.js` to include the plugin:\n\n```javascript\nplugins: [\n  require(\'@tailwindcss/forms\'),\n]\n```\n\nIncredible stuff.\n\nBack to adding the team filter. We’ll start by adding the team filter to the UI. In the `players` partial:\n\n```erb\n<%= form_with url: list_players_path, method: :get, data: { controller: "search-form", search_form_target: "form", turbo_frame: "players" } do |form| %>\n  <%= form.select :team_id,\n    options_for_select(\n      Team.all.pluck(:name, :id),\n      session.dig(\'player_filters\', \'team_id\')\n    ),\n    { include_blank: \'All Teams\' },\n    class: "border-blue-500 rounded",\n    data: { \n      action: "change->search-form#search" \n    } \n  %>\n\x3c!-- Snip the search input --\x3e\n<% end %>\n```\n\nThis is a regular Rails `select` helper. In it, we build a list of all teams in the database, set the selected value when one is present (`session.dig`, again) and fire the `search` function of the `search-form` controller each time the select input changes.\n\nRefresh the page, change the team input and see that it doesn\'t work yet. We haven’t updated `Player` to support filtering by team yet.\n\nHead to `app/models/player.rb` and update it like this:\n\n```ruby\nFILTER_PARAMS = %i[name team_id column direction].freeze\n\nscope :by_team, ->(team_id) { where(team_id: team_id) if team_id.present? }\n\ndef self.filter(filters)\n  Player.includes(:team)\n        .by_name(filters[\'name\'])\n        .by_team(filters[\'team_id\'])\n        .order("#{filters[\'column\']} #{filters[\'direction\']}")\nend\n```\n\nNow we can start to see the benefit of the work we did in the last section. We can add filtering by a new option with just a few simple changes to the model.\n\nWe updated the model to add `team_id` to the list of valid `FILTER_PARAMS`, added the `by_team` scope, and then added `by_team` to the `filters` method.\n\nNo need to change our controller or touch the `Filterable` module — updating the model is all we need.\n\nRefresh the page, apply a team filter and see that filtering by team works along with searching by name and sorting. Great work!\n\n![A screen recording of a user interacting with a table on a website. They click column headers to sort the table, use a drop down menu to filter the table by a specific team, and type in a search box to filter the table by name](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/6b7qgskgktg5814w0bmo.gif)\n\n## Filtering the index action\nWe’ll wrap up this exercise by make a few more small adjustments to avoid weirdness when a user visits the `/players` with filtering values already saved in their session.\n\nFirst, now that we have access to the `filter!` method, we can update the `index` action to use that method instead of always setting the value of `players` to all players in the database.\n\nTo do that, update `index` in `app/controllers/players_controller.rb` like this:\n\n```ruby\ndef index\n  @players = filter!(Player)\nend\n```\n\nWith that change in place, we’ll now filter the list of players properly when a user reloads players page after applying filters in a previous request, making the experience on the index page a bit more consistent.\n\nFinally, since we’re using the session values to restore previously applied filters, we need to update the `name` search field to set its `value` from the session. Without this change, when the user applies a name search and then refreshes the page, the list of players will be filtered by name, but the search term won’t be visible in the name field.\n\nTo fix this issue,  update the name field in the `players` partial like this:\n\n```erb\n<%= form.text_field :name,\n  placeholder: "Search by name",\n  value: session.dig(\'player_filters\', \'name\'),\n  class: "border border-blue-500 rounded p-2",\n  autocomplete: "off",\n  data: { action: "input->search-form#search" }\n%>\n```\n\nWith `value` added to the `name` field, we’ll always show the correct value to users, even on the initial page load.\n\nWith these small changes in places, we’ve now got consistent filtering experience that persists cleanly across requests and can be extended with new options as our user experience requirements change.\n\nNice work making it this far!\n\nYou\'ve reached the end of the tutorial portion of the article, we\'ll finish up by discussing a few ways we could improve this implementation in a production application.\n\n## Production-grade considerations\nWhile what we built today works fine, there are some things to consider if we were building a real, consumer-facing application.\n\nOur code works and is pretty easy to maintain, but before we go, let’s touch on a few points to think about for production-grade applications. These are intended simply as things to think about as you build, and we won’t be going through any code here:\n\n### Session storage limitations\nWe are relying on the `session` object to store filter options. This is fine for small applications, but as you grow, you may run into the limits of storing options like this in the session.\n\nBy default, Rails stores the session in a cookie which can only be ~4kb before it will start raising errors. You can use a [different session store](https://guides.rubyonrails.org/v4.1.4/action_controller_overview.html#session) but you may want to consider a more flexible solution for storing filter options.\n\nOne option here is to use [Kredis](https://github.com/rails/kredis), a Redis-based solution that provides a nice interface for solving problems like our session persistance problem today.\n\n### Replace helper methods\nThe helper methods we are using to render sorting links and indicators could be implemented as [ViewComponents](https://viewcomponent.org/).\n\nThis pattern allows us to write more testable and reusable view code and excels in cases like our example application. As this application grows, we should expect to have multiple tables across our application that all need sort links.\n\nRather than implementing them as helpers that are very specific to the players table, we could create them as generic components that can be thoroughly tested and then reused throughout the code base.\n\n### Expand Filterable implementation\nRight now, `Filterable` relies on each model to define `FILTER_PARAMS` and a `filter` method from scratch.\n\nIn the real world, there would likely be enough overlap between the different implementations of `filter` in each model that we would benefit from moving `filter` out of each model and into a `Filter` class that defines some shared logic, like applying `order`, which is likely to be the same for every class.\n\nFor a really detailed implementation of a `Filterable` pattern, take a look at the [filterable_reflex](https://www.stimulusreflexpatterns.com/patterns/filterable_reflex/) from StimulusReflex Patterns.\n\n## Wrapping up\nToday we built on a Turbo Frame foundation to expand a sortable table view to a table that can be searched, filtered, and sorted without full page turns or lots of custom JavaScript.\n\nBecause frames are so powerful, we were able to easily hook into our existing frame code and add in searching and filtering without thinking too much about the front end implementation. It mostly just worked, once we built the filtering logic on the server.\n\nThis is the power of Turbo Frames — we can build fast, efficient user interfaces without stepping much outside of standard Rails code. The client side code stays light and maintainable, while our server looks and feels familiar to any level of Rails developer.\n\nTo dig deeper into Turbo and building modern Ruby on Rails applications with the Hotwire stack:\n* Read my articles on [Turbo Frames](https://www.colby.so/posts/turbo-frames-on-rails) and [Turbo Streams](https://www.colby.so/posts/turbo-streams-on-rails) on Rails\n* Dive into the [Turbo](https://github.com/hotwired/turbo) and [turbo-rails](https://github.com/hotwired/turbo-rails) source and follow along with the Github activity for both\n* Join the [hotwire discussion forums](https://discuss.hotwired.dev/)\n* (Shameless plug) Sign up for my monthly newsletter, [Hotwiring Rails](https://landing.mailerlite.com/webforms/landing/d7z0n0), to stay up to date on the latest developments in Rails-land\n\nThat’s all for today. As always, thanks for reading!\n',e.user={name:"David Colby",username:n,twitter_username:n,github_username:"DavidColby",website_url:"https://colby.so",profile_image:"https://res.cloudinary.com/practicaldev/image/fetch/s--dkssf6E5--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/510445/f91e2161-c944-4001-bcc4-2be8fa3aa689.jpg",profile_image_90:"https://res.cloudinary.com/practicaldev/image/fetch/s--hGnCh9nu--/c_fill,f_auto,fl_progressive,h_90,q_auto,w_90/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/510445/f91e2161-c944-4001-bcc4-2be8fa3aa689.jpg"},{layout:"default",data:[{}],fetch:{"data-v-70afb46a:0":{article:e}},error:a,state:{currentArticle:e},serverRendered:!0,routePath:"/davidcolbyatx/865146",config:{_app:{basePath:"/nuxtstop/",assetsPath:"/nuxtstop/_nuxt/",cdnURL:a}}}}("2021-10-15T19:34:30Z",null,{},"davidcolbyatx")</script><script src="/nuxtstop/_nuxt/f6e87fb.js" defer></script><script src="/nuxtstop/_nuxt/dc9ce94.js" defer></script><script src="/nuxtstop/_nuxt/6474719.js" defer></script><script src="/nuxtstop/_nuxt/9b75090.js" defer></script><script src="/nuxtstop/_nuxt/18df600.js" defer></script>
  </body>
</html>
