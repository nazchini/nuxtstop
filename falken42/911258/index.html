<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>初めてのStripe: 完全にサーバーレスのチケット販売</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="Using Nuxt.js fetch() hook to build dev.to with a new look"><meta data-n-head="ssr" name="format-detection" content="telephone=no"><base href="/nuxtstop/"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,500,600&display=swap"><link rel="preload" href="/nuxtstop/_nuxt/f6e87fb.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/6474719.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/9b75090.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/18df600.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/dc9ce94.js" as="script"><style data-vue-ssr-id="c650fd98:0 af4684f0:0 a9c71758:0 dcafa518:0 4b9cec49:0 b093d766:0 9d98bcb4:0 6b6a11ea:0 0248ed80:0 ea8e4264:0">html{box-sizing:border-box;font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}*,:after,:before{box-sizing:inherit}html{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}*,:after,:before{border:0 solid #e0e0e0}blockquote,body,dd,dl,figure,h1,h2,h3,h4,h5,h6,p,pre{margin:0}button{background:0 0;padding:0}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}hr{border-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:inherit;opacity:.5}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:inherit;opacity:.5}input::placeholder,textarea::placeholder{color:inherit;opacity:.5}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit;font-family:sans-serif}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit;font-family:inherit;font-size:100%}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;overflow:auto;word-break:break-word;white-space:normal}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}html{height:100%;font-size:18px;-ms-overflow-style:scrollbar;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}@media(min-width:640px){html{font-size:20px}}body{height:100%;min-width:320px;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:400;line-height:1.5;color:#000;background-color:#eff4f7;-webkit-text-rendering:optimizeLegibility;text-rendering:optimizeLegibility;font-synthesis:none;font-kerning:normal;font-feature-settings:"normal","kern";-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-overflow-scrolling:touch;overflow-x:hidden;overflow-y:scroll}h1,h2,h3,h4,h5,h6{color:#000;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:600;font-feature-settings:"normal";line-height:1.2}pre{background:#29292e;border-radius:2px;overflow:auto;padding:1rem;color:#eff1f9;line-height:1.42em;font-size:13px}@media screen and (min-width:380px){pre{font-size:15px}}pre code{background:#29292e;color:#eff0f9;white-space:pre}div.highlight pre.highlight code{font-size:inherit;padding:0}div.inner-comment div.body div.highlight pre.highlight{background:#29292e}div.inner-comment div.body div.highlight pre.highlight code{font-size:inherit;white-space:inherit;background:inherit;color:inherit}.highlight .hll{background-color:#49483e}.highlight{background:#29292e;color:#f8f8f2}.highlight .c{color:grey}.highlight .err{text-shadow:0 0 7px #f9690e}.highlight .k{color:#f39c12}.highlight .l{color:plum}.highlight .n{color:#f8f8f2}.highlight .o{color:#f9690e}.highlight .p{color:#f8f8f2}.highlight .c1,.highlight .ch,.highlight .cm,.highlight .cp,.highlight .cpf,.highlight .cs{color:grey}.highlight .gd{color:#f9690e}.highlight .ge{font-style:italic}.highlight .gi{color:#7ed07e}.highlight .gs{font-weight:700}.highlight .gu{color:grey}.highlight .kc,.highlight .kd{color:#f39c12}.highlight .kn{color:#f9690e}.highlight .kp,.highlight .kr,.highlight .kt{color:#f39c12}.highlight .ld{color:#f2ca27}.highlight .m{color:plum}.highlight .s{color:#f2ca27}.highlight .na{color:#7ed07e}.highlight .nb{color:#f8f8f2}.highlight .nc{color:#7ed07e}.highlight .no{color:#f39c12}.highlight .nd{color:#7ed07e}.highlight .ni{color:#f8f8f2}.highlight .ne,.highlight .nf{color:#7ed07e}.highlight .nl,.highlight .nn{color:#f8f8f2}.highlight .nx{color:#7ed07e}.highlight .py{color:#f8f8f2}.highlight .nt{color:#f9690e}.highlight .nv{color:#f8f8f2}.highlight .ow{color:#f9690e}.highlight .w{color:#f8f8f2}.highlight .mb,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo{color:plum}.highlight .dl,.highlight .s2,.highlight .sa,.highlight .sb,.highlight .sc,.highlight .sd{color:#f2ca27}.highlight .se{color:plum}.highlight .s1,.highlight .sh,.highlight .si,.highlight .sr,.highlight .ss,.highlight .sx{color:#f2ca27}.highlight .bp{color:#f8f8f2}.highlight .fm{color:#7ed07e}.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{color:#f8f8f2}.highlight .il{color:plum}.vue-content-placeholders-heading__img,.vue-content-placeholders-heading__subtitle,.vue-content-placeholders-heading__title,.vue-content-placeholders-img,.vue-content-placeholders-text__line{background:#bfcdec!important}.vue-content-placeholders-is-animated .vue-content-placeholders-heading__img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__subtitle:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__title:before,.vue-content-placeholders-is-animated .vue-content-placeholders-img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-text__line:before{background:linear-gradient(90deg,transparent 0,#d3ddf9 15%,transparent 30%)!important}header[data-v-27046cca]{max-width:1280px;margin:auto;padding:1rem;height:6rem;border-bottom:1px solid rgba(0,0,0,.2)}header .logo-wrapper[data-v-27046cca],header[data-v-27046cca]{display:flex;align-items:center;justify-content:space-between}header .logo-wrapper[data-v-27046cca]{margin:0 .5rem}header .logo-wrapper svg[data-v-27046cca]{width:3rem;height:100%}header .logo-wrapper .name-wrapper[data-v-27046cca]{margin-left:.6em}header .logo-wrapper .name-wrapper .subtitle[data-v-27046cca]{font-size:1rem}header .logo-wrapper .name-wrapper .app-name[data-v-27046cca]{font-weight:700;font-size:2.25rem;line-height:1.25}header nav[data-v-27046cca]{letter-spacing:-.025rem;font-weight:600;text-transform:uppercase}header nav ul[data-v-27046cca]{display:flex}header nav ul li[data-v-27046cca]{margin:0 .5rem}header nav ul li a[data-v-27046cca]{box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;padding:.25rem 1rem;border-radius:.5rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}header nav ul li a[data-v-27046cca]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header nav ul li a.nuxt-link-exact-active[data-v-27046cca]{cursor:default}header nav ul li a.nuxt-link-exact-active[data-v-27046cca],header nav ul li a[data-v-27046cca]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}.page-wrapper[data-v-10d06ee8]{max-width:1280px;margin:auto;padding:1rem}.article-content-wrapper[data-v-10d06ee8]{display:flex;flex-direction:column;align-items:center;margin:auto auto 2rem}@media(min-width:1024px){.article-content-wrapper[data-v-10d06ee8]{align-items:normal;flex-direction:row}}.article-content-wrapper .article-block[data-v-10d06ee8]{width:100%;max-width:880px}@media(min-width:1024px){.article-content-wrapper .article-block[data-v-10d06ee8]{margin-right:1rem;width:66.66666%;margin-bottom:2rem}}.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{max-width:880px;width:100%;position:relative}@media(min-width:1024px){.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{display:block;width:33.33333%}}.article-content-wrapper .aside-username-wrapper .aside-username-block[data-v-10d06ee8]{position:-webkit-sticky;position:sticky;top:1rem}@media(min-width:1280px){.comments-block[data-v-10d06ee8]{margin:.5rem}}article[data-v-70afb46a]{padding:.5rem;border-radius:1rem}header h1[data-v-70afb46a],header[data-v-70afb46a]{margin-bottom:1rem}header h1[data-v-70afb46a]{font-size:2.25rem;letter-spacing:-.025rem}header .tags[data-v-70afb46a]{display:flex;flex-wrap:wrap;margin-bottom:1.5rem}header .tags .tag[data-v-70afb46a]{font-weight:500;line-height:1;padding:.5rem;margin:0 .5rem .5rem 0;border-radius:.25rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db}header .tags .tag[data-v-70afb46a]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header .tags .tag[data-v-70afb46a]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}header .image-wrapper[data-v-70afb46a]{position:relative;padding-bottom:56.25%;background-color:#d4dfe8;margin-bottom:1.5rem;border-radius:.5rem;overflow:hidden}@media(min-width:834px){header .image-wrapper[data-v-70afb46a]{margin-bottom:1.5rem}}header .image-wrapper img[data-v-70afb46a]{position:absolute;top:0;left:0;width:100%;height:100%;-o-object-fit:cover;object-fit:cover}header .meta[data-v-70afb46a]{line-height:1;font-size:.875rem;text-transform:uppercase;font-weight:500;letter-spacing:-.025rem;display:flex;align-items:center;justify-content:space-between}header .meta .scl[data-v-70afb46a]{display:flex}header .meta .scl span[data-v-70afb46a]{display:flex;align-items:center;margin-right:1rem}header .meta .scl span svg[data-v-70afb46a]{margin-right:.25rem}header .meta .scl .comments[data-v-70afb46a]{cursor:pointer}[data-v-70afb46a] .content .ltag__user{display:none}[data-v-70afb46a] .content iframe{max-width:100%}[data-v-70afb46a] .content h1{font-size:1.875rem}[data-v-70afb46a] .content h1,[data-v-70afb46a] .content h2{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h2{font-size:1.5rem}[data-v-70afb46a] .content h3{font-size:1.25rem}[data-v-70afb46a] .content h3,[data-v-70afb46a] .content h4{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h4{font-size:1rem}[data-v-70afb46a] .content a{color:#6e87d2}[data-v-70afb46a] .content p{margin-bottom:1rem;line-height:1.4}[data-v-70afb46a] .content p code{background-color:#d2f3e1;border-radius:.25rem;padding:.25rem}[data-v-70afb46a] .content img{width:100%;border-radius:.5rem}[data-v-70afb46a] .content .highlight{margin-bottom:1rem;border-radius:.5rem}[data-v-70afb46a] .content ul{list-style:numeral;margin-bottom:1rem}[data-v-70afb46a] .content ul li p{margin-bottom:0}[data-v-70afb46a] .content ol{margin-bottom:1rem}aside[data-v-37984f8c]{padding:1rem;background-color:#dfe8ef;border-radius:1rem}aside .username-heading[data-v-37984f8c]{display:flex;margin-bottom:1rem}aside .username-heading[data-v-37984f8c]:hover{color:#6e87d2}aside .username-heading img[data-v-37984f8c]{width:3rem;height:3rem;border-radius:50%;margin-right:1rem}aside .username-heading .text[data-v-37984f8c]{display:flex;flex-direction:column;justify-content:center}aside .username-heading .text a[data-v-37984f8c]{line-height:1}aside .username-heading .text a[data-v-37984f8c]:first-child{font-size:1.25rem;font-weight:500;letter-spacing:-.025rem;margin-bottom:.25rem}aside .username-heading .text a[data-v-37984f8c]:last-child{color:#999;font-size:.875rem}aside .username-heading.loading[data-v-37984f8c]{display:block}aside .f-button[data-v-37984f8c]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}aside .f-button[data-v-37984f8c]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}aside .f-button[data-v-37984f8c]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}aside .info>div[data-v-37984f8c]{margin-bottom:.5rem}aside .info .title[data-v-37984f8c]{font-size:.666666rem;letter-spacing:-.0125rem;font-weight:500;color:#999;text-transform:uppercase;margin-bottom:.1rem}aside .info .content[data-v-37984f8c]{font-size:.875rem;line-height:1.4}.add-comment[data-v-8c4375bc]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}.add-comment[data-v-8c4375bc]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}.add-comment[data-v-8c4375bc]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}footer[data-v-22cb8fd0]{padding:2rem;text-align:center;display:flex;align-items:center;justify-content:center}footer span[data-v-22cb8fd0]{display:inline-block;line-height:1;text-transform:uppercase;letter-spacing:-.025rem;font-size:.75rem;font-weight:500}footer a svg[data-v-22cb8fd0]{width:3rem;height:3rem;margin:0 .5rem}footer a .nuxt-icon[data-v-22cb8fd0]{width:2.5rem;height:2.5rem;margin:0 .25rem}</style>
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><div id="__layout"><div><header data-v-27046cca><a href="/nuxtstop/" class="logo-wrapper nuxt-link-active" data-v-27046cca><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-27046cca><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-27046cca></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-27046cca></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-27046cca></path></svg> <div class="name-wrapper" data-v-27046cca><span class="app-name" data-v-27046cca>Nuxtstop</span> <p class="subtitle" data-v-27046cca>For all things nuxt.js</p></div></a> <nav data-v-27046cca><ul data-v-27046cca><li data-v-27046cca><a href="/nuxtstop/" class="nuxt-link-active" data-v-27046cca>
          New
        </a></li><li data-v-27046cca><a href="/nuxtstop/top" data-v-27046cca>
          Top
        </a></li></ul></nav></header> <div class="page-wrapper" data-v-10d06ee8><div class="article-content-wrapper" data-v-10d06ee8><article data-fetch-key="data-v-70afb46a:0" class="article-block" data-v-70afb46a data-v-10d06ee8><header data-v-70afb46a><h1 data-v-70afb46a>初めてのStripe: 完全にサーバーレスのチケット販売</h1> <div class="tags" data-v-70afb46a><a href="/nuxtstop/t/serverless" class="tag" data-v-70afb46a>
          #serverless
        </a><a href="/nuxtstop/t/stripe" class="tag" data-v-70afb46a>
          #stripe
        </a><a href="/nuxtstop/t/aws" class="tag" data-v-70afb46a>
          #aws
        </a><a href="/nuxtstop/t/demoscene" class="tag" data-v-70afb46a>
          #demoscene
        </a></div> <div class="image-wrapper" data-v-70afb46a><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--qEYd9l-B--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/qqqwzy695mjn121oiz66.png" alt="初めてのStripe: 完全にサーバーレスのチケット販売" data-v-70afb46a></div> <div class="meta" data-v-70afb46a><div class="scl" data-v-70afb46a><span data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M16.4444 3C14.6733 3 13.0333 3.94162 12 5.34C10.9667 3.94162 9.32667 3 7.55556 3C4.49222 3 2 5.52338 2 8.625C2 14.8024 11.0267 20.586 11.4122 20.829C11.5922 20.9426 11.7956 21 12 21C12.2044 21 12.4078 20.9426 12.5878 20.829C12.9733 20.586 22 14.8024 22 8.625C22 5.52338 19.5078 3 16.4444 3Z" fill="#FF0000" data-v-70afb46a data-v-70afb46a></path></svg>
            10
          </span> <span class="comments" data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M6.11765 22H4.94118L5.64706 21.05C6.11765 20.3969 6.41176 19.5656 6.58824 18.5563C3.64706 17.1906 2 14.6375 2 11.3125C2 6.20625 5.82353 3 12 3C18.1765 3 22 6.20625 22 11.3125C22 16.5375 18.2353 19.625 12 19.625H11.5882C10.6471 20.7531 9 22 6.11765 22ZM12 4.1875C6.47059 4.1875 3.17647 6.85937 3.17647 11.3125C3.17647 15.1125 5.47059 16.8938 7.41177 17.6656L7.82353 17.8437L7.76471 18.3187C7.64706 19.2687 7.47059 20.1 7.11765 20.8125C9.05882 20.575 10.1765 19.5656 10.8235 18.7344L11 18.4969H12C19.9412 18.4969 20.8235 13.5094 20.8235 11.3719C20.8235 6.85938 17.5294 4.1875 12 4.1875Z" fill="black" data-v-70afb46a data-v-70afb46a></path></svg>
            0
          </span></div> <time data-v-70afb46a>Dec 2 '21</time></div></header> <div class="content" data-v-70afb46a><p>[ This post is available <a href="https://dev.to/aws-builders/first-time-with-stripe-fully-serverless-ticket-sales-329a">in English here</a>. ]</p>

<p>本ブログは2021年<a href="https://qiita.com/advent-calendar/2021/stripe">Stripe Advent Calendar 2021</a>の12月3日分のエントリーです。</p>


<hr>

<p>皆さん、こんにちは！Tokyo Demo Fest実行委員のテッダー　マイケルです。AWSとの9年間の開発経験を活かしながら、JAWS-UG札幌支部とJAWS-UGのコミュニティイベント（<a href="https://jft2019.jaws-ug.jp/">FESTA 2019</a>、<a href="https://jawsdays2021.jaws-ug.jp/">DAYS 2021</a>、<a href="https://jawspankration2021.jaws-ug.jp/">PANKRATION 2021</a>）の運営を手伝いしています。2020年にAWSコミュニティビルダーに認定されました。</p>

<p>今回はTokyo Demo Fest 2021のチケット販売のため、AWS上で初めてStripeを実装した話を詳しくご紹介します。Stripeをまだ触っていない方でもわかりやすく伝えたいと思います。サンプルコードの言語はNode.js 14.xになります。</p>

<h2>
  <a name="tokyo-demo-fest%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6" href="#tokyo-demo-fest%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">
  </a>
  Tokyo Demo Festについて
</h2>

<p>Tokyo Demo Fest (略: TDF)は日本で唯一のデモパーティです。デモパーティは、コンピュータを用いたプログラミングとアートに興味のある人々が日本のみならず、世界中から一堂に会し、デモ作品のコンペティション(コンポ)やセミナーなどを行います。また、イベント開催中は集まった様々な人たちとの交流が深められます。</p>

<p>デモについての解説は<a href="https://tokyodemofest.jp/2016/?lang=ja#aboutdemo">こちらをご参照ください</a>。</p>

<p>過去のTDFのチケット販売はPayPalで行いましたが、今年からはようやくStripeに移行することができました。今回は実装がとても簡単なStripe Checkoutを利用し、実際のコーディングは数時間程度で対応できました。</p>

<h2>
  <a name="%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E8%A8%AD%E8%A8%88" href="#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E8%A8%AD%E8%A8%88">
  </a>
  システム設計
</h2>

<p>こちらが全体図です。今回はStripeに限る話だけなので、ライブ配信周りなどは描かれてません。Stripeとその関係するシステムのみになります。</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--fIPhTsSR--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/di5bdgrkerfx41kzi69h.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--fIPhTsSR--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/di5bdgrkerfx41kzi69h.png" alt="Serverless Stripe Diagram" loading="lazy" width="880" height="706"></a></p>

<p>Visitorは最初にAmplifyで公開されている<a href="https://tokyodemofest.jp/index_ja.html">TDFのWebサイト</a>から入ります。2種類のチケットがあるのでどちらかを選択し、Stripe Checkoutへ移行します。決済完了時はStripeからのWebhookが呼び出され、チケット情報とVotekeyがStripeでの購入時に入力されたメールアドレスに送信されます。Visitorはメールで配布されたVotekeyを使い、<a href="https://github.com/Gargaj/wuhu">Wuhuパーティシステム</a> (ECS/Fargate)にログインできるようになります。</p>

<h2>
  <a name="stripe%E5%95%86%E5%93%81%E3%81%AE%E4%BD%9C%E6%88%90" href="#stripe%E5%95%86%E5%93%81%E3%81%AE%E4%BD%9C%E6%88%90">
  </a>
  Stripe商品の作成
</h2>

<p>今回のTDFではチケットを2種類販売しています。</p>

<ol>
<li>Visitor Ticket（1,000円）</li>
<li>Bronze Supporter (10,000円、Tシャツ無料配送込み)</li>
</ol>

<p>Visitor TicketはStripeでは1つの「商品」になるので、簡単ですね。</p>

<p>Bronze SupporterはVisitor Ticketと金額が違うため別の商品が必要ですが、Tシャツのサイズ（S/M/L/XL）の選択もあるので、サイズ別の4つの商品を作成しました。Tシャツはチケット代に含まれているので、それぞれのサイズの金額は「ゼロ円」に設定しています。そしてTシャツは配送になるため、購入時にVisitorの住所入力が必要です。</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--ai5xUVhU--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/u418fcq355zfmtxtnxqp.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--ai5xUVhU--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/u418fcq355zfmtxtnxqp.png" alt="TDF Stripe Products" loading="lazy" width="880" height="632"></a></p>

<p>Stripeで配送情報を入力させるためには「配送料金」を作成する必要があります。今回はTシャツの配送料もチケット代に含まれているため、こちらの金額も「ゼロ円」に設定しています。</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--IihEjYFH--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/bvj9r6cp4jwpvlqd7jwo.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--IihEjYFH--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/bvj9r6cp4jwpvlqd7jwo.png" alt="TDF Stripe Shipping" loading="lazy" width="880" height="263"></a></p>

<h2>
  <a name="stripe-api%E3%82%AD%E3%83%BC%E3%81%AE%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3" href="#stripe-api%E3%82%AD%E3%83%BC%E3%81%AE%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3">
  </a>
  Stripe APIキーのセキュリティ
</h2>

<p>Stripe APIキーは秘密情報なので、ソースコードに書き込んだりすると情報漏えいの要因になります。私のいつもの実装パターンですが、Lambdaを使ってる時はAWS Systems Managerの<a href="https://docs.aws.amazon.com/ja_jp/systems-manager/latest/userguide/systems-manager-parameter-store.html">Parameter Store</a>にAPIキー等を保存することにしています。</p>

<p>APIキー、Webhookシークレット、商品のPriceID、配送料金IDなどは1つずつ別々のSecureStringに保存が可能ですが、実はStandardでも4KBまで保存が可能なので、すべての必要な情報をJSON化にし、1つの文字列として保存するのがとても楽です。</p>

<p>以下、キーの内容は隠してますが、実際保存してるデータがこんな感じです。<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>{"stripe_api_secret_key":"sk_test_51JU2XXXXXXXXXXXX",
"webhook_signing_secret":"whsec_TqW4TXXXXXXXXXXXX",
"product_visitor_ticket":"price_1JX1zXXXXXXXXXXXX",
"product_bronze_ticket":"price_1JrKaXXXXXXXXXXXX",
"product_tshirt_s":"price_1JrKlXXXXXXXXXXXX",
"product_tshirt_m":"price_1JrKmXXXXXXXXXXXX",
"product_tshirt_l":"price_1JrKnXXXXXXXXXXXX",
"product_tshirt_xl":"price_1JrKoXXXXXXXXXXXX",
"success_url":"https://tokyodemofest.jp/success.html",
"cancel_url":"https://tokyodemofest.jp#registration",
"shipping_rate":"shr_1JrKNXXXXXXXXXXXX",
"shipping_countries":"US,JP,IE,GB,NO,SE,FI,RU,PT,ES,FR,DE,CH,IT,PL,CZ,AT,HU,BA,BY,UA,RO,BG,GR,AU,NZ,KR,TW,IS"}
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Lambdaが実行されてる際、このJSONをパラメータストアから読み込むためには Lambdaに内蔵されてる <code>aws-sdk</code> を使います。Stripeの初期化にはAPIキーを渡すのが必要なので、SSMからconfigを引っ張ってから初期化を行います。<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>const loadConfig = async function() {
  const aws = require('aws-sdk');
  const ssm = new aws.SSM();
  const res = await ssm.getParameter( { Name: '/tdf/config-stripe', WithDecryption: true } ).promise();
  return JSON.parse(res.Parameter.Value);
}

exports.handler = async (event) => {
  const config = await loadConfig();
  const stripe = require('stripe')(config.stripe_api_secret_key);
  // ...
}
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<h2>
  <a name="html%E5%81%B4%E3%81%AE%E8%B3%BC%E5%85%A5%E3%83%9C%E3%82%BF%E3%83%B3%E4%BD%9C%E6%88%90" href="#html%E5%81%B4%E3%81%AE%E8%B3%BC%E5%85%A5%E3%83%9C%E3%82%BF%E3%83%B3%E4%BD%9C%E6%88%90">
  </a>
  HTML側の購入ボタン作成
</h2>

<p>参考のため、今回のTDFのHTML側の購入ボタンを軽く紹介します。</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--356gi-dM--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/g5o6ttt7wdnu9bnjuhdq.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--356gi-dM--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/g5o6ttt7wdnu9bnjuhdq.png" alt="TDF Visitor Ticket" loading="lazy" width="880" height="122"></a></p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--Yc0c8M06--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/08ukha0sn2r182dqwq24.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--Yc0c8M06--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/08ukha0sn2r182dqwq24.png" alt="TDF Bronze Supporter" loading="lazy" width="880" height="122"></a></p>

<p>チケットの種類が2つなのですが、実はPOSTするエンドポイントが同じです。</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--gMX4Re3K--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/z90o2ltnbje9dcyddxtt.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--gMX4Re3K--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/z90o2ltnbje9dcyddxtt.png" alt="TDF Ticket HTML" loading="lazy" width="880" height="580"></a></p>

<p>Lambda側でチケットの違いをわかるためには <code>&lt;input type="hidden" name="type" value="bronze"></code> で判断しています。そして <code>type=bronze</code> の場合はTシャツサイズの <code>tshirt</code> 指定もわかります。</p>

<p>Stripe CheckoutにBronze SupporterチケットとTシャツの商品指定は次のセクションで紹介します。</p>

<h2>
  <a name="stripe-checkout%E3%81%B8%E3%81%AEurl%E7%94%9F%E6%88%90" href="#stripe-checkout%E3%81%B8%E3%81%AEurl%E7%94%9F%E6%88%90">
  </a>
  Stripe CheckoutへのURL生成
</h2>

<p>次はWebサイトでVisitorがチケット購入ボタンを押したら、Stripe Checkoutに移行させます。このURLには、どの商品を購入するとか、購入時に必要な情報（住所の入力が必要かどうか）が含まれています。URL生成はStripe SDKが行うので、URLが作成されたら、ブラウザに <code>HTTP 303</code> (See Other) で転送されると、Stripe Checkoutのページが表示されます。</p>

<p>LambdaでCheckoutセッションのURLを生成し転送させるにはこんな感じです。<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>exports.handler = async (event) => {
  const config = await loadConfig();
  const stripe = require('stripe')(config.stripe_api_secret_key);

  const session = await stripe.checkout.sessions.create( {
    line_items: /* TODO */,
    payment_method_types: [ 'card' ],
    mode: 'payment',
    success_url: config.success_url,
    cancel_url: config.cancel_url
  } );

  const response = {
    statusCode: 303,
    headers: {
      'Location': session.url
    }
  };

  return response;
}
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>セッションデータの <code>line_items</code> は商品を指定します。ブラウザからPOSTで送信されたデータがあるかどうかを確認し、 <code>line_items</code> に入れる商品データを変えます。なお、LambdaではペイロードがBase64エンコードされてることがあるので、デコードを行う必要があります。<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>  if (event.body) {
    let payload = event.body;
    if (event.isBase64Encoded)
      payload = Buffer.from(event.body, 'base64').toString();

    const querystring = require('querystring');
    const res = querystring.parse(payload);
    if ((res.type) && (res.type == 'bronze')) {
      // ...
    }
  }
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>まずVisitorチケットの場合は単純に1つの商品になります。<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>  let items = [ {
    price: config.product_visitor_ticket,
    quantity: 1
  } ];
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Visitorチケットの1つの商品でStripe Checkoutに転送するとこんな感じで表示されます。</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--eS5A0lIs--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/4po7ld6thtf25au7br7h.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--eS5A0lIs--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/4po7ld6thtf25au7br7h.png" alt="Stripe Checkout Visitor" loading="lazy" width="880" height="544"></a></p>

<p>では、次にBronze Supporterチケットの場合は選択されたTシャツサイズを商品のPriceIDとマッチングし、2つの商品（チケットの商品とTシャツの商品）を <code>line_items</code> に入れます。<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>  let tshirt_type = config.product_tshirt_s;

  if (res.tshirt) {
    if (res.tshirt == 's') tshirt_type = config.product_tshirt_s;
    if (res.tshirt == 'm') tshirt_type = config.product_tshirt_m;
    if (res.tshirt == 'l') tshirt_type = config.product_tshirt_l;
    if (res.tshirt == 'xl') tshirt_type = config.product_tshirt_xl;
  }

  items = [ {
    price: config.product_bronze_ticket,
    quantity: 1
  }, {
    price: tshirt_type,
    quantity: 1
  } ];
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>あとは、Bronze Supporterチケットの場合はTシャツの配送に住所を入力してもらう必要があります。Checkoutセッションデータに配送料金の <code>shipping_rates</code> と配送対象国（どの国への配送が可能）を <code>shipping_address_collection</code> の <code>allowed_countries</code> で指定します。</p>

<p>まとめるとこんな感じになります。<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>  const session = await stripe.checkout.sessions.create( {
    line_items: [ {
      price: config.product_bronze_ticket,
      quantity: 1
    }, {
      price: tshirt_type,
      quantity: 1
    } ],
    payment_method_types: [ 'card' ],
    mode: 'payment',
    success_url: config.success_url,
    cancel_url: config.cancel_url,
    shipping_rates: [ config.shipping_rate ],
    shipping_address_collection: {
      allowed_countries: config.shipping_countries.split(',')
    }
  } );
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>配送情報がセッションデータに含まれるとStripe Checkoutで住所入力フィールドが一緒にフォームに表示されます。</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--z5lLQT-t--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/xl82a4iy6uu47hot3lml.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--z5lLQT-t--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/xl82a4iy6uu47hot3lml.png" alt="Stripe Checkout Bronze" loading="lazy" width="880" height="618"></a></p>

<p>一応、この数十行のコードだけでStripe Checkoutでの決済は可能になりました。購入決済が完了されたら、StripeからWebhookを呼び出し、メール送信などの他の処理が可能なので、次のセクションで紹介します。</p>

<h2>
  <a name="stripe-webhook%E3%81%AE%E5%AE%9F%E8%A3%85" href="#stripe-webhook%E3%81%AE%E5%AE%9F%E8%A3%85">
  </a>
  Stripe Webhookの実装
</h2>

<p>先ほど紹介しましたが、TDFでは、チケット購入の決済完了となった時はVisitorへのチケット情報をメールで送信します。こちらの対応は別のLambda関数を作成し、API GatewayのURLをStripe Webhookに設定します。</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--R9eXzY3W--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/su51bm074bf6j57u7t16.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--R9eXzY3W--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/su51bm074bf6j57u7t16.png" alt="TDF Stripe Webhook" loading="lazy" width="880" height="370"></a></p>

<p>Webhookの処理は各自それぞれ違う対応になりますので、StripeからのPOSTデータのデコードまで紹介します。</p>

<p>まずは、WebhookのURLが公開されているため、誰でもアクセスができてしまいます。Stripeからのアクセスの際はHTTPヘッダーに署名が含まれ、Webhookシークレットのキーでペイロードデータが正常なのかを確認します。<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>exports.handler = async (event) => {
  // require Stripe signature in header
  if (!event.headers['stripe-signature']) {
    console.log('no Stripe signature received in header, returning 400 Bad Request');
    return {
      statusCode: 400
    };
  }

  const sig = event.headers['stripe-signature'];

  // require an event body
  if (!event.body) {
    console.log('no event body received in POST, returning 400 Bad Request');
    return {
      statusCode: 400
    };
  }

  // decode payload
  let payload = event.body;
  if (event.isBase64Encoded)
    payload = Buffer.from(event.body, 'base64').toString();

  // construct a Stripe Webhook event
  const config = await loadConfig();
  const stripe = require('stripe')(config.stripe_api_secret_key);

  try {
    let ev = stripe.webhooks.constructEvent(payload, sig, config.webhook_signing_secret);
  } catch (err) {
    console.log('error creating Stripe Webhook event');
    console.log(err);
    return {
      statusCode: 400
    };
  }

  // ...TODO...

  return {
    statusCode: 200
  };
}
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Stripe Webhookのイベントまで正常に作成したら、次はCheckoutセッションのステータス変化を確認します。決済に関して以下の3つのイベントを対応するのが一般的です。</p>

<ol>
<li>
<code>checkout.session.completed</code> : Stripe Checkoutで決済が行われました。支払い方法によって、決済が完了になってない可能性があります。クレジットカードの場合は基本的に <code>payment_status</code> が <code>paid</code> になるので、決済完了ということになります。</li>
<li>
<code>checkout.session.async_payment_succeeded</code> : <code>completed</code> のイベントで決済が未完了だったのが、決済完了となりました。</li>
<li>
<code>checkout.session.async_payment_failed</code> : <code>completed</code> のイベントで決済が未完了だったのが、決済失敗となりました。</li>
</ol>

<p>この3つのイベントを対応するには<a href="https://stripe.com/docs/payments/checkout/fulfill-orders">Stripeのサンプルコード</a>とほぼ同様に行ってます。<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>const createOrder = async function(session) {
  // we (TDF) don't need to do anything here
}

const fulfillOrder = async function(session) {
  // send ticket info to customer by email
  console.log('customer email is: ' + session.customer_details.email);
}

const emailCustomerAboutFailedPayment = async function(session) {
  // send email about failed payment
}

exports.handler = async (event) => {
  // ...
  const session = ev.data.object;
  switch (ev.type) {
    case 'checkout.session.completed':
      // save an order in your database, marked as 'awaiting payment'
      await createOrder(session);

      // check if the order is paid (e.g., from a card payment)
      // a delayed notification payment will have an `unpaid` status
      if (session.payment_status === 'paid') {
        await fulfillOrder(session);
      }
      break;

    case 'checkout.session.async_payment_succeeded':
      // fulfill the purchase...
      await fulfillOrder(session);
      break;

    case 'checkout.session.async_payment_failed':
      // send an email to the customer asking them to retry their order
      await emailCustomerAboutFailedPayment(session);
      break;
  }
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p><code>createOrder()</code> 、<code>fulfillOrder()</code> 、そして <code>emailCustomerAboutFailedPayment()</code> の3つの関数を実装することでWebhookの対応は完了になります。</p>

<p>もしWebhookがエラーで <code>HTTP 2xx</code> 以外のレスポンスを返された場合、Stripe側では時間を置いてから自動的にリトライされます。詳しくは<a href="https://stripe.com/docs/webhooks/best-practices">Stripe Webhook Best Practices</a>を確認してください。</p>

<p>ここまで実装ができてれば、Stripe Checkoutの対応は完了になります。おめでとうございます！</p>

<h2>
  <a name="api-gateway%E3%81%AEcustom-domain%E3%81%A7%E8%A4%87%E6%95%B0%E3%82%A8%E3%83%B3%E3%83%89%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E3%81%B2%E3%81%A8%E3%81%A4%E3%81%AB%E7%B5%B1%E5%90%88" href="#api-gateway%E3%81%AEcustom-domain%E3%81%A7%E8%A4%87%E6%95%B0%E3%82%A8%E3%83%B3%E3%83%89%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E3%81%B2%E3%81%A8%E3%81%A4%E3%81%AB%E7%B5%B1%E5%90%88">
  </a>
  API GatewayのCustom Domainで複数エンドポイントをひとつに統合
</h2>

<p>今回の実装では、Stripe CheckoutのURL生成とStripe Webhookの2つのエンドポイントがあります。もちろんAPI Gatewayで払い出されたURL ( <code>https://7q6f1e5os2.execute-api.ap-northeast-1...</code> )をそのまま使えますが、 <code>stripe.tokyodemofest.jp</code> などの名前を付けられたサブドメインに統合するとURLの見た目が良くなります。</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--f9wIkQM---/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/mpvoy2tl8f32h3ipbkm9.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--f9wIkQM---/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/mpvoy2tl8f32h3ipbkm9.png" alt="API Gateway Custom Domain" loading="lazy" width="880" height="617"></a></p>

<p>こんな感じで <code>checkout</code> と <code>fulfill</code> の2つのLambdaとAPI GatewayがCustom Domainの1つにまとめています。</p>

<h2>
  <a name="tdf%E3%81%A7%E5%88%9D%E3%82%81%E3%81%A6stripe%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%97%E3%81%A6%E3%81%AE%E6%84%9F%E6%83%B3" href="#tdf%E3%81%A7%E5%88%9D%E3%82%81%E3%81%A6stripe%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%97%E3%81%A6%E3%81%AE%E6%84%9F%E6%83%B3">
  </a>
  TDFで初めてStripeを実装しての感想
</h2>

<p>正直、Stripe Checkoutをサーバーレスで実装するのはとても簡単でした。コードを書く量が少ないので、本当に数十行だけで自分のWebサイトから決済ができるようになります。</p>

<p>しかも、CheckoutやWebhookを実装してる際はStripe UIでAPIのHTTPリクエストとレスポンスとログ情報まで細かく見れて、Dashboardでグラフがとてもわかりやすいです。</p>

<p>ひとつ欲を言えば、テスト環境で作成した商品を簡単に本番モードに持って行きたいです。Webhookは「テストエンドポイントをインポート」する機能がありますが、<del>商品ではできないのがちょっとだけ残念です。テスト環境で作成した商品をもう一度すべて本番モードで作り直す必要があります。</del></p>

<p>【※: 投稿してから知りましたが、実は商品詳細ページには「本番環境にコピー」というボタンがあります。テスト環境で作成したすべての商品を一気に本番環境までインポートするのはできないようですが、1つずつ商品をコピーするのは可能です。】</p>

<p>長年PayPalと戦っていたので、もっと早く乗り換えれば良かったと後悔しています（笑）</p>

<p>最後まで読んでくれてありがとうございました。何か質問やコメントがあれば、ぜひどうぞよろしくお願いいたします！</p>

</div></article> <div class="aside-username-wrapper" data-v-10d06ee8><aside class="aside-username-block" data-v-37984f8c data-v-10d06ee8><div class="username-heading loading" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-heading" data-v-37984f8c><div class="vue-content-placeholders-heading__img"></div> <div class="vue-content-placeholders-heading__content"><div class="vue-content-placeholders-heading__title"></div> <div class="vue-content-placeholders-heading__subtitle"></div></div></div></div></div> <div class="info" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-text" data-v-37984f8c><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div></div></div></div></aside></div></div> <div class="comments-block" data-v-8c4375bc data-v-10d06ee8><!----> <a href="https://dev.to/falken42/chu-metenostripe-wan-quan-nisabaresunotiketutofan-mai-2780" target="_blank" rel="nofollow noopener noreferer" class="add-comment" data-v-8c4375bc>
    Add comment
  </a></div></div> <footer data-v-22cb8fd0><span data-v-22cb8fd0>Built with</span> <a href="https://nuxtjs.org" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="nuxt-icon" data-v-22cb8fd0 data-v-22cb8fd0><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a> <span data-v-22cb8fd0>&</span> <a href="https://docs.dev.to/api" rel="nofollow noopener" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-22cb8fd0 data-v-22cb8fd0><path d="M1.5726 5.13748C1.42945 5.20622 1.2411 5.36661 1.15822 5.48117C1 5.69503 1 5.74849 1 11.8739C1 17.9993 1 18.0528 1.15822 18.2667C1.2411 18.3812 1.42945 18.5416 1.5726 18.6104C1.8137 18.7402 2.46164 18.7478 12 18.7478C21.5384 18.7478 22.1863 18.7402 22.4274 18.6104C22.5706 18.5416 22.7589 18.3812 22.8418 18.2667C23 18.0528 23 17.9993 23 11.8739C23 5.74849 23 5.69503 22.8418 5.48117C22.7589 5.36661 22.5706 5.20622 22.4274 5.13748C22.1863 5.00764 21.5384 5 12 5C2.46164 5 1.8137 5.00764 1.5726 5.13748ZM7.7055 8.2613C8.0822 8.45989 8.59454 9.0098 8.77536 9.40694C8.89589 9.66664 8.91095 9.94922 8.91095 12.0649C8.91095 14.3104 8.90344 14.4478 8.75275 14.7839C8.51919 15.288 8.16506 15.6546 7.68288 15.899C7.26096 16.1052 7.22328 16.1128 5.7315 16.1358L4.20206 16.1663V12.1031V8.04744L5.80684 8.07035C7.27602 8.09327 7.42672 8.10854 7.7055 8.2613ZM13.6952 8.89521V9.73538H12.4521H11.2089V10.4991V11.2629H11.9623H12.7158V12.1031V12.9432H11.9623H11.2089V13.707V14.4708H12.4521H13.6952V15.3109V16.151H12C10.1315 16.151 10.0411 16.1358 9.67191 15.6928L9.47603 15.4484V12.1336C9.47603 8.46752 9.46851 8.49807 9.95069 8.20783C10.1692 8.07035 10.3425 8.05508 11.9473 8.05508H13.6952V8.89521ZM16.5658 10.3769C16.8897 11.6295 17.1685 12.6912 17.176 12.7293C17.1911 12.7675 17.4699 11.7441 17.8014 10.461C18.1254 9.17017 18.4343 8.1009 18.4795 8.08563C18.5247 8.06271 18.9541 8.06271 19.4288 8.07035L20.3028 8.09327L19.376 11.6219C18.8713 13.5542 18.4117 15.2269 18.3664 15.3261C18.0123 16.0135 17.274 16.3343 16.7164 16.0441C16.4528 15.899 16.0911 15.4865 15.9705 15.1887C15.9254 15.0665 15.4884 13.4549 15.0062 11.6142C14.524 9.76593 14.1171 8.20783 14.0945 8.15437C14.0644 8.07035 14.2301 8.05508 15.0212 8.07035L15.9856 8.09327L16.5658 10.3769Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M5.93491 12.103V14.4707H6.27394C6.66574 14.4707 7.01983 14.3103 7.1404 14.0965C7.18559 14.0048 7.21575 13.2105 7.21575 12.0648V10.1783L6.99725 9.95683C6.80133 9.76591 6.71847 9.73535 6.35683 9.73535H5.93491V12.103Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a></footer></div></div></div><script>window.__NUXT__=function(e,t,n,s,i,a){return n.type_of="article",n.id=911258,n.title="初めてのStripe: 完全にサーバーレスのチケット販売",n.description="[ This post is available in English here. ]  本ブログは2021年Stripe Advent Calendar...",n.readable_publish_date="Dec 2 '21",n.slug="chu-metenostripe-wan-quan-nisabaresunotiketutofan-mai-2780",n.path="/aws-builders/chu-metenostripe-wan-quan-nisabaresunotiketutofan-mai-2780",n.url=s,n.comments_count=0,n.public_reactions_count=10,n.collection_id=e,n.published_timestamp=t,n.positive_reactions_count=10,n.cover_image="https://res.cloudinary.com/practicaldev/image/fetch/s--qEYd9l-B--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/qqqwzy695mjn121oiz66.png",n.social_image="https://res.cloudinary.com/practicaldev/image/fetch/s--OKZoOYs6--/c_imagga_scale,f_auto,fl_progressive,h_500,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/qqqwzy695mjn121oiz66.png",n.canonical_url=s,n.created_at="2021-11-28T11:20:34Z",n.edited_at="2022-01-30T05:08:35Z",n.crossposted_at=e,n.published_at=t,n.last_comment_at=t,n.reading_time_minutes=4,n.tag_list="serverless, stripe, aws, demoscene",n.tags=["serverless","stripe","aws","demoscene"],n.body_html='<p>[ This post is available <a href="https://dev.to/aws-builders/first-time-with-stripe-fully-serverless-ticket-sales-329a">in English here</a>. ]</p>\n\n<p>本ブログは2021年<a href="https://qiita.com/advent-calendar/2021/stripe">Stripe Advent Calendar 2021</a>の12月3日分のエントリーです。</p>\n\n\n<hr>\n\n<p>皆さん、こんにちは！Tokyo Demo Fest実行委員のテッダー　マイケルです。AWSとの9年間の開発経験を活かしながら、JAWS-UG札幌支部とJAWS-UGのコミュニティイベント（<a href="https://jft2019.jaws-ug.jp/">FESTA 2019</a>、<a href="https://jawsdays2021.jaws-ug.jp/">DAYS 2021</a>、<a href="https://jawspankration2021.jaws-ug.jp/">PANKRATION 2021</a>）の運営を手伝いしています。2020年にAWSコミュニティビルダーに認定されました。</p>\n\n<p>今回はTokyo Demo Fest 2021のチケット販売のため、AWS上で初めてStripeを実装した話を詳しくご紹介します。Stripeをまだ触っていない方でもわかりやすく伝えたいと思います。サンプルコードの言語はNode.js 14.xになります。</p>\n\n<h2>\n  <a name="tokyo-demo-fest%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6" href="#tokyo-demo-fest%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">\n  </a>\n  Tokyo Demo Festについて\n</h2>\n\n<p>Tokyo Demo Fest (略: TDF)は日本で唯一のデモパーティです。デモパーティは、コンピュータを用いたプログラミングとアートに興味のある人々が日本のみならず、世界中から一堂に会し、デモ作品のコンペティション(コンポ)やセミナーなどを行います。また、イベント開催中は集まった様々な人たちとの交流が深められます。</p>\n\n<p>デモについての解説は<a href="https://tokyodemofest.jp/2016/?lang=ja#aboutdemo">こちらをご参照ください</a>。</p>\n\n<p>過去のTDFのチケット販売はPayPalで行いましたが、今年からはようやくStripeに移行することができました。今回は実装がとても簡単なStripe Checkoutを利用し、実際のコーディングは数時間程度で対応できました。</p>\n\n<h2>\n  <a name="%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E8%A8%AD%E8%A8%88" href="#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E8%A8%AD%E8%A8%88">\n  </a>\n  システム設計\n</h2>\n\n<p>こちらが全体図です。今回はStripeに限る話だけなので、ライブ配信周りなどは描かれてません。Stripeとその関係するシステムのみになります。</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--fIPhTsSR--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/di5bdgrkerfx41kzi69h.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--fIPhTsSR--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/di5bdgrkerfx41kzi69h.png" alt="Serverless Stripe Diagram" loading="lazy" width="880" height="706"></a></p>\n\n<p>Visitorは最初にAmplifyで公開されている<a href="https://tokyodemofest.jp/index_ja.html">TDFのWebサイト</a>から入ります。2種類のチケットがあるのでどちらかを選択し、Stripe Checkoutへ移行します。決済完了時はStripeからのWebhookが呼び出され、チケット情報とVotekeyがStripeでの購入時に入力されたメールアドレスに送信されます。Visitorはメールで配布されたVotekeyを使い、<a href="https://github.com/Gargaj/wuhu">Wuhuパーティシステム</a> (ECS/Fargate)にログインできるようになります。</p>\n\n<h2>\n  <a name="stripe%E5%95%86%E5%93%81%E3%81%AE%E4%BD%9C%E6%88%90" href="#stripe%E5%95%86%E5%93%81%E3%81%AE%E4%BD%9C%E6%88%90">\n  </a>\n  Stripe商品の作成\n</h2>\n\n<p>今回のTDFではチケットを2種類販売しています。</p>\n\n<ol>\n<li>Visitor Ticket（1,000円）</li>\n<li>Bronze Supporter (10,000円、Tシャツ無料配送込み)</li>\n</ol>\n\n<p>Visitor TicketはStripeでは1つの「商品」になるので、簡単ですね。</p>\n\n<p>Bronze SupporterはVisitor Ticketと金額が違うため別の商品が必要ですが、Tシャツのサイズ（S/M/L/XL）の選択もあるので、サイズ別の4つの商品を作成しました。Tシャツはチケット代に含まれているので、それぞれのサイズの金額は「ゼロ円」に設定しています。そしてTシャツは配送になるため、購入時にVisitorの住所入力が必要です。</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--ai5xUVhU--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/u418fcq355zfmtxtnxqp.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--ai5xUVhU--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/u418fcq355zfmtxtnxqp.png" alt="TDF Stripe Products" loading="lazy" width="880" height="632"></a></p>\n\n<p>Stripeで配送情報を入力させるためには「配送料金」を作成する必要があります。今回はTシャツの配送料もチケット代に含まれているため、こちらの金額も「ゼロ円」に設定しています。</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--IihEjYFH--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/bvj9r6cp4jwpvlqd7jwo.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--IihEjYFH--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/bvj9r6cp4jwpvlqd7jwo.png" alt="TDF Stripe Shipping" loading="lazy" width="880" height="263"></a></p>\n\n<h2>\n  <a name="stripe-api%E3%82%AD%E3%83%BC%E3%81%AE%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3" href="#stripe-api%E3%82%AD%E3%83%BC%E3%81%AE%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3">\n  </a>\n  Stripe APIキーのセキュリティ\n</h2>\n\n<p>Stripe APIキーは秘密情報なので、ソースコードに書き込んだりすると情報漏えいの要因になります。私のいつもの実装パターンですが、Lambdaを使ってる時はAWS Systems Managerの<a href="https://docs.aws.amazon.com/ja_jp/systems-manager/latest/userguide/systems-manager-parameter-store.html">Parameter Store</a>にAPIキー等を保存することにしています。</p>\n\n<p>APIキー、Webhookシークレット、商品のPriceID、配送料金IDなどは1つずつ別々のSecureStringに保存が可能ですが、実はStandardでも4KBまで保存が可能なので、すべての必要な情報をJSON化にし、1つの文字列として保存するのがとても楽です。</p>\n\n<p>以下、キーの内容は隠してますが、実際保存してるデータがこんな感じです。<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>{"stripe_api_secret_key":"sk_test_51JU2XXXXXXXXXXXX",\n"webhook_signing_secret":"whsec_TqW4TXXXXXXXXXXXX",\n"product_visitor_ticket":"price_1JX1zXXXXXXXXXXXX",\n"product_bronze_ticket":"price_1JrKaXXXXXXXXXXXX",\n"product_tshirt_s":"price_1JrKlXXXXXXXXXXXX",\n"product_tshirt_m":"price_1JrKmXXXXXXXXXXXX",\n"product_tshirt_l":"price_1JrKnXXXXXXXXXXXX",\n"product_tshirt_xl":"price_1JrKoXXXXXXXXXXXX",\n"success_url":"https://tokyodemofest.jp/success.html",\n"cancel_url":"https://tokyodemofest.jp#registration",\n"shipping_rate":"shr_1JrKNXXXXXXXXXXXX",\n"shipping_countries":"US,JP,IE,GB,NO,SE,FI,RU,PT,ES,FR,DE,CH,IT,PL,CZ,AT,HU,BA,BY,UA,RO,BG,GR,AU,NZ,KR,TW,IS"}\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Lambdaが実行されてる際、このJSONをパラメータストアから読み込むためには Lambdaに内蔵されてる <code>aws-sdk</code> を使います。Stripeの初期化にはAPIキーを渡すのが必要なので、SSMからconfigを引っ張ってから初期化を行います。<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>const loadConfig = async function() {\n  const aws = require(\'aws-sdk\');\n  const ssm = new aws.SSM();\n  const res = await ssm.getParameter( { Name: \'/tdf/config-stripe\', WithDecryption: true } ).promise();\n  return JSON.parse(res.Parameter.Value);\n}\n\nexports.handler = async (event) =&gt; {\n  const config = await loadConfig();\n  const stripe = require(\'stripe\')(config.stripe_api_secret_key);\n  // ...\n}\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<h2>\n  <a name="html%E5%81%B4%E3%81%AE%E8%B3%BC%E5%85%A5%E3%83%9C%E3%82%BF%E3%83%B3%E4%BD%9C%E6%88%90" href="#html%E5%81%B4%E3%81%AE%E8%B3%BC%E5%85%A5%E3%83%9C%E3%82%BF%E3%83%B3%E4%BD%9C%E6%88%90">\n  </a>\n  HTML側の購入ボタン作成\n</h2>\n\n<p>参考のため、今回のTDFのHTML側の購入ボタンを軽く紹介します。</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--356gi-dM--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/g5o6ttt7wdnu9bnjuhdq.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--356gi-dM--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/g5o6ttt7wdnu9bnjuhdq.png" alt="TDF Visitor Ticket" loading="lazy" width="880" height="122"></a></p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--Yc0c8M06--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/08ukha0sn2r182dqwq24.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--Yc0c8M06--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/08ukha0sn2r182dqwq24.png" alt="TDF Bronze Supporter" loading="lazy" width="880" height="122"></a></p>\n\n<p>チケットの種類が2つなのですが、実はPOSTするエンドポイントが同じです。</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--gMX4Re3K--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/z90o2ltnbje9dcyddxtt.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--gMX4Re3K--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/z90o2ltnbje9dcyddxtt.png" alt="TDF Ticket HTML" loading="lazy" width="880" height="580"></a></p>\n\n<p>Lambda側でチケットの違いをわかるためには <code>&lt;input type="hidden" name="type" value="bronze"&gt;</code> で判断しています。そして <code>type=bronze</code> の場合はTシャツサイズの <code>tshirt</code> 指定もわかります。</p>\n\n<p>Stripe CheckoutにBronze SupporterチケットとTシャツの商品指定は次のセクションで紹介します。</p>\n\n<h2>\n  <a name="stripe-checkout%E3%81%B8%E3%81%AEurl%E7%94%9F%E6%88%90" href="#stripe-checkout%E3%81%B8%E3%81%AEurl%E7%94%9F%E6%88%90">\n  </a>\n  Stripe CheckoutへのURL生成\n</h2>\n\n<p>次はWebサイトでVisitorがチケット購入ボタンを押したら、Stripe Checkoutに移行させます。このURLには、どの商品を購入するとか、購入時に必要な情報（住所の入力が必要かどうか）が含まれています。URL生成はStripe SDKが行うので、URLが作成されたら、ブラウザに <code>HTTP 303</code> (See Other) で転送されると、Stripe Checkoutのページが表示されます。</p>\n\n<p>LambdaでCheckoutセッションのURLを生成し転送させるにはこんな感じです。<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>exports.handler = async (event) =&gt; {\n  const config = await loadConfig();\n  const stripe = require(\'stripe\')(config.stripe_api_secret_key);\n\n  const session = await stripe.checkout.sessions.create( {\n    line_items: /* TODO */,\n    payment_method_types: [ \'card\' ],\n    mode: \'payment\',\n    success_url: config.success_url,\n    cancel_url: config.cancel_url\n  } );\n\n  const response = {\n    statusCode: 303,\n    headers: {\n      \'Location\': session.url\n    }\n  };\n\n  return response;\n}\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>セッションデータの <code>line_items</code> は商品を指定します。ブラウザからPOSTで送信されたデータがあるかどうかを確認し、 <code>line_items</code> に入れる商品データを変えます。なお、LambdaではペイロードがBase64エンコードされてることがあるので、デコードを行う必要があります。<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>  if (event.body) {\n    let payload = event.body;\n    if (event.isBase64Encoded)\n      payload = Buffer.from(event.body, \'base64\').toString();\n\n    const querystring = require(\'querystring\');\n    const res = querystring.parse(payload);\n    if ((res.type) &amp;&amp; (res.type == \'bronze\')) {\n      // ...\n    }\n  }\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>まずVisitorチケットの場合は単純に1つの商品になります。<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>  let items = [ {\n    price: config.product_visitor_ticket,\n    quantity: 1\n  } ];\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Visitorチケットの1つの商品でStripe Checkoutに転送するとこんな感じで表示されます。</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--eS5A0lIs--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/4po7ld6thtf25au7br7h.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--eS5A0lIs--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/4po7ld6thtf25au7br7h.png" alt="Stripe Checkout Visitor" loading="lazy" width="880" height="544"></a></p>\n\n<p>では、次にBronze Supporterチケットの場合は選択されたTシャツサイズを商品のPriceIDとマッチングし、2つの商品（チケットの商品とTシャツの商品）を <code>line_items</code> に入れます。<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>  let tshirt_type = config.product_tshirt_s;\n\n  if (res.tshirt) {\n    if (res.tshirt == \'s\') tshirt_type = config.product_tshirt_s;\n    if (res.tshirt == \'m\') tshirt_type = config.product_tshirt_m;\n    if (res.tshirt == \'l\') tshirt_type = config.product_tshirt_l;\n    if (res.tshirt == \'xl\') tshirt_type = config.product_tshirt_xl;\n  }\n\n  items = [ {\n    price: config.product_bronze_ticket,\n    quantity: 1\n  }, {\n    price: tshirt_type,\n    quantity: 1\n  } ];\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>あとは、Bronze Supporterチケットの場合はTシャツの配送に住所を入力してもらう必要があります。Checkoutセッションデータに配送料金の <code>shipping_rates</code> と配送対象国（どの国への配送が可能）を <code>shipping_address_collection</code> の <code>allowed_countries</code> で指定します。</p>\n\n<p>まとめるとこんな感じになります。<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>  const session = await stripe.checkout.sessions.create( {\n    line_items: [ {\n      price: config.product_bronze_ticket,\n      quantity: 1\n    }, {\n      price: tshirt_type,\n      quantity: 1\n    } ],\n    payment_method_types: [ \'card\' ],\n    mode: \'payment\',\n    success_url: config.success_url,\n    cancel_url: config.cancel_url,\n    shipping_rates: [ config.shipping_rate ],\n    shipping_address_collection: {\n      allowed_countries: config.shipping_countries.split(\',\')\n    }\n  } );\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>配送情報がセッションデータに含まれるとStripe Checkoutで住所入力フィールドが一緒にフォームに表示されます。</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--z5lLQT-t--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/xl82a4iy6uu47hot3lml.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--z5lLQT-t--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/xl82a4iy6uu47hot3lml.png" alt="Stripe Checkout Bronze" loading="lazy" width="880" height="618"></a></p>\n\n<p>一応、この数十行のコードだけでStripe Checkoutでの決済は可能になりました。購入決済が完了されたら、StripeからWebhookを呼び出し、メール送信などの他の処理が可能なので、次のセクションで紹介します。</p>\n\n<h2>\n  <a name="stripe-webhook%E3%81%AE%E5%AE%9F%E8%A3%85" href="#stripe-webhook%E3%81%AE%E5%AE%9F%E8%A3%85">\n  </a>\n  Stripe Webhookの実装\n</h2>\n\n<p>先ほど紹介しましたが、TDFでは、チケット購入の決済完了となった時はVisitorへのチケット情報をメールで送信します。こちらの対応は別のLambda関数を作成し、API GatewayのURLをStripe Webhookに設定します。</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--R9eXzY3W--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/su51bm074bf6j57u7t16.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--R9eXzY3W--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/su51bm074bf6j57u7t16.png" alt="TDF Stripe Webhook" loading="lazy" width="880" height="370"></a></p>\n\n<p>Webhookの処理は各自それぞれ違う対応になりますので、StripeからのPOSTデータのデコードまで紹介します。</p>\n\n<p>まずは、WebhookのURLが公開されているため、誰でもアクセスができてしまいます。Stripeからのアクセスの際はHTTPヘッダーに署名が含まれ、Webhookシークレットのキーでペイロードデータが正常なのかを確認します。<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>exports.handler = async (event) =&gt; {\n  // require Stripe signature in header\n  if (!event.headers[\'stripe-signature\']) {\n    console.log(\'no Stripe signature received in header, returning 400 Bad Request\');\n    return {\n      statusCode: 400\n    };\n  }\n\n  const sig = event.headers[\'stripe-signature\'];\n\n  // require an event body\n  if (!event.body) {\n    console.log(\'no event body received in POST, returning 400 Bad Request\');\n    return {\n      statusCode: 400\n    };\n  }\n\n  // decode payload\n  let payload = event.body;\n  if (event.isBase64Encoded)\n    payload = Buffer.from(event.body, \'base64\').toString();\n\n  // construct a Stripe Webhook event\n  const config = await loadConfig();\n  const stripe = require(\'stripe\')(config.stripe_api_secret_key);\n\n  try {\n    let ev = stripe.webhooks.constructEvent(payload, sig, config.webhook_signing_secret);\n  } catch (err) {\n    console.log(\'error creating Stripe Webhook event\');\n    console.log(err);\n    return {\n      statusCode: 400\n    };\n  }\n\n  // ...TODO...\n\n  return {\n    statusCode: 200\n  };\n}\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Stripe Webhookのイベントまで正常に作成したら、次はCheckoutセッションのステータス変化を確認します。決済に関して以下の3つのイベントを対応するのが一般的です。</p>\n\n<ol>\n<li>\n<code>checkout.session.completed</code> : Stripe Checkoutで決済が行われました。支払い方法によって、決済が完了になってない可能性があります。クレジットカードの場合は基本的に <code>payment_status</code> が <code>paid</code> になるので、決済完了ということになります。</li>\n<li>\n<code>checkout.session.async_payment_succeeded</code> : <code>completed</code> のイベントで決済が未完了だったのが、決済完了となりました。</li>\n<li>\n<code>checkout.session.async_payment_failed</code> : <code>completed</code> のイベントで決済が未完了だったのが、決済失敗となりました。</li>\n</ol>\n\n<p>この3つのイベントを対応するには<a href="https://stripe.com/docs/payments/checkout/fulfill-orders">Stripeのサンプルコード</a>とほぼ同様に行ってます。<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>const createOrder = async function(session) {\n  // we (TDF) don\'t need to do anything here\n}\n\nconst fulfillOrder = async function(session) {\n  // send ticket info to customer by email\n  console.log(\'customer email is: \' + session.customer_details.email);\n}\n\nconst emailCustomerAboutFailedPayment = async function(session) {\n  // send email about failed payment\n}\n\nexports.handler = async (event) =&gt; {\n  // ...\n  const session = ev.data.object;\n  switch (ev.type) {\n    case \'checkout.session.completed\':\n      // save an order in your database, marked as \'awaiting payment\'\n      await createOrder(session);\n\n      // check if the order is paid (e.g., from a card payment)\n      // a delayed notification payment will have an `unpaid` status\n      if (session.payment_status === \'paid\') {\n        await fulfillOrder(session);\n      }\n      break;\n\n    case \'checkout.session.async_payment_succeeded\':\n      // fulfill the purchase...\n      await fulfillOrder(session);\n      break;\n\n    case \'checkout.session.async_payment_failed\':\n      // send an email to the customer asking them to retry their order\n      await emailCustomerAboutFailedPayment(session);\n      break;\n  }\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p><code>createOrder()</code> 、<code>fulfillOrder()</code> 、そして <code>emailCustomerAboutFailedPayment()</code> の3つの関数を実装することでWebhookの対応は完了になります。</p>\n\n<p>もしWebhookがエラーで <code>HTTP 2xx</code> 以外のレスポンスを返された場合、Stripe側では時間を置いてから自動的にリトライされます。詳しくは<a href="https://stripe.com/docs/webhooks/best-practices">Stripe Webhook Best Practices</a>を確認してください。</p>\n\n<p>ここまで実装ができてれば、Stripe Checkoutの対応は完了になります。おめでとうございます！</p>\n\n<h2>\n  <a name="api-gateway%E3%81%AEcustom-domain%E3%81%A7%E8%A4%87%E6%95%B0%E3%82%A8%E3%83%B3%E3%83%89%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E3%81%B2%E3%81%A8%E3%81%A4%E3%81%AB%E7%B5%B1%E5%90%88" href="#api-gateway%E3%81%AEcustom-domain%E3%81%A7%E8%A4%87%E6%95%B0%E3%82%A8%E3%83%B3%E3%83%89%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E3%81%B2%E3%81%A8%E3%81%A4%E3%81%AB%E7%B5%B1%E5%90%88">\n  </a>\n  API GatewayのCustom Domainで複数エンドポイントをひとつに統合\n</h2>\n\n<p>今回の実装では、Stripe CheckoutのURL生成とStripe Webhookの2つのエンドポイントがあります。もちろんAPI Gatewayで払い出されたURL ( <code>https://7q6f1e5os2.execute-api.ap-northeast-1...</code> )をそのまま使えますが、 <code>stripe.tokyodemofest.jp</code> などの名前を付けられたサブドメインに統合するとURLの見た目が良くなります。</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--f9wIkQM---/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/mpvoy2tl8f32h3ipbkm9.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--f9wIkQM---/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/mpvoy2tl8f32h3ipbkm9.png" alt="API Gateway Custom Domain" loading="lazy" width="880" height="617"></a></p>\n\n<p>こんな感じで <code>checkout</code> と <code>fulfill</code> の2つのLambdaとAPI GatewayがCustom Domainの1つにまとめています。</p>\n\n<h2>\n  <a name="tdf%E3%81%A7%E5%88%9D%E3%82%81%E3%81%A6stripe%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%97%E3%81%A6%E3%81%AE%E6%84%9F%E6%83%B3" href="#tdf%E3%81%A7%E5%88%9D%E3%82%81%E3%81%A6stripe%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%97%E3%81%A6%E3%81%AE%E6%84%9F%E6%83%B3">\n  </a>\n  TDFで初めてStripeを実装しての感想\n</h2>\n\n<p>正直、Stripe Checkoutをサーバーレスで実装するのはとても簡単でした。コードを書く量が少ないので、本当に数十行だけで自分のWebサイトから決済ができるようになります。</p>\n\n<p>しかも、CheckoutやWebhookを実装してる際はStripe UIでAPIのHTTPリクエストとレスポンスとログ情報まで細かく見れて、Dashboardでグラフがとてもわかりやすいです。</p>\n\n<p>ひとつ欲を言えば、テスト環境で作成した商品を簡単に本番モードに持って行きたいです。Webhookは「テストエンドポイントをインポート」する機能がありますが、<del>商品ではできないのがちょっとだけ残念です。テスト環境で作成した商品をもう一度すべて本番モードで作り直す必要があります。</del></p>\n\n<p>【※: 投稿してから知りましたが、実は商品詳細ページには「本番環境にコピー」というボタンがあります。テスト環境で作成したすべての商品を一気に本番環境までインポートするのはできないようですが、1つずつ商品をコピーするのは可能です。】</p>\n\n<p>長年PayPalと戦っていたので、もっと早く乗り換えれば良かったと後悔しています（笑）</p>\n\n<p>最後まで読んでくれてありがとうございました。何か質問やコメントがあれば、ぜひどうぞよろしくお願いいたします！</p>\n\n',n.body_markdown="[ This post is available [in English here](https://dev.to/aws-builders/first-time-with-stripe-fully-serverless-ticket-sales-329a). ]\n\n本ブログは2021年[Stripe Advent Calendar 2021](https://qiita.com/advent-calendar/2021/stripe)の12月3日分のエントリーです。\n\n---\n\n皆さん、こんにちは！Tokyo Demo Fest実行委員のテッダー　マイケルです。AWSとの9年間の開発経験を活かしながら、JAWS-UG札幌支部とJAWS-UGのコミュニティイベント（[FESTA 2019](https://jft2019.jaws-ug.jp/)、[DAYS 2021](https://jawsdays2021.jaws-ug.jp/)、[PANKRATION 2021](https://jawspankration2021.jaws-ug.jp/)）の運営を手伝いしています。2020年にAWSコミュニティビルダーに認定されました。\n\n今回はTokyo Demo Fest 2021のチケット販売のため、AWS上で初めてStripeを実装した話を詳しくご紹介します。Stripeをまだ触っていない方でもわかりやすく伝えたいと思います。サンプルコードの言語はNode.js 14.xになります。\n\n## Tokyo Demo Festについて\n\nTokyo Demo Fest (略: TDF)は日本で唯一のデモパーティです。デモパーティは、コンピュータを用いたプログラミングとアートに興味のある人々が日本のみならず、世界中から一堂に会し、デモ作品のコンペティション(コンポ)やセミナーなどを行います。また、イベント開催中は集まった様々な人たちとの交流が深められます。\n\nデモについての解説は[こちらをご参照ください](https://tokyodemofest.jp/2016/?lang=ja#aboutdemo)。\n\n過去のTDFのチケット販売はPayPalで行いましたが、今年からはようやくStripeに移行することができました。今回は実装がとても簡単なStripe Checkoutを利用し、実際のコーディングは数時間程度で対応できました。\n\n## システム設計\n\nこちらが全体図です。今回はStripeに限る話だけなので、ライブ配信周りなどは描かれてません。Stripeとその関係するシステムのみになります。\n\n![Serverless Stripe Diagram](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/di5bdgrkerfx41kzi69h.png)\n\nVisitorは最初にAmplifyで公開されている[TDFのWebサイト](https://tokyodemofest.jp/index_ja.html)から入ります。2種類のチケットがあるのでどちらかを選択し、Stripe Checkoutへ移行します。決済完了時はStripeからのWebhookが呼び出され、チケット情報とVotekeyがStripeでの購入時に入力されたメールアドレスに送信されます。Visitorはメールで配布されたVotekeyを使い、[Wuhuパーティシステム](https://github.com/Gargaj/wuhu) (ECS/Fargate)にログインできるようになります。\n\n## Stripe商品の作成\n\n今回のTDFではチケットを2種類販売しています。\n\n1. Visitor Ticket（1,000円）\n2. Bronze Supporter (10,000円、Tシャツ無料配送込み)\n\nVisitor TicketはStripeでは1つの「商品」になるので、簡単ですね。\n\nBronze SupporterはVisitor Ticketと金額が違うため別の商品が必要ですが、Tシャツのサイズ（S/M/L/XL）の選択もあるので、サイズ別の4つの商品を作成しました。Tシャツはチケット代に含まれているので、それぞれのサイズの金額は「ゼロ円」に設定しています。そしてTシャツは配送になるため、購入時にVisitorの住所入力が必要です。\n\n![TDF Stripe Products](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/u418fcq355zfmtxtnxqp.png)\n\nStripeで配送情報を入力させるためには「配送料金」を作成する必要があります。今回はTシャツの配送料もチケット代に含まれているため、こちらの金額も「ゼロ円」に設定しています。\n\n![TDF Stripe Shipping](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/bvj9r6cp4jwpvlqd7jwo.png)\n\n## Stripe APIキーのセキュリティ\n\nStripe APIキーは秘密情報なので、ソースコードに書き込んだりすると情報漏えいの要因になります。私のいつもの実装パターンですが、Lambdaを使ってる時はAWS Systems Managerの[Parameter Store](https://docs.aws.amazon.com/ja_jp/systems-manager/latest/userguide/systems-manager-parameter-store.html)にAPIキー等を保存することにしています。\n\nAPIキー、Webhookシークレット、商品のPriceID、配送料金IDなどは1つずつ別々のSecureStringに保存が可能ですが、実はStandardでも4KBまで保存が可能なので、すべての必要な情報をJSON化にし、1つの文字列として保存するのがとても楽です。\n\n以下、キーの内容は隠してますが、実際保存してるデータがこんな感じです。\n\n```\n{\"stripe_api_secret_key\":\"sk_test_51JU2XXXXXXXXXXXX\",\n\"webhook_signing_secret\":\"whsec_TqW4TXXXXXXXXXXXX\",\n\"product_visitor_ticket\":\"price_1JX1zXXXXXXXXXXXX\",\n\"product_bronze_ticket\":\"price_1JrKaXXXXXXXXXXXX\",\n\"product_tshirt_s\":\"price_1JrKlXXXXXXXXXXXX\",\n\"product_tshirt_m\":\"price_1JrKmXXXXXXXXXXXX\",\n\"product_tshirt_l\":\"price_1JrKnXXXXXXXXXXXX\",\n\"product_tshirt_xl\":\"price_1JrKoXXXXXXXXXXXX\",\n\"success_url\":\"https://tokyodemofest.jp/success.html\",\n\"cancel_url\":\"https://tokyodemofest.jp#registration\",\n\"shipping_rate\":\"shr_1JrKNXXXXXXXXXXXX\",\n\"shipping_countries\":\"US,JP,IE,GB,NO,SE,FI,RU,PT,ES,FR,DE,CH,IT,PL,CZ,AT,HU,BA,BY,UA,RO,BG,GR,AU,NZ,KR,TW,IS\"}\n```\n\nLambdaが実行されてる際、このJSONをパラメータストアから読み込むためには Lambdaに内蔵されてる `aws-sdk` を使います。Stripeの初期化にはAPIキーを渡すのが必要なので、SSMからconfigを引っ張ってから初期化を行います。\n\n```\nconst loadConfig = async function() {\n  const aws = require('aws-sdk');\n  const ssm = new aws.SSM();\n  const res = await ssm.getParameter( { Name: '/tdf/config-stripe', WithDecryption: true } ).promise();\n  return JSON.parse(res.Parameter.Value);\n}\n\nexports.handler = async (event) => {\n  const config = await loadConfig();\n  const stripe = require('stripe')(config.stripe_api_secret_key);\n  // ...\n}\n```\n\n## HTML側の購入ボタン作成\n\n参考のため、今回のTDFのHTML側の購入ボタンを軽く紹介します。\n\n![TDF Visitor Ticket](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/g5o6ttt7wdnu9bnjuhdq.png)\n\n![TDF Bronze Supporter](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/08ukha0sn2r182dqwq24.png)\n\nチケットの種類が2つなのですが、実はPOSTするエンドポイントが同じです。\n\n![TDF Ticket HTML](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/z90o2ltnbje9dcyddxtt.png)\n\nLambda側でチケットの違いをわかるためには `<input type=\"hidden\" name=\"type\" value=\"bronze\">` で判断しています。そして `type=bronze` の場合はTシャツサイズの `tshirt` 指定もわかります。\n\nStripe CheckoutにBronze SupporterチケットとTシャツの商品指定は次のセクションで紹介します。\n\n## Stripe CheckoutへのURL生成\n\n次はWebサイトでVisitorがチケット購入ボタンを押したら、Stripe Checkoutに移行させます。このURLには、どの商品を購入するとか、購入時に必要な情報（住所の入力が必要かどうか）が含まれています。URL生成はStripe SDKが行うので、URLが作成されたら、ブラウザに `HTTP 303` (See Other) で転送されると、Stripe Checkoutのページが表示されます。\n\nLambdaでCheckoutセッションのURLを生成し転送させるにはこんな感じです。\n\n```\nexports.handler = async (event) => {\n  const config = await loadConfig();\n  const stripe = require('stripe')(config.stripe_api_secret_key);\n\n  const session = await stripe.checkout.sessions.create( {\n    line_items: /* TODO */,\n    payment_method_types: [ 'card' ],\n    mode: 'payment',\n    success_url: config.success_url,\n    cancel_url: config.cancel_url\n  } );\n\n  const response = {\n    statusCode: 303,\n    headers: {\n      'Location': session.url\n    }\n  };\n\n  return response;\n}\n```\n\nセッションデータの `line_items` は商品を指定します。ブラウザからPOSTで送信されたデータがあるかどうかを確認し、 `line_items` に入れる商品データを変えます。なお、LambdaではペイロードがBase64エンコードされてることがあるので、デコードを行う必要があります。\n\n```\n  if (event.body) {\n    let payload = event.body;\n    if (event.isBase64Encoded)\n      payload = Buffer.from(event.body, 'base64').toString();\n\n    const querystring = require('querystring');\n    const res = querystring.parse(payload);\n    if ((res.type) && (res.type == 'bronze')) {\n      // ...\n    }\n  }\n```\n\nまずVisitorチケットの場合は単純に1つの商品になります。\n\n```\n  let items = [ {\n    price: config.product_visitor_ticket,\n    quantity: 1\n  } ];\n```\n\nVisitorチケットの1つの商品でStripe Checkoutに転送するとこんな感じで表示されます。\n\n![Stripe Checkout Visitor](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/4po7ld6thtf25au7br7h.png)\n\nでは、次にBronze Supporterチケットの場合は選択されたTシャツサイズを商品のPriceIDとマッチングし、2つの商品（チケットの商品とTシャツの商品）を `line_items` に入れます。\n\n```\n  let tshirt_type = config.product_tshirt_s;\n\n  if (res.tshirt) {\n    if (res.tshirt == 's') tshirt_type = config.product_tshirt_s;\n    if (res.tshirt == 'm') tshirt_type = config.product_tshirt_m;\n    if (res.tshirt == 'l') tshirt_type = config.product_tshirt_l;\n    if (res.tshirt == 'xl') tshirt_type = config.product_tshirt_xl;\n  }\n\n  items = [ {\n    price: config.product_bronze_ticket,\n    quantity: 1\n  }, {\n    price: tshirt_type,\n    quantity: 1\n  } ];\n```\n\nあとは、Bronze Supporterチケットの場合はTシャツの配送に住所を入力してもらう必要があります。Checkoutセッションデータに配送料金の `shipping_rates` と配送対象国（どの国への配送が可能）を `shipping_address_collection` の `allowed_countries` で指定します。\n\nまとめるとこんな感じになります。\n\n```\n  const session = await stripe.checkout.sessions.create( {\n    line_items: [ {\n      price: config.product_bronze_ticket,\n      quantity: 1\n    }, {\n      price: tshirt_type,\n      quantity: 1\n    } ],\n    payment_method_types: [ 'card' ],\n    mode: 'payment',\n    success_url: config.success_url,\n    cancel_url: config.cancel_url,\n    shipping_rates: [ config.shipping_rate ],\n    shipping_address_collection: {\n      allowed_countries: config.shipping_countries.split(',')\n    }\n  } );\n```\n\n\b配送情報がセッションデータに含まれるとStripe Checkoutで住所入力フィールドが一緒にフォームに表示されます。\n\n![Stripe Checkout Bronze](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/xl82a4iy6uu47hot3lml.png)\n\n一応、この数十行のコードだけでStripe Checkoutでの決済は可能になりました。購入決済が完了されたら、StripeからWebhookを呼び出し、メール送信などの他の処理が可能なので、次のセクションで紹介します。\n\n## Stripe Webhookの実装\n\n先ほど紹介しましたが、TDFでは、チケット購入の決済完了となった時はVisitorへのチケット情報をメールで送信します。こちらの対応は別のLambda関数を作成し、API GatewayのURLをStripe Webhookに設定します。\n\n![TDF Stripe Webhook](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/su51bm074bf6j57u7t16.png)\n\nWebhookの処理は各自それぞれ違う対応になりますので、StripeからのPOSTデータのデコードまで紹介します。\n\nまずは、WebhookのURLが公開されているため、誰でもアクセスができてしまいます。Stripeからのアクセスの際はHTTPヘッダーに署名が含まれ、Webhookシークレットのキーでペイロードデータが正常なのかを確認します。\n\n```\nexports.handler = async (event) => {\n  // require Stripe signature in header\n  if (!event.headers['stripe-signature']) {\n    console.log('no Stripe signature received in header, returning 400 Bad Request');\n    return {\n      statusCode: 400\n    };\n  }\n\n  const sig = event.headers['stripe-signature'];\n\n  // require an event body\n  if (!event.body) {\n    console.log('no event body received in POST, returning 400 Bad Request');\n    return {\n      statusCode: 400\n    };\n  }\n\n  // decode payload\n  let payload = event.body;\n  if (event.isBase64Encoded)\n    payload = Buffer.from(event.body, 'base64').toString();\n\n  // construct a Stripe Webhook event\n  const config = await loadConfig();\n  const stripe = require('stripe')(config.stripe_api_secret_key);\n\n  try {\n    let ev = stripe.webhooks.constructEvent(payload, sig, config.webhook_signing_secret);\n  } catch (err) {\n    console.log('error creating Stripe Webhook event');\n    console.log(err);\n    return {\n      statusCode: 400\n    };\n  }\n\n  // ...TODO...\n\n  return {\n    statusCode: 200\n  };\n}\n```\n\nStripe Webhookのイベントまで正常に作成したら、次はCheckoutセッションのステータス変化を確認します。決済に関して以下の3つのイベントを対応するのが一般的です。\n\n1. `checkout.session.completed` : Stripe Checkoutで決済が行われました。支払い方法によって、決済が完了になってない可能性があります。クレジットカードの場合は基本的に `payment_status` が `paid` になるので、決済完了ということになります。\n2. `checkout.session.async_payment_succeeded` : `completed` のイベントで決済が未完了だったのが、決済完了となりました。\n3. `checkout.session.async_payment_failed` : `completed` のイベントで決済が未完了だったのが、決済失敗となりました。\n\nこの3つのイベントを対応するには[Stripeのサンプルコード](https://stripe.com/docs/payments/checkout/fulfill-orders)とほぼ同様に行ってます。\n\n```\nconst createOrder = async function(session) {\n  // we (TDF) don't need to do anything here\n}\n\nconst fulfillOrder = async function(session) {\n  // send ticket info to customer by email\n  console.log('customer email is: ' + session.customer_details.email);\n}\n\nconst emailCustomerAboutFailedPayment = async function(session) {\n  // send email about failed payment\n}\n\nexports.handler = async (event) => {\n  // ...\n  const session = ev.data.object;\n  switch (ev.type) {\n    case 'checkout.session.completed':\n      // save an order in your database, marked as 'awaiting payment'\n      await createOrder(session);\n\n      // check if the order is paid (e.g., from a card payment)\n      // a delayed notification payment will have an `unpaid` status\n      if (session.payment_status === 'paid') {\n        await fulfillOrder(session);\n      }\n      break;\n\n    case 'checkout.session.async_payment_succeeded':\n      // fulfill the purchase...\n      await fulfillOrder(session);\n      break;\n\n    case 'checkout.session.async_payment_failed':\n      // send an email to the customer asking them to retry their order\n      await emailCustomerAboutFailedPayment(session);\n      break;\n  }\n```\n\n`createOrder()` 、`fulfillOrder()` 、そして `emailCustomerAboutFailedPayment()` の3つの関数を実装することでWebhookの対応は完了になります。\n\nもしWebhookがエラーで `HTTP 2xx` 以外のレスポンスを返された場合、Stripe側では時間を置いてから自動的にリトライされます。詳しくは[Stripe Webhook Best Practices](https://stripe.com/docs/webhooks/best-practices)を確認してください。\n\nここまで実装ができてれば、Stripe Checkoutの対応は完了になります。おめでとうございます！\n\n## API GatewayのCustom Domainで複数エンドポイントをひとつに統合\n\n今回の実装では、Stripe CheckoutのURL生成とStripe Webhookの2つのエンドポイントがあります。もちろんAPI Gatewayで払い出されたURL ( `https://7q6f1e5os2.execute-api.ap-northeast-1...` )をそのまま使えますが、 `stripe.tokyodemofest.jp` などの名前を付けられたサブドメインに統合するとURLの見た目が良くなります。\n\n![API Gateway Custom Domain](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/mpvoy2tl8f32h3ipbkm9.png)\n\nこんな感じで `checkout` と `fulfill` の2つのLambdaとAPI GatewayがCustom Domainの1つにまとめています。\n\n## TDFで初めてStripeを実装しての感想\n\n正直、Stripe Checkoutをサーバーレスで実装するのはとても簡単でした。コードを書く量が少ないので、本当に数十行だけで自分のWebサイトから決済ができるようになります。\n\nしかも、CheckoutやWebhookを実装してる際はStripe UIでAPIのHTTPリクエストとレスポンスとログ情報まで細かく見れて、Dashboardでグラフがとてもわかりやすいです。\n\nひとつ欲を言えば、テスト環境で作成した商品を簡単に本番モードに持って行きたいです。Webhookは「テストエンドポイントをインポート」する機能がありますが、~~商品ではできないのがちょっとだけ残念です。テスト環境で作成した商品をもう一度すべて本番モードで作り直す必要があります。~~\n\n【※: 投稿してから知りましたが、実は商品詳細ページには「本番環境にコピー」というボタンがあります。テスト環境で作成したすべての商品を一気に本番環境までインポートするのはできないようですが、1つずつ商品をコピーするのは可能です。】\n\n長年PayPalと戦っていたので、もっと早く乗り換えれば良かったと後悔しています（笑）\n\n最後まで読んでくれてありがとうございました。何か質問やコメントがあれば、ぜひどうぞよろしくお願いいたします！",n.user={name:"Michael Tedder",username:i,twitter_username:"_falken",github_username:i,website_url:"https://tedder.cc",profile_image:"https://res.cloudinary.com/practicaldev/image/fetch/s--Fad5Ur6y--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/571956/6bcaa3e9-48b2-40f9-b347-eadfba523ec5.jpeg",profile_image_90:"https://res.cloudinary.com/practicaldev/image/fetch/s--HPRr7_Xx--/c_fill,f_auto,fl_progressive,h_90,q_auto,w_90/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/571956/6bcaa3e9-48b2-40f9-b347-eadfba523ec5.jpeg"},n.organization={name:"AWS Community Builders ",username:a,slug:a,profile_image:"https://res.cloudinary.com/practicaldev/image/fetch/s--zmOZQNzv--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/organization/profile_image/2794/88da75b6-aadd-4ea1-8083-ae2dfca8be94.png",profile_image_90:"https://res.cloudinary.com/practicaldev/image/fetch/s--vWmcJ-ty--/c_fill,f_auto,fl_progressive,h_90,q_auto,w_90/https://dev-to-uploads.s3.amazonaws.com/uploads/organization/profile_image/2794/88da75b6-aadd-4ea1-8083-ae2dfca8be94.png"},{layout:"default",data:[{}],fetch:{"data-v-70afb46a:0":{article:n}},error:e,state:{currentArticle:n},serverRendered:!0,routePath:"/falken42/911258",config:{_app:{basePath:"/nuxtstop/",assetsPath:"/nuxtstop/_nuxt/",cdnURL:e}}}}(null,"2021-12-02T15:19:16Z",{},"https://dev.to/aws-builders/chu-metenostripe-wan-quan-nisabaresunotiketutofan-mai-2780","falken42","aws-builders")</script><script src="/nuxtstop/_nuxt/f6e87fb.js" defer></script><script src="/nuxtstop/_nuxt/dc9ce94.js" defer></script><script src="/nuxtstop/_nuxt/6474719.js" defer></script><script src="/nuxtstop/_nuxt/9b75090.js" defer></script><script src="/nuxtstop/_nuxt/18df600.js" defer></script>
  </body>
</html>
