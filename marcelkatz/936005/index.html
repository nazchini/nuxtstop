<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Node.js and Redis deployed in Docker containers, using Docker Compose - then load-balancing the Node.js servers with Nginx</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="Using Nuxt.js fetch() hook to build dev.to with a new look"><meta data-n-head="ssr" name="format-detection" content="telephone=no"><base href="/nuxtstop/"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,500,600&display=swap"><link rel="preload" href="/nuxtstop/_nuxt/f6e87fb.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/6474719.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/9b75090.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/18df600.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/dc9ce94.js" as="script"><style data-vue-ssr-id="c650fd98:0 af4684f0:0 a9c71758:0 dcafa518:0 4b9cec49:0 b093d766:0 9d98bcb4:0 6b6a11ea:0 0248ed80:0 ea8e4264:0">html{box-sizing:border-box;font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}*,:after,:before{box-sizing:inherit}html{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}*,:after,:before{border:0 solid #e0e0e0}blockquote,body,dd,dl,figure,h1,h2,h3,h4,h5,h6,p,pre{margin:0}button{background:0 0;padding:0}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}hr{border-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:inherit;opacity:.5}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:inherit;opacity:.5}input::placeholder,textarea::placeholder{color:inherit;opacity:.5}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit;font-family:sans-serif}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit;font-family:inherit;font-size:100%}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;overflow:auto;word-break:break-word;white-space:normal}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}html{height:100%;font-size:18px;-ms-overflow-style:scrollbar;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}@media(min-width:640px){html{font-size:20px}}body{height:100%;min-width:320px;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:400;line-height:1.5;color:#000;background-color:#eff4f7;-webkit-text-rendering:optimizeLegibility;text-rendering:optimizeLegibility;font-synthesis:none;font-kerning:normal;font-feature-settings:"normal","kern";-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-overflow-scrolling:touch;overflow-x:hidden;overflow-y:scroll}h1,h2,h3,h4,h5,h6{color:#000;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:600;font-feature-settings:"normal";line-height:1.2}pre{background:#29292e;border-radius:2px;overflow:auto;padding:1rem;color:#eff1f9;line-height:1.42em;font-size:13px}@media screen and (min-width:380px){pre{font-size:15px}}pre code{background:#29292e;color:#eff0f9;white-space:pre}div.highlight pre.highlight code{font-size:inherit;padding:0}div.inner-comment div.body div.highlight pre.highlight{background:#29292e}div.inner-comment div.body div.highlight pre.highlight code{font-size:inherit;white-space:inherit;background:inherit;color:inherit}.highlight .hll{background-color:#49483e}.highlight{background:#29292e;color:#f8f8f2}.highlight .c{color:grey}.highlight .err{text-shadow:0 0 7px #f9690e}.highlight .k{color:#f39c12}.highlight .l{color:plum}.highlight .n{color:#f8f8f2}.highlight .o{color:#f9690e}.highlight .p{color:#f8f8f2}.highlight .c1,.highlight .ch,.highlight .cm,.highlight .cp,.highlight .cpf,.highlight .cs{color:grey}.highlight .gd{color:#f9690e}.highlight .ge{font-style:italic}.highlight .gi{color:#7ed07e}.highlight .gs{font-weight:700}.highlight .gu{color:grey}.highlight .kc,.highlight .kd{color:#f39c12}.highlight .kn{color:#f9690e}.highlight .kp,.highlight .kr,.highlight .kt{color:#f39c12}.highlight .ld{color:#f2ca27}.highlight .m{color:plum}.highlight .s{color:#f2ca27}.highlight .na{color:#7ed07e}.highlight .nb{color:#f8f8f2}.highlight .nc{color:#7ed07e}.highlight .no{color:#f39c12}.highlight .nd{color:#7ed07e}.highlight .ni{color:#f8f8f2}.highlight .ne,.highlight .nf{color:#7ed07e}.highlight .nl,.highlight .nn{color:#f8f8f2}.highlight .nx{color:#7ed07e}.highlight .py{color:#f8f8f2}.highlight .nt{color:#f9690e}.highlight .nv{color:#f8f8f2}.highlight .ow{color:#f9690e}.highlight .w{color:#f8f8f2}.highlight .mb,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo{color:plum}.highlight .dl,.highlight .s2,.highlight .sa,.highlight .sb,.highlight .sc,.highlight .sd{color:#f2ca27}.highlight .se{color:plum}.highlight .s1,.highlight .sh,.highlight .si,.highlight .sr,.highlight .ss,.highlight .sx{color:#f2ca27}.highlight .bp{color:#f8f8f2}.highlight .fm{color:#7ed07e}.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{color:#f8f8f2}.highlight .il{color:plum}.vue-content-placeholders-heading__img,.vue-content-placeholders-heading__subtitle,.vue-content-placeholders-heading__title,.vue-content-placeholders-img,.vue-content-placeholders-text__line{background:#bfcdec!important}.vue-content-placeholders-is-animated .vue-content-placeholders-heading__img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__subtitle:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__title:before,.vue-content-placeholders-is-animated .vue-content-placeholders-img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-text__line:before{background:linear-gradient(90deg,transparent 0,#d3ddf9 15%,transparent 30%)!important}header[data-v-27046cca]{max-width:1280px;margin:auto;padding:1rem;height:6rem;border-bottom:1px solid rgba(0,0,0,.2)}header .logo-wrapper[data-v-27046cca],header[data-v-27046cca]{display:flex;align-items:center;justify-content:space-between}header .logo-wrapper[data-v-27046cca]{margin:0 .5rem}header .logo-wrapper svg[data-v-27046cca]{width:3rem;height:100%}header .logo-wrapper .name-wrapper[data-v-27046cca]{margin-left:.6em}header .logo-wrapper .name-wrapper .subtitle[data-v-27046cca]{font-size:1rem}header .logo-wrapper .name-wrapper .app-name[data-v-27046cca]{font-weight:700;font-size:2.25rem;line-height:1.25}header nav[data-v-27046cca]{letter-spacing:-.025rem;font-weight:600;text-transform:uppercase}header nav ul[data-v-27046cca]{display:flex}header nav ul li[data-v-27046cca]{margin:0 .5rem}header nav ul li a[data-v-27046cca]{box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;padding:.25rem 1rem;border-radius:.5rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}header nav ul li a[data-v-27046cca]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header nav ul li a.nuxt-link-exact-active[data-v-27046cca]{cursor:default}header nav ul li a.nuxt-link-exact-active[data-v-27046cca],header nav ul li a[data-v-27046cca]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}.page-wrapper[data-v-10d06ee8]{max-width:1280px;margin:auto;padding:1rem}.article-content-wrapper[data-v-10d06ee8]{display:flex;flex-direction:column;align-items:center;margin:auto auto 2rem}@media(min-width:1024px){.article-content-wrapper[data-v-10d06ee8]{align-items:normal;flex-direction:row}}.article-content-wrapper .article-block[data-v-10d06ee8]{width:100%;max-width:880px}@media(min-width:1024px){.article-content-wrapper .article-block[data-v-10d06ee8]{margin-right:1rem;width:66.66666%;margin-bottom:2rem}}.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{max-width:880px;width:100%;position:relative}@media(min-width:1024px){.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{display:block;width:33.33333%}}.article-content-wrapper .aside-username-wrapper .aside-username-block[data-v-10d06ee8]{position:-webkit-sticky;position:sticky;top:1rem}@media(min-width:1280px){.comments-block[data-v-10d06ee8]{margin:.5rem}}article[data-v-70afb46a]{padding:.5rem;border-radius:1rem}header h1[data-v-70afb46a],header[data-v-70afb46a]{margin-bottom:1rem}header h1[data-v-70afb46a]{font-size:2.25rem;letter-spacing:-.025rem}header .tags[data-v-70afb46a]{display:flex;flex-wrap:wrap;margin-bottom:1.5rem}header .tags .tag[data-v-70afb46a]{font-weight:500;line-height:1;padding:.5rem;margin:0 .5rem .5rem 0;border-radius:.25rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db}header .tags .tag[data-v-70afb46a]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header .tags .tag[data-v-70afb46a]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}header .image-wrapper[data-v-70afb46a]{position:relative;padding-bottom:56.25%;background-color:#d4dfe8;margin-bottom:1.5rem;border-radius:.5rem;overflow:hidden}@media(min-width:834px){header .image-wrapper[data-v-70afb46a]{margin-bottom:1.5rem}}header .image-wrapper img[data-v-70afb46a]{position:absolute;top:0;left:0;width:100%;height:100%;-o-object-fit:cover;object-fit:cover}header .meta[data-v-70afb46a]{line-height:1;font-size:.875rem;text-transform:uppercase;font-weight:500;letter-spacing:-.025rem;display:flex;align-items:center;justify-content:space-between}header .meta .scl[data-v-70afb46a]{display:flex}header .meta .scl span[data-v-70afb46a]{display:flex;align-items:center;margin-right:1rem}header .meta .scl span svg[data-v-70afb46a]{margin-right:.25rem}header .meta .scl .comments[data-v-70afb46a]{cursor:pointer}[data-v-70afb46a] .content .ltag__user{display:none}[data-v-70afb46a] .content iframe{max-width:100%}[data-v-70afb46a] .content h1{font-size:1.875rem}[data-v-70afb46a] .content h1,[data-v-70afb46a] .content h2{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h2{font-size:1.5rem}[data-v-70afb46a] .content h3{font-size:1.25rem}[data-v-70afb46a] .content h3,[data-v-70afb46a] .content h4{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h4{font-size:1rem}[data-v-70afb46a] .content a{color:#6e87d2}[data-v-70afb46a] .content p{margin-bottom:1rem;line-height:1.4}[data-v-70afb46a] .content p code{background-color:#d2f3e1;border-radius:.25rem;padding:.25rem}[data-v-70afb46a] .content img{width:100%;border-radius:.5rem}[data-v-70afb46a] .content .highlight{margin-bottom:1rem;border-radius:.5rem}[data-v-70afb46a] .content ul{list-style:numeral;margin-bottom:1rem}[data-v-70afb46a] .content ul li p{margin-bottom:0}[data-v-70afb46a] .content ol{margin-bottom:1rem}aside[data-v-37984f8c]{padding:1rem;background-color:#dfe8ef;border-radius:1rem}aside .username-heading[data-v-37984f8c]{display:flex;margin-bottom:1rem}aside .username-heading[data-v-37984f8c]:hover{color:#6e87d2}aside .username-heading img[data-v-37984f8c]{width:3rem;height:3rem;border-radius:50%;margin-right:1rem}aside .username-heading .text[data-v-37984f8c]{display:flex;flex-direction:column;justify-content:center}aside .username-heading .text a[data-v-37984f8c]{line-height:1}aside .username-heading .text a[data-v-37984f8c]:first-child{font-size:1.25rem;font-weight:500;letter-spacing:-.025rem;margin-bottom:.25rem}aside .username-heading .text a[data-v-37984f8c]:last-child{color:#999;font-size:.875rem}aside .username-heading.loading[data-v-37984f8c]{display:block}aside .f-button[data-v-37984f8c]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}aside .f-button[data-v-37984f8c]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}aside .f-button[data-v-37984f8c]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}aside .info>div[data-v-37984f8c]{margin-bottom:.5rem}aside .info .title[data-v-37984f8c]{font-size:.666666rem;letter-spacing:-.0125rem;font-weight:500;color:#999;text-transform:uppercase;margin-bottom:.1rem}aside .info .content[data-v-37984f8c]{font-size:.875rem;line-height:1.4}.add-comment[data-v-8c4375bc]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}.add-comment[data-v-8c4375bc]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}.add-comment[data-v-8c4375bc]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}footer[data-v-22cb8fd0]{padding:2rem;text-align:center;display:flex;align-items:center;justify-content:center}footer span[data-v-22cb8fd0]{display:inline-block;line-height:1;text-transform:uppercase;letter-spacing:-.025rem;font-size:.75rem;font-weight:500}footer a svg[data-v-22cb8fd0]{width:3rem;height:3rem;margin:0 .5rem}footer a .nuxt-icon[data-v-22cb8fd0]{width:2.5rem;height:2.5rem;margin:0 .25rem}</style>
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><div id="__layout"><div><header data-v-27046cca><a href="/nuxtstop/" class="logo-wrapper nuxt-link-active" data-v-27046cca><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-27046cca><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-27046cca></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-27046cca></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-27046cca></path></svg> <div class="name-wrapper" data-v-27046cca><span class="app-name" data-v-27046cca>Nuxtstop</span> <p class="subtitle" data-v-27046cca>For all things nuxt.js</p></div></a> <nav data-v-27046cca><ul data-v-27046cca><li data-v-27046cca><a href="/nuxtstop/" class="nuxt-link-active" data-v-27046cca>
          New
        </a></li><li data-v-27046cca><a href="/nuxtstop/top" data-v-27046cca>
          Top
        </a></li></ul></nav></header> <div class="page-wrapper" data-v-10d06ee8><div class="article-content-wrapper" data-v-10d06ee8><article data-fetch-key="data-v-70afb46a:0" class="article-block" data-v-70afb46a data-v-10d06ee8><header data-v-70afb46a><h1 data-v-70afb46a>Node.js and Redis deployed in Docker containers, using Docker Compose - then load-balancing the Node.js servers with Nginx</h1> <div class="tags" data-v-70afb46a><a href="/nuxtstop/t/docker" class="tag" data-v-70afb46a>
          #docker
        </a><a href="/nuxtstop/t/node" class="tag" data-v-70afb46a>
          #node
        </a><a href="/nuxtstop/t/redis" class="tag" data-v-70afb46a>
          #redis
        </a><a href="/nuxtstop/t/nginx" class="tag" data-v-70afb46a>
          #nginx
        </a></div> <!----> <div class="meta" data-v-70afb46a><div class="scl" data-v-70afb46a><span data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M16.4444 3C14.6733 3 13.0333 3.94162 12 5.34C10.9667 3.94162 9.32667 3 7.55556 3C4.49222 3 2 5.52338 2 8.625C2 14.8024 11.0267 20.586 11.4122 20.829C11.5922 20.9426 11.7956 21 12 21C12.2044 21 12.4078 20.9426 12.5878 20.829C12.9733 20.586 22 14.8024 22 8.625C22 5.52338 19.5078 3 16.4444 3Z" fill="#FF0000" data-v-70afb46a data-v-70afb46a></path></svg>
            80
          </span> <span class="comments" data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M6.11765 22H4.94118L5.64706 21.05C6.11765 20.3969 6.41176 19.5656 6.58824 18.5563C3.64706 17.1906 2 14.6375 2 11.3125C2 6.20625 5.82353 3 12 3C18.1765 3 22 6.20625 22 11.3125C22 16.5375 18.2353 19.625 12 19.625H11.5882C10.6471 20.7531 9 22 6.11765 22ZM12 4.1875C6.47059 4.1875 3.17647 6.85937 3.17647 11.3125C3.17647 15.1125 5.47059 16.8938 7.41177 17.6656L7.82353 17.8437L7.76471 18.3187C7.64706 19.2687 7.47059 20.1 7.11765 20.8125C9.05882 20.575 10.1765 19.5656 10.8235 18.7344L11 18.4969H12C19.9412 18.4969 20.8235 13.5094 20.8235 11.3719C20.8235 6.85938 17.5294 4.1875 12 4.1875Z" fill="black" data-v-70afb46a data-v-70afb46a></path></svg>
            2
          </span></div> <time data-v-70afb46a>Dec 24 '21</time></div></header> <div class="content" data-v-70afb46a><p>This article contains two main stages:<br>
<strong>(1) Containerizing a Node.js server application and a Redis database instance into two separate Docker containers, using Dockerfile and Docker Compose, and showing how these two applications communicate with each other.</strong></p>

<p><strong>(2) Load-balancing the Node.js server, using a containerized Nginx reverse-proxy.</strong> </p>

<p><strong>Let’s start with Stage 1:<br>
(1) Containerizing a Node.js server application and a Redis instance into two separate Docker containers, using Dockerfile and Docker Compose, and showing how these two applications communicate with each other</strong></p>

<p>Starting with a simple <strong>Node.js server</strong> application (we’ll call it “<em>test-webapp</em>”) that responds to an <em>HTTP GET</em> request by displaying the “numbers of visits”. The numbering scheme below (i.e. (1.1), (1.2), (1.3) etc.), matches the numbering in the diagram below:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--vjd6PFTp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/3yp6moj945jli4n6vfl4.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--vjd6PFTp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/3yp6moj945jli4n6vfl4.png" alt="Figure 1.a – Schematic diagram of the components" loading="lazy" width="624" height="350"></a><br>
<em>Figure 1.a - Schematic diagram of the components</em></p>

<p>In "<strong>Figure 1.a - Schematic diagram of the components</strong>" above we have the following components:<br>
(<strong>1.1</strong>) "<em>Docker Container 1</em>" - container running the <strong>Node.js server</strong> called "<em>test-webapp</em>" that communicates with the browser on the left. Each time we refresh the URL <code>localhost:80</code> i.e. we send a <code>GET</code>command to the <strong>Node.js server</strong> "<em>test-webapp</em>", the server code increments the number of visits, then saves this value into the <strong><em>Redis</em></strong> database instance that runs on "<em>Docker Container 2</em>", and also displays the value back in the browser.</p>

<p>(<strong>1.2</strong>) “<em>Dockerfile</em>” - defines and controls the <strong>Node.js server</strong> process in “<em>Docker Container 1</em>”. </p>

<p>(<strong>1.3</strong>, <strong>1.3.1</strong>, <strong>1.3.2</strong>) “<em><a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/docker-compose.yml">docker-compose.yml</a></em>” – the <strong>Docker Compose</strong> config file defines and controls both “<em>Docker Container 1</em>” and “<em>Docker Container 2</em>”. “<em>Docker Container 1</em>” runs the <strong>Node.js server</strong> process “<em>test-webap_p”. “_Docker Container 2</em>” runs the <strong><em>Redis</em></strong> database instance.</p>

<p>(<strong>1.3.3</strong>) <strong>Docker Compose</strong> establishes by default a communication network between “<em>Docker Container 1</em>” and “<em>Docker Container 2</em>” which allow the <strong>Node.js server</strong> process “<em>test-webapp</em>” to communicate with the <strong><em>Redis</em></strong> database instance, and exchange between them the “number of visits to the app/web server” (<code>numVisits</code>) value.</p>

<p>(<strong>1.3.4</strong>) <strong>Docker Compose</strong> maps local hosting machine Port 80 to “<em>Docker Container 1</em>” Port 5000. Port 5000 is the port on which the <strong>Node.js server</strong> “<em>test-webapp</em>” listens and reacts to the <code>GET</code>commands sent by the browser.</p>

<p>(<strong>1.4</strong>) Connecting to the shell of “<em>Docker Container 2</em>” and then to the client command line of the <strong><em>Redis</em></strong> database instance via “<code>redis-cli</code>” we can see that the value of <code>numVisits</code> (which represents the number of times the browser issued a <code>GET</code>command to the <strong>Node.js server</strong>) is in sync with the value displayed in the browser by the <strong>Node.js server</strong> – thus showing that inter-process communication occurs between the processes “<em>test-webapp</em>” in “<em>Docker Container 1</em>” and the <strong><em>Redis</em></strong> process in “<em>Docker Container 2</em>”.</p>

<p>(<strong>1.5</strong>) This step illustrates the <code>restart</code> directive and capability in <strong>Docker Compose</strong> (specified in config file “<em>docker-compose.yml</em>”) – when connecting to the Linux shell of “<em>Docker Container 1</em>”, we can <code>kill -9</code> the <strong>Node.js server</strong> process, but the <strong>Node.js server</strong> process will be restarted automatically by <strong>Docker Compose</strong> – illustrating the automatic recovery provided by <strong>Docker Compose</strong>.</p>

<p>And now let’s describe the steps and the flow of this scenario. The numbering scheme in the description below (i.e. (1.1), (1.2), (1.3) etc.), matches the numbering in “<strong>Figure 1.a – Schematic diagram of the components</strong>”.</p>

<p><strong>(1.1) File structure:</strong></p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--_yC5myBq--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/rm92ysovtnnq9azlunop.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--_yC5myBq--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/rm92ysovtnnq9azlunop.png" alt="Figure 1.b – File structure for Stage 1" loading="lazy" width="864" height="688"></a><br>
<em>Figure 1.b – File structure for Stage 1</em></p>

<p><strong>Node.js files for process ‘test-webapp’:</strong></p>

<p>The contents of directory “<em>test-webapp</em>”, where the source code for the <strong>Node.js server</strong> “<em>test-webapp</em>” resides:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--bSempo81--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jqed4cw6m1mpm1upws9m.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--bSempo81--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jqed4cw6m1mpm1upws9m.png" alt="Node.js files for process 'test-webapp'" loading="lazy" width="165" height="164"></a></p>

<p>(<strong>1.2</strong>) The <em>Dockerfile _containerizes and controls the <strong>Node.js application</strong> by downloading the “_node:alpine</em>” image from <a href="https://hub.docker.com/">Docker Hub</a>, installing <strong>Node.js</strong> on the container, copying to the container the <a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/tree/main/test-webapp">source files</a> – then launching the <strong>Node.js server</strong> web app (see source code in file “<a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/test-webapp/server.js"><em>server.js</em></a>”).</p>

<p>(<strong>1.3</strong>) Going one directory above, we see the "<em><a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/docker-compose.yml">docker-compose.yml</a></em>" file that organizes the containerization and sets up the architecture of all the components. (File <br>
“<em><a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/docker-compose-nginx.yml">docker-composer-nginx.yml</a></em>” will be presented and explained in <strong>Stage 2</strong> of this article)</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--naPa4IgZ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/tqtlkv6v7vams8x3xq9d.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--naPa4IgZ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/tqtlkv6v7vams8x3xq9d.png" alt="'docker-compose.yml' file for process 'test-webapp'" loading="lazy" width="312" height="88"></a></p>

<p><strong>Purge all images and containers:</strong></p>

<p>We run command <code>docker system prune -a</code> to clear all Docker images and containers and start with a clean slate.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>C:\test-docker\test-redis>docker system prune -a                                          
WARNING! This will remove:                                                                                                
- all stopped containers                                                                                                
- all networks not used by at least one container                                                                       
- all images without at least one container associated to them                                                          
- all build cache                                                                                                                                                                                                                             
Are you sure you want to continue? [y/N] y
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p><strong>(1.3) Build and run the 'test-webapp' image with Docker Compose</strong></p>

<p>Use command <code>docker-compose -f &lt;config-filename> build</code> to build containers and the applications that will be running in each container:</p>

<p><code>C:\test-docker\test-redis>docker-compose -f docker-compose.yml build</code></p>

<p>See the results below of the built Docker image:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>C:\test-docker\test-redis>docker images                                                                                                                     
REPOSITORY               TAG       IMAGE ID       CREATED         SIZE                                                                                                                     
test-redis_test-webapp   latest    e8145bea0fec   4 minutes ago   175MB
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p><strong>Run the 'test-webapp' and 'redis' containers with 'docker-compose':</strong></p>

<p>Let’s launch both “<em>test-webapp</em>” and “<em>redis</em>” services, as described in config file <br>
“<em><a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/docker-compose.yml">docker-compose.yml</a></em>”, using the <code>docker-compose -f &lt;config-filename> up</code> command.</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--7d3NTR5i--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/66ukw6kmm4djhk2nzxsa.PNG" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--7d3NTR5i--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/66ukw6kmm4djhk2nzxsa.PNG" alt="docker-compose -f docker-compose.yml up" loading="lazy" width="634" height="233"></a></p>

<p>We can see from the output above, that both the “<em>redis</em>” container (“<em>test-redis_1</em>” – corresponding to “<em>Docker Container 2</em>” in <strong>Figure 1.a</strong>) and the “<em>test-webapp</em>” container (“<em>test-webapp_1</em>” corresponding to “<em>Docker Container 1</em>” in <strong>Figure 1.a</strong>) are running and printing to stdout in the command line window where we launched <strong>Docker Compose</strong> to run these two containers.</p>

<p><strong>View the 'test-webapp' and 'redis' running containers:</strong><br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>C:\test-docker\test-redis\test-webapp>docker ps                                                                                        
CONTAINER ID   IMAGE                    PORTS                
NAMES                                         
928b8b07415d   test-redis_test-webapp   0.0.0.0:80->5000/tcp   test-redis_test-webapp_1                      
a8756127bff5   redis:alpine             6379/tcp               test-redis_test-redis_1
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>(<strong>1.3.1</strong>, <strong>1.3.2</strong>) The two containers above match the containers “<em>Docker Container 1</em>” and “<em>Docker Container 2</em>” in the <strong>Figure 1.a</strong> above. Note the “<em>CONTAINER ID</em>” column whose values we will use below to perform operation on each individual running container. </p>

<p>(<strong>1.3.4</strong>) Port 5000 in the <strong>Node.js server</strong> "<em>test-webapp</em>" container is mapped to local (hosting) Port 80, so when one connects in the local (hosting) browser to URL <strong><a href="http://localhost:80">http://localhost:80</a></strong>, for each refresh, the <strong>Node.js process</strong> in the “<em>test-webapp</em>” container increments the number of visits in variable <code>numVisits</code> which is set and saved in the <strong><em>Redis</em></strong> in variable <code>numVisits</code> -- and this value is also send back and displayed in the browser. </p>

<p>“Docker-compose” sets-up by default a network with both “<em>test-webapp</em>” container (“<em>Docker Container 1</em>” in <strong>Figure 1.a</strong>) and “<em>redis</em>” container (“<em>Docker Container 2</em>” in <strong>Figure 1.a</strong>) within this network, and both containers are reachable by each other via this network. </p>

<p>The local browser communicates with the <strong>Node.js server</strong> container. When refreshing the connection in the browser, the server callback is invoked which responds to the browser with the updated number of visits.</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--BKBbVg8w--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/euscx0msi6am2kz9tk7j.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--BKBbVg8w--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/euscx0msi6am2kz9tk7j.png" alt="1.3.4 Browser - localhost - number of visits 8" loading="lazy" width="419" height="170"></a></p>

<p>(<strong>1.4</strong>) We are using the <code>docker exec -it</code> command that allows us to connect to a running container while the <code>-it</code> option allows us to capture the stdin/stdout of that container. Then we specify the CONTAINER ID <em>a8756127bff5</em> obtained from <code>docker ps</code> command above, followed by the shell (<strong><em>sh</em></strong>) that we want to launch as we enter the container. </p>

<p><code>C:\test-redis\test-webapp>docker exec -it a8756127bff5 sh</code></p>

<p>Then, once we are inside the container’s shell, we connect to the <strong><em>Redis</em></strong> database using the <code>redis-cli</code> command. At the <strong><em>Redis</em></strong> prompt we use <code>get numVisits</code> to obtain the value of the variable “<strong>numVisits</strong>” inside “<em>redis</em>”. We can see that the “<em>redis</em>” instance communicates with the “<em>test-webapp</em>” process in its respective container and the variable “<em>numVisits</em>” in the <strong><em>Redis</em></strong> database instance is in sync with its value in the browser. In this case both have the value “<strong>8</strong>”, because we refreshed 8 times the “<strong>localhost:80</strong>” URL thus issuing a <code>GET</code> command in the browser that is intercepted by the *<em>Node.js server *</em> which increments the “number of visits” (<code>numVisits</code>) variable. The “number of visits” value is sent back to the browser by the “<em>test-webapp</em>” process which also saves the value in the “<em>redis</em>” database in variable <code>numVisits</code>).<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>/data # redis-cli                                                                                                                                                     
127.0.0.1:6379> get numVisits                                                                                                                                      
"8"                                                                                                                                                                    
127.0.0.1:6379> 
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>From within the “<em>redis-cli</em>” in the “<em>redis</em>” container (“<em>Docker Container 2</em>”) we can also set in <strong><em>Redis</em></strong> manually the “<em>numVisits</em>” variable to a random value of let’s say “<strong>342</strong>”…</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--5mFZNh5z--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/3snsztp8x4gcgco7t7ec.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--5mFZNh5z--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/3snsztp8x4gcgco7t7ec.png" alt="1.4 - redis - set num visits 342" loading="lazy" width="407" height="91"></a></p>

<p>…the <code>numVisits</code> variable is updated in the “test-webapp” <strong>Node.js server</strong> (running in “<em>Docker Container 1</em>”), and therefore in the browser (due to the fact that in order to invoke the <em>callback</em> in the <strong><a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/test-webapp/server.js">Node.js server</a></strong>, one needs to refresh the connection to “<strong>localhost:80</strong>”, the number of visits increases by <strong>1</strong>, thus <strong>342</strong> + 1 = <strong>343</strong>. This shows that we have two-way inter-process communications between the processes running in “<em>Docker Container 1</em>” and “<em>Docker Container 2</em>”.</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--FNra9-r7--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/oapryvdzrnppyzztuxfn.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--FNra9-r7--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/oapryvdzrnppyzztuxfn.png" alt="1.4 Browser - localhost - number of visits 343" loading="lazy" width="435" height="191"></a></p>

<p>(<strong>1.5</strong>) A useful feature provided by <strong>Docker Compose</strong> is the capability to specify in “<em>docker-compose.yml</em>” a “<a href="https://docs.docker.com/config/containers/start-containers-automatically/#use-a-restart-policy">restart</a>” option. <br>
This will allow us when connecting to the shell of “<em>Docker Container 1</em>”, to “kill” the <strong>Node.js server</strong> process, but the <strong>Node.js server</strong> process will be restarted automatically by the <strong>Docker Compose</strong> “<em>restart</em>” directive.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>C:\test-docker\test-redis>docker ps
CONTAINER ID   IMAGE                      PORTS                    NAMES
c675ff6c0464   test-redis_nginx           0.0.0.0:80->80/tcp       test-redis_nginx_1
3137d1468ec7   test-redis_test-webapp-2   0.0.0.0:3009->5000/tcp   test-redis_test-webapp-2_1 
57d399295421   redis:alpine                                        test-redis_test-redis_1
b30635f44151   test-redis_test-webapp-1   0.0.0.0:3008->5000/tcp   test-redis_test-webapp-1_1
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Connect to the Docker container whose ID is <em>928b8b07415d</em> and invoke the shell (<strong><em>sh</em></strong>). </p>

<p><code>C:\test-redis\test-webapp>docker exec -it 928b8b07415d sh</code></p>

<p>Inside the container, at the shell prompt, show all process id’s using <code>ps -al</code>.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>/usr/src/app # ps -al
PID   USER     TIME  COMMAND
1     root     0:00  npm start
19    root     0:00  node server.js
30    root     0:00  sh
36    root     0:00  ps -al
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Proceed with “killing” the “<em>node server.js</em>” process by issuing a <code>kill -9 &lt;process-id></code> command:</p>

<p><code>/usr/src/app # kill -9 19</code></p>

<p>In the command line window that is running <strong>Docker Compose</strong> we can see how the “<em>test-webapp</em>” receives a “kill signal” (<code>SIGKILL</code>), exited with code ‘<strong>1</strong>’, and then restarted automatically.</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--PyOXsmV8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7m25v5kmnu9zlbobgqgf.PNG" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--PyOXsmV8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7m25v5kmnu9zlbobgqgf.PNG" alt="npm ERR command sh -c node server.js" loading="lazy" width="604" height="136"></a></p>

<p><strong>Conclusion</strong></p>

<p>In <strong>Stage 1</strong> of this example we showed how <strong>Docker Compose</strong> allows us to easily establish independent environments that communicate with each other, and also the automatic fault-tolerance (restart on failure) capability of Docker Compose.</p>

<p><strong>Let’s continue with Stage 2:<br>
(2) Load-balancing the Node.js server, with the help of a containerized Nginx reverse-proxy</strong></p>

<p>The diagram in “<strong>Figure 2.a – Schematic diagram of the components for Stage 2</strong>” describes an architecture similar to the one described earlier in “<strong>Figure 1.a – Schematic diagram of the components</strong>” but with the changes described below.</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--dW6tGtNm--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/02s6wkco89eaeu00ezxu.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--dW6tGtNm--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/02s6wkco89eaeu00ezxu.png" alt="Figure 2.a – Schematic diagram of the components for Stage 2" loading="lazy" width="856" height="484"></a><br>
<em>Figure 2.a – Schematic diagram of the components for Stage 2</em></p>

<p>In “<strong>Figure 2.a – Schematic diagram of the components for Stage 2</strong>” we have the following components:</p>

<p>(<strong>2.1.1</strong>, <strong>2.1.2</strong>) “<em>Docker Container 1</em>” and “<em>Docker Container 2</em>” – two identical containers whose source code reside in directories “<em><a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/tree/main/test-webapp-1">test-webapp-1</a></em>” and “<em><a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/tree/main/test-webapp-2">test-webapp-2</a></em>” (as shown in “<strong>Figure 2.b – File structure for Stage 2</strong>” below), that are almost identical copies of the application “<em>test-webapp</em>” that was described earlier in <strong>Stage 1</strong>. This time we are using two <strong>Node.js server</strong> processes that will serve the client browser from the local host machine, scaling up and load-balancing the original one-server configuration from <strong>Stage 1</strong>. These two containers are defined and controlled each by their respective “<em>Dockerfile</em>” (<strong>2.1.1.1</strong>) and (<strong>2.1.1.2</strong>). Each <strong>Node.js server</strong> “<em>Docker Container 1</em>” and “<em>Docker Container 2</em>” counts the number of visits coming from the local host browser. Then it saves the number of visits into the <strong><em>Redis</em></strong> database, and it also responds back to the browser with the number of visits and with which specific <strong>Node.js server</strong> served each individual <em>HTTP GET</em> request coming from the browser, by sending back to the browser a message of type: <br>
“<strong>test-webapp-1</strong>: Number of visits is: ”, or <br>
“<strong>test-webapp-2</strong>: Number of visits is: ”<br>
…thus highlighting the load-leveling nature of this stage.</p>

<p>(<strong>2.1.3</strong>) “Docker Container 3” – the container running the <strong><em>Redis</em></strong> database instance, identical to the one described in <strong>Stage 1</strong>, storing the “number of visits” performed by the localhost machine browser to “<strong>localhost:80</strong>”. The number of visits is stored by the <strong>Node.js server</strong> processes “<em>test-webapp-1</em>” and “<em>test-webapp-2</em>” in the <strong><em>Redis</em></strong> variable <code>numVisits</code> whose value is transmitted by each <strong>Node.js server</strong> to the <strong><em>Redis</em></strong> database on each refresh on the local host browser.</p>

<p>(<strong>2.2</strong>) “<em><a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/docker-compose-nginx.yml">docker-compose-nginx.yml</a></em>” – the main <strong>Docker Compose</strong> config file defines and controls: (I) “<em>Docker Container 1</em>” running <strong>Node.js server</strong> “<em>test-webapp-1</em>”,  (II) “<em>Docker Container 2</em>” running <strong>Node.js server</strong> “<em>test-webapp-2</em>”, (III) “<em>Docker Container 3</em>” running <strong><em>Redis</em></strong>, and (IV) “<em>Docker Container 4</em>” running <strong><em>Nginx</em></strong>.</p>

<p>(<strong>2.3</strong>) “<em>Docker Container 4</em>” running “<em>Nginx</em>” – This is an additional container introduced in <strong>Stage 2</strong>, defined and controlled by its own <em>Dockerfile</em> (<strong>2.3.1</strong>), that runs an “<em>nginx</em>” instance, and acts a as reverse-proxy that routes the <em>HTTP GET</em> requests coming from the local host browser. The “<strong><em>Nginx</em></strong>” process in “<em>Docker Container 4</em>” routes the <em>HTTP GET</em> requests coming from local host browser “<strong>localhost:80</strong>”, in a <strong>round-robin</strong> manner (<strong>(2.3.3)</strong> and <strong>(2.3.4)</strong>), to either the “<em>test-webapp-1</em>” <strong>Node.js server</strong> in “<em>Docker Container 1</em>” or to “<em>test-webapp-2</em>” <strong>Node.js</strong> server in “<em>Docker Container 2</em>”. The “<strong><em>nginx</em></strong>” process in “<em>Docker Container 4</em>” is defined and controlled by the <strong>_Nginx _</strong>config file “<em><a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/nginx/nginx.conf">nginx.conf</a></em>” which is copied by <strong><em>Nginx</em></strong> container’s <em>Dockerfile</em> to the “<em>Docker Container 4</em>” environment file “<em>/etc/nginx/conf.d./<strong>default.conf</strong></em>” (this is a standard <strong><em>Nginx</em></strong> setup). The “<em>nginx</em>” instance distributes the incoming traffic from the local host browser, thus scaling up and load- balancing the single-container web/app server architecture presented in <strong>Stage 1</strong>. </p>

<p>And now let’s describe the steps and the flow of this scenario. The numbering scheme in the description below (i.e. (2.1), (2.2), (2.3) etc.), matches the numbering in “<strong>Figure 2.a – Schematic diagram of the components for Stage 2</strong>”.</p>

<p><strong>(2.1) File structure:</strong></p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--5AOs-x2p--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/8v7qndptehh545sknesh.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--5AOs-x2p--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/8v7qndptehh545sknesh.png" alt="Figure 2.b – File structure for Stage 2" loading="lazy" width="864" height="684"></a></p>

<p>The file structure described in “<strong>Figure 2.b – File structure for Stage 2</strong>” is almost identical to the files structure described earlier in “<strong>Figure 1.b – File structure for Stage 1</strong>” with the following changes:</p>

<p>(<strong>2.1.1</strong>, <strong>2.1.2</strong>) The files from directory “<em>test-webapp</em>” from <strong>Stage 1</strong> were copied into directories “<em>test-webapp-1</em>” and “<em>test-webapp-2</em>”.</p>

<p>(<strong>2.2</strong>) Going one directory above, we see the "<em><a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/docker-compose-nginx.yml">docker-compose-nginx.yml</a></em>" config file that organizes the containerization and sets up the architecture of all the components:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--A8ZD3MU4--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/23ztsgagx0fthaktnn3n.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--A8ZD3MU4--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/23ztsgagx0fthaktnn3n.png" alt="'docker-compose-nginx.yml' file" loading="lazy" width="293" height="106"></a></p>

<p><strong>Purge all images and containers:</strong></p>

<p>As in <strong>Stage 1</strong>, we run command <code>docker system prune -a</code> to clear all Docker images and containers and start with a clean slate.</p>

<p><strong>(2.3) Build and run the 'test-webapp-1',  'test-webapp-2', ‘redis’, and ‘nginx’ images with Docker Compose</strong></p>

<p>Build with Docker Compose:</p>

<p><code>C:\test-docker\test-redis>docker-compose -f docker-compose-nginx.yml build</code></p>

<p>Run with Docker Compose:</p>

<p><code>C:\test-docker\test-redis>docker-compose -f docker-compose-nginx.yml up</code></p>

<p>In the command line window where we issue the <code>docker-compose -f docker-compose-nginx.yml up</code> command, <strong>Docker Compose</strong> replies with:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--Ufv9ddaS--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/xi20q9vn6kp7m67olqst.PNG" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--Ufv9ddaS--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/xi20q9vn6kp7m67olqst.PNG" alt="4 containers running" loading="lazy" width="663" height="193"></a></p>

<p>...showing that all 4 Docker containers have started successfully and are up and running: “<em>test-redis_1</em>” corresponds to the <strong><em>Redis</em></strong> process running in “<em>Docker Container 3</em>”, “<em>test-webapp-2_1</em>” corresponds to the <strong>Node.js server</strong> process running in “<em>Docker Container 2</em>”, “<em>test-webapp-1_1</em>” corresponds to the <strong>Node.js server</strong> process running in “<em>Docker Container 1</em>”, and “<em>nginx_1</em>” corresponds to the <strong><em>Nginx</em></strong> server running in “<em>Docker Container 4</em>”.</p>

<p><strong>View the 'test-webapp-1', ‘test-webapp-2’, 'redis', and ‘nginx’ running containers:</strong><br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>C:\test-docker\test-redis>docker ps 
CONTAINER ID   IMAGE                       PORTS       NAMES                                            c675ff6c0464   test-redis_nginx            0.0.0.0:80->80/tcp        test-redis_nginx_1                               
3137d1468ec7   test-redis_test-webapp-2    0.0.0.0:3009->5000/tcp   
test-redis_test-webapp-2_1                       
57d399295421   redis:alpine                                                                         test-redis_test-redis_1                          
b30635f44151   test-redis_test-webapp-1    0.0.0.0:3008->5000/tcp   test-redis_test-webapp-1_1
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>The four containers above match containers “<em>Docker Container 1</em>” through “<em>Docker Container 4</em>” in “<strong>Figure 2.a – Schematic diagram of the components for Stage 2</strong>”<br>
above. Note the “<em>CONTAINER ID</em>” column whose values we will use below to potentially perform operations on each individual running container.</p>

<p>Let’s run first two instances of the browser on the hosting machine, and point them to URL “<strong>localhost:80</strong>”:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--OpVMnmS4--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/42dwmonlt8jn07ifovp0.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--OpVMnmS4--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/42dwmonlt8jn07ifovp0.png" alt="2.3 Browser - test-webapp-2 - number of visits 7" loading="lazy" width="513" height="159"></a></p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--sOWO-DD_--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/d06t4jutlz9c47pd5po8.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--sOWO-DD_--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/d06t4jutlz9c47pd5po8.png" alt="2.3 Browser - test-webapp-1 - number of visits 8" loading="lazy" width="513" height="156"></a></p>

<p>Notice how due to the <strong>round-robin</strong> routing mechanism employed by the <strong><em>Nginx</em></strong> reverse-proxy, the “<em>GET localhost:80</em>” request is routed once to “<em>test-webapp-1</em>” <strong>Node.js server</strong>, and once to the “<em>test-webapp-2</em>” <strong>Node.js server</strong>, achieving the scaling-up and load balancing that we intended to demonstrate. </p>

<p>Let’s connect to the container that is running <strong><em>Redis</em></strong>, to its <strong><em>sh</em></strong> (shell) environment:</p>

<p><code>C:\test-docker\test-redis>docker exec -it 57d399295421 sh</code></p>

<p>Then, inside the container, let’s connect to <strong><em>Redis</em></strong> itself using “<em>redis-cli</em>”:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>/data #
/data # redis-cli
127.0.0.1:6379> 
127.0.0.1:6379> get numVisits
"8"
127.0.0.1:6379>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Note how the <code>get numVisits</code> command in <strong><em>Redis</em></strong> returns the expected value of “number of visits” that is communicated to the “<strong><em>redis</em></strong>” container from the containers that are running the <strong>Node.js app servers</strong>.</p>

<p><strong>Conclusion</strong></p>

<p>In <strong>Stage 2</strong> of this example we showed how <strong>Docker Compose</strong> allows us to easily establish multiple containers with their independent environments that communicate with each other, and also how scaling and load-balancing achieved with Nginx.</p>

<p><strong>Source code:</strong><br>
<a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx">https://github.com/marcelkatz/test-docker-nodejs-redis-nginx</a></p>

</div></article> <div class="aside-username-wrapper" data-v-10d06ee8><aside class="aside-username-block" data-v-37984f8c data-v-10d06ee8><div class="username-heading loading" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-heading" data-v-37984f8c><div class="vue-content-placeholders-heading__img"></div> <div class="vue-content-placeholders-heading__content"><div class="vue-content-placeholders-heading__title"></div> <div class="vue-content-placeholders-heading__subtitle"></div></div></div></div></div> <div class="info" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-text" data-v-37984f8c><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div></div></div></div></aside></div></div> <div class="comments-block" data-v-8c4375bc data-v-10d06ee8><!----> <a href="https://dev.to/marcelkatz/nodejs-and-redis-deployed-in-docker-containers-using-docker-compose-then-load-balancing-the-nodejs-servers-with-nginx-4omc" target="_blank" rel="nofollow noopener noreferer" class="add-comment" data-v-8c4375bc>
    Add comment
  </a></div></div> <footer data-v-22cb8fd0><span data-v-22cb8fd0>Built with</span> <a href="https://nuxtjs.org" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="nuxt-icon" data-v-22cb8fd0 data-v-22cb8fd0><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a> <span data-v-22cb8fd0>&</span> <a href="https://docs.dev.to/api" rel="nofollow noopener" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-22cb8fd0 data-v-22cb8fd0><path d="M1.5726 5.13748C1.42945 5.20622 1.2411 5.36661 1.15822 5.48117C1 5.69503 1 5.74849 1 11.8739C1 17.9993 1 18.0528 1.15822 18.2667C1.2411 18.3812 1.42945 18.5416 1.5726 18.6104C1.8137 18.7402 2.46164 18.7478 12 18.7478C21.5384 18.7478 22.1863 18.7402 22.4274 18.6104C22.5706 18.5416 22.7589 18.3812 22.8418 18.2667C23 18.0528 23 17.9993 23 11.8739C23 5.74849 23 5.69503 22.8418 5.48117C22.7589 5.36661 22.5706 5.20622 22.4274 5.13748C22.1863 5.00764 21.5384 5 12 5C2.46164 5 1.8137 5.00764 1.5726 5.13748ZM7.7055 8.2613C8.0822 8.45989 8.59454 9.0098 8.77536 9.40694C8.89589 9.66664 8.91095 9.94922 8.91095 12.0649C8.91095 14.3104 8.90344 14.4478 8.75275 14.7839C8.51919 15.288 8.16506 15.6546 7.68288 15.899C7.26096 16.1052 7.22328 16.1128 5.7315 16.1358L4.20206 16.1663V12.1031V8.04744L5.80684 8.07035C7.27602 8.09327 7.42672 8.10854 7.7055 8.2613ZM13.6952 8.89521V9.73538H12.4521H11.2089V10.4991V11.2629H11.9623H12.7158V12.1031V12.9432H11.9623H11.2089V13.707V14.4708H12.4521H13.6952V15.3109V16.151H12C10.1315 16.151 10.0411 16.1358 9.67191 15.6928L9.47603 15.4484V12.1336C9.47603 8.46752 9.46851 8.49807 9.95069 8.20783C10.1692 8.07035 10.3425 8.05508 11.9473 8.05508H13.6952V8.89521ZM16.5658 10.3769C16.8897 11.6295 17.1685 12.6912 17.176 12.7293C17.1911 12.7675 17.4699 11.7441 17.8014 10.461C18.1254 9.17017 18.4343 8.1009 18.4795 8.08563C18.5247 8.06271 18.9541 8.06271 19.4288 8.07035L20.3028 8.09327L19.376 11.6219C18.8713 13.5542 18.4117 15.2269 18.3664 15.3261C18.0123 16.0135 17.274 16.3343 16.7164 16.0441C16.4528 15.899 16.0911 15.4865 15.9705 15.1887C15.9254 15.0665 15.4884 13.4549 15.0062 11.6142C14.524 9.76593 14.1171 8.20783 14.0945 8.15437C14.0644 8.07035 14.2301 8.05508 15.0212 8.07035L15.9856 8.09327L16.5658 10.3769Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M5.93491 12.103V14.4707H6.27394C6.66574 14.4707 7.01983 14.3103 7.1404 14.0965C7.18559 14.0048 7.21575 13.2105 7.21575 12.0648V10.1783L6.99725 9.95683C6.80133 9.76591 6.71847 9.73535 6.35683 9.73535H5.93491V12.103Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a></footer></div></div></div><script>window.__NUXT__=function(e,t,n,s,o){return n.type_of="article",n.id=936005,n.title="Node.js and Redis deployed in Docker containers, using Docker Compose - then load-balancing the Node.js servers with Nginx",n.description="This article contains two main stages: (1) Containerizing a Node.js server application and a Redis...",n.readable_publish_date="Dec 24 '21",n.slug="nodejs-and-redis-deployed-in-docker-containers-using-docker-compose-then-load-balancing-the-nodejs-servers-with-nginx-4omc",n.path="/marcelkatz/nodejs-and-redis-deployed-in-docker-containers-using-docker-compose-then-load-balancing-the-nodejs-servers-with-nginx-4omc",n.url=s,n.comments_count=2,n.public_reactions_count=80,n.collection_id=e,n.published_timestamp=o,n.positive_reactions_count=80,n.cover_image=e,n.social_image="https://dev.to/social_previews/article/936005.png",n.canonical_url=s,n.created_at="2021-12-24T21:33:49Z",n.edited_at="2021-12-25T01:03:22Z",n.crossposted_at=e,n.published_at=o,n.last_comment_at="2022-06-04T12:49:17Z",n.reading_time_minutes=13,n.tag_list="docker, node, redis, nginx",n.tags=["docker","node","redis","nginx"],n.body_html='<p>This article contains two main stages:<br>\n<strong>(1) Containerizing a Node.js server application and a Redis database instance into two separate Docker containers, using Dockerfile and Docker Compose, and showing how these two applications communicate with each other.</strong></p>\n\n<p><strong>(2) Load-balancing the Node.js server, using a containerized Nginx reverse-proxy.</strong> </p>\n\n<p><strong>Let’s start with Stage 1:<br>\n(1) Containerizing a Node.js server application and a Redis instance into two separate Docker containers, using Dockerfile and Docker Compose, and showing how these two applications communicate with each other</strong></p>\n\n<p>Starting with a simple <strong>Node.js server</strong> application (we’ll call it “<em>test-webapp</em>”) that responds to an <em>HTTP GET</em> request by displaying the “numbers of visits”. The numbering scheme below (i.e. (1.1), (1.2), (1.3) etc.), matches the numbering in the diagram below:</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--vjd6PFTp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/3yp6moj945jli4n6vfl4.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--vjd6PFTp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/3yp6moj945jli4n6vfl4.png" alt="Figure 1.a – Schematic diagram of the components" loading="lazy" width="624" height="350"></a><br>\n<em>Figure 1.a - Schematic diagram of the components</em></p>\n\n<p>In "<strong>Figure 1.a - Schematic diagram of the components</strong>" above we have the following components:<br>\n(<strong>1.1</strong>) "<em>Docker Container 1</em>" - container running the <strong>Node.js server</strong> called "<em>test-webapp</em>" that communicates with the browser on the left. Each time we refresh the URL <code>localhost:80</code> i.e. we send a <code>GET</code>command to the <strong>Node.js server</strong> "<em>test-webapp</em>", the server code increments the number of visits, then saves this value into the <strong><em>Redis</em></strong> database instance that runs on "<em>Docker Container 2</em>", and also displays the value back in the browser.</p>\n\n<p>(<strong>1.2</strong>) “<em>Dockerfile</em>” - defines and controls the <strong>Node.js server</strong> process in “<em>Docker Container 1</em>”. </p>\n\n<p>(<strong>1.3</strong>, <strong>1.3.1</strong>, <strong>1.3.2</strong>) “<em><a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/docker-compose.yml">docker-compose.yml</a></em>” – the <strong>Docker Compose</strong> config file defines and controls both “<em>Docker Container 1</em>” and “<em>Docker Container 2</em>”. “<em>Docker Container 1</em>” runs the <strong>Node.js server</strong> process “<em>test-webap_p”. “_Docker Container 2</em>” runs the <strong><em>Redis</em></strong> database instance.</p>\n\n<p>(<strong>1.3.3</strong>) <strong>Docker Compose</strong> establishes by default a communication network between “<em>Docker Container 1</em>” and “<em>Docker Container 2</em>” which allow the <strong>Node.js server</strong> process “<em>test-webapp</em>” to communicate with the <strong><em>Redis</em></strong> database instance, and exchange between them the “number of visits to the app/web server” (<code>numVisits</code>) value.</p>\n\n<p>(<strong>1.3.4</strong>) <strong>Docker Compose</strong> maps local hosting machine Port 80 to “<em>Docker Container 1</em>” Port 5000. Port 5000 is the port on which the <strong>Node.js server</strong> “<em>test-webapp</em>” listens and reacts to the <code>GET</code>commands sent by the browser.</p>\n\n<p>(<strong>1.4</strong>) Connecting to the shell of “<em>Docker Container 2</em>” and then to the client command line of the <strong><em>Redis</em></strong> database instance via “<code>redis-cli</code>” we can see that the value of <code>numVisits</code> (which represents the number of times the browser issued a <code>GET</code>command to the <strong>Node.js server</strong>) is in sync with the value displayed in the browser by the <strong>Node.js server</strong> – thus showing that inter-process communication occurs between the processes “<em>test-webapp</em>” in “<em>Docker Container 1</em>” and the <strong><em>Redis</em></strong> process in “<em>Docker Container 2</em>”.</p>\n\n<p>(<strong>1.5</strong>) This step illustrates the <code>restart</code> directive and capability in <strong>Docker Compose</strong> (specified in config file “<em>docker-compose.yml</em>”) – when connecting to the Linux shell of “<em>Docker Container 1</em>”, we can <code>kill -9</code> the <strong>Node.js server</strong> process, but the <strong>Node.js server</strong> process will be restarted automatically by <strong>Docker Compose</strong> – illustrating the automatic recovery provided by <strong>Docker Compose</strong>.</p>\n\n<p>And now let’s describe the steps and the flow of this scenario. The numbering scheme in the description below (i.e. (1.1), (1.2), (1.3) etc.), matches the numbering in “<strong>Figure 1.a – Schematic diagram of the components</strong>”.</p>\n\n<p><strong>(1.1) File structure:</strong></p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--_yC5myBq--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/rm92ysovtnnq9azlunop.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--_yC5myBq--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/rm92ysovtnnq9azlunop.png" alt="Figure 1.b – File structure for Stage 1" loading="lazy" width="864" height="688"></a><br>\n<em>Figure 1.b – File structure for Stage 1</em></p>\n\n<p><strong>Node.js files for process ‘test-webapp’:</strong></p>\n\n<p>The contents of directory “<em>test-webapp</em>”, where the source code for the <strong>Node.js server</strong> “<em>test-webapp</em>” resides:</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--bSempo81--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jqed4cw6m1mpm1upws9m.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--bSempo81--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jqed4cw6m1mpm1upws9m.png" alt="Node.js files for process \'test-webapp\'" loading="lazy" width="165" height="164"></a></p>\n\n<p>(<strong>1.2</strong>) The <em>Dockerfile _containerizes and controls the <strong>Node.js application</strong> by downloading the “_node:alpine</em>” image from <a href="https://hub.docker.com/">Docker Hub</a>, installing <strong>Node.js</strong> on the container, copying to the container the <a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/tree/main/test-webapp">source files</a> – then launching the <strong>Node.js server</strong> web app (see source code in file “<a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/test-webapp/server.js"><em>server.js</em></a>”).</p>\n\n<p>(<strong>1.3</strong>) Going one directory above, we see the "<em><a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/docker-compose.yml">docker-compose.yml</a></em>" file that organizes the containerization and sets up the architecture of all the components. (File <br>\n“<em><a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/docker-compose-nginx.yml">docker-composer-nginx.yml</a></em>” will be presented and explained in <strong>Stage 2</strong> of this article)</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--naPa4IgZ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/tqtlkv6v7vams8x3xq9d.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--naPa4IgZ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/tqtlkv6v7vams8x3xq9d.png" alt="\'docker-compose.yml\' file for process \'test-webapp\'" loading="lazy" width="312" height="88"></a></p>\n\n<p><strong>Purge all images and containers:</strong></p>\n\n<p>We run command <code>docker system prune -a</code> to clear all Docker images and containers and start with a clean slate.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>C:\\test-docker\\test-redis&gt;docker system prune -a                                          \nWARNING! This will remove:                                                                                                \n- all stopped containers                                                                                                \n- all networks not used by at least one container                                                                       \n- all images without at least one container associated to them                                                          \n- all build cache                                                                                                                                                                                                                             \nAre you sure you want to continue? [y/N] y\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p><strong>(1.3) Build and run the \'test-webapp\' image with Docker Compose</strong></p>\n\n<p>Use command <code>docker-compose -f &lt;config-filename&gt; build</code> to build containers and the applications that will be running in each container:</p>\n\n<p><code>C:\\test-docker\\test-redis&gt;docker-compose -f docker-compose.yml build</code></p>\n\n<p>See the results below of the built Docker image:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>C:\\test-docker\\test-redis&gt;docker images                                                                                                                     \nREPOSITORY               TAG       IMAGE ID       CREATED         SIZE                                                                                                                     \ntest-redis_test-webapp   latest    e8145bea0fec   4 minutes ago   175MB\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p><strong>Run the \'test-webapp\' and \'redis\' containers with \'docker-compose\':</strong></p>\n\n<p>Let’s launch both “<em>test-webapp</em>” and “<em>redis</em>” services, as described in config file <br>\n“<em><a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/docker-compose.yml">docker-compose.yml</a></em>”, using the <code>docker-compose -f &lt;config-filename&gt; up</code> command.</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--7d3NTR5i--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/66ukw6kmm4djhk2nzxsa.PNG" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--7d3NTR5i--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/66ukw6kmm4djhk2nzxsa.PNG" alt="docker-compose -f docker-compose.yml up" loading="lazy" width="634" height="233"></a></p>\n\n<p>We can see from the output above, that both the “<em>redis</em>” container (“<em>test-redis_1</em>” – corresponding to “<em>Docker Container 2</em>” in <strong>Figure 1.a</strong>) and the “<em>test-webapp</em>” container (“<em>test-webapp_1</em>” corresponding to “<em>Docker Container 1</em>” in <strong>Figure 1.a</strong>) are running and printing to stdout in the command line window where we launched <strong>Docker Compose</strong> to run these two containers.</p>\n\n<p><strong>View the \'test-webapp\' and \'redis\' running containers:</strong><br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>C:\\test-docker\\test-redis\\test-webapp&gt;docker ps                                                                                        \nCONTAINER ID   IMAGE                    PORTS                \nNAMES                                         \n928b8b07415d   test-redis_test-webapp   0.0.0.0:80-&gt;5000/tcp   test-redis_test-webapp_1                      \na8756127bff5   redis:alpine             6379/tcp               test-redis_test-redis_1\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>(<strong>1.3.1</strong>, <strong>1.3.2</strong>) The two containers above match the containers “<em>Docker Container 1</em>” and “<em>Docker Container 2</em>” in the <strong>Figure 1.a</strong> above. Note the “<em>CONTAINER ID</em>” column whose values we will use below to perform operation on each individual running container. </p>\n\n<p>(<strong>1.3.4</strong>) Port 5000 in the <strong>Node.js server</strong> "<em>test-webapp</em>" container is mapped to local (hosting) Port 80, so when one connects in the local (hosting) browser to URL <strong><a href="http://localhost:80">http://localhost:80</a></strong>, for each refresh, the <strong>Node.js process</strong> in the “<em>test-webapp</em>” container increments the number of visits in variable <code>numVisits</code> which is set and saved in the <strong><em>Redis</em></strong> in variable <code>numVisits</code> -- and this value is also send back and displayed in the browser. </p>\n\n<p>“Docker-compose” sets-up by default a network with both “<em>test-webapp</em>” container (“<em>Docker Container 1</em>” in <strong>Figure 1.a</strong>) and “<em>redis</em>” container (“<em>Docker Container 2</em>” in <strong>Figure 1.a</strong>) within this network, and both containers are reachable by each other via this network. </p>\n\n<p>The local browser communicates with the <strong>Node.js server</strong> container. When refreshing the connection in the browser, the server callback is invoked which responds to the browser with the updated number of visits.</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--BKBbVg8w--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/euscx0msi6am2kz9tk7j.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--BKBbVg8w--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/euscx0msi6am2kz9tk7j.png" alt="1.3.4 Browser - localhost - number of visits 8" loading="lazy" width="419" height="170"></a></p>\n\n<p>(<strong>1.4</strong>) We are using the <code>docker exec -it</code> command that allows us to connect to a running container while the <code>-it</code> option allows us to capture the stdin/stdout of that container. Then we specify the CONTAINER ID <em>a8756127bff5</em> obtained from <code>docker ps</code> command above, followed by the shell (<strong><em>sh</em></strong>) that we want to launch as we enter the container. </p>\n\n<p><code>C:\\test-redis\\test-webapp&gt;docker exec -it a8756127bff5 sh</code></p>\n\n<p>Then, once we are inside the container’s shell, we connect to the <strong><em>Redis</em></strong> database using the <code>redis-cli</code> command. At the <strong><em>Redis</em></strong> prompt we use <code>get numVisits</code> to obtain the value of the variable “<strong>numVisits</strong>” inside “<em>redis</em>”. We can see that the “<em>redis</em>” instance communicates with the “<em>test-webapp</em>” process in its respective container and the variable “<em>numVisits</em>” in the <strong><em>Redis</em></strong> database instance is in sync with its value in the browser. In this case both have the value “<strong>8</strong>”, because we refreshed 8 times the “<strong>localhost:80</strong>” URL thus issuing a <code>GET</code> command in the browser that is intercepted by the *<em>Node.js server *</em> which increments the “number of visits” (<code>numVisits</code>) variable. The “number of visits” value is sent back to the browser by the “<em>test-webapp</em>” process which also saves the value in the “<em>redis</em>” database in variable <code>numVisits</code>).<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>/data # redis-cli                                                                                                                                                     \n127.0.0.1:6379&gt; get numVisits                                                                                                                                      \n"8"                                                                                                                                                                    \n127.0.0.1:6379&gt; \n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>From within the “<em>redis-cli</em>” in the “<em>redis</em>” container (“<em>Docker Container 2</em>”) we can also set in <strong><em>Redis</em></strong> manually the “<em>numVisits</em>” variable to a random value of let’s say “<strong>342</strong>”…</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--5mFZNh5z--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/3snsztp8x4gcgco7t7ec.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--5mFZNh5z--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/3snsztp8x4gcgco7t7ec.png" alt="1.4 - redis - set num visits 342" loading="lazy" width="407" height="91"></a></p>\n\n<p>…the <code>numVisits</code> variable is updated in the “test-webapp” <strong>Node.js server</strong> (running in “<em>Docker Container 1</em>”), and therefore in the browser (due to the fact that in order to invoke the <em>callback</em> in the <strong><a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/test-webapp/server.js">Node.js server</a></strong>, one needs to refresh the connection to “<strong>localhost:80</strong>”, the number of visits increases by <strong>1</strong>, thus <strong>342</strong> + 1 = <strong>343</strong>. This shows that we have two-way inter-process communications between the processes running in “<em>Docker Container 1</em>” and “<em>Docker Container 2</em>”.</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--FNra9-r7--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/oapryvdzrnppyzztuxfn.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--FNra9-r7--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/oapryvdzrnppyzztuxfn.png" alt="1.4 Browser - localhost - number of visits 343" loading="lazy" width="435" height="191"></a></p>\n\n<p>(<strong>1.5</strong>) A useful feature provided by <strong>Docker Compose</strong> is the capability to specify in “<em>docker-compose.yml</em>” a “<a href="https://docs.docker.com/config/containers/start-containers-automatically/#use-a-restart-policy">restart</a>” option. <br>\nThis will allow us when connecting to the shell of “<em>Docker Container 1</em>”, to “kill” the <strong>Node.js server</strong> process, but the <strong>Node.js server</strong> process will be restarted automatically by the <strong>Docker Compose</strong> “<em>restart</em>” directive.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>C:\\test-docker\\test-redis&gt;docker ps\nCONTAINER ID   IMAGE                      PORTS                    NAMES\nc675ff6c0464   test-redis_nginx           0.0.0.0:80-&gt;80/tcp       test-redis_nginx_1\n3137d1468ec7   test-redis_test-webapp-2   0.0.0.0:3009-&gt;5000/tcp   test-redis_test-webapp-2_1 \n57d399295421   redis:alpine                                        test-redis_test-redis_1\nb30635f44151   test-redis_test-webapp-1   0.0.0.0:3008-&gt;5000/tcp   test-redis_test-webapp-1_1\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Connect to the Docker container whose ID is <em>928b8b07415d</em> and invoke the shell (<strong><em>sh</em></strong>). </p>\n\n<p><code>C:\\test-redis\\test-webapp&gt;docker exec -it 928b8b07415d sh</code></p>\n\n<p>Inside the container, at the shell prompt, show all process id’s using <code>ps -al</code>.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>/usr/src/app # ps -al\nPID   USER     TIME  COMMAND\n1     root     0:00  npm start\n19    root     0:00  node server.js\n30    root     0:00  sh\n36    root     0:00  ps -al\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Proceed with “killing” the “<em>node server.js</em>” process by issuing a <code>kill -9 &lt;process-id&gt;</code> command:</p>\n\n<p><code>/usr/src/app # kill -9 19</code></p>\n\n<p>In the command line window that is running <strong>Docker Compose</strong> we can see how the “<em>test-webapp</em>” receives a “kill signal” (<code>SIGKILL</code>), exited with code ‘<strong>1</strong>’, and then restarted automatically.</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--PyOXsmV8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7m25v5kmnu9zlbobgqgf.PNG" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--PyOXsmV8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7m25v5kmnu9zlbobgqgf.PNG" alt="npm ERR command sh -c node server.js" loading="lazy" width="604" height="136"></a></p>\n\n<p><strong>Conclusion</strong></p>\n\n<p>In <strong>Stage 1</strong> of this example we showed how <strong>Docker Compose</strong> allows us to easily establish independent environments that communicate with each other, and also the automatic fault-tolerance (restart on failure) capability of Docker Compose.</p>\n\n<p><strong>Let’s continue with Stage 2:<br>\n(2) Load-balancing the Node.js server, with the help of a containerized Nginx reverse-proxy</strong></p>\n\n<p>The diagram in “<strong>Figure 2.a – Schematic diagram of the components for Stage 2</strong>” describes an architecture similar to the one described earlier in “<strong>Figure 1.a – Schematic diagram of the components</strong>” but with the changes described below.</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--dW6tGtNm--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/02s6wkco89eaeu00ezxu.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--dW6tGtNm--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/02s6wkco89eaeu00ezxu.png" alt="Figure 2.a – Schematic diagram of the components for Stage 2" loading="lazy" width="856" height="484"></a><br>\n<em>Figure 2.a – Schematic diagram of the components for Stage 2</em></p>\n\n<p>In “<strong>Figure 2.a – Schematic diagram of the components for Stage 2</strong>” we have the following components:</p>\n\n<p>(<strong>2.1.1</strong>, <strong>2.1.2</strong>) “<em>Docker Container 1</em>” and “<em>Docker Container 2</em>” – two identical containers whose source code reside in directories “<em><a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/tree/main/test-webapp-1">test-webapp-1</a></em>” and “<em><a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/tree/main/test-webapp-2">test-webapp-2</a></em>” (as shown in “<strong>Figure 2.b – File structure for Stage 2</strong>” below), that are almost identical copies of the application “<em>test-webapp</em>” that was described earlier in <strong>Stage 1</strong>. This time we are using two <strong>Node.js server</strong> processes that will serve the client browser from the local host machine, scaling up and load-balancing the original one-server configuration from <strong>Stage 1</strong>. These two containers are defined and controlled each by their respective “<em>Dockerfile</em>” (<strong>2.1.1.1</strong>) and (<strong>2.1.1.2</strong>). Each <strong>Node.js server</strong> “<em>Docker Container 1</em>” and “<em>Docker Container 2</em>” counts the number of visits coming from the local host browser. Then it saves the number of visits into the <strong><em>Redis</em></strong> database, and it also responds back to the browser with the number of visits and with which specific <strong>Node.js server</strong> served each individual <em>HTTP GET</em> request coming from the browser, by sending back to the browser a message of type: <br>\n“<strong>test-webapp-1</strong>: Number of visits is: ”, or <br>\n“<strong>test-webapp-2</strong>: Number of visits is: ”<br>\n…thus highlighting the load-leveling nature of this stage.</p>\n\n<p>(<strong>2.1.3</strong>) “Docker Container 3” – the container running the <strong><em>Redis</em></strong> database instance, identical to the one described in <strong>Stage 1</strong>, storing the “number of visits” performed by the localhost machine browser to “<strong>localhost:80</strong>”. The number of visits is stored by the <strong>Node.js server</strong> processes “<em>test-webapp-1</em>” and “<em>test-webapp-2</em>” in the <strong><em>Redis</em></strong> variable <code>numVisits</code> whose value is transmitted by each <strong>Node.js server</strong> to the <strong><em>Redis</em></strong> database on each refresh on the local host browser.</p>\n\n<p>(<strong>2.2</strong>) “<em><a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/docker-compose-nginx.yml">docker-compose-nginx.yml</a></em>” – the main <strong>Docker Compose</strong> config file defines and controls: (I) “<em>Docker Container 1</em>” running <strong>Node.js server</strong> “<em>test-webapp-1</em>”,  (II) “<em>Docker Container 2</em>” running <strong>Node.js server</strong> “<em>test-webapp-2</em>”, (III) “<em>Docker Container 3</em>” running <strong><em>Redis</em></strong>, and (IV) “<em>Docker Container 4</em>” running <strong><em>Nginx</em></strong>.</p>\n\n<p>(<strong>2.3</strong>) “<em>Docker Container 4</em>” running “<em>Nginx</em>” – This is an additional container introduced in <strong>Stage 2</strong>, defined and controlled by its own <em>Dockerfile</em> (<strong>2.3.1</strong>), that runs an “<em>nginx</em>” instance, and acts a as reverse-proxy that routes the <em>HTTP GET</em> requests coming from the local host browser. The “<strong><em>Nginx</em></strong>” process in “<em>Docker Container 4</em>” routes the <em>HTTP GET</em> requests coming from local host browser “<strong>localhost:80</strong>”, in a <strong>round-robin</strong> manner (<strong>(2.3.3)</strong> and <strong>(2.3.4)</strong>), to either the “<em>test-webapp-1</em>” <strong>Node.js server</strong> in “<em>Docker Container 1</em>” or to “<em>test-webapp-2</em>” <strong>Node.js</strong> server in “<em>Docker Container 2</em>”. The “<strong><em>nginx</em></strong>” process in “<em>Docker Container 4</em>” is defined and controlled by the <strong>_Nginx _</strong>config file “<em><a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/nginx/nginx.conf">nginx.conf</a></em>” which is copied by <strong><em>Nginx</em></strong> container’s <em>Dockerfile</em> to the “<em>Docker Container 4</em>” environment file “<em>/etc/nginx/conf.d./<strong>default.conf</strong></em>” (this is a standard <strong><em>Nginx</em></strong> setup). The “<em>nginx</em>” instance distributes the incoming traffic from the local host browser, thus scaling up and load- balancing the single-container web/app server architecture presented in <strong>Stage 1</strong>. </p>\n\n<p>And now let’s describe the steps and the flow of this scenario. The numbering scheme in the description below (i.e. (2.1), (2.2), (2.3) etc.), matches the numbering in “<strong>Figure 2.a – Schematic diagram of the components for Stage 2</strong>”.</p>\n\n<p><strong>(2.1) File structure:</strong></p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--5AOs-x2p--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/8v7qndptehh545sknesh.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--5AOs-x2p--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/8v7qndptehh545sknesh.png" alt="Figure 2.b – File structure for Stage 2" loading="lazy" width="864" height="684"></a></p>\n\n<p>The file structure described in “<strong>Figure 2.b – File structure for Stage 2</strong>” is almost identical to the files structure described earlier in “<strong>Figure 1.b – File structure for Stage 1</strong>” with the following changes:</p>\n\n<p>(<strong>2.1.1</strong>, <strong>2.1.2</strong>) The files from directory “<em>test-webapp</em>” from <strong>Stage 1</strong> were copied into directories “<em>test-webapp-1</em>” and “<em>test-webapp-2</em>”.</p>\n\n<p>(<strong>2.2</strong>) Going one directory above, we see the "<em><a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/docker-compose-nginx.yml">docker-compose-nginx.yml</a></em>" config file that organizes the containerization and sets up the architecture of all the components:</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--A8ZD3MU4--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/23ztsgagx0fthaktnn3n.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--A8ZD3MU4--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/23ztsgagx0fthaktnn3n.png" alt="\'docker-compose-nginx.yml\' file" loading="lazy" width="293" height="106"></a></p>\n\n<p><strong>Purge all images and containers:</strong></p>\n\n<p>As in <strong>Stage 1</strong>, we run command <code>docker system prune -a</code> to clear all Docker images and containers and start with a clean slate.</p>\n\n<p><strong>(2.3) Build and run the \'test-webapp-1\',  \'test-webapp-2\', ‘redis’, and ‘nginx’ images with Docker Compose</strong></p>\n\n<p>Build with Docker Compose:</p>\n\n<p><code>C:\\test-docker\\test-redis&gt;docker-compose -f docker-compose-nginx.yml build</code></p>\n\n<p>Run with Docker Compose:</p>\n\n<p><code>C:\\test-docker\\test-redis&gt;docker-compose -f docker-compose-nginx.yml up</code></p>\n\n<p>In the command line window where we issue the <code>docker-compose -f docker-compose-nginx.yml up</code> command, <strong>Docker Compose</strong> replies with:</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--Ufv9ddaS--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/xi20q9vn6kp7m67olqst.PNG" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--Ufv9ddaS--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/xi20q9vn6kp7m67olqst.PNG" alt="4 containers running" loading="lazy" width="663" height="193"></a></p>\n\n<p>...showing that all 4 Docker containers have started successfully and are up and running: “<em>test-redis_1</em>” corresponds to the <strong><em>Redis</em></strong> process running in “<em>Docker Container 3</em>”, “<em>test-webapp-2_1</em>” corresponds to the <strong>Node.js server</strong> process running in “<em>Docker Container 2</em>”, “<em>test-webapp-1_1</em>” corresponds to the <strong>Node.js server</strong> process running in “<em>Docker Container 1</em>”, and “<em>nginx_1</em>” corresponds to the <strong><em>Nginx</em></strong> server running in “<em>Docker Container 4</em>”.</p>\n\n<p><strong>View the \'test-webapp-1\', ‘test-webapp-2’, \'redis\', and ‘nginx’ running containers:</strong><br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>C:\\test-docker\\test-redis&gt;docker ps \nCONTAINER ID   IMAGE                       PORTS       NAMES                                            c675ff6c0464   test-redis_nginx            0.0.0.0:80-&gt;80/tcp        test-redis_nginx_1                               \n3137d1468ec7   test-redis_test-webapp-2    0.0.0.0:3009-&gt;5000/tcp   \ntest-redis_test-webapp-2_1                       \n57d399295421   redis:alpine                                                                         test-redis_test-redis_1                          \nb30635f44151   test-redis_test-webapp-1    0.0.0.0:3008-&gt;5000/tcp   test-redis_test-webapp-1_1\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>The four containers above match containers “<em>Docker Container 1</em>” through “<em>Docker Container 4</em>” in “<strong>Figure 2.a – Schematic diagram of the components for Stage 2</strong>”<br>\nabove. Note the “<em>CONTAINER ID</em>” column whose values we will use below to potentially perform operations on each individual running container.</p>\n\n<p>Let’s run first two instances of the browser on the hosting machine, and point them to URL “<strong>localhost:80</strong>”:</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--OpVMnmS4--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/42dwmonlt8jn07ifovp0.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--OpVMnmS4--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/42dwmonlt8jn07ifovp0.png" alt="2.3 Browser - test-webapp-2 - number of visits 7" loading="lazy" width="513" height="159"></a></p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--sOWO-DD_--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/d06t4jutlz9c47pd5po8.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--sOWO-DD_--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/d06t4jutlz9c47pd5po8.png" alt="2.3 Browser - test-webapp-1 - number of visits 8" loading="lazy" width="513" height="156"></a></p>\n\n<p>Notice how due to the <strong>round-robin</strong> routing mechanism employed by the <strong><em>Nginx</em></strong> reverse-proxy, the “<em>GET localhost:80</em>” request is routed once to “<em>test-webapp-1</em>” <strong>Node.js server</strong>, and once to the “<em>test-webapp-2</em>” <strong>Node.js server</strong>, achieving the scaling-up and load balancing that we intended to demonstrate. </p>\n\n<p>Let’s connect to the container that is running <strong><em>Redis</em></strong>, to its <strong><em>sh</em></strong> (shell) environment:</p>\n\n<p><code>C:\\test-docker\\test-redis&gt;docker exec -it 57d399295421 sh</code></p>\n\n<p>Then, inside the container, let’s connect to <strong><em>Redis</em></strong> itself using “<em>redis-cli</em>”:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>/data #\n/data # redis-cli\n127.0.0.1:6379&gt; \n127.0.0.1:6379&gt; get numVisits\n"8"\n127.0.0.1:6379&gt;\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Note how the <code>get numVisits</code> command in <strong><em>Redis</em></strong> returns the expected value of “number of visits” that is communicated to the “<strong><em>redis</em></strong>” container from the containers that are running the <strong>Node.js app servers</strong>.</p>\n\n<p><strong>Conclusion</strong></p>\n\n<p>In <strong>Stage 2</strong> of this example we showed how <strong>Docker Compose</strong> allows us to easily establish multiple containers with their independent environments that communicate with each other, and also how scaling and load-balancing achieved with Nginx.</p>\n\n<p><strong>Source code:</strong><br>\n<a href="https://github.com/marcelkatz/test-docker-nodejs-redis-nginx">https://github.com/marcelkatz/test-docker-nodejs-redis-nginx</a></p>\n\n',n.body_markdown="This article contains two main stages:\n**(1) Containerizing a Node.js server application and a Redis database instance into two separate Docker containers, using Dockerfile and Docker Compose, and showing how these two applications communicate with each other.**\n\n**(2) Load-balancing the Node.js server, using a containerized Nginx reverse-proxy.** \n\n**Let’s start with Stage 1:\n(1) Containerizing a Node.js server application and a Redis instance into two separate Docker containers, using Dockerfile and Docker Compose, and showing how these two applications communicate with each other**\n\nStarting with a simple **Node.js server** application (we’ll call it “_test-webapp_”) that responds to an _HTTP GET_ request by displaying the “numbers of visits”. The numbering scheme below (i.e. (1.1), (1.2), (1.3) etc.), matches the numbering in the diagram below:\n\n\n![Figure 1.a – Schematic diagram of the components](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/3yp6moj945jli4n6vfl4.png)\n_Figure 1.a - Schematic diagram of the components_\n\nIn \"**Figure 1.a - Schematic diagram of the components**\" above we have the following components:\n(**1.1**) \"_Docker Container 1_\" - container running the **Node.js server** called \"_test-webapp_\" that communicates with the browser on the left. Each time we refresh the URL `localhost:80` i.e. we send a `GET `command to the **Node.js server** \"_test-webapp_\", the server code increments the number of visits, then saves this value into the **_Redis_** database instance that runs on \"_Docker Container 2_\", and also displays the value back in the browser.\n\n(**1.2**) “_Dockerfile_” - defines and controls the **Node.js server** process in “_Docker Container 1_”. \n\n(**1.3**, **1.3.1**, **1.3.2**) “_[docker-compose.yml](https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/docker-compose.yml)_” – the **Docker Compose** config file defines and controls both “_Docker Container 1_” and “_Docker Container 2_”. “_Docker Container 1_” runs the **Node.js server** process “_test-webap_p”. “_Docker Container 2_” runs the **_Redis_** database instance.\n\n(**1.3.3**) **Docker Compose** establishes by default a communication network between “_Docker Container 1_” and “_Docker Container 2_” which allow the **Node.js server** process “_test-webapp_” to communicate with the **_Redis_** database instance, and exchange between them the “number of visits to the app/web server” (`numVisits`) value.\n\n(**1.3.4**) **Docker Compose** maps local hosting machine Port 80 to “_Docker Container 1_” Port 5000. Port 5000 is the port on which the **Node.js server** “_test-webapp_” listens and reacts to the `GET `commands sent by the browser.\n\n(**1.4**) Connecting to the shell of “_Docker Container 2_” and then to the client command line of the **_Redis_** database instance via “`redis-cli`” we can see that the value of `numVisits` (which represents the number of times the browser issued a `GET `command to the **Node.js server**) is in sync with the value displayed in the browser by the **Node.js server** – thus showing that inter-process communication occurs between the processes “_test-webapp_” in “_Docker Container 1_” and the **_Redis_** process in “_Docker Container 2_”.\n\n(**1.5**) This step illustrates the `restart` directive and capability in **Docker Compose** (specified in config file “_docker-compose.yml_”) – when connecting to the Linux shell of “_Docker Container 1_”, we can `kill -9` the **Node.js server** process, but the **Node.js server** process will be restarted automatically by **Docker Compose** – illustrating the automatic recovery provided by **Docker Compose**.\n\nAnd now let’s describe the steps and the flow of this scenario. The numbering scheme in the description below (i.e. (1.1), (1.2), (1.3) etc.), matches the numbering in “**Figure 1.a – Schematic diagram of the components**”.\n\n**(1.1) File structure:**\n\n![Figure 1.b – File structure for Stage 1](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/rm92ysovtnnq9azlunop.png)\n_Figure 1.b – File structure for Stage 1_\n\n**Node.js files for process ‘test-webapp’:**\n\nThe contents of directory “_test-webapp_”, where the source code for the **Node.js server** “_test-webapp_” resides:\n\n![Node.js files for process 'test-webapp'](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jqed4cw6m1mpm1upws9m.png)\n\n(**1.2**) The _Dockerfile _containerizes and controls the **Node.js application** by downloading the “_node:alpine_” image from [Docker Hub](https://hub.docker.com/), installing **Node.js** on the container, copying to the container the [source files](https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/tree/main/test-webapp) – then launching the **Node.js server** web app (see source code in file “[_server.js_](https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/test-webapp/server.js)”).\n\n(**1.3**) Going one directory above, we see the \"_[docker-compose.yml](https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/docker-compose.yml)_\" file that organizes the containerization and sets up the architecture of all the components. (File \n“_[docker-composer-nginx.yml](https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/docker-compose-nginx.yml)_” will be presented and explained in **Stage 2** of this article)\n\n!['docker-compose.yml' file for process 'test-webapp'](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/tqtlkv6v7vams8x3xq9d.png)\n\n**Purge all images and containers:**\n\nWe run command `docker system prune -a` to clear all Docker images and containers and start with a clean slate.\n\n```\nC:\\test-docker\\test-redis>docker system prune -a                                          \nWARNING! This will remove:                                                                                                \n- all stopped containers                                                                                                \n- all networks not used by at least one container                                                                       \n- all images without at least one container associated to them                                                          \n- all build cache                                                                                                                                                                                                                             \nAre you sure you want to continue? [y/N] y\n```\n\n**(1.3) Build and run the 'test-webapp' image with Docker Compose**\n\nUse command `docker-compose -f <config-filename> build` to build containers and the applications that will be running in each container:\n\n`C:\\test-docker\\test-redis>docker-compose -f docker-compose.yml build`\n\nSee the results below of the built Docker image:\n\n```\nC:\\test-docker\\test-redis>docker images                                                                                                                     \nREPOSITORY               TAG       IMAGE ID       CREATED         SIZE                                                                                                                     \ntest-redis_test-webapp   latest    e8145bea0fec   4 minutes ago   175MB\n```\n\n**Run the 'test-webapp' and 'redis' containers with 'docker-compose':**\n\nLet’s launch both “_test-webapp_” and “_redis_” services, as described in config file \n“_[docker-compose.yml](https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/docker-compose.yml)_”, using the `docker-compose -f <config-filename> up` command.\n\n![docker-compose -f docker-compose.yml up](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/66ukw6kmm4djhk2nzxsa.PNG)\n\nWe can see from the output above, that both the “_redis_” container (“_test-redis_1_” – corresponding to “_Docker Container 2_” in **Figure 1.a**) and the “_test-webapp_” container (“_test-webapp_1_” corresponding to “_Docker Container 1_” in **Figure 1.a**) are running and printing to stdout in the command line window where we launched **Docker Compose** to run these two containers.\n\n**View the 'test-webapp' and 'redis' running containers:**\n\n\n```\nC:\\test-docker\\test-redis\\test-webapp>docker ps                                                                                        \nCONTAINER ID   IMAGE                    PORTS                \nNAMES                                         \n928b8b07415d   test-redis_test-webapp   0.0.0.0:80->5000/tcp   test-redis_test-webapp_1                      \na8756127bff5   redis:alpine             6379/tcp               test-redis_test-redis_1\n```\n\n(**1.3.1**, **1.3.2**) The two containers above match the containers “_Docker Container 1_” and “_Docker Container 2_” in the **Figure 1.a** above. Note the “_CONTAINER ID_” column whose values we will use below to perform operation on each individual running container. \n\n(**1.3.4**) Port 5000 in the **Node.js server** \"_test-webapp_\" container is mapped to local (hosting) Port 80, so when one connects in the local (hosting) browser to URL **http://localhost:80**, for each refresh, the **Node.js process** in the “_test-webapp_” container increments the number of visits in variable `numVisits` which is set and saved in the **_Redis_** in variable `numVisits` -- and this value is also send back and displayed in the browser. \n\n“Docker-compose” sets-up by default a network with both “_test-webapp_” container (“_Docker Container 1_” in **Figure 1.a**) and “_redis_” container (“_Docker Container 2_” in **Figure 1.a**) within this network, and both containers are reachable by each other via this network. \n\nThe local browser communicates with the **Node.js server** container. When refreshing the connection in the browser, the server callback is invoked which responds to the browser with the updated number of visits.\n\n![1.3.4 Browser - localhost - number of visits 8](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/euscx0msi6am2kz9tk7j.png)\n\n(**1.4**) We are using the `docker exec -it` command that allows us to connect to a running container while the `-it` option allows us to capture the stdin/stdout of that container. Then we specify the CONTAINER ID _a8756127bff5_ obtained from `docker ps` command above, followed by the shell (**_sh_**) that we want to launch as we enter the container. \n\n`C:\\test-redis\\test-webapp>docker exec -it a8756127bff5 sh`\n\nThen, once we are inside the container’s shell, we connect to the **_Redis_** database using the `redis-cli` command. At the **_Redis_** prompt we use `get numVisits` to obtain the value of the variable “**numVisits**” inside “_redis_”. We can see that the “_redis_” instance communicates with the “_test-webapp_” process in its respective container and the variable “_numVisits_” in the **_Redis_** database instance is in sync with its value in the browser. In this case both have the value “**8**”, because we refreshed 8 times the “**localhost:80**” URL thus issuing a `GET` command in the browser that is intercepted by the **Node.js server ** which increments the “number of visits” (`numVisits`) variable. The “number of visits” value is sent back to the browser by the “_test-webapp_” process which also saves the value in the “_redis_” database in variable `numVisits`).\n\n```\n/data # redis-cli                                                                                                                                                     \n127.0.0.1:6379> get numVisits                                                                                                                                      \n\"8\"                                                                                                                                                                    \n127.0.0.1:6379> \n```\n\nFrom within the “_redis-cli_” in the “_redis_” container (“_Docker Container 2_”) we can also set in **_Redis_** manually the “_numVisits_” variable to a random value of let’s say “**342**”…\n\n![1.4 - redis - set num visits 342](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/3snsztp8x4gcgco7t7ec.png)\n\n…the `numVisits` variable is updated in the “test-webapp” **Node.js server** (running in “_Docker Container 1_”), and therefore in the browser (due to the fact that in order to invoke the _callback_ in the **[Node.js server](https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/test-webapp/server.js)**, one needs to refresh the connection to “**localhost:80**”, the number of visits increases by **1**, thus **342** + 1 = **343**. This shows that we have two-way inter-process communications between the processes running in “_Docker Container 1_” and “_Docker Container 2_”.\n\n![1.4 Browser - localhost - number of visits 343](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/oapryvdzrnppyzztuxfn.png)\n\n(**1.5**) A useful feature provided by **Docker Compose** is the capability to specify in “_docker-compose.yml_” a “[restart](https://docs.docker.com/config/containers/start-containers-automatically/#use-a-restart-policy)” option. \nThis will allow us when connecting to the shell of “_Docker Container 1_”, to “kill” the **Node.js server** process, but the **Node.js server** process will be restarted automatically by the **Docker Compose** “_restart_” directive.\n\n```\nC:\\test-docker\\test-redis>docker ps\nCONTAINER ID   IMAGE                      PORTS                    NAMES\nc675ff6c0464   test-redis_nginx           0.0.0.0:80->80/tcp       test-redis_nginx_1\n3137d1468ec7   test-redis_test-webapp-2   0.0.0.0:3009->5000/tcp   test-redis_test-webapp-2_1 \n57d399295421   redis:alpine                                        test-redis_test-redis_1\nb30635f44151   test-redis_test-webapp-1   0.0.0.0:3008->5000/tcp   test-redis_test-webapp-1_1\n```\n\nConnect to the Docker container whose ID is _928b8b07415d_ and invoke the shell (**_sh_**). \n\n`C:\\test-redis\\test-webapp>docker exec -it 928b8b07415d sh`\n\nInside the container, at the shell prompt, show all process id’s using `ps -al`.\n\n```\n/usr/src/app # ps -al\nPID   USER     TIME  COMMAND\n1     root     0:00  npm start\n19    root     0:00  node server.js\n30    root     0:00  sh\n36    root     0:00  ps -al\n```\n\nProceed with “killing” the “_node server.js_” process by issuing a `kill -9 <process-id>` command:\n\n`/usr/src/app # kill -9 19`\n      \nIn the command line window that is running **Docker Compose** we can see how the “_test-webapp_” receives a “kill signal” (`SIGKILL`), exited with code ‘**1**’, and then restarted automatically.\n\n![npm ERR command sh -c node server.js](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7m25v5kmnu9zlbobgqgf.PNG)\n\n**Conclusion**\n\nIn **Stage 1** of this example we showed how **Docker Compose** allows us to easily establish independent environments that communicate with each other, and also the automatic fault-tolerance (restart on failure) capability of Docker Compose.\n\n**Let’s continue with Stage 2:\n(2) Load-balancing the Node.js server, with the help of a containerized Nginx reverse-proxy**\n\nThe diagram in “**Figure 2.a – Schematic diagram of the components for Stage 2**” describes an architecture similar to the one described earlier in “**Figure 1.a – Schematic diagram of the components**” but with the changes described below.\n\n\n![Figure 2.a – Schematic diagram of the components for Stage 2](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/02s6wkco89eaeu00ezxu.png)\n_Figure 2.a – Schematic diagram of the components for Stage 2_\n\nIn “**Figure 2.a – Schematic diagram of the components for Stage 2**” we have the following components:\n\n(**2.1.1**, **2.1.2**) “_Docker Container 1_” and “_Docker Container 2_” – two identical containers whose source code reside in directories “_[test-webapp-1](https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/tree/main/test-webapp-1)_” and “_[test-webapp-2](https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/tree/main/test-webapp-2)_” (as shown in “**Figure 2.b – File structure for Stage 2**” below), that are almost identical copies of the application “_test-webapp_” that was described earlier in **Stage 1**. This time we are using two **Node.js server** processes that will serve the client browser from the local host machine, scaling up and load-balancing the original one-server configuration from **Stage 1**. These two containers are defined and controlled each by their respective “_Dockerfile_” (**2.1.1.1**) and (**2.1.1.2**). Each **Node.js server** “_Docker Container 1_” and “_Docker Container 2_” counts the number of visits coming from the local host browser. Then it saves the number of visits into the **_Redis_** database, and it also responds back to the browser with the number of visits and with which specific **Node.js server** served each individual _HTTP GET_ request coming from the browser, by sending back to the browser a message of type: \n“**test-webapp-1**: Number of visits is: <numVisits>”, or \n“**test-webapp-2**: Number of visits is: <numVisits>”\n…thus highlighting the load-leveling nature of this stage.\n\n(**2.1.3**) “Docker Container 3” – the container running the **_Redis_** database instance, identical to the one described in **Stage 1**, storing the “number of visits” performed by the localhost machine browser to “**localhost:80**”. The number of visits is stored by the **Node.js server** processes “_test-webapp-1_” and “_test-webapp-2_” in the **_Redis_** variable `numVisits` whose value is transmitted by each **Node.js server** to the **_Redis_** database on each refresh on the local host browser.\n\n(**2.2**) “_[docker-compose-nginx.yml](https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/docker-compose-nginx.yml)_” – the main **Docker Compose** config file defines and controls: (I) “_Docker Container 1_” running **Node.js server** “_test-webapp-1_”,  (II) “_Docker Container 2_” running **Node.js server** “_test-webapp-2_”, (III) “_Docker Container 3_” running **_Redis_**, and (IV) “_Docker Container 4_” running **_Nginx_**.\n\n(**2.3**) “_Docker Container 4_” running “_Nginx_” – This is an additional container introduced in **Stage 2**, defined and controlled by its own _Dockerfile_ (**2.3.1**), that runs an “_nginx_” instance, and acts a as reverse-proxy that routes the _HTTP GET_ requests coming from the local host browser. The “**_Nginx_**” process in “_Docker Container 4_” routes the _HTTP GET_ requests coming from local host browser “**localhost:80**”, in a **round-robin** manner (**(2.3.3)** and **(2.3.4)**), to either the “_test-webapp-1_” **Node.js server** in “_Docker Container 1_” or to “_test-webapp-2_” **Node.js** server in “_Docker Container 2_”. The “**_nginx_**” process in “_Docker Container 4_” is defined and controlled by the **_Nginx _**config file “_[nginx.conf](https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/nginx/nginx.conf)_” which is copied by **_Nginx_** container’s _Dockerfile_ to the “_Docker Container 4_” environment file “_/etc/nginx/conf.d./**default.conf**_” (this is a standard **_Nginx_** setup). The “_nginx_” instance distributes the incoming traffic from the local host browser, thus scaling up and load- balancing the single-container web/app server architecture presented in **Stage 1**. \n\nAnd now let’s describe the steps and the flow of this scenario. The numbering scheme in the description below (i.e. (2.1), (2.2), (2.3) etc.), matches the numbering in “**Figure 2.a – Schematic diagram of the components for Stage 2**”.\n\n**(2.1) File structure:**\n\n![Figure 2.b – File structure for Stage 2](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/8v7qndptehh545sknesh.png)\n\nThe file structure described in “**Figure 2.b – File structure for Stage 2**” is almost identical to the files structure described earlier in “**Figure 1.b – File structure for Stage 1**” with the following changes:\n\n(**2.1.1**, **2.1.2**) The files from directory “_test-webapp_” from **Stage 1** were copied into directories “_test-webapp-1_” and “_test-webapp-2_”.\n\n(**2.2**) Going one directory above, we see the \"_[docker-compose-nginx.yml](https://github.com/marcelkatz/test-docker-nodejs-redis-nginx/blob/main/docker-compose-nginx.yml)_\" config file that organizes the containerization and sets up the architecture of all the components:\n\n!['docker-compose-nginx.yml' file](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/23ztsgagx0fthaktnn3n.png)\n\n**Purge all images and containers:**\n\nAs in **Stage 1**, we run command `docker system prune -a` to clear all Docker images and containers and start with a clean slate.\n\n**(2.3) Build and run the 'test-webapp-1',  'test-webapp-2', ‘redis’, and ‘nginx’ images with Docker Compose**\n\nBuild with Docker Compose:\n\n`C:\\test-docker\\test-redis>docker-compose -f docker-compose-nginx.yml build`\n\nRun with Docker Compose:\n\n`C:\\test-docker\\test-redis>docker-compose -f docker-compose-nginx.yml up`\n\nIn the command line window where we issue the `docker-compose -f docker-compose-nginx.yml up` command, **Docker Compose** replies with:\n\n![4 containers running](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/xi20q9vn6kp7m67olqst.PNG)\n\n...showing that all 4 Docker containers have started successfully and are up and running: “_test-redis_1_” corresponds to the **_Redis_** process running in “_Docker Container 3_”, “_test-webapp-2_1_” corresponds to the **Node.js server** process running in “_Docker Container 2_”, “_test-webapp-1_1_” corresponds to the **Node.js server** process running in “_Docker Container 1_”, and “_nginx_1_” corresponds to the **_Nginx_** server running in “_Docker Container 4_”.\n\n**View the 'test-webapp-1', ‘test-webapp-2’, 'redis', and ‘nginx’ running containers:**\n\n```\nC:\\test-docker\\test-redis>docker ps \nCONTAINER ID   IMAGE                       PORTS       NAMES                                            c675ff6c0464   test-redis_nginx            0.0.0.0:80->80/tcp        test-redis_nginx_1                               \n3137d1468ec7   test-redis_test-webapp-2    0.0.0.0:3009->5000/tcp   \ntest-redis_test-webapp-2_1                       \n57d399295421   redis:alpine                                                                         test-redis_test-redis_1                          \nb30635f44151   test-redis_test-webapp-1    0.0.0.0:3008->5000/tcp   test-redis_test-webapp-1_1\n```\n\nThe four containers above match containers “_Docker Container 1_” through “_Docker Container 4_” in “**Figure 2.a – Schematic diagram of the components for Stage 2**”\nabove. Note the “_CONTAINER ID_” column whose values we will use below to potentially perform operations on each individual running container.\n\nLet’s run first two instances of the browser on the hosting machine, and point them to URL “**localhost:80**”:\n\n![2.3 Browser - test-webapp-2 - number of visits 7](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/42dwmonlt8jn07ifovp0.png)\n\n![2.3 Browser - test-webapp-1 - number of visits 8](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/d06t4jutlz9c47pd5po8.png)\n\nNotice how due to the **round-robin** routing mechanism employed by the **_Nginx_** reverse-proxy, the “_GET localhost:80_” request is routed once to “_test-webapp-1_” **Node.js server**, and once to the “_test-webapp-2_” **Node.js server**, achieving the scaling-up and load balancing that we intended to demonstrate. \n\nLet’s connect to the container that is running **_Redis_**, to its **_sh_** (shell) environment:\n\n`C:\\test-docker\\test-redis>docker exec -it 57d399295421 sh  `\n\nThen, inside the container, let’s connect to **_Redis_** itself using “_redis-cli_”:\n\n```\n/data #\n/data # redis-cli\n127.0.0.1:6379> \n127.0.0.1:6379> get numVisits\n\"8\"\n127.0.0.1:6379>\n```\n\nNote how the `get numVisits` command in **_Redis_** returns the expected value of “number of visits” that is communicated to the “**_redis_**” container from the containers that are running the **Node.js app servers**.\n\n**Conclusion**\n\nIn **Stage 2** of this example we showed how **Docker Compose** allows us to easily establish multiple containers with their independent environments that communicate with each other, and also how scaling and load-balancing achieved with Nginx.\n\n**Source code:**\n[https://github.com/marcelkatz/test-docker-nodejs-redis-nginx](https://github.com/marcelkatz/test-docker-nodejs-redis-nginx)\n\n\n",n.user={name:t,username:t,twitter_username:e,github_username:t,website_url:e,profile_image:"https://res.cloudinary.com/practicaldev/image/fetch/s--Z3LKnN_4--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/461728/b3eaafc7-959c-4def-8b52-aec2c44ec1f5.JPG",profile_image_90:"https://res.cloudinary.com/practicaldev/image/fetch/s--vB-tPos5--/c_fill,f_auto,fl_progressive,h_90,q_auto,w_90/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/461728/b3eaafc7-959c-4def-8b52-aec2c44ec1f5.JPG"},{layout:"default",data:[{}],fetch:{"data-v-70afb46a:0":{article:n}},error:e,state:{currentArticle:n},serverRendered:!0,routePath:"/marcelkatz/936005",config:{_app:{basePath:"/nuxtstop/",assetsPath:"/nuxtstop/_nuxt/",cdnURL:e}}}}(null,"marcelkatz",{},"https://dev.to/marcelkatz/nodejs-and-redis-deployed-in-docker-containers-using-docker-compose-then-load-balancing-the-nodejs-servers-with-nginx-4omc","2021-12-24T21:35:16Z")</script><script src="/nuxtstop/_nuxt/f6e87fb.js" defer></script><script src="/nuxtstop/_nuxt/dc9ce94.js" defer></script><script src="/nuxtstop/_nuxt/6474719.js" defer></script><script src="/nuxtstop/_nuxt/9b75090.js" defer></script><script src="/nuxtstop/_nuxt/18df600.js" defer></script>
  </body>
</html>
