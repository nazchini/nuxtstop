<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Midtrans and Laravel 8 Integration Using Snap: Part 2</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="Using Nuxt.js fetch() hook to build dev.to with a new look"><meta data-n-head="ssr" name="format-detection" content="telephone=no"><base href="/nuxtstop/"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,500,600&display=swap"><link rel="preload" href="/nuxtstop/_nuxt/f6e87fb.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/6474719.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/9b75090.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/18df600.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/dc9ce94.js" as="script"><style data-vue-ssr-id="c650fd98:0 af4684f0:0 a9c71758:0 dcafa518:0 4b9cec49:0 b093d766:0 9d98bcb4:0 6b6a11ea:0 0248ed80:0 ea8e4264:0">html{box-sizing:border-box;font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}*,:after,:before{box-sizing:inherit}html{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}*,:after,:before{border:0 solid #e0e0e0}blockquote,body,dd,dl,figure,h1,h2,h3,h4,h5,h6,p,pre{margin:0}button{background:0 0;padding:0}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}hr{border-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:inherit;opacity:.5}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:inherit;opacity:.5}input::placeholder,textarea::placeholder{color:inherit;opacity:.5}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit;font-family:sans-serif}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit;font-family:inherit;font-size:100%}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;overflow:auto;word-break:break-word;white-space:normal}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}html{height:100%;font-size:18px;-ms-overflow-style:scrollbar;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}@media(min-width:640px){html{font-size:20px}}body{height:100%;min-width:320px;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:400;line-height:1.5;color:#000;background-color:#eff4f7;-webkit-text-rendering:optimizeLegibility;text-rendering:optimizeLegibility;font-synthesis:none;font-kerning:normal;font-feature-settings:"normal","kern";-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-overflow-scrolling:touch;overflow-x:hidden;overflow-y:scroll}h1,h2,h3,h4,h5,h6{color:#000;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:600;font-feature-settings:"normal";line-height:1.2}pre{background:#29292e;border-radius:2px;overflow:auto;padding:1rem;color:#eff1f9;line-height:1.42em;font-size:13px}@media screen and (min-width:380px){pre{font-size:15px}}pre code{background:#29292e;color:#eff0f9;white-space:pre}div.highlight pre.highlight code{font-size:inherit;padding:0}div.inner-comment div.body div.highlight pre.highlight{background:#29292e}div.inner-comment div.body div.highlight pre.highlight code{font-size:inherit;white-space:inherit;background:inherit;color:inherit}.highlight .hll{background-color:#49483e}.highlight{background:#29292e;color:#f8f8f2}.highlight .c{color:grey}.highlight .err{text-shadow:0 0 7px #f9690e}.highlight .k{color:#f39c12}.highlight .l{color:plum}.highlight .n{color:#f8f8f2}.highlight .o{color:#f9690e}.highlight .p{color:#f8f8f2}.highlight .c1,.highlight .ch,.highlight .cm,.highlight .cp,.highlight .cpf,.highlight .cs{color:grey}.highlight .gd{color:#f9690e}.highlight .ge{font-style:italic}.highlight .gi{color:#7ed07e}.highlight .gs{font-weight:700}.highlight .gu{color:grey}.highlight .kc,.highlight .kd{color:#f39c12}.highlight .kn{color:#f9690e}.highlight .kp,.highlight .kr,.highlight .kt{color:#f39c12}.highlight .ld{color:#f2ca27}.highlight .m{color:plum}.highlight .s{color:#f2ca27}.highlight .na{color:#7ed07e}.highlight .nb{color:#f8f8f2}.highlight .nc{color:#7ed07e}.highlight .no{color:#f39c12}.highlight .nd{color:#7ed07e}.highlight .ni{color:#f8f8f2}.highlight .ne,.highlight .nf{color:#7ed07e}.highlight .nl,.highlight .nn{color:#f8f8f2}.highlight .nx{color:#7ed07e}.highlight .py{color:#f8f8f2}.highlight .nt{color:#f9690e}.highlight .nv{color:#f8f8f2}.highlight .ow{color:#f9690e}.highlight .w{color:#f8f8f2}.highlight .mb,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo{color:plum}.highlight .dl,.highlight .s2,.highlight .sa,.highlight .sb,.highlight .sc,.highlight .sd{color:#f2ca27}.highlight .se{color:plum}.highlight .s1,.highlight .sh,.highlight .si,.highlight .sr,.highlight .ss,.highlight .sx{color:#f2ca27}.highlight .bp{color:#f8f8f2}.highlight .fm{color:#7ed07e}.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{color:#f8f8f2}.highlight .il{color:plum}.vue-content-placeholders-heading__img,.vue-content-placeholders-heading__subtitle,.vue-content-placeholders-heading__title,.vue-content-placeholders-img,.vue-content-placeholders-text__line{background:#bfcdec!important}.vue-content-placeholders-is-animated .vue-content-placeholders-heading__img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__subtitle:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__title:before,.vue-content-placeholders-is-animated .vue-content-placeholders-img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-text__line:before{background:linear-gradient(90deg,transparent 0,#d3ddf9 15%,transparent 30%)!important}header[data-v-27046cca]{max-width:1280px;margin:auto;padding:1rem;height:6rem;border-bottom:1px solid rgba(0,0,0,.2)}header .logo-wrapper[data-v-27046cca],header[data-v-27046cca]{display:flex;align-items:center;justify-content:space-between}header .logo-wrapper[data-v-27046cca]{margin:0 .5rem}header .logo-wrapper svg[data-v-27046cca]{width:3rem;height:100%}header .logo-wrapper .name-wrapper[data-v-27046cca]{margin-left:.6em}header .logo-wrapper .name-wrapper .subtitle[data-v-27046cca]{font-size:1rem}header .logo-wrapper .name-wrapper .app-name[data-v-27046cca]{font-weight:700;font-size:2.25rem;line-height:1.25}header nav[data-v-27046cca]{letter-spacing:-.025rem;font-weight:600;text-transform:uppercase}header nav ul[data-v-27046cca]{display:flex}header nav ul li[data-v-27046cca]{margin:0 .5rem}header nav ul li a[data-v-27046cca]{box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;padding:.25rem 1rem;border-radius:.5rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}header nav ul li a[data-v-27046cca]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header nav ul li a.nuxt-link-exact-active[data-v-27046cca]{cursor:default}header nav ul li a.nuxt-link-exact-active[data-v-27046cca],header nav ul li a[data-v-27046cca]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}.page-wrapper[data-v-10d06ee8]{max-width:1280px;margin:auto;padding:1rem}.article-content-wrapper[data-v-10d06ee8]{display:flex;flex-direction:column;align-items:center;margin:auto auto 2rem}@media(min-width:1024px){.article-content-wrapper[data-v-10d06ee8]{align-items:normal;flex-direction:row}}.article-content-wrapper .article-block[data-v-10d06ee8]{width:100%;max-width:880px}@media(min-width:1024px){.article-content-wrapper .article-block[data-v-10d06ee8]{margin-right:1rem;width:66.66666%;margin-bottom:2rem}}.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{max-width:880px;width:100%;position:relative}@media(min-width:1024px){.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{display:block;width:33.33333%}}.article-content-wrapper .aside-username-wrapper .aside-username-block[data-v-10d06ee8]{position:-webkit-sticky;position:sticky;top:1rem}@media(min-width:1280px){.comments-block[data-v-10d06ee8]{margin:.5rem}}article[data-v-70afb46a]{padding:.5rem;border-radius:1rem}header h1[data-v-70afb46a],header[data-v-70afb46a]{margin-bottom:1rem}header h1[data-v-70afb46a]{font-size:2.25rem;letter-spacing:-.025rem}header .tags[data-v-70afb46a]{display:flex;flex-wrap:wrap;margin-bottom:1.5rem}header .tags .tag[data-v-70afb46a]{font-weight:500;line-height:1;padding:.5rem;margin:0 .5rem .5rem 0;border-radius:.25rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db}header .tags .tag[data-v-70afb46a]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header .tags .tag[data-v-70afb46a]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}header .image-wrapper[data-v-70afb46a]{position:relative;padding-bottom:56.25%;background-color:#d4dfe8;margin-bottom:1.5rem;border-radius:.5rem;overflow:hidden}@media(min-width:834px){header .image-wrapper[data-v-70afb46a]{margin-bottom:1.5rem}}header .image-wrapper img[data-v-70afb46a]{position:absolute;top:0;left:0;width:100%;height:100%;-o-object-fit:cover;object-fit:cover}header .meta[data-v-70afb46a]{line-height:1;font-size:.875rem;text-transform:uppercase;font-weight:500;letter-spacing:-.025rem;display:flex;align-items:center;justify-content:space-between}header .meta .scl[data-v-70afb46a]{display:flex}header .meta .scl span[data-v-70afb46a]{display:flex;align-items:center;margin-right:1rem}header .meta .scl span svg[data-v-70afb46a]{margin-right:.25rem}header .meta .scl .comments[data-v-70afb46a]{cursor:pointer}[data-v-70afb46a] .content .ltag__user{display:none}[data-v-70afb46a] .content iframe{max-width:100%}[data-v-70afb46a] .content h1{font-size:1.875rem}[data-v-70afb46a] .content h1,[data-v-70afb46a] .content h2{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h2{font-size:1.5rem}[data-v-70afb46a] .content h3{font-size:1.25rem}[data-v-70afb46a] .content h3,[data-v-70afb46a] .content h4{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h4{font-size:1rem}[data-v-70afb46a] .content a{color:#6e87d2}[data-v-70afb46a] .content p{margin-bottom:1rem;line-height:1.4}[data-v-70afb46a] .content p code{background-color:#d2f3e1;border-radius:.25rem;padding:.25rem}[data-v-70afb46a] .content img{width:100%;border-radius:.5rem}[data-v-70afb46a] .content .highlight{margin-bottom:1rem;border-radius:.5rem}[data-v-70afb46a] .content ul{list-style:numeral;margin-bottom:1rem}[data-v-70afb46a] .content ul li p{margin-bottom:0}[data-v-70afb46a] .content ol{margin-bottom:1rem}aside[data-v-37984f8c]{padding:1rem;background-color:#dfe8ef;border-radius:1rem}aside .username-heading[data-v-37984f8c]{display:flex;margin-bottom:1rem}aside .username-heading[data-v-37984f8c]:hover{color:#6e87d2}aside .username-heading img[data-v-37984f8c]{width:3rem;height:3rem;border-radius:50%;margin-right:1rem}aside .username-heading .text[data-v-37984f8c]{display:flex;flex-direction:column;justify-content:center}aside .username-heading .text a[data-v-37984f8c]{line-height:1}aside .username-heading .text a[data-v-37984f8c]:first-child{font-size:1.25rem;font-weight:500;letter-spacing:-.025rem;margin-bottom:.25rem}aside .username-heading .text a[data-v-37984f8c]:last-child{color:#999;font-size:.875rem}aside .username-heading.loading[data-v-37984f8c]{display:block}aside .f-button[data-v-37984f8c]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}aside .f-button[data-v-37984f8c]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}aside .f-button[data-v-37984f8c]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}aside .info>div[data-v-37984f8c]{margin-bottom:.5rem}aside .info .title[data-v-37984f8c]{font-size:.666666rem;letter-spacing:-.0125rem;font-weight:500;color:#999;text-transform:uppercase;margin-bottom:.1rem}aside .info .content[data-v-37984f8c]{font-size:.875rem;line-height:1.4}.add-comment[data-v-8c4375bc]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}.add-comment[data-v-8c4375bc]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}.add-comment[data-v-8c4375bc]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}footer[data-v-22cb8fd0]{padding:2rem;text-align:center;display:flex;align-items:center;justify-content:center}footer span[data-v-22cb8fd0]{display:inline-block;line-height:1;text-transform:uppercase;letter-spacing:-.025rem;font-size:.75rem;font-weight:500}footer a svg[data-v-22cb8fd0]{width:3rem;height:3rem;margin:0 .5rem}footer a .nuxt-icon[data-v-22cb8fd0]{width:2.5rem;height:2.5rem;margin:0 .25rem}</style>
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><div id="__layout"><div><header data-v-27046cca><a href="/nuxtstop/" class="logo-wrapper nuxt-link-active" data-v-27046cca><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-27046cca><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-27046cca></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-27046cca></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-27046cca></path></svg> <div class="name-wrapper" data-v-27046cca><span class="app-name" data-v-27046cca>Nuxtstop</span> <p class="subtitle" data-v-27046cca>For all things nuxt.js</p></div></a> <nav data-v-27046cca><ul data-v-27046cca><li data-v-27046cca><a href="/nuxtstop/" class="nuxt-link-active" data-v-27046cca>
          New
        </a></li><li data-v-27046cca><a href="/nuxtstop/top" data-v-27046cca>
          Top
        </a></li></ul></nav></header> <div class="page-wrapper" data-v-10d06ee8><div class="article-content-wrapper" data-v-10d06ee8><article data-fetch-key="data-v-70afb46a:0" class="article-block" data-v-70afb46a data-v-10d06ee8><header data-v-70afb46a><h1 data-v-70afb46a>Midtrans and Laravel 8 Integration Using Snap: Part 2</h1> <div class="tags" data-v-70afb46a><a href="/nuxtstop/t/midtrans" class="tag" data-v-70afb46a>
          #midtrans
        </a><a href="/nuxtstop/t/payment" class="tag" data-v-70afb46a>
          #payment
        </a><a href="/nuxtstop/t/gateway" class="tag" data-v-70afb46a>
          #gateway
        </a></div> <div class="image-wrapper" data-v-70afb46a><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--YogmxZDK--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/o3mkegnb2wsoexfesegs.jpg" alt="Midtrans and Laravel 8 Integration Using Snap: Part 2" data-v-70afb46a></div> <div class="meta" data-v-70afb46a><div class="scl" data-v-70afb46a><span data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M16.4444 3C14.6733 3 13.0333 3.94162 12 5.34C10.9667 3.94162 9.32667 3 7.55556 3C4.49222 3 2 5.52338 2 8.625C2 14.8024 11.0267 20.586 11.4122 20.829C11.5922 20.9426 11.7956 21 12 21C12.2044 21 12.4078 20.9426 12.5878 20.829C12.9733 20.586 22 14.8024 22 8.625C22 5.52338 19.5078 3 16.4444 3Z" fill="#FF0000" data-v-70afb46a data-v-70afb46a></path></svg>
            7
          </span> <span class="comments" data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M6.11765 22H4.94118L5.64706 21.05C6.11765 20.3969 6.41176 19.5656 6.58824 18.5563C3.64706 17.1906 2 14.6375 2 11.3125C2 6.20625 5.82353 3 12 3C18.1765 3 22 6.20625 22 11.3125C22 16.5375 18.2353 19.625 12 19.625H11.5882C10.6471 20.7531 9 22 6.11765 22ZM12 4.1875C6.47059 4.1875 3.17647 6.85937 3.17647 11.3125C3.17647 15.1125 5.47059 16.8938 7.41177 17.6656L7.82353 17.8437L7.76471 18.3187C7.64706 19.2687 7.47059 20.1 7.11765 20.8125C9.05882 20.575 10.1765 19.5656 10.8235 18.7344L11 18.4969H12C19.9412 18.4969 20.8235 13.5094 20.8235 11.3719C20.8235 6.85938 17.5294 4.1875 12 4.1875Z" fill="black" data-v-70afb46a data-v-70afb46a></path></svg>
            0
          </span></div> <time data-v-70afb46a>Jun 1</time></div></header> <div class="content" data-v-70afb46a><p>Before continuing reading, please read part 1: <a href="https://dev.to/martinms/integrate-midtrans-in-laravel-with-snap-api-part-1-18g8">Integration of Midtrans and Laravel 8 Using Snap: Part 1</a></p>

<p>In part 1, we have successfully integrated the Midtrans payment interface using Snap. Until there, customers can make payments through the various payment channels available. In this post, we will continue to create payment callbacks.</p>

<p>What are callbacks? In part 1, the customer is able to make a payment. For example using a virtual account. After the customer has made a successful payment, Midtrans will send a notification to our website that the customer has made a payment. Or, if the customer does not make a payment within the specified time limit, Midtrans will send a notification that the transaction has expired. Our job, is to receive the notification and process the notification.</p>

<p>For example, after the customer has successfully paid, we will receive a successful notification. From the notification, we can change the payment status of the order from previously <strong>waiting for payment</strong> to <strong>already paid</strong>. With this system, there is no need to manually confirm and change the payment status.</p>

<h2>
  <a name="create-a-service-class" href="#create-a-service-class">
  </a>
  Create a Service Class
</h2>

<p>Sama seperti sebelumnya, logic utama akan kita pisahkan di service layer. Sebelumnya, kita sudah membuat file <code>Midtrans.php</code>, <code>CreateSnapTokenService.php</code> dan <code>CallbackService.php</code>, untuk callback akan kita tulis di file <code>CallbackService.php</code><br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight php"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">App\Services\Midtrans</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">App\Models\Order</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Services\Midtrans\Midtrans</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Midtrans\Notification</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">CallbackService</span> <span class="kd">extends</span> <span class="nc">Midtrans</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$notification</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$order</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$serverKey</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="nf">__construct</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-></span><span class="n">serverKey</span> <span class="o">=</span> <span class="nf">config</span><span class="p">(</span><span class="s1">'midtrans.server_key'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-></span><span class="nf">_handleNotification</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">isSignatureKeyVerified</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-></span><span class="nf">_createLocalSignatureKey</span><span class="p">()</span> <span class="o">==</span> <span class="nv">$this</span><span class="o">-></span><span class="n">notification</span><span class="o">-></span><span class="n">signature_key</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">isSuccess</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$statusCode</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-></span><span class="n">notification</span><span class="o">-></span><span class="n">status_code</span><span class="p">;</span>
        <span class="nv">$transactionStatus</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-></span><span class="n">notification</span><span class="o">-></span><span class="n">transaction_status</span><span class="p">;</span>
        <span class="nv">$fraudStatus</span> <span class="o">=</span> <span class="o">!</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-></span><span class="n">notification</span><span class="o">-></span><span class="n">fraud_status</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-></span><span class="n">notification</span><span class="o">-></span><span class="n">fraud_status</span> <span class="o">==</span> <span class="s1">'accept'</span><span class="p">)</span> <span class="o">:</span> <span class="kc">true</span><span class="p">;</span>

        <span class="k">return</span> <span class="p">(</span><span class="nv">$statusCode</span> <span class="o">==</span> <span class="mi">200</span> <span class="o">&&</span> <span class="nv">$fraudStatus</span> <span class="o">&&</span> <span class="p">(</span><span class="nv">$transactionStatus</span> <span class="o">==</span> <span class="s1">'capture'</span> <span class="o">||</span> <span class="nv">$transactionStatus</span> <span class="o">==</span> <span class="s1">'settlement'</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">isExpire</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-></span><span class="n">notification</span><span class="o">-></span><span class="n">transaction_status</span> <span class="o">==</span> <span class="s1">'expire'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">isCancelled</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-></span><span class="n">notification</span><span class="o">-></span><span class="n">transaction_status</span> <span class="o">==</span> <span class="s1">'cancel'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">getNotification</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-></span><span class="n">notification</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">getOrder</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-></span><span class="n">order</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="n">_createLocalSignatureKey</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$orderId</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-></span><span class="n">order</span><span class="o">-></span><span class="n">number</span><span class="p">;</span>
        <span class="nv">$statusCode</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-></span><span class="n">notification</span><span class="o">-></span><span class="n">status_code</span><span class="p">;</span>
        <span class="nv">$grossAmount</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-></span><span class="n">order</span><span class="o">-></span><span class="n">total_price</span><span class="p">;</span>
        <span class="nv">$serverKey</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-></span><span class="n">serverKey</span><span class="p">;</span>
        <span class="nv">$input</span> <span class="o">=</span> <span class="nv">$orderId</span> <span class="mf">.</span> <span class="nv">$statusCode</span> <span class="mf">.</span> <span class="nv">$grossAmount</span> <span class="mf">.</span> <span class="nv">$serverKey</span><span class="p">;</span>
        <span class="nv">$signature</span> <span class="o">=</span> <span class="nb">openssl_digest</span><span class="p">(</span><span class="nv">$input</span><span class="p">,</span> <span class="s1">'sha512'</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$signature</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="n">_handleNotification</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$notification</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Notification</span><span class="p">();</span>

        <span class="nv">$orderNumber</span> <span class="o">=</span> <span class="nv">$notification</span><span class="o">-></span><span class="n">order_id</span><span class="p">;</span>
        <span class="nv">$order</span> <span class="o">=</span> <span class="nc">Order</span><span class="o">::</span><span class="nf">where</span><span class="p">(</span><span class="s1">'number'</span><span class="p">,</span> <span class="nv">$orderNumber</span><span class="p">)</span><span class="o">-></span><span class="nf">first</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-></span><span class="n">notification</span> <span class="o">=</span> <span class="nv">$notification</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-></span><span class="n">order</span> <span class="o">=</span> <span class="nv">$order</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>In that service, we capture the notification sent by Midtrans with the <code>_handleNotification()</code> method, then the notification result will be processed again. Here we also need to create a local signature key. This key is a local key so that notifications can be received. When sending notifications, Midtrans will also send a signature key, the key will be compared with the local signature key to verify whether the request is valid or not.</p>

<h2>
  <a name="creating-a-callback-controller" href="#creating-a-callback-controller">
  </a>
  Creating a Callback Controller
</h2>

<p>To receive notifications, we will create a custom controller named <code>PaymentCallbackController</code>. In the terminal, type the following command:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight shell"><code>php artisan make:controller PaymentCallbackController
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Then write the following code on the controller earlier.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight php"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">App\Http\Controllers</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">App\Models\Order</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Illuminate\Http\Request</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Services\Midtrans\CallbackService</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">PaymentCallbackController</span> <span class="kd">extends</span> <span class="nc">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">receive</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$callback</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CallbackService</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$callback</span><span class="o">-></span><span class="nf">isSignatureKeyVerified</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$notification</span> <span class="o">=</span> <span class="nv">$callback</span><span class="o">-></span><span class="nf">getNotification</span><span class="p">();</span>
            <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$callback</span><span class="o">-></span><span class="nf">getOrder</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span><span class="nv">$callback</span><span class="o">-></span><span class="nf">isSuccess</span><span class="p">())</span> <span class="p">{</span>
                <span class="nc">Order</span><span class="o">::</span><span class="nf">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="nv">$order</span><span class="o">-></span><span class="n">id</span><span class="p">)</span><span class="o">-></span><span class="nf">update</span><span class="p">([</span>
                    <span class="s1">'payment_status'</span> <span class="o">=></span> <span class="mi">2</span><span class="p">,</span>
                <span class="p">]);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nv">$callback</span><span class="o">-></span><span class="nf">isExpire</span><span class="p">())</span> <span class="p">{</span>
                <span class="nc">Order</span><span class="o">::</span><span class="nf">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="nv">$order</span><span class="o">-></span><span class="n">id</span><span class="p">)</span><span class="o">-></span><span class="nf">update</span><span class="p">([</span>
                    <span class="s1">'payment_status'</span> <span class="o">=></span> <span class="mi">3</span><span class="p">,</span>
                <span class="p">]);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nv">$callback</span><span class="o">-></span><span class="nf">isCancelled</span><span class="p">())</span> <span class="p">{</span>
                <span class="nc">Order</span><span class="o">::</span><span class="nf">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="nv">$order</span><span class="o">-></span><span class="n">id</span><span class="p">)</span><span class="o">-></span><span class="nf">update</span><span class="p">([</span>
                    <span class="s1">'payment_status'</span> <span class="o">=></span> <span class="mi">4</span><span class="p">,</span>
                <span class="p">]);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nf">response</span><span class="p">()</span>
                <span class="o">-></span><span class="nf">json</span><span class="p">([</span>
                    <span class="s1">'success'</span> <span class="o">=></span> <span class="kc">true</span><span class="p">,</span>
                    <span class="s1">'message'</span> <span class="o">=></span> <span class="s1">'Notification successfully processed'</span><span class="p">,</span>
                <span class="p">]);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">response</span><span class="p">()</span>
                <span class="o">-></span><span class="nf">json</span><span class="p">([</span>
                    <span class="s1">'error'</span> <span class="o">=></span> <span class="kc">true</span><span class="p">,</span>
                    <span class="s1">'message'</span> <span class="o">=></span> <span class="s1">'Signature key not verified'</span><span class="p">,</span>
                <span class="p">],</span> <span class="mi">403</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>In this controller, we have to check whether the signature key is verified or not. Furthermore, in the service callback we have 3 methods, namely <code>isSuccess()</code> to check whether the transaction was successful, <code>isExpire()</code> to check whether the transaction has expired, <code>isCancelled()</code> to check whether the transaction was aborted. If successful, then update order status data to 2 (already paid), if expired, update order status data to 3 (expired), and if expired then update order status data to 3. You can also add other logic as needed.</p>

<blockquote>
<p><strong>Safety note</strong><br>
The program flow that I created is quite safe to use. Even if anyone knows the callback URL, that person will not be able to "shoot" it directly, because it needs to include an authentication header in the form of a signature key which is a combination of Order ID, status code, overall price and server key. So, don't let anyone know your Midtrans servey key.</p>
</blockquote>

<h2>
  <a name="creating-routes" href="#creating-routes">
  </a>
  Creating Routes
</h2>

<p>After creating the controller, we have to create a new route. Later Midtrans will send a post request to that route. In the <code>web.php</code> route, add the following route.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight php"><code><span class="kn">use</span> <span class="nc">App\Http\Controllers\PaymentCallbackController</span><span class="p">;</span>

<span class="nc">Route</span><span class="o">::</span><span class="nf">post</span><span class="p">(</span><span class="s1">'payments/midtrans-notification'</span><span class="p">,</span> <span class="p">[</span><span class="nc">PaymentCallbackController</span><span class="o">::</span><span class="n">class</span><span class="p">,</span> <span class="s1">'receive'</span><span class="p">]);</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Midtrans will send notifications to the address: <code>http://mydomain.com/payments/midtrans-notification</code>. But here we will not deploy to test, but will use tunel.</p>

<h2>
  <a name="creating-a-csrf-exception" href="#creating-a-csrf-exception">
  </a>
  Creating a CSRF exception
</h2>

<p>Because it is on a web route, every post request will be protected by CSRF. This means that the route that we created above will not be accessible by Midtrans. For that, we have to exclude the route from CSRF protection. In the file <code>app/Http/Middleware/VerifyCsrfToken.php</code> add the above route to be excluded, so it will be like this.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight php"><code><span class="k">protected</span> <span class="nv">$except</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'payments/midtrans-notification'</span><span class="p">,</span>
<span class="p">];</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>If so, the next step is to test.</p>

<h2>
  <a name="installing-ngrok-for-tunneling" href="#installing-ngrok-for-tunneling">
  </a>
  Installing Ngrok for Tunneling
</h2>

<p>Because our Laravel is still on localhost (still offline), of course Midtrans can't send notifications. For that, we have to online the Laravel. You can do this by uploading it to the server so that it can be online and accessible. But here I will not upload to the server, and still use localhost. The trick is to use Ngrok.</p>

<p><strong>What is Ngrok? Ngrok is</strong> a tunelling application that can "online localhost". Ngrok can make our Laravel on localhost (offline) be online and can be accessed by anyone on the internet, just by typing the URL provided by Ngrok. Therefore, we will use Ngrok to test the Midtrans callback.</p>

<blockquote>
<p><strong>Notes</strong><br>
Ngrok is only used for offline testing, if it is ready to use and uploaded to the server, no configuration needs to be changed. Just replace the ngrok tunel address with your domain.</p>
</blockquote>

<h2>
  <a name="download-and-install-ngrok" href="#download-and-install-ngrok">
  </a>
  Download and install Ngrok
</h2>

<p>To download, please go to the <a href="https://ngrok.com">ngrok.com</a> webiste and navigate to the download page. Then download according to your operating system. For installation, please follow the guide on each operating system. If in Windows, just click-click as usual.<br>
<a href="https://res.cloudinary.com/practicaldev/image/fetch/s--5zJvozvI--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/2n55x9fb7yr2xkgwgpy6.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--5zJvozvI--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/2n55x9fb7yr2xkgwgpy6.png" alt="Ngrok download" loading="lazy" width="880" height="396"></a></p>

<p>If so, please register to get an auth token. If you have already registered, go to the <a href="https://dashboard.ngrok.com/get-started/setup">Ngrok dashboard</a> to get the auth token.<br>
<a href="https://res.cloudinary.com/practicaldev/image/fetch/s--6p6lzj-d--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jd5qva0ljceu9pk5wzqk.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--6p6lzj-d--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jd5qva0ljceu9pk5wzqk.png" alt="Setup Ngrok auth token" loading="lazy" width="880" height="396"></a></p>

<p>Please note down the token. Then in CMD / terminal type the following command<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>ngrok authtoken NGROK_AUTH_TOKEN
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s---208Odud--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/wh7ey2xqf2innz75vqw2.PNG" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s---208Odud--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/wh7ey2xqf2innz75vqw2.PNG" alt="Setup ngrok auth token" loading="lazy" width="880" height="460"></a></p>

<p>If successful, we will proceed to the next stage.</p>

<h2>
  <a name="creating-local-servers-and-tunnels" href="#creating-local-servers-and-tunnels">
  </a>
  Creating Local Servers and Tunnels
</h2>

<p>To create a local server, we will use the command artisan serve from laravel with port 8080 (not 8000).<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>php artisan serve --port=8080
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Then a new local server will be created with port 8080. (<a href="http://localhost:8080">http://localhost:8080</a>)</p>

<h2>
  <a name="make-tunel-ngrok" href="#make-tunel-ngrok">
  </a>
  Make tunel ngrok
</h2>

<p>To online the localhost that was previously created, in cmd type the following command:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>ngrok http 8080
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>This command will forward all requests to port 8080, and the Laravel port that was created earlier. If successful it will be as follows.</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--ox4lxdYC--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/mhrovbmzahzn159yqckj.PNG" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--ox4lxdYC--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/mhrovbmzahzn159yqckj.PNG" alt="Ngrok server" loading="lazy" width="880" height="459"></a></p>

<p>Please note the forwarding URL provided by Ngrok, just one of them is enough. Here I get the URL: <code>http://b674-110-137-75-3.ngrok.io/</code>. This URL can be accessed by anyone on the internet. This URL will be given to Midtrans to send notifications. To view the history of incoming requests, please go to: <a href="http://localhost:4040/">http://localhost:4040/</a></p>

<h2>
  <a name="configure-notification-url-on-midtrans-dashboard" href="#configure-notification-url-on-midtrans-dashboard">
  </a>
  Configure Notification URL on Midtrans Dashboard
</h2>

<p>Open the Midtrans dashboard, in the <strong>Settings</strong> > <strong>Configuration</strong> section, in the Payment Notification URL field, fill in as follows.</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--Ub7eS7aK--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/zu9sv4c5gt4e6zd8b78o.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--Ub7eS7aK--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/zu9sv4c5gt4e6zd8b78o.png" alt="Configure Notification URL at Midtrans Dashboard" loading="lazy" width="880" height="396"></a></p>

<p>Please adjust it with your ngrok URL. If so, it should now be ready to be tested.</p>

<blockquote>
<p><strong>Notes</strong><br>
Ngrok is only used for offline testing, if it is ready to use and uploaded to the server, no configuration needs to be changed. Just replace the ngrok tunel address with your domain. For example, if uploaded on the <strong><a href="https://jurnalmms.web.id">https://jurnalmms.web.id</a></strong> domain, just change to: <strong><a href="https://jurnalmms.web.id/payments/midtrans-notification">https://jurnalmms.web.id/payments/midtrans-notification</a></strong></p>
</blockquote>

<h2>
  <a name="doing-test" href="#doing-test">
  </a>
  Doing Test
</h2>

<p>To test the payment, we can use the simulator provided by Midtrans. With the simulator, we can make payments without having to make real payments. Midtrans Mock can be accessed <a href="https://simulator.sandbox.midtrans.com/bri/va/index">here</a>.</p>

<h2>
  <a name="get-the-destination-account-number" href="#get-the-destination-account-number">
  </a>
  Get the destination account number
</h2>

<p>First, we have to get the destination account number. The trick is to open the order page, then click the “Pay now” button, select the payment channel and note the account number displayed.<br>
<a href="https://res.cloudinary.com/practicaldev/image/fetch/s--lMgTBZtw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/dmsbnwixz5arlufpaara.PNG" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--lMgTBZtw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/dmsbnwixz5arlufpaara.PNG" alt="Get back account number for testing" loading="lazy" width="363" height="514"></a></p>

<p>Because the number is a BRI Virtual Account, on the Mock Payment Midtrans website select "BRI Virtual Account" in the Payment Page dropdown.<br>
<a href="https://res.cloudinary.com/practicaldev/image/fetch/s--Gc_IeX9G--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/fs3bhu9nkx6jret3wyrj.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--Gc_IeX9G--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/fs3bhu9nkx6jret3wyrj.png" alt="BRIVA Mock" loading="lazy" width="880" height="396"></a></p>

<p>Then in the input field enter the account number that was obtained earlier. Then click the Inquire button. On the next page click the <strong>Pay button</strong> to pay. If you have successfully entered the success page, it means that the payment simulation has been successfully carried out.</p>

<p>To view the history, please go to <a href="http://localhost:4040">http://localhost:4040</a> and view the history of incoming requests via Ngrok.<br>
<a href="https://res.cloudinary.com/practicaldev/image/fetch/s--9WHIKx8d--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/a5h46jjnhf5j6hnis98q.PNG" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--9WHIKx8d--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/a5h46jjnhf5j6hnis98q.PNG" alt="Ngrok incoming request stats" loading="lazy" width="593" height="174"></a></p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--dUDgv1qg--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1gu7ciropjgsczh5j4pk.PNG" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--dUDgv1qg--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1gu7ciropjgsczh5j4pk.PNG" alt="Ngrok incoming request stats" loading="lazy" width="724" height="287"></a></p>

<p>So far, we have successfully received notifications from Midtrans. The payment status in the database will also change automatically.</p>

<p>When you start testing, there may be an issue with the signature key being unverified. One way to solve this is to make sure the price paid by the customer is the same as the <code>total_price</code> column in the database.</p>

<blockquote>
<p>All program code can be seen in the following GitHub repository:<br>
<a href="https://github.com/mulyosyahidin/laravel-midtrans">https://github.com/mulyosyahidin/laravel-midtrans</a></p>
</blockquote>

<p>Read this post in Indonesian: <a href="https://jurnalmms.web.id/laravel/integrasi-midtrans-dan-laravel-8-menggunakan-snap-bagian-2/">https://jurnalmms.web.id/laravel/integrasi-midtrans-dan-laravel-8-menggunakan-snap-bagian-2/</a></p>

</div></article> <div class="aside-username-wrapper" data-v-10d06ee8><aside class="aside-username-block" data-v-37984f8c data-v-10d06ee8><div class="username-heading loading" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-heading" data-v-37984f8c><div class="vue-content-placeholders-heading__img"></div> <div class="vue-content-placeholders-heading__content"><div class="vue-content-placeholders-heading__title"></div> <div class="vue-content-placeholders-heading__subtitle"></div></div></div></div></div> <div class="info" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-text" data-v-37984f8c><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div></div></div></div></aside></div></div> <div class="comments-block" data-v-8c4375bc data-v-10d06ee8><!----> <a href="https://dev.to/martinms/midtrans-and-laravel-8-integration-using-snap-part-2-4d53" target="_blank" rel="nofollow noopener noreferer" class="add-comment" data-v-8c4375bc>
    Add comment
  </a></div></div> <footer data-v-22cb8fd0><span data-v-22cb8fd0>Built with</span> <a href="https://nuxtjs.org" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="nuxt-icon" data-v-22cb8fd0 data-v-22cb8fd0><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a> <span data-v-22cb8fd0>&</span> <a href="https://docs.dev.to/api" rel="nofollow noopener" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-22cb8fd0 data-v-22cb8fd0><path d="M1.5726 5.13748C1.42945 5.20622 1.2411 5.36661 1.15822 5.48117C1 5.69503 1 5.74849 1 11.8739C1 17.9993 1 18.0528 1.15822 18.2667C1.2411 18.3812 1.42945 18.5416 1.5726 18.6104C1.8137 18.7402 2.46164 18.7478 12 18.7478C21.5384 18.7478 22.1863 18.7402 22.4274 18.6104C22.5706 18.5416 22.7589 18.3812 22.8418 18.2667C23 18.0528 23 17.9993 23 11.8739C23 5.74849 23 5.69503 22.8418 5.48117C22.7589 5.36661 22.5706 5.20622 22.4274 5.13748C22.1863 5.00764 21.5384 5 12 5C2.46164 5 1.8137 5.00764 1.5726 5.13748ZM7.7055 8.2613C8.0822 8.45989 8.59454 9.0098 8.77536 9.40694C8.89589 9.66664 8.91095 9.94922 8.91095 12.0649C8.91095 14.3104 8.90344 14.4478 8.75275 14.7839C8.51919 15.288 8.16506 15.6546 7.68288 15.899C7.26096 16.1052 7.22328 16.1128 5.7315 16.1358L4.20206 16.1663V12.1031V8.04744L5.80684 8.07035C7.27602 8.09327 7.42672 8.10854 7.7055 8.2613ZM13.6952 8.89521V9.73538H12.4521H11.2089V10.4991V11.2629H11.9623H12.7158V12.1031V12.9432H11.9623H11.2089V13.707V14.4708H12.4521H13.6952V15.3109V16.151H12C10.1315 16.151 10.0411 16.1358 9.67191 15.6928L9.47603 15.4484V12.1336C9.47603 8.46752 9.46851 8.49807 9.95069 8.20783C10.1692 8.07035 10.3425 8.05508 11.9473 8.05508H13.6952V8.89521ZM16.5658 10.3769C16.8897 11.6295 17.1685 12.6912 17.176 12.7293C17.1911 12.7675 17.4699 11.7441 17.8014 10.461C18.1254 9.17017 18.4343 8.1009 18.4795 8.08563C18.5247 8.06271 18.9541 8.06271 19.4288 8.07035L20.3028 8.09327L19.376 11.6219C18.8713 13.5542 18.4117 15.2269 18.3664 15.3261C18.0123 16.0135 17.274 16.3343 16.7164 16.0441C16.4528 15.899 16.0911 15.4865 15.9705 15.1887C15.9254 15.0665 15.4884 13.4549 15.0062 11.6142C14.524 9.76593 14.1171 8.20783 14.0945 8.15437C14.0644 8.07035 14.2301 8.05508 15.0212 8.07035L15.9856 8.09327L16.5658 10.3769Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M5.93491 12.103V14.4707H6.27394C6.66574 14.4707 7.01983 14.3103 7.1404 14.0965C7.18559 14.0048 7.21575 13.2105 7.21575 12.0648V10.1783L6.99725 9.95683C6.80133 9.76591 6.71847 9.73535 6.35683 9.73535H5.93491V12.103Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a></footer></div></div></div><script>window.__NUXT__=function(s,a,n,e){return n.type_of="article",n.id=1101678,n.title="Midtrans and Laravel 8 Integration Using Snap: Part 2",n.description="Before continuing reading, please read part 1: Integration of Midtrans and Laravel 8 Using Snap: Part...",n.readable_publish_date="Jun 1",n.slug="midtrans-and-laravel-8-integration-using-snap-part-2-4d53",n.path="/martinms/midtrans-and-laravel-8-integration-using-snap-part-2-4d53",n.url=e,n.comments_count=0,n.public_reactions_count=7,n.collection_id=s,n.published_timestamp=a,n.positive_reactions_count=7,n.cover_image="https://res.cloudinary.com/practicaldev/image/fetch/s--YogmxZDK--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/o3mkegnb2wsoexfesegs.jpg",n.social_image="https://res.cloudinary.com/practicaldev/image/fetch/s--hFTng4cf--/c_imagga_scale,f_auto,fl_progressive,h_500,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/o3mkegnb2wsoexfesegs.jpg",n.canonical_url=e,n.created_at="2022-06-01T12:03:06Z",n.edited_at=s,n.crossposted_at=s,n.published_at=a,n.last_comment_at=a,n.reading_time_minutes=7,n.tag_list="midtrans, payment, gateway",n.tags=["midtrans","payment","gateway"],n.body_html='<p>Before continuing reading, please read part 1: <a href="https://dev.to/martinms/integrate-midtrans-in-laravel-with-snap-api-part-1-18g8">Integration of Midtrans and Laravel 8 Using Snap: Part 1</a></p>\n\n<p>In part 1, we have successfully integrated the Midtrans payment interface using Snap. Until there, customers can make payments through the various payment channels available. In this post, we will continue to create payment callbacks.</p>\n\n<p>What are callbacks? In part 1, the customer is able to make a payment. For example using a virtual account. After the customer has made a successful payment, Midtrans will send a notification to our website that the customer has made a payment. Or, if the customer does not make a payment within the specified time limit, Midtrans will send a notification that the transaction has expired. Our job, is to receive the notification and process the notification.</p>\n\n<p>For example, after the customer has successfully paid, we will receive a successful notification. From the notification, we can change the payment status of the order from previously <strong>waiting for payment</strong> to <strong>already paid</strong>. With this system, there is no need to manually confirm and change the payment status.</p>\n\n<h2>\n  <a name="create-a-service-class" href="#create-a-service-class">\n  </a>\n  Create a Service Class\n</h2>\n\n<p>Sama seperti sebelumnya, logic utama akan kita pisahkan di service layer. Sebelumnya, kita sudah membuat file <code>Midtrans.php</code>, <code>CreateSnapTokenService.php</code> dan <code>CallbackService.php</code>, untuk callback akan kita tulis di file <code>CallbackService.php</code><br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight php"><code><span class="cp">&lt;?php</span>\n\n<span class="kn">namespace</span> <span class="nn">App\\Services\\Midtrans</span><span class="p">;</span>\n\n<span class="kn">use</span> <span class="nc">App\\Models\\Order</span><span class="p">;</span>\n<span class="kn">use</span> <span class="nc">App\\Services\\Midtrans\\Midtrans</span><span class="p">;</span>\n<span class="kn">use</span> <span class="nc">Midtrans\\Notification</span><span class="p">;</span>\n\n<span class="kd">class</span> <span class="nc">CallbackService</span> <span class="kd">extends</span> <span class="nc">Midtrans</span>\n<span class="p">{</span>\n    <span class="k">protected</span> <span class="nv">$notification</span><span class="p">;</span>\n    <span class="k">protected</span> <span class="nv">$order</span><span class="p">;</span>\n    <span class="k">protected</span> <span class="nv">$serverKey</span><span class="p">;</span>\n\n    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span>\n    <span class="p">{</span>\n        <span class="k">parent</span><span class="o">::</span><span class="nf">__construct</span><span class="p">();</span>\n\n        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">serverKey</span> <span class="o">=</span> <span class="nf">config</span><span class="p">(</span><span class="s1">\'midtrans.server_key\'</span><span class="p">);</span>\n        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">_handleNotification</span><span class="p">();</span>\n    <span class="p">}</span>\n\n    <span class="k">public</span> <span class="k">function</span> <span class="n">isSignatureKeyVerified</span><span class="p">()</span>\n    <span class="p">{</span>\n        <span class="k">return</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">_createLocalSignatureKey</span><span class="p">()</span> <span class="o">==</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">notification</span><span class="o">-&gt;</span><span class="n">signature_key</span><span class="p">);</span>\n    <span class="p">}</span>\n\n    <span class="k">public</span> <span class="k">function</span> <span class="n">isSuccess</span><span class="p">()</span>\n    <span class="p">{</span>\n        <span class="nv">$statusCode</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">notification</span><span class="o">-&gt;</span><span class="n">status_code</span><span class="p">;</span>\n        <span class="nv">$transactionStatus</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">notification</span><span class="o">-&gt;</span><span class="n">transaction_status</span><span class="p">;</span>\n        <span class="nv">$fraudStatus</span> <span class="o">=</span> <span class="o">!</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">notification</span><span class="o">-&gt;</span><span class="n">fraud_status</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">notification</span><span class="o">-&gt;</span><span class="n">fraud_status</span> <span class="o">==</span> <span class="s1">\'accept\'</span><span class="p">)</span> <span class="o">:</span> <span class="kc">true</span><span class="p">;</span>\n\n        <span class="k">return</span> <span class="p">(</span><span class="nv">$statusCode</span> <span class="o">==</span> <span class="mi">200</span> <span class="o">&amp;&amp;</span> <span class="nv">$fraudStatus</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">$transactionStatus</span> <span class="o">==</span> <span class="s1">\'capture\'</span> <span class="o">||</span> <span class="nv">$transactionStatus</span> <span class="o">==</span> <span class="s1">\'settlement\'</span><span class="p">));</span>\n    <span class="p">}</span>\n\n    <span class="k">public</span> <span class="k">function</span> <span class="n">isExpire</span><span class="p">()</span>\n    <span class="p">{</span>\n        <span class="k">return</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">notification</span><span class="o">-&gt;</span><span class="n">transaction_status</span> <span class="o">==</span> <span class="s1">\'expire\'</span><span class="p">);</span>\n    <span class="p">}</span>\n\n    <span class="k">public</span> <span class="k">function</span> <span class="n">isCancelled</span><span class="p">()</span>\n    <span class="p">{</span>\n        <span class="k">return</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">notification</span><span class="o">-&gt;</span><span class="n">transaction_status</span> <span class="o">==</span> <span class="s1">\'cancel\'</span><span class="p">);</span>\n    <span class="p">}</span>\n\n    <span class="k">public</span> <span class="k">function</span> <span class="n">getNotification</span><span class="p">()</span>\n    <span class="p">{</span>\n        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">notification</span><span class="p">;</span>\n    <span class="p">}</span>\n\n    <span class="k">public</span> <span class="k">function</span> <span class="n">getOrder</span><span class="p">()</span>\n    <span class="p">{</span>\n        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">order</span><span class="p">;</span>\n    <span class="p">}</span>\n\n    <span class="k">protected</span> <span class="k">function</span> <span class="n">_createLocalSignatureKey</span><span class="p">()</span>\n    <span class="p">{</span>\n        <span class="nv">$orderId</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">order</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>\n        <span class="nv">$statusCode</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">notification</span><span class="o">-&gt;</span><span class="n">status_code</span><span class="p">;</span>\n        <span class="nv">$grossAmount</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">order</span><span class="o">-&gt;</span><span class="n">total_price</span><span class="p">;</span>\n        <span class="nv">$serverKey</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">serverKey</span><span class="p">;</span>\n        <span class="nv">$input</span> <span class="o">=</span> <span class="nv">$orderId</span> <span class="mf">.</span> <span class="nv">$statusCode</span> <span class="mf">.</span> <span class="nv">$grossAmount</span> <span class="mf">.</span> <span class="nv">$serverKey</span><span class="p">;</span>\n        <span class="nv">$signature</span> <span class="o">=</span> <span class="nb">openssl_digest</span><span class="p">(</span><span class="nv">$input</span><span class="p">,</span> <span class="s1">\'sha512\'</span><span class="p">);</span>\n\n        <span class="k">return</span> <span class="nv">$signature</span><span class="p">;</span>\n    <span class="p">}</span>\n\n    <span class="k">protected</span> <span class="k">function</span> <span class="n">_handleNotification</span><span class="p">()</span>\n    <span class="p">{</span>\n        <span class="nv">$notification</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Notification</span><span class="p">();</span>\n\n        <span class="nv">$orderNumber</span> <span class="o">=</span> <span class="nv">$notification</span><span class="o">-&gt;</span><span class="n">order_id</span><span class="p">;</span>\n        <span class="nv">$order</span> <span class="o">=</span> <span class="nc">Order</span><span class="o">::</span><span class="nf">where</span><span class="p">(</span><span class="s1">\'number\'</span><span class="p">,</span> <span class="nv">$orderNumber</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">first</span><span class="p">();</span>\n\n        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">notification</span> <span class="o">=</span> <span class="nv">$notification</span><span class="p">;</span>\n        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">order</span> <span class="o">=</span> <span class="nv">$order</span><span class="p">;</span>\n    <span class="p">}</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>In that service, we capture the notification sent by Midtrans with the <code>_handleNotification()</code> method, then the notification result will be processed again. Here we also need to create a local signature key. This key is a local key so that notifications can be received. When sending notifications, Midtrans will also send a signature key, the key will be compared with the local signature key to verify whether the request is valid or not.</p>\n\n<h2>\n  <a name="creating-a-callback-controller" href="#creating-a-callback-controller">\n  </a>\n  Creating a Callback Controller\n</h2>\n\n<p>To receive notifications, we will create a custom controller named <code>PaymentCallbackController</code>. In the terminal, type the following command:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight shell"><code>php artisan make:controller PaymentCallbackController\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Then write the following code on the controller earlier.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight php"><code><span class="cp">&lt;?php</span>\n\n<span class="kn">namespace</span> <span class="nn">App\\Http\\Controllers</span><span class="p">;</span>\n\n<span class="kn">use</span> <span class="nc">App\\Models\\Order</span><span class="p">;</span>\n<span class="kn">use</span> <span class="nc">Illuminate\\Http\\Request</span><span class="p">;</span>\n<span class="kn">use</span> <span class="nc">App\\Services\\Midtrans\\CallbackService</span><span class="p">;</span>\n\n<span class="kd">class</span> <span class="nc">PaymentCallbackController</span> <span class="kd">extends</span> <span class="nc">Controller</span>\n<span class="p">{</span>\n    <span class="k">public</span> <span class="k">function</span> <span class="n">receive</span><span class="p">()</span>\n    <span class="p">{</span>\n        <span class="nv">$callback</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CallbackService</span><span class="p">;</span>\n\n        <span class="k">if</span> <span class="p">(</span><span class="nv">$callback</span><span class="o">-&gt;</span><span class="nf">isSignatureKeyVerified</span><span class="p">())</span> <span class="p">{</span>\n            <span class="nv">$notification</span> <span class="o">=</span> <span class="nv">$callback</span><span class="o">-&gt;</span><span class="nf">getNotification</span><span class="p">();</span>\n            <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$callback</span><span class="o">-&gt;</span><span class="nf">getOrder</span><span class="p">();</span>\n\n            <span class="k">if</span> <span class="p">(</span><span class="nv">$callback</span><span class="o">-&gt;</span><span class="nf">isSuccess</span><span class="p">())</span> <span class="p">{</span>\n                <span class="nc">Order</span><span class="o">::</span><span class="nf">where</span><span class="p">(</span><span class="s1">\'id\'</span><span class="p">,</span> <span class="nv">$order</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">update</span><span class="p">([</span>\n                    <span class="s1">\'payment_status\'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>\n                <span class="p">]);</span>\n            <span class="p">}</span>\n\n            <span class="k">if</span> <span class="p">(</span><span class="nv">$callback</span><span class="o">-&gt;</span><span class="nf">isExpire</span><span class="p">())</span> <span class="p">{</span>\n                <span class="nc">Order</span><span class="o">::</span><span class="nf">where</span><span class="p">(</span><span class="s1">\'id\'</span><span class="p">,</span> <span class="nv">$order</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">update</span><span class="p">([</span>\n                    <span class="s1">\'payment_status\'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>\n                <span class="p">]);</span>\n            <span class="p">}</span>\n\n            <span class="k">if</span> <span class="p">(</span><span class="nv">$callback</span><span class="o">-&gt;</span><span class="nf">isCancelled</span><span class="p">())</span> <span class="p">{</span>\n                <span class="nc">Order</span><span class="o">::</span><span class="nf">where</span><span class="p">(</span><span class="s1">\'id\'</span><span class="p">,</span> <span class="nv">$order</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">update</span><span class="p">([</span>\n                    <span class="s1">\'payment_status\'</span> <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">,</span>\n                <span class="p">]);</span>\n            <span class="p">}</span>\n\n            <span class="k">return</span> <span class="nf">response</span><span class="p">()</span>\n                <span class="o">-&gt;</span><span class="nf">json</span><span class="p">([</span>\n                    <span class="s1">\'success\'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>\n                    <span class="s1">\'message\'</span> <span class="o">=&gt;</span> <span class="s1">\'Notification successfully processed\'</span><span class="p">,</span>\n                <span class="p">]);</span>\n        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>\n            <span class="k">return</span> <span class="nf">response</span><span class="p">()</span>\n                <span class="o">-&gt;</span><span class="nf">json</span><span class="p">([</span>\n                    <span class="s1">\'error\'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>\n                    <span class="s1">\'message\'</span> <span class="o">=&gt;</span> <span class="s1">\'Signature key not verified\'</span><span class="p">,</span>\n                <span class="p">],</span> <span class="mi">403</span><span class="p">);</span>\n        <span class="p">}</span>\n    <span class="p">}</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>In this controller, we have to check whether the signature key is verified or not. Furthermore, in the service callback we have 3 methods, namely <code>isSuccess()</code> to check whether the transaction was successful, <code>isExpire()</code> to check whether the transaction has expired, <code>isCancelled()</code> to check whether the transaction was aborted. If successful, then update order status data to 2 (already paid), if expired, update order status data to 3 (expired), and if expired then update order status data to 3. You can also add other logic as needed.</p>\n\n<blockquote>\n<p><strong>Safety note</strong><br>\nThe program flow that I created is quite safe to use. Even if anyone knows the callback URL, that person will not be able to "shoot" it directly, because it needs to include an authentication header in the form of a signature key which is a combination of Order ID, status code, overall price and server key. So, don\'t let anyone know your Midtrans servey key.</p>\n</blockquote>\n\n<h2>\n  <a name="creating-routes" href="#creating-routes">\n  </a>\n  Creating Routes\n</h2>\n\n<p>After creating the controller, we have to create a new route. Later Midtrans will send a post request to that route. In the <code>web.php</code> route, add the following route.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight php"><code><span class="kn">use</span> <span class="nc">App\\Http\\Controllers\\PaymentCallbackController</span><span class="p">;</span>\n\n<span class="nc">Route</span><span class="o">::</span><span class="nf">post</span><span class="p">(</span><span class="s1">\'payments/midtrans-notification\'</span><span class="p">,</span> <span class="p">[</span><span class="nc">PaymentCallbackController</span><span class="o">::</span><span class="n">class</span><span class="p">,</span> <span class="s1">\'receive\'</span><span class="p">]);</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Midtrans will send notifications to the address: <code>http://mydomain.com/payments/midtrans-notification</code>. But here we will not deploy to test, but will use tunel.</p>\n\n<h2>\n  <a name="creating-a-csrf-exception" href="#creating-a-csrf-exception">\n  </a>\n  Creating a CSRF exception\n</h2>\n\n<p>Because it is on a web route, every post request will be protected by CSRF. This means that the route that we created above will not be accessible by Midtrans. For that, we have to exclude the route from CSRF protection. In the file <code>app/Http/Middleware/VerifyCsrfToken.php</code> add the above route to be excluded, so it will be like this.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight php"><code><span class="k">protected</span> <span class="nv">$except</span> <span class="o">=</span> <span class="p">[</span>\n    <span class="s1">\'payments/midtrans-notification\'</span><span class="p">,</span>\n<span class="p">];</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>If so, the next step is to test.</p>\n\n<h2>\n  <a name="installing-ngrok-for-tunneling" href="#installing-ngrok-for-tunneling">\n  </a>\n  Installing Ngrok for Tunneling\n</h2>\n\n<p>Because our Laravel is still on localhost (still offline), of course Midtrans can\'t send notifications. For that, we have to online the Laravel. You can do this by uploading it to the server so that it can be online and accessible. But here I will not upload to the server, and still use localhost. The trick is to use Ngrok.</p>\n\n<p><strong>What is Ngrok? Ngrok is</strong> a tunelling application that can "online localhost". Ngrok can make our Laravel on localhost (offline) be online and can be accessed by anyone on the internet, just by typing the URL provided by Ngrok. Therefore, we will use Ngrok to test the Midtrans callback.</p>\n\n<blockquote>\n<p><strong>Notes</strong><br>\nNgrok is only used for offline testing, if it is ready to use and uploaded to the server, no configuration needs to be changed. Just replace the ngrok tunel address with your domain.</p>\n</blockquote>\n\n<h2>\n  <a name="download-and-install-ngrok" href="#download-and-install-ngrok">\n  </a>\n  Download and install Ngrok\n</h2>\n\n<p>To download, please go to the <a href="https://ngrok.com">ngrok.com</a> webiste and navigate to the download page. Then download according to your operating system. For installation, please follow the guide on each operating system. If in Windows, just click-click as usual.<br>\n<a href="https://res.cloudinary.com/practicaldev/image/fetch/s--5zJvozvI--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/2n55x9fb7yr2xkgwgpy6.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--5zJvozvI--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/2n55x9fb7yr2xkgwgpy6.png" alt="Ngrok download" loading="lazy" width="880" height="396"></a></p>\n\n<p>If so, please register to get an auth token. If you have already registered, go to the <a href="https://dashboard.ngrok.com/get-started/setup">Ngrok dashboard</a> to get the auth token.<br>\n<a href="https://res.cloudinary.com/practicaldev/image/fetch/s--6p6lzj-d--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jd5qva0ljceu9pk5wzqk.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--6p6lzj-d--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jd5qva0ljceu9pk5wzqk.png" alt="Setup Ngrok auth token" loading="lazy" width="880" height="396"></a></p>\n\n<p>Please note down the token. Then in CMD / terminal type the following command<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>ngrok authtoken NGROK_AUTH_TOKEN\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s---208Odud--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/wh7ey2xqf2innz75vqw2.PNG" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s---208Odud--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/wh7ey2xqf2innz75vqw2.PNG" alt="Setup ngrok auth token" loading="lazy" width="880" height="460"></a></p>\n\n<p>If successful, we will proceed to the next stage.</p>\n\n<h2>\n  <a name="creating-local-servers-and-tunnels" href="#creating-local-servers-and-tunnels">\n  </a>\n  Creating Local Servers and Tunnels\n</h2>\n\n<p>To create a local server, we will use the command artisan serve from laravel with port 8080 (not 8000).<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>php artisan serve --port=8080\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Then a new local server will be created with port 8080. (<a href="http://localhost:8080">http://localhost:8080</a>)</p>\n\n<h2>\n  <a name="make-tunel-ngrok" href="#make-tunel-ngrok">\n  </a>\n  Make tunel ngrok\n</h2>\n\n<p>To online the localhost that was previously created, in cmd type the following command:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>ngrok http 8080\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>This command will forward all requests to port 8080, and the Laravel port that was created earlier. If successful it will be as follows.</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--ox4lxdYC--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/mhrovbmzahzn159yqckj.PNG" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--ox4lxdYC--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/mhrovbmzahzn159yqckj.PNG" alt="Ngrok server" loading="lazy" width="880" height="459"></a></p>\n\n<p>Please note the forwarding URL provided by Ngrok, just one of them is enough. Here I get the URL: <code>http://b674-110-137-75-3.ngrok.io/</code>. This URL can be accessed by anyone on the internet. This URL will be given to Midtrans to send notifications. To view the history of incoming requests, please go to: <a href="http://localhost:4040/">http://localhost:4040/</a></p>\n\n<h2>\n  <a name="configure-notification-url-on-midtrans-dashboard" href="#configure-notification-url-on-midtrans-dashboard">\n  </a>\n  Configure Notification URL on Midtrans Dashboard\n</h2>\n\n<p>Open the Midtrans dashboard, in the <strong>Settings</strong> &gt; <strong>Configuration</strong> section, in the Payment Notification URL field, fill in as follows.</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--Ub7eS7aK--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/zu9sv4c5gt4e6zd8b78o.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--Ub7eS7aK--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/zu9sv4c5gt4e6zd8b78o.png" alt="Configure Notification URL at Midtrans Dashboard" loading="lazy" width="880" height="396"></a></p>\n\n<p>Please adjust it with your ngrok URL. If so, it should now be ready to be tested.</p>\n\n<blockquote>\n<p><strong>Notes</strong><br>\nNgrok is only used for offline testing, if it is ready to use and uploaded to the server, no configuration needs to be changed. Just replace the ngrok tunel address with your domain. For example, if uploaded on the <strong><a href="https://jurnalmms.web.id">https://jurnalmms.web.id</a></strong> domain, just change to: <strong><a href="https://jurnalmms.web.id/payments/midtrans-notification">https://jurnalmms.web.id/payments/midtrans-notification</a></strong></p>\n</blockquote>\n\n<h2>\n  <a name="doing-test" href="#doing-test">\n  </a>\n  Doing Test\n</h2>\n\n<p>To test the payment, we can use the simulator provided by Midtrans. With the simulator, we can make payments without having to make real payments. Midtrans Mock can be accessed <a href="https://simulator.sandbox.midtrans.com/bri/va/index">here</a>.</p>\n\n<h2>\n  <a name="get-the-destination-account-number" href="#get-the-destination-account-number">\n  </a>\n  Get the destination account number\n</h2>\n\n<p>First, we have to get the destination account number. The trick is to open the order page, then click the “Pay now” button, select the payment channel and note the account number displayed.<br>\n<a href="https://res.cloudinary.com/practicaldev/image/fetch/s--lMgTBZtw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/dmsbnwixz5arlufpaara.PNG" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--lMgTBZtw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/dmsbnwixz5arlufpaara.PNG" alt="Get back account number for testing" loading="lazy" width="363" height="514"></a></p>\n\n<p>Because the number is a BRI Virtual Account, on the Mock Payment Midtrans website select "BRI Virtual Account" in the Payment Page dropdown.<br>\n<a href="https://res.cloudinary.com/practicaldev/image/fetch/s--Gc_IeX9G--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/fs3bhu9nkx6jret3wyrj.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--Gc_IeX9G--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/fs3bhu9nkx6jret3wyrj.png" alt="BRIVA Mock" loading="lazy" width="880" height="396"></a></p>\n\n<p>Then in the input field enter the account number that was obtained earlier. Then click the Inquire button. On the next page click the <strong>Pay button</strong> to pay. If you have successfully entered the success page, it means that the payment simulation has been successfully carried out.</p>\n\n<p>To view the history, please go to <a href="http://localhost:4040">http://localhost:4040</a> and view the history of incoming requests via Ngrok.<br>\n<a href="https://res.cloudinary.com/practicaldev/image/fetch/s--9WHIKx8d--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/a5h46jjnhf5j6hnis98q.PNG" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--9WHIKx8d--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/a5h46jjnhf5j6hnis98q.PNG" alt="Ngrok incoming request stats" loading="lazy" width="593" height="174"></a></p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--dUDgv1qg--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1gu7ciropjgsczh5j4pk.PNG" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--dUDgv1qg--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1gu7ciropjgsczh5j4pk.PNG" alt="Ngrok incoming request stats" loading="lazy" width="724" height="287"></a></p>\n\n<p>So far, we have successfully received notifications from Midtrans. The payment status in the database will also change automatically.</p>\n\n<p>When you start testing, there may be an issue with the signature key being unverified. One way to solve this is to make sure the price paid by the customer is the same as the <code>total_price</code> column in the database.</p>\n\n<blockquote>\n<p>All program code can be seen in the following GitHub repository:<br>\n<a href="https://github.com/mulyosyahidin/laravel-midtrans">https://github.com/mulyosyahidin/laravel-midtrans</a></p>\n</blockquote>\n\n<p>Read this post in Indonesian: <a href="https://jurnalmms.web.id/laravel/integrasi-midtrans-dan-laravel-8-menggunakan-snap-bagian-2/">https://jurnalmms.web.id/laravel/integrasi-midtrans-dan-laravel-8-menggunakan-snap-bagian-2/</a></p>\n\n',n.body_markdown="Before continuing reading, please read part 1: [Integration of Midtrans and Laravel 8 Using Snap: Part 1](https://dev.to/martinms/integrate-midtrans-in-laravel-with-snap-api-part-1-18g8)\n\nIn part 1, we have successfully integrated the Midtrans payment interface using Snap. Until there, customers can make payments through the various payment channels available. In this post, we will continue to create payment callbacks.\n\nWhat are callbacks? In part 1, the customer is able to make a payment. For example using a virtual account. After the customer has made a successful payment, Midtrans will send a notification to our website that the customer has made a payment. Or, if the customer does not make a payment within the specified time limit, Midtrans will send a notification that the transaction has expired. Our job, is to receive the notification and process the notification.\n\nFor example, after the customer has successfully paid, we will receive a successful notification. From the notification, we can change the payment status of the order from previously **waiting for payment** to **already paid**. With this system, there is no need to manually confirm and change the payment status.\n\n##Create a Service Class\nSama seperti sebelumnya, logic utama akan kita pisahkan di service layer. Sebelumnya, kita sudah membuat file `Midtrans.php`, `CreateSnapTokenService.php` dan `CallbackService.php`, untuk callback akan kita tulis di file `CallbackService.php`\n\n```php\n<?php\n \nnamespace App\\Services\\Midtrans;\n \nuse App\\Models\\Order;\nuse App\\Services\\Midtrans\\Midtrans;\nuse Midtrans\\Notification;\n \nclass CallbackService extends Midtrans\n{\n    protected $notification;\n    protected $order;\n    protected $serverKey;\n \n    public function __construct()\n    {\n        parent::__construct();\n \n        $this->serverKey = config('midtrans.server_key');\n        $this->_handleNotification();\n    }\n \n    public function isSignatureKeyVerified()\n    {\n        return ($this->_createLocalSignatureKey() == $this->notification->signature_key);\n    }\n \n    public function isSuccess()\n    {\n        $statusCode = $this->notification->status_code;\n        $transactionStatus = $this->notification->transaction_status;\n        $fraudStatus = !empty($this->notification->fraud_status) ? ($this->notification->fraud_status == 'accept') : true;\n \n        return ($statusCode == 200 && $fraudStatus && ($transactionStatus == 'capture' || $transactionStatus == 'settlement'));\n    }\n \n    public function isExpire()\n    {\n        return ($this->notification->transaction_status == 'expire');\n    }\n \n    public function isCancelled()\n    {\n        return ($this->notification->transaction_status == 'cancel');\n    }\n \n    public function getNotification()\n    {\n        return $this->notification;\n    }\n \n    public function getOrder()\n    {\n        return $this->order;\n    }\n \n    protected function _createLocalSignatureKey()\n    {\n        $orderId = $this->order->number;\n        $statusCode = $this->notification->status_code;\n        $grossAmount = $this->order->total_price;\n        $serverKey = $this->serverKey;\n        $input = $orderId . $statusCode . $grossAmount . $serverKey;\n        $signature = openssl_digest($input, 'sha512');\n \n        return $signature;\n    }\n \n    protected function _handleNotification()\n    {\n        $notification = new Notification();\n \n        $orderNumber = $notification->order_id;\n        $order = Order::where('number', $orderNumber)->first();\n \n        $this->notification = $notification;\n        $this->order = $order;\n    }\n}\n```\n\nIn that service, we capture the notification sent by Midtrans with the `_handleNotification()` method, then the notification result will be processed again. Here we also need to create a local signature key. This key is a local key so that notifications can be received. When sending notifications, Midtrans will also send a signature key, the key will be compared with the local signature key to verify whether the request is valid or not.\n\n##Creating a Callback Controller\nTo receive notifications, we will create a custom controller named `PaymentCallbackController`. In the terminal, type the following command:\n```bash\nphp artisan make:controller PaymentCallbackController\n```\n\nThen write the following code on the controller earlier.\n```php\n<?php\n \nnamespace App\\Http\\Controllers;\n \nuse App\\Models\\Order;\nuse Illuminate\\Http\\Request;\nuse App\\Services\\Midtrans\\CallbackService;\n \nclass PaymentCallbackController extends Controller\n{\n    public function receive()\n    {\n        $callback = new CallbackService;\n \n        if ($callback->isSignatureKeyVerified()) {\n            $notification = $callback->getNotification();\n            $order = $callback->getOrder();\n \n            if ($callback->isSuccess()) {\n                Order::where('id', $order->id)->update([\n                    'payment_status' => 2,\n                ]);\n            }\n \n            if ($callback->isExpire()) {\n                Order::where('id', $order->id)->update([\n                    'payment_status' => 3,\n                ]);\n            }\n \n            if ($callback->isCancelled()) {\n                Order::where('id', $order->id)->update([\n                    'payment_status' => 4,\n                ]);\n            }\n \n            return response()\n                ->json([\n                    'success' => true,\n                    'message' => 'Notification successfully processed',\n                ]);\n        } else {\n            return response()\n                ->json([\n                    'error' => true,\n                    'message' => 'Signature key not verified',\n                ], 403);\n        }\n    }\n}\n```\n\nIn this controller, we have to check whether the signature key is verified or not. Furthermore, in the service callback we have 3 methods, namely `isSuccess()` to check whether the transaction was successful, `isExpire()` to check whether the transaction has expired, `isCancelled()` to check whether the transaction was aborted. If successful, then update order status data to 2 (already paid), if expired, update order status data to 3 (expired), and if expired then update order status data to 3. You can also add other logic as needed.\n\n>**Safety note**\nThe program flow that I created is quite safe to use. Even if anyone knows the callback URL, that person will not be able to \"shoot\" it directly, because it needs to include an authentication header in the form of a signature key which is a combination of Order ID, status code, overall price and server key. So, don't let anyone know your Midtrans servey key.\n\n##Creating Routes\nAfter creating the controller, we have to create a new route. Later Midtrans will send a post request to that route. In the `web.php` route, add the following route.\n```php\nuse App\\Http\\Controllers\\PaymentCallbackController;\n \nRoute::post('payments/midtrans-notification', [PaymentCallbackController::class, 'receive']);\n```\n\nMidtrans will send notifications to the address: `http://mydomain.com/payments/midtrans-notification`. But here we will not deploy to test, but will use tunel.\n\n##Creating a CSRF exception\nBecause it is on a web route, every post request will be protected by CSRF. This means that the route that we created above will not be accessible by Midtrans. For that, we have to exclude the route from CSRF protection. In the file `app/Http/Middleware/VerifyCsrfToken.php` add the above route to be excluded, so it will be like this.\n```php\nprotected $except = [\n    'payments/midtrans-notification',\n];\n```\nIf so, the next step is to test.\n\n##Installing Ngrok for Tunneling\nBecause our Laravel is still on localhost (still offline), of course Midtrans can't send notifications. For that, we have to online the Laravel. You can do this by uploading it to the server so that it can be online and accessible. But here I will not upload to the server, and still use localhost. The trick is to use Ngrok.\n\n**What is Ngrok? Ngrok is** a tunelling application that can \"online localhost\". Ngrok can make our Laravel on localhost (offline) be online and can be accessed by anyone on the internet, just by typing the URL provided by Ngrok. Therefore, we will use Ngrok to test the Midtrans callback.\n\n>**Notes**\nNgrok is only used for offline testing, if it is ready to use and uploaded to the server, no configuration needs to be changed. Just replace the ngrok tunel address with your domain.\n\n##Download and install Ngrok\nTo download, please go to the [ngrok.com](https://ngrok.com) webiste and navigate to the download page. Then download according to your operating system. For installation, please follow the guide on each operating system. If in Windows, just click-click as usual.\n![Ngrok download](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/2n55x9fb7yr2xkgwgpy6.png)\n\nIf so, please register to get an auth token. If you have already registered, go to the [Ngrok dashboard](https://dashboard.ngrok.com/get-started/setup) to get the auth token.\n![Setup Ngrok auth token](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jd5qva0ljceu9pk5wzqk.png)\n\nPlease note down the token. Then in CMD / terminal type the following command\n```\t\nngrok authtoken NGROK_AUTH_TOKEN\n```\n\n![Setup ngrok auth token](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/wh7ey2xqf2innz75vqw2.PNG)\n\nIf successful, we will proceed to the next stage.\n\n##Creating Local Servers and Tunnels\nTo create a local server, we will use the command artisan serve from laravel with port 8080 (not 8000).\n```\nphp artisan serve --port=8080\n```\n\nThen a new local server will be created with port 8080. (http://localhost:8080)\n\n##Make tunel ngrok\nTo online the localhost that was previously created, in cmd type the following command:\n```\t\nngrok http 8080\n```\n\nThis command will forward all requests to port 8080, and the Laravel port that was created earlier. If successful it will be as follows.\n\n![Ngrok server](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/mhrovbmzahzn159yqckj.PNG)\n\nPlease note the forwarding URL provided by Ngrok, just one of them is enough. Here I get the URL: `http://b674-110-137-75-3.ngrok.io/`. This URL can be accessed by anyone on the internet. This URL will be given to Midtrans to send notifications. To view the history of incoming requests, please go to: http://localhost:4040/\n\n##Configure Notification URL on Midtrans Dashboard\nOpen the Midtrans dashboard, in the **Settings** > **Configuration** section, in the Payment Notification URL field, fill in as follows.\n\n![Configure Notification URL at Midtrans Dashboard](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/zu9sv4c5gt4e6zd8b78o.png)\n\nPlease adjust it with your ngrok URL. If so, it should now be ready to be tested.\n>**Notes**\nNgrok is only used for offline testing, if it is ready to use and uploaded to the server, no configuration needs to be changed. Just replace the ngrok tunel address with your domain. For example, if uploaded on the **https://jurnalmms.web.id** domain, just change to: **https://jurnalmms.web.id/payments/midtrans-notification**\n\n##Doing Test\nTo test the payment, we can use the simulator provided by Midtrans. With the simulator, we can make payments without having to make real payments. Midtrans Mock can be accessed [here](https://simulator.sandbox.midtrans.com/bri/va/index).\n\n##Get the destination account number\nFirst, we have to get the destination account number. The trick is to open the order page, then click the “Pay now” button, select the payment channel and note the account number displayed.\n![Get back account number for testing](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/dmsbnwixz5arlufpaara.PNG)\n\nBecause the number is a BRI Virtual Account, on the Mock Payment Midtrans website select \"BRI Virtual Account\" in the Payment Page dropdown.\n![BRIVA Mock](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/fs3bhu9nkx6jret3wyrj.png)\n\nThen in the input field enter the account number that was obtained earlier. Then click the Inquire button. On the next page click the **Pay button** to pay. If you have successfully entered the success page, it means that the payment simulation has been successfully carried out.\n\nTo view the history, please go to http://localhost:4040 and view the history of incoming requests via Ngrok.\n![Ngrok incoming request stats](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/a5h46jjnhf5j6hnis98q.PNG)\n\n![Ngrok incoming request stats](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1gu7ciropjgsczh5j4pk.PNG)\n\nSo far, we have successfully received notifications from Midtrans. The payment status in the database will also change automatically.\n\nWhen you start testing, there may be an issue with the signature key being unverified. One way to solve this is to make sure the price paid by the customer is the same as the `total_price` column in the database.\n\n>All program code can be seen in the following GitHub repository:\nhttps://github.com/mulyosyahidin/laravel-midtrans\n\nRead this post in Indonesian: [https://jurnalmms.web.id/laravel/integrasi-midtrans-dan-laravel-8-menggunakan-snap-bagian-2/](https://jurnalmms.web.id/laravel/integrasi-midtrans-dan-laravel-8-menggunakan-snap-bagian-2/)\n",n.user={name:"Martin Mulyo Syahidin",username:"martinms",twitter_username:s,github_username:"mulyosyahidin",website_url:"https://jurnalmms.web.id/",profile_image:"https://res.cloudinary.com/practicaldev/image/fetch/s--ZgTADGHw--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/675398/bdb11c32-2d44-4d5b-b294-2ee3b3960e7d.JPG",profile_image_90:"https://res.cloudinary.com/practicaldev/image/fetch/s--R-V3VKW2--/c_fill,f_auto,fl_progressive,h_90,q_auto,w_90/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/675398/bdb11c32-2d44-4d5b-b294-2ee3b3960e7d.JPG"},{layout:"default",data:[{}],fetch:{"data-v-70afb46a:0":{article:n}},error:s,state:{currentArticle:n},serverRendered:!0,routePath:"/martinms/1101678",config:{_app:{basePath:"/nuxtstop/",assetsPath:"/nuxtstop/_nuxt/",cdnURL:s}}}}(null,"2022-06-01T12:41:51Z",{},"https://dev.to/martinms/midtrans-and-laravel-8-integration-using-snap-part-2-4d53")</script><script src="/nuxtstop/_nuxt/f6e87fb.js" defer></script><script src="/nuxtstop/_nuxt/dc9ce94.js" defer></script><script src="/nuxtstop/_nuxt/6474719.js" defer></script><script src="/nuxtstop/_nuxt/9b75090.js" defer></script><script src="/nuxtstop/_nuxt/18df600.js" defer></script>
  </body>
</html>
