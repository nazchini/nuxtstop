<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Magic links ðŸª„ with Cognito using the CDK</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="Using Nuxt.js fetch() hook to build dev.to with a new look"><meta data-n-head="ssr" name="format-detection" content="telephone=no"><base href="/nuxtstop/"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,500,600&display=swap"><link rel="preload" href="/nuxtstop/_nuxt/f6e87fb.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/6474719.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/9b75090.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/18df600.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/dc9ce94.js" as="script"><style data-vue-ssr-id="c650fd98:0 af4684f0:0 a9c71758:0 dcafa518:0 4b9cec49:0 b093d766:0 9d98bcb4:0 6b6a11ea:0 0248ed80:0 ea8e4264:0">html{box-sizing:border-box;font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}*,:after,:before{box-sizing:inherit}html{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}*,:after,:before{border:0 solid #e0e0e0}blockquote,body,dd,dl,figure,h1,h2,h3,h4,h5,h6,p,pre{margin:0}button{background:0 0;padding:0}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}hr{border-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:inherit;opacity:.5}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:inherit;opacity:.5}input::placeholder,textarea::placeholder{color:inherit;opacity:.5}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit;font-family:sans-serif}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit;font-family:inherit;font-size:100%}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;overflow:auto;word-break:break-word;white-space:normal}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}html{height:100%;font-size:18px;-ms-overflow-style:scrollbar;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}@media(min-width:640px){html{font-size:20px}}body{height:100%;min-width:320px;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:400;line-height:1.5;color:#000;background-color:#eff4f7;-webkit-text-rendering:optimizeLegibility;text-rendering:optimizeLegibility;font-synthesis:none;font-kerning:normal;font-feature-settings:"normal","kern";-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-overflow-scrolling:touch;overflow-x:hidden;overflow-y:scroll}h1,h2,h3,h4,h5,h6{color:#000;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:600;font-feature-settings:"normal";line-height:1.2}pre{background:#29292e;border-radius:2px;overflow:auto;padding:1rem;color:#eff1f9;line-height:1.42em;font-size:13px}@media screen and (min-width:380px){pre{font-size:15px}}pre code{background:#29292e;color:#eff0f9;white-space:pre}div.highlight pre.highlight code{font-size:inherit;padding:0}div.inner-comment div.body div.highlight pre.highlight{background:#29292e}div.inner-comment div.body div.highlight pre.highlight code{font-size:inherit;white-space:inherit;background:inherit;color:inherit}.highlight .hll{background-color:#49483e}.highlight{background:#29292e;color:#f8f8f2}.highlight .c{color:grey}.highlight .err{text-shadow:0 0 7px #f9690e}.highlight .k{color:#f39c12}.highlight .l{color:plum}.highlight .n{color:#f8f8f2}.highlight .o{color:#f9690e}.highlight .p{color:#f8f8f2}.highlight .c1,.highlight .ch,.highlight .cm,.highlight .cp,.highlight .cpf,.highlight .cs{color:grey}.highlight .gd{color:#f9690e}.highlight .ge{font-style:italic}.highlight .gi{color:#7ed07e}.highlight .gs{font-weight:700}.highlight .gu{color:grey}.highlight .kc,.highlight .kd{color:#f39c12}.highlight .kn{color:#f9690e}.highlight .kp,.highlight .kr,.highlight .kt{color:#f39c12}.highlight .ld{color:#f2ca27}.highlight .m{color:plum}.highlight .s{color:#f2ca27}.highlight .na{color:#7ed07e}.highlight .nb{color:#f8f8f2}.highlight .nc{color:#7ed07e}.highlight .no{color:#f39c12}.highlight .nd{color:#7ed07e}.highlight .ni{color:#f8f8f2}.highlight .ne,.highlight .nf{color:#7ed07e}.highlight .nl,.highlight .nn{color:#f8f8f2}.highlight .nx{color:#7ed07e}.highlight .py{color:#f8f8f2}.highlight .nt{color:#f9690e}.highlight .nv{color:#f8f8f2}.highlight .ow{color:#f9690e}.highlight .w{color:#f8f8f2}.highlight .mb,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo{color:plum}.highlight .dl,.highlight .s2,.highlight .sa,.highlight .sb,.highlight .sc,.highlight .sd{color:#f2ca27}.highlight .se{color:plum}.highlight .s1,.highlight .sh,.highlight .si,.highlight .sr,.highlight .ss,.highlight .sx{color:#f2ca27}.highlight .bp{color:#f8f8f2}.highlight .fm{color:#7ed07e}.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{color:#f8f8f2}.highlight .il{color:plum}.vue-content-placeholders-heading__img,.vue-content-placeholders-heading__subtitle,.vue-content-placeholders-heading__title,.vue-content-placeholders-img,.vue-content-placeholders-text__line{background:#bfcdec!important}.vue-content-placeholders-is-animated .vue-content-placeholders-heading__img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__subtitle:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__title:before,.vue-content-placeholders-is-animated .vue-content-placeholders-img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-text__line:before{background:linear-gradient(90deg,transparent 0,#d3ddf9 15%,transparent 30%)!important}header[data-v-27046cca]{max-width:1280px;margin:auto;padding:1rem;height:6rem;border-bottom:1px solid rgba(0,0,0,.2)}header .logo-wrapper[data-v-27046cca],header[data-v-27046cca]{display:flex;align-items:center;justify-content:space-between}header .logo-wrapper[data-v-27046cca]{margin:0 .5rem}header .logo-wrapper svg[data-v-27046cca]{width:3rem;height:100%}header .logo-wrapper .name-wrapper[data-v-27046cca]{margin-left:.6em}header .logo-wrapper .name-wrapper .subtitle[data-v-27046cca]{font-size:1rem}header .logo-wrapper .name-wrapper .app-name[data-v-27046cca]{font-weight:700;font-size:2.25rem;line-height:1.25}header nav[data-v-27046cca]{letter-spacing:-.025rem;font-weight:600;text-transform:uppercase}header nav ul[data-v-27046cca]{display:flex}header nav ul li[data-v-27046cca]{margin:0 .5rem}header nav ul li a[data-v-27046cca]{box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;padding:.25rem 1rem;border-radius:.5rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}header nav ul li a[data-v-27046cca]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header nav ul li a.nuxt-link-exact-active[data-v-27046cca]{cursor:default}header nav ul li a.nuxt-link-exact-active[data-v-27046cca],header nav ul li a[data-v-27046cca]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}.page-wrapper[data-v-10d06ee8]{max-width:1280px;margin:auto;padding:1rem}.article-content-wrapper[data-v-10d06ee8]{display:flex;flex-direction:column;align-items:center;margin:auto auto 2rem}@media(min-width:1024px){.article-content-wrapper[data-v-10d06ee8]{align-items:normal;flex-direction:row}}.article-content-wrapper .article-block[data-v-10d06ee8]{width:100%;max-width:880px}@media(min-width:1024px){.article-content-wrapper .article-block[data-v-10d06ee8]{margin-right:1rem;width:66.66666%;margin-bottom:2rem}}.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{max-width:880px;width:100%;position:relative}@media(min-width:1024px){.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{display:block;width:33.33333%}}.article-content-wrapper .aside-username-wrapper .aside-username-block[data-v-10d06ee8]{position:-webkit-sticky;position:sticky;top:1rem}@media(min-width:1280px){.comments-block[data-v-10d06ee8]{margin:.5rem}}article[data-v-70afb46a]{padding:.5rem;border-radius:1rem}header h1[data-v-70afb46a],header[data-v-70afb46a]{margin-bottom:1rem}header h1[data-v-70afb46a]{font-size:2.25rem;letter-spacing:-.025rem}header .tags[data-v-70afb46a]{display:flex;flex-wrap:wrap;margin-bottom:1.5rem}header .tags .tag[data-v-70afb46a]{font-weight:500;line-height:1;padding:.5rem;margin:0 .5rem .5rem 0;border-radius:.25rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db}header .tags .tag[data-v-70afb46a]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header .tags .tag[data-v-70afb46a]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}header .image-wrapper[data-v-70afb46a]{position:relative;padding-bottom:56.25%;background-color:#d4dfe8;margin-bottom:1.5rem;border-radius:.5rem;overflow:hidden}@media(min-width:834px){header .image-wrapper[data-v-70afb46a]{margin-bottom:1.5rem}}header .image-wrapper img[data-v-70afb46a]{position:absolute;top:0;left:0;width:100%;height:100%;-o-object-fit:cover;object-fit:cover}header .meta[data-v-70afb46a]{line-height:1;font-size:.875rem;text-transform:uppercase;font-weight:500;letter-spacing:-.025rem;display:flex;align-items:center;justify-content:space-between}header .meta .scl[data-v-70afb46a]{display:flex}header .meta .scl span[data-v-70afb46a]{display:flex;align-items:center;margin-right:1rem}header .meta .scl span svg[data-v-70afb46a]{margin-right:.25rem}header .meta .scl .comments[data-v-70afb46a]{cursor:pointer}[data-v-70afb46a] .content .ltag__user{display:none}[data-v-70afb46a] .content iframe{max-width:100%}[data-v-70afb46a] .content h1{font-size:1.875rem}[data-v-70afb46a] .content h1,[data-v-70afb46a] .content h2{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h2{font-size:1.5rem}[data-v-70afb46a] .content h3{font-size:1.25rem}[data-v-70afb46a] .content h3,[data-v-70afb46a] .content h4{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h4{font-size:1rem}[data-v-70afb46a] .content a{color:#6e87d2}[data-v-70afb46a] .content p{margin-bottom:1rem;line-height:1.4}[data-v-70afb46a] .content p code{background-color:#d2f3e1;border-radius:.25rem;padding:.25rem}[data-v-70afb46a] .content img{width:100%;border-radius:.5rem}[data-v-70afb46a] .content .highlight{margin-bottom:1rem;border-radius:.5rem}[data-v-70afb46a] .content ul{list-style:numeral;margin-bottom:1rem}[data-v-70afb46a] .content ul li p{margin-bottom:0}[data-v-70afb46a] .content ol{margin-bottom:1rem}aside[data-v-37984f8c]{padding:1rem;background-color:#dfe8ef;border-radius:1rem}aside .username-heading[data-v-37984f8c]{display:flex;margin-bottom:1rem}aside .username-heading[data-v-37984f8c]:hover{color:#6e87d2}aside .username-heading img[data-v-37984f8c]{width:3rem;height:3rem;border-radius:50%;margin-right:1rem}aside .username-heading .text[data-v-37984f8c]{display:flex;flex-direction:column;justify-content:center}aside .username-heading .text a[data-v-37984f8c]{line-height:1}aside .username-heading .text a[data-v-37984f8c]:first-child{font-size:1.25rem;font-weight:500;letter-spacing:-.025rem;margin-bottom:.25rem}aside .username-heading .text a[data-v-37984f8c]:last-child{color:#999;font-size:.875rem}aside .username-heading.loading[data-v-37984f8c]{display:block}aside .f-button[data-v-37984f8c]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}aside .f-button[data-v-37984f8c]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}aside .f-button[data-v-37984f8c]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}aside .info>div[data-v-37984f8c]{margin-bottom:.5rem}aside .info .title[data-v-37984f8c]{font-size:.666666rem;letter-spacing:-.0125rem;font-weight:500;color:#999;text-transform:uppercase;margin-bottom:.1rem}aside .info .content[data-v-37984f8c]{font-size:.875rem;line-height:1.4}.add-comment[data-v-8c4375bc]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}.add-comment[data-v-8c4375bc]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}.add-comment[data-v-8c4375bc]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}footer[data-v-22cb8fd0]{padding:2rem;text-align:center;display:flex;align-items:center;justify-content:center}footer span[data-v-22cb8fd0]{display:inline-block;line-height:1;text-transform:uppercase;letter-spacing:-.025rem;font-size:.75rem;font-weight:500}footer a svg[data-v-22cb8fd0]{width:3rem;height:3rem;margin:0 .5rem}footer a .nuxt-icon[data-v-22cb8fd0]{width:2.5rem;height:2.5rem;margin:0 .25rem}</style>
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><div id="__layout"><div><header data-v-27046cca><a href="/nuxtstop/" class="logo-wrapper nuxt-link-active" data-v-27046cca><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-27046cca><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-27046cca></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-27046cca></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-27046cca></path></svg> <div class="name-wrapper" data-v-27046cca><span class="app-name" data-v-27046cca>Nuxtstop</span> <p class="subtitle" data-v-27046cca>For all things nuxt.js</p></div></a> <nav data-v-27046cca><ul data-v-27046cca><li data-v-27046cca><a href="/nuxtstop/" class="nuxt-link-active" data-v-27046cca>
          New
        </a></li><li data-v-27046cca><a href="/nuxtstop/top" data-v-27046cca>
          Top
        </a></li></ul></nav></header> <div class="page-wrapper" data-v-10d06ee8><div class="article-content-wrapper" data-v-10d06ee8><article data-fetch-key="data-v-70afb46a:0" class="article-block" data-v-70afb46a data-v-10d06ee8><header data-v-70afb46a><h1 data-v-70afb46a>Magic links ðŸª„ with Cognito using the CDK</h1> <div class="tags" data-v-70afb46a><a href="/nuxtstop/t/cdk" class="tag" data-v-70afb46a>
          #cdk
        </a><a href="/nuxtstop/t/lambda" class="tag" data-v-70afb46a>
          #lambda
        </a><a href="/nuxtstop/t/cognito" class="tag" data-v-70afb46a>
          #cognito
        </a><a href="/nuxtstop/t/typescript" class="tag" data-v-70afb46a>
          #typescript
        </a></div> <!----> <div class="meta" data-v-70afb46a><div class="scl" data-v-70afb46a><span data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M16.4444 3C14.6733 3 13.0333 3.94162 12 5.34C10.9667 3.94162 9.32667 3 7.55556 3C4.49222 3 2 5.52338 2 8.625C2 14.8024 11.0267 20.586 11.4122 20.829C11.5922 20.9426 11.7956 21 12 21C12.2044 21 12.4078 20.9426 12.5878 20.829C12.9733 20.586 22 14.8024 22 8.625C22 5.52338 19.5078 3 16.4444 3Z" fill="#FF0000" data-v-70afb46a data-v-70afb46a></path></svg>
            37
          </span> <span class="comments" data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M6.11765 22H4.94118L5.64706 21.05C6.11765 20.3969 6.41176 19.5656 6.58824 18.5563C3.64706 17.1906 2 14.6375 2 11.3125C2 6.20625 5.82353 3 12 3C18.1765 3 22 6.20625 22 11.3125C22 16.5375 18.2353 19.625 12 19.625H11.5882C10.6471 20.7531 9 22 6.11765 22ZM12 4.1875C6.47059 4.1875 3.17647 6.85937 3.17647 11.3125C3.17647 15.1125 5.47059 16.8938 7.41177 17.6656L7.82353 17.8437L7.76471 18.3187C7.64706 19.2687 7.47059 20.1 7.11765 20.8125C9.05882 20.575 10.1765 19.5656 10.8235 18.7344L11 18.4969H12C19.9412 18.4969 20.8235 13.5094 20.8235 11.3719C20.8235 6.85938 17.5294 4.1875 12 4.1875Z" fill="black" data-v-70afb46a data-v-70afb46a></path></svg>
            4
          </span></div> <time data-v-70afb46a>Aug 2 '21</time></div></header> <div class="content" data-v-70afb46a><h2>
  <a name="this-is-a-post-on-how-to-perform-passwordless-authentication-using-cognito-the-resources-will-be-created-using-the-cdk-typescript" href="#this-is-a-post-on-how-to-perform-passwordless-authentication-using-cognito-the-resources-will-be-created-using-the-cdk-typescript">
  </a>
  This is a post on how to perform Passwordless authentication ðŸª„ using Cognito. The resources will be created using the CDK (TypeScript).
</h2>

<p>The basic workflow in this would be:</p>

<ol>
<li>User enters their email on the sign-in page.</li>
<li>We create a user in Cognito and store the secret/auth-challenge along with the creation timestamp.</li>
<li>We construct a link to our webapp with the user's email and secret and email it to them</li>
<li>Finally, when they open the sign-in link, we verify the secret + expiration and authenticate the user.</li>
</ol>

<h2>
  <a name="prerequisites" href="#prerequisites">
  </a>
  Prerequisites
</h2>

<p>To follow along, I would suggest cloning the repo and installing the dependencies using <code>yarn</code>.</p>


<div class="ltag-github-readme-tag">
  <div class="readme-overview">
    <h2>
      <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--i3JOwpme--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/github-logo-ba8488d21cd8ee1fee097b8410db9deaa41d0ca30b004c0c63de0a479114156f.svg" alt="GitHub logo" loading="lazy">
      <a href="https://github.com/ryands17">
        ryands17
      </a> / <a style="font-weight:600" href="https://github.com/ryands17/passwordless-auth">
        passwordless-auth
      </a>
    </h2>
    <h3>
      Allows a user to login directly via email without a need for entering passwords using Cognito
    </h3>
  </div>
</div>


<p><strong><em>Note</em></strong>: This is a <a href="https://en.wikipedia.org/wiki/Monorepo">monorepo</a> that has both the backend resources and simple UI to sign-in. This will be located in the <code>packages</code> folder under <code>backend</code> and <code>frontend</code> respectively.</p>

<h2>
  <a name="constructs" href="#constructs">
  </a>
  Constructs
</h2>

<p>Let's have a look at the constructs required to make this work.</p>

<h3>
  <a name="cognito-user-pool-and-app-client" href="#cognito-user-pool-and-app-client">
  </a>
  Cognito User Pool and App Client
</h3>

<p>We need to create a Cognito User Pool and App Client that will help us register the users and execute our sign in flow.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="c1">// packages/backend/lib/passwordless-login-stack.ts</span>

<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">cg</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@aws-cdk/aws-cognito</span><span class="dl">'</span>

<span class="kd">const</span> <span class="nx">userPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cg</span><span class="p">.</span><span class="nx">UserPool</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">'</span><span class="s1">users</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">standardAttributes</span><span class="p">:</span> <span class="p">{</span> <span class="na">email</span><span class="p">:</span> <span class="p">{</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">mutable</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">},</span>
  <span class="na">customAttributes</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">authChallenge</span><span class="p">:</span> <span class="k">new</span> <span class="nx">cg</span><span class="p">.</span><span class="nx">StringAttribute</span><span class="p">({</span> <span class="na">mutable</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}),</span>
  <span class="p">},</span>
  <span class="na">passwordPolicy</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">requireDigits</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="na">requireUppercase</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="na">requireSymbols</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="na">accountRecovery</span><span class="p">:</span> <span class="nx">cg</span><span class="p">.</span><span class="nx">AccountRecovery</span><span class="p">.</span><span class="nx">NONE</span><span class="p">,</span>
  <span class="na">selfSignUpEnabled</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">signInAliases</span><span class="p">:</span> <span class="p">{</span> <span class="na">email</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
  <span class="na">lambdaTriggers</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">preSignUp</span><span class="p">:</span> <span class="nx">lambda</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">'</span><span class="s1">preSignup</span><span class="dl">'</span><span class="p">),</span>
    <span class="na">createAuthChallenge</span><span class="p">:</span> <span class="nx">lambda</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">'</span><span class="s1">createAuthChallenge</span><span class="dl">'</span><span class="p">),</span>
    <span class="na">defineAuthChallenge</span><span class="p">:</span> <span class="nx">lambda</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">'</span><span class="s1">defineAuthChallenge</span><span class="dl">'</span><span class="p">),</span>
    <span class="na">verifyAuthChallengeResponse</span><span class="p">:</span> <span class="nx">lambda</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">'</span><span class="s1">verifyAuthChallenge</span><span class="dl">'</span><span class="p">),</span>
    <span class="nx">postAuthentication</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="na">removalPolicy</span><span class="p">:</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">RemovalPolicy</span><span class="p">.</span><span class="nx">DESTROY</span><span class="p">,</span>
<span class="p">})</span>

<span class="kd">const</span> <span class="nx">webClient</span> <span class="o">=</span> <span class="nx">userPool</span><span class="p">.</span><span class="nx">addClient</span><span class="p">(</span><span class="dl">'</span><span class="s1">webAppClient</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">authFlows</span><span class="p">:</span> <span class="p">{</span> <span class="na">custom</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
<span class="p">})</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>First, we create a <em>UserPool</em>. This will have a standard attribute <code>email</code> that we will use for signing up and so is required. We have also specified a custom attribute that will be used to store the authentication challenge code along with the current timestamp.</p>

<p>We disable all password policies because we will not be using it. We also disable account recovery and set <code>email</code> as an alias so signing in can be done via the <code>email</code>. There are some <code>lambdaTriggers</code> that we will be discussing in the next section.</p>

<p>For sending emails, you need to <a href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/verify-email-addresses.html">verify your email address in SES</a> as we are using SES in Sandbox mode.</p>

<p>We then create a <code>client</code> where we enable a custom auth flow. This is needed because we won't be using a username/password flow but sending a sign-in link which is technically a custom authentication flow in Cognito.</p>
<h3>
  <a name="lambda-triggers" href="#lambda-triggers">
  </a>
  Lambda triggers
</h3>

<p>Let's have a look at all the triggers used in the <code>lambdaTriggers</code> section:</p>

<ul>
<li><strong><code>preSignUp</code></strong></li>
</ul>

<p>This function will be called when we signup the user after they enter their email.<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="c1">// packages/backend/functions/preSignup.ts</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">handler</span><span class="p">:</span> <span class="nx">PreSignUpTriggerHandler</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=></span> <span class="p">{</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">autoConfirmUser</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="k">return</span> <span class="nx">event</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>What we do here is confirm the user so that we don't need to verify them on signup. Cognito's default flow needs a user to be verified on signup and that would defeat the purpose of a link based sign-in workflow.</p>

<ul>
<li><strong><code>createAuthChallenge</code></strong></li>
</ul>

<p>This function will create the challenge and set the public and private challenge parameters respectively.<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="c1">// packages/backend/functions/createAuthChallenge.ts</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">handler</span><span class="p">:</span> <span class="nx">CreateAuthChallengeTriggerHandler</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=></span> <span class="p">{</span>
  <span class="c1">// This is sent back to the client app</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">publicChallengeParameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">email</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">userAttributes</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="c1">// Add the secret login code to the private challenge parameters</span>
  <span class="c1">// so it can be verified by the "Verify Auth Challenge Response" trigger</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">privateChallengeParameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">challenge</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">userAttributes</span><span class="p">[</span><span class="dl">'</span><span class="s1">custom:authChallenge</span><span class="dl">'</span><span class="p">],</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">event</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>The public challenge parameter i.e. the <code>email</code> will be sent to the user whereas the private challenge parameter i.e. our secret will be added to the event which will be used to verify from the sign-in link later on.</p>

<ul>
<li><strong><code>defineAuthChallenge</code></strong></li>
</ul>

<p>This function checks if the parameters for our Passwordless auth (Cognito's custom challenge) are correct. </p>

<p><strong><em>Note</em></strong>: I haven't included the functions used here to keep the code concise but you can easily view them <a href="https://github.com/ryands17/passwordless-auth/blob/main/packages/backend/functions/defineAuthChallenge.ts#L29-L44">here</a> or in the file mentioned in the comments if you have cloned the repo :)<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="c1">// packages/backend/functions/defineAuthChallenge.ts</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">handler</span><span class="p">:</span> <span class="nx">DefineAuthChallengeTriggerHandler</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=></span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">notCustomChallenge</span><span class="p">(</span><span class="nx">event</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// We only accept custom challenges; fail auth</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">issueTokens</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">failAuthentication</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">tooManyFailedAttempts</span><span class="p">(</span><span class="nx">event</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// The user provided a wrong answer 3 times; fail auth</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">issueTokens</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">failAuthentication</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">successfulAnswer</span><span class="p">(</span><span class="nx">event</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// The user provided the right answer; succeed auth</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">issueTokens</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">failAuthentication</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// The user did not provide a correct answer yet; present challenge</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">issueTokens</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">failAuthentication</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">challengeName</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">CUSTOM_CHALLENGE</span><span class="dl">'</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">event</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>This function checks for four things:</p>

<ol>
<li>If the challenge was not a custom challenge, then fail the authentication process as our sign-in link only works with a custom challenge.</li>
<li>If the user has already made three attempts at the incorrect answer i.e. if the link was tampered with, fail the auth.</li>
<li>If the answer was successful, issue the tokens which means that the user will login successfully.</li>
<li>If all of the above conditions don't match, it means that the user hasn't got the link yet so set the challenge and wait for the user to click the sign-in link.</li>
</ol>

<p>Think of this as the pre-validation function. It will check the parameters before we validate the link and return <code>event</code> with the appropriate values.</p>

<ul>
<li><strong><code>verifyAuthChallengeResponse</code></strong></li>
</ul>

<p>This is the main function that verifies the link opened by the user. We call the <code>sendCustomChallengeAnswer</code> method from the <a href="https://docs.amplify.aws/lib/auth/emailpassword/q/platform/js">Amplify JS library</a> that would internally call this Lambda.<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="c1">// packages/backend/functions/verifyAuthChallenge.ts</span>

<span class="kd">const</span> <span class="nx">MAGIC_LINK_TIMEOUT</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">handler</span><span class="p">:</span> <span class="nx">VerifyAuthChallengeResponseTriggerHandler</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span>
  <span class="nx">event</span>
<span class="p">)</span> <span class="o">=></span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">authChallenge</span><span class="p">,</span> <span class="nx">timestamp</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">privateChallengeParameters</span><span class="p">.</span><span class="nx">challenge</span> <span class="o">||</span> <span class="dl">''</span>
  <span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">,</span><span class="dl">'</span><span class="p">)</span>

  <span class="c1">// fail if any one of the parameters is missing</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">authChallenge</span> <span class="o">||</span> <span class="o">!</span><span class="nx">timestamp</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">answerCorrect</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="k">return</span> <span class="nx">event</span>
  <span class="p">}</span>

  <span class="c1">// is the correct challenge and is not expired</span>
  <span class="k">if</span> <span class="p">(</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">challengeAnswer</span> <span class="o">===</span> <span class="nx">authChallenge</span> <span class="o">&&</span>
    <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">timestamp</span><span class="p">)</span> <span class="o">+</span> <span class="nx">MAGIC_LINK_TIMEOUT</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">answerCorrect</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="k">return</span> <span class="nx">event</span>
  <span class="p">}</span>

  <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">answerCorrect</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="k">return</span> <span class="nx">event</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>Here, we set the validity of our link to be <strong>3 minutes</strong>. We then check if the <code>authChallenge</code> (secret code) and timestamp are available and fail if they are missing.</p>

<p>In the next step, we verify if the link has the correct code (not tampered in any way) and the user has opened the link in time. If that's valid, we set the <code>answerCorrect</code> property to <code>true</code> which means that the user can successfully sign-in. If not, we will show a nice error message in the UI stating that the sign-in link was invalid.</p>

<ul>
<li><strong><code>postAuthentication</code></strong></li>
</ul>

<p>This is the final function which will be called after a user has been successfully authenticated.<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="c1">// packages/backend/functions/postAuthentication.ts</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">CognitoIdentityServiceProvider</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">aws-sdk</span><span class="dl">'</span>

<span class="kd">const</span> <span class="nx">cisp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CognitoIdentityServiceProvider</span><span class="p">()</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">handler</span><span class="p">:</span> <span class="nx">PostAuthenticationTriggerHandler</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=></span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">userAttributes</span><span class="p">?.</span><span class="nx">email_verified</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">true</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">cisp</span>
      <span class="p">.</span><span class="nx">adminUpdateUserAttributes</span><span class="p">({</span>
        <span class="na">UserPoolId</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">userPoolId</span><span class="p">,</span>
        <span class="na">UserAttributes</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="na">Name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">email_verified</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">Value</span><span class="p">:</span> <span class="dl">'</span><span class="s1">true</span><span class="dl">'</span><span class="p">,</span>
          <span class="p">},</span>
        <span class="p">],</span>
        <span class="na">Username</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">userName</span><span class="p">,</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="nx">promise</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">event</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>We check if the user's email is verified and if it isn't, we verify it using the <code>adminUpdateUserAttributes</code> method from <code>CognitoIdentityServiceProvider</code>.</p>

<p>This was the entire flow of validating the link sent to the user and signing them in without a password.</p>

<p>You must be wondering that we have covered all this but where do we send the email to user with the sign-in link? For this, we will be creating a <code>signIn</code> API using API Gateway and Lambda proxy which will use <code>SES</code> to send an email to the user.</p>
<h3>
  <a name="api" href="#api">
  </a>
  API
</h3>

<p>Let's start with creating the resources for API Gateway and its method.<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="c1">// packages/backend/lib/passwordless-login-stack.ts</span>

<span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">apiGw</span><span class="p">.</span><span class="nx">RestApi</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">'</span><span class="s1">authApi</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">endpointConfiguration</span><span class="p">:</span> <span class="p">{</span> <span class="na">types</span><span class="p">:</span> <span class="p">[</span><span class="nx">apiGw</span><span class="p">.</span><span class="nx">EndpointType</span><span class="p">.</span><span class="nx">REGIONAL</span><span class="p">]</span> <span class="p">},</span>
  <span class="na">defaultCorsPreflightOptions</span><span class="p">:</span> <span class="p">{</span> <span class="na">allowOrigins</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">]</span> <span class="p">},</span>
  <span class="na">deployOptions</span><span class="p">:</span> <span class="p">{</span> <span class="na">stageName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">dev</span><span class="dl">'</span> <span class="p">},</span>
<span class="p">})</span>

<span class="kd">const</span> <span class="nx">signInMethod</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">apiGw</span><span class="p">.</span><span class="nx">LambdaIntegration</span><span class="p">(</span><span class="nx">signIn</span><span class="p">)</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">addMethod</span><span class="p">(</span><span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span> <span class="nx">signInMethod</span><span class="p">)</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>This snippet creates a REST API with Lambda Proxy integration and a function named <code>signIn</code>. This will be added as on the <code>POST</code> method of our endpoint. We will be passing the <code>email</code> in the body of this request.</p>

<p>The Lambda resource would look something like this:<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="c1">// packages/backend/lib/passwordless-login-stack.ts</span>

<span class="kd">const</span> <span class="nx">signIn</span> <span class="o">=</span> <span class="nx">lambda</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">'</span><span class="s1">signIn</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">addEnvironment</span><span class="p">(</span><span class="dl">'</span><span class="s1">SES_FROM_ADDRESS</span><span class="dl">'</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SES_FROM_ADDRESS</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">addEnvironment</span><span class="p">(</span><span class="dl">'</span><span class="s1">USER_POOL_ID</span><span class="dl">'</span><span class="p">,</span> <span class="nx">userPool</span><span class="p">.</span><span class="nx">userPoolId</span><span class="p">)</span>

<span class="nx">signIn</span><span class="p">.</span><span class="nx">addToRolePolicy</span><span class="p">(</span>
<span class="k">new</span> <span class="nx">iam</span><span class="p">.</span><span class="nx">PolicyStatement</span><span class="p">({</span>
  <span class="na">effect</span><span class="p">:</span> <span class="nx">iam</span><span class="p">.</span><span class="nx">Effect</span><span class="p">.</span><span class="nx">ALLOW</span><span class="p">,</span>
  <span class="na">actions</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">ses:SendEmail</span><span class="dl">'</span><span class="p">],</span>
  <span class="na">resources</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">],</span>
<span class="p">})</span>
<span class="p">)</span>

<span class="nx">signIn</span><span class="p">.</span><span class="nx">addToRolePolicy</span><span class="p">(</span>
<span class="k">new</span> <span class="nx">iam</span><span class="p">.</span><span class="nx">PolicyStatement</span><span class="p">({</span>
  <span class="na">effect</span><span class="p">:</span> <span class="nx">iam</span><span class="p">.</span><span class="nx">Effect</span><span class="p">.</span><span class="nx">ALLOW</span><span class="p">,</span>
  <span class="na">actions</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">cognito-idp:AdminUpdateUserAttributes</span><span class="dl">'</span><span class="p">],</span>
  <span class="na">resources</span><span class="p">:</span> <span class="p">[</span><span class="nx">userPool</span><span class="p">.</span><span class="nx">userPoolArn</span><span class="p">],</span>
<span class="p">})</span>
<span class="p">)</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>Here, we are creating a function that needs two environment variables, one for sending the email and the other for updating the <code>authChallenge</code> (secret) in our user's custom attribute.</p>

<p>Due the these operations, we would also need to add permissions for SES and Cognito. The permissions <code>sendEmail</code> and <code>AdminUpdateUserAttributes</code> are for sending the email and updating the custom attribute respectively.</p>

<p>Now let's have a look at what the Lambda function contains:<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="c1">// packages/backend/functions/signIn.ts</span>

<span class="kd">const</span> <span class="nx">cisp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CognitoIdentityServiceProvider</span><span class="p">()</span>
<span class="kd">const</span> <span class="nx">ses</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SES</span><span class="p">({</span> <span class="na">region</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_REGION</span> <span class="p">})</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">handler</span><span class="p">:</span> <span class="nx">APIGatewayProxyHandler</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=></span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">email</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">body</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">{}</span><span class="dl">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">email</span><span class="p">)</span> <span class="k">throw</span> <span class="nb">Error</span><span class="p">()</span>

    <span class="c1">// set the code in custom attributes</span>
    <span class="kd">const</span> <span class="nx">authChallenge</span> <span class="o">=</span> <span class="nx">randomDigits</span><span class="p">(</span><span class="mi">6</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="dl">''</span><span class="p">)</span>
    <span class="k">await</span> <span class="nx">cisp</span>
      <span class="p">.</span><span class="nx">adminUpdateUserAttributes</span><span class="p">({</span>
        <span class="na">UserAttributes</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="na">Name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">custom:authChallenge</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">Value</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">authChallenge</span><span class="p">}</span><span class="s2">,</span><span class="p">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()}</span><span class="s2">`</span><span class="p">,</span>
          <span class="p">},</span>
        <span class="p">],</span>
        <span class="na">UserPoolId</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">USER_POOL_ID</span><span class="p">,</span>
        <span class="na">Username</span><span class="p">:</span> <span class="nx">email</span><span class="p">,</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="nx">promise</span><span class="p">()</span>

    <span class="k">await</span> <span class="nx">sendEmail</span><span class="p">(</span><span class="nx">email</span><span class="p">,</span> <span class="nx">authChallenge</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
      <span class="na">statusCode</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
      <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">'</span><span class="s1">Access-Control-Allow-Origin</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="na">body</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
        <span class="na">message</span><span class="p">:</span> <span class="s2">`A link has been sent to </span><span class="p">${</span><span class="nx">email</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
      <span class="p">}),</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">statusCode</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
      <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">'</span><span class="s1">Access-Control-Allow-Origin</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="na">body</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
        <span class="na">message</span><span class="p">:</span> <span class="s2">`Couldn't process the request. Please try after some time.`</span><span class="p">,</span>
      <span class="p">}),</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">BASE_URL</span> <span class="o">=</span> <span class="s2">`http://localhost:3000/verify`</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">sendEmail</span><span class="p">(</span><span class="nx">emailAddress</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">authChallenge</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">MAGIC_LINK</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">BASE_URL</span><span class="p">}</span><span class="s2">?email=</span><span class="p">${</span><span class="nx">emailAddress</span><span class="p">}</span><span class="s2">&code=</span><span class="p">${</span><span class="nx">authChallenge</span><span class="p">}</span><span class="s2">`</span>

  <span class="kd">const</span> <span class="nx">html</span> <span class="o">=</span> <span class="s2">`
    &lt;html>&lt;body>
    &lt;p>Here's your link:&lt;/p>
    &lt;h3>
      &lt;a target="_blank" rel="noopener noreferrer" href="</span><span class="p">${</span><span class="nx">MAGIC_LINK</span><span class="p">}</span><span class="s2">">Click to sign-in&lt;/a>
    &lt;/h3>
    &lt;/body>&lt;/html>
  `</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span>

  <span class="kd">const</span> <span class="nx">params</span><span class="p">:</span> <span class="nx">SES</span><span class="p">.</span><span class="nx">SendEmailRequest</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">Destination</span><span class="p">:</span> <span class="p">{</span> <span class="na">ToAddresses</span><span class="p">:</span> <span class="p">[</span><span class="nx">emailAddress</span><span class="p">]</span> <span class="p">},</span>
    <span class="na">Message</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">Body</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">Html</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">Charset</span><span class="p">:</span> <span class="dl">'</span><span class="s1">UTF-8</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">Data</span><span class="p">:</span> <span class="nx">html</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="na">Text</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">Charset</span><span class="p">:</span> <span class="dl">'</span><span class="s1">UTF-8</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">Data</span><span class="p">:</span> <span class="s2">`Here's your link (copy and paste in the browser): </span><span class="p">${</span><span class="nx">MAGIC_LINK</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
        <span class="p">},</span>
      <span class="p">},</span>
      <span class="na">Subject</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">Charset</span><span class="p">:</span> <span class="dl">'</span><span class="s1">UTF-8</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">Data</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Login link</span><span class="dl">'</span><span class="p">,</span>
      <span class="p">},</span>
    <span class="p">},</span>
    <span class="na">Source</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SES_FROM_ADDRESS</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="k">await</span> <span class="nx">ses</span><span class="p">.</span><span class="nx">sendEmail</span><span class="p">(</span><span class="nx">params</span><span class="p">).</span><span class="nx">promise</span><span class="p">()</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>First, we create a cryptographically random secret that will be inserted in the sign-up link. We set the secret and the creation timestamp in the user's custom attribute. Finally, we call the <code>sendEmail</code> method that accepts the secret and email of the user trying to sign in.</p>

<p>We created a <code>BASE_URL</code> constant that will actually to be the link to our webapp set to <code>localhost</code> currently for development. We then construct the magic link as follows:<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="kd">const</span> <span class="nx">MAGIC_LINK</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">BASE_URL</span><span class="p">}</span><span class="s2">?email=</span><span class="p">${</span><span class="nx">emailAddress</span><span class="p">}</span><span class="s2">&code=</span><span class="p">${</span><span class="nx">authChallenge</span><span class="p">}</span><span class="s2">`</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>This will append the <code>email</code> and <code>code</code> as querystring params which we be fetching in our webapp to validate the sign-in request. The final part is just constructing the email to be sent where we embed the link and the user can directly click the link to open it in the browser.</p>
<h3>
  <a name="deploying-the-stack" href="#deploying-the-stack">
  </a>
  Deploying the stack
</h3>

<p>The final step to add in our stack is outputs that our webapp will use to perform authentication against the User Pool. This is done using the <a href="https://docs.amplify.aws/lib/auth/getting-started/q/platform/js">Amplify JS library</a>.<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="k">new</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">CfnOutput</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">'</span><span class="s1">userPoolId</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">value</span><span class="p">:</span> <span class="nx">userPool</span><span class="p">.</span><span class="nx">userPoolId</span><span class="p">,</span>
<span class="p">})</span>

<span class="k">new</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">CfnOutput</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">'</span><span class="s1">clientId</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">value</span><span class="p">:</span> <span class="nx">webClient</span><span class="p">.</span><span class="nx">userPoolClientId</span><span class="p">,</span>
<span class="p">})</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>We set the <code>userPoolId</code> and <code>clientId</code> to be used by Amplify. CDK <strong>automatically outputs</strong> the API Gateway endpoint URL so we don't need to add it explicitly. Sweet!</p>

<p>Now let's deploy the stack! As we are using workspaces, we need to run the <code>deploy</code> command in the backend workspace.<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>yarn workspace backend cdk deploy
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>As an alternative, you can also move to the <code>backend</code> directory and simply run <code>yarn cdk deploy</code>.</p>

<p>This will deploy all our resources and create a JSON file with the outputs in our <code>frontend/src</code> folder. We generate the outputs file in the <code>frontend/src</code> folder on purpose as we need to use this in our React app. This app is created using <a href="https://reactjs.org/docs/create-a-new-react-app.html">create-react-app</a>.</p>

<p><strong><em>Note</em></strong>: You will need to edit the URL key the <a href="https://github.com/ryands17/passwordless-auth/blob/main/packages/frontend/src/config/api.ts">api</a> file before proceeding further as CDK will generate a new resource name for your stack.</p>
<h3>
  <a name="testing-the-login-flow" href="#testing-the-login-flow">
  </a>
  Testing the login flow
</h3>

<p>After successful deployment, we can run the webapp locally to test the login flow using the following command:<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>yarn workspace frontend dev
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>This will fire up the app on <a href="http://localhost:3000/">http://localhost:3000/</a> and will redirect to the <code>signIn</code> page as we aren't currently authenticated.</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--jM9vKrUG--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/t9wbs7ix4f05eyoye4ai.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--jM9vKrUG--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/t9wbs7ix4f05eyoye4ai.png" alt="Sign-in page that accepts an email" loading="lazy"></a></p>

<p>On adding our email address here, we will get a link on our email address.</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--m5MRFh3A--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/52s0el1i9frcxs5tuzbs.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--m5MRFh3A--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/52s0el1i9frcxs5tuzbs.png" alt="Link sent successfully" loading="lazy"></a></p>

<p>Here's the link I received that includes the email and authChallenge (secret).</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--MkVpa7jt--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/d4jfxeoaz7m6zumsg0wl.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--MkVpa7jt--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/d4jfxeoaz7m6zumsg0wl.png" alt="Email received with the sign-in link" loading="lazy"></a></p>

<p>On clicking the link, a verify page is opened that will perform the sign-in and call the <code>sendCustomChallengeAnswer</code> method which will successfully verify the user and be redirected to the home page :)</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--_sM4nTxk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jcqdzadh8i7qpnom2b9a.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--_sM4nTxk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jcqdzadh8i7qpnom2b9a.png" alt="Home page after successfully signing in" loading="lazy"></a></p>
<h2>
  <a name="conclusion" href="#conclusion">
  </a>
  Conclusion
</h2>

<p>So that was it! This is how we can perform a truly Passwordless sign-in with Cognito. Here's the repo again for those who would like to experiment:</p>


<div class="ltag-github-readme-tag">
  <div class="readme-overview">
    <h2>
      <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--i3JOwpme--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/github-logo-ba8488d21cd8ee1fee097b8410db9deaa41d0ca30b004c0c63de0a479114156f.svg" alt="GitHub logo" loading="lazy">
      <a href="https://github.com/ryands17">
        ryands17
      </a> / <a style="font-weight:600" href="https://github.com/ryands17/passwordless-auth">
        passwordless-auth
      </a>
    </h2>
    <h3>
      Allows a user to login directly via email without a need for entering passwords using Cognito
    </h3>
  </div>
</div>



<p>Also don't forget to <strong>destroy this stack</strong> so that you do not incur unnecessary charges using the following command:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>yarn workspace backend cdk destroy
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>The resources I used to help create this are:</p>

<p><a href="https://aws.amazon.com/blogs/mobile/implementing-passwordless-email-authentication-with-amazon-cognito/">https://aws.amazon.com/blogs/mobile/implementing-passwordless-email-authentication-with-amazon-cognito/</a></p>

<p><a href="https://schof.co/cognito-magic-links/">https://schof.co/cognito-magic-links/</a></p>

<p>Thanks for reading this and I would love to hear your thoughts on this in the comments! If you liked this post, do give it a like and share, and follow me on <a href="https://twitter.com/ryands1701">Twitter</a>. Until next time!</p>

</div></article> <div class="aside-username-wrapper" data-v-10d06ee8><aside class="aside-username-block" data-v-37984f8c data-v-10d06ee8><div class="username-heading loading" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-heading" data-v-37984f8c><div class="vue-content-placeholders-heading__img"></div> <div class="vue-content-placeholders-heading__content"><div class="vue-content-placeholders-heading__title"></div> <div class="vue-content-placeholders-heading__subtitle"></div></div></div></div></div> <div class="info" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-text" data-v-37984f8c><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div></div></div></div></aside></div></div> <div class="comments-block" data-v-8c4375bc data-v-10d06ee8><!----> <a href="https://dev.to/ryands17/magic-links-with-cognito-using-the-cdk-24a9" target="_blank" rel="nofollow noopener noreferer" class="add-comment" data-v-8c4375bc>
    Add comment
  </a></div></div> <footer data-v-22cb8fd0><span data-v-22cb8fd0>Built with</span> <a href="https://nuxtjs.org" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="nuxt-icon" data-v-22cb8fd0 data-v-22cb8fd0><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a> <span data-v-22cb8fd0>&</span> <a href="https://docs.dev.to/api" rel="nofollow noopener" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-22cb8fd0 data-v-22cb8fd0><path d="M1.5726 5.13748C1.42945 5.20622 1.2411 5.36661 1.15822 5.48117C1 5.69503 1 5.74849 1 11.8739C1 17.9993 1 18.0528 1.15822 18.2667C1.2411 18.3812 1.42945 18.5416 1.5726 18.6104C1.8137 18.7402 2.46164 18.7478 12 18.7478C21.5384 18.7478 22.1863 18.7402 22.4274 18.6104C22.5706 18.5416 22.7589 18.3812 22.8418 18.2667C23 18.0528 23 17.9993 23 11.8739C23 5.74849 23 5.69503 22.8418 5.48117C22.7589 5.36661 22.5706 5.20622 22.4274 5.13748C22.1863 5.00764 21.5384 5 12 5C2.46164 5 1.8137 5.00764 1.5726 5.13748ZM7.7055 8.2613C8.0822 8.45989 8.59454 9.0098 8.77536 9.40694C8.89589 9.66664 8.91095 9.94922 8.91095 12.0649C8.91095 14.3104 8.90344 14.4478 8.75275 14.7839C8.51919 15.288 8.16506 15.6546 7.68288 15.899C7.26096 16.1052 7.22328 16.1128 5.7315 16.1358L4.20206 16.1663V12.1031V8.04744L5.80684 8.07035C7.27602 8.09327 7.42672 8.10854 7.7055 8.2613ZM13.6952 8.89521V9.73538H12.4521H11.2089V10.4991V11.2629H11.9623H12.7158V12.1031V12.9432H11.9623H11.2089V13.707V14.4708H12.4521H13.6952V15.3109V16.151H12C10.1315 16.151 10.0411 16.1358 9.67191 15.6928L9.47603 15.4484V12.1336C9.47603 8.46752 9.46851 8.49807 9.95069 8.20783C10.1692 8.07035 10.3425 8.05508 11.9473 8.05508H13.6952V8.89521ZM16.5658 10.3769C16.8897 11.6295 17.1685 12.6912 17.176 12.7293C17.1911 12.7675 17.4699 11.7441 17.8014 10.461C18.1254 9.17017 18.4343 8.1009 18.4795 8.08563C18.5247 8.06271 18.9541 8.06271 19.4288 8.07035L20.3028 8.09327L19.376 11.6219C18.8713 13.5542 18.4117 15.2269 18.3664 15.3261C18.0123 16.0135 17.274 16.3343 16.7164 16.0441C16.4528 15.899 16.0911 15.4865 15.9705 15.1887C15.9254 15.0665 15.4884 13.4549 15.0062 11.6142C14.524 9.76593 14.1171 8.20783 14.0945 8.15437C14.0644 8.07035 14.2301 8.05508 15.0212 8.07035L15.9856 8.09327L16.5658 10.3769Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M5.93491 12.103V14.4707H6.27394C6.66574 14.4707 7.01983 14.3103 7.1404 14.0965C7.18559 14.0048 7.21575 13.2105 7.21575 12.0648V10.1783L6.99725 9.95683C6.80133 9.76591 6.71847 9.73535 6.35683 9.73535H5.93491V12.103Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a></footer></div></div></div><script>window.__NUXT__=function(s,n,a,e,p){return n.type_of="article",n.id=778234,n.title="Magic links ðŸª„ with Cognito using the CDK",n.description="This is a post on how to perform Passwordless authentication ðŸª„ using Cognito. The resources...",n.readable_publish_date="Aug 2 '21",n.slug="magic-links-with-cognito-using-the-cdk-24a9",n.path="/ryands17/magic-links-with-cognito-using-the-cdk-24a9",n.url=a,n.comments_count=4,n.public_reactions_count=37,n.collection_id=s,n.published_timestamp=e,n.positive_reactions_count=37,n.cover_image=s,n.social_image="https://dev.to/social_previews/article/778234.png",n.canonical_url=a,n.created_at="2021-08-01T11:01:33Z",n.edited_at="2021-08-03T12:57:54Z",n.crossposted_at=s,n.published_at=e,n.last_comment_at="2022-05-11T09:59:35Z",n.reading_time_minutes=9,n.tag_list="cdk, lambda, cognito, typescript",n.tags=["cdk","lambda","cognito","typescript"],n.body_html='<h2>\n  <a name="this-is-a-post-on-how-to-perform-passwordless-authentication-using-cognito-the-resources-will-be-created-using-the-cdk-typescript" href="#this-is-a-post-on-how-to-perform-passwordless-authentication-using-cognito-the-resources-will-be-created-using-the-cdk-typescript">\n  </a>\n  This is a post on how to perform Passwordless authentication ðŸª„ using Cognito. The resources will be created using the CDK (TypeScript).\n</h2>\n\n<p>The basic workflow in this would be:</p>\n\n<ol>\n<li>User enters their email on the sign-in page.</li>\n<li>We create a user in Cognito and store the secret/auth-challenge along with the creation timestamp.</li>\n<li>We construct a link to our webapp with the user\'s email and secret and email it to them</li>\n<li>Finally, when they open the sign-in link, we verify the secret + expiration and authenticate the user.</li>\n</ol>\n\n<h2>\n  <a name="prerequisites" href="#prerequisites">\n  </a>\n  Prerequisites\n</h2>\n\n<p>To follow along, I would suggest cloning the repo and installing the dependencies using <code>yarn</code>.</p>\n\n\n<div class="ltag-github-readme-tag">\n  <div class="readme-overview">\n    <h2>\n      <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--i3JOwpme--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/github-logo-ba8488d21cd8ee1fee097b8410db9deaa41d0ca30b004c0c63de0a479114156f.svg" alt="GitHub logo" loading="lazy">\n      <a href="https://github.com/ryands17">\n        ryands17\n      </a> / <a style="font-weight: 600;" href="https://github.com/ryands17/passwordless-auth">\n        passwordless-auth\n      </a>\n    </h2>\n    <h3>\n      Allows a user to login directly via email without a need for entering passwords using Cognito\n    </h3>\n  </div>\n</div>\n\n\n<p><strong><em>Note</em></strong>: This is a <a href="https://en.wikipedia.org/wiki/Monorepo">monorepo</a> that has both the backend resources and simple UI to sign-in. This will be located in the <code>packages</code> folder under <code>backend</code> and <code>frontend</code> respectively.</p>\n\n<h2>\n  <a name="constructs" href="#constructs">\n  </a>\n  Constructs\n</h2>\n\n<p>Let\'s have a look at the constructs required to make this work.</p>\n\n<h3>\n  <a name="cognito-user-pool-and-app-client" href="#cognito-user-pool-and-app-client">\n  </a>\n  Cognito User Pool and App Client\n</h3>\n\n<p>We need to create a Cognito User Pool and App Client that will help us register the users and execute our sign in flow.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="c1">// packages/backend/lib/passwordless-login-stack.ts</span>\n\n<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">cg</span> <span class="k">from</span> <span class="dl">\'</span><span class="s1">@aws-cdk/aws-cognito</span><span class="dl">\'</span>\n\n<span class="kd">const</span> <span class="nx">userPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cg</span><span class="p">.</span><span class="nx">UserPool</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">\'</span><span class="s1">users</span><span class="dl">\'</span><span class="p">,</span> <span class="p">{</span>\n  <span class="na">standardAttributes</span><span class="p">:</span> <span class="p">{</span> <span class="na">email</span><span class="p">:</span> <span class="p">{</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">mutable</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">},</span>\n  <span class="na">customAttributes</span><span class="p">:</span> <span class="p">{</span>\n    <span class="na">authChallenge</span><span class="p">:</span> <span class="k">new</span> <span class="nx">cg</span><span class="p">.</span><span class="nx">StringAttribute</span><span class="p">({</span> <span class="na">mutable</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}),</span>\n  <span class="p">},</span>\n  <span class="na">passwordPolicy</span><span class="p">:</span> <span class="p">{</span>\n    <span class="na">requireDigits</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>\n    <span class="na">requireUppercase</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>\n    <span class="na">requireSymbols</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>\n  <span class="p">},</span>\n  <span class="na">accountRecovery</span><span class="p">:</span> <span class="nx">cg</span><span class="p">.</span><span class="nx">AccountRecovery</span><span class="p">.</span><span class="nx">NONE</span><span class="p">,</span>\n  <span class="na">selfSignUpEnabled</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>\n  <span class="na">signInAliases</span><span class="p">:</span> <span class="p">{</span> <span class="na">email</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>\n  <span class="na">lambdaTriggers</span><span class="p">:</span> <span class="p">{</span>\n    <span class="na">preSignUp</span><span class="p">:</span> <span class="nx">lambda</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">\'</span><span class="s1">preSignup</span><span class="dl">\'</span><span class="p">),</span>\n    <span class="na">createAuthChallenge</span><span class="p">:</span> <span class="nx">lambda</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">\'</span><span class="s1">createAuthChallenge</span><span class="dl">\'</span><span class="p">),</span>\n    <span class="na">defineAuthChallenge</span><span class="p">:</span> <span class="nx">lambda</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">\'</span><span class="s1">defineAuthChallenge</span><span class="dl">\'</span><span class="p">),</span>\n    <span class="na">verifyAuthChallengeResponse</span><span class="p">:</span> <span class="nx">lambda</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">\'</span><span class="s1">verifyAuthChallenge</span><span class="dl">\'</span><span class="p">),</span>\n    <span class="nx">postAuthentication</span><span class="p">,</span>\n  <span class="p">},</span>\n  <span class="na">removalPolicy</span><span class="p">:</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">RemovalPolicy</span><span class="p">.</span><span class="nx">DESTROY</span><span class="p">,</span>\n<span class="p">})</span>\n\n<span class="kd">const</span> <span class="nx">webClient</span> <span class="o">=</span> <span class="nx">userPool</span><span class="p">.</span><span class="nx">addClient</span><span class="p">(</span><span class="dl">\'</span><span class="s1">webAppClient</span><span class="dl">\'</span><span class="p">,</span> <span class="p">{</span>\n  <span class="na">authFlows</span><span class="p">:</span> <span class="p">{</span> <span class="na">custom</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>\n<span class="p">})</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>First, we create a <em>UserPool</em>. This will have a standard attribute <code>email</code> that we will use for signing up and so is required. We have also specified a custom attribute that will be used to store the authentication challenge code along with the current timestamp.</p>\n\n<p>We disable all password policies because we will not be using it. We also disable account recovery and set <code>email</code> as an alias so signing in can be done via the <code>email</code>. There are some <code>lambdaTriggers</code> that we will be discussing in the next section.</p>\n\n<p>For sending emails, you need to <a href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/verify-email-addresses.html">verify your email address in SES</a> as we are using SES in Sandbox mode.</p>\n\n<p>We then create a <code>client</code> where we enable a custom auth flow. This is needed because we won\'t be using a username/password flow but sending a sign-in link which is technically a custom authentication flow in Cognito.</p>\n<h3>\n  <a name="lambda-triggers" href="#lambda-triggers">\n  </a>\n  Lambda triggers\n</h3>\n\n<p>Let\'s have a look at all the triggers used in the <code>lambdaTriggers</code> section:</p>\n\n<ul>\n<li><strong><code>preSignUp</code></strong></li>\n</ul>\n\n<p>This function will be called when we signup the user after they enter their email.<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="c1">// packages/backend/functions/preSignup.ts</span>\n\n<span class="k">export</span> <span class="kd">const</span> <span class="nx">handler</span><span class="p">:</span> <span class="nx">PreSignUpTriggerHandler</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">autoConfirmUser</span> <span class="o">=</span> <span class="kc">true</span>\n  <span class="k">return</span> <span class="nx">event</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>What we do here is confirm the user so that we don\'t need to verify them on signup. Cognito\'s default flow needs a user to be verified on signup and that would defeat the purpose of a link based sign-in workflow.</p>\n\n<ul>\n<li><strong><code>createAuthChallenge</code></strong></li>\n</ul>\n\n<p>This function will create the challenge and set the public and private challenge parameters respectively.<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="c1">// packages/backend/functions/createAuthChallenge.ts</span>\n\n<span class="k">export</span> <span class="kd">const</span> <span class="nx">handler</span><span class="p">:</span> <span class="nx">CreateAuthChallengeTriggerHandler</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="c1">// This is sent back to the client app</span>\n  <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">publicChallengeParameters</span> <span class="o">=</span> <span class="p">{</span>\n    <span class="na">email</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">userAttributes</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>\n  <span class="p">}</span>\n\n  <span class="c1">// Add the secret login code to the private challenge parameters</span>\n  <span class="c1">// so it can be verified by the "Verify Auth Challenge Response" trigger</span>\n  <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">privateChallengeParameters</span> <span class="o">=</span> <span class="p">{</span>\n    <span class="na">challenge</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">userAttributes</span><span class="p">[</span><span class="dl">\'</span><span class="s1">custom:authChallenge</span><span class="dl">\'</span><span class="p">],</span>\n  <span class="p">}</span>\n\n  <span class="k">return</span> <span class="nx">event</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>The public challenge parameter i.e. the <code>email</code> will be sent to the user whereas the private challenge parameter i.e. our secret will be added to the event which will be used to verify from the sign-in link later on.</p>\n\n<ul>\n<li><strong><code>defineAuthChallenge</code></strong></li>\n</ul>\n\n<p>This function checks if the parameters for our Passwordless auth (Cognito\'s custom challenge) are correct. </p>\n\n<p><strong><em>Note</em></strong>: I haven\'t included the functions used here to keep the code concise but you can easily view them <a href="https://github.com/ryands17/passwordless-auth/blob/main/packages/backend/functions/defineAuthChallenge.ts#L29-L44">here</a> or in the file mentioned in the comments if you have cloned the repo :)<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="c1">// packages/backend/functions/defineAuthChallenge.ts</span>\n\n<span class="k">export</span> <span class="kd">const</span> <span class="nx">handler</span><span class="p">:</span> <span class="nx">DefineAuthChallengeTriggerHandler</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="k">if</span> <span class="p">(</span><span class="nx">notCustomChallenge</span><span class="p">(</span><span class="nx">event</span><span class="p">))</span> <span class="p">{</span>\n    <span class="c1">// We only accept custom challenges; fail auth</span>\n    <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">issueTokens</span> <span class="o">=</span> <span class="kc">false</span>\n    <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">failAuthentication</span> <span class="o">=</span> <span class="kc">true</span>\n  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">tooManyFailedAttempts</span><span class="p">(</span><span class="nx">event</span><span class="p">))</span> <span class="p">{</span>\n    <span class="c1">// The user provided a wrong answer 3 times; fail auth</span>\n    <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">issueTokens</span> <span class="o">=</span> <span class="kc">false</span>\n    <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">failAuthentication</span> <span class="o">=</span> <span class="kc">true</span>\n  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">successfulAnswer</span><span class="p">(</span><span class="nx">event</span><span class="p">))</span> <span class="p">{</span>\n    <span class="c1">// The user provided the right answer; succeed auth</span>\n    <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">issueTokens</span> <span class="o">=</span> <span class="kc">true</span>\n    <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">failAuthentication</span> <span class="o">=</span> <span class="kc">false</span>\n  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>\n    <span class="c1">// The user did not provide a correct answer yet; present challenge</span>\n    <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">issueTokens</span> <span class="o">=</span> <span class="kc">false</span>\n    <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">failAuthentication</span> <span class="o">=</span> <span class="kc">false</span>\n    <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">challengeName</span> <span class="o">=</span> <span class="dl">\'</span><span class="s1">CUSTOM_CHALLENGE</span><span class="dl">\'</span>\n  <span class="p">}</span>\n\n  <span class="k">return</span> <span class="nx">event</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>This function checks for four things:</p>\n\n<ol>\n<li>If the challenge was not a custom challenge, then fail the authentication process as our sign-in link only works with a custom challenge.</li>\n<li>If the user has already made three attempts at the incorrect answer i.e. if the link was tampered with, fail the auth.</li>\n<li>If the answer was successful, issue the tokens which means that the user will login successfully.</li>\n<li>If all of the above conditions don\'t match, it means that the user hasn\'t got the link yet so set the challenge and wait for the user to click the sign-in link.</li>\n</ol>\n\n<p>Think of this as the pre-validation function. It will check the parameters before we validate the link and return <code>event</code> with the appropriate values.</p>\n\n<ul>\n<li><strong><code>verifyAuthChallengeResponse</code></strong></li>\n</ul>\n\n<p>This is the main function that verifies the link opened by the user. We call the <code>sendCustomChallengeAnswer</code> method from the <a href="https://docs.amplify.aws/lib/auth/emailpassword/q/platform/js">Amplify JS library</a> that would internally call this Lambda.<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="c1">// packages/backend/functions/verifyAuthChallenge.ts</span>\n\n<span class="kd">const</span> <span class="nx">MAGIC_LINK_TIMEOUT</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span>\n\n<span class="k">export</span> <span class="kd">const</span> <span class="nx">handler</span><span class="p">:</span> <span class="nx">VerifyAuthChallengeResponseTriggerHandler</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span>\n  <span class="nx">event</span>\n<span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="kd">const</span> <span class="p">[</span><span class="nx">authChallenge</span><span class="p">,</span> <span class="nx">timestamp</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>\n    <span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">privateChallengeParameters</span><span class="p">.</span><span class="nx">challenge</span> <span class="o">||</span> <span class="dl">\'\'</span>\n  <span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="dl">\'</span><span class="s1">,</span><span class="dl">\'</span><span class="p">)</span>\n\n  <span class="c1">// fail if any one of the parameters is missing</span>\n  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">authChallenge</span> <span class="o">||</span> <span class="o">!</span><span class="nx">timestamp</span><span class="p">)</span> <span class="p">{</span>\n    <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">answerCorrect</span> <span class="o">=</span> <span class="kc">false</span>\n    <span class="k">return</span> <span class="nx">event</span>\n  <span class="p">}</span>\n\n  <span class="c1">// is the correct challenge and is not expired</span>\n  <span class="k">if</span> <span class="p">(</span>\n    <span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">challengeAnswer</span> <span class="o">===</span> <span class="nx">authChallenge</span> <span class="o">&amp;&amp;</span>\n    <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">timestamp</span><span class="p">)</span> <span class="o">+</span> <span class="nx">MAGIC_LINK_TIMEOUT</span>\n  <span class="p">)</span> <span class="p">{</span>\n    <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">answerCorrect</span> <span class="o">=</span> <span class="kc">true</span>\n    <span class="k">return</span> <span class="nx">event</span>\n  <span class="p">}</span>\n\n  <span class="nx">event</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">answerCorrect</span> <span class="o">=</span> <span class="kc">false</span>\n  <span class="k">return</span> <span class="nx">event</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>Here, we set the validity of our link to be <strong>3 minutes</strong>. We then check if the <code>authChallenge</code> (secret code) and timestamp are available and fail if they are missing.</p>\n\n<p>In the next step, we verify if the link has the correct code (not tampered in any way) and the user has opened the link in time. If that\'s valid, we set the <code>answerCorrect</code> property to <code>true</code> which means that the user can successfully sign-in. If not, we will show a nice error message in the UI stating that the sign-in link was invalid.</p>\n\n<ul>\n<li><strong><code>postAuthentication</code></strong></li>\n</ul>\n\n<p>This is the final function which will be called after a user has been successfully authenticated.<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="c1">// packages/backend/functions/postAuthentication.ts</span>\n\n<span class="k">import</span> <span class="p">{</span> <span class="nx">CognitoIdentityServiceProvider</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">\'</span><span class="s1">aws-sdk</span><span class="dl">\'</span>\n\n<span class="kd">const</span> <span class="nx">cisp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CognitoIdentityServiceProvider</span><span class="p">()</span>\n\n<span class="k">export</span> <span class="kd">const</span> <span class="nx">handler</span><span class="p">:</span> <span class="nx">PostAuthenticationTriggerHandler</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">userAttributes</span><span class="p">?.</span><span class="nx">email_verified</span> <span class="o">!==</span> <span class="dl">\'</span><span class="s1">true</span><span class="dl">\'</span><span class="p">)</span> <span class="p">{</span>\n    <span class="k">await</span> <span class="nx">cisp</span>\n      <span class="p">.</span><span class="nx">adminUpdateUserAttributes</span><span class="p">({</span>\n        <span class="na">UserPoolId</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">userPoolId</span><span class="p">,</span>\n        <span class="na">UserAttributes</span><span class="p">:</span> <span class="p">[</span>\n          <span class="p">{</span>\n            <span class="na">Name</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">email_verified</span><span class="dl">\'</span><span class="p">,</span>\n            <span class="na">Value</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">true</span><span class="dl">\'</span><span class="p">,</span>\n          <span class="p">},</span>\n        <span class="p">],</span>\n        <span class="na">Username</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">userName</span><span class="p">,</span>\n      <span class="p">})</span>\n      <span class="p">.</span><span class="nx">promise</span><span class="p">()</span>\n  <span class="p">}</span>\n  <span class="k">return</span> <span class="nx">event</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>We check if the user\'s email is verified and if it isn\'t, we verify it using the <code>adminUpdateUserAttributes</code> method from <code>CognitoIdentityServiceProvider</code>.</p>\n\n<p>This was the entire flow of validating the link sent to the user and signing them in without a password.</p>\n\n<p>You must be wondering that we have covered all this but where do we send the email to user with the sign-in link? For this, we will be creating a <code>signIn</code> API using API Gateway and Lambda proxy which will use <code>SES</code> to send an email to the user.</p>\n<h3>\n  <a name="api" href="#api">\n  </a>\n  API\n</h3>\n\n<p>Let\'s start with creating the resources for API Gateway and its method.<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="c1">// packages/backend/lib/passwordless-login-stack.ts</span>\n\n<span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">apiGw</span><span class="p">.</span><span class="nx">RestApi</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">\'</span><span class="s1">authApi</span><span class="dl">\'</span><span class="p">,</span> <span class="p">{</span>\n  <span class="na">endpointConfiguration</span><span class="p">:</span> <span class="p">{</span> <span class="na">types</span><span class="p">:</span> <span class="p">[</span><span class="nx">apiGw</span><span class="p">.</span><span class="nx">EndpointType</span><span class="p">.</span><span class="nx">REGIONAL</span><span class="p">]</span> <span class="p">},</span>\n  <span class="na">defaultCorsPreflightOptions</span><span class="p">:</span> <span class="p">{</span> <span class="na">allowOrigins</span><span class="p">:</span> <span class="p">[</span><span class="dl">\'</span><span class="s1">*</span><span class="dl">\'</span><span class="p">]</span> <span class="p">},</span>\n  <span class="na">deployOptions</span><span class="p">:</span> <span class="p">{</span> <span class="na">stageName</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">dev</span><span class="dl">\'</span> <span class="p">},</span>\n<span class="p">})</span>\n\n<span class="kd">const</span> <span class="nx">signInMethod</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">apiGw</span><span class="p">.</span><span class="nx">LambdaIntegration</span><span class="p">(</span><span class="nx">signIn</span><span class="p">)</span>\n<span class="nx">api</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">addMethod</span><span class="p">(</span><span class="dl">\'</span><span class="s1">POST</span><span class="dl">\'</span><span class="p">,</span> <span class="nx">signInMethod</span><span class="p">)</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>This snippet creates a REST API with Lambda Proxy integration and a function named <code>signIn</code>. This will be added as on the <code>POST</code> method of our endpoint. We will be passing the <code>email</code> in the body of this request.</p>\n\n<p>The Lambda resource would look something like this:<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="c1">// packages/backend/lib/passwordless-login-stack.ts</span>\n\n<span class="kd">const</span> <span class="nx">signIn</span> <span class="o">=</span> <span class="nx">lambda</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">\'</span><span class="s1">signIn</span><span class="dl">\'</span><span class="p">)</span>\n  <span class="p">.</span><span class="nx">addEnvironment</span><span class="p">(</span><span class="dl">\'</span><span class="s1">SES_FROM_ADDRESS</span><span class="dl">\'</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SES_FROM_ADDRESS</span><span class="p">)</span>\n  <span class="p">.</span><span class="nx">addEnvironment</span><span class="p">(</span><span class="dl">\'</span><span class="s1">USER_POOL_ID</span><span class="dl">\'</span><span class="p">,</span> <span class="nx">userPool</span><span class="p">.</span><span class="nx">userPoolId</span><span class="p">)</span>\n\n<span class="nx">signIn</span><span class="p">.</span><span class="nx">addToRolePolicy</span><span class="p">(</span>\n<span class="k">new</span> <span class="nx">iam</span><span class="p">.</span><span class="nx">PolicyStatement</span><span class="p">({</span>\n  <span class="na">effect</span><span class="p">:</span> <span class="nx">iam</span><span class="p">.</span><span class="nx">Effect</span><span class="p">.</span><span class="nx">ALLOW</span><span class="p">,</span>\n  <span class="na">actions</span><span class="p">:</span> <span class="p">[</span><span class="dl">\'</span><span class="s1">ses:SendEmail</span><span class="dl">\'</span><span class="p">],</span>\n  <span class="na">resources</span><span class="p">:</span> <span class="p">[</span><span class="dl">\'</span><span class="s1">*</span><span class="dl">\'</span><span class="p">],</span>\n<span class="p">})</span>\n<span class="p">)</span>\n\n<span class="nx">signIn</span><span class="p">.</span><span class="nx">addToRolePolicy</span><span class="p">(</span>\n<span class="k">new</span> <span class="nx">iam</span><span class="p">.</span><span class="nx">PolicyStatement</span><span class="p">({</span>\n  <span class="na">effect</span><span class="p">:</span> <span class="nx">iam</span><span class="p">.</span><span class="nx">Effect</span><span class="p">.</span><span class="nx">ALLOW</span><span class="p">,</span>\n  <span class="na">actions</span><span class="p">:</span> <span class="p">[</span><span class="dl">\'</span><span class="s1">cognito-idp:AdminUpdateUserAttributes</span><span class="dl">\'</span><span class="p">],</span>\n  <span class="na">resources</span><span class="p">:</span> <span class="p">[</span><span class="nx">userPool</span><span class="p">.</span><span class="nx">userPoolArn</span><span class="p">],</span>\n<span class="p">})</span>\n<span class="p">)</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>Here, we are creating a function that needs two environment variables, one for sending the email and the other for updating the <code>authChallenge</code> (secret) in our user\'s custom attribute.</p>\n\n<p>Due the these operations, we would also need to add permissions for SES and Cognito. The permissions <code>sendEmail</code> and <code>AdminUpdateUserAttributes</code> are for sending the email and updating the custom attribute respectively.</p>\n\n<p>Now let\'s have a look at what the Lambda function contains:<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="c1">// packages/backend/functions/signIn.ts</span>\n\n<span class="kd">const</span> <span class="nx">cisp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CognitoIdentityServiceProvider</span><span class="p">()</span>\n<span class="kd">const</span> <span class="nx">ses</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SES</span><span class="p">({</span> <span class="na">region</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_REGION</span> <span class="p">})</span>\n\n<span class="k">export</span> <span class="kd">const</span> <span class="nx">handler</span><span class="p">:</span> <span class="nx">APIGatewayProxyHandler</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="k">try</span> <span class="p">{</span>\n    <span class="kd">const</span> <span class="p">{</span> <span class="nx">email</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">body</span> <span class="o">||</span> <span class="dl">\'</span><span class="s1">{}</span><span class="dl">\'</span><span class="p">)</span>\n    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">email</span><span class="p">)</span> <span class="k">throw</span> <span class="nb">Error</span><span class="p">()</span>\n\n    <span class="c1">// set the code in custom attributes</span>\n    <span class="kd">const</span> <span class="nx">authChallenge</span> <span class="o">=</span> <span class="nx">randomDigits</span><span class="p">(</span><span class="mi">6</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="dl">\'\'</span><span class="p">)</span>\n    <span class="k">await</span> <span class="nx">cisp</span>\n      <span class="p">.</span><span class="nx">adminUpdateUserAttributes</span><span class="p">({</span>\n        <span class="na">UserAttributes</span><span class="p">:</span> <span class="p">[</span>\n          <span class="p">{</span>\n            <span class="na">Name</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">custom:authChallenge</span><span class="dl">\'</span><span class="p">,</span>\n            <span class="na">Value</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">authChallenge</span><span class="p">}</span><span class="s2">,</span><span class="p">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()}</span><span class="s2">`</span><span class="p">,</span>\n          <span class="p">},</span>\n        <span class="p">],</span>\n        <span class="na">UserPoolId</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">USER_POOL_ID</span><span class="p">,</span>\n        <span class="na">Username</span><span class="p">:</span> <span class="nx">email</span><span class="p">,</span>\n      <span class="p">})</span>\n      <span class="p">.</span><span class="nx">promise</span><span class="p">()</span>\n\n    <span class="k">await</span> <span class="nx">sendEmail</span><span class="p">(</span><span class="nx">email</span><span class="p">,</span> <span class="nx">authChallenge</span><span class="p">)</span>\n\n    <span class="k">return</span> <span class="p">{</span>\n      <span class="na">statusCode</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>\n      <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>\n        <span class="dl">\'</span><span class="s1">Access-Control-Allow-Origin</span><span class="dl">\'</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">*</span><span class="dl">\'</span><span class="p">,</span>\n      <span class="p">},</span>\n      <span class="na">body</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>\n        <span class="na">message</span><span class="p">:</span> <span class="s2">`A link has been sent to </span><span class="p">${</span><span class="nx">email</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>\n      <span class="p">}),</span>\n    <span class="p">}</span>\n  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>\n    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>\n    <span class="k">return</span> <span class="p">{</span>\n      <span class="na">statusCode</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>\n      <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>\n        <span class="dl">\'</span><span class="s1">Access-Control-Allow-Origin</span><span class="dl">\'</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">*</span><span class="dl">\'</span><span class="p">,</span>\n      <span class="p">},</span>\n      <span class="na">body</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>\n        <span class="na">message</span><span class="p">:</span> <span class="s2">`Couldn\'t process the request. Please try after some time.`</span><span class="p">,</span>\n      <span class="p">}),</span>\n    <span class="p">}</span>\n  <span class="p">}</span>\n<span class="p">}</span>\n\n<span class="kd">const</span> <span class="nx">BASE_URL</span> <span class="o">=</span> <span class="s2">`http://localhost:3000/verify`</span>\n\n<span class="k">async</span> <span class="kd">function</span> <span class="nx">sendEmail</span><span class="p">(</span><span class="nx">emailAddress</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">authChallenge</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>\n  <span class="kd">const</span> <span class="nx">MAGIC_LINK</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">BASE_URL</span><span class="p">}</span><span class="s2">?email=</span><span class="p">${</span><span class="nx">emailAddress</span><span class="p">}</span><span class="s2">&amp;code=</span><span class="p">${</span><span class="nx">authChallenge</span><span class="p">}</span><span class="s2">`</span>\n\n  <span class="kd">const</span> <span class="nx">html</span> <span class="o">=</span> <span class="s2">`\n    &lt;html&gt;&lt;body&gt;\n    &lt;p&gt;Here\'s your link:&lt;/p&gt;\n    &lt;h3&gt;\n      &lt;a target="_blank" rel="noopener noreferrer" href="</span><span class="p">${</span><span class="nx">MAGIC_LINK</span><span class="p">}</span><span class="s2">"&gt;Click to sign-in&lt;/a&gt;\n    &lt;/h3&gt;\n    &lt;/body&gt;&lt;/html&gt;\n  `</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span>\n\n  <span class="kd">const</span> <span class="nx">params</span><span class="p">:</span> <span class="nx">SES</span><span class="p">.</span><span class="nx">SendEmailRequest</span> <span class="o">=</span> <span class="p">{</span>\n    <span class="na">Destination</span><span class="p">:</span> <span class="p">{</span> <span class="na">ToAddresses</span><span class="p">:</span> <span class="p">[</span><span class="nx">emailAddress</span><span class="p">]</span> <span class="p">},</span>\n    <span class="na">Message</span><span class="p">:</span> <span class="p">{</span>\n      <span class="na">Body</span><span class="p">:</span> <span class="p">{</span>\n        <span class="na">Html</span><span class="p">:</span> <span class="p">{</span>\n          <span class="na">Charset</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">UTF-8</span><span class="dl">\'</span><span class="p">,</span>\n          <span class="na">Data</span><span class="p">:</span> <span class="nx">html</span><span class="p">,</span>\n        <span class="p">},</span>\n        <span class="na">Text</span><span class="p">:</span> <span class="p">{</span>\n          <span class="na">Charset</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">UTF-8</span><span class="dl">\'</span><span class="p">,</span>\n          <span class="na">Data</span><span class="p">:</span> <span class="s2">`Here\'s your link (copy and paste in the browser): </span><span class="p">${</span><span class="nx">MAGIC_LINK</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>\n        <span class="p">},</span>\n      <span class="p">},</span>\n      <span class="na">Subject</span><span class="p">:</span> <span class="p">{</span>\n        <span class="na">Charset</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">UTF-8</span><span class="dl">\'</span><span class="p">,</span>\n        <span class="na">Data</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">Login link</span><span class="dl">\'</span><span class="p">,</span>\n      <span class="p">},</span>\n    <span class="p">},</span>\n    <span class="na">Source</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SES_FROM_ADDRESS</span><span class="p">,</span>\n  <span class="p">}</span>\n  <span class="k">await</span> <span class="nx">ses</span><span class="p">.</span><span class="nx">sendEmail</span><span class="p">(</span><span class="nx">params</span><span class="p">).</span><span class="nx">promise</span><span class="p">()</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>First, we create a cryptographically random secret that will be inserted in the sign-up link. We set the secret and the creation timestamp in the user\'s custom attribute. Finally, we call the <code>sendEmail</code> method that accepts the secret and email of the user trying to sign in.</p>\n\n<p>We created a <code>BASE_URL</code> constant that will actually to be the link to our webapp set to <code>localhost</code> currently for development. We then construct the magic link as follows:<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="kd">const</span> <span class="nx">MAGIC_LINK</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">BASE_URL</span><span class="p">}</span><span class="s2">?email=</span><span class="p">${</span><span class="nx">emailAddress</span><span class="p">}</span><span class="s2">&amp;code=</span><span class="p">${</span><span class="nx">authChallenge</span><span class="p">}</span><span class="s2">`</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>This will append the <code>email</code> and <code>code</code> as querystring params which we be fetching in our webapp to validate the sign-in request. The final part is just constructing the email to be sent where we embed the link and the user can directly click the link to open it in the browser.</p>\n<h3>\n  <a name="deploying-the-stack" href="#deploying-the-stack">\n  </a>\n  Deploying the stack\n</h3>\n\n<p>The final step to add in our stack is outputs that our webapp will use to perform authentication against the User Pool. This is done using the <a href="https://docs.amplify.aws/lib/auth/getting-started/q/platform/js">Amplify JS library</a>.<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="k">new</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">CfnOutput</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">\'</span><span class="s1">userPoolId</span><span class="dl">\'</span><span class="p">,</span> <span class="p">{</span>\n  <span class="na">value</span><span class="p">:</span> <span class="nx">userPool</span><span class="p">.</span><span class="nx">userPoolId</span><span class="p">,</span>\n<span class="p">})</span>\n\n<span class="k">new</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">CfnOutput</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="dl">\'</span><span class="s1">clientId</span><span class="dl">\'</span><span class="p">,</span> <span class="p">{</span>\n  <span class="na">value</span><span class="p">:</span> <span class="nx">webClient</span><span class="p">.</span><span class="nx">userPoolClientId</span><span class="p">,</span>\n<span class="p">})</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>We set the <code>userPoolId</code> and <code>clientId</code> to be used by Amplify. CDK <strong>automatically outputs</strong> the API Gateway endpoint URL so we don\'t need to add it explicitly. Sweet!</p>\n\n<p>Now let\'s deploy the stack! As we are using workspaces, we need to run the <code>deploy</code> command in the backend workspace.<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>yarn workspace backend cdk deploy\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>As an alternative, you can also move to the <code>backend</code> directory and simply run <code>yarn cdk deploy</code>.</p>\n\n<p>This will deploy all our resources and create a JSON file with the outputs in our <code>frontend/src</code> folder. We generate the outputs file in the <code>frontend/src</code> folder on purpose as we need to use this in our React app. This app is created using <a href="https://reactjs.org/docs/create-a-new-react-app.html">create-react-app</a>.</p>\n\n<p><strong><em>Note</em></strong>: You will need to edit the URL key the <a href="https://github.com/ryands17/passwordless-auth/blob/main/packages/frontend/src/config/api.ts">api</a> file before proceeding further as CDK will generate a new resource name for your stack.</p>\n<h3>\n  <a name="testing-the-login-flow" href="#testing-the-login-flow">\n  </a>\n  Testing the login flow\n</h3>\n\n<p>After successful deployment, we can run the webapp locally to test the login flow using the following command:<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>yarn workspace frontend dev\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>This will fire up the app on <a href="http://localhost:3000/">http://localhost:3000/</a> and will redirect to the <code>signIn</code> page as we aren\'t currently authenticated.</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--jM9vKrUG--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/t9wbs7ix4f05eyoye4ai.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--jM9vKrUG--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/t9wbs7ix4f05eyoye4ai.png" alt="Sign-in page that accepts an email" loading="lazy"></a></p>\n\n<p>On adding our email address here, we will get a link on our email address.</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--m5MRFh3A--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/52s0el1i9frcxs5tuzbs.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--m5MRFh3A--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/52s0el1i9frcxs5tuzbs.png" alt="Link sent successfully" loading="lazy"></a></p>\n\n<p>Here\'s the link I received that includes the email and authChallenge (secret).</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--MkVpa7jt--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/d4jfxeoaz7m6zumsg0wl.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--MkVpa7jt--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/d4jfxeoaz7m6zumsg0wl.png" alt="Email received with the sign-in link" loading="lazy"></a></p>\n\n<p>On clicking the link, a verify page is opened that will perform the sign-in and call the <code>sendCustomChallengeAnswer</code> method which will successfully verify the user and be redirected to the home page :)</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--_sM4nTxk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jcqdzadh8i7qpnom2b9a.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--_sM4nTxk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jcqdzadh8i7qpnom2b9a.png" alt="Home page after successfully signing in" loading="lazy"></a></p>\n<h2>\n  <a name="conclusion" href="#conclusion">\n  </a>\n  Conclusion\n</h2>\n\n<p>So that was it! This is how we can perform a truly Passwordless sign-in with Cognito. Here\'s the repo again for those who would like to experiment:</p>\n\n\n<div class="ltag-github-readme-tag">\n  <div class="readme-overview">\n    <h2>\n      <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--i3JOwpme--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/github-logo-ba8488d21cd8ee1fee097b8410db9deaa41d0ca30b004c0c63de0a479114156f.svg" alt="GitHub logo" loading="lazy">\n      <a href="https://github.com/ryands17">\n        ryands17\n      </a> / <a style="font-weight: 600;" href="https://github.com/ryands17/passwordless-auth">\n        passwordless-auth\n      </a>\n    </h2>\n    <h3>\n      Allows a user to login directly via email without a need for entering passwords using Cognito\n    </h3>\n  </div>\n</div>\n\n\n\n<p>Also don\'t forget to <strong>destroy this stack</strong> so that you do not incur unnecessary charges using the following command:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>yarn workspace backend cdk destroy\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>The resources I used to help create this are:</p>\n\n<p><a href="https://aws.amazon.com/blogs/mobile/implementing-passwordless-email-authentication-with-amazon-cognito/">https://aws.amazon.com/blogs/mobile/implementing-passwordless-email-authentication-with-amazon-cognito/</a></p>\n\n<p><a href="https://schof.co/cognito-magic-links/">https://schof.co/cognito-magic-links/</a></p>\n\n<p>Thanks for reading this and I would love to hear your thoughts on this in the comments! If you liked this post, do give it a like and share, and follow me on <a href="https://twitter.com/ryands1701">Twitter</a>. Until next time!</p>\n\n',n.body_markdown="## This is a post on how to perform Passwordless authentication ðŸª„ using Cognito. The resources will be created using the CDK (TypeScript).\n\nThe basic workflow in this would be:\n\n1. User enters their email on the sign-in page.\n2. We create a user in Cognito and store the secret/auth-challenge along with the creation timestamp.\n3. We construct a link to our webapp with the user's email and secret and email it to them\n4. Finally, when they open the sign-in link, we verify the secret + expiration and authenticate the user.\n\n## Prerequisites\n\nTo follow along, I would suggest cloning the repo and installing the dependencies using `yarn`.\n\n{% github ryands17/passwordless-auth no-readme %}\n\n__*Note*__: This is a [monorepo](https://en.wikipedia.org/wiki/Monorepo) that has both the backend resources and simple UI to sign-in. This will be located in the `packages` folder under `backend` and `frontend` respectively.\n\n## Constructs\n\nLet's have a look at the constructs required to make this work.\n\n### Cognito User Pool and App Client\n\nWe need to create a Cognito User Pool and App Client that will help us register the users and execute our sign in flow.\n\n```ts\n// packages/backend/lib/passwordless-login-stack.ts\n\nimport * as cg from '@aws-cdk/aws-cognito'\n\nconst userPool = new cg.UserPool(this, 'users', {\n  standardAttributes: { email: { required: true, mutable: true } },\n  customAttributes: {\n    authChallenge: new cg.StringAttribute({ mutable: true }),\n  },\n  passwordPolicy: {\n    requireDigits: false,\n    requireUppercase: false,\n    requireSymbols: false,\n  },\n  accountRecovery: cg.AccountRecovery.NONE,\n  selfSignUpEnabled: true,\n  signInAliases: { email: true },\n  lambdaTriggers: {\n    preSignUp: lambda(this, 'preSignup'),\n    createAuthChallenge: lambda(this, 'createAuthChallenge'),\n    defineAuthChallenge: lambda(this, 'defineAuthChallenge'),\n    verifyAuthChallengeResponse: lambda(this, 'verifyAuthChallenge'),\n    postAuthentication,\n  },\n  removalPolicy: cdk.RemovalPolicy.DESTROY,\n})\n\nconst webClient = userPool.addClient('webAppClient', {\n  authFlows: { custom: true },\n})\n```\n\nFirst, we create a _UserPool_. This will have a standard attribute `email` that we will use for signing up and so is required. We have also specified a custom attribute that will be used to store the authentication challenge code along with the current timestamp.\n\nWe disable all password policies because we will not be using it. We also disable account recovery and set `email` as an alias so signing in can be done via the `email`. There are some `lambdaTriggers` that we will be discussing in the next section.\n\nFor sending emails, you need to [verify your email address in SES](https://docs.aws.amazon.com/ses/latest/DeveloperGuide/verify-email-addresses.html) as we are using SES in Sandbox mode.\n\nWe then create a `client` where we enable a custom auth flow. This is needed because we won't be using a username/password flow but sending a sign-in link which is technically a custom authentication flow in Cognito.\n\n### Lambda triggers\n\nLet's have a look at all the triggers used in the `lambdaTriggers` section:\n\n- **`preSignUp`**\n\nThis function will be called when we signup the user after they enter their email.\n\n```ts\n// packages/backend/functions/preSignup.ts\n\nexport const handler: PreSignUpTriggerHandler = async (event) => {\n  event.response.autoConfirmUser = true\n  return event\n}\n```\n\nWhat we do here is confirm the user so that we don't need to verify them on signup. Cognito's default flow needs a user to be verified on signup and that would defeat the purpose of a link based sign-in workflow.\n\n- **`createAuthChallenge`**\n\nThis function will create the challenge and set the public and private challenge parameters respectively.\n\n```ts\n// packages/backend/functions/createAuthChallenge.ts\n\nexport const handler: CreateAuthChallengeTriggerHandler = async (event) => {\n  // This is sent back to the client app\n  event.response.publicChallengeParameters = {\n    email: event.request.userAttributes.email,\n  }\n\n  // Add the secret login code to the private challenge parameters\n  // so it can be verified by the \"Verify Auth Challenge Response\" trigger\n  event.response.privateChallengeParameters = {\n    challenge: event.request.userAttributes['custom:authChallenge'],\n  }\n\n  return event\n}\n```\n\nThe public challenge parameter i.e. the `email` will be sent to the user whereas the private challenge parameter i.e. our secret will be added to the event which will be used to verify from the sign-in link later on.\n\n- **`defineAuthChallenge`**\n\nThis function checks if the parameters for our Passwordless auth (Cognito's custom challenge) are correct. \n\n__*Note*__: I haven't included the functions used here to keep the code concise but you can easily view them [here](https://github.com/ryands17/passwordless-auth/blob/main/packages/backend/functions/defineAuthChallenge.ts#L29-L44) or in the file mentioned in the comments if you have cloned the repo :)\n\n```ts\n// packages/backend/functions/defineAuthChallenge.ts\n\nexport const handler: DefineAuthChallengeTriggerHandler = async (event) => {\n  if (notCustomChallenge(event)) {\n    // We only accept custom challenges; fail auth\n    event.response.issueTokens = false\n    event.response.failAuthentication = true\n  } else if (tooManyFailedAttempts(event)) {\n    // The user provided a wrong answer 3 times; fail auth\n    event.response.issueTokens = false\n    event.response.failAuthentication = true\n  } else if (successfulAnswer(event)) {\n    // The user provided the right answer; succeed auth\n    event.response.issueTokens = true\n    event.response.failAuthentication = false\n  } else {\n    // The user did not provide a correct answer yet; present challenge\n    event.response.issueTokens = false\n    event.response.failAuthentication = false\n    event.response.challengeName = 'CUSTOM_CHALLENGE'\n  }\n\n  return event\n}\n```\n\nThis function checks for four things:\n\n1. If the challenge was not a custom challenge, then fail the authentication process as our sign-in link only works with a custom challenge.\n2. If the user has already made three attempts at the incorrect answer i.e. if the link was tampered with, fail the auth.\n3. If the answer was successful, issue the tokens which means that the user will login successfully.\n4. If all of the above conditions don't match, it means that the user hasn't got the link yet so set the challenge and wait for the user to click the sign-in link.\n\nThink of this as the pre-validation function. It will check the parameters before we validate the link and return `event` with the appropriate values.\n\n- **`verifyAuthChallengeResponse`**\n\nThis is the main function that verifies the link opened by the user. We call the `sendCustomChallengeAnswer` method from the [Amplify JS library](https://docs.amplify.aws/lib/auth/emailpassword/q/platform/js) that would internally call this Lambda.\n\n```ts\n// packages/backend/functions/verifyAuthChallenge.ts\n\nconst MAGIC_LINK_TIMEOUT = 3 * 60 * 1000\n\nexport const handler: VerifyAuthChallengeResponseTriggerHandler = async (\n  event\n) => {\n  const [authChallenge, timestamp] = (\n    event.request.privateChallengeParameters.challenge || ''\n  ).split(',')\n\n  // fail if any one of the parameters is missing\n  if (!authChallenge || !timestamp) {\n    event.response.answerCorrect = false\n    return event\n  }\n\n  // is the correct challenge and is not expired\n  if (\n    event.request.challengeAnswer === authChallenge &&\n    Date.now() <= Number(timestamp) + MAGIC_LINK_TIMEOUT\n  ) {\n    event.response.answerCorrect = true\n    return event\n  }\n\n  event.response.answerCorrect = false\n  return event\n}\n```\n\nHere, we set the validity of our link to be **3 minutes**. We then check if the `authChallenge` (secret code) and timestamp are available and fail if they are missing.\n\nIn the next step, we verify if the link has the correct code (not tampered in any way) and the user has opened the link in time. If that's valid, we set the `answerCorrect` property to `true` which means that the user can successfully sign-in. If not, we will show a nice error message in the UI stating that the sign-in link was invalid.\n\n- **`postAuthentication`**\n\nThis is the final function which will be called after a user has been successfully authenticated.\n\n```ts\n// packages/backend/functions/postAuthentication.ts\n\nimport { CognitoIdentityServiceProvider } from 'aws-sdk'\n\nconst cisp = new CognitoIdentityServiceProvider()\n\nexport const handler: PostAuthenticationTriggerHandler = async (event) => {\n  if (event.request.userAttributes?.email_verified !== 'true') {\n    await cisp\n      .adminUpdateUserAttributes({\n        UserPoolId: event.userPoolId,\n        UserAttributes: [\n          {\n            Name: 'email_verified',\n            Value: 'true',\n          },\n        ],\n        Username: event.userName,\n      })\n      .promise()\n  }\n  return event\n}\n```\n\nWe check if the user's email is verified and if it isn't, we verify it using the `adminUpdateUserAttributes` method from `CognitoIdentityServiceProvider`.\n\nThis was the entire flow of validating the link sent to the user and signing them in without a password.\n\nYou must be wondering that we have covered all this but where do we send the email to user with the sign-in link? For this, we will be creating a `signIn` API using API Gateway and Lambda proxy which will use `SES` to send an email to the user.\n\n### API\n\nLet's start with creating the resources for API Gateway and its method.\n\n```ts\n// packages/backend/lib/passwordless-login-stack.ts\n\nconst api = new apiGw.RestApi(this, 'authApi', {\n  endpointConfiguration: { types: [apiGw.EndpointType.REGIONAL] },\n  defaultCorsPreflightOptions: { allowOrigins: ['*'] },\n  deployOptions: { stageName: 'dev' },\n})\n\nconst signInMethod = new apiGw.LambdaIntegration(signIn)\napi.root.addMethod('POST', signInMethod)\n```\n\nThis snippet creates a REST API with Lambda Proxy integration and a function named `signIn`. This will be added as on the `POST` method of our endpoint. We will be passing the `email` in the body of this request.\n\nThe Lambda resource would look something like this:\n\n```ts\n// packages/backend/lib/passwordless-login-stack.ts\n\nconst signIn = lambda(this, 'signIn')\n  .addEnvironment('SES_FROM_ADDRESS', process.env.SES_FROM_ADDRESS)\n  .addEnvironment('USER_POOL_ID', userPool.userPoolId)\n\nsignIn.addToRolePolicy(\nnew iam.PolicyStatement({\n  effect: iam.Effect.ALLOW,\n  actions: ['ses:SendEmail'],\n  resources: ['*'],\n})\n)\n\nsignIn.addToRolePolicy(\nnew iam.PolicyStatement({\n  effect: iam.Effect.ALLOW,\n  actions: ['cognito-idp:AdminUpdateUserAttributes'],\n  resources: [userPool.userPoolArn],\n})\n)\n```\n\nHere, we are creating a function that needs two environment variables, one for sending the email and the other for updating the `authChallenge` (secret) in our user's custom attribute.\n\nDue the these operations, we would also need to add permissions for SES and Cognito. The permissions `sendEmail` and `AdminUpdateUserAttributes` are for sending the email and updating the custom attribute respectively.\n\nNow let's have a look at what the Lambda function contains:\n\n```ts\n// packages/backend/functions/signIn.ts\n\nconst cisp = new CognitoIdentityServiceProvider()\nconst ses = new SES({ region: process.env.AWS_REGION })\n\nexport const handler: APIGatewayProxyHandler = async (event) => {\n  try {\n    const { email } = JSON.parse(event.body || '{}')\n    if (!email) throw Error()\n\n    // set the code in custom attributes\n    const authChallenge = randomDigits(6).join('')\n    await cisp\n      .adminUpdateUserAttributes({\n        UserAttributes: [\n          {\n            Name: 'custom:authChallenge',\n            Value: `${authChallenge},${Date.now()}`,\n          },\n        ],\n        UserPoolId: process.env.USER_POOL_ID,\n        Username: email,\n      })\n      .promise()\n\n    await sendEmail(email, authChallenge)\n\n    return {\n      statusCode: 200,\n      headers: {\n        'Access-Control-Allow-Origin': '*',\n      },\n      body: JSON.stringify({\n        message: `A link has been sent to ${email}`,\n      }),\n    }\n  } catch (e) {\n    console.error(e)\n    return {\n      statusCode: 400,\n      headers: {\n        'Access-Control-Allow-Origin': '*',\n      },\n      body: JSON.stringify({\n        message: `Couldn't process the request. Please try after some time.`,\n      }),\n    }\n  }\n}\n\nconst BASE_URL = `http://localhost:3000/verify`\n\nasync function sendEmail(emailAddress: string, authChallenge: string) {\n  const MAGIC_LINK = `${BASE_URL}?email=${emailAddress}&code=${authChallenge}`\n\n  const html = `\n    <html><body>\n    <p>Here's your link:</p>\n    <h3>\n      <a target=\"_blank\" rel=\"noopener noreferrer\" href=\"${MAGIC_LINK}\">Click to sign-in</a>\n    </h3>\n    </body></html>\n  `.trim()\n\n  const params: SES.SendEmailRequest = {\n    Destination: { ToAddresses: [emailAddress] },\n    Message: {\n      Body: {\n        Html: {\n          Charset: 'UTF-8',\n          Data: html,\n        },\n        Text: {\n          Charset: 'UTF-8',\n          Data: `Here's your link (copy and paste in the browser): ${MAGIC_LINK}`,\n        },\n      },\n      Subject: {\n        Charset: 'UTF-8',\n        Data: 'Login link',\n      },\n    },\n    Source: process.env.SES_FROM_ADDRESS,\n  }\n  await ses.sendEmail(params).promise()\n}\n```\n\nFirst, we create a cryptographically random secret that will be inserted in the sign-up link. We set the secret and the creation timestamp in the user's custom attribute. Finally, we call the `sendEmail` method that accepts the secret and email of the user trying to sign in.\n\nWe created a `BASE_URL` constant that will actually to be the link to our webapp set to `localhost` currently for development. We then construct the magic link as follows:\n\n```ts\nconst MAGIC_LINK = `${BASE_URL}?email=${emailAddress}&code=${authChallenge}`\n```\n\nThis will append the `email` and `code` as querystring params which we be fetching in our webapp to validate the sign-in request. The final part is just constructing the email to be sent where we embed the link and the user can directly click the link to open it in the browser.\n\n### Deploying the stack\n\nThe final step to add in our stack is outputs that our webapp will use to perform authentication against the User Pool. This is done using the [Amplify JS library](https://docs.amplify.aws/lib/auth/getting-started/q/platform/js).\n\n```ts\nnew cdk.CfnOutput(this, 'userPoolId', {\n  value: userPool.userPoolId,\n})\n\nnew cdk.CfnOutput(this, 'clientId', {\n  value: webClient.userPoolClientId,\n})\n```\n\nWe set the `userPoolId` and `clientId` to be used by Amplify. CDK **automatically outputs** the API Gateway endpoint URL so we don't need to add it explicitly. Sweet!\n\nNow let's deploy the stack! As we are using workspaces, we need to run the `deploy` command in the backend workspace.\n\n```\nyarn workspace backend cdk deploy\n```\n\nAs an alternative, you can also move to the `backend` directory and simply run `yarn cdk deploy`.\n\nThis will deploy all our resources and create a JSON file with the outputs in our `frontend/src` folder. We generate the outputs file in the `frontend/src` folder on purpose as we need to use this in our React app. This app is created using [create-react-app](https://reactjs.org/docs/create-a-new-react-app.html).\n\n__*Note*__: You will need to edit the URL key the [api](https://github.com/ryands17/passwordless-auth/blob/main/packages/frontend/src/config/api.ts) file before proceeding further as CDK will generate a new resource name for your stack.\n\n### Testing the login flow\n\nAfter successful deployment, we can run the webapp locally to test the login flow using the following command:\n\n```\nyarn workspace frontend dev\n```\n\nThis will fire up the app on [http://localhost:3000/](http://localhost:3000/) and will redirect to the `signIn` page as we aren't currently authenticated.\n\n![Sign-in page that accepts an email](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/t9wbs7ix4f05eyoye4ai.png)\n\nOn adding our email address here, we will get a link on our email address.\n\n![Link sent successfully](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/52s0el1i9frcxs5tuzbs.png)\n\nHere's the link I received that includes the email and authChallenge (secret).\n\n![Email received with the sign-in link](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/d4jfxeoaz7m6zumsg0wl.png)\n\nOn clicking the link, a verify page is opened that will perform the sign-in and call the `sendCustomChallengeAnswer` method which will successfully verify the user and be redirected to the home page :)\n\n![Home page after successfully signing in](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jcqdzadh8i7qpnom2b9a.png)\n\n## Conclusion\n\nSo that was it! This is how we can perform a truly Passwordless sign-in with Cognito. Here's the repo again for those who would like to experiment:\n\n{% github ryands17/passwordless-auth no-readme %}\n\nAlso don't forget to **destroy this stack** so that you do not incur unnecessary charges using the following command:\n\n```\nyarn workspace backend cdk destroy\n```\n\nThe resources I used to help create this are:\n\n[https://aws.amazon.com/blogs/mobile/implementing-passwordless-email-authentication-with-amazon-cognito/](https://aws.amazon.com/blogs/mobile/implementing-passwordless-email-authentication-with-amazon-cognito/)\n\n[https://schof.co/cognito-magic-links/](https://schof.co/cognito-magic-links/)\n\nThanks for reading this and I would love to hear your thoughts on this in the comments! If you liked this post, do give it a like and share, and follow me on [Twitter](https://twitter.com/ryands1701). Until next time!",n.user={name:"Ryan Dsouza",username:p,twitter_username:"ryands1701",github_username:p,website_url:s,profile_image:"https://res.cloudinary.com/practicaldev/image/fetch/s--a4zreXSQ--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/114739/ad7657e6-666a-421c-a67c-90cb0eecfd83.jpg",profile_image_90:"https://res.cloudinary.com/practicaldev/image/fetch/s--gAgBerz9--/c_fill,f_auto,fl_progressive,h_90,q_auto,w_90/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/114739/ad7657e6-666a-421c-a67c-90cb0eecfd83.jpg"},{layout:"default",data:[{}],fetch:{"data-v-70afb46a:0":{article:n}},error:s,state:{currentArticle:n},serverRendered:!0,routePath:"/ryands17/778234",config:{_app:{basePath:"/nuxtstop/",assetsPath:"/nuxtstop/_nuxt/",cdnURL:s}}}}(null,{},"https://dev.to/ryands17/magic-links-with-cognito-using-the-cdk-24a9","2021-08-02T17:47:55Z","ryands17")</script><script src="/nuxtstop/_nuxt/f6e87fb.js" defer></script><script src="/nuxtstop/_nuxt/dc9ce94.js" defer></script><script src="/nuxtstop/_nuxt/6474719.js" defer></script><script src="/nuxtstop/_nuxt/9b75090.js" defer></script><script src="/nuxtstop/_nuxt/18df600.js" defer></script>
  </body>
</html>
