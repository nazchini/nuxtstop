<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>How to provision an Azure SQL Database with Active Directory authentication</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="Using Nuxt.js fetch() hook to build dev.to with a new look"><meta data-n-head="ssr" name="format-detection" content="telephone=no"><base href="/nuxtstop/"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,500,600&display=swap"><link rel="preload" href="/nuxtstop/_nuxt/f6e87fb.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/6474719.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/9b75090.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/18df600.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/dc9ce94.js" as="script"><style data-vue-ssr-id="c650fd98:0 af4684f0:0 a9c71758:0 dcafa518:0 4b9cec49:0 b093d766:0 9d98bcb4:0 6b6a11ea:0 0248ed80:0 ea8e4264:0">html{box-sizing:border-box;font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}*,:after,:before{box-sizing:inherit}html{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}*,:after,:before{border:0 solid #e0e0e0}blockquote,body,dd,dl,figure,h1,h2,h3,h4,h5,h6,p,pre{margin:0}button{background:0 0;padding:0}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}hr{border-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:inherit;opacity:.5}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:inherit;opacity:.5}input::placeholder,textarea::placeholder{color:inherit;opacity:.5}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit;font-family:sans-serif}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit;font-family:inherit;font-size:100%}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;overflow:auto;word-break:break-word;white-space:normal}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}html{height:100%;font-size:18px;-ms-overflow-style:scrollbar;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}@media(min-width:640px){html{font-size:20px}}body{height:100%;min-width:320px;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:400;line-height:1.5;color:#000;background-color:#eff4f7;-webkit-text-rendering:optimizeLegibility;text-rendering:optimizeLegibility;font-synthesis:none;font-kerning:normal;font-feature-settings:"normal","kern";-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-overflow-scrolling:touch;overflow-x:hidden;overflow-y:scroll}h1,h2,h3,h4,h5,h6{color:#000;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:600;font-feature-settings:"normal";line-height:1.2}pre{background:#29292e;border-radius:2px;overflow:auto;padding:1rem;color:#eff1f9;line-height:1.42em;font-size:13px}@media screen and (min-width:380px){pre{font-size:15px}}pre code{background:#29292e;color:#eff0f9;white-space:pre}div.highlight pre.highlight code{font-size:inherit;padding:0}div.inner-comment div.body div.highlight pre.highlight{background:#29292e}div.inner-comment div.body div.highlight pre.highlight code{font-size:inherit;white-space:inherit;background:inherit;color:inherit}.highlight .hll{background-color:#49483e}.highlight{background:#29292e;color:#f8f8f2}.highlight .c{color:grey}.highlight .err{text-shadow:0 0 7px #f9690e}.highlight .k{color:#f39c12}.highlight .l{color:plum}.highlight .n{color:#f8f8f2}.highlight .o{color:#f9690e}.highlight .p{color:#f8f8f2}.highlight .c1,.highlight .ch,.highlight .cm,.highlight .cp,.highlight .cpf,.highlight .cs{color:grey}.highlight .gd{color:#f9690e}.highlight .ge{font-style:italic}.highlight .gi{color:#7ed07e}.highlight .gs{font-weight:700}.highlight .gu{color:grey}.highlight .kc,.highlight .kd{color:#f39c12}.highlight .kn{color:#f9690e}.highlight .kp,.highlight .kr,.highlight .kt{color:#f39c12}.highlight .ld{color:#f2ca27}.highlight .m{color:plum}.highlight .s{color:#f2ca27}.highlight .na{color:#7ed07e}.highlight .nb{color:#f8f8f2}.highlight .nc{color:#7ed07e}.highlight .no{color:#f39c12}.highlight .nd{color:#7ed07e}.highlight .ni{color:#f8f8f2}.highlight .ne,.highlight .nf{color:#7ed07e}.highlight .nl,.highlight .nn{color:#f8f8f2}.highlight .nx{color:#7ed07e}.highlight .py{color:#f8f8f2}.highlight .nt{color:#f9690e}.highlight .nv{color:#f8f8f2}.highlight .ow{color:#f9690e}.highlight .w{color:#f8f8f2}.highlight .mb,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo{color:plum}.highlight .dl,.highlight .s2,.highlight .sa,.highlight .sb,.highlight .sc,.highlight .sd{color:#f2ca27}.highlight .se{color:plum}.highlight .s1,.highlight .sh,.highlight .si,.highlight .sr,.highlight .ss,.highlight .sx{color:#f2ca27}.highlight .bp{color:#f8f8f2}.highlight .fm{color:#7ed07e}.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{color:#f8f8f2}.highlight .il{color:plum}.vue-content-placeholders-heading__img,.vue-content-placeholders-heading__subtitle,.vue-content-placeholders-heading__title,.vue-content-placeholders-img,.vue-content-placeholders-text__line{background:#bfcdec!important}.vue-content-placeholders-is-animated .vue-content-placeholders-heading__img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__subtitle:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__title:before,.vue-content-placeholders-is-animated .vue-content-placeholders-img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-text__line:before{background:linear-gradient(90deg,transparent 0,#d3ddf9 15%,transparent 30%)!important}header[data-v-27046cca]{max-width:1280px;margin:auto;padding:1rem;height:6rem;border-bottom:1px solid rgba(0,0,0,.2)}header .logo-wrapper[data-v-27046cca],header[data-v-27046cca]{display:flex;align-items:center;justify-content:space-between}header .logo-wrapper[data-v-27046cca]{margin:0 .5rem}header .logo-wrapper svg[data-v-27046cca]{width:3rem;height:100%}header .logo-wrapper .name-wrapper[data-v-27046cca]{margin-left:.6em}header .logo-wrapper .name-wrapper .subtitle[data-v-27046cca]{font-size:1rem}header .logo-wrapper .name-wrapper .app-name[data-v-27046cca]{font-weight:700;font-size:2.25rem;line-height:1.25}header nav[data-v-27046cca]{letter-spacing:-.025rem;font-weight:600;text-transform:uppercase}header nav ul[data-v-27046cca]{display:flex}header nav ul li[data-v-27046cca]{margin:0 .5rem}header nav ul li a[data-v-27046cca]{box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;padding:.25rem 1rem;border-radius:.5rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}header nav ul li a[data-v-27046cca]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header nav ul li a.nuxt-link-exact-active[data-v-27046cca]{cursor:default}header nav ul li a.nuxt-link-exact-active[data-v-27046cca],header nav ul li a[data-v-27046cca]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}.page-wrapper[data-v-10d06ee8]{max-width:1280px;margin:auto;padding:1rem}.article-content-wrapper[data-v-10d06ee8]{display:flex;flex-direction:column;align-items:center;margin:auto auto 2rem}@media(min-width:1024px){.article-content-wrapper[data-v-10d06ee8]{align-items:normal;flex-direction:row}}.article-content-wrapper .article-block[data-v-10d06ee8]{width:100%;max-width:880px}@media(min-width:1024px){.article-content-wrapper .article-block[data-v-10d06ee8]{margin-right:1rem;width:66.66666%;margin-bottom:2rem}}.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{max-width:880px;width:100%;position:relative}@media(min-width:1024px){.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{display:block;width:33.33333%}}.article-content-wrapper .aside-username-wrapper .aside-username-block[data-v-10d06ee8]{position:-webkit-sticky;position:sticky;top:1rem}@media(min-width:1280px){.comments-block[data-v-10d06ee8]{margin:.5rem}}article[data-v-70afb46a]{padding:.5rem;border-radius:1rem}header h1[data-v-70afb46a],header[data-v-70afb46a]{margin-bottom:1rem}header h1[data-v-70afb46a]{font-size:2.25rem;letter-spacing:-.025rem}header .tags[data-v-70afb46a]{display:flex;flex-wrap:wrap;margin-bottom:1.5rem}header .tags .tag[data-v-70afb46a]{font-weight:500;line-height:1;padding:.5rem;margin:0 .5rem .5rem 0;border-radius:.25rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db}header .tags .tag[data-v-70afb46a]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header .tags .tag[data-v-70afb46a]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}header .image-wrapper[data-v-70afb46a]{position:relative;padding-bottom:56.25%;background-color:#d4dfe8;margin-bottom:1.5rem;border-radius:.5rem;overflow:hidden}@media(min-width:834px){header .image-wrapper[data-v-70afb46a]{margin-bottom:1.5rem}}header .image-wrapper img[data-v-70afb46a]{position:absolute;top:0;left:0;width:100%;height:100%;-o-object-fit:cover;object-fit:cover}header .meta[data-v-70afb46a]{line-height:1;font-size:.875rem;text-transform:uppercase;font-weight:500;letter-spacing:-.025rem;display:flex;align-items:center;justify-content:space-between}header .meta .scl[data-v-70afb46a]{display:flex}header .meta .scl span[data-v-70afb46a]{display:flex;align-items:center;margin-right:1rem}header .meta .scl span svg[data-v-70afb46a]{margin-right:.25rem}header .meta .scl .comments[data-v-70afb46a]{cursor:pointer}[data-v-70afb46a] .content .ltag__user{display:none}[data-v-70afb46a] .content iframe{max-width:100%}[data-v-70afb46a] .content h1{font-size:1.875rem}[data-v-70afb46a] .content h1,[data-v-70afb46a] .content h2{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h2{font-size:1.5rem}[data-v-70afb46a] .content h3{font-size:1.25rem}[data-v-70afb46a] .content h3,[data-v-70afb46a] .content h4{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h4{font-size:1rem}[data-v-70afb46a] .content a{color:#6e87d2}[data-v-70afb46a] .content p{margin-bottom:1rem;line-height:1.4}[data-v-70afb46a] .content p code{background-color:#d2f3e1;border-radius:.25rem;padding:.25rem}[data-v-70afb46a] .content img{width:100%;border-radius:.5rem}[data-v-70afb46a] .content .highlight{margin-bottom:1rem;border-radius:.5rem}[data-v-70afb46a] .content ul{list-style:numeral;margin-bottom:1rem}[data-v-70afb46a] .content ul li p{margin-bottom:0}[data-v-70afb46a] .content ol{margin-bottom:1rem}aside[data-v-37984f8c]{padding:1rem;background-color:#dfe8ef;border-radius:1rem}aside .username-heading[data-v-37984f8c]{display:flex;margin-bottom:1rem}aside .username-heading[data-v-37984f8c]:hover{color:#6e87d2}aside .username-heading img[data-v-37984f8c]{width:3rem;height:3rem;border-radius:50%;margin-right:1rem}aside .username-heading .text[data-v-37984f8c]{display:flex;flex-direction:column;justify-content:center}aside .username-heading .text a[data-v-37984f8c]{line-height:1}aside .username-heading .text a[data-v-37984f8c]:first-child{font-size:1.25rem;font-weight:500;letter-spacing:-.025rem;margin-bottom:.25rem}aside .username-heading .text a[data-v-37984f8c]:last-child{color:#999;font-size:.875rem}aside .username-heading.loading[data-v-37984f8c]{display:block}aside .f-button[data-v-37984f8c]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}aside .f-button[data-v-37984f8c]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}aside .f-button[data-v-37984f8c]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}aside .info>div[data-v-37984f8c]{margin-bottom:.5rem}aside .info .title[data-v-37984f8c]{font-size:.666666rem;letter-spacing:-.0125rem;font-weight:500;color:#999;text-transform:uppercase;margin-bottom:.1rem}aside .info .content[data-v-37984f8c]{font-size:.875rem;line-height:1.4}.add-comment[data-v-8c4375bc]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}.add-comment[data-v-8c4375bc]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}.add-comment[data-v-8c4375bc]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}footer[data-v-22cb8fd0]{padding:2rem;text-align:center;display:flex;align-items:center;justify-content:center}footer span[data-v-22cb8fd0]{display:inline-block;line-height:1;text-transform:uppercase;letter-spacing:-.025rem;font-size:.75rem;font-weight:500}footer a svg[data-v-22cb8fd0]{width:3rem;height:3rem;margin:0 .5rem}footer a .nuxt-icon[data-v-22cb8fd0]{width:2.5rem;height:2.5rem;margin:0 .25rem}</style>
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><div id="__layout"><div><header data-v-27046cca><a href="/nuxtstop/" class="logo-wrapper nuxt-link-active" data-v-27046cca><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-27046cca><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-27046cca></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-27046cca></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-27046cca></path></svg> <div class="name-wrapper" data-v-27046cca><span class="app-name" data-v-27046cca>Nuxtstop</span> <p class="subtitle" data-v-27046cca>For all things nuxt.js</p></div></a> <nav data-v-27046cca><ul data-v-27046cca><li data-v-27046cca><a href="/nuxtstop/" class="nuxt-link-active" data-v-27046cca>
          New
        </a></li><li data-v-27046cca><a href="/nuxtstop/top" data-v-27046cca>
          Top
        </a></li></ul></nav></header> <div class="page-wrapper" data-v-10d06ee8><div class="article-content-wrapper" data-v-10d06ee8><article data-fetch-key="data-v-70afb46a:0" class="article-block" data-v-70afb46a data-v-10d06ee8><header data-v-70afb46a><h1 data-v-70afb46a>How to provision an Azure SQL Database with Active Directory authentication</h1> <div class="tags" data-v-70afb46a><a href="/nuxtstop/t/pulumi" class="tag" data-v-70afb46a>
          #pulumi
        </a><a href="/nuxtstop/t/azure" class="tag" data-v-70afb46a>
          #azure
        </a><a href="/nuxtstop/t/sql" class="tag" data-v-70afb46a>
          #sql
        </a><a href="/nuxtstop/t/dotnet" class="tag" data-v-70afb46a>
          #dotnet
        </a></div> <div class="image-wrapper" data-v-70afb46a><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--QIFOj9Sn--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/8fds9zlpj9sst72k3mpv.jpg" alt="How to provision an Azure SQL Database with Active Directory authentication" data-v-70afb46a></div> <div class="meta" data-v-70afb46a><div class="scl" data-v-70afb46a><span data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M16.4444 3C14.6733 3 13.0333 3.94162 12 5.34C10.9667 3.94162 9.32667 3 7.55556 3C4.49222 3 2 5.52338 2 8.625C2 14.8024 11.0267 20.586 11.4122 20.829C11.5922 20.9426 11.7956 21 12 21C12.2044 21 12.4078 20.9426 12.5878 20.829C12.9733 20.586 22 14.8024 22 8.625C22 5.52338 19.5078 3 16.4444 3Z" fill="#FF0000" data-v-70afb46a data-v-70afb46a></path></svg>
            7
          </span> <span class="comments" data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M6.11765 22H4.94118L5.64706 21.05C6.11765 20.3969 6.41176 19.5656 6.58824 18.5563C3.64706 17.1906 2 14.6375 2 11.3125C2 6.20625 5.82353 3 12 3C18.1765 3 22 6.20625 22 11.3125C22 16.5375 18.2353 19.625 12 19.625H11.5882C10.6471 20.7531 9 22 6.11765 22ZM12 4.1875C6.47059 4.1875 3.17647 6.85937 3.17647 11.3125C3.17647 15.1125 5.47059 16.8938 7.41177 17.6656L7.82353 17.8437L7.76471 18.3187C7.64706 19.2687 7.47059 20.1 7.11765 20.8125C9.05882 20.575 10.1765 19.5656 10.8235 18.7344L11 18.4969H12C19.9412 18.4969 20.8235 13.5094 20.8235 11.3719C20.8235 6.85938 17.5294 4.1875 12 4.1875Z" fill="black" data-v-70afb46a data-v-70afb46a></path></svg>
            0
          </span></div> <time data-v-70afb46a>Feb 22</time></div></header> <div class="content" data-v-70afb46a><p>In this article, we will talk about how to provision an Azure SQL Database with authentication restricted to Active Directory users/groups/applications. We will use Pulumi to do that.</p>

<h2>
  <a name="why-this-article" href="#why-this-article">
  </a>
  Why this article?
</h2>

<p>In <a href="https://www.techwatching.dev/posts/sqlclient-active-directory-authent">a previous article</a>, I already talked about connecting to an Azure SQL Database using Azure Active Directory authentication. However, my focus was on querying an Azure SQL Database from C# code (from an ASP.NET 6 Minimal API that was using <code>Microsoft.Data.SqlClient</code> 'Active Directory Default' authentication mode to be more precise), and not on the configuration of the Azure AD authentication itself.</p>

<p>Still, in that article, I wrote an Azure CLI script that showed how to provision and configure the database with Azure AD authentication enabled. So why write another article about that? First because I did not show how to give an Azure AD entity (user, group, or managed identity) permission to access the database. (In my samples, to simplify things I was using the SQL server Azure AD administrator account to make my queries 🤫). Yet, it is something you will probably have to do if you want your App Service or Function App to query your database. Second because even if Azure CLI is great to handle Azure resources (if you are a reader of my blog, you probably know that I <a href="https://www.techwatching.dev/posts/welcome-azure-cli">enjoy very much Azure CLI</a>), in a real project I would probably use a more advanced Infrastructure as Code solution like Pulumi. And that is what we will show here.</p>

<blockquote>
<p>🗨️ If you are not familiar with Pulumi, it is an IaC solution similar to Terraform but using programming languages like C#. Speaking of C#, that is what I will use to write my infrastructure code but you can easily do the same in another language supported by Pulumi (TypeScript, Go, Python,... choose the one you are used to), the concepts stay relevant and the code will be similar.</p>
</blockquote>

<p>Now, let's get to the heart of the matter.</p>

<h2>
  <a name="an-azure-ad-user-as-our-sql-server-administrator" href="#an-azure-ad-user-as-our-sql-server-administrator">
  </a>
  An Azure AD user as our SQL Server administrator
</h2>

<p>Usually, when you create an Azure SQL Server, you have to provide an administrator login and an administrator password. But I said I wanted to limit the authentication to Azure Active Directory authentication only. So we will only need an Azure AD account to set as the administrator of our SQL Server. We could use an existing Azure AD account, but let's create a new Azure AD user just for that:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight csharp"><code><span class="kt">var</span> <span class="n">config</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Config</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">sqlAdAdminLogin</span> <span class="p">=</span> <span class="n">config</span><span class="p">.</span><span class="nf">Require</span><span class="p">(</span><span class="s">"sqlAdAdmin"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">sqlAdAdminPassword</span> <span class="p">=</span> <span class="n">config</span><span class="p">.</span><span class="nf">RequireSecret</span><span class="p">(</span><span class="s">"sqlAdPassword"</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">sqlAdAdmin</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">User</span><span class="p">(</span><span class="s">"sqlAdmin"</span><span class="p">,</span> <span class="k">new</span> <span class="n">UserArgs</span>
<span class="p">{</span>
    <span class="n">UserPrincipalName</span> <span class="p">=</span> <span class="n">sqlAdAdminLogin</span><span class="p">,</span>
    <span class="n">Password</span> <span class="p">=</span> <span class="n">sqlAdAdminPassword</span><span class="p">,</span>
    <span class="n">DisplayName</span> <span class="p">=</span> <span class="s">"Global SQL Admin"</span>
<span class="p">});</span>

</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>To create a new Azure AD user we need a login (it will be the email of the new user in our tenant) and a password. In this example, we retrieve these values from the <a href="https://www.pulumi.com/docs/intro/concepts/config/">configuration</a> which is stored in the YAML settings file. You can notice there that we retrieve a secret (the password) from the configuration thanks to the <code>config.RequireSecret</code> method. Indeed to avoid exposing a secret in the configuration file or the state file, Pulumi has <a href="https://www.pulumi.com/docs/intro/concepts/secrets/">built-in support for secret encryption and decryption</a> (not sure Terraform folks can say the same thing 😉).</p>

<h2>
  <a name="create-the-azure-sql-server-and-its-database" href="#create-the-azure-sql-server-and-its-database">
  </a>
  Create the Azure SQL Server and its database.
</h2>

<p>Now that we have our administrator account, we can create the Azure SQL Server:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight csharp"><code><span class="kt">var</span> <span class="n">sqlServer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Server</span><span class="p">(</span><span class="s">$"sql-sqlDbWithAzureAd-</span><span class="p">{</span><span class="n">Deployment</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">StackName</span><span class="p">}</span><span class="s">"</span><span class="p">,</span> <span class="k">new</span> <span class="n">ServerArgs</span>
<span class="p">{</span>
    <span class="n">ResourceGroupName</span> <span class="p">=</span> <span class="n">resourceGroup</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
    <span class="n">Administrators</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ServerExternalAdministratorArgs</span>
    <span class="p">{</span>
        <span class="n">Login</span> <span class="p">=</span> <span class="n">sqlAdAdmin</span><span class="p">.</span><span class="n">UserPrincipalName</span><span class="p">,</span>
        <span class="n">Sid</span> <span class="p">=</span> <span class="n">sqlAdAdmin</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span>
        <span class="n">AzureADOnlyAuthentication</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
        <span class="n">AdministratorType</span> <span class="p">=</span> <span class="n">AdministratorType</span><span class="p">.</span><span class="n">ActiveDirectory</span><span class="p">,</span>
        <span class="n">PrincipalType</span> <span class="p">=</span> <span class="n">PrincipalType</span><span class="p">.</span><span class="n">User</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">});</span>

</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Nothing special here: we are using the variable <code>sqlAdmin</code> that is our newly created user to set the administrator of the SQL Server and we set the authentication to Azure AD only. We can then create the database:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight csharp"><code><span class="kt">var</span> <span class="n">database</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Database</span><span class="p">(</span><span class="s">"sqldb-sqlDbWithAzureAd-Main"</span><span class="p">,</span> <span class="k">new</span> <span class="n">DatabaseArgs</span>
<span class="p">{</span>
    <span class="n">ResourceGroupName</span> <span class="p">=</span> <span class="n">resourceGroup</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
    <span class="n">ServerName</span> <span class="p">=</span> <span class="n">sqlServer</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
    <span class="n">Sku</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SkuArgs</span>
    <span class="p">{</span>
        <span class="n">Name</span> <span class="p">=</span> <span class="s">"Basic"</span>
    <span class="p">}</span>
<span class="p">});</span>

</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<h2>
  <a name="grant-sql-database-access-permissions-to-azure-ad-entities" href="#grant-sql-database-access-permissions-to-azure-ad-entities">
  </a>
  Grant SQL Database access permissions to Azure AD entities
</h2>

<p>Once we have provisioned the Azure SQL Server and its database, here comes the tough part: we need to configure who can access the database. In a project, you will probably have to give access to some users and to the Azure resources that need to query the database (you will have to assign these resources a managed identity before that). But to keep things simple, we will just consider we need to grant SQL Database access to an Azure AD group. That could be a good way to do things by the way: create an Azure AD group, grant permissions to this group and add users and managed identities that need access to the database.</p>

<p>Why did I say that this part was tough? It's because to grant SQL database permissions, we need to execute an SQL command on the Server as you can read <a href="https://docs.microsoft.com/en-us/azure/app-service/tutorial-connect-msi-sql-database?tabs=windowsclient%2Cef%2Cdotnet#grant-permissions-to-managed-identity">in the documentation</a>.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight sql"><code><span class="k">CREATE</span> <span class="k">USER</span> <span class="p">[</span><span class="o">&lt;</span><span class="k">identity</span><span class="o">-</span><span class="n">name</span><span class="o">></span><span class="p">]</span> <span class="k">FROM</span> <span class="k">EXTERNAL</span> <span class="n">PROVIDER</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="k">ROLE</span> <span class="n">db_datareader</span> <span class="k">ADD</span> <span class="n">MEMBER</span> <span class="p">[</span><span class="o">&lt;</span><span class="k">identity</span><span class="o">-</span><span class="n">name</span><span class="o">></span><span class="p">];</span>
<span class="k">ALTER</span> <span class="k">ROLE</span> <span class="n">db_datawriter</span> <span class="k">ADD</span> <span class="n">MEMBER</span> <span class="p">[</span><span class="o">&lt;</span><span class="k">identity</span><span class="o">-</span><span class="n">name</span><span class="o">></span><span class="p">];</span>
<span class="k">GO</span>

</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>With this command, we are creating a user and giving <code>db_datareader</code> and <code>db_datawriter</code> roles. However it is not a classical user, it's a user that is "external" to the database: in our case, it corresponds to an Azure AD entity (a user, group, or application).</p>

<p>So it's not just about setting a property to properly configure an Azure resource, it's a bit more complicated.</p>

<p>I see multiple ways of doing that:</p>

<ul>
<li>Create a new Pulumi provider "SQL Server provider" that is to able manage users in an SQL Server database</li>
<li>Write custom C# code that executes the SQL command once the database is created</li>
<li>Use the Pulumi Command provider to execute the SQL command using the <code>sqlcmd</code> utility</li>
</ul>

<p>Let's review these solutions.</p>

<h3>
  <a name="new-sql-server-provider" href="#new-sql-server-provider">
  </a>
  New "SQL Server Provider"
</h3>

<p>To manage SQL Server resources like users and roles, we can create a complete provider. We could create it from scratch of course or use this <a href="https://github.com/pulumi/pulumi-provider-boilerplate">Pulumi GitHub repository</a> that provides some boilerplate code to create a Pulumi provider. Usually, Pulumi providers are written in Go (like the Terraform providers by the way) and generate SDKs for all programming languages supported by Pulumi.</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--jH9ELIlm--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://techwatching.dev/posts/images/sqldatabase_ad_provider_1.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--jH9ELIlm--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://techwatching.dev/posts/images/sqldatabase_ad_provider_1.png" alt="" loading="lazy" width="880" height="442"></a></p>

<p>Another way would be to adapt the existing <a href="https://registry.terraform.io/providers/betr-io/mssql/latest/docs">Microsoft SQL Server Provider</a> for Terraform. This Terraform provider made by the community enables you to create and manage logins and users on a SQL Server. I talked about "adapting" this provider because you can create a Pulumi provider out of a Terraform provider by using the <a href="https://github.com/pulumi/pulumi-terraform-bridge">Pulumi Terraform Bridge</a>. That's great because instead of reinventing the wheel you can benefit from Terraform ecosystem by creating a Pulumi provider that wraps an existing Terraform provider. This <a href="https://github.com/pulumi/pulumi-tf-provider-boilerplate">GitHub repository</a> contains boilerplate code to do exactly that.</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--iR-Bo9BC--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://techwatching.dev/posts/images/sqldatabase_ad_provider_2.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--iR-Bo9BC--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://techwatching.dev/posts/images/sqldatabase_ad_provider_2.png" alt="" loading="lazy" width="880" height="291"></a></p>

<blockquote>
<p>You might have noticed that I sometimes criticize Terraform in my articles. That's not because I think Terraform is a bad infrastructure as code solution, in fact, I think it is a great solution with a rich ecosystem. However, I am critical of Terraform because I believe Infrastructure as Code should be done with programming languages instead of Domain-Specific Languages. Moreover, there are some areas (API coverage of major cloud providers, security, IDE support, ...) where I found Terraform is not good enough, especially compared to other platforms like Pulumi. So I am always a bit disappointed when I see that many people choose by default Terraform as their infrastructure as code platform without considering alternatives (and I am not only talking about Pulumi, there are also Farmer and Bicep for instance), even when these alternatives would be better suited to their use cases. That being said, Terraform has also advantages like its great community that creates and contributes to many providers like the <code>mssql</code> one.</p>
</blockquote>

<p>This first solution of creating a new "SQL Server Provider" (whether it be from scratch, from boilerplate code, or from the <code>mssql</code> Terraform provider) is interesting but could be time-consuming because there are some things to set up and some amount of code to write.</p>

<h3>
  <a name="custom-c-code" href="#custom-c-code">
  </a>
  Custom C# code
</h3>

<p>When you need to do something specific and there is no existing provider that can help you with it, you can just write the code to do it yourself without creating a complete provider. It's one of the reasons why I like Pulumi, even if you are doing Infrastructure as Code, at the end of the day you are just developing software so you can code what you need in the language you are familiar with. For instance, as I am developing in .NET, I can use the <a href="https://docs.microsoft.com/en-us/sql/connect/ado-net/overview-sqlclient-driver"><code>Microsoft.Data.SqlClient</code> library</a> (which is a data provider for Azure SQL Database) to connect and send commands to the database. And if I want to use <a href="https://github.com/DapperLib/Dapper">Dapper</a> on top of it because that's the library I am used to for querying a database I can. Hence writing the code that executes on the database the SQL command we have previously seen should not be very difficult.</p>

<p>Now, even if we are using imperative language in Pulumi to write the infrastructure code it's still declarative infrastructure as code with a state. Therefore, we have to be careful about how and when this custom code should be executed.</p>

<p>The easiest way is to use an <code>Apply</code> method on an output of the database like this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight csharp"><code><span class="n">database</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="nf">Apply</span><span class="p">(</span><span class="n">name</span> <span class="p">=></span>
<span class="p">{</span>
    <span class="cm">/*** 
     * Indempotent code using Microsoft.Data.SqlClient library
     * to execute the SQL command that assigns the correct roles
     * to the Azure AD group we want to have access to the database.
    ***/</span> 
    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
<span class="p">});</span>

</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>The code in the <code>Apply</code> will execute on every run after the resource is created, that is why it needs to be idempotent. Having to make the code idempotent is a constraint that I would prefer to avoid but at least it gives us a simple way to execute the code that grants access to the database.</p>

<p>Another way would be to use <a href="https://www.pulumi.com/docs/intro/concepts/resources/dynamic-providers/">Dynamic Providers</a> whose purpose is exactly that: do an infrastructure task that no existing provider can help you deliver. You can see some use cases of dynamic providers in <a href="https://www.pulumi.com/blog/dynamic-providers/#sample-use-cases">this Pulumi article</a>. In our use case, we could imagine writing a dynamic resource provider for an Azure AD entity user in an Azure SQL Database. We would have to implement the different CRUD operations to handle the different use cases properly (a user is added, a user is removed, user roles are updated, ...). Unfortunately, as you can see in <a href="https://github.com/pulumi/pulumi/issues/3638">this GitHub issue</a>, .NET Dynamic Providers are not yet supported (only TypesScript, JavaScript and Python are for the moment). It's a shame because Dynamic Providers provide an easy and efficient way of supporting custom resource types.</p>

<h3>
  <a name="command-provider-with-the-raw-sqlcmd-endraw-utility" href="#command-provider-with-the-raw-sqlcmd-endraw-utility">
  </a>
  Command provider with the <code>sqlcmd</code> utility
</h3>

<p><a href="https://docs.microsoft.com/en-us/azure/app-service/tutorial-connect-msi-sql-database?tabs=windowsclient%2Cef%2Cdotnet#grant-permissions-to-managed-identity">The Microsoft tutorial</a>, that shows how to grant database permissions to an Azure AD entity, explains how the necessary SQL commands can be run using the <a href="https://docs.microsoft.com/en-us/sql/tools/sqlcmd-utility"><code>sqlcmd</code> utility</a>. So instead of writing some C# code to do the same, an interesting idea would be to directly run the <code>sqlcmd</code> utility. And you know what? There is a Pulumi provider for executing commands and scripts: <a href="https://www.pulumi.com/registry/packages/command/api-docs/">the Command Provider</a>.</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--PXtktMD2--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://techwatching.dev/posts/images/sqldatabase_ad_pulumi_1.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--PXtktMD2--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://techwatching.dev/posts/images/sqldatabase_ad_pulumi_1.png" alt="" loading="lazy" width="880" height="432"></a></p>

<p>Because it's a Pulumi provider, the <code>sqlcmd</code> command would be executed "as part of the Pulumi resource model" which means the scripts would be executed at the corresponding time of the resource life-cycle (the <code>create</code> script when the resource is created and so on). So it's very nice and not the same as executing the <code>sqlcmd</code> outside of a Pulumi program, without access to all the variables and where you would have to make your script idempotent. Moreover, the ability to execute commands remotely can bring interesting use cases, just not for our current concern here.</p>

<blockquote>
<p>Pulumi Command Provider is currently in preview and only supports running scripts on <code>create</code> and <code>destroy</code> operations (support for <code>diff</code>, <code>update</code> and <code>read</code> operations <a href="https://github.com/pulumi/pulumi-command/issues/20">will probably be added later</a>). It works fine but does not log details about the error when a script fails, which makes debugging difficult. That should not prevent you from using it but as with any components in preview, use it with caution knowing everything is not perfect yet.</p>
</blockquote>

<h2>
  <a name="implement-the-database-permissions-for-an-azure-ad-group" href="#implement-the-database-permissions-for-an-azure-ad-group">
  </a>
  Implement the database permissions for an Azure AD Group
</h2>

<p>Of the 3 possible solutions let's take the 3rd one with the Command provider and the <code>sqlcmd</code> utility. It is probably not the "best" solution but I thought it would be simpler to use the <code>sqlcmd</code> utility than writing a complete provider or even custom C# code to do the same. Furthermore, it's the opportunity to test the Command provider which is fairly new.</p>

<h3>
  <a name="allow-the-machine-running-the-pulumi-program-to-connect-to-the-sql-server" href="#allow-the-machine-running-the-pulumi-program-to-connect-to-the-sql-server">
  </a>
  Allow the machine running the Pulumi program to connect to the SQL Server
</h3>

<p>To run a SQL command in the database, the machine that executes the Pulumi program needs to have its public IP authorized. To programmatically retrieve the public IP address from where the Pulumi program is running we can use <code>ipify API</code>. It's a simple open source HTTP API that returns the public IP address of the caller.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight csharp"><code><span class="kt">var</span> <span class="n">publicIp</span> <span class="p">=</span> <span class="n">Output</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="k">new</span> <span class="nf">HttpClient</span><span class="p">().</span><span class="nf">GetStringAsync</span><span class="p">(</span><span class="s">"https://api.ipify.org"</span><span class="p">));</span>

</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<blockquote>
<p>You can note here that we are just using standard C# code with an <code>HttpClient</code> that makes a <code>GET</code> to the API and returns asynchronously a string. I like the fact that with Pulumi we can reuse our existing C# skills, and the libraries we are used to. If we were to do that in Terraform we would have to look in the documentation how to do HTTP calls, discover that there is an <a href="https://registry.terraform.io/providers/hashicorp/http/latest/docs/data-sources/http">http data source</a> that can be used, understand how it works (to be honest it seems quite simple but still that is not natural) and use it.</p>
</blockquote>

<p>Now we can enable this public IP by creating a firewall rule in the SQL Server.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight csharp"><code><span class="kt">var</span> <span class="n">enableLocalMachine</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FirewallRule</span><span class="p">(</span><span class="s">"AllowLocalMachine"</span><span class="p">,</span> <span class="k">new</span> <span class="n">FirewallRuleArgs</span>
<span class="p">{</span>
    <span class="n">ResourceGroupName</span> <span class="p">=</span> <span class="n">resourceGroup</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
    <span class="n">ServerName</span> <span class="p">=</span> <span class="n">sqlServer</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
    <span class="n">StartIpAddress</span> <span class="p">=</span> <span class="n">publicIp</span><span class="p">,</span>
    <span class="n">EndIpAddress</span> <span class="p">=</span> <span class="n">publicIp</span>
<span class="p">});</span>

</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<h3>
  <a name="create-the-azure-ad-group-that-will-be-given-access-to-the-database" href="#create-the-azure-ad-group-that-will-be-given-access-to-the-database">
  </a>
  Create the Azure AD group that will be given access to the database
</h3>

<p>We said we wanted to grant SQL Database access to an Azure AD group that will contain in the future users and application managed identities that need access to the database. So let's create that:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight csharp"><code><span class="kt">var</span> <span class="n">sqlDatabaseAuthorizedGroup</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Group</span><span class="p">(</span><span class="s">"SqlDbUsersGroup"</span><span class="p">,</span> <span class="k">new</span> <span class="n">GroupArgs</span>
<span class="p">{</span>
    <span class="n">DisplayName</span> <span class="p">=</span> <span class="s">"SqlDbUsersGroup"</span><span class="p">,</span>
    <span class="n">SecurityEnabled</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
    <span class="n">Owners</span> <span class="p">=</span> <span class="k">new</span> <span class="n">InputList</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">></span> <span class="p">{</span> <span class="n">sqlAdAdmin</span><span class="p">.</span><span class="n">Id</span> <span class="p">}</span>
<span class="p">});</span>

</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>We set the Azure SQL Server admin as the owner of the group. This way, the admin of the database can add Azure AD users to the group and they directly have the permissions configured for this group. I like authorizing an Azure AD group instead of each Azure AD user because:</p>

<ul>
<li>it is easier to manage a group than individual users (adding a user to a group is less work than using SQL commands to assign the correct role for each user)</li>
<li>you don't lose granularity of access control (you can always create several groups with different permissions if you need to)</li>
<li>you can ensure that your application runs with the same permissions locally (the code you debug uses your user account identity) and on Azure (the code uses the managed identity of the App Service where it is hosted) by putting users and managed identities in the same group</li>
</ul>

<h3>
  <a name="assign-the-roles-to-the-azure-ad-group-using-the-command-provider" href="#assign-the-roles-to-the-azure-ad-group-using-the-command-provider">
  </a>
  Assign the roles to the Azure AD group using the Command provider
</h3>

<p>As we already talked about, we can specify a script to run on the <code>create</code> operation and another on the <code>destroy</code> operations. To keep things simple for this sample, we will only handle the creation scenario where we will add our Azure AD group as a user of the database and give it the expected roles. We already showed the SQL Command to execute, with our new group name it becomes:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight sql"><code><span class="k">CREATE</span> <span class="k">USER</span> <span class="p">{</span><span class="n">sqlDatabaseAuthorizedGroup</span><span class="p">.</span><span class="n">DisplayName</span><span class="p">}</span> <span class="k">FROM</span> <span class="k">EXTERNAL</span> <span class="n">PROVIDER</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="k">ROLE</span> <span class="n">db_datareader</span> <span class="k">ADD</span> <span class="n">MEMBER</span> <span class="p">{</span><span class="n">sqlDatabaseAuthorizedGroup</span><span class="p">.</span><span class="n">DisplayName</span><span class="p">};</span>
<span class="k">ALTER</span> <span class="k">ROLE</span> <span class="n">db_datawriter</span> <span class="k">ADD</span> <span class="n">MEMBER</span> <span class="p">{</span><span class="n">sqlDatabaseAuthorizedGroup</span><span class="p">.</span><span class="n">DisplayName</span><span class="p">};</span>
<span class="k">GO</span>

</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>The <code>sqlcmd</code> utility can be used like this to send a command on the database:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight powershell"><code><span class="n">sqlcmd</span><span class="w"> </span><span class="nt">-S</span><span class="w"> </span><span class="p">{</span><span class="n">sqlServer.Name</span><span class="p">}</span><span class="o">.</span><span class="nf">database</span><span class="o">.</span><span class="nf">windows</span><span class="o">.</span><span class="nf">net</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="p">{</span><span class="n">database.Name</span><span class="p">}</span><span class="w"> </span><span class="nt">-U</span><span class="w"> </span><span class="p">{</span><span class="n">sqlAdAdmin.UserPrincipalName</span><span class="p">}</span><span class="w"> </span><span class="nt">-P</span><span class="w"> </span><span class="p">{</span><span class="n">sqlAdAdmin.Password</span><span class="p">}</span><span class="w"> </span><span class="nt">-G</span><span class="w"> </span><span class="nt">-l</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="nt">-Q</span><span class="w"> </span><span class="s1">' ___SQL Command___'</span><span class="w">

</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>You can check the <a href="https://docs.microsoft.com/en-us/sql/tools/sqlcmd-utility?view=sql-server-ver15#sqlcmd-commands">documentation</a> to learn more about how to use <code>sqlcmd</code> but that is quite simple: we are just specifying to send a command line query on our database using Azure Active Directory to authenticate.</p>

<p>If we use all that with our Command provider, we get the following C# code.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight csharp"><code><span class="kt">var</span> <span class="n">authorizeAdGroup</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Command</span><span class="p">(</span><span class="s">"AuthorizeAdGroup"</span><span class="p">,</span> <span class="k">new</span> <span class="n">CommandArgs</span>
<span class="p">{</span>
    <span class="n">Create</span> <span class="p">=</span> <span class="n">Output</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">$"sqlcmd -S </span><span class="p">{</span><span class="n">sqlServer</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s">.database.windows.net -d </span><span class="p">{</span><span class="n">database</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s"> -U </span><span class="p">{</span><span class="n">sqlAdAdmin</span><span class="p">.</span><span class="n">UserPrincipalName</span><span class="p">}</span><span class="s"> -P </span><span class="p">{</span><span class="n">sqlAdAdmin</span><span class="p">.</span><span class="n">Password</span><span class="p">}</span><span class="s"> -G -l 30 -Q 'CREATE USER </span><span class="p">{</span><span class="n">sqlDatabaseAuthorizedGroup</span><span class="p">.</span><span class="n">DisplayName</span><span class="p">}</span><span class="s"> FROM EXTERNAL PROVIDER; ALTER ROLE db_datareader ADD MEMBER </span><span class="p">{</span><span class="n">sqlDatabaseAuthorizedGroup</span><span class="p">.</span><span class="n">DisplayName</span><span class="p">}</span><span class="s">; ALTER ROLE db_datawriter ADD MEMBER </span><span class="p">{</span><span class="n">sqlDatabaseAuthorizedGroup</span><span class="p">.</span><span class="n">DisplayName</span><span class="p">}</span><span class="s">;'"</span><span class="p">),</span>
    <span class="n">Interpreter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">InputList</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">></span>
    <span class="p">{</span>
        <span class="s">"pwsh"</span><span class="p">,</span>
        <span class="s">"-c"</span>
    <span class="p">}</span>
<span class="p">});</span>

</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>As you can see, we can specify a specific interpreter to use (PowerShell here).</p>

<blockquote>
<p>Don't do like me and forget that our variables are <a href="https://www.pulumi.com/docs/intro/concepts/inputs-outputs/#inputs-and-outputs">outputs</a> (only fully known when the infrastructure resource is completely provisioned). Because of that it is necessary to use the <code>Output.Format</code> method for string interpolation instead of using the C# operator <code>$</code>. Thanks to the community on Slack for helping me on that one because with the Command provider not logging the errors details I had a hard time on this.</p>
</blockquote>

<h3>
  <a name="results" href="#results">
  </a>
  Results
</h3>

<p>And that's it! We now have created the Azure AD group as an external user in the database and assigned it the <code>db_datareader</code> and <code>db_datawriter</code> roles. Here is what it looks like in Azure Data Studio:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--V098As3l--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://techwatching.dev/posts/images/sqldatabase_ad_azuredatastudio.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--V098As3l--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://techwatching.dev/posts/images/sqldatabase_ad_azuredatastudio.png" alt="" loading="lazy" width="880" height="499"></a></p>

<h2>
  <a name="conclusion" href="#conclusion">
  </a>
  Conclusion
</h2>

<p>This article is a bit long because I explain all the steps and possibilities but the complete code is not very big or complex. You can find it in this <a href="https://github.com/TechWatching/SqlDatabaseWithAzureAd">GitHub repository</a>.</p>

<p>I did not see that many articles on the web that talk about using Azure Active Directory authentication for an Azure SQL Database, and even less that showed how to properly configure it using Infrastructure as Code. Yet, I think it's an important thing to do to properly secure your Azure SQL database. So I hope you enjoyed it and learn something. Whether you use Azure CLI, Bicep, ARM Templates, Terraform, or Pulumi, don't hesitate to use Azure AD authentication on your Azure SQL Database, for me that is the right and secure way to go.</p>

<p>As you have seen in this article, even when there is no provider for your custom resource or task, there are always several solutions to do what you want with Pulumi. Some are more elegant, some are more complex than others but you will always find a way and you will not be limited by the platform.</p>

<p>A big thank you to the Pulumi community that gave me some insights on how to configure Azure AD authentication on a database properly using Pulumi. Without the help of some people in the Pulumi Slack or the GitHub Issues/Discussions I would not have been able to write this article. Indeed some ideas and solutions are directly inspired by people's answers to my questions. This article is my way of contributing back and helping others that would have similar questions.</p>

</div></article> <div class="aside-username-wrapper" data-v-10d06ee8><aside class="aside-username-block" data-v-37984f8c data-v-10d06ee8><div class="username-heading loading" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-heading" data-v-37984f8c><div class="vue-content-placeholders-heading__img"></div> <div class="vue-content-placeholders-heading__content"><div class="vue-content-placeholders-heading__title"></div> <div class="vue-content-placeholders-heading__subtitle"></div></div></div></div></div> <div class="info" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-text" data-v-37984f8c><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div></div></div></div></aside></div></div> <div class="comments-block" data-v-8c4375bc data-v-10d06ee8><!----> <a href="https://dev.to/techwatching/how-to-provision-an-azure-sql-database-with-active-directory-authentication-7hm" target="_blank" rel="nofollow noopener noreferer" class="add-comment" data-v-8c4375bc>
    Add comment
  </a></div></div> <footer data-v-22cb8fd0><span data-v-22cb8fd0>Built with</span> <a href="https://nuxtjs.org" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="nuxt-icon" data-v-22cb8fd0 data-v-22cb8fd0><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a> <span data-v-22cb8fd0>&</span> <a href="https://docs.dev.to/api" rel="nofollow noopener" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-22cb8fd0 data-v-22cb8fd0><path d="M1.5726 5.13748C1.42945 5.20622 1.2411 5.36661 1.15822 5.48117C1 5.69503 1 5.74849 1 11.8739C1 17.9993 1 18.0528 1.15822 18.2667C1.2411 18.3812 1.42945 18.5416 1.5726 18.6104C1.8137 18.7402 2.46164 18.7478 12 18.7478C21.5384 18.7478 22.1863 18.7402 22.4274 18.6104C22.5706 18.5416 22.7589 18.3812 22.8418 18.2667C23 18.0528 23 17.9993 23 11.8739C23 5.74849 23 5.69503 22.8418 5.48117C22.7589 5.36661 22.5706 5.20622 22.4274 5.13748C22.1863 5.00764 21.5384 5 12 5C2.46164 5 1.8137 5.00764 1.5726 5.13748ZM7.7055 8.2613C8.0822 8.45989 8.59454 9.0098 8.77536 9.40694C8.89589 9.66664 8.91095 9.94922 8.91095 12.0649C8.91095 14.3104 8.90344 14.4478 8.75275 14.7839C8.51919 15.288 8.16506 15.6546 7.68288 15.899C7.26096 16.1052 7.22328 16.1128 5.7315 16.1358L4.20206 16.1663V12.1031V8.04744L5.80684 8.07035C7.27602 8.09327 7.42672 8.10854 7.7055 8.2613ZM13.6952 8.89521V9.73538H12.4521H11.2089V10.4991V11.2629H11.9623H12.7158V12.1031V12.9432H11.9623H11.2089V13.707V14.4708H12.4521H13.6952V15.3109V16.151H12C10.1315 16.151 10.0411 16.1358 9.67191 15.6928L9.47603 15.4484V12.1336C9.47603 8.46752 9.46851 8.49807 9.95069 8.20783C10.1692 8.07035 10.3425 8.05508 11.9473 8.05508H13.6952V8.89521ZM16.5658 10.3769C16.8897 11.6295 17.1685 12.6912 17.176 12.7293C17.1911 12.7675 17.4699 11.7441 17.8014 10.461C18.1254 9.17017 18.4343 8.1009 18.4795 8.08563C18.5247 8.06271 18.9541 8.06271 19.4288 8.07035L20.3028 8.09327L19.376 11.6219C18.8713 13.5542 18.4117 15.2269 18.3664 15.3261C18.0123 16.0135 17.274 16.3343 16.7164 16.0441C16.4528 15.899 16.0911 15.4865 15.9705 15.1887C15.9254 15.0665 15.4884 13.4549 15.0062 11.6142C14.524 9.76593 14.1171 8.20783 14.0945 8.15437C14.0644 8.07035 14.2301 8.05508 15.0212 8.07035L15.9856 8.09327L16.5658 10.3769Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M5.93491 12.103V14.4707H6.27394C6.66574 14.4707 7.01983 14.3103 7.1404 14.0965C7.18559 14.0048 7.21575 13.2105 7.21575 12.0648V10.1783L6.99725 9.95683C6.80133 9.76591 6.71847 9.73535 6.35683 9.73535H5.93491V12.103Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a></footer></div></div></div><script>window.__NUXT__=function(e,a,s,n,t){return a.type_of="article",a.id=997995,a.title="How to provision an Azure SQL Database with Active Directory authentication",a.description="In this article, we will talk about how to provision an Azure SQL Database with authentication...",a.readable_publish_date="Feb 22",a.slug="how-to-provision-an-azure-sql-database-with-active-directory-authentication-7hm",a.path="/techwatching/how-to-provision-an-azure-sql-database-with-active-directory-authentication-7hm",a.url="https://dev.to/techwatching/how-to-provision-an-azure-sql-database-with-active-directory-authentication-7hm",a.comments_count=0,a.public_reactions_count=7,a.collection_id=e,a.published_timestamp=s,a.positive_reactions_count=7,a.cover_image="https://res.cloudinary.com/practicaldev/image/fetch/s--QIFOj9Sn--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/8fds9zlpj9sst72k3mpv.jpg",a.social_image="https://res.cloudinary.com/practicaldev/image/fetch/s--2EHmI1VB--/c_imagga_scale,f_auto,fl_progressive,h_500,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/8fds9zlpj9sst72k3mpv.jpg",a.canonical_url="https://techwatching.dev/posts/sqldatabase-active-directory-authent",a.created_at="2022-02-22T21:31:31Z",a.edited_at=e,a.crossposted_at=s,a.published_at=n,a.last_comment_at=n,a.reading_time_minutes=13,a.tag_list="pulumi, azure, sql, dotnet",a.tags=["pulumi","azure","sql","dotnet"],a.body_html='<p>In this article, we will talk about how to provision an Azure SQL Database with authentication restricted to Active Directory users/groups/applications. We will use Pulumi to do that.</p>\n\n<h2>\n  <a name="why-this-article" href="#why-this-article">\n  </a>\n  Why this article?\n</h2>\n\n<p>In <a href="https://www.techwatching.dev/posts/sqlclient-active-directory-authent">a previous article</a>, I already talked about connecting to an Azure SQL Database using Azure Active Directory authentication. However, my focus was on querying an Azure SQL Database from C# code (from an ASP.NET 6 Minimal API that was using <code>Microsoft.Data.SqlClient</code> \'Active Directory Default\' authentication mode to be more precise), and not on the configuration of the Azure AD authentication itself.</p>\n\n<p>Still, in that article, I wrote an Azure CLI script that showed how to provision and configure the database with Azure AD authentication enabled. So why write another article about that? First because I did not show how to give an Azure AD entity (user, group, or managed identity) permission to access the database. (In my samples, to simplify things I was using the SQL server Azure AD administrator account to make my queries 🤫). Yet, it is something you will probably have to do if you want your App Service or Function App to query your database. Second because even if Azure CLI is great to handle Azure resources (if you are a reader of my blog, you probably know that I <a href="https://www.techwatching.dev/posts/welcome-azure-cli">enjoy very much Azure CLI</a>), in a real project I would probably use a more advanced Infrastructure as Code solution like Pulumi. And that is what we will show here.</p>\n\n<blockquote>\n<p>🗨️ If you are not familiar with Pulumi, it is an IaC solution similar to Terraform but using programming languages like C#. Speaking of C#, that is what I will use to write my infrastructure code but you can easily do the same in another language supported by Pulumi (TypeScript, Go, Python,... choose the one you are used to), the concepts stay relevant and the code will be similar.</p>\n</blockquote>\n\n<p>Now, let\'s get to the heart of the matter.</p>\n\n<h2>\n  <a name="an-azure-ad-user-as-our-sql-server-administrator" href="#an-azure-ad-user-as-our-sql-server-administrator">\n  </a>\n  An Azure AD user as our SQL Server administrator\n</h2>\n\n<p>Usually, when you create an Azure SQL Server, you have to provide an administrator login and an administrator password. But I said I wanted to limit the authentication to Azure Active Directory authentication only. So we will only need an Azure AD account to set as the administrator of our SQL Server. We could use an existing Azure AD account, but let\'s create a new Azure AD user just for that:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight csharp"><code><span class="kt">var</span> <span class="n">config</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Config</span><span class="p">();</span>\n<span class="kt">var</span> <span class="n">sqlAdAdminLogin</span> <span class="p">=</span> <span class="n">config</span><span class="p">.</span><span class="nf">Require</span><span class="p">(</span><span class="s">"sqlAdAdmin"</span><span class="p">);</span>\n<span class="kt">var</span> <span class="n">sqlAdAdminPassword</span> <span class="p">=</span> <span class="n">config</span><span class="p">.</span><span class="nf">RequireSecret</span><span class="p">(</span><span class="s">"sqlAdPassword"</span><span class="p">);</span>\n\n<span class="kt">var</span> <span class="n">sqlAdAdmin</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">User</span><span class="p">(</span><span class="s">"sqlAdmin"</span><span class="p">,</span> <span class="k">new</span> <span class="n">UserArgs</span>\n<span class="p">{</span>\n    <span class="n">UserPrincipalName</span> <span class="p">=</span> <span class="n">sqlAdAdminLogin</span><span class="p">,</span>\n    <span class="n">Password</span> <span class="p">=</span> <span class="n">sqlAdAdminPassword</span><span class="p">,</span>\n    <span class="n">DisplayName</span> <span class="p">=</span> <span class="s">"Global SQL Admin"</span>\n<span class="p">});</span>\n\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>To create a new Azure AD user we need a login (it will be the email of the new user in our tenant) and a password. In this example, we retrieve these values from the <a href="https://www.pulumi.com/docs/intro/concepts/config/">configuration</a> which is stored in the YAML settings file. You can notice there that we retrieve a secret (the password) from the configuration thanks to the <code>config.RequireSecret</code> method. Indeed to avoid exposing a secret in the configuration file or the state file, Pulumi has <a href="https://www.pulumi.com/docs/intro/concepts/secrets/">built-in support for secret encryption and decryption</a> (not sure Terraform folks can say the same thing 😉).</p>\n\n<h2>\n  <a name="create-the-azure-sql-server-and-its-database" href="#create-the-azure-sql-server-and-its-database">\n  </a>\n  Create the Azure SQL Server and its database.\n</h2>\n\n<p>Now that we have our administrator account, we can create the Azure SQL Server:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight csharp"><code><span class="kt">var</span> <span class="n">sqlServer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Server</span><span class="p">(</span><span class="s">$"sql-sqlDbWithAzureAd-</span><span class="p">{</span><span class="n">Deployment</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">StackName</span><span class="p">}</span><span class="s">"</span><span class="p">,</span> <span class="k">new</span> <span class="n">ServerArgs</span>\n<span class="p">{</span>\n    <span class="n">ResourceGroupName</span> <span class="p">=</span> <span class="n">resourceGroup</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>\n    <span class="n">Administrators</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ServerExternalAdministratorArgs</span>\n    <span class="p">{</span>\n        <span class="n">Login</span> <span class="p">=</span> <span class="n">sqlAdAdmin</span><span class="p">.</span><span class="n">UserPrincipalName</span><span class="p">,</span>\n        <span class="n">Sid</span> <span class="p">=</span> <span class="n">sqlAdAdmin</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span>\n        <span class="n">AzureADOnlyAuthentication</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>\n        <span class="n">AdministratorType</span> <span class="p">=</span> <span class="n">AdministratorType</span><span class="p">.</span><span class="n">ActiveDirectory</span><span class="p">,</span>\n        <span class="n">PrincipalType</span> <span class="p">=</span> <span class="n">PrincipalType</span><span class="p">.</span><span class="n">User</span><span class="p">,</span>\n    <span class="p">},</span>\n<span class="p">});</span>\n\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Nothing special here: we are using the variable <code>sqlAdmin</code> that is our newly created user to set the administrator of the SQL Server and we set the authentication to Azure AD only. We can then create the database:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight csharp"><code><span class="kt">var</span> <span class="n">database</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Database</span><span class="p">(</span><span class="s">"sqldb-sqlDbWithAzureAd-Main"</span><span class="p">,</span> <span class="k">new</span> <span class="n">DatabaseArgs</span>\n<span class="p">{</span>\n    <span class="n">ResourceGroupName</span> <span class="p">=</span> <span class="n">resourceGroup</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>\n    <span class="n">ServerName</span> <span class="p">=</span> <span class="n">sqlServer</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>\n    <span class="n">Sku</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SkuArgs</span>\n    <span class="p">{</span>\n        <span class="n">Name</span> <span class="p">=</span> <span class="s">"Basic"</span>\n    <span class="p">}</span>\n<span class="p">});</span>\n\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<h2>\n  <a name="grant-sql-database-access-permissions-to-azure-ad-entities" href="#grant-sql-database-access-permissions-to-azure-ad-entities">\n  </a>\n  Grant SQL Database access permissions to Azure AD entities\n</h2>\n\n<p>Once we have provisioned the Azure SQL Server and its database, here comes the tough part: we need to configure who can access the database. In a project, you will probably have to give access to some users and to the Azure resources that need to query the database (you will have to assign these resources a managed identity before that). But to keep things simple, we will just consider we need to grant SQL Database access to an Azure AD group. That could be a good way to do things by the way: create an Azure AD group, grant permissions to this group and add users and managed identities that need access to the database.</p>\n\n<p>Why did I say that this part was tough? It\'s because to grant SQL database permissions, we need to execute an SQL command on the Server as you can read <a href="https://docs.microsoft.com/en-us/azure/app-service/tutorial-connect-msi-sql-database?tabs=windowsclient%2Cef%2Cdotnet#grant-permissions-to-managed-identity">in the documentation</a>.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight sql"><code><span class="k">CREATE</span> <span class="k">USER</span> <span class="p">[</span><span class="o">&lt;</span><span class="k">identity</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span><span class="p">]</span> <span class="k">FROM</span> <span class="k">EXTERNAL</span> <span class="n">PROVIDER</span><span class="p">;</span>\n<span class="k">ALTER</span> <span class="k">ROLE</span> <span class="n">db_datareader</span> <span class="k">ADD</span> <span class="n">MEMBER</span> <span class="p">[</span><span class="o">&lt;</span><span class="k">identity</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span><span class="p">];</span>\n<span class="k">ALTER</span> <span class="k">ROLE</span> <span class="n">db_datawriter</span> <span class="k">ADD</span> <span class="n">MEMBER</span> <span class="p">[</span><span class="o">&lt;</span><span class="k">identity</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span><span class="p">];</span>\n<span class="k">GO</span>\n\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>With this command, we are creating a user and giving <code>db_datareader</code> and <code>db_datawriter</code> roles. However it is not a classical user, it\'s a user that is "external" to the database: in our case, it corresponds to an Azure AD entity (a user, group, or application).</p>\n\n<p>So it\'s not just about setting a property to properly configure an Azure resource, it\'s a bit more complicated.</p>\n\n<p>I see multiple ways of doing that:</p>\n\n<ul>\n<li>Create a new Pulumi provider "SQL Server provider" that is to able manage users in an SQL Server database</li>\n<li>Write custom C# code that executes the SQL command once the database is created</li>\n<li>Use the Pulumi Command provider to execute the SQL command using the <code>sqlcmd</code> utility</li>\n</ul>\n\n<p>Let\'s review these solutions.</p>\n\n<h3>\n  <a name="new-sql-server-provider" href="#new-sql-server-provider">\n  </a>\n  New "SQL Server Provider"\n</h3>\n\n<p>To manage SQL Server resources like users and roles, we can create a complete provider. We could create it from scratch of course or use this <a href="https://github.com/pulumi/pulumi-provider-boilerplate">Pulumi GitHub repository</a> that provides some boilerplate code to create a Pulumi provider. Usually, Pulumi providers are written in Go (like the Terraform providers by the way) and generate SDKs for all programming languages supported by Pulumi.</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--jH9ELIlm--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://techwatching.dev/posts/images/sqldatabase_ad_provider_1.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--jH9ELIlm--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://techwatching.dev/posts/images/sqldatabase_ad_provider_1.png" alt="" loading="lazy" width="880" height="442"></a></p>\n\n<p>Another way would be to adapt the existing <a href="https://registry.terraform.io/providers/betr-io/mssql/latest/docs">Microsoft SQL Server Provider</a> for Terraform. This Terraform provider made by the community enables you to create and manage logins and users on a SQL Server. I talked about "adapting" this provider because you can create a Pulumi provider out of a Terraform provider by using the <a href="https://github.com/pulumi/pulumi-terraform-bridge">Pulumi Terraform Bridge</a>. That\'s great because instead of reinventing the wheel you can benefit from Terraform ecosystem by creating a Pulumi provider that wraps an existing Terraform provider. This <a href="https://github.com/pulumi/pulumi-tf-provider-boilerplate">GitHub repository</a> contains boilerplate code to do exactly that.</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--iR-Bo9BC--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://techwatching.dev/posts/images/sqldatabase_ad_provider_2.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--iR-Bo9BC--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://techwatching.dev/posts/images/sqldatabase_ad_provider_2.png" alt="" loading="lazy" width="880" height="291"></a></p>\n\n<blockquote>\n<p>You might have noticed that I sometimes criticize Terraform in my articles. That\'s not because I think Terraform is a bad infrastructure as code solution, in fact, I think it is a great solution with a rich ecosystem. However, I am critical of Terraform because I believe Infrastructure as Code should be done with programming languages instead of Domain-Specific Languages. Moreover, there are some areas (API coverage of major cloud providers, security, IDE support, ...) where I found Terraform is not good enough, especially compared to other platforms like Pulumi. So I am always a bit disappointed when I see that many people choose by default Terraform as their infrastructure as code platform without considering alternatives (and I am not only talking about Pulumi, there are also Farmer and Bicep for instance), even when these alternatives would be better suited to their use cases. That being said, Terraform has also advantages like its great community that creates and contributes to many providers like the <code>mssql</code> one.</p>\n</blockquote>\n\n<p>This first solution of creating a new "SQL Server Provider" (whether it be from scratch, from boilerplate code, or from the <code>mssql</code> Terraform provider) is interesting but could be time-consuming because there are some things to set up and some amount of code to write.</p>\n\n<h3>\n  <a name="custom-c-code" href="#custom-c-code">\n  </a>\n  Custom C# code\n</h3>\n\n<p>When you need to do something specific and there is no existing provider that can help you with it, you can just write the code to do it yourself without creating a complete provider. It\'s one of the reasons why I like Pulumi, even if you are doing Infrastructure as Code, at the end of the day you are just developing software so you can code what you need in the language you are familiar with. For instance, as I am developing in .NET, I can use the <a href="https://docs.microsoft.com/en-us/sql/connect/ado-net/overview-sqlclient-driver"><code>Microsoft.Data.SqlClient</code> library</a> (which is a data provider for Azure SQL Database) to connect and send commands to the database. And if I want to use <a href="https://github.com/DapperLib/Dapper">Dapper</a> on top of it because that\'s the library I am used to for querying a database I can. Hence writing the code that executes on the database the SQL command we have previously seen should not be very difficult.</p>\n\n<p>Now, even if we are using imperative language in Pulumi to write the infrastructure code it\'s still declarative infrastructure as code with a state. Therefore, we have to be careful about how and when this custom code should be executed.</p>\n\n<p>The easiest way is to use an <code>Apply</code> method on an output of the database like this:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight csharp"><code><span class="n">database</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="nf">Apply</span><span class="p">(</span><span class="n">name</span> <span class="p">=&gt;</span>\n<span class="p">{</span>\n    <span class="cm">/*** \n     * Indempotent code using Microsoft.Data.SqlClient library\n     * to execute the SQL command that assigns the correct roles\n     * to the Azure AD group we want to have access to the database.\n    ***/</span> \n    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>\n<span class="p">});</span>\n\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>The code in the <code>Apply</code> will execute on every run after the resource is created, that is why it needs to be idempotent. Having to make the code idempotent is a constraint that I would prefer to avoid but at least it gives us a simple way to execute the code that grants access to the database.</p>\n\n<p>Another way would be to use <a href="https://www.pulumi.com/docs/intro/concepts/resources/dynamic-providers/">Dynamic Providers</a> whose purpose is exactly that: do an infrastructure task that no existing provider can help you deliver. You can see some use cases of dynamic providers in <a href="https://www.pulumi.com/blog/dynamic-providers/#sample-use-cases">this Pulumi article</a>. In our use case, we could imagine writing a dynamic resource provider for an Azure AD entity user in an Azure SQL Database. We would have to implement the different CRUD operations to handle the different use cases properly (a user is added, a user is removed, user roles are updated, ...). Unfortunately, as you can see in <a href="https://github.com/pulumi/pulumi/issues/3638">this GitHub issue</a>, .NET Dynamic Providers are not yet supported (only TypesScript, JavaScript and Python are for the moment). It\'s a shame because Dynamic Providers provide an easy and efficient way of supporting custom resource types.</p>\n\n<h3>\n  <a name="command-provider-with-the-raw-sqlcmd-endraw-utility" href="#command-provider-with-the-raw-sqlcmd-endraw-utility">\n  </a>\n  Command provider with the <code>sqlcmd</code> utility\n</h3>\n\n<p><a href="https://docs.microsoft.com/en-us/azure/app-service/tutorial-connect-msi-sql-database?tabs=windowsclient%2Cef%2Cdotnet#grant-permissions-to-managed-identity">The Microsoft tutorial</a>, that shows how to grant database permissions to an Azure AD entity, explains how the necessary SQL commands can be run using the <a href="https://docs.microsoft.com/en-us/sql/tools/sqlcmd-utility"><code>sqlcmd</code> utility</a>. So instead of writing some C# code to do the same, an interesting idea would be to directly run the <code>sqlcmd</code> utility. And you know what? There is a Pulumi provider for executing commands and scripts: <a href="https://www.pulumi.com/registry/packages/command/api-docs/">the Command Provider</a>.</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--PXtktMD2--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://techwatching.dev/posts/images/sqldatabase_ad_pulumi_1.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--PXtktMD2--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://techwatching.dev/posts/images/sqldatabase_ad_pulumi_1.png" alt="" loading="lazy" width="880" height="432"></a></p>\n\n<p>Because it\'s a Pulumi provider, the <code>sqlcmd</code> command would be executed "as part of the Pulumi resource model" which means the scripts would be executed at the corresponding time of the resource life-cycle (the <code>create</code> script when the resource is created and so on). So it\'s very nice and not the same as executing the <code>sqlcmd</code> outside of a Pulumi program, without access to all the variables and where you would have to make your script idempotent. Moreover, the ability to execute commands remotely can bring interesting use cases, just not for our current concern here.</p>\n\n<blockquote>\n<p>Pulumi Command Provider is currently in preview and only supports running scripts on <code>create</code> and <code>destroy</code> operations (support for <code>diff</code>, <code>update</code> and <code>read</code> operations <a href="https://github.com/pulumi/pulumi-command/issues/20">will probably be added later</a>). It works fine but does not log details about the error when a script fails, which makes debugging difficult. That should not prevent you from using it but as with any components in preview, use it with caution knowing everything is not perfect yet.</p>\n</blockquote>\n\n<h2>\n  <a name="implement-the-database-permissions-for-an-azure-ad-group" href="#implement-the-database-permissions-for-an-azure-ad-group">\n  </a>\n  Implement the database permissions for an Azure AD Group\n</h2>\n\n<p>Of the 3 possible solutions let\'s take the 3rd one with the Command provider and the <code>sqlcmd</code> utility. It is probably not the "best" solution but I thought it would be simpler to use the <code>sqlcmd</code> utility than writing a complete provider or even custom C# code to do the same. Furthermore, it\'s the opportunity to test the Command provider which is fairly new.</p>\n\n<h3>\n  <a name="allow-the-machine-running-the-pulumi-program-to-connect-to-the-sql-server" href="#allow-the-machine-running-the-pulumi-program-to-connect-to-the-sql-server">\n  </a>\n  Allow the machine running the Pulumi program to connect to the SQL Server\n</h3>\n\n<p>To run a SQL command in the database, the machine that executes the Pulumi program needs to have its public IP authorized. To programmatically retrieve the public IP address from where the Pulumi program is running we can use <code>ipify API</code>. It\'s a simple open source HTTP API that returns the public IP address of the caller.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight csharp"><code><span class="kt">var</span> <span class="n">publicIp</span> <span class="p">=</span> <span class="n">Output</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="k">new</span> <span class="nf">HttpClient</span><span class="p">().</span><span class="nf">GetStringAsync</span><span class="p">(</span><span class="s">"https://api.ipify.org"</span><span class="p">));</span>\n\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<blockquote>\n<p>You can note here that we are just using standard C# code with an <code>HttpClient</code> that makes a <code>GET</code> to the API and returns asynchronously a string. I like the fact that with Pulumi we can reuse our existing C# skills, and the libraries we are used to. If we were to do that in Terraform we would have to look in the documentation how to do HTTP calls, discover that there is an <a href="https://registry.terraform.io/providers/hashicorp/http/latest/docs/data-sources/http">http data source</a> that can be used, understand how it works (to be honest it seems quite simple but still that is not natural) and use it.</p>\n</blockquote>\n\n<p>Now we can enable this public IP by creating a firewall rule in the SQL Server.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight csharp"><code><span class="kt">var</span> <span class="n">enableLocalMachine</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FirewallRule</span><span class="p">(</span><span class="s">"AllowLocalMachine"</span><span class="p">,</span> <span class="k">new</span> <span class="n">FirewallRuleArgs</span>\n<span class="p">{</span>\n    <span class="n">ResourceGroupName</span> <span class="p">=</span> <span class="n">resourceGroup</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>\n    <span class="n">ServerName</span> <span class="p">=</span> <span class="n">sqlServer</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>\n    <span class="n">StartIpAddress</span> <span class="p">=</span> <span class="n">publicIp</span><span class="p">,</span>\n    <span class="n">EndIpAddress</span> <span class="p">=</span> <span class="n">publicIp</span>\n<span class="p">});</span>\n\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<h3>\n  <a name="create-the-azure-ad-group-that-will-be-given-access-to-the-database" href="#create-the-azure-ad-group-that-will-be-given-access-to-the-database">\n  </a>\n  Create the Azure AD group that will be given access to the database\n</h3>\n\n<p>We said we wanted to grant SQL Database access to an Azure AD group that will contain in the future users and application managed identities that need access to the database. So let\'s create that:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight csharp"><code><span class="kt">var</span> <span class="n">sqlDatabaseAuthorizedGroup</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Group</span><span class="p">(</span><span class="s">"SqlDbUsersGroup"</span><span class="p">,</span> <span class="k">new</span> <span class="n">GroupArgs</span>\n<span class="p">{</span>\n    <span class="n">DisplayName</span> <span class="p">=</span> <span class="s">"SqlDbUsersGroup"</span><span class="p">,</span>\n    <span class="n">SecurityEnabled</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>\n    <span class="n">Owners</span> <span class="p">=</span> <span class="k">new</span> <span class="n">InputList</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">sqlAdAdmin</span><span class="p">.</span><span class="n">Id</span> <span class="p">}</span>\n<span class="p">});</span>\n\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>We set the Azure SQL Server admin as the owner of the group. This way, the admin of the database can add Azure AD users to the group and they directly have the permissions configured for this group. I like authorizing an Azure AD group instead of each Azure AD user because:</p>\n\n<ul>\n<li>it is easier to manage a group than individual users (adding a user to a group is less work than using SQL commands to assign the correct role for each user)</li>\n<li>you don\'t lose granularity of access control (you can always create several groups with different permissions if you need to)</li>\n<li>you can ensure that your application runs with the same permissions locally (the code you debug uses your user account identity) and on Azure (the code uses the managed identity of the App Service where it is hosted) by putting users and managed identities in the same group</li>\n</ul>\n\n<h3>\n  <a name="assign-the-roles-to-the-azure-ad-group-using-the-command-provider" href="#assign-the-roles-to-the-azure-ad-group-using-the-command-provider">\n  </a>\n  Assign the roles to the Azure AD group using the Command provider\n</h3>\n\n<p>As we already talked about, we can specify a script to run on the <code>create</code> operation and another on the <code>destroy</code> operations. To keep things simple for this sample, we will only handle the creation scenario where we will add our Azure AD group as a user of the database and give it the expected roles. We already showed the SQL Command to execute, with our new group name it becomes:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight sql"><code><span class="k">CREATE</span> <span class="k">USER</span> <span class="p">{</span><span class="n">sqlDatabaseAuthorizedGroup</span><span class="p">.</span><span class="n">DisplayName</span><span class="p">}</span> <span class="k">FROM</span> <span class="k">EXTERNAL</span> <span class="n">PROVIDER</span><span class="p">;</span>\n<span class="k">ALTER</span> <span class="k">ROLE</span> <span class="n">db_datareader</span> <span class="k">ADD</span> <span class="n">MEMBER</span> <span class="p">{</span><span class="n">sqlDatabaseAuthorizedGroup</span><span class="p">.</span><span class="n">DisplayName</span><span class="p">};</span>\n<span class="k">ALTER</span> <span class="k">ROLE</span> <span class="n">db_datawriter</span> <span class="k">ADD</span> <span class="n">MEMBER</span> <span class="p">{</span><span class="n">sqlDatabaseAuthorizedGroup</span><span class="p">.</span><span class="n">DisplayName</span><span class="p">};</span>\n<span class="k">GO</span>\n\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>The <code>sqlcmd</code> utility can be used like this to send a command on the database:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight powershell"><code><span class="n">sqlcmd</span><span class="w"> </span><span class="nt">-S</span><span class="w"> </span><span class="p">{</span><span class="n">sqlServer.Name</span><span class="p">}</span><span class="o">.</span><span class="nf">database</span><span class="o">.</span><span class="nf">windows</span><span class="o">.</span><span class="nf">net</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="p">{</span><span class="n">database.Name</span><span class="p">}</span><span class="w"> </span><span class="nt">-U</span><span class="w"> </span><span class="p">{</span><span class="n">sqlAdAdmin.UserPrincipalName</span><span class="p">}</span><span class="w"> </span><span class="nt">-P</span><span class="w"> </span><span class="p">{</span><span class="n">sqlAdAdmin.Password</span><span class="p">}</span><span class="w"> </span><span class="nt">-G</span><span class="w"> </span><span class="nt">-l</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="nt">-Q</span><span class="w"> </span><span class="s1">\' ___SQL Command___\'</span><span class="w">\n\n</span></code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>You can check the <a href="https://docs.microsoft.com/en-us/sql/tools/sqlcmd-utility?view=sql-server-ver15#sqlcmd-commands">documentation</a> to learn more about how to use <code>sqlcmd</code> but that is quite simple: we are just specifying to send a command line query on our database using Azure Active Directory to authenticate.</p>\n\n<p>If we use all that with our Command provider, we get the following C# code.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight csharp"><code><span class="kt">var</span> <span class="n">authorizeAdGroup</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Command</span><span class="p">(</span><span class="s">"AuthorizeAdGroup"</span><span class="p">,</span> <span class="k">new</span> <span class="n">CommandArgs</span>\n<span class="p">{</span>\n    <span class="n">Create</span> <span class="p">=</span> <span class="n">Output</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">$"sqlcmd -S </span><span class="p">{</span><span class="n">sqlServer</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s">.database.windows.net -d </span><span class="p">{</span><span class="n">database</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s"> -U </span><span class="p">{</span><span class="n">sqlAdAdmin</span><span class="p">.</span><span class="n">UserPrincipalName</span><span class="p">}</span><span class="s"> -P </span><span class="p">{</span><span class="n">sqlAdAdmin</span><span class="p">.</span><span class="n">Password</span><span class="p">}</span><span class="s"> -G -l 30 -Q \'CREATE USER </span><span class="p">{</span><span class="n">sqlDatabaseAuthorizedGroup</span><span class="p">.</span><span class="n">DisplayName</span><span class="p">}</span><span class="s"> FROM EXTERNAL PROVIDER; ALTER ROLE db_datareader ADD MEMBER </span><span class="p">{</span><span class="n">sqlDatabaseAuthorizedGroup</span><span class="p">.</span><span class="n">DisplayName</span><span class="p">}</span><span class="s">; ALTER ROLE db_datawriter ADD MEMBER </span><span class="p">{</span><span class="n">sqlDatabaseAuthorizedGroup</span><span class="p">.</span><span class="n">DisplayName</span><span class="p">}</span><span class="s">;\'"</span><span class="p">),</span>\n    <span class="n">Interpreter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">InputList</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span>\n    <span class="p">{</span>\n        <span class="s">"pwsh"</span><span class="p">,</span>\n        <span class="s">"-c"</span>\n    <span class="p">}</span>\n<span class="p">});</span>\n\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>As you can see, we can specify a specific interpreter to use (PowerShell here).</p>\n\n<blockquote>\n<p>Don\'t do like me and forget that our variables are <a href="https://www.pulumi.com/docs/intro/concepts/inputs-outputs/#inputs-and-outputs">outputs</a> (only fully known when the infrastructure resource is completely provisioned). Because of that it is necessary to use the <code>Output.Format</code> method for string interpolation instead of using the C# operator <code>$</code>. Thanks to the community on Slack for helping me on that one because with the Command provider not logging the errors details I had a hard time on this.</p>\n</blockquote>\n\n<h3>\n  <a name="results" href="#results">\n  </a>\n  Results\n</h3>\n\n<p>And that\'s it! We now have created the Azure AD group as an external user in the database and assigned it the <code>db_datareader</code> and <code>db_datawriter</code> roles. Here is what it looks like in Azure Data Studio:</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--V098As3l--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://techwatching.dev/posts/images/sqldatabase_ad_azuredatastudio.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--V098As3l--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://techwatching.dev/posts/images/sqldatabase_ad_azuredatastudio.png" alt="" loading="lazy" width="880" height="499"></a></p>\n\n<h2>\n  <a name="conclusion" href="#conclusion">\n  </a>\n  Conclusion\n</h2>\n\n<p>This article is a bit long because I explain all the steps and possibilities but the complete code is not very big or complex. You can find it in this <a href="https://github.com/TechWatching/SqlDatabaseWithAzureAd">GitHub repository</a>.</p>\n\n<p>I did not see that many articles on the web that talk about using Azure Active Directory authentication for an Azure SQL Database, and even less that showed how to properly configure it using Infrastructure as Code. Yet, I think it\'s an important thing to do to properly secure your Azure SQL database. So I hope you enjoyed it and learn something. Whether you use Azure CLI, Bicep, ARM Templates, Terraform, or Pulumi, don\'t hesitate to use Azure AD authentication on your Azure SQL Database, for me that is the right and secure way to go.</p>\n\n<p>As you have seen in this article, even when there is no provider for your custom resource or task, there are always several solutions to do what you want with Pulumi. Some are more elegant, some are more complex than others but you will always find a way and you will not be limited by the platform.</p>\n\n<p>A big thank you to the Pulumi community that gave me some insights on how to configure Azure AD authentication on a database properly using Pulumi. Without the help of some people in the Pulumi Slack or the GitHub Issues/Discussions I would not have been able to write this article. Indeed some ideas and solutions are directly inspired by people\'s answers to my questions. This article is my way of contributing back and helping others that would have similar questions.</p>\n\n',a.body_markdown='---\ntitle: How to provision an Azure SQL Database with Active Directory authentication\npublished: true\ndate: 2022-02-22 00:00:00 UTC\ntags: pulumi, azure, sql, dotnet\ncanonical_url: https://techwatching.dev/posts/sqldatabase-active-directory-authent\ncover_image: https://dev-to-uploads.s3.amazonaws.com/uploads/articles/8fds9zlpj9sst72k3mpv.jpg\n---\n\nIn this article, we will talk about how to provision an Azure SQL Database with authentication restricted to Active Directory users/groups/applications. We will use Pulumi to do that.\n\n## Why this article?\n\nIn [a previous article](https://www.techwatching.dev/posts/sqlclient-active-directory-authent), I already talked about connecting to an Azure SQL Database using Azure Active Directory authentication. However, my focus was on querying an Azure SQL Database from C# code (from an ASP.NET 6 Minimal API that was using `Microsoft.Data.SqlClient` \'Active Directory Default\' authentication mode to be more precise), and not on the configuration of the Azure AD authentication itself.\n\nStill, in that article, I wrote an Azure CLI script that showed how to provision and configure the database with Azure AD authentication enabled. So why write another article about that? First because I did not show how to give an Azure AD entity (user, group, or managed identity) permission to access the database. (In my samples, to simplify things I was using the SQL server Azure AD administrator account to make my queries 🤫). Yet, it is something you will probably have to do if you want your App Service or Function App to query your database. Second because even if Azure CLI is great to handle Azure resources (if you are a reader of my blog, you probably know that I [enjoy very much Azure CLI](https://www.techwatching.dev/posts/welcome-azure-cli)), in a real project I would probably use a more advanced Infrastructure as Code solution like Pulumi. And that is what we will show here.\n\n> 🗨️ If you are not familiar with Pulumi, it is an IaC solution similar to Terraform but using programming languages like C#. Speaking of C#, that is what I will use to write my infrastructure code but you can easily do the same in another language supported by Pulumi (TypeScript, Go, Python,... choose the one you are used to), the concepts stay relevant and the code will be similar.\n\nNow, let\'s get to the heart of the matter.\n\n## An Azure AD user as our SQL Server administrator\n\nUsually, when you create an Azure SQL Server, you have to provide an administrator login and an administrator password. But I said I wanted to limit the authentication to Azure Active Directory authentication only. So we will only need an Azure AD account to set as the administrator of our SQL Server. We could use an existing Azure AD account, but let\'s create a new Azure AD user just for that:\n\n```csharp\nvar config = new Config();\nvar sqlAdAdminLogin = config.Require("sqlAdAdmin");\nvar sqlAdAdminPassword = config.RequireSecret("sqlAdPassword");\n\nvar sqlAdAdmin = new User("sqlAdmin", new UserArgs\n{\n    UserPrincipalName = sqlAdAdminLogin,\n    Password = sqlAdAdminPassword,\n    DisplayName = "Global SQL Admin"\n});\n\n```\n\nTo create a new Azure AD user we need a login (it will be the email of the new user in our tenant) and a password. In this example, we retrieve these values from the [configuration](https://www.pulumi.com/docs/intro/concepts/config/) which is stored in the YAML settings file. You can notice there that we retrieve a secret (the password) from the configuration thanks to the `config.RequireSecret` method. Indeed to avoid exposing a secret in the configuration file or the state file, Pulumi has [built-in support for secret encryption and decryption](https://www.pulumi.com/docs/intro/concepts/secrets/) (not sure Terraform folks can say the same thing 😉).\n\n## Create the Azure SQL Server and its database.\n\nNow that we have our administrator account, we can create the Azure SQL Server:\n\n```csharp\nvar sqlServer = new Server($"sql-sqlDbWithAzureAd-{Deployment.Instance.StackName}", new ServerArgs\n{\n    ResourceGroupName = resourceGroup.Name,\n    Administrators = new ServerExternalAdministratorArgs\n    {\n        Login = sqlAdAdmin.UserPrincipalName,\n        Sid = sqlAdAdmin.Id,\n        AzureADOnlyAuthentication = true,\n        AdministratorType = AdministratorType.ActiveDirectory,\n        PrincipalType = PrincipalType.User,\n    },\n});\n\n```\n\nNothing special here: we are using the variable `sqlAdmin` that is our newly created user to set the administrator of the SQL Server and we set the authentication to Azure AD only. We can then create the database:\n\n```csharp\nvar database = new Database("sqldb-sqlDbWithAzureAd-Main", new DatabaseArgs\n{\n    ResourceGroupName = resourceGroup.Name,\n    ServerName = sqlServer.Name,\n    Sku = new SkuArgs\n    {\n        Name = "Basic"\n    }\n});\n\n```\n\n## Grant SQL Database access permissions to Azure AD entities\n\nOnce we have provisioned the Azure SQL Server and its database, here comes the tough part: we need to configure who can access the database. In a project, you will probably have to give access to some users and to the Azure resources that need to query the database (you will have to assign these resources a managed identity before that). But to keep things simple, we will just consider we need to grant SQL Database access to an Azure AD group. That could be a good way to do things by the way: create an Azure AD group, grant permissions to this group and add users and managed identities that need access to the database.\n\nWhy did I say that this part was tough? It\'s because to grant SQL database permissions, we need to execute an SQL command on the Server as you can read [in the documentation](https://docs.microsoft.com/en-us/azure/app-service/tutorial-connect-msi-sql-database?tabs=windowsclient%2Cef%2Cdotnet#grant-permissions-to-managed-identity).\n\n```sql\nCREATE USER [<identity-name>] FROM EXTERNAL PROVIDER;\nALTER ROLE db_datareader ADD MEMBER [<identity-name>];\nALTER ROLE db_datawriter ADD MEMBER [<identity-name>];\nGO\n\n```\n\nWith this command, we are creating a user and giving `db_datareader` and `db_datawriter` roles. However it is not a classical user, it\'s a user that is "external" to the database: in our case, it corresponds to an Azure AD entity (a user, group, or application).\n\nSo it\'s not just about setting a property to properly configure an Azure resource, it\'s a bit more complicated.\n\nI see multiple ways of doing that:\n\n- Create a new Pulumi provider "SQL Server provider" that is to able manage users in an SQL Server database\n- Write custom C# code that executes the SQL command once the database is created\n- Use the Pulumi Command provider to execute the SQL command using the `sqlcmd` utility\n\nLet\'s review these solutions.\n\n### New "SQL Server Provider"\n\nTo manage SQL Server resources like users and roles, we can create a complete provider. We could create it from scratch of course or use this [Pulumi GitHub repository](https://github.com/pulumi/pulumi-provider-boilerplate) that provides some boilerplate code to create a Pulumi provider. Usually, Pulumi providers are written in Go (like the Terraform providers by the way) and generate SDKs for all programming languages supported by Pulumi.\n\n ![](https://techwatching.dev/posts/images/sqldatabase_ad_provider_1.png)\n\nAnother way would be to adapt the existing [Microsoft SQL Server Provider](https://registry.terraform.io/providers/betr-io/mssql/latest/docs) for Terraform. This Terraform provider made by the community enables you to create and manage logins and users on a SQL Server. I talked about "adapting" this provider because you can create a Pulumi provider out of a Terraform provider by using the [Pulumi Terraform Bridge](https://github.com/pulumi/pulumi-terraform-bridge). That\'s great because instead of reinventing the wheel you can benefit from Terraform ecosystem by creating a Pulumi provider that wraps an existing Terraform provider. This [GitHub repository](https://github.com/pulumi/pulumi-tf-provider-boilerplate) contains boilerplate code to do exactly that.\n\n ![](https://techwatching.dev/posts/images/sqldatabase_ad_provider_2.png)\n\n> You might have noticed that I sometimes criticize Terraform in my articles. That\'s not because I think Terraform is a bad infrastructure as code solution, in fact, I think it is a great solution with a rich ecosystem. However, I am critical of Terraform because I believe Infrastructure as Code should be done with programming languages instead of Domain-Specific Languages. Moreover, there are some areas (API coverage of major cloud providers, security, IDE support, ...) where I found Terraform is not good enough, especially compared to other platforms like Pulumi. So I am always a bit disappointed when I see that many people choose by default Terraform as their infrastructure as code platform without considering alternatives (and I am not only talking about Pulumi, there are also Farmer and Bicep for instance), even when these alternatives would be better suited to their use cases. That being said, Terraform has also advantages like its great community that creates and contributes to many providers like the `mssql` one.\n\nThis first solution of creating a new "SQL Server Provider" (whether it be from scratch, from boilerplate code, or from the `mssql` Terraform provider) is interesting but could be time-consuming because there are some things to set up and some amount of code to write.\n\n### Custom C# code\n\nWhen you need to do something specific and there is no existing provider that can help you with it, you can just write the code to do it yourself without creating a complete provider. It\'s one of the reasons why I like Pulumi, even if you are doing Infrastructure as Code, at the end of the day you are just developing software so you can code what you need in the language you are familiar with. For instance, as I am developing in .NET, I can use the [`Microsoft.Data.SqlClient` library](https://docs.microsoft.com/en-us/sql/connect/ado-net/overview-sqlclient-driver) (which is a data provider for Azure SQL Database) to connect and send commands to the database. And if I want to use [Dapper](https://github.com/DapperLib/Dapper) on top of it because that\'s the library I am used to for querying a database I can. Hence writing the code that executes on the database the SQL command we have previously seen should not be very difficult.\n\nNow, even if we are using imperative language in Pulumi to write the infrastructure code it\'s still declarative infrastructure as code with a state. Therefore, we have to be careful about how and when this custom code should be executed.\n\nThe easiest way is to use an `Apply` method on an output of the database like this:\n\n```csharp\ndatabase.Name.Apply(name =>\n{\n    /*** \n     * Indempotent code using Microsoft.Data.SqlClient library\n     * to execute the SQL command that assigns the correct roles\n     * to the Azure AD group we want to have access to the database.\n    ***/ \n    return true;\n});\n\n```\n\nThe code in the `Apply` will execute on every run after the resource is created, that is why it needs to be idempotent. Having to make the code idempotent is a constraint that I would prefer to avoid but at least it gives us a simple way to execute the code that grants access to the database.\n\nAnother way would be to use [Dynamic Providers](https://www.pulumi.com/docs/intro/concepts/resources/dynamic-providers/) whose purpose is exactly that: do an infrastructure task that no existing provider can help you deliver. You can see some use cases of dynamic providers in [this Pulumi article](https://www.pulumi.com/blog/dynamic-providers/#sample-use-cases). In our use case, we could imagine writing a dynamic resource provider for an Azure AD entity user in an Azure SQL Database. We would have to implement the different CRUD operations to handle the different use cases properly (a user is added, a user is removed, user roles are updated, ...). Unfortunately, as you can see in [this GitHub issue](https://github.com/pulumi/pulumi/issues/3638), .NET Dynamic Providers are not yet supported (only TypesScript, JavaScript and Python are for the moment). It\'s a shame because Dynamic Providers provide an easy and efficient way of supporting custom resource types.\n\n### Command provider with the `sqlcmd` utility\n\n[The Microsoft tutorial](https://docs.microsoft.com/en-us/azure/app-service/tutorial-connect-msi-sql-database?tabs=windowsclient%2Cef%2Cdotnet#grant-permissions-to-managed-identity), that shows how to grant database permissions to an Azure AD entity, explains how the necessary SQL commands can be run using the [`sqlcmd` utility](https://docs.microsoft.com/en-us/sql/tools/sqlcmd-utility). So instead of writing some C# code to do the same, an interesting idea would be to directly run the `sqlcmd` utility. And you know what? There is a Pulumi provider for executing commands and scripts: [the Command Provider](https://www.pulumi.com/registry/packages/command/api-docs/).\n\n ![](https://techwatching.dev/posts/images/sqldatabase_ad_pulumi_1.png)\n\nBecause it\'s a Pulumi provider, the `sqlcmd` command would be executed "as part of the Pulumi resource model" which means the scripts would be executed at the corresponding time of the resource life-cycle (the `create` script when the resource is created and so on). So it\'s very nice and not the same as executing the `sqlcmd` outside of a Pulumi program, without access to all the variables and where you would have to make your script idempotent. Moreover, the ability to execute commands remotely can bring interesting use cases, just not for our current concern here.\n\n> Pulumi Command Provider is currently in preview and only supports running scripts on `create` and `destroy` operations (support for `diff`, `update` and `read` operations [will probably be added later](https://github.com/pulumi/pulumi-command/issues/20)). It works fine but does not log details about the error when a script fails, which makes debugging difficult. That should not prevent you from using it but as with any components in preview, use it with caution knowing everything is not perfect yet.\n\n## Implement the database permissions for an Azure AD Group\n\nOf the 3 possible solutions let\'s take the 3rd one with the Command provider and the `sqlcmd` utility. It is probably not the "best" solution but I thought it would be simpler to use the `sqlcmd` utility than writing a complete provider or even custom C# code to do the same. Furthermore, it\'s the opportunity to test the Command provider which is fairly new.\n\n### Allow the machine running the Pulumi program to connect to the SQL Server\n\nTo run a SQL command in the database, the machine that executes the Pulumi program needs to have its public IP authorized. To programmatically retrieve the public IP address from where the Pulumi program is running we can use `ipify API`. It\'s a simple open source HTTP API that returns the public IP address of the caller.\n\n```csharp\nvar publicIp = Output.Create(new HttpClient().GetStringAsync("https://api.ipify.org"));\n\n```\n\n> You can note here that we are just using standard C# code with an `HttpClient` that makes a `GET` to the API and returns asynchronously a string. I like the fact that with Pulumi we can reuse our existing C# skills, and the libraries we are used to. If we were to do that in Terraform we would have to look in the documentation how to do HTTP calls, discover that there is an [http data source](https://registry.terraform.io/providers/hashicorp/http/latest/docs/data-sources/http) that can be used, understand how it works (to be honest it seems quite simple but still that is not natural) and use it.\n\nNow we can enable this public IP by creating a firewall rule in the SQL Server.\n\n```csharp\nvar enableLocalMachine = new FirewallRule("AllowLocalMachine", new FirewallRuleArgs\n{\n    ResourceGroupName = resourceGroup.Name,\n    ServerName = sqlServer.Name,\n    StartIpAddress = publicIp,\n    EndIpAddress = publicIp\n});\n\n```\n\n### Create the Azure AD group that will be given access to the database\n\nWe said we wanted to grant SQL Database access to an Azure AD group that will contain in the future users and application managed identities that need access to the database. So let\'s create that:\n\n```csharp\nvar sqlDatabaseAuthorizedGroup = new Group("SqlDbUsersGroup", new GroupArgs\n{\n    DisplayName = "SqlDbUsersGroup",\n    SecurityEnabled = true,\n    Owners = new InputList<string> { sqlAdAdmin.Id }\n});\n\n```\n\nWe set the Azure SQL Server admin as the owner of the group. This way, the admin of the database can add Azure AD users to the group and they directly have the permissions configured for this group. I like authorizing an Azure AD group instead of each Azure AD user because:\n\n- it is easier to manage a group than individual users (adding a user to a group is less work than using SQL commands to assign the correct role for each user)\n- you don\'t lose granularity of access control (you can always create several groups with different permissions if you need to)\n- you can ensure that your application runs with the same permissions locally (the code you debug uses your user account identity) and on Azure (the code uses the managed identity of the App Service where it is hosted) by putting users and managed identities in the same group\n\n### Assign the roles to the Azure AD group using the Command provider\n\nAs we already talked about, we can specify a script to run on the `create` operation and another on the `destroy` operations. To keep things simple for this sample, we will only handle the creation scenario where we will add our Azure AD group as a user of the database and give it the expected roles. We already showed the SQL Command to execute, with our new group name it becomes:\n\n```sql\nCREATE USER {sqlDatabaseAuthorizedGroup.DisplayName} FROM EXTERNAL PROVIDER;\nALTER ROLE db_datareader ADD MEMBER {sqlDatabaseAuthorizedGroup.DisplayName};\nALTER ROLE db_datawriter ADD MEMBER {sqlDatabaseAuthorizedGroup.DisplayName};\nGO\n\n```\n\nThe `sqlcmd` utility can be used like this to send a command on the database:\n\n```powershell\nsqlcmd -S {sqlServer.Name}.database.windows.net -d {database.Name} -U {sqlAdAdmin.UserPrincipalName} -P {sqlAdAdmin.Password} -G -l 30 -Q \' ___SQL Command___\'\n\n```\n\nYou can check the [documentation](https://docs.microsoft.com/en-us/sql/tools/sqlcmd-utility?view=sql-server-ver15#sqlcmd-commands) to learn more about how to use `sqlcmd` but that is quite simple: we are just specifying to send a command line query on our database using Azure Active Directory to authenticate.\n\nIf we use all that with our Command provider, we get the following C# code.\n\n```csharp\nvar authorizeAdGroup = new Command("AuthorizeAdGroup", new CommandArgs\n{\n    Create = Output.Format($"sqlcmd -S {sqlServer.Name}.database.windows.net -d {database.Name} -U {sqlAdAdmin.UserPrincipalName} -P {sqlAdAdmin.Password} -G -l 30 -Q \'CREATE USER {sqlDatabaseAuthorizedGroup.DisplayName} FROM EXTERNAL PROVIDER; ALTER ROLE db_datareader ADD MEMBER {sqlDatabaseAuthorizedGroup.DisplayName}; ALTER ROLE db_datawriter ADD MEMBER {sqlDatabaseAuthorizedGroup.DisplayName};\'"),\n    Interpreter = new InputList<string>\n    {\n        "pwsh",\n        "-c"\n    }\n});\n\n```\n\nAs you can see, we can specify a specific interpreter to use (PowerShell here).\n\n> Don\'t do like me and forget that our variables are [outputs](https://www.pulumi.com/docs/intro/concepts/inputs-outputs/#inputs-and-outputs) (only fully known when the infrastructure resource is completely provisioned). Because of that it is necessary to use the `Output.Format` method for string interpolation instead of using the C# operator `$`. Thanks to the community on Slack for helping me on that one because with the Command provider not logging the errors details I had a hard time on this.\n\n### Results\n\nAnd that\'s it! We now have created the Azure AD group as an external user in the database and assigned it the `db_datareader` and `db_datawriter` roles. Here is what it looks like in Azure Data Studio:\n\n ![](https://techwatching.dev/posts/images/sqldatabase_ad_azuredatastudio.png)\n\n## Conclusion\n\nThis article is a bit long because I explain all the steps and possibilities but the complete code is not very big or complex. You can find it in this [GitHub repository](https://github.com/TechWatching/SqlDatabaseWithAzureAd).\n\nI did not see that many articles on the web that talk about using Azure Active Directory authentication for an Azure SQL Database, and even less that showed how to properly configure it using Infrastructure as Code. Yet, I think it\'s an important thing to do to properly secure your Azure SQL database. So I hope you enjoyed it and learn something. Whether you use Azure CLI, Bicep, ARM Templates, Terraform, or Pulumi, don\'t hesitate to use Azure AD authentication on your Azure SQL Database, for me that is the right and secure way to go.\n\nAs you have seen in this article, even when there is no provider for your custom resource or task, there are always several solutions to do what you want with Pulumi. Some are more elegant, some are more complex than others but you will always find a way and you will not be limited by the platform.\n\nA big thank you to the Pulumi community that gave me some insights on how to configure Azure AD authentication on a database properly using Pulumi. Without the help of some people in the Pulumi Slack or the GitHub Issues/Discussions I would not have been able to write this article. Indeed some ideas and solutions are directly inspired by people\'s answers to my questions. This article is my way of contributing back and helping others that would have similar questions.',a.user={name:"Alexandre",username:"techwatching",twitter_username:t,github_username:t,website_url:"https://www.techwatching.dev/",profile_image:"https://res.cloudinary.com/practicaldev/image/fetch/s--DbUWbl-1--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/169280/ef379162-fc92-4ee1-8569-a418c983e291.png",profile_image_90:"https://res.cloudinary.com/practicaldev/image/fetch/s--uTegHcGj--/c_fill,f_auto,fl_progressive,h_90,q_auto,w_90/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/169280/ef379162-fc92-4ee1-8569-a418c983e291.png"},{layout:"default",data:[{}],fetch:{"data-v-70afb46a:0":{article:a}},error:e,state:{currentArticle:a},serverRendered:!0,routePath:"/techwatching/997995",config:{_app:{basePath:"/nuxtstop/",assetsPath:"/nuxtstop/_nuxt/",cdnURL:e}}}}(null,{},"2022-02-22T21:38:47Z","2022-02-22T00:00:00Z","TechWatching")</script><script src="/nuxtstop/_nuxt/f6e87fb.js" defer></script><script src="/nuxtstop/_nuxt/dc9ce94.js" defer></script><script src="/nuxtstop/_nuxt/6474719.js" defer></script><script src="/nuxtstop/_nuxt/9b75090.js" defer></script><script src="/nuxtstop/_nuxt/18df600.js" defer></script>
  </body>
</html>
