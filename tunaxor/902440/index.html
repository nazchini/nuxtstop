<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Building a Webpack alternative in F#</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="Using Nuxt.js fetch() hook to build dev.to with a new look"><meta data-n-head="ssr" name="format-detection" content="telephone=no"><base href="/nuxtstop/"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,500,600&display=swap"><link rel="preload" href="/nuxtstop/_nuxt/f6e87fb.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/6474719.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/9b75090.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/18df600.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/dc9ce94.js" as="script"><style data-vue-ssr-id="c650fd98:0 af4684f0:0 a9c71758:0 dcafa518:0 4b9cec49:0 b093d766:0 9d98bcb4:0 6b6a11ea:0 0248ed80:0 ea8e4264:0">html{box-sizing:border-box;font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}*,:after,:before{box-sizing:inherit}html{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}*,:after,:before{border:0 solid #e0e0e0}blockquote,body,dd,dl,figure,h1,h2,h3,h4,h5,h6,p,pre{margin:0}button{background:0 0;padding:0}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}hr{border-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:inherit;opacity:.5}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:inherit;opacity:.5}input::placeholder,textarea::placeholder{color:inherit;opacity:.5}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit;font-family:sans-serif}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit;font-family:inherit;font-size:100%}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;overflow:auto;word-break:break-word;white-space:normal}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}html{height:100%;font-size:18px;-ms-overflow-style:scrollbar;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}@media(min-width:640px){html{font-size:20px}}body{height:100%;min-width:320px;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:400;line-height:1.5;color:#000;background-color:#eff4f7;-webkit-text-rendering:optimizeLegibility;text-rendering:optimizeLegibility;font-synthesis:none;font-kerning:normal;font-feature-settings:"normal","kern";-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-overflow-scrolling:touch;overflow-x:hidden;overflow-y:scroll}h1,h2,h3,h4,h5,h6{color:#000;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:600;font-feature-settings:"normal";line-height:1.2}pre{background:#29292e;border-radius:2px;overflow:auto;padding:1rem;color:#eff1f9;line-height:1.42em;font-size:13px}@media screen and (min-width:380px){pre{font-size:15px}}pre code{background:#29292e;color:#eff0f9;white-space:pre}div.highlight pre.highlight code{font-size:inherit;padding:0}div.inner-comment div.body div.highlight pre.highlight{background:#29292e}div.inner-comment div.body div.highlight pre.highlight code{font-size:inherit;white-space:inherit;background:inherit;color:inherit}.highlight .hll{background-color:#49483e}.highlight{background:#29292e;color:#f8f8f2}.highlight .c{color:grey}.highlight .err{text-shadow:0 0 7px #f9690e}.highlight .k{color:#f39c12}.highlight .l{color:plum}.highlight .n{color:#f8f8f2}.highlight .o{color:#f9690e}.highlight .p{color:#f8f8f2}.highlight .c1,.highlight .ch,.highlight .cm,.highlight .cp,.highlight .cpf,.highlight .cs{color:grey}.highlight .gd{color:#f9690e}.highlight .ge{font-style:italic}.highlight .gi{color:#7ed07e}.highlight .gs{font-weight:700}.highlight .gu{color:grey}.highlight .kc,.highlight .kd{color:#f39c12}.highlight .kn{color:#f9690e}.highlight .kp,.highlight .kr,.highlight .kt{color:#f39c12}.highlight .ld{color:#f2ca27}.highlight .m{color:plum}.highlight .s{color:#f2ca27}.highlight .na{color:#7ed07e}.highlight .nb{color:#f8f8f2}.highlight .nc{color:#7ed07e}.highlight .no{color:#f39c12}.highlight .nd{color:#7ed07e}.highlight .ni{color:#f8f8f2}.highlight .ne,.highlight .nf{color:#7ed07e}.highlight .nl,.highlight .nn{color:#f8f8f2}.highlight .nx{color:#7ed07e}.highlight .py{color:#f8f8f2}.highlight .nt{color:#f9690e}.highlight .nv{color:#f8f8f2}.highlight .ow{color:#f9690e}.highlight .w{color:#f8f8f2}.highlight .mb,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo{color:plum}.highlight .dl,.highlight .s2,.highlight .sa,.highlight .sb,.highlight .sc,.highlight .sd{color:#f2ca27}.highlight .se{color:plum}.highlight .s1,.highlight .sh,.highlight .si,.highlight .sr,.highlight .ss,.highlight .sx{color:#f2ca27}.highlight .bp{color:#f8f8f2}.highlight .fm{color:#7ed07e}.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{color:#f8f8f2}.highlight .il{color:plum}.vue-content-placeholders-heading__img,.vue-content-placeholders-heading__subtitle,.vue-content-placeholders-heading__title,.vue-content-placeholders-img,.vue-content-placeholders-text__line{background:#bfcdec!important}.vue-content-placeholders-is-animated .vue-content-placeholders-heading__img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__subtitle:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__title:before,.vue-content-placeholders-is-animated .vue-content-placeholders-img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-text__line:before{background:linear-gradient(90deg,transparent 0,#d3ddf9 15%,transparent 30%)!important}header[data-v-27046cca]{max-width:1280px;margin:auto;padding:1rem;height:6rem;border-bottom:1px solid rgba(0,0,0,.2)}header .logo-wrapper[data-v-27046cca],header[data-v-27046cca]{display:flex;align-items:center;justify-content:space-between}header .logo-wrapper[data-v-27046cca]{margin:0 .5rem}header .logo-wrapper svg[data-v-27046cca]{width:3rem;height:100%}header .logo-wrapper .name-wrapper[data-v-27046cca]{margin-left:.6em}header .logo-wrapper .name-wrapper .subtitle[data-v-27046cca]{font-size:1rem}header .logo-wrapper .name-wrapper .app-name[data-v-27046cca]{font-weight:700;font-size:2.25rem;line-height:1.25}header nav[data-v-27046cca]{letter-spacing:-.025rem;font-weight:600;text-transform:uppercase}header nav ul[data-v-27046cca]{display:flex}header nav ul li[data-v-27046cca]{margin:0 .5rem}header nav ul li a[data-v-27046cca]{box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;padding:.25rem 1rem;border-radius:.5rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}header nav ul li a[data-v-27046cca]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header nav ul li a.nuxt-link-exact-active[data-v-27046cca]{cursor:default}header nav ul li a.nuxt-link-exact-active[data-v-27046cca],header nav ul li a[data-v-27046cca]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}.page-wrapper[data-v-10d06ee8]{max-width:1280px;margin:auto;padding:1rem}.article-content-wrapper[data-v-10d06ee8]{display:flex;flex-direction:column;align-items:center;margin:auto auto 2rem}@media(min-width:1024px){.article-content-wrapper[data-v-10d06ee8]{align-items:normal;flex-direction:row}}.article-content-wrapper .article-block[data-v-10d06ee8]{width:100%;max-width:880px}@media(min-width:1024px){.article-content-wrapper .article-block[data-v-10d06ee8]{margin-right:1rem;width:66.66666%;margin-bottom:2rem}}.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{max-width:880px;width:100%;position:relative}@media(min-width:1024px){.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{display:block;width:33.33333%}}.article-content-wrapper .aside-username-wrapper .aside-username-block[data-v-10d06ee8]{position:-webkit-sticky;position:sticky;top:1rem}@media(min-width:1280px){.comments-block[data-v-10d06ee8]{margin:.5rem}}article[data-v-70afb46a]{padding:.5rem;border-radius:1rem}header h1[data-v-70afb46a],header[data-v-70afb46a]{margin-bottom:1rem}header h1[data-v-70afb46a]{font-size:2.25rem;letter-spacing:-.025rem}header .tags[data-v-70afb46a]{display:flex;flex-wrap:wrap;margin-bottom:1.5rem}header .tags .tag[data-v-70afb46a]{font-weight:500;line-height:1;padding:.5rem;margin:0 .5rem .5rem 0;border-radius:.25rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db}header .tags .tag[data-v-70afb46a]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header .tags .tag[data-v-70afb46a]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}header .image-wrapper[data-v-70afb46a]{position:relative;padding-bottom:56.25%;background-color:#d4dfe8;margin-bottom:1.5rem;border-radius:.5rem;overflow:hidden}@media(min-width:834px){header .image-wrapper[data-v-70afb46a]{margin-bottom:1.5rem}}header .image-wrapper img[data-v-70afb46a]{position:absolute;top:0;left:0;width:100%;height:100%;-o-object-fit:cover;object-fit:cover}header .meta[data-v-70afb46a]{line-height:1;font-size:.875rem;text-transform:uppercase;font-weight:500;letter-spacing:-.025rem;display:flex;align-items:center;justify-content:space-between}header .meta .scl[data-v-70afb46a]{display:flex}header .meta .scl span[data-v-70afb46a]{display:flex;align-items:center;margin-right:1rem}header .meta .scl span svg[data-v-70afb46a]{margin-right:.25rem}header .meta .scl .comments[data-v-70afb46a]{cursor:pointer}[data-v-70afb46a] .content .ltag__user{display:none}[data-v-70afb46a] .content iframe{max-width:100%}[data-v-70afb46a] .content h1{font-size:1.875rem}[data-v-70afb46a] .content h1,[data-v-70afb46a] .content h2{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h2{font-size:1.5rem}[data-v-70afb46a] .content h3{font-size:1.25rem}[data-v-70afb46a] .content h3,[data-v-70afb46a] .content h4{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h4{font-size:1rem}[data-v-70afb46a] .content a{color:#6e87d2}[data-v-70afb46a] .content p{margin-bottom:1rem;line-height:1.4}[data-v-70afb46a] .content p code{background-color:#d2f3e1;border-radius:.25rem;padding:.25rem}[data-v-70afb46a] .content img{width:100%;border-radius:.5rem}[data-v-70afb46a] .content .highlight{margin-bottom:1rem;border-radius:.5rem}[data-v-70afb46a] .content ul{list-style:numeral;margin-bottom:1rem}[data-v-70afb46a] .content ul li p{margin-bottom:0}[data-v-70afb46a] .content ol{margin-bottom:1rem}aside[data-v-37984f8c]{padding:1rem;background-color:#dfe8ef;border-radius:1rem}aside .username-heading[data-v-37984f8c]{display:flex;margin-bottom:1rem}aside .username-heading[data-v-37984f8c]:hover{color:#6e87d2}aside .username-heading img[data-v-37984f8c]{width:3rem;height:3rem;border-radius:50%;margin-right:1rem}aside .username-heading .text[data-v-37984f8c]{display:flex;flex-direction:column;justify-content:center}aside .username-heading .text a[data-v-37984f8c]{line-height:1}aside .username-heading .text a[data-v-37984f8c]:first-child{font-size:1.25rem;font-weight:500;letter-spacing:-.025rem;margin-bottom:.25rem}aside .username-heading .text a[data-v-37984f8c]:last-child{color:#999;font-size:.875rem}aside .username-heading.loading[data-v-37984f8c]{display:block}aside .f-button[data-v-37984f8c]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}aside .f-button[data-v-37984f8c]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}aside .f-button[data-v-37984f8c]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}aside .info>div[data-v-37984f8c]{margin-bottom:.5rem}aside .info .title[data-v-37984f8c]{font-size:.666666rem;letter-spacing:-.0125rem;font-weight:500;color:#999;text-transform:uppercase;margin-bottom:.1rem}aside .info .content[data-v-37984f8c]{font-size:.875rem;line-height:1.4}.add-comment[data-v-8c4375bc]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}.add-comment[data-v-8c4375bc]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}.add-comment[data-v-8c4375bc]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}footer[data-v-22cb8fd0]{padding:2rem;text-align:center;display:flex;align-items:center;justify-content:center}footer span[data-v-22cb8fd0]{display:inline-block;line-height:1;text-transform:uppercase;letter-spacing:-.025rem;font-size:.75rem;font-weight:500}footer a svg[data-v-22cb8fd0]{width:3rem;height:3rem;margin:0 .5rem}footer a .nuxt-icon[data-v-22cb8fd0]{width:2.5rem;height:2.5rem;margin:0 .25rem}</style>
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><div id="__layout"><div><header data-v-27046cca><a href="/nuxtstop/" class="logo-wrapper nuxt-link-active" data-v-27046cca><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-27046cca><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-27046cca></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-27046cca></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-27046cca></path></svg> <div class="name-wrapper" data-v-27046cca><span class="app-name" data-v-27046cca>Nuxtstop</span> <p class="subtitle" data-v-27046cca>For all things nuxt.js</p></div></a> <nav data-v-27046cca><ul data-v-27046cca><li data-v-27046cca><a href="/nuxtstop/" class="nuxt-link-active" data-v-27046cca>
          New
        </a></li><li data-v-27046cca><a href="/nuxtstop/top" data-v-27046cca>
          Top
        </a></li></ul></nav></header> <div class="page-wrapper" data-v-10d06ee8><div class="article-content-wrapper" data-v-10d06ee8><article data-fetch-key="data-v-70afb46a:0" class="article-block" data-v-70afb46a data-v-10d06ee8><header data-v-70afb46a><h1 data-v-70afb46a>Building a Webpack alternative in F#</h1> <div class="tags" data-v-70afb46a><a href="/nuxtstop/t/fsharp" class="tag" data-v-70afb46a>
          #fsharp
        </a><a href="/nuxtstop/t/fsadvent" class="tag" data-v-70afb46a>
          #fsadvent
        </a><a href="/nuxtstop/t/dotnet" class="tag" data-v-70afb46a>
          #dotnet
        </a><a href="/nuxtstop/t/frontend" class="tag" data-v-70afb46a>
          #frontend
        </a></div> <div class="image-wrapper" data-v-70afb46a><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--DMuY9BZM--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1lo9l9tm4ajnnze56u93.png" alt="Building a Webpack alternative in F#" data-v-70afb46a></div> <div class="meta" data-v-70afb46a><div class="scl" data-v-70afb46a><span data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M16.4444 3C14.6733 3 13.0333 3.94162 12 5.34C10.9667 3.94162 9.32667 3 7.55556 3C4.49222 3 2 5.52338 2 8.625C2 14.8024 11.0267 20.586 11.4122 20.829C11.5922 20.9426 11.7956 21 12 21C12.2044 21 12.4078 20.9426 12.5878 20.829C12.9733 20.586 22 14.8024 22 8.625C22 5.52338 19.5078 3 16.4444 3Z" fill="#FF0000" data-v-70afb46a data-v-70afb46a></path></svg>
            77
          </span> <span class="comments" data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M6.11765 22H4.94118L5.64706 21.05C6.11765 20.3969 6.41176 19.5656 6.58824 18.5563C3.64706 17.1906 2 14.6375 2 11.3125C2 6.20625 5.82353 3 12 3C18.1765 3 22 6.20625 22 11.3125C22 16.5375 18.2353 19.625 12 19.625H11.5882C10.6471 20.7531 9 22 6.11765 22ZM12 4.1875C6.47059 4.1875 3.17647 6.85937 3.17647 11.3125C3.17647 15.1125 5.47059 16.8938 7.41177 17.6656L7.82353 17.8437L7.76471 18.3187C7.64706 19.2687 7.47059 20.1 7.11765 20.8125C9.05882 20.575 10.1765 19.5656 10.8235 18.7344L11 18.4969H12C19.9412 18.4969 20.8235 13.5094 20.8235 11.3719C20.8235 6.85938 17.5294 4.1875 12 4.1875Z" fill="black" data-v-70afb46a data-v-70afb46a></path></svg>
            8
          </span></div> <time data-v-70afb46a>Dec 17 '21</time></div></header> <div class="content" data-v-70afb46a><p>Fable 3 made something I was not aware for some time, it moved to emitting ESM Modules and leaving babel and other stuff behind for users to set up.<br>
It was around June that I was really mad at compilation times with <a href="https://fable.io/">Fable</a> projects, After being in the JS/Node ecosystems for years I wondered what could be done to improve that situation.</p>


<blockquote class="ltag__twitter-tweet" data-url="https://twitter.com/angel_d_munoz/status/1404250352338325510">

  <div class="ltag__twitter-tweet__main" data-url="https://twitter.com/angel_d_munoz/status/1404250352338325510">
    <div class="ltag__twitter-tweet__header">
      <img class="ltag__twitter-tweet__profile-image" src="https://res.cloudinary.com/practicaldev/image/fetch/s--s15CcGpw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://pbs.twimg.com/profile_images/1427821392662339584/ev-ZMAoV_normal.jpg" alt="Angel Munoz profile image" loading="lazy">
      <div class="ltag__twitter-tweet__full-name">
        Angel Munoz
      </div>
      <div class="ltag__twitter-tweet__username">
        @angel_d_munoz
      </div>
      <div class="ltag__twitter-tweet__twitter-logo">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--ir1kO05j--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-f95605061196010f91e64806688390eb1a4dbc9e913682e043eb8b1e06ca484f.svg" alt="twitter logo" loading="lazy">
      </div>
    </div>
    <div class="ltag__twitter-tweet__body">
      If you're only using html/css/<a href="https://twitter.com/hashtag/fsharp">#fsharp</a> I think you can have a fairly modern dev setup with just suave, fable cli and F# scripts, I'll see if I can get a POC out later on, what would be missing HMR, bundling, some types of imports and preprocessing
    </div>
    <div class="ltag__twitter-tweet__date">
      01:32 AM - 14 Jun 2021
    </div>


    <div class="ltag__twitter-tweet__actions">
      <a href="https://twitter.com/intent/tweet?in_reply_to=1404250352338325510" class="ltag__twitter-tweet__actions__button">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--fFnoeFxk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-reply-action-238fe0a37991706a6880ed13941c3efd6b371e4aefe288fe8e0db85250708bc4.svg" alt="Twitter reply action" loading="lazy">
      </a>
      <a href="https://twitter.com/intent/retweet?tweet_id=1404250352338325510" class="ltag__twitter-tweet__actions__button">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--k6dcrOn8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-retweet-action-632c83532a4e7de573c5c08dbb090ee18b348b13e2793175fea914827bc42046.svg" alt="Twitter retweet action" loading="lazy">
      </a>
      <a href="https://twitter.com/intent/like?tweet_id=1404250352338325510" class="ltag__twitter-tweet__actions__button">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--SRQc9lOp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-like-action-1ea89f4b87c7d37465b0eb78d51fcb7fe6c03a089805d7ea014ba71365be5171.svg" alt="Twitter like action" loading="lazy">
      </a>
    </div>
  </div>
</blockquote>


<p>At the time I had been exploring alternatives to <a href="https://webpack.js.org/">Webpack</a> like <a href="https://fuse-box.org/">fuse-box</a>, <a href="https://parceljs.org/">parcel</a>, and <a href="https://esbuild.github.io/">esbuild</a>. Around the same time I was made aware aware that browsers had already implemented <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules">ESM modules</a>, so technically as long as you produced HTML, CSS, and JS you didn't need any kind of pre-processing at all.</p>

<p>This shouldn't be that hard, I just needed a server that well... served the HTML/CSS/JS files right?<br>
I went to my desktop, created an F# script added a couple of libraries like <a href="https://suave.io/">Suave</a> and <a href="https://github.com/Tyrrrz/CliWrap">CliWrap</a> so I could call the <code>dotnet fable</code> command from my F# code and make it compile my Fable files.</p>

<p>Taking out some code I came up with this PoC:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight fsharp"><code><span class="c1">// I omited more code above for brevity</span>
<span class="k">let</span> <span class="n">stdinAsyncSeq</span> <span class="bp">()</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">readFromStdin</span> <span class="bp">()</span> <span class="p">=</span>
        <span class="nn">Console</span><span class="p">.</span><span class="nn">In</span><span class="p">.</span><span class="nc">ReadLineAsync</span><span class="bp">()</span> <span class="p">|></span> <span class="nn">Async</span><span class="p">.</span><span class="nc">AwaitTask</span>

    <span class="n">asyncSeq</span> <span class="p">{</span>
        <span class="c1">// I wanted to think this is a "clever"</span>
        <span class="c1">// way to keep it running</span>
        <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
            <span class="k">let</span><span class="o">!</span> <span class="n">value</span> <span class="p">=</span> <span class="n">readFromStdin</span> <span class="bp">()</span>
            <span class="n">value</span>
    <span class="p">}</span>
    <span class="p">|></span> <span class="nn">AsyncSeq</span><span class="p">.</span><span class="n">distinctUntilChanged</span>
    <span class="p">|></span> <span class="nn">AsyncSeq</span><span class="p">.</span><span class="n">iterAsync</span> <span class="n">onStdinAsync</span>

<span class="k">let</span> <span class="n">app</span> <span class="p">=</span>
    <span class="n">choose</span> <span class="p">[</span> <span class="n">path</span> <span class="s2">"/"</span>
             <span class="o">>=></span> <span class="nc">GET</span>
             <span class="c1">// send the index file</span>
             <span class="o">>=></span> <span class="nn">Files</span><span class="p">.</span><span class="n">browseFileHome</span> <span class="s2">"index.html"</span>
             <span class="c1">// serve static files</span>
             <span class="nc">GET</span> <span class="o">>=></span> <span class="nn">Files</span><span class="p">.</span><span class="n">browseHome</span>
             <span class="nn">RequestErrors</span><span class="p">.</span><span class="nc">NOT_FOUND</span> <span class="s2">"Not Found"</span>
             <span class="c1">// SPA like fallback</span>
             <span class="o">>=></span> <span class="n">redirect</span> <span class="s2">"/"</span> <span class="p">]</span>

<span class="k">let</span> <span class="n">config</span> <span class="p">(</span><span class="n">publicPath</span><span class="p">:</span> <span class="kt">string</span> <span class="n">option</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">path</span> <span class="p">=</span>
        <span class="nn">Path</span><span class="p">.</span><span class="nc">GetFullPath</span><span class="p">(</span>
            <span class="k">match</span> <span class="n">publicPath</span> <span class="k">with</span>
            <span class="p">|</span> <span class="nc">Some</span> <span class="s2">"built"</span> <span class="p">-></span> <span class="s2">"./dist"</span>
            <span class="p">|</span> <span class="p">_</span> <span class="p">-></span> <span class="s2">"./public"</span>
        <span class="p">)</span>

    <span class="n">printfn</span> <span class="o">$</span><span class="s2">"Serving content from {path}"</span>
    <span class="c1">// configure the suave server instance</span>
    <span class="p">{</span> <span class="n">defaultConfig</span> <span class="k">with</span>
          <span class="n">bindings</span> <span class="p">=</span> <span class="p">[</span> <span class="nn">HttpBinding</span><span class="p">.</span><span class="n">createSimple</span> <span class="nc">HTTP</span> <span class="s2">"0.0.0.0"</span> <span class="mi">3000</span> <span class="p">]</span>
          <span class="n">homeFolder</span> <span class="p">=</span> <span class="nc">Some</span> <span class="n">path</span>
          <span class="n">compressedFilesFolder</span> <span class="p">=</span> <span class="nc">Some</span><span class="p">(</span><span class="nn">Path</span><span class="p">.</span><span class="nc">GetFullPath</span> <span class="s2">"./.compressed"</span><span class="p">)</span> <span class="p">}</span>
<span class="c1">// let's make it run!</span>
<span class="n">stdinAsyncSeq</span> <span class="bp">()</span> <span class="p">|></span> <span class="nn">Async</span><span class="p">.</span><span class="nc">Start</span>
<span class="c1">// dotnet fsi suave.fsx built to show how bundled files work</span>
<span class="n">startWebServer</span> <span class="p">(</span><span class="n">config</span> <span class="p">(</span><span class="n">fsi</span><span class="p">.</span><span class="nc">CommandLineArgs</span> <span class="p">|></span> <span class="nn">Array</span><span class="p">.</span><span class="n">tryLast</span><span class="o">))</span> <span class="n">app</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>Now, I could have my suave server and my Fable compiler running on the background. I could see my files being served in my browser I could make changes, press F5 and see them working.</p>


<blockquote class="ltag__twitter-tweet" data-url="https://twitter.com/angel_d_munoz/status/1404300942648954882">

  <div class="ltag__twitter-tweet__main" data-url="https://twitter.com/angel_d_munoz/status/1404300942648954882">
    <div class="ltag__twitter-tweet__header">
      <img class="ltag__twitter-tweet__profile-image" src="https://res.cloudinary.com/practicaldev/image/fetch/s--s15CcGpw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://pbs.twimg.com/profile_images/1427821392662339584/ev-ZMAoV_normal.jpg" alt="Angel Munoz profile image" loading="lazy">
      <div class="ltag__twitter-tweet__full-name">
        Angel Munoz
      </div>
      <div class="ltag__twitter-tweet__username">
        @angel_d_munoz
      </div>
      <div class="ltag__twitter-tweet__twitter-logo">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--ir1kO05j--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-f95605061196010f91e64806688390eb1a4dbc9e913682e043eb8b1e06ca484f.svg" alt="twitter logo" loading="lazy">
      </div>
    </div>
    <div class="ltag__twitter-tweet__body">
      It is possible to have a "node-less" <a href="https://twitter.com/hashtag/fsharp">#fsharp</a> frontend development experience thanks to  <a href="https://twitter.com/FableCompiler">@FableCompiler</a> and <a href="https://twitter.com/SuaveIO">@SuaveIO</a> <br>with a small F# script you can spin up a suave server and have fable compile your files in the background <br><a href="https://t.co/LfscIPlw9s">github.com/AngelMunoz/sua…</a>
    </div>
    <div class="ltag__twitter-tweet__date">
      04:53 AM - 14 Jun 2021
    </div>


    <div class="ltag__twitter-tweet__actions">
      <a href="https://twitter.com/intent/tweet?in_reply_to=1404300942648954882" class="ltag__twitter-tweet__actions__button">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--fFnoeFxk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-reply-action-238fe0a37991706a6880ed13941c3efd6b371e4aefe288fe8e0db85250708bc4.svg" alt="Twitter reply action" loading="lazy">
      </a>
      <a href="https://twitter.com/intent/retweet?tweet_id=1404300942648954882" class="ltag__twitter-tweet__actions__button">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--k6dcrOn8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-retweet-action-632c83532a4e7de573c5c08dbb090ee18b348b13e2793175fea914827bc42046.svg" alt="Twitter retweet action" loading="lazy">
      </a>
      <a href="https://twitter.com/intent/like?tweet_id=1404300942648954882" class="ltag__twitter-tweet__actions__button">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--SRQc9lOp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-like-action-1ea89f4b87c7d37465b0eb78d51fcb7fe6c03a089805d7ea014ba71365be5171.svg" alt="Twitter like action" loading="lazy">
      </a>
    </div>
  </div>
</blockquote>


<p>Cool it worked... Yay!... sure, with my attention span for some things I simply didn't think too much about it, or so I thought.</p>

<p>What came up next was experimenting with snowpack and fuse-box to see which setup could work best with Fable 3 and Although, Both projects work extremely well with Fable, the snowpack project felt more compelling to me thanks to the promoted <a href="https://www.snowpack.dev/concepts/how-snowpack-works#unbundled-development">Unbundled</a> development concept. I decided to go for it and tried the <a href="https://github.com/AngelMunoz/real-world-fable">Fable Real World</a> implementation and switched webpack for snowpack and the results were kind of what I was expecting, faster builds, a simpler setup and a much faster developer loop feedback with the browser.</p>

<p>Unconsciously on the back of my head was still that voice about writing something like snowpack in F#... In my mind, the people who build those kinds of tools are like people in the movies; You know they exist but, you don't think you are capable of doing something like it. Specially when most of my experience at that point was building UI's in things like Angular.</p>

<p>I went ahead and started studying the snowpack source code and I found out that they were using <a href="https://esbuild.github.io/">esbuild</a> a JS/TS compiler written in Go, no wonder why it was faster than anything done in JavaScript at the time.</p>

<p>Also, on the background <a href="https://vitejs.dev/">vitejs</a> was also starting to get in shape, I was looking at Evan's tweets from afar and getting inspired from that as well so I realized I needed to go back and see if I could go even further.</p>

<ul>
<li>What if I used esbuild as well?</li>
<li>What if I could use esbuild to produce my prod bundle after I built my fable code?</li>
</ul>


<blockquote class="ltag__twitter-tweet" data-url="https://twitter.com/angel_d_munoz/status/1407072676355751938">
      <div class="ltag__twitter-tweet__media ltag__twitter-tweet__media__video-wrapper">
        <div class="ltag__twitter-tweet__media--video-preview">
          <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--DLXdonkH--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://pbs.twimg.com/tweet_video_thumb/E4br8O3WEAEiLeX.jpg" alt="unknown tweet media content" loading="lazy">
          <img src="/assets/play-butt.svg" class="ltag__twitter-tweet__play-butt" alt="Play butt" loading="lazy">
        </div>
        <div class="ltag__twitter-tweet__video">
          <video loop controls>
            <source src="https://video.twimg.com/tweet_video/E4br8O3WEAEiLeX.mp4" type="video/mp4">
          </video>
        </div>
      </div>

  <div class="ltag__twitter-tweet__main" data-url="https://twitter.com/angel_d_munoz/status/1407072676355751938">
    <div class="ltag__twitter-tweet__header">
      <img class="ltag__twitter-tweet__profile-image" src="https://res.cloudinary.com/practicaldev/image/fetch/s--s15CcGpw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://pbs.twimg.com/profile_images/1427821392662339584/ev-ZMAoV_normal.jpg" alt="Angel Munoz profile image" loading="lazy">
      <div class="ltag__twitter-tweet__full-name">
        Angel Munoz
      </div>
      <div class="ltag__twitter-tweet__username">
        @angel_d_munoz
      </div>
      <div class="ltag__twitter-tweet__twitter-logo">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--ir1kO05j--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-f95605061196010f91e64806688390eb1a4dbc9e913682e043eb8b1e06ca484f.svg" alt="twitter logo" loading="lazy">
      </div>
    </div>
    <div class="ltag__twitter-tweet__body">
      Going back to that suave-dev server...<br>if we do add esbuild, we could actually go nodeless even  when preparing for prod stuff<br><a href="https://twitter.com/hashtag/fsharp">#fsharp</a><br>updated the scripts there<br><a href="https://t.co/LfscIPlw9s">github.com/AngelMunoz/sua…</a> 
    </div>
    <div class="ltag__twitter-tweet__date">
      20:27 PM - 21 Jun 2021
    </div>


    <div class="ltag__twitter-tweet__actions">
      <a href="https://twitter.com/intent/tweet?in_reply_to=1407072676355751938" class="ltag__twitter-tweet__actions__button">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--fFnoeFxk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-reply-action-238fe0a37991706a6880ed13941c3efd6b371e4aefe288fe8e0db85250708bc4.svg" alt="Twitter reply action" loading="lazy">
      </a>
      <a href="https://twitter.com/intent/retweet?tweet_id=1407072676355751938" class="ltag__twitter-tweet__actions__button">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--k6dcrOn8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-retweet-action-632c83532a4e7de573c5c08dbb090ee18b348b13e2793175fea914827bc42046.svg" alt="Twitter retweet action" loading="lazy">
      </a>
      <a href="https://twitter.com/intent/like?tweet_id=1407072676355751938" class="ltag__twitter-tweet__actions__button">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--SRQc9lOp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-like-action-1ea89f4b87c7d37465b0eb78d51fcb7fe6c03a089805d7ea014ba71365be5171.svg" alt="Twitter like action" loading="lazy">
      </a>
    </div>
  </div>
</blockquote>


<p>Turns out... I wasn't that crazy, after all both vite and snowpack were doing it as well!</p>

<p>Around September vite got traction with the vue user base and other users as well. I also studied a bit the vite source code, and even used it for some Fable material for posts. I was trying to make some awareness of <a href="https://fable.io/Fable.Lit/">Fable.Lit</a> support for Web Components and I wanted to experiment in reality how good vite was, and boi it's awesome If you're starting new projects that depend on node tooling in my opinion, it's your best bet.</p>

<p>Anyways, I tend to be looking at what's new on the web space, and by this time these... <a href="https://github.com/WICG/import-maps">Import Maps</a> thing came to my attention, it is a really nice browser feature that can be used to control the browser's behavior to import JavaScript files.</p>

<p>Import maps can tell the browser to use "bare specifiers" (i.e. <code>import dependency from "my-dependency"</code> rather than <code>"./my-dependency.js</code>) </p>

<p>Almost like "pull this import from this URL".</p>

<p>Hopefully you are starting to put the pieces together as I was doing.</p>

<p>Maybe... It might be possible to actually enjoy the NPM ecosystem without having to rely on the local tooling... Just maybe...</p>


<blockquote class="ltag__twitter-tweet" data-url="https://twitter.com/angel_d_munoz/status/1438579622904582144">
    <div class="ltag__twitter-tweet__media ltag__twitter-tweet__media__two-pics">
      <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--bGQuh9of--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://pbs.twimg.com/media/E_bbm6uWQAQuNjI.jpg" alt="unknown tweet media content" loading="lazy">
    </div>

  <div class="ltag__twitter-tweet__main" data-url="https://twitter.com/angel_d_munoz/status/1438579622904582144">
    <div class="ltag__twitter-tweet__header">
      <img class="ltag__twitter-tweet__profile-image" src="https://res.cloudinary.com/practicaldev/image/fetch/s--s15CcGpw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://pbs.twimg.com/profile_images/1427821392662339584/ev-ZMAoV_normal.jpg" alt="Angel Munoz profile image" loading="lazy">
      <div class="ltag__twitter-tweet__full-name">
        Angel Munoz
      </div>
      <div class="ltag__twitter-tweet__username">
        @angel_d_munoz
      </div>
      <div class="ltag__twitter-tweet__twitter-logo">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--ir1kO05j--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-f95605061196010f91e64806688390eb1a4dbc9e913682e043eb8b1e06ca484f.svg" alt="twitter logo" loading="lazy">
      </div>
    </div>
    <div class="ltag__twitter-tweet__body">
      It's starting to make sense if this works we would just need a couple of msbuild tasks to switch from lookup to pinned urls in prod mode and no node needed for frontend development, <a href="https://twitter.com/skypackjs">@skypackjs</a> and import maps really enable cool stuff<br><a href="https://twitter.com/hashtag/fsharp">#fsharp</a> 
    </div>
    <div class="ltag__twitter-tweet__date">
      19:04 PM - 16 Sep 2021
    </div>


    <div class="ltag__twitter-tweet__actions">
      <a href="https://twitter.com/intent/tweet?in_reply_to=1438579622904582144" class="ltag__twitter-tweet__actions__button">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--fFnoeFxk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-reply-action-238fe0a37991706a6880ed13941c3efd6b371e4aefe288fe8e0db85250708bc4.svg" alt="Twitter reply action" loading="lazy">
      </a>
      <a href="https://twitter.com/intent/retweet?tweet_id=1438579622904582144" class="ltag__twitter-tweet__actions__button">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--k6dcrOn8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-retweet-action-632c83532a4e7de573c5c08dbb090ee18b348b13e2793175fea914827bc42046.svg" alt="Twitter retweet action" loading="lazy">
      </a>
      <a href="https://twitter.com/intent/like?tweet_id=1438579622904582144" class="ltag__twitter-tweet__actions__button">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--SRQc9lOp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-like-action-1ea89f4b87c7d37465b0eb78d51fcb7fe6c03a089805d7ea014ba71365be5171.svg" alt="Twitter like action" loading="lazy">
      </a>
    </div>
  </div>
</blockquote>
 

<p>From then on, It was just about making small F# scripts to experiment PoC's and implementing small features.</p>

<p>At this point is when I said to myself.</p>

<blockquote>
<p>It's time to build a Webpack alternative...</p>
</blockquote>

<p>For this... <em>FSharp.DevServer</em>... I needed to have an idea of what I wanted to implement to make it usable at least, I settled on the following set of features.</p>

<ul>
<li>Serve HTML/CSS/JS</li>
<li>Support for Fable Projects</li>
<li>Reload on change</li>
<li>Install dependencies</li>
<li>Production Bundles</li>
<li>Transpilation on the fly</li>
<li>Dev Proxy</li>
<li>Plugins</li>
<li>HMR</li>
</ul>

<p>Those are the least features necessary IMO to consider for a project like this.</p>

<p>I will take you on a quick tour at how those got implemented at some point in the project.</p>

<blockquote>
<p>Keep in mind I'm not an F# expert! I'm just a guy with a lot of anxiety and free time so I use my code to distract myself while having a ton of fun with F# code.</p>
</blockquote>

<p>While for a proof of concept Suave did great, I switched it in favor of <a href="https://saturnframework.org/">Saturn</a> given my familiarity with it and some ASP.NET code.</p>
<h2>
  <a name="serve-htmlcssjs" href="#serve-htmlcssjs">
  </a>
  Serve HTML/CSS/JS
</h2>

<p>From most of the features, this must have been perhaps the most simple after all if you're using a server, it should be really simple to do right?</p>

<p>Well... Yes and No... it turns out that if you serve static files they get out of the middleware chain very quick due to the order of the static middleware is in. While it was good for serving it if I wanted to reload on change or compile these files I was not going to be able to do it.<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight fsharp"><code><span class="c1">// the current devServer function has way more stuff</span>
<span class="c1">// due the extra features that have been implemented</span>
<span class="k">let</span> <span class="k">private</span> <span class="n">devServer</span> <span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nc">FdsConfig</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">withAppConfig</span> <span class="p">(</span><span class="n">appConfig</span><span class="p">:</span> <span class="nc">IApplicationBuilder</span><span class="p">)</span> <span class="p">=</span>
        <span class="c1">// let's serve everything statically</span>
        <span class="c1">// but let's ignore some extensions</span>
        <span class="k">let</span> <span class="n">ignoreStatic</span> <span class="p">=</span>
          <span class="p">[</span> <span class="s2">".js"</span>
            <span class="s2">".css"</span>
            <span class="s2">".module.css"</span>
            <span class="s2">".ts"</span>
            <span class="s2">".tsx"</span>
            <span class="s2">".jsx"</span>
            <span class="s2">".json"</span> <span class="p">]</span>
        <span class="c1">// mountedDirs is a property in perla.jsonc</span>
        <span class="c1">// that enables you to watch a partcular set of </span>
        <span class="c1">// directories for source code</span>
        <span class="k">for</span> <span class="n">map</span> <span class="k">in</span> <span class="n">mountedDirs</span> <span class="k">do</span>
          <span class="k">let</span> <span class="n">staticFileOptions</span> <span class="p">=</span>
            <span class="k">let</span> <span class="n">provider</span> <span class="p">=</span> <span class="nc">FileExtensionContentTypeProvider</span><span class="bp">()</span>

            <span class="k">for</span> <span class="n">ext</span> <span class="k">in</span> <span class="n">ignoreStatic</span> <span class="k">do</span>
              <span class="n">provider</span><span class="p">.</span><span class="nn">Mappings</span><span class="p">.</span><span class="nc">Remove</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="p">|></span> <span class="n">ignore</span>

            <span class="k">let</span> <span class="n">options</span> <span class="p">=</span> <span class="nc">StaticFileOptions</span><span class="bp">()</span>

            <span class="n">options</span><span class="p">.</span><span class="nc">ContentTypeProvider</span> <span class="p">&lt;-</span> <span class="n">provider</span>
            <span class="c1">// in the next lines we enable local mapings</span>
            <span class="c1">// to URL's e.g.</span>
            <span class="c1">// ./src on disk -> /src on the URL</span>
            <span class="n">options</span><span class="p">.</span><span class="nc">RequestPath</span> <span class="p">&lt;-</span> <span class="nc">PathString</span><span class="p">(</span><span class="n">map</span><span class="p">.</span><span class="nc">Value</span><span class="p">)</span>

            <span class="n">options</span><span class="p">.</span><span class="nc">FileProvider</span> <span class="p">&lt;-</span>
              <span class="k">new</span> <span class="nc">PhysicalFileProvider</span><span class="p">(</span><span class="nn">Path</span><span class="p">.</span><span class="nc">GetFullPath</span><span class="p">(</span><span class="n">map</span><span class="p">.</span><span class="nc">Key</span><span class="o">))</span>

            <span class="n">options</span>

          <span class="n">appConfig</span><span class="p">.</span><span class="nc">UseStaticFiles</span> <span class="n">staticFileOptions</span>
          <span class="p">|></span> <span class="n">ignore</span>

        <span class="k">let</span> <span class="n">appConfig</span> <span class="p">=</span>
          <span class="c1">// at the same time we enable transpilation</span>
          <span class="c1">// middleware when we're ignoring some extensions</span>
          <span class="n">appConfig</span><span class="p">.</span><span class="nc">UseWhen</span><span class="p">(</span>
            <span class="nn">Middleware</span><span class="p">.</span><span class="n">transformPredicate</span> <span class="n">ignoreStatic</span><span class="p">,</span>
            <span class="nn">Middleware</span><span class="p">.</span><span class="n">configureTransformMiddleware</span> <span class="n">config</span>
          <span class="p">)</span>
    <span class="c1">// set the configured options</span>
    <span class="n">application</span> <span class="p">{</span>
        <span class="n">app_config</span> <span class="n">withAppConfig</span>
        <span class="n">webhost_config</span> <span class="n">withWebhostConfig</span>
        <span class="n">use_endpoint_router</span> <span class="n">urls</span>
    <span class="p">}</span>
    <span class="c1">// build it</span>
    <span class="n">app</span>
        <span class="p">.</span><span class="nc">UseEnvironment</span><span class="p">(</span><span class="nn">Environments</span><span class="p">.</span><span class="nc">Development</span><span class="p">)</span>
        <span class="p">.</span><span class="nc">Build</span><span class="bp">()</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>This part is just about serving files, nothing more, nothing less, that's the core of a dev server. </p>
<h2>
  <a name="support-for-fable-projects" href="#support-for-fable-projects">
  </a>
  Support for Fable Projects
</h2>

<p>Fable is actually not hard to support, fable is distributed as a dotnet tool, we can invoke the command with <a href="https://github.com/Tyrrrz/CliWrap">CliWrap</a> which has proven us in the PoC stage, how simple is to call a process from .NET.<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight fsharp"><code><span class="c1">// This is the actual Fable implementation</span>

<span class="k">module</span> <span class="nc">Fable</span> <span class="p">=</span>
  <span class="k">let</span> <span class="k">mutable</span> <span class="k">private</span> <span class="n">activeFable</span><span class="p">:</span> <span class="kt">int</span> <span class="n">option</span> <span class="p">=</span> <span class="nc">None</span>

  <span class="c1">// this is to start/stop the fable command</span>
  <span class="c1">// if requested by the user</span>
  <span class="k">let</span> <span class="k">private</span> <span class="n">killActiveProcess</span> <span class="n">pid</span> <span class="p">=</span>
    <span class="k">try</span>
      <span class="k">let</span> <span class="n">activeProcess</span> <span class="p">=</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Diagnostics</span><span class="p">.</span><span class="nn">Process</span><span class="p">.</span><span class="nc">GetProcessById</span> <span class="n">pid</span>

      <span class="n">activeProcess</span><span class="p">.</span><span class="nc">Kill</span><span class="bp">()</span>
    <span class="k">with</span>
    <span class="p">|</span> <span class="n">ex</span> <span class="p">-></span> <span class="n">printfn</span> <span class="o">$</span><span class="s2">"Failed to Kill Procees with PID: [{pid}]</span><span class="se">\n</span><span class="s2">{ex.Message}"</span>

  <span class="c1">// Helper functions to add arguments to the fable command</span>

  <span class="k">let</span> <span class="k">private</span> <span class="n">addOutDir</span>
    <span class="p">(</span><span class="n">outdir</span><span class="p">:</span> <span class="kt">string</span> <span class="n">option</span><span class="p">)</span>
    <span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="nn">Builders</span><span class="p">.</span><span class="nc">ArgumentsBuilder</span><span class="p">)</span>
    <span class="p">=</span>
    <span class="k">match</span> <span class="n">outdir</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Some</span> <span class="n">outdir</span> <span class="p">-></span> <span class="n">args</span><span class="p">.</span><span class="nc">Add</span> <span class="o">$</span><span class="s2">"-o {outdir}"</span>
    <span class="p">|</span> <span class="nc">None</span> <span class="p">-></span> <span class="n">args</span>

  <span class="k">let</span> <span class="k">private</span> <span class="n">addExtension</span>
    <span class="p">(</span><span class="n">extension</span><span class="p">:</span> <span class="kt">string</span> <span class="n">option</span><span class="p">)</span>
    <span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="nn">Builders</span><span class="p">.</span><span class="nc">ArgumentsBuilder</span><span class="p">)</span>
    <span class="p">=</span>
    <span class="k">match</span> <span class="n">extension</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Some</span> <span class="n">extension</span> <span class="p">-></span> <span class="n">args</span><span class="p">.</span><span class="nc">Add</span> <span class="o">$</span><span class="s2">"-e {extension}"</span>
    <span class="p">|</span> <span class="nc">None</span> <span class="p">-></span> <span class="n">args</span>

  <span class="k">let</span> <span class="k">private</span> <span class="n">addWatch</span> <span class="p">(</span><span class="n">watch</span><span class="p">:</span> <span class="kt">bool</span> <span class="n">option</span><span class="p">)</span> <span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="nn">Builders</span><span class="p">.</span><span class="nc">ArgumentsBuilder</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">watch</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Some</span> <span class="bp">true</span> <span class="p">-></span> <span class="n">args</span><span class="p">.</span><span class="nc">Add</span> <span class="o">$</span><span class="s2">"--watch"</span>
    <span class="p">|</span> <span class="nc">Some</span> <span class="bp">false</span>
    <span class="p">|</span> <span class="nc">None</span> <span class="p">-></span> <span class="n">args</span>

  <span class="c1">// we can fire up fable either as a background process</span>
  <span class="c1">// or before calling esbuild for production</span>
  <span class="k">let</span> <span class="n">fableCmd</span> <span class="p">(</span><span class="n">isWatch</span><span class="p">:</span> <span class="kt">bool</span> <span class="n">option</span><span class="p">)</span> <span class="p">=</span>

    <span class="k">fun</span> <span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nc">FableConfig</span><span class="p">)</span> <span class="p">-></span>
      <span class="k">let</span> <span class="n">execBinName</span> <span class="p">=</span>
        <span class="k">if</span> <span class="nn">Env</span><span class="p">.</span><span class="n">isWindows</span> <span class="k">then</span>
          <span class="s2">"dotnet.exe"</span>
        <span class="k">else</span>
          <span class="s2">"dotnet"</span>

      <span class="nn">Cli</span>
        <span class="p">.</span><span class="nc">Wrap</span><span class="p">(</span><span class="n">execBinName</span><span class="p">)</span>
        <span class="p">.</span><span class="nc">WithArguments</span><span class="p">(</span><span class="k">fun</span> <span class="n">args</span> <span class="p">-></span>
          <span class="n">args</span>
            <span class="p">.</span><span class="nc">Add</span><span class="p">(</span><span class="s2">"fable"</span><span class="p">)</span>
            <span class="p">.</span><span class="nc">Add</span><span class="p">(</span><span class="n">defaultArg</span> <span class="n">config</span><span class="p">.</span><span class="n">project</span> <span class="s2">"./src/App.fsproj"</span><span class="p">)</span>
          <span class="p">|></span> <span class="n">addWatch</span> <span class="n">isWatch</span>
          <span class="p">|></span> <span class="n">addOutDir</span> <span class="n">config</span><span class="p">.</span><span class="n">outDir</span>
          <span class="p">|></span> <span class="n">addExtension</span> <span class="n">config</span><span class="p">.</span><span class="n">extension</span>
          <span class="p">|></span> <span class="n">ignore</span><span class="p">)</span>
        <span class="c1">// we don't do a lot, we simply re-direct the stdio to the console</span>
        <span class="p">.</span><span class="nc">WithStandardErrorPipe</span><span class="p">(</span><span class="nn">PipeTarget</span><span class="p">.</span><span class="nc">ToStream</span><span class="p">(</span><span class="nn">Console</span><span class="p">.</span><span class="nc">OpenStandardError</span><span class="bp">()</span><span class="o">))</span>
        <span class="p">.</span><span class="nc">WithStandardOutputPipe</span><span class="p">(</span>
          <span class="nn">PipeTarget</span><span class="p">.</span><span class="nc">ToStream</span><span class="p">(</span><span class="nn">Console</span><span class="p">.</span><span class="nc">OpenStandardOutput</span><span class="bp">()</span><span class="p">)</span>
        <span class="p">)</span>

  <span class="k">let</span> <span class="n">stopFable</span> <span class="bp">()</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">activeFable</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Some</span> <span class="n">pid</span> <span class="p">-></span> <span class="n">killActiveProcess</span> <span class="n">pid</span>
    <span class="p">|</span> <span class="nc">None</span> <span class="p">-></span> <span class="n">printfn</span> <span class="s2">"No active Fable found"</span>

  <span class="k">let</span> <span class="n">startFable</span>
    <span class="p">(</span><span class="n">getCommand</span><span class="p">:</span> <span class="nc">FableConfig</span> <span class="n">option</span> <span class="p">-></span> <span class="nc">Command</span><span class="p">)</span>
    <span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nc">FableConfig</span> <span class="n">option</span><span class="p">)</span>
    <span class="p">=</span>
    <span class="n">task</span> <span class="p">{</span>
      <span class="c1">// Execute and wait for it to finish</span>
      <span class="k">let</span> <span class="n">cmdResult</span> <span class="p">=</span> <span class="n">getCommand</span><span class="p">(</span><span class="n">config</span><span class="o">).</span><span class="nc">ExecuteAsync</span><span class="bp">()</span>
      <span class="n">activeFable</span> <span class="p">&lt;-</span> <span class="nc">Some</span> <span class="n">cmdResult</span><span class="p">.</span><span class="nc">ProcessId</span>

      <span class="k">return</span><span class="o">!</span> <span class="n">cmdResult</span><span class="p">.</span><span class="nc">Task</span>
    <span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>Keeping the process ID on memory might not be the best idea and there can be better ways to handle that but at least for now it works just fine.</p>

<p>Calling the <code>startFable</code> function with fable options, will make fable run on the background, this allows us to have fable output JS files that we will be able to serve.</p>
<h2>
  <a name="reload-on-change" href="#reload-on-change">
  </a>
  Reload on change
</h2>

<p>Reloading on change was an interesting feature to do, first of all I needed a file watcher and I have had heard before that the .NET one wasn't really that great, I also needed to communicate with the frontend when something changed in the backend.</p>

<p>For the file watcher, I tried to search for good alternatives, but to be honest in the end I decided to go with the one in the BCL.</p>

<p>I was kind of scared though how would I manage multiple notifications and events without making it a mess? I had No idea... Thankfully <a href="http://fsprojects.github.io/FSharp.Control.Reactive/">FSharp.Control.Reactive</a> was found and is just what I needed. This library allows you to make observables from events and has a bunch of nice utility functions to work with stream like collections if you've used RxJS or RX.NET you will feel at home with it.<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight fsharp"><code>
  <span class="k">let</span> <span class="n">getFileWatcher</span> <span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nc">WatchConfig</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">watchers</span> <span class="p">=</span>
      <span class="c1">// monitor a particular list of  addresses</span>
      <span class="p">(</span><span class="n">defaultArg</span> <span class="n">config</span><span class="p">.</span><span class="n">directories</span> <span class="o">([</span> <span class="s2">"./src"</span> <span class="p">]</span> <span class="p">|></span> <span class="nn">Seq</span><span class="p">.</span><span class="n">ofList</span><span class="o">))</span>
      <span class="p">|></span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">dir</span> <span class="p">-></span>
        <span class="c1">// for each address create a file watcher</span>
        <span class="k">let</span> <span class="n">fsw</span> <span class="p">=</span> <span class="k">new</span> <span class="nc">FileSystemWatcher</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span>
        <span class="n">fsw</span><span class="p">.</span><span class="nc">IncludeSubdirectories</span> <span class="p">&lt;-</span> <span class="bp">true</span>
        <span class="n">fsw</span><span class="p">.</span><span class="nc">NotifyFilter</span> <span class="p">&lt;-</span> <span class="nn">NotifyFilters</span><span class="p">.</span><span class="nc">FileName</span> <span class="o">|||</span> <span class="nn">NotifyFilters</span><span class="p">.</span><span class="nc">Size</span>

        <span class="k">let</span> <span class="n">filters</span> <span class="p">=</span>
          <span class="n">defaultArg</span>
            <span class="n">config</span><span class="p">.</span><span class="n">extensions</span>
            <span class="p">(</span><span class="nn">Seq</span><span class="p">.</span><span class="n">ofList</span> <span class="p">[</span> <span class="s2">"*.js"</span>
                          <span class="s2">"*.css"</span>
                          <span class="s2">"*.ts"</span>
                          <span class="s2">"*.tsx"</span>
                          <span class="s2">"*.jsx"</span>
                          <span class="s2">"*.json"</span> <span class="o">])</span>
        <span class="c1">// ensure you're monitoring all of the</span>
        <span class="c1">// extensions you want to reload on change</span>
        <span class="k">for</span> <span class="n">filter</span> <span class="k">in</span> <span class="n">filters</span> <span class="k">do</span>
          <span class="n">fsw</span><span class="p">.</span><span class="nn">Filters</span><span class="p">.</span><span class="nc">Add</span><span class="p">(</span><span class="n">filter</span><span class="p">)</span>
        <span class="c1">// and ensure you will rise events for them :)</span>
        <span class="n">fsw</span><span class="p">.</span><span class="nc">EnableRaisingEvents</span> <span class="p">&lt;-</span> <span class="bp">true</span>
        <span class="n">fsw</span><span class="p">)</span>


    <span class="k">let</span> <span class="n">subs</span> <span class="p">=</span>
      <span class="n">watchers</span>
      <span class="p">|></span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">watcher</span> <span class="p">-></span>
        <span class="c1">// for each watche react to the following events</span>
        <span class="c1">// Renamed</span>
        <span class="c1">// Changed</span>
        <span class="c1">// Deleted</span>
        <span class="c1">// Created</span>
        <span class="p">[</span> <span class="n">watcher</span><span class="p">.</span><span class="nc">Renamed</span>
          <span class="c1">// To prevent overflows and weird behaviors</span>
          <span class="c1">// ensure to throttle the events</span>
          <span class="p">|></span> <span class="nn">Observable</span><span class="p">.</span><span class="n">throttle</span> <span class="p">(</span><span class="nn">TimeSpan</span><span class="p">.</span><span class="nc">FromMilliseconds</span><span class="p">(</span><span class="mi">400</span><span class="o">.))</span>
          <span class="p">|></span> <span class="nn">Observable</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">e</span> <span class="p">-></span>
            <span class="p">{</span> <span class="n">oldName</span> <span class="p">=</span> <span class="nc">Some</span> <span class="n">e</span><span class="p">.</span><span class="nc">OldName</span>
              <span class="nc">ChangeType</span> <span class="p">=</span> <span class="nc">Renamed</span>
              <span class="n">name</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nc">Name</span>
              <span class="n">path</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nc">FullPath</span> <span class="o">})</span>
          <span class="n">watcher</span><span class="p">.</span><span class="nc">Changed</span>
          <span class="p">|></span> <span class="nn">Observable</span><span class="p">.</span><span class="n">throttle</span> <span class="p">(</span><span class="nn">TimeSpan</span><span class="p">.</span><span class="nc">FromMilliseconds</span><span class="p">(</span><span class="mi">400</span><span class="o">.))</span>
          <span class="p">|></span> <span class="nn">Observable</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">e</span> <span class="p">-></span>
            <span class="p">{</span> <span class="n">oldName</span> <span class="p">=</span> <span class="nc">None</span>
              <span class="nc">ChangeType</span> <span class="p">=</span> <span class="nc">Changed</span>
              <span class="n">name</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nc">Name</span>
              <span class="n">path</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nc">FullPath</span> <span class="o">})</span>
          <span class="n">watcher</span><span class="p">.</span><span class="nc">Deleted</span>
          <span class="p">|></span> <span class="nn">Observable</span><span class="p">.</span><span class="n">throttle</span> <span class="p">(</span><span class="nn">TimeSpan</span><span class="p">.</span><span class="nc">FromMilliseconds</span><span class="p">(</span><span class="mi">400</span><span class="o">.))</span>
          <span class="p">|></span> <span class="nn">Observable</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">e</span> <span class="p">-></span>
            <span class="p">{</span> <span class="n">oldName</span> <span class="p">=</span> <span class="nc">None</span>
              <span class="nc">ChangeType</span> <span class="p">=</span> <span class="nc">Deleted</span>
              <span class="n">name</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nc">Name</span>
              <span class="n">path</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nc">FullPath</span> <span class="o">})</span>
          <span class="n">watcher</span><span class="p">.</span><span class="nc">Created</span>
          <span class="p">|></span> <span class="nn">Observable</span><span class="p">.</span><span class="n">throttle</span> <span class="p">(</span><span class="nn">TimeSpan</span><span class="p">.</span><span class="nc">FromMilliseconds</span><span class="p">(</span><span class="mi">400</span><span class="o">.))</span>
          <span class="p">|></span> <span class="nn">Observable</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">e</span> <span class="p">-></span>
            <span class="p">{</span> <span class="n">oldName</span> <span class="p">=</span> <span class="nc">None</span>
              <span class="nc">ChangeType</span> <span class="p">=</span> <span class="nc">Created</span>
              <span class="n">name</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nc">Name</span>
              <span class="n">path</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nc">FullPath</span> <span class="o">})</span> <span class="p">]</span>
        <span class="c1">// Merge these observables in a single one</span>
        <span class="p">|></span> <span class="nn">Observable</span><span class="p">.</span><span class="n">mergeSeq</span><span class="p">)</span>

    <span class="p">{</span> <span class="k">new</span> <span class="nc">IFileWatcher</span> <span class="k">with</span>
        <span class="k">override</span> <span class="o">_.</span><span class="nc">Dispose</span><span class="bp">()</span> <span class="p">:</span> <span class="kt">unit</span> <span class="p">=</span>
          <span class="n">watchers</span>
          <span class="c1">// when disposing, dispose every watcher you may have around</span>
          <span class="p">|></span> <span class="nn">Seq</span><span class="p">.</span><span class="n">iter</span> <span class="p">(</span><span class="k">fun</span> <span class="n">watcher</span> <span class="p">-></span> <span class="n">watcher</span><span class="p">.</span><span class="nc">Dispose</span><span class="bp">()</span><span class="p">)</span>

        <span class="k">override</span> <span class="o">_.</span><span class="nc">FileChanged</span><span class="p">:</span> <span class="nc">IObservable</span><span class="p">&lt;</span><span class="nc">FileChangedEvent</span><span class="p">></span> <span class="p">=</span>
          <span class="c1">// merge the the merged observables into a single one!!!</span>
          <span class="nn">Observable</span><span class="p">.</span><span class="n">mergeSeq</span> <span class="n">subs</span> <span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>With this setup you can easily observe changes to multiple directories and multiple extensions it might not be the most efficient way to do it, but It at least got me started with it, now that I had a way to know when something changed I needed to tell the browser what had happened.</p>

<p>For that I chose SSE (Server Sent Events) which is a really cool way to do real time notifications from the server exclusively without having to implement web sockets it's just an HTTP call which can be terminated (or not).<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight fsharp"><code>
  <span class="k">let</span> <span class="k">private</span> <span class="nc">Sse</span> <span class="p">(</span><span class="n">watchConfig</span><span class="p">:</span> <span class="nc">WatchConfig</span><span class="p">)</span> <span class="n">next</span> <span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="nc">HttpContext</span><span class="p">)</span> <span class="p">=</span>
    <span class="n">task</span> <span class="p">{</span>
      <span class="k">let</span> <span class="n">logger</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">GetLogger</span><span class="p">(</span><span class="s2">"Perla:SSE"</span><span class="p">)</span>
      <span class="n">logger</span><span class="p">.</span><span class="nc">LogInformation</span> <span class="o">$</span><span class="s2">"LiveReload Client Connected"</span>
      <span class="c1">// set up the correct headers</span>
      <span class="n">ctx</span><span class="p">.</span><span class="nc">SetHttpHeader</span><span class="p">(</span><span class="s2">"Content-Type"</span><span class="p">,</span> <span class="s2">"text/event-stream"</span><span class="p">)</span>
      <span class="n">ctx</span><span class="p">.</span><span class="nc">SetHttpHeader</span><span class="p">(</span><span class="s2">"Cache-Control"</span><span class="p">,</span> <span class="s2">"no-cache"</span><span class="p">)</span>
      <span class="n">ctx</span><span class="p">.</span><span class="nc">SetStatusCode</span> <span class="mi">200</span>

      <span class="c1">// send the first event</span>
      <span class="k">let</span> <span class="n">res</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">Response</span>
      <span class="k">do</span><span class="o">!</span> <span class="n">res</span><span class="p">.</span><span class="nc">WriteAsync</span><span class="o">($</span><span class="s2">"id:{ctx.Connection.Id}</span><span class="se">\n</span><span class="s2">data:{DateTime.Now}</span><span class="se">\n\n</span><span class="s2">"</span><span class="p">)</span>
      <span class="k">do</span><span class="o">!</span> <span class="n">res</span><span class="p">.</span><span class="nn">Body</span><span class="p">.</span><span class="nc">FlushAsync</span><span class="bp">()</span>

      <span class="c1">// get the observable of file changes</span>
      <span class="k">let</span> <span class="n">watcher</span> <span class="p">=</span> <span class="nn">Fs</span><span class="p">.</span><span class="n">getFileWatcher</span> <span class="n">watchConfig</span>

      <span class="n">logger</span><span class="p">.</span><span class="nc">LogInformation</span> <span class="o">$</span><span class="s2">"Watching %A{watchConfig.directories} for changes"</span>

      <span class="k">let</span> <span class="n">onChangeSub</span> <span class="p">=</span>
        <span class="n">watcher</span><span class="p">.</span><span class="nc">FileChanged</span>
        <span class="p">|></span> <span class="nn">Observable</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="k">event</span> <span class="p">-></span>
          <span class="n">task</span> <span class="p">{</span>
            <span class="k">match</span> <span class="nn">Path</span><span class="p">.</span><span class="nc">GetExtension</span> <span class="k">event</span><span class="p">.</span><span class="n">name</span> <span class="k">with</span>
            <span class="p">|</span> <span class="nc">Css</span> <span class="p">-></span>
              <span class="c1">// if the change was on a CSS file send the new content</span>
              <span class="k">let</span><span class="o">!</span> <span class="n">content</span> <span class="p">=</span> <span class="nn">File</span><span class="p">.</span><span class="nc">ReadAllTextAsync</span> <span class="k">event</span><span class="p">.</span><span class="n">path</span>

              <span class="k">let</span> <span class="n">data</span> <span class="p">=</span>
                <span class="nn">Json</span><span class="p">.</span><span class="nc">ToTextMinified</span><span class="p">(</span>
                  <span class="o">{|</span> <span class="n">oldName</span> <span class="p">=</span>
                      <span class="k">event</span><span class="p">.</span><span class="n">oldName</span>
                      <span class="p">|></span> <span class="nn">Option</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">value</span> <span class="p">-></span>
                        <span class="k">match</span> <span class="n">value</span> <span class="k">with</span>
                        <span class="p">|</span> <span class="nc">Css</span> <span class="p">-></span> <span class="n">value</span>
                        <span class="p">|</span> <span class="p">_</span> <span class="p">-></span> <span class="s2">""</span><span class="p">)</span>
                     <span class="n">name</span> <span class="p">=</span> <span class="k">event</span><span class="p">.</span><span class="n">path</span>
                     <span class="n">content</span> <span class="p">=</span> <span class="n">content</span> <span class="o">|}</span>
                <span class="p">)</span>
              <span class="c1">// CSS HMR was basically free!</span>
              <span class="k">do</span><span class="o">!</span> <span class="n">res</span><span class="p">.</span><span class="nc">WriteAsync</span> <span class="o">$</span><span class="s2">"event:replace-css</span><span class="se">\n</span><span class="s2">data:{data}</span><span class="se">\n\n</span><span class="s2">"</span>
              <span class="k">return</span><span class="o">!</span> <span class="n">res</span><span class="p">.</span><span class="nn">Body</span><span class="p">.</span><span class="nc">FlushAsync</span><span class="bp">()</span>
            <span class="c1">// if it's any other file well... just reload</span>
            <span class="p">|</span> <span class="nc">Typescript</span>
            <span class="p">|</span> <span class="nc">Javascript</span>
            <span class="p">|</span> <span class="nc">Jsx</span>
            <span class="p">|</span> <span class="nc">Json</span>
            <span class="p">|</span> <span class="nc">Other</span> <span class="p">_</span> <span class="p">-></span>
              <span class="k">let</span> <span class="n">data</span> <span class="p">=</span>
                <span class="nn">Json</span><span class="p">.</span><span class="nc">ToTextMinified</span><span class="p">(</span>
                  <span class="o">{|</span> <span class="n">oldName</span> <span class="p">=</span> <span class="k">event</span><span class="p">.</span><span class="n">oldName</span>
                     <span class="n">name</span> <span class="p">=</span> <span class="k">event</span><span class="p">.</span><span class="n">name</span> <span class="o">|}</span>
                <span class="p">)</span>

              <span class="n">logger</span><span class="p">.</span><span class="nc">LogInformation</span> <span class="o">$</span><span class="s2">"LiveReload File Changed: {event.name}"</span>
              <span class="k">do</span><span class="o">!</span> <span class="n">res</span><span class="p">.</span><span class="nc">WriteAsync</span> <span class="o">$</span><span class="s2">"event:reload</span><span class="se">\n</span><span class="s2">data:{data}</span><span class="se">\n\n</span><span class="s2">"</span>
              <span class="k">return</span><span class="o">!</span> <span class="n">res</span><span class="p">.</span><span class="nn">Body</span><span class="p">.</span><span class="nc">FlushAsync</span><span class="bp">()</span>
          <span class="o">})</span>
        <span class="c1">// ensure the task gets done</span>
        <span class="p">|></span> <span class="nn">Observable</span><span class="p">.</span><span class="n">switchTask</span>
        <span class="p">|></span> <span class="nn">Observable</span><span class="p">.</span><span class="n">subscribe</span> <span class="n">ignore</span>
      <span class="c1">// if the client closes the browser</span>
      <span class="c1">// then dispose these resources</span>
      <span class="n">ctx</span><span class="p">.</span><span class="nn">RequestAborted</span><span class="p">.</span><span class="nc">Register</span> <span class="p">(</span><span class="k">fun</span> <span class="p">_</span> <span class="p">-></span>
        <span class="n">watcher</span><span class="p">.</span><span class="nc">Dispose</span><span class="bp">()</span>
        <span class="n">onChangeSub</span><span class="p">.</span><span class="nc">Dispose</span><span class="bp">()</span><span class="p">)</span>
      <span class="p">|></span> <span class="n">ignore</span>

      <span class="c1">// keep the connection alive</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="c1">// TBH there must be a better way to do it</span>
        <span class="c1">// but since this is not critical, it works just fine</span>
        <span class="k">do</span><span class="o">!</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">Sleep</span><span class="p">(</span><span class="nn">TimeSpan</span><span class="p">.</span><span class="nc">FromSeconds</span> <span class="mi">1</span><span class="o">.)</span>

      <span class="k">return</span><span class="o">!</span> <span class="n">text</span> <span class="s2">""</span> <span class="n">next</span> <span class="n">ctx</span>
    <span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>At this time, I also <a href="https://dev.to/tunaxor/server-sent-events-with-saturn-and-fsharp-m6b">published about SSE</a> on my blog, I really felt it was a really cool thing and decided to share it with the rest of the world :)</p>
<h2>
  <a name="install-dependencies" href="#install-dependencies">
  </a>
  Install dependencies
</h2>

<p>I was really undecided if I wanted to pursue a webpack alernative because</p>

<ul>
<li>How can you install dependencies without npm?</li>
<li>Do you really want to do

<ul>
<li><code>import { useState } from 'https://cdn.skypack.dev/pin/react@v17.0.1-yH0aYV1FOvoIPeKBbHxg/mode=imports,min/optimized/react.js'</code></li>
</ul>
</li>
</ul>

<p>On every damned file? oh no no no, I don't think so... Enter the Import Maps, this feature (along esbuild) was the thing that made me realize it was actually possible to ditch out node/webpack/npm entirely (at least in a local and direct way) instead of doing that ugly import from above, if you can provide a import map with your dependencies the rest should be relatively easy<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight html"><code><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"importmap"</span><span class="nt">></span>
  <span class="p">{</span>
    <span class="dl">"</span><span class="s2">imports</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">moment</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">https://ga.jspm.io/npm:moment@2.29.1/moment.js</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">lodash</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">https://cdn.skypack.dev/lodash</span><span class="dl">"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="nt">&lt;/script></span>
<span class="c">&lt;!-- Allows you to do the next  --></span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"module"</span><span class="nt">></span>
  <span class="k">import</span> <span class="nx">moment</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">moment</span><span class="dl">"</span><span class="p">;</span>
  <span class="k">import</span> <span class="nx">lodash</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">lodash</span><span class="dl">"</span><span class="p">;</span>
<span class="nt">&lt;/script></span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<blockquote class="ltag__twitter-tweet" data-url="https://twitter.com/angel_d_munoz/status/1439457103433936897">
    <div class="ltag__twitter-tweet__media ltag__twitter-tweet__media__two-pics">
      <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--Q7FakYrf--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://pbs.twimg.com/media/E_n3i0OWYAQ4Wcs.png" alt="unknown tweet media content" loading="lazy">
    </div>

  <div class="ltag__twitter-tweet__main" data-url="https://twitter.com/angel_d_munoz/status/1439457103433936897">
    <div class="ltag__twitter-tweet__header">
      <img class="ltag__twitter-tweet__profile-image" src="https://res.cloudinary.com/practicaldev/image/fetch/s--s15CcGpw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://pbs.twimg.com/profile_images/1427821392662339584/ev-ZMAoV_normal.jpg" alt="Angel Munoz profile image" loading="lazy">
      <div class="ltag__twitter-tweet__full-name">
        Angel Munoz
      </div>
      <div class="ltag__twitter-tweet__username">
        @angel_d_munoz
      </div>
      <div class="ltag__twitter-tweet__twitter-logo">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--ir1kO05j--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-f95605061196010f91e64806688390eb1a4dbc9e913682e043eb8b1e06ca484f.svg" alt="twitter logo" loading="lazy">
      </div>
    </div>
    <div class="ltag__twitter-tweet__body">
      Here's something towards a node'less frontend development for <a href="https://twitter.com/hashtag/fsharp">#fsharp</a> with help of <a href="https://twitter.com/skypackjs">@skypackjs</a> <br>The cli tool "installs" a package (i.e. grabs a skypack lookup url) and saves: import map, lock, dependency this import map is added to the index file 
    </div>
    <div class="ltag__twitter-tweet__date">
      05:11 AM - 19 Sep 2021
    </div>


    <div class="ltag__twitter-tweet__actions">
      <a href="https://twitter.com/intent/tweet?in_reply_to=1439457103433936897" class="ltag__twitter-tweet__actions__button">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--fFnoeFxk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-reply-action-238fe0a37991706a6880ed13941c3efd6b371e4aefe288fe8e0db85250708bc4.svg" alt="Twitter reply action" loading="lazy">
      </a>
      <a href="https://twitter.com/intent/retweet?tweet_id=1439457103433936897" class="ltag__twitter-tweet__actions__button">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--k6dcrOn8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-retweet-action-632c83532a4e7de573c5c08dbb090ee18b348b13e2793175fea914827bc42046.svg" alt="Twitter retweet action" loading="lazy">
      </a>
      <a href="https://twitter.com/intent/like?tweet_id=1439457103433936897" class="ltag__twitter-tweet__actions__button">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--SRQc9lOp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-like-action-1ea89f4b87c7d37465b0eb78d51fcb7fe6c03a089805d7ea014ba71365be5171.svg" alt="Twitter like action" loading="lazy">
      </a>
    </div>
  </div>
</blockquote>
 

<p>So here I was trying to replicate a version of <code>package.json</code> this ended up implementing the <code>perla.jsonc.lock</code> file which is not precisely a <em>lock</em> file, while the URL's there are certainly the pined and production versions of those packages, it's in reality the <em><strong>import map</strong></em> in disguise, to get that information though I had to investigate how to do it. Once again I decided to study snowpack since it's the only frontend dev tool I know it has this kind of mechanism (remote sources), after some investigation and some PoC's I also stumbled upon JSPM's recently released <a href="https://generator.jspm.io/">Import Map Generator</a> which is basically what I wanted to do! Skypack, JSPM and Unpkg offer reliable CDN services for production with all of these investigations and gathered knowledge I went to implement fetching dependencies and "<em>installing</em>" them with the dev server tool.<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight fsharp"><code>
<span class="p">[&lt;</span><span class="nc">RequireQualifiedAccessAttribute</span><span class="p">>]</span>
<span class="k">module</span> <span class="k">internal</span> <span class="nc">Http</span> <span class="p">=</span>
  <span class="k">open</span> <span class="nc">Flurl</span>
  <span class="k">open</span> <span class="nn">Flurl</span><span class="p">.</span><span class="nc">Http</span>

  <span class="p">[&lt;</span><span class="nc">Literal</span><span class="p">>]</span>
  <span class="k">let</span> <span class="nc">SKYPACK_CDN</span> <span class="p">=</span> <span class="s2">"https://cdn.skypack.dev"</span>

  <span class="p">[&lt;</span><span class="nc">Literal</span><span class="p">>]</span>
  <span class="k">let</span> <span class="nc">SKYPACK_API</span> <span class="p">=</span> <span class="s2">"https://api.skypack.dev/v1"</span>

  <span class="p">[&lt;</span><span class="nc">Literal</span><span class="p">>]</span>
  <span class="k">let</span> <span class="nc">JSPM_API</span> <span class="p">=</span> <span class="s2">"https://api.jspm.io/generate"</span>

  <span class="k">let</span> <span class="k">private</span> <span class="n">getSkypackInfo</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">alias</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">=</span>
    <span class="c1">// FsToolkit.ErrorHandling FTW</span>
    <span class="n">taskResult</span> <span class="p">{</span>
      <span class="k">try</span>
        <span class="k">let</span> <span class="n">info</span> <span class="p">=</span> <span class="o">{|</span> <span class="n">lookUp</span> <span class="p">=</span> <span class="o">$</span><span class="s2">"%s{name}"</span> <span class="o">|}</span>
        <span class="k">let</span><span class="o">!</span> <span class="n">res</span> <span class="p">=</span> <span class="o">$</span><span class="s2">"{SKYPACK_CDN}/{info.lookUp}"</span><span class="p">.</span><span class="nc">GetAsync</span><span class="bp">()</span>

        <span class="k">if</span> <span class="n">res</span><span class="p">.</span><span class="nc">StatusCode</span> <span class="o">>=</span> <span class="mi">400</span> <span class="k">then</span>
          <span class="k">return</span><span class="o">!</span> <span class="nc">PackageNotFoundException</span> <span class="p">|></span> <span class="nc">Error</span>

        <span class="k">let</span> <span class="k">mutable</span> <span class="n">pinnedUrl</span> <span class="p">=</span> <span class="s2">""</span>
        <span class="k">let</span> <span class="k">mutable</span> <span class="n">importUrl</span> <span class="p">=</span> <span class="s2">""</span>
        <span class="c1">// try to get the pinned URL from the headers</span>
        <span class="k">let</span> <span class="n">info</span> <span class="p">=</span>
          <span class="k">if</span>
            <span class="n">res</span><span class="p">.</span><span class="nn">Headers</span><span class="p">.</span><span class="nc">TryGetFirst</span><span class="p">(</span><span class="s2">"x-pinned-url"</span><span class="p">,</span> <span class="p">&</span><span class="n">pinnedUrl</span><span class="p">)</span>
            <span class="p">|></span> <span class="k">not</span>
          <span class="k">then</span>
            <span class="o">{|</span> <span class="n">info</span> <span class="k">with</span> <span class="n">pin</span> <span class="p">=</span> <span class="nc">None</span> <span class="o">|}</span>
          <span class="k">else</span>
            <span class="o">{|</span> <span class="n">info</span> <span class="k">with</span> <span class="n">pin</span> <span class="p">=</span> <span class="nc">Some</span> <span class="n">pinnedUrl</span> <span class="o">|}</span>

        <span class="c1">// and the imports as well</span>
        <span class="k">let</span> <span class="n">info</span> <span class="p">=</span>
          <span class="k">if</span>
            <span class="n">res</span><span class="p">.</span><span class="nn">Headers</span><span class="p">.</span><span class="nc">TryGetFirst</span><span class="p">(</span><span class="s2">"x-import-url"</span><span class="p">,</span> <span class="p">&</span><span class="n">importUrl</span><span class="p">)</span>
            <span class="p">|></span> <span class="k">not</span>
          <span class="k">then</span>
            <span class="o">{|</span> <span class="n">info</span> <span class="k">with</span> <span class="n">import</span> <span class="p">=</span> <span class="nc">None</span> <span class="o">|}</span>
          <span class="k">else</span>
            <span class="o">{|</span> <span class="n">info</span> <span class="k">with</span> <span class="n">import</span> <span class="p">=</span> <span class="nc">Some</span> <span class="n">importUrl</span> <span class="o">|}</span>

        <span class="k">return</span>
          <span class="c1">// generate the corresponding import map entry</span>
          <span class="p">[</span> <span class="n">alias</span><span class="p">,</span> <span class="o">$</span><span class="s2">"{SKYPACK_CDN}{info.pin |> Option.defaultValue info.lookUp}"</span> <span class="o">],</span>
          <span class="c1">// skypack doesn't handle any import maps so the scopes will always be empty</span>
          <span class="bp">[]</span>
      <span class="k">with</span>
      <span class="p">|</span> <span class="o">:?</span> <span class="nn">Flurl</span><span class="p">.</span><span class="nn">Http</span><span class="p">.</span><span class="nc">FlurlHttpException</span> <span class="k">as</span> <span class="n">ex</span> <span class="p">-></span>
        <span class="k">match</span> <span class="n">ex</span><span class="p">.</span><span class="nc">StatusCode</span> <span class="p">|></span> <span class="nn">Option</span><span class="p">.</span><span class="n">ofNullable</span> <span class="k">with</span>
        <span class="p">|</span> <span class="nc">Some</span> <span class="n">code</span> <span class="k">when</span> <span class="n">code</span> <span class="o">>=</span> <span class="mi">400</span> <span class="p">-></span>
          <span class="k">return</span><span class="o">!</span> <span class="nc">PackageNotFoundException</span> <span class="p">|></span> <span class="nc">Error</span>
        <span class="p">|</span> <span class="p">_</span> <span class="p">-></span> <span class="bp">()</span>

        <span class="k">return</span><span class="o">!</span> <span class="n">ex</span> <span class="p">:></span> <span class="nc">Exception</span> <span class="p">|></span> <span class="nc">Error</span>
      <span class="p">|</span> <span class="n">ex</span> <span class="p">-></span> <span class="k">return</span><span class="o">!</span> <span class="n">ex</span> <span class="p">|></span> <span class="nc">Error</span>
    <span class="p">}</span>

  <span class="k">let</span> <span class="n">getJspmInfo</span> <span class="n">name</span> <span class="n">alias</span> <span class="n">source</span> <span class="p">=</span>
    <span class="n">taskResult</span> <span class="p">{</span>
      <span class="k">let</span> <span class="n">queryParams</span> <span class="p">=</span>
        <span class="o">{|</span> <span class="n">install</span> <span class="p">=</span> <span class="p">[|</span> <span class="o">$</span><span class="s2">"{name}"</span> <span class="p">|]</span>
           <span class="n">env</span> <span class="p">=</span> <span class="s2">"browser"</span>
           <span class="n">provider</span> <span class="p">=</span>
           <span class="c1">// JSPM offer various reliable sources</span>
           <span class="c1">// to get your dependencies</span>
            <span class="k">match</span> <span class="n">source</span> <span class="k">with</span>
            <span class="p">|</span> <span class="nn">Source</span><span class="p">.</span><span class="nc">Skypack</span> <span class="p">-></span> <span class="s2">"skypack"</span>
            <span class="p">|</span> <span class="nn">Source</span><span class="p">.</span><span class="nc">Jspm</span> <span class="p">-></span> <span class="s2">"jspm"</span>
            <span class="p">|</span> <span class="nn">Source</span><span class="p">.</span><span class="nc">Jsdelivr</span> <span class="p">-></span> <span class="s2">"jsdelivr"</span>
            <span class="p">|</span> <span class="nn">Source</span><span class="p">.</span><span class="nc">Unpkg</span> <span class="p">-></span> <span class="s2">"unpkg"</span>
            <span class="p">|</span> <span class="p">_</span> <span class="p">-></span>
              <span class="n">printfn</span>
                <span class="o">$</span><span class="s2">"Warn: An unknown provider has been specied: [{source}] defaulting to jspm"</span>

              <span class="s2">"jspm"</span> <span class="o">|}</span>

      <span class="k">try</span>
        <span class="k">let</span><span class="o">!</span> <span class="n">res</span> <span class="p">=</span>
          <span class="nn">JSPM_API</span>
            <span class="p">.</span><span class="nc">SetQueryParams</span><span class="p">(</span><span class="n">queryParams</span><span class="p">)</span>
            <span class="p">.</span><span class="nc">GetJsonAsync</span><span class="p">&lt;</span><span class="nc">JspmResponse</span><span class="o">>()</span>

        <span class="k">let</span> <span class="n">scopes</span> <span class="p">=</span>
          <span class="c1">// F# type serialization hits again!</span>
          <span class="c1">// the JSPM response may include a scope object or not</span>
          <span class="c1">// so try to safely check if it exists or not</span>
          <span class="k">match</span> <span class="n">res</span><span class="p">.</span><span class="n">map</span><span class="p">.</span><span class="n">scopes</span> <span class="p">:></span> <span class="n">obj</span> <span class="p">|></span> <span class="nn">Option</span><span class="p">.</span><span class="n">ofObj</span> <span class="k">with</span>
          <span class="p">|</span> <span class="nc">None</span> <span class="p">-></span> <span class="nn">Map</span><span class="p">.</span><span class="n">empty</span>
          <span class="p">|</span> <span class="nc">Some</span> <span class="n">value</span> <span class="p">-></span> <span class="n">value</span> <span class="o">:?></span> <span class="nc">Map</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="nc">Scope</span><span class="p">></span>

        <span class="k">return</span>
          <span class="c1">// generate the corresponding import map</span>
          <span class="c1">// entries as well as the scopes</span>
          <span class="n">res</span><span class="p">.</span><span class="n">map</span><span class="p">.</span><span class="n">imports</span>
          <span class="p">|></span> <span class="nn">Map</span><span class="p">.</span><span class="n">toList</span>
          <span class="p">|></span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="p">-></span> <span class="n">alias</span><span class="p">,</span> <span class="n">v</span><span class="o">),</span>
          <span class="n">scopes</span> <span class="p">|></span> <span class="nn">Map</span><span class="p">.</span><span class="n">toList</span>
      <span class="k">with</span>
      <span class="p">|</span> <span class="o">:?</span> <span class="nn">Flurl</span><span class="p">.</span><span class="nn">Http</span><span class="p">.</span><span class="nc">FlurlHttpException</span> <span class="k">as</span> <span class="n">ex</span> <span class="p">-></span>
        <span class="k">match</span> <span class="n">ex</span><span class="p">.</span><span class="nc">StatusCode</span> <span class="p">|></span> <span class="nn">Option</span><span class="p">.</span><span class="n">ofNullable</span> <span class="k">with</span>
        <span class="p">|</span> <span class="nc">Some</span> <span class="n">code</span> <span class="k">when</span> <span class="n">code</span> <span class="o">>=</span> <span class="mi">400</span> <span class="p">-></span>
          <span class="k">return</span><span class="o">!</span> <span class="nc">PackageNotFoundException</span> <span class="p">|></span> <span class="nc">Error</span>
        <span class="p">|</span> <span class="p">_</span> <span class="p">-></span> <span class="bp">()</span>

        <span class="k">return</span><span class="o">!</span> <span class="n">ex</span> <span class="p">:></span> <span class="nc">Exception</span> <span class="p">|></span> <span class="nc">Error</span>
    <span class="p">}</span>

  <span class="k">let</span> <span class="n">getPackageUrlInfo</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">alias</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nc">Source</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">source</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nn">Source</span><span class="p">.</span><span class="nc">Skypack</span> <span class="p">-></span> <span class="n">getSkypackInfo</span> <span class="n">name</span> <span class="n">alias</span>
    <span class="p">|</span> <span class="p">_</span> <span class="p">-></span> <span class="n">getJspmInfo</span> <span class="n">name</span> <span class="n">alias</span> <span class="n">source</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>This was a relatively low effort to implement but it did require finding a way to gather these resources so they can be mapped to json objects. This approach also allows you yo import different version fo the same package in the same application! that can be useful when you want to migrate dependencies slowly rolling them out.</p>
<h2>
  <a name="production-bundles" href="#production-bundles">
  </a>
  Production Bundles
</h2>

<p>Just as Installing dependencies, having a production ready build is critical This is where <a href="https://esbuild.github.io/">esbuild</a> finally comes into the picture it is a crucial piece of the puzzle. Esbuild while it's written in go and offers a npm package, it provides a single executable binary which can be used in a lot of platforms and and architectures, it distributes itself through the npm registry so it's about downloading the package in the correct way and just executing it like we did for the fable command.<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight fsharp"><code><span class="k">let</span> <span class="n">esbuildJsCmd</span> <span class="p">(</span><span class="n">entryPoint</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nc">BuildConfig</span><span class="p">)</span> <span class="p">=</span>

  <span class="k">let</span> <span class="n">dirName</span> <span class="p">=</span>
    <span class="p">(</span><span class="nn">Path</span><span class="p">.</span><span class="nc">GetDirectoryName</span> <span class="n">entryPoint</span><span class="p">)</span>
      <span class="p">.</span><span class="nc">Split</span><span class="p">(</span><span class="nn">Path</span><span class="p">.</span><span class="nc">DirectorySeparatorChar</span><span class="p">)</span>
    <span class="p">|></span> <span class="nn">Seq</span><span class="p">.</span><span class="n">last</span>

  <span class="k">let</span> <span class="n">outDir</span> <span class="p">=</span>
    <span class="k">match</span> <span class="n">config</span><span class="p">.</span><span class="n">outDir</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Some</span> <span class="n">outdir</span> <span class="p">-></span> <span class="nn">Path</span><span class="p">.</span><span class="nc">Combine</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">dirName</span><span class="p">)</span> <span class="p">|></span> <span class="nc">Some</span>
    <span class="p">|</span> <span class="nc">None</span> <span class="p">-></span> <span class="nn">Path</span><span class="p">.</span><span class="nc">Combine</span><span class="p">(</span><span class="s2">"./dist"</span><span class="p">,</span> <span class="n">dirName</span><span class="p">)</span> <span class="p">|></span> <span class="nc">Some</span>

  <span class="k">let</span> <span class="n">execBin</span> <span class="p">=</span> <span class="n">defaultArg</span> <span class="n">config</span><span class="p">.</span><span class="n">esBuildPath</span> <span class="n">esbuildExec</span>

  <span class="k">let</span> <span class="n">fileLoaders</span> <span class="p">=</span> <span class="n">getDefaultLoders</span> <span class="n">config</span>

  <span class="nn">Cli</span>
    <span class="p">.</span><span class="nc">Wrap</span><span class="p">(</span><span class="n">execBin</span><span class="p">)</span>
    <span class="p">.</span><span class="nc">WithStandardErrorPipe</span><span class="p">(</span><span class="nn">PipeTarget</span><span class="p">.</span><span class="nc">ToStream</span><span class="p">(</span><span class="nn">Console</span><span class="p">.</span><span class="nc">OpenStandardError</span><span class="bp">()</span><span class="o">))</span>
    <span class="p">.</span><span class="nc">WithStandardOutputPipe</span><span class="p">(</span><span class="nn">PipeTarget</span><span class="p">.</span><span class="nc">ToStream</span><span class="p">(</span><span class="nn">Console</span><span class="p">.</span><span class="nc">OpenStandardOutput</span><span class="bp">()</span><span class="o">))</span>
    <span class="c1">// CliWrap simply allows us to add arguments to commands very easy</span>
    <span class="p">.</span><span class="nc">WithArguments</span><span class="p">(</span><span class="k">fun</span> <span class="n">args</span> <span class="p">-></span>
      <span class="n">args</span><span class="p">.</span><span class="nc">Add</span><span class="p">(</span><span class="n">entryPoint</span><span class="p">)</span>
      <span class="p">|></span> <span class="n">addEsExternals</span> <span class="n">config</span><span class="p">.</span><span class="n">externals</span>
      <span class="p">|></span> <span class="n">addIsBundle</span> <span class="n">config</span><span class="p">.</span><span class="n">bundle</span>
      <span class="p">|></span> <span class="n">addTarget</span> <span class="n">config</span><span class="p">.</span><span class="n">target</span>
      <span class="p">|></span> <span class="n">addDefaultFileLoaders</span> <span class="n">fileLoaders</span>
      <span class="p">|></span> <span class="n">addMinify</span> <span class="n">config</span><span class="p">.</span><span class="n">minify</span>
      <span class="p">|></span> <span class="n">addFormat</span> <span class="n">config</span><span class="p">.</span><span class="n">format</span>
      <span class="p">|></span> <span class="n">addInjects</span> <span class="n">config</span><span class="p">.</span><span class="n">injects</span>
      <span class="p">|></span> <span class="n">addOutDir</span> <span class="n">outDir</span>
      <span class="p">|></span> <span class="n">ignore</span><span class="p">)</span>

</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>the CLI API from esbuild is pretty simple to be honest and is really effective when it comes to transpilation the benefits are that it not just transpiles Javascript, it also transpiles typescript, jsx and tsx files. Adding to those features esbuild is blazing fast.</p>
<h1>
  <a name="transpilation-on-the-fly" href="#transpilation-on-the-fly">
  </a>
  Transpilation on the fly
</h1>

<p>The dev server not only needs to serve JS content to the browser, often it needs to serve Typescript/JSX/TSX as well, and as we found earlier in the post if you serve static content your options for transforming or manipulating these request are severely limited, so I had to make particular middlewares to enable compiling single files on the fly.<br>
let's check a little bit how these are somewhat laid out on Perla<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight fsharp"><code><span class="p">[&lt;</span><span class="nc">RequireQualifiedAccess</span><span class="p">>]</span>
<span class="k">module</span> <span class="nc">Middleware</span> <span class="p">=</span>
    <span class="c1">// this function helps us determine a particular extension is in the request path</span>
    <span class="c1">// if it is we  will use one of the middlewares below on the calling site.</span>
    <span class="k">let</span> <span class="n">transformPredicate</span> <span class="p">(</span><span class="n">extensions</span><span class="p">:</span> <span class="kt">string</span> <span class="kt">list</span><span class="p">)</span> <span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="nc">HttpContext</span><span class="p">)</span> <span class="p">=</span> <span class="o">...</span>

    <span class="k">let</span> <span class="n">cssImport</span>
        <span class="p">(</span><span class="n">mountedDirs</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="o">>)</span>
        <span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="nc">HttpContext</span><span class="p">)</span>
        <span class="p">(</span><span class="n">next</span><span class="p">:</span> <span class="nc">Func</span><span class="p">&lt;</span><span class="nc">Task</span><span class="o">>)</span> <span class="p">=</span> <span class="o">...</span>

    <span class="k">let</span> <span class="n">jsonImport</span>
        <span class="p">(</span><span class="n">mountedDirs</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="o">>)</span>
        <span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="nc">HttpContext</span><span class="p">)</span>
        <span class="p">(</span><span class="n">next</span><span class="p">:</span> <span class="nc">Func</span><span class="p">&lt;</span><span class="nc">Task</span><span class="o">>)</span> <span class="p">=</span> <span class="o">...</span>

    <span class="k">let</span> <span class="n">jsImport</span>
        <span class="p">(</span><span class="n">buildConfig</span><span class="p">:</span> <span class="nc">BuildConfig</span> <span class="n">option</span><span class="p">)</span>
        <span class="p">(</span><span class="n">mountedDirs</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="o">>)</span>
        <span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="nc">HttpContext</span><span class="p">)</span>
        <span class="p">(</span><span class="n">next</span><span class="p">:</span> <span class="nc">Func</span><span class="p">&lt;</span><span class="nc">Task</span><span class="o">>)</span> <span class="p">=</span>
        <span class="n">task</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">logger</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">GetLogger</span><span class="p">(</span><span class="s2">"Perla Middleware"</span><span class="p">)</span>

        <span class="k">if</span>
            <span class="c1">// for the moment, we just serve the JS as is and don't process it</span>
            <span class="n">ctx</span><span class="p">.</span><span class="nn">Request</span><span class="p">.</span><span class="nn">Path</span><span class="p">.</span><span class="nn">Value</span><span class="p">.</span><span class="nc">Contains</span><span class="p">(</span><span class="s2">"~perla~"</span><span class="p">)</span>
            <span class="o">||</span> <span class="n">ctx</span><span class="p">.</span><span class="nn">Request</span><span class="p">.</span><span class="nn">Path</span><span class="p">.</span><span class="nn">Value</span><span class="p">.</span><span class="nc">Contains</span><span class="p">(</span><span class="s2">".js"</span><span class="p">)</span> <span class="p">|></span> <span class="k">not</span>
        <span class="k">then</span>
            <span class="k">return</span><span class="o">!</span> <span class="n">next</span><span class="p">.</span><span class="nc">Invoke</span><span class="bp">()</span>
        <span class="k">else</span>

            <span class="k">let</span> <span class="n">path</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nn">Request</span><span class="p">.</span><span class="nn">Path</span><span class="p">.</span><span class="nc">Value</span>
            <span class="n">logger</span><span class="p">.</span><span class="nc">LogInformation</span><span class="o">($</span><span class="s2">"Serving {path}"</span><span class="p">)</span>

            <span class="k">let</span> <span class="n">baseDir</span><span class="p">,</span> <span class="n">baseName</span> <span class="p">=</span>
                <span class="c1">// check if we're actually monitoring this directory and this file extension</span>
                <span class="n">mountedDirs</span>
                <span class="p">|></span> <span class="nn">Map</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="p">_</span> <span class="n">v</span> <span class="p">-></span> <span class="nn">String</span><span class="p">.</span><span class="nc">IsNullOrWhiteSpace</span> <span class="n">v</span> <span class="p">|></span> <span class="k">not</span><span class="p">)</span>
                <span class="p">|></span> <span class="nn">Map</span><span class="p">.</span><span class="n">toSeq</span>
                <span class="p">|></span> <span class="nn">Seq</span><span class="p">.</span><span class="n">find</span> <span class="p">(</span><span class="k">fun</span> <span class="o">(_,</span> <span class="n">v</span><span class="p">)</span> <span class="p">-></span> <span class="n">path</span><span class="p">.</span><span class="nc">StartsWith</span><span class="p">(</span><span class="n">v</span><span class="o">))</span>

            <span class="c1">// find the file on disk</span>
            <span class="k">let</span> <span class="n">filePath</span> <span class="p">=</span>
                <span class="k">let</span> <span class="n">fileName</span> <span class="p">=</span>
                    <span class="n">path</span><span class="p">.</span><span class="nc">Replace</span><span class="o">($</span><span class="s2">"{baseName}/"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="nn">StringComparison</span><span class="p">.</span><span class="nc">InvariantCulture</span><span class="p">)</span>

                <span class="nn">Path</span><span class="p">.</span><span class="nc">Combine</span><span class="p">(</span><span class="n">baseDir</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>
            <span class="c1">// we will serve javascript regardless of what we find on disk</span>
            <span class="n">ctx</span><span class="p">.</span><span class="nc">SetContentType</span> <span class="s2">"text/javascript"</span>

            <span class="k">try</span>
                <span class="k">if</span> <span class="nn">Path</span><span class="p">.</span><span class="nc">GetExtension</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span> <span class="p">&lt;></span> <span class="s2">".js"</span> <span class="k">then</span>
                    <span class="k">return</span> <span class="n">failwith</span> <span class="s2">"Not a JS file, Try looking with another extension."</span>
                <span class="c1">// if the file exists on disk</span>
                <span class="c1">// and has a js extension then just send it as is</span>
                <span class="c1">// the browser should be able to interpret it</span>
                <span class="k">let</span><span class="o">!</span> <span class="n">content</span> <span class="p">=</span> <span class="nn">File</span><span class="p">.</span><span class="nc">ReadAllBytesAsync</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>
                <span class="k">do</span><span class="o">!</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">WriteBytesAsync</span> <span class="n">content</span> <span class="p">:></span> <span class="nc">Task</span>
            <span class="k">with</span>
            <span class="p">|</span> <span class="n">ex</span> <span class="p">-></span>
                <span class="k">let</span><span class="o">!</span> <span class="n">fileData</span> <span class="p">=</span> <span class="nn">Esbuild</span><span class="p">.</span><span class="n">tryCompileFile</span> <span class="n">filePath</span> <span class="n">buildConfig</span>

                <span class="k">match</span> <span class="n">fileData</span> <span class="k">with</span>
                <span class="p">|</span> <span class="nc">Ok</span> <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span> <span class="p">-></span>
                    <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="nc">IsNullOrWhiteSpace</span> <span class="n">stderr</span> <span class="p">|></span> <span class="k">not</span> <span class="k">then</span>
                        <span class="c1">// In the SSE code, we added (later on)</span>
                        <span class="c1">// an observer for compilation errors and send a message to the client,</span>
                        <span class="c1">// this should trigger an "overlay" on the client side</span>
                        <span class="nn">Fs</span><span class="p">.</span><span class="nc">PublishCompileErr</span> <span class="n">stderr</span>
                        <span class="k">do</span><span class="o">!</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">WriteBytesAsync</span> <span class="o">[||]</span> <span class="p">:></span> <span class="nc">Task</span>
                    <span class="k">else</span>
                        <span class="c1">// if the file got compiled then just write the file to the body</span>
                        <span class="c1">// of the request</span>
                        <span class="k">let</span> <span class="n">content</span> <span class="p">=</span> <span class="nn">Encoding</span><span class="p">.</span><span class="nn">UTF8</span><span class="p">.</span><span class="nc">GetBytes</span> <span class="n">stdout</span>
                        <span class="k">do</span><span class="o">!</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">WriteBytesAsync</span> <span class="n">content</span> <span class="p">:></span> <span class="nc">Task</span>
                <span class="p">|</span> <span class="nc">Error</span> <span class="n">err</span> <span class="p">-></span>
                    <span class="c1">// anything else, just send a 500</span>
                    <span class="n">ctx</span><span class="p">.</span><span class="nc">SetStatusCode</span> <span class="mi">500</span>
                    <span class="k">do</span><span class="o">!</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">WriteTextAsync</span> <span class="n">err</span><span class="p">.</span><span class="nc">Message</span> <span class="p">:></span> <span class="nc">Task</span>
        <span class="p">}</span>
        <span class="p">:></span> <span class="nc">Task</span>

    <span class="k">let</span> <span class="n">configureTransformMiddleware</span>
        <span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nc">FdsConfig</span><span class="p">)</span>
        <span class="p">(</span><span class="n">appConfig</span><span class="p">:</span> <span class="nc">IApplicationBuilder</span><span class="p">)</span> <span class="p">=</span>
        <span class="k">let</span> <span class="n">serverConfig</span> <span class="p">=</span>
            <span class="n">defaultArg</span> <span class="n">config</span><span class="p">.</span><span class="n">devServer</span> <span class="p">(</span><span class="nn">DevServerConfig</span><span class="p">.</span><span class="nc">DefaultConfig</span><span class="bp">()</span><span class="p">)</span>

        <span class="k">let</span> <span class="n">mountedDirs</span> <span class="p">=</span> <span class="n">defaultArg</span> <span class="n">serverConfig</span><span class="p">.</span><span class="n">mountDirectories</span> <span class="nn">Map</span><span class="p">.</span><span class="n">empty</span>

        <span class="n">appConfig</span>
            <span class="p">.</span><span class="nc">Use</span><span class="p">(</span><span class="nc">Func</span><span class="p">&lt;</span><span class="nc">HttpContext</span><span class="p">,</span> <span class="nc">Func</span><span class="p">&lt;</span><span class="nc">Task</span><span class="o">>,</span> <span class="nc">Task</span><span class="o">>(</span><span class="n">jsonImport</span> <span class="n">mountedDirs</span><span class="o">))</span>
            <span class="p">.</span><span class="nc">Use</span><span class="p">(</span><span class="nc">Func</span><span class="p">&lt;</span><span class="nc">HttpContext</span><span class="p">,</span> <span class="nc">Func</span><span class="p">&lt;</span><span class="nc">Task</span><span class="o">>,</span> <span class="nc">Task</span><span class="o">>(</span><span class="n">cssImport</span> <span class="n">mountedDirs</span><span class="o">))</span>
            <span class="p">.</span><span class="nc">Use</span><span class="p">(</span>
                <span class="nc">Func</span><span class="p">&lt;</span><span class="nc">HttpContext</span><span class="p">,</span> <span class="nc">Func</span><span class="p">&lt;</span><span class="nc">Task</span><span class="o">>,</span> <span class="nc">Task</span><span class="o">>(</span><span class="n">jsImport</span> <span class="n">config</span><span class="p">.</span><span class="n">build</span> <span class="n">mountedDirs</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="p">|></span> <span class="n">ignore</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>It is a pretty simple module (I want to think) that only has some functions that deal with the content of the files and return any compiled result if neededm otherwise just send the file.</p>

<p>Now... Let's take a look at the magic behind <code>let! fileData = Esbuild.tryCompileFile filePath buildConfig</code> to be honest I didn't really know what I was doing, the main line of thought was just to try and find the content on disk and try the next extension if it didn't work. Hah! well <a href="https://res.cloudinary.com/practicaldev/image/fetch/s--QddMIzt5--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://th.bing.com/th/id/OIP.XBALsTMB2KdavcvdRAlpuwHaFD%3Fpid%3DImgDet%26rs%3D1" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--QddMIzt5--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://th.bing.com/th/id/OIP.XBALsTMB2KdavcvdRAlpuwHaFD%3Fpid%3DImgDet%26rs%3D1" alt="as long as it works" loading="lazy" width="474" height="323"></a><br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight fsharp"><code><span class="k">let</span> <span class="n">tryCompileFile</span> <span class="n">filepath</span> <span class="n">config</span> <span class="p">=</span>
  <span class="n">taskResult</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">config</span> <span class="p">=</span> <span class="p">(</span><span class="n">defaultArg</span> <span class="n">config</span> <span class="p">(</span><span class="nn">BuildConfig</span><span class="p">.</span><span class="nc">DefaultConfig</span><span class="bp">()</span><span class="o">))</span>
    <span class="c1">// since we're using</span>
    <span class="c1">// FsToolkit.ErrorHandling if the operation fails it will</span>
    <span class="c1">// "early return" meaning it won't continue the success path</span>
    <span class="k">let</span><span class="o">!</span> <span class="n">res</span> <span class="p">=</span> <span class="nn">Fs</span><span class="p">.</span><span class="n">tryReadFile</span> <span class="n">filepath</span>
    <span class="k">let</span> <span class="n">strout</span> <span class="p">=</span> <span class="nc">StringBuilder</span><span class="bp">()</span>
    <span class="k">let</span> <span class="n">strerr</span> <span class="p">=</span> <span class="nc">StringBuilder</span><span class="bp">()</span>
    <span class="k">let</span> <span class="o">(_,</span> <span class="n">loader</span><span class="p">)</span> <span class="p">=</span> <span class="n">res</span>

    <span class="k">let</span> <span class="n">cmd</span> <span class="p">=</span> <span class="n">buildSingleFileCmd</span> <span class="n">config</span> <span class="p">(</span><span class="n">strout</span><span class="p">,</span> <span class="n">strerr</span><span class="p">)</span> <span class="n">res</span>
    <span class="c1">// execute esbuild on the file</span>
    <span class="k">do</span><span class="o">!</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="nc">ExecuteAsync</span><span class="bp">()</span><span class="o">).</span><span class="nc">Task</span> <span class="p">:></span> <span class="nc">Task</span>

    <span class="k">let</span> <span class="n">strout</span> <span class="p">=</span> <span class="n">strout</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span>
    <span class="k">let</span> <span class="n">strerr</span> <span class="p">=</span> <span class="n">strerr</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span>

    <span class="k">let</span> <span class="n">strout</span> <span class="p">=</span>
      <span class="k">match</span> <span class="n">loader</span> <span class="k">with</span>
      <span class="p">|</span> <span class="nc">Jsx</span>
      <span class="p">|</span> <span class="nc">Tsx</span> <span class="p">-></span>
        <span class="k">try</span>
          <span class="c1">// if the file needs injects (e.g automatic "import React from 'react'" in JSX files)</span>
          <span class="k">let</span> <span class="n">injects</span> <span class="p">=</span>
            <span class="n">defaultArg</span> <span class="n">config</span><span class="p">.</span><span class="n">injects</span> <span class="p">(</span><span class="nn">Seq</span><span class="p">.</span><span class="n">empty</span><span class="p">)</span>
            <span class="p">|></span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">File</span><span class="p">.</span><span class="nc">ReadAllText</span>

          <span class="c1">// add those right here</span>
          <span class="k">let</span> <span class="n">injects</span> <span class="p">=</span> <span class="nn">String</span><span class="p">.</span><span class="nc">Join</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">,</span> <span class="n">injects</span><span class="p">)</span>
          <span class="o">$</span><span class="s2">"{injects}</span><span class="se">\n</span><span class="s2">{strout}"</span>
        <span class="k">with</span>
        <span class="p">|</span> <span class="n">ex</span> <span class="p">-></span>
          <span class="n">printfn</span> <span class="o">$</span><span class="s2">"Perla Serve: failed to inject, {ex.Message}"</span>
          <span class="n">strout</span>
      <span class="p">|</span> <span class="p">_</span> <span class="p">-></span> <span class="n">strout</span>
    <span class="c1">// return the compilation results</span>
    <span class="c1">// the transpiled output and the error if any</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">strout</span><span class="p">,</span> <span class="n">strerr</span><span class="p">)</span>
  <span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>Surely thats a lot of things to do for a single file, I'm sure it must be quite slow right? Well... It turns out that <strong>.NET</strong> and <strong>Go</strong> are quite quite feaking fast</p>


<blockquote class="ltag__twitter-tweet" data-url="https://twitter.com/angel_d_munoz/status/1444508310393212934">
      <div class="ltag__twitter-tweet__media">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--VvhW-jDa--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://pbs.twimg.com/media/FAvrtN5X0AABTQ8.png" alt="unknown tweet media content" loading="lazy">
      </div>

  <div class="ltag__twitter-tweet__main" data-url="https://twitter.com/angel_d_munoz/status/1444508310393212934">
    <div class="ltag__twitter-tweet__header">
      <img class="ltag__twitter-tweet__profile-image" src="https://res.cloudinary.com/practicaldev/image/fetch/s--s15CcGpw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://pbs.twimg.com/profile_images/1427821392662339584/ev-ZMAoV_normal.jpg" alt="Angel Munoz profile image" loading="lazy">
      <div class="ltag__twitter-tweet__full-name">
        Angel Munoz
      </div>
      <div class="ltag__twitter-tweet__username">
        @angel_d_munoz
      </div>
      <div class="ltag__twitter-tweet__twitter-logo">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--ir1kO05j--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-f95605061196010f91e64806688390eb1a4dbc9e913682e043eb8b1e06ca484f.svg" alt="twitter logo" loading="lazy">
      </div>
    </div>
    <div class="ltag__twitter-tweet__body">
      .NET6 is really fast even for my not optimized sloppy <a href="https://twitter.com/hashtag/fsharp">#fsharp</a> code<br>I'm doing a bunch of IO/async operations without peformance in mind plus my weird mental logic and yet both esbuild transform + middleware stuff  + IO + tasks<br>and yet each request takes between 10-20ms 
    </div>
    <div class="ltag__twitter-tweet__date">
      03:43 AM - 03 Oct 2021
    </div>


    <div class="ltag__twitter-tweet__actions">
      <a href="https://twitter.com/intent/tweet?in_reply_to=1444508310393212934" class="ltag__twitter-tweet__actions__button">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--fFnoeFxk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-reply-action-238fe0a37991706a6880ed13941c3efd6b371e4aefe288fe8e0db85250708bc4.svg" alt="Twitter reply action" loading="lazy">
      </a>
      <a href="https://twitter.com/intent/retweet?tweet_id=1444508310393212934" class="ltag__twitter-tweet__actions__button">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--k6dcrOn8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-retweet-action-632c83532a4e7de573c5c08dbb090ee18b348b13e2793175fea914827bc42046.svg" alt="Twitter retweet action" loading="lazy">
      </a>
      <a href="https://twitter.com/intent/like?tweet_id=1444508310393212934" class="ltag__twitter-tweet__actions__button">
        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--SRQc9lOp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-like-action-1ea89f4b87c7d37465b0eb78d51fcb7fe6c03a089805d7ea014ba71365be5171.svg" alt="Twitter like action" loading="lazy">
      </a>
    </div>
  </div>
</blockquote>
 

<p>each request takes around 10-20ms and I'm pretty sure it can be improved once the phase of heavy development settles down and the code base stabilizes a little bit more.</p>
<h2>
  <a name="dev-proxy" href="#dev-proxy">
  </a>
  Dev Proxy
</h2>

<p>This one is pretty new, a dev proxy is somewhat necessary specially when you will host your applications on your own server so you are very likely to have URLs like <code>/api/my-endpoint</code> rather than <code>http://my-api.com/api/my-endpoint</code> it also helps you target different environments with a single configuration change, in this case it was not really complex thanks to <a href="https://twitter.com/Yaurthek">@Yaurthek</a> who hinted at me one <a href="https://microsoft.github.io/reverse-proxy/articles/direct-forwarding.html">Yarp</a> implementation of a dev proxy, so I ended up basing my work on that.</p>

<p>The whole idea here is to read a json file with some <code>origin -> target</code> mappings and then just adding a proxy to the server application.<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight fsharp"><code>
  <span class="k">let</span> <span class="k">private</span> <span class="n">getHttpClientAndForwarder</span> <span class="bp">()</span> <span class="p">=</span>
    <span class="c1">// this socket handler is actually disposable</span>
    <span class="c1">// but since technically I will only use one in the whole application</span>
    <span class="c1">// I won't need to dispose it</span>
    <span class="k">let</span> <span class="n">socketsHandler</span> <span class="p">=</span> <span class="k">new</span> <span class="nc">SocketsHttpHandler</span><span class="bp">()</span>
    <span class="n">socketsHandler</span><span class="p">.</span><span class="nc">UseProxy</span> <span class="p">&lt;-</span> <span class="bp">false</span>
    <span class="n">socketsHandler</span><span class="p">.</span><span class="nc">AllowAutoRedirect</span> <span class="p">&lt;-</span> <span class="bp">false</span>
    <span class="n">socketsHandler</span><span class="p">.</span><span class="nc">AutomaticDecompression</span> <span class="p">&lt;-</span> <span class="nn">DecompressionMethods</span><span class="p">.</span><span class="nc">None</span>
    <span class="n">socketsHandler</span><span class="p">.</span><span class="nc">UseCookies</span> <span class="p">&lt;-</span> <span class="bp">false</span>
    <span class="k">let</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nc">HttpMessageInvoker</span><span class="p">(</span><span class="n">socketsHandler</span><span class="p">)</span>
    <span class="k">let</span> <span class="n">reqConfig</span> <span class="p">=</span> <span class="nc">ForwarderRequestConfig</span><span class="bp">()</span>
    <span class="n">reqConfig</span><span class="p">.</span><span class="nc">ActivityTimeout</span> <span class="p">&lt;-</span> <span class="nn">TimeSpan</span><span class="p">.</span><span class="nc">FromSeconds</span><span class="p">(</span><span class="mi">100</span><span class="o">.)</span>
    <span class="n">client</span><span class="p">,</span> <span class="n">reqConfig</span>

  <span class="k">let</span> <span class="k">private</span> <span class="n">getProxyHandler</span>
    <span class="p">(</span><span class="n">target</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span>
    <span class="p">(</span><span class="n">httpClient</span><span class="p">:</span> <span class="nc">HttpMessageInvoker</span><span class="p">)</span>
    <span class="p">(</span><span class="n">forwardConfig</span><span class="p">:</span> <span class="nc">ForwarderRequestConfig</span><span class="p">)</span>
    <span class="p">:</span> <span class="nc">Func</span><span class="p">&lt;</span><span class="nc">HttpContext</span><span class="p">,</span> <span class="nc">IHttpForwarder</span><span class="p">,</span> <span class="nc">Task</span><span class="p">></span> <span class="p">=</span>
    <span class="c1">// this is actually using .NET6 Minimal API's from asp.net!</span>
    <span class="k">let</span> <span class="n">toFunc</span> <span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="nc">HttpContext</span><span class="p">)</span> <span class="p">(</span><span class="n">forwarder</span><span class="p">:</span> <span class="nc">IHttpForwarder</span><span class="p">)</span> <span class="p">=</span>
      <span class="n">task</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">logger</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">GetLogger</span><span class="p">(</span><span class="s2">"Perla Proxy"</span><span class="p">)</span>
        <span class="k">let</span><span class="o">!</span> <span class="n">error</span> <span class="p">=</span> <span class="n">forwarder</span><span class="p">.</span><span class="nc">SendAsync</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">httpClient</span><span class="p">,</span> <span class="n">forwardConfig</span><span class="p">)</span>

        <span class="c1">// report the errors to the log as a warning</span>
        <span class="c1">// since we don't need to die if a request fails</span>
        <span class="k">if</span> <span class="n">error</span> <span class="p">&lt;></span> <span class="nn">ForwarderError</span><span class="p">.</span><span class="nc">None</span> <span class="k">then</span>
          <span class="k">let</span> <span class="n">errorFeat</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">GetForwarderErrorFeature</span><span class="bp">()</span>
          <span class="k">let</span> <span class="n">ex</span> <span class="p">=</span> <span class="n">errorFeat</span><span class="p">.</span><span class="nc">Exception</span>
          <span class="n">logger</span><span class="p">.</span><span class="nc">LogWarning</span><span class="o">($</span><span class="s2">"{ex.Message}"</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="p">:></span> <span class="nc">Task</span>
    <span class="nc">Func</span><span class="p">&lt;</span><span class="nc">HttpContext</span><span class="p">,</span> <span class="nc">IHttpForwarder</span><span class="p">,</span> <span class="nc">Task</span><span class="o">>(</span><span class="n">toFunc</span><span class="p">)</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>And then somewher inside the aspnet application configuration<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight fsharp"><code><span class="k">match</span> <span class="n">getProxyConfig</span> <span class="k">with</span>
<span class="p">|</span> <span class="nc">Some</span> <span class="n">proxyConfig</span> <span class="p">-></span>
    <span class="n">appConfig</span>
    <span class="p">.</span><span class="nc">UseRouting</span><span class="bp">()</span>
    <span class="p">.</span><span class="nc">UseEndpoints</span><span class="p">(</span><span class="k">fun</span> <span class="n">endpoints</span> <span class="p">-></span>
        <span class="k">let</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reqConfig</span><span class="p">)</span> <span class="p">=</span> <span class="n">getHttpClientAndForwarder</span> <span class="bp">()</span>
        <span class="c1">// for each mapping add the url add an endpoint</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="k">in</span> <span class="n">proxyConfig</span> <span class="p">|></span> <span class="nn">Map</span><span class="p">.</span><span class="n">toSeq</span> <span class="k">do</span>
            <span class="k">let</span> <span class="n">handler</span> <span class="p">=</span> <span class="n">getProxyHandler</span> <span class="n">target</span> <span class="n">client</span> <span class="n">reqConfig</span>
            <span class="n">endpoints</span><span class="p">.</span><span class="nc">Map</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span> <span class="p">|></span> <span class="n">ignore</span><span class="p">)</span>
<span class="p">|</span> <span class="nc">None</span> <span class="p">-></span> <span class="n">appConfig</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>That's it! At least on my initial testing it seems to work fine, I would need to have some feedback on the feature to know if this is actually working for more complex use cases.</p>
<h2>
  <a name="future-and-experimental-things" href="#future-and-experimental-things">
  </a>
  Future and Experimental things
</h2>

<p>What you have seen so far (and some other minor features) are already inside Perla, they are working and they try to provide you a seamless experience for building Single Page Applications however there are still missing pieces for a complete experience. For example Perla doesn't support Sass or Less at the moment and Sass is a pretty common way to write styles on big frontend projects, we are not able to parse out <code>.Vue</code> files or anything else that is not HTML/CSS/JS/TS/JSX/TSX, We do support HMR for CSS files since that is not a complex mechanism but, HMR for JS/TS/JSX/TSX files is not there yet sady. Fear not that We're looking for a way to provide these at some point in time.</p>
<h2>
  <a name="plugins" href="#plugins">
  </a>
  Plugins
</h2>

<p>I'm a fan of <code>.fsx</code> files, F# scripts are pretty flexible and since F# 5.0 they are even more powerful than ever allowing you to pull dependencies directly from NuGet without any extra command.</p>

<p>The main goal for the author and user experiences is somewhat like this</p>

<p>As an Author:</p>

<ul>
<li>Write an <code>.fsx</code> script</li>
<li>Upload it to gist/github</li>
<li>Profit</li>
</ul>

<p>As a User:</p>

<ul>
<li>Add an entry yo tour "plugins" section</li>
<li>Profit</li>
</ul>

<p>Implementation details are more complex though...</p>

<p>My vision is somewhere along the following lines</p>

<ul>
<li>get a request for a different file e.g. sass files</li>
<li>if the file is not part of the default supported extensions

<ul>
<li>Call a function that will parse the content of that file</li>
<li>get the transpiled content or the compilation error (just like we saw above with the js middleware)</li>
<li>return the valid HTML/CSS/JS content to the browser</li>
</ul>
</li>
</ul>

<p>To get there I want to leverage the [FSharp.Compiler.Services] NuGet Package to start an F# interactive session that runs over the life of the server,</p>

<ul>
<li>Start the server, also if there are plugins in the plugin section, start the fsi session.</li>
<li>load the plugins, download them to a known location in disk, or even just get the strings without downloading the file to disk</li>
<li>execute the contents on the fsi session and grab a particular set of functions

<ul>
<li>These functions can be part of a life cycle which may possible be something like</li>
<li>on load // when HMR is enabled</li>
<li>on change // when HMR is enabled</li>
<li>on transform // when the file is requested</li>
<li>on build // when the production build is executed</li>
</ul>
</li>
<li>call the functions in the plugins section whenever needed</li>
</ul>

<p>Starting an FSI session is not a complex task let's take a look.</p>

<p>let's say we have the following script:<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight fsharp"><code><span class="p">#</span><span class="n">r</span> <span class="s2">"nuget: LibSassHost, 1.3.3"</span>
<span class="p">#</span><span class="n">r</span> <span class="s2">"nuget: LibSassHost.Native.linux-x64, 1.3.3"</span>

<span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">IO</span>
<span class="k">open</span> <span class="nc">LibSassHost</span>

<span class="k">let</span> <span class="n">compileSassFile</span> <span class="p">=</span>
  <span class="k">let</span> <span class="p">_</span><span class="n">compileSassFile</span> <span class="p">(</span><span class="n">filePath</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">=</span>
    <span class="k">let</span> <span class="n">filename</span> <span class="p">=</span> <span class="nn">Path</span><span class="p">.</span><span class="nc">GetFileName</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>
    <span class="k">let</span> <span class="n">result</span> <span class="p">=</span> <span class="nn">SassCompiler</span><span class="p">.</span><span class="nc">Compile</span><span class="p">(</span><span class="nn">File</span><span class="p">.</span><span class="nc">ReadAllText</span><span class="p">(</span><span class="n">filePath</span><span class="o">))</span>
    <span class="p">[|</span><span class="n">filename</span><span class="p">;</span> <span class="n">result</span><span class="p">.</span><span class="nc">CompiledContent</span> <span class="p">|]</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>In this file we're able to provide a function that when given a file path, it will try to compile a <code>.scss</code> file into it's <code>.css</code> equivalent, to be able to execute that in Perla, we need a module that does somewhat like this:<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight fsharp"><code><span class="p">#</span><span class="n">r</span> <span class="s2">"nuget: FSharp.Compiler.Service, 41.0.1"</span>

<span class="k">open</span> <span class="nc">System</span>
<span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">IO</span>
<span class="k">open</span> <span class="nn">FSharp</span><span class="p">.</span><span class="nn">Compiler</span><span class="p">.</span><span class="nn">Interactive</span><span class="p">.</span><span class="nc">Shell</span>

<span class="k">module</span> <span class="nc">ScriptedContent</span> <span class="p">=</span>

    <span class="k">let</span> <span class="n">tryGetSassPluginFunction</span> <span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="kt">string</span><span class="o">):</span> <span class="p">(</span><span class="kt">string</span> <span class="p">-></span> <span class="kt">string</span><span class="p">)</span> <span class="n">option</span> <span class="p">=</span>
        <span class="k">let</span> <span class="n">defConfig</span> <span class="p">=</span>
            <span class="nn">FsiEvaluationSession</span><span class="p">.</span><span class="nc">GetDefaultConfiguration</span><span class="bp">()</span>

        <span class="k">let</span> <span class="n">argv</span> <span class="p">=</span>
            <span class="p">[|</span> <span class="s2">"fsi.exe"</span>
               <span class="s2">"--noninteractive"</span>
               <span class="s2">"--nologo"</span>
               <span class="s2">"--gui-"</span> <span class="p">|]</span>

        <span class="k">use</span> <span class="n">stdIn</span> <span class="p">=</span> <span class="k">new</span> <span class="nc">StringReader</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
        <span class="k">use</span> <span class="n">stdOut</span> <span class="p">=</span> <span class="k">new</span> <span class="nc">StringWriter</span><span class="bp">()</span>
        <span class="k">use</span> <span class="n">stdErr</span> <span class="p">=</span> <span class="k">new</span> <span class="nc">StringWriter</span><span class="bp">()</span>

        <span class="k">use</span> <span class="n">session</span> <span class="p">=</span>
            <span class="nn">FsiEvaluationSession</span><span class="p">.</span><span class="nc">Create</span><span class="p">(</span><span class="n">defConfig</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">stdIn</span><span class="p">,</span> <span class="n">stdOut</span><span class="p">,</span> <span class="n">stdErr</span><span class="p">,</span> <span class="bp">true</span><span class="p">)</span>
        <span class="n">session</span><span class="p">.</span><span class="nc">EvalInteractionNonThrowing</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="p">|></span> <span class="n">ignore</span>

        <span class="k">match</span> <span class="n">session</span><span class="p">.</span><span class="nc">TryFindBoundValue</span> <span class="s2">"compileSassFile"</span> <span class="k">with</span>
        <span class="p">|</span> <span class="nc">Some</span> <span class="n">bound</span> <span class="p">-></span>
            <span class="c1">// If there's a value with that name on the script try to grab it</span>
            <span class="k">match</span> <span class="n">bound</span><span class="p">.</span><span class="nn">Value</span><span class="p">.</span><span class="nc">ReflectionValue</span> <span class="k">with</span>
            <span class="c1">// ensure it fits the signature we are expecting</span>
            <span class="p">|</span> <span class="o">:?</span> <span class="nc">FSharpFunc</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">></span> <span class="k">as</span> <span class="n">compileSassFile</span> <span class="p">-></span>
              <span class="nc">Some</span> <span class="n">compileSassFile</span>
            <span class="p">|</span> <span class="p">_</span> <span class="p">-></span> <span class="nc">None</span>
        <span class="p">|</span> <span class="nc">None</span> <span class="p">-></span> <span class="nc">None</span>

<span class="k">let</span> <span class="n">content</span> <span class="p">=</span> <span class="nn">File</span><span class="p">.</span><span class="nc">ReadAllText</span><span class="p">(</span><span class="s2">"./path/to/sass-plugin.fsx"</span><span class="p">)</span>
<span class="c1">// this is where it get's nice, we can also fetch the scritps from the cloud</span>
<span class="c1">// let! content = Http.getFromGithub("AngelMunoz/Perla.Sass")</span>
<span class="k">match</span> <span class="nn">ScriptedContent</span><span class="p">.</span><span class="n">tryGetSassPluginFunction</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="k">with</span>
<span class="p">|</span> <span class="nc">Some</span> <span class="n">plugin</span> <span class="p">-></span>
  <span class="k">let</span> <span class="n">css</span> <span class="p">=</span> <span class="n">plugin</span> <span class="s2">"./path/to/file.scss"</span>
  <span class="n">printfn</span> <span class="o">$</span><span class="s2">"Resulting CSS:</span><span class="se">\n</span><span class="s2">{css}"</span>
<span class="p">|</span> <span class="nc">None</span> <span class="p">-></span> <span class="n">printfn</span> <span class="s2">"No plugin was found on the script"</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>This is more-less what I have in mind, it has a few downsides though</p>

<ul>
<li>Convention based naming</li>
<li>Badly written plugins might leak memory or make Perla's performance to slow down</li>
<li>Script distribution is a real concern, there's no clear way to do it as of now</li>
<li>Security concerns when executing code with Perla's permissions on the user's behalf</li>
</ul>

<p>And many others that I might not be looking after.</p>

<p>Being able to author plugins and process any kind of file into something Perla can use to enhance the consumer experience is just worth it though, for example just look at the vast amount of webpack and vite plugins. The use cases are there for anyone to fulfill them .</p>
<h3>
  <a name="hmr" href="#hmr">
  </a>
  HMR
</h3>

<p>This is the golden apple I'm not entirely sure how to tackle...<br>
<a href="https://github.com/snowpackjs/esm-hmr">There's an HMR spec</a> that I will follow for that since that's what snowpack/vite's HMR is based on, libraries like <a href="https://fable.io/Fable.Lit/">Fable.Lit</a>, or <a href="https://elmish.github.io/hmr/">Elmish.HMR</a> are working towards being compatible with vite's HMR, so if Perla can make it work like them, then we won't even need to write any specific code for Perla.</p>

<p>I can talk however of CSS HMR, This is a pretty simple change to support given that CSS changes are automatically propagated in the browser, it basically does half of the HMR for us.</p>

<p>Perla does the following:</p>

<ul>
<li>Sees <code>import "./app.css</code>
</li>
<li>Runs the <code>cssImport</code> middleware function I hinted at earlier and returns a ~CSS~ Javascript file that injects a script tag on the head of the page.
</li>
</ul>
<div class="highlight js-code-highlight">
<pre class="highlight fsharp"><code>  <span class="k">let</span> <span class="n">cssImport</span>
    <span class="p">(</span><span class="n">mountedDirs</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="o">>)</span>
    <span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="nc">HttpContext</span><span class="p">)</span>
    <span class="p">(</span><span class="n">next</span><span class="p">:</span> <span class="nc">Func</span><span class="p">&lt;</span><span class="nc">Task</span><span class="o">>)</span>
    <span class="p">=</span>
    <span class="n">task</span> <span class="p">{</span>
      <span class="c1">// skip non-css files</span>
      <span class="k">if</span> <span class="n">ctx</span><span class="p">.</span><span class="nn">Request</span><span class="p">.</span><span class="nn">Path</span><span class="p">.</span><span class="nn">Value</span><span class="p">.</span><span class="nc">Contains</span><span class="p">(</span><span class="s2">".css"</span><span class="p">)</span> <span class="p">|></span> <span class="k">not</span> <span class="k">then</span>
        <span class="k">return</span><span class="o">!</span> <span class="n">next</span><span class="p">.</span><span class="nc">Invoke</span><span class="bp">()</span>
      <span class="k">else</span>

        <span class="k">let</span> <span class="n">logger</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">GetLogger</span><span class="p">(</span><span class="s2">"Perla Middleware"</span><span class="p">)</span>
        <span class="k">let</span> <span class="n">path</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nn">Request</span><span class="p">.</span><span class="nn">Path</span><span class="p">.</span><span class="nc">Value</span>

        <span class="k">let</span> <span class="n">baseDir</span><span class="p">,</span> <span class="n">baseName</span> <span class="p">=</span>
          <span class="n">mountedDirs</span>
          <span class="p">|></span> <span class="nn">Map</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="p">_</span> <span class="n">v</span> <span class="p">-></span> <span class="nn">String</span><span class="p">.</span><span class="nc">IsNullOrWhiteSpace</span> <span class="n">v</span> <span class="p">|></span> <span class="k">not</span><span class="p">)</span>
          <span class="p">|></span> <span class="nn">Map</span><span class="p">.</span><span class="n">toSeq</span>
          <span class="p">|></span> <span class="nn">Seq</span><span class="p">.</span><span class="n">find</span> <span class="p">(</span><span class="k">fun</span> <span class="o">(_,</span> <span class="n">v</span><span class="p">)</span> <span class="p">-></span> <span class="n">path</span><span class="p">.</span><span class="nc">StartsWith</span><span class="p">(</span><span class="n">v</span><span class="o">))</span>

        <span class="k">let</span> <span class="n">filePath</span> <span class="p">=</span>
          <span class="k">let</span> <span class="n">fileName</span> <span class="p">=</span>
            <span class="n">path</span><span class="p">.</span><span class="nc">Replace</span><span class="o">($</span><span class="s2">"{baseName}/"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="nn">StringComparison</span><span class="p">.</span><span class="nc">InvariantCulture</span><span class="p">)</span>

          <span class="nn">Path</span><span class="p">.</span><span class="nc">Combine</span><span class="p">(</span><span class="n">baseDir</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>

        <span class="n">logger</span><span class="p">.</span><span class="nc">LogInformation</span><span class="p">(</span><span class="s2">"Transforming CSS"</span><span class="p">)</span>

        <span class="k">let</span><span class="o">!</span> <span class="n">content</span> <span class="p">=</span> <span class="nn">File</span><span class="p">.</span><span class="nc">ReadAllTextAsync</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>
        <span class="c1">// return the JS code to insert the CSS content in a style tag</span>
        <span class="k">let</span> <span class="n">newContent</span> <span class="p">=</span>
          <span class="o">$</span><span class="s2">"""
const css = `{content}`
const style = document.createElement('style')
style.innerHTML = css
style.setAttribute("</span><span class="n">filename</span><span class="s2">", "</span><span class="p">{</span><span class="n">filePath</span><span class="p">}</span><span class="s2">");
document.head.appendChild(style)"""</span>

        <span class="n">ctx</span><span class="p">.</span><span class="nc">SetContentType</span> <span class="s2">"text/javascript"</span>
        <span class="k">do</span><span class="o">!</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">WriteStringAsync</span> <span class="n">newContent</span> <span class="p">:></span> <span class="nc">Task</span>
    <span class="p">}</span>
    <span class="p">:></span> <span class="nc">Task</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>In the SSE handler function we observe for file changes in disk and depending on the content we do the corresponding update<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight fsharp"><code><span class="n">watcher</span><span class="p">.</span><span class="nc">FileChanged</span>
<span class="p">|></span> <span class="nn">Observable</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="k">event</span> <span class="p">-></span>
  <span class="n">task</span> <span class="p">{</span>
    <span class="k">match</span> <span class="nn">Path</span><span class="p">.</span><span class="nc">GetExtension</span> <span class="k">event</span><span class="p">.</span><span class="n">name</span> <span class="k">with</span>
    <span class="p">|</span> <span class="nc">Css</span> <span class="p">-></span>
      <span class="c1">// a CSS file was changed, read all of the content</span>
      <span class="k">let</span><span class="o">!</span> <span class="n">content</span> <span class="p">=</span> <span class="nn">File</span><span class="p">.</span><span class="nc">ReadAllTextAsync</span> <span class="k">event</span><span class="p">.</span><span class="n">path</span>

      <span class="k">let</span> <span class="n">data</span> <span class="p">=</span>
        <span class="nn">Json</span><span class="p">.</span><span class="nc">ToTextMinified</span><span class="p">(</span>
          <span class="o">{|</span> <span class="n">oldName</span> <span class="p">=</span>
              <span class="k">event</span><span class="p">.</span><span class="n">oldName</span>
              <span class="p">|></span> <span class="nn">Option</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">value</span> <span class="p">-></span>
                <span class="k">match</span> <span class="n">value</span> <span class="k">with</span>
                <span class="p">|</span> <span class="nc">Css</span> <span class="p">-></span> <span class="n">value</span>
                <span class="p">|</span> <span class="p">_</span> <span class="p">-></span> <span class="s2">""</span><span class="p">)</span>
              <span class="n">name</span> <span class="p">=</span> <span class="k">event</span><span class="p">.</span><span class="n">path</span>
              <span class="n">content</span> <span class="p">=</span> <span class="n">content</span> <span class="o">|}</span>
        <span class="p">)</span>
      <span class="c1">// Send the SSE Message to the client with the new CSS content</span>
      <span class="k">do</span><span class="o">!</span> <span class="n">res</span><span class="p">.</span><span class="nc">WriteAsync</span> <span class="o">$</span><span class="s2">"event:replace-css</span><span class="se">\n</span><span class="s2">data:{data}</span><span class="se">\n\n</span><span class="s2">"</span>
      <span class="k">return</span><span class="o">!</span> <span class="n">res</span><span class="p">.</span><span class="nn">Body</span><span class="p">.</span><span class="nc">FlushAsync</span><span class="bp">()</span>
    <span class="p">|</span> <span class="nc">Typescript</span>
    <span class="p">|</span> <span class="nc">Javascript</span>
    <span class="p">|</span> <span class="nc">Jsx</span>
    <span class="p">|</span> <span class="nc">Json</span>
    <span class="p">|</span> <span class="nc">Other</span> <span class="p">_</span> <span class="p">-></span> <span class="c1">//... other content ...</span>
  <span class="o">})</span>
<span class="p">|></span> <span class="nn">Observable</span><span class="p">.</span><span class="n">switchTask</span>
<span class="p">|></span> <span class="nn">Observable</span><span class="p">.</span><span class="n">subscribe</span> <span class="n">ignore</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>To handle these updates we use two cool things, <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers">WebWorkers</a> and a simple scripts, the live reload script has this content<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight javascript"><code><span class="c1">// initiate worker</span>
<span class="kd">const</span> <span class="nx">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Worker</span><span class="p">(</span><span class="dl">"</span><span class="s2">/~perla~/worker.js</span><span class="dl">"</span><span class="p">);</span>
<span class="c1">// connect to the SSE endpoint</span>
<span class="nx">worker</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span> <span class="na">event</span><span class="p">:</span> <span class="dl">"</span><span class="s2">connect</span><span class="dl">"</span> <span class="p">});</span>

<span class="kd">function</span> <span class="nx">replaceCssContent</span><span class="p">({</span> <span class="nx">oldName</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">content</span> <span class="p">})</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">css</span> <span class="o">=</span> <span class="nx">content</span><span class="p">?.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">(?:\\</span><span class="sr">r</span><span class="se">\\</span><span class="sr">n|</span><span class="se">\\</span><span class="sr">r|</span><span class="se">\\</span><span class="sr">n</span><span class="se">)</span><span class="sr">/g</span><span class="p">,</span> <span class="dl">"</span><span class="se">\n</span><span class="dl">"</span><span class="p">)</span> <span class="o">||</span> <span class="dl">""</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">findBy</span> <span class="o">=</span> <span class="nx">oldName</span> <span class="o">||</span> <span class="nx">name</span><span class="p">;</span>

  <span class="c1">// find the style tag with the particular name</span>
  <span class="kd">const</span> <span class="nx">style</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">`[filename="</span><span class="p">${</span><span class="nx">findBy</span><span class="p">}</span><span class="s2">"]`</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">style</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="dl">"</span><span class="s2">Unable to find</span><span class="dl">"</span><span class="p">,</span> <span class="nx">oldName</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// replace the content</span>
  <span class="nx">style</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">css</span><span class="p">;</span>
  <span class="nx">style</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">filename</span><span class="dl">"</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">showOverlay</span><span class="p">({</span> <span class="nx">error</span> <span class="p">})</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">show overlay</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// react to the worker messages</span>
<span class="nx">worker</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">({</span> <span class="nx">data</span> <span class="p">})</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nx">data</span><span class="p">?.</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="dl">"</span><span class="s2">reload</span><span class="dl">"</span><span class="p">:</span>
      <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span>
    <span class="k">case</span> <span class="dl">"</span><span class="s2">replace-css</span><span class="dl">"</span><span class="p">:</span>
      <span class="k">return</span> <span class="nx">replaceCssContent</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="k">case</span> <span class="dl">"</span><span class="s2">compile-err</span><span class="dl">"</span><span class="p">:</span>
      <span class="k">return</span> <span class="nx">showOverlay</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="nl">default</span><span class="p">:</span>
      <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Unknown message:</span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>Inside our Worker the code is very very similar<br>
</p>
<div class="highlight js-code-highlight">
<pre class="highlight javascript"><code><span class="kd">let</span> <span class="nx">source</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">tryParse</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="o">=></span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{};</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">connectToSource</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="c1">//connect to the SSE endpoint</span>
  <span class="nx">source</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventSource</span><span class="p">(</span><span class="dl">"</span><span class="s2">/~perla~/sse</span><span class="dl">"</span><span class="p">);</span>
  <span class="nx">source</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">open</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Connected</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="c1">// react to file reloads</span>
  <span class="nx">source</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">reload</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Reloading, file changed: </span><span class="dl">"</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
    <span class="nb">self</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
      <span class="na">event</span><span class="p">:</span> <span class="dl">"</span><span class="s2">reload</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="c1">// if the server sends a `replace-css` event</span>
  <span class="c1">// notify the main thread about it</span>
  <span class="c1">// Yes! web workers run on background threads!</span>
  <span class="nx">source</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">replace-css</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">oldName</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">content</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">tryParse</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Css Changed: </span><span class="p">${</span><span class="nx">oldName</span> <span class="p">?</span> <span class="nx">oldName</span> <span class="p">:</span> <span class="nx">name</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="nb">self</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
      <span class="na">event</span><span class="p">:</span> <span class="dl">"</span><span class="s2">replace-css</span><span class="dl">"</span><span class="p">,</span>
      <span class="nx">oldName</span><span class="p">,</span>
      <span class="nx">name</span><span class="p">,</span>
      <span class="nx">content</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">source</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">compile-err</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">error</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">tryParse</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="nb">self</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
      <span class="na">event</span><span class="p">:</span> <span class="dl">"</span><span class="s2">compile-err</span><span class="dl">"</span><span class="p">,</span>
      <span class="nx">error</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="nb">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">({</span> <span class="nx">data</span> <span class="p">})</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">?.</span><span class="nx">event</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">connect</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">connectToSource</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>And that's how the CSS HMR works in Perla and it is instant, in less than a blink of an eye! Well... maybe not but pretty close to it.</p>

<p>For the JS side I'm still not sure how this will work given that I might need to have a mapping in both sides of the files I have and what is their current version.</p>
<h2>
  <a name="whats-next" href="#whats-next">
  </a>
  What's next?
</h2>

<p>Whew! That was a lot! but shows how to build each part of the Webpack alternative I've been working on Called <a href="https://perla-docs.web.app/">Perla</a> there are still some gaps though</p>

<ul>
<li>Project Scaffolding</li>
</ul>

<p>This will be an important step for adoption I believe, generating certain files, or even starter projects to reduce the onboarding complexity is vital, so this is likely the next step for me (even before the HMR)</p>

<ul>
<li>Unit/E2E Testing</li>
</ul>

<p>Node based test runners won't work naturally since we're not using node! So this is an area to investigate, for E2E I already have the thought of using playwright, for unit tests I'm not sure yet but I guess I'd be able to pick something similar or simply have a test framework that runs entirely on the browser.</p>

<ul>
<li>Import map ergonomics</li>
</ul>

<p>Some times, you must edit by hand the import map (<code>perla.jsonc.lock</code>) to get dependencies like <code>import fp from 'lodash/fp'</code> with the import maps the browser knows what to do with <code>lodash</code> but not <code>lodash/fp</code> so an edit must be made, this requires you to understand how these dependencies work and how you need to write the import map, it's an area I'd love to make as simple as possible</p>

<ul>
<li>Typescript Types for dependencies</li>
</ul>

<p>Typescript (and related Editors/IDEs like vscode and webstorm) rely on the presence of node_modules to pick typings from disk, It would be nice if typescript worked with the URI style imports for typings that would fix a lot of issues.</p>

<ul>
<li>Library/Build only mode</li>
</ul>

<p>There might be certain cases where you would like to author a library either for you and your team, perhaps you only need the JS files and a package.json to share the sources, while not a priority it's something it's worth looking at.</p>

<ul>
<li>Improve the <em>Install</em> story</li>
</ul>

<p>The goal is run a single line command, get your stuff installed in place regardless of if you have .NET or not</p>
<h2>
  <a name="closing-thoughts" href="#closing-thoughts">
  </a>
  Closing thoughts...
</h2>

<p>So those are some of the things I might have on my plate for next, of course if I receive feedback on this project I may prioritize some things over the others but rather than doing it all for myself, I wish to share this and make it a community effort to continue to improve the Frontend tooling story that doesn't rely on complex patterns and extremely weird and cryptic errors, hundreds of hours spent in configuration, something as simple that you feel confident enough to trust and use :)</p>

<blockquote>
<p>by the way, this is the repository in question :) <br>
</p>
<div class="ltag-github-readme-tag">
  <div class="readme-overview">
    <h2>
      <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--566lAguM--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/github-logo-5a155e1f9a670af7944dd5e12375bc76ed542ea80224905ecaf878b9157cdefc.svg" alt="GitHub logo" loading="lazy">
      <a href="https://github.com/AngelMunoz">
        AngelMunoz
      </a> / <a style="font-weight:600" href="https://github.com/AngelMunoz/Perla">
        Perla
      </a>
    </h2>
    <h3>
      A cross-platform tool for unbundled front-end development that doesn't depend on Node or requires you to install a complex toolchain
    </h3>
  </div>
  <div class="ltag-github-body">
    
<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><h1 dir="auto">
Perla Dev Server</h1>
<blockquote>
<p dir="auto">Check the samples <a href="https://github.com/AngelMunoz/perla-samples">https://github.com/AngelMunoz/perla-samples</a></p>
</blockquote>
<p dir="auto">Perla is a cross-platform single executable binary CLI Tool for a Development Server of Single Page Applications.</p>
<p dir="auto">If that sounds like something nice, <a href="https://perla-docs.web.app/" rel="nofollow">Check The docs!</a></p>
<h2 dir="auto">
Status</h2>
<p dir="auto">This project is in development, current goals at this point are:</p>
<ul class="contains-task-list">
<li class="task-list-item">
 Remove npm/node out of the equation.</li>
<li class="task-list-item">
 For F# users, seamless fable integration.</li>
<li class="task-list-item">
 A Fast and easy to use Development server</li>
<li class="task-list-item">
 Build for production using esbuild.</li>
<li class="task-list-item">
 Binary Release for users outside .NET</li>
<li class="task-list-item">
 HMR (for other than CSS)</li>
<li class="task-list-item">
 Plugin System</li>
</ul>
<p dir="auto">For more information check the Issues tab.</p>
<h2 dir="auto">
Existing tools</h2>
<p dir="auto">If you actually use and like nodejs, then you would be better taking a look at the tools that inspired this repository</p>
<ul dir="auto">
<li><a href="https://vitejs.dev/" rel="nofollow">vite</a></li>
<li><a href="https://www.snowpack.dev/" rel="nofollow">snowpack</a></li>
</ul>
<p dir="auto">These tools have a bigger community and rely on an even bigger ecosystem plus they support plugins via npm so if you're using node stick with them they are a better choice
Perla's unbundled…</p></article></div>
  </div>
  <div class="gh-btn-container"><a class="gh-btn" href="https://github.com/AngelMunoz/Perla">View on GitHub</a></div>
</div>


<br>
</blockquote>

<p>And with all due respect, I really thank the maintainers of snowpack,esbuild, and vite who make an incredible job at reducing the complexity of frontend tooling as well, they inspired me AND if you're a loving node user please look at their projects ditch webpack enough so they also reflect back and simplify their setups!</p>

<p>For the .NET community I wish to spark a little of interest to look outside and build tooling for other communities, I think it is a really nice way to introduce .NET with the rest of the world and new devs be it with F#, C# or VB, I think .NET is an amazing platform for that. This has been a really good learning exercise and at the same time a project I believe in so, I will try to spend more time and push it to as much as I can.</p>

<p>I'll see you on the next one :)</p>

</div></article> <div class="aside-username-wrapper" data-v-10d06ee8><aside class="aside-username-block" data-v-37984f8c data-v-10d06ee8><div class="username-heading loading" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-heading" data-v-37984f8c><div class="vue-content-placeholders-heading__img"></div> <div class="vue-content-placeholders-heading__content"><div class="vue-content-placeholders-heading__title"></div> <div class="vue-content-placeholders-heading__subtitle"></div></div></div></div></div> <div class="info" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-text" data-v-37984f8c><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div></div></div></div></aside></div></div> <div class="comments-block" data-v-8c4375bc data-v-10d06ee8><!----> <a href="https://dev.to/tunaxor/building-a-webpack-alternative-in-f-4p0f" target="_blank" rel="nofollow noopener noreferer" class="add-comment" data-v-8c4375bc>
    Add comment
  </a></div></div> <footer data-v-22cb8fd0><span data-v-22cb8fd0>Built with</span> <a href="https://nuxtjs.org" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="nuxt-icon" data-v-22cb8fd0 data-v-22cb8fd0><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a> <span data-v-22cb8fd0>&</span> <a href="https://docs.dev.to/api" rel="nofollow noopener" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-22cb8fd0 data-v-22cb8fd0><path d="M1.5726 5.13748C1.42945 5.20622 1.2411 5.36661 1.15822 5.48117C1 5.69503 1 5.74849 1 11.8739C1 17.9993 1 18.0528 1.15822 18.2667C1.2411 18.3812 1.42945 18.5416 1.5726 18.6104C1.8137 18.7402 2.46164 18.7478 12 18.7478C21.5384 18.7478 22.1863 18.7402 22.4274 18.6104C22.5706 18.5416 22.7589 18.3812 22.8418 18.2667C23 18.0528 23 17.9993 23 11.8739C23 5.74849 23 5.69503 22.8418 5.48117C22.7589 5.36661 22.5706 5.20622 22.4274 5.13748C22.1863 5.00764 21.5384 5 12 5C2.46164 5 1.8137 5.00764 1.5726 5.13748ZM7.7055 8.2613C8.0822 8.45989 8.59454 9.0098 8.77536 9.40694C8.89589 9.66664 8.91095 9.94922 8.91095 12.0649C8.91095 14.3104 8.90344 14.4478 8.75275 14.7839C8.51919 15.288 8.16506 15.6546 7.68288 15.899C7.26096 16.1052 7.22328 16.1128 5.7315 16.1358L4.20206 16.1663V12.1031V8.04744L5.80684 8.07035C7.27602 8.09327 7.42672 8.10854 7.7055 8.2613ZM13.6952 8.89521V9.73538H12.4521H11.2089V10.4991V11.2629H11.9623H12.7158V12.1031V12.9432H11.9623H11.2089V13.707V14.4708H12.4521H13.6952V15.3109V16.151H12C10.1315 16.151 10.0411 16.1358 9.67191 15.6928L9.47603 15.4484V12.1336C9.47603 8.46752 9.46851 8.49807 9.95069 8.20783C10.1692 8.07035 10.3425 8.05508 11.9473 8.05508H13.6952V8.89521ZM16.5658 10.3769C16.8897 11.6295 17.1685 12.6912 17.176 12.7293C17.1911 12.7675 17.4699 11.7441 17.8014 10.461C18.1254 9.17017 18.4343 8.1009 18.4795 8.08563C18.5247 8.06271 18.9541 8.06271 19.4288 8.07035L20.3028 8.09327L19.376 11.6219C18.8713 13.5542 18.4117 15.2269 18.3664 15.3261C18.0123 16.0135 17.274 16.3343 16.7164 16.0441C16.4528 15.899 16.0911 15.4865 15.9705 15.1887C15.9254 15.0665 15.4884 13.4549 15.0062 11.6142C14.524 9.76593 14.1171 8.20783 14.0945 8.15437C14.0644 8.07035 14.2301 8.05508 15.0212 8.07035L15.9856 8.09327L16.5658 10.3769Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M5.93491 12.103V14.4707H6.27394C6.66574 14.4707 7.01983 14.3103 7.1404 14.0965C7.18559 14.0048 7.21575 13.2105 7.21575 12.0648V10.1783L6.99725 9.95683C6.80133 9.76591 6.71847 9.73535 6.35683 9.73535H5.93491V12.103Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a></footer></div></div></div><script>window.__NUXT__=function(s,n,a){return n.type_of="article",n.id=902440,n.title="Building a Webpack alternative in F#",n.description="Fable 3 made something I was not aware for some time, it moved to emitting ESM Modules and leaving...",n.readable_publish_date="Dec 17 '21",n.slug="building-a-webpack-alternative-in-f-4p0f",n.path="/tunaxor/building-a-webpack-alternative-in-f-4p0f",n.url="https://dev.to/tunaxor/building-a-webpack-alternative-in-f-4p0f",n.comments_count=8,n.public_reactions_count=77,n.collection_id=9772,n.published_timestamp=a,n.positive_reactions_count=77,n.cover_image="https://res.cloudinary.com/practicaldev/image/fetch/s--DMuY9BZM--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1lo9l9tm4ajnnze56u93.png",n.social_image="https://res.cloudinary.com/practicaldev/image/fetch/s--0u08U4oU--/c_imagga_scale,f_auto,fl_progressive,h_500,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1lo9l9tm4ajnnze56u93.png",n.canonical_url="https://blog.tunaxor.me/blog/2021-12-16-Building-a-webpack-alternative-in-fsharp.html",n.created_at="2021-11-18T22:29:19Z",n.edited_at="2021-12-17T18:28:17Z",n.crossposted_at=s,n.published_at=a,n.last_comment_at="2022-01-06T08:15:18Z",n.reading_time_minutes=26,n.tag_list="fsharp, fsadvent, dotnet, frontend",n.tags=["fsharp","fsadvent","dotnet","frontend"],n.body_html='<p>Fable 3 made something I was not aware for some time, it moved to emitting ESM Modules and leaving babel and other stuff behind for users to set up.<br>\nIt was around June that I was really mad at compilation times with <a href="https://fable.io/">Fable</a> projects, After being in the JS/Node ecosystems for years I wondered what could be done to improve that situation.</p>\n\n\n<blockquote class="ltag__twitter-tweet" data-url="https://twitter.com/angel_d_munoz/status/1404250352338325510">\n\n  <div class="ltag__twitter-tweet__main" data-url="https://twitter.com/angel_d_munoz/status/1404250352338325510">\n    <div class="ltag__twitter-tweet__header">\n      <img class="ltag__twitter-tweet__profile-image" src="https://res.cloudinary.com/practicaldev/image/fetch/s--s15CcGpw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://pbs.twimg.com/profile_images/1427821392662339584/ev-ZMAoV_normal.jpg" alt="Angel Munoz profile image" loading="lazy">\n      <div class="ltag__twitter-tweet__full-name">\n        Angel Munoz\n      </div>\n      <div class="ltag__twitter-tweet__username">\n        @angel_d_munoz\n      </div>\n      <div class="ltag__twitter-tweet__twitter-logo">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--ir1kO05j--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-f95605061196010f91e64806688390eb1a4dbc9e913682e043eb8b1e06ca484f.svg" alt="twitter logo" loading="lazy">\n      </div>\n    </div>\n    <div class="ltag__twitter-tweet__body">\n      If you\'re only using html/css/<a href="https://twitter.com/hashtag/fsharp">#fsharp</a> I think you can have a fairly modern dev setup with just suave, fable cli and F# scripts, I\'ll see if I can get a POC out later on, what would be missing HMR, bundling, some types of imports and preprocessing\n    </div>\n    <div class="ltag__twitter-tweet__date">\n      01:32 AM - 14 Jun 2021\n    </div>\n\n\n    <div class="ltag__twitter-tweet__actions">\n      <a href="https://twitter.com/intent/tweet?in_reply_to=1404250352338325510" class="ltag__twitter-tweet__actions__button">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--fFnoeFxk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-reply-action-238fe0a37991706a6880ed13941c3efd6b371e4aefe288fe8e0db85250708bc4.svg" alt="Twitter reply action" loading="lazy">\n      </a>\n      <a href="https://twitter.com/intent/retweet?tweet_id=1404250352338325510" class="ltag__twitter-tweet__actions__button">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--k6dcrOn8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-retweet-action-632c83532a4e7de573c5c08dbb090ee18b348b13e2793175fea914827bc42046.svg" alt="Twitter retweet action" loading="lazy">\n      </a>\n      <a href="https://twitter.com/intent/like?tweet_id=1404250352338325510" class="ltag__twitter-tweet__actions__button">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--SRQc9lOp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-like-action-1ea89f4b87c7d37465b0eb78d51fcb7fe6c03a089805d7ea014ba71365be5171.svg" alt="Twitter like action" loading="lazy">\n      </a>\n    </div>\n  </div>\n</blockquote>\n\n\n<p>At the time I had been exploring alternatives to <a href="https://webpack.js.org/">Webpack</a> like <a href="https://fuse-box.org/">fuse-box</a>, <a href="https://parceljs.org/">parcel</a>, and <a href="https://esbuild.github.io/">esbuild</a>. Around the same time I was made aware aware that browsers had already implemented <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules">ESM modules</a>, so technically as long as you produced HTML, CSS, and JS you didn\'t need any kind of pre-processing at all.</p>\n\n<p>This shouldn\'t be that hard, I just needed a server that well... served the HTML/CSS/JS files right?<br>\nI went to my desktop, created an F# script added a couple of libraries like <a href="https://suave.io/">Suave</a> and <a href="https://github.com/Tyrrrz/CliWrap">CliWrap</a> so I could call the <code>dotnet fable</code> command from my F# code and make it compile my Fable files.</p>\n\n<p>Taking out some code I came up with this PoC:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight fsharp"><code><span class="c1">// I omited more code above for brevity</span>\n<span class="k">let</span> <span class="n">stdinAsyncSeq</span> <span class="bp">()</span> <span class="p">=</span>\n    <span class="k">let</span> <span class="n">readFromStdin</span> <span class="bp">()</span> <span class="p">=</span>\n        <span class="nn">Console</span><span class="p">.</span><span class="nn">In</span><span class="p">.</span><span class="nc">ReadLineAsync</span><span class="bp">()</span> <span class="p">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">AwaitTask</span>\n\n    <span class="n">asyncSeq</span> <span class="p">{</span>\n        <span class="c1">// I wanted to think this is a "clever"</span>\n        <span class="c1">// way to keep it running</span>\n        <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>\n            <span class="k">let</span><span class="o">!</span> <span class="n">value</span> <span class="p">=</span> <span class="n">readFromStdin</span> <span class="bp">()</span>\n            <span class="n">value</span>\n    <span class="p">}</span>\n    <span class="p">|&gt;</span> <span class="nn">AsyncSeq</span><span class="p">.</span><span class="n">distinctUntilChanged</span>\n    <span class="p">|&gt;</span> <span class="nn">AsyncSeq</span><span class="p">.</span><span class="n">iterAsync</span> <span class="n">onStdinAsync</span>\n\n<span class="k">let</span> <span class="n">app</span> <span class="p">=</span>\n    <span class="n">choose</span> <span class="p">[</span> <span class="n">path</span> <span class="s2">"/"</span>\n             <span class="o">&gt;=&gt;</span> <span class="nc">GET</span>\n             <span class="c1">// send the index file</span>\n             <span class="o">&gt;=&gt;</span> <span class="nn">Files</span><span class="p">.</span><span class="n">browseFileHome</span> <span class="s2">"index.html"</span>\n             <span class="c1">// serve static files</span>\n             <span class="nc">GET</span> <span class="o">&gt;=&gt;</span> <span class="nn">Files</span><span class="p">.</span><span class="n">browseHome</span>\n             <span class="nn">RequestErrors</span><span class="p">.</span><span class="nc">NOT_FOUND</span> <span class="s2">"Not Found"</span>\n             <span class="c1">// SPA like fallback</span>\n             <span class="o">&gt;=&gt;</span> <span class="n">redirect</span> <span class="s2">"/"</span> <span class="p">]</span>\n\n<span class="k">let</span> <span class="n">config</span> <span class="p">(</span><span class="n">publicPath</span><span class="p">:</span> <span class="kt">string</span> <span class="n">option</span><span class="p">)</span> <span class="p">=</span>\n    <span class="k">let</span> <span class="n">path</span> <span class="p">=</span>\n        <span class="nn">Path</span><span class="p">.</span><span class="nc">GetFullPath</span><span class="p">(</span>\n            <span class="k">match</span> <span class="n">publicPath</span> <span class="k">with</span>\n            <span class="p">|</span> <span class="nc">Some</span> <span class="s2">"built"</span> <span class="p">-&gt;</span> <span class="s2">"./dist"</span>\n            <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="s2">"./public"</span>\n        <span class="p">)</span>\n\n    <span class="n">printfn</span> <span class="o">$</span><span class="s2">"Serving content from {path}"</span>\n    <span class="c1">// configure the suave server instance</span>\n    <span class="p">{</span> <span class="n">defaultConfig</span> <span class="k">with</span>\n          <span class="n">bindings</span> <span class="p">=</span> <span class="p">[</span> <span class="nn">HttpBinding</span><span class="p">.</span><span class="n">createSimple</span> <span class="nc">HTTP</span> <span class="s2">"0.0.0.0"</span> <span class="mi">3000</span> <span class="p">]</span>\n          <span class="n">homeFolder</span> <span class="p">=</span> <span class="nc">Some</span> <span class="n">path</span>\n          <span class="n">compressedFilesFolder</span> <span class="p">=</span> <span class="nc">Some</span><span class="p">(</span><span class="nn">Path</span><span class="p">.</span><span class="nc">GetFullPath</span> <span class="s2">"./.compressed"</span><span class="p">)</span> <span class="p">}</span>\n<span class="c1">// let\'s make it run!</span>\n<span class="n">stdinAsyncSeq</span> <span class="bp">()</span> <span class="p">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">Start</span>\n<span class="c1">// dotnet fsi suave.fsx built to show how bundled files work</span>\n<span class="n">startWebServer</span> <span class="p">(</span><span class="n">config</span> <span class="p">(</span><span class="n">fsi</span><span class="p">.</span><span class="nc">CommandLineArgs</span> <span class="p">|&gt;</span> <span class="nn">Array</span><span class="p">.</span><span class="n">tryLast</span><span class="o">))</span> <span class="n">app</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>Now, I could have my suave server and my Fable compiler running on the background. I could see my files being served in my browser I could make changes, press F5 and see them working.</p>\n\n\n<blockquote class="ltag__twitter-tweet" data-url="https://twitter.com/angel_d_munoz/status/1404300942648954882">\n\n  <div class="ltag__twitter-tweet__main" data-url="https://twitter.com/angel_d_munoz/status/1404300942648954882">\n    <div class="ltag__twitter-tweet__header">\n      <img class="ltag__twitter-tweet__profile-image" src="https://res.cloudinary.com/practicaldev/image/fetch/s--s15CcGpw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://pbs.twimg.com/profile_images/1427821392662339584/ev-ZMAoV_normal.jpg" alt="Angel Munoz profile image" loading="lazy">\n      <div class="ltag__twitter-tweet__full-name">\n        Angel Munoz\n      </div>\n      <div class="ltag__twitter-tweet__username">\n        @angel_d_munoz\n      </div>\n      <div class="ltag__twitter-tweet__twitter-logo">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--ir1kO05j--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-f95605061196010f91e64806688390eb1a4dbc9e913682e043eb8b1e06ca484f.svg" alt="twitter logo" loading="lazy">\n      </div>\n    </div>\n    <div class="ltag__twitter-tweet__body">\n      It is possible to have a "node-less" <a href="https://twitter.com/hashtag/fsharp">#fsharp</a> frontend development experience thanks to  <a href="https://twitter.com/FableCompiler">@FableCompiler</a> and <a href="https://twitter.com/SuaveIO">@SuaveIO</a> <br>with a small F# script you can spin up a suave server and have fable compile your files in the background <br><a href="https://t.co/LfscIPlw9s">github.com/AngelMunoz/sua…</a>\n    </div>\n    <div class="ltag__twitter-tweet__date">\n      04:53 AM - 14 Jun 2021\n    </div>\n\n\n    <div class="ltag__twitter-tweet__actions">\n      <a href="https://twitter.com/intent/tweet?in_reply_to=1404300942648954882" class="ltag__twitter-tweet__actions__button">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--fFnoeFxk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-reply-action-238fe0a37991706a6880ed13941c3efd6b371e4aefe288fe8e0db85250708bc4.svg" alt="Twitter reply action" loading="lazy">\n      </a>\n      <a href="https://twitter.com/intent/retweet?tweet_id=1404300942648954882" class="ltag__twitter-tweet__actions__button">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--k6dcrOn8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-retweet-action-632c83532a4e7de573c5c08dbb090ee18b348b13e2793175fea914827bc42046.svg" alt="Twitter retweet action" loading="lazy">\n      </a>\n      <a href="https://twitter.com/intent/like?tweet_id=1404300942648954882" class="ltag__twitter-tweet__actions__button">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--SRQc9lOp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-like-action-1ea89f4b87c7d37465b0eb78d51fcb7fe6c03a089805d7ea014ba71365be5171.svg" alt="Twitter like action" loading="lazy">\n      </a>\n    </div>\n  </div>\n</blockquote>\n\n\n<p>Cool it worked... Yay!... sure, with my attention span for some things I simply didn\'t think too much about it, or so I thought.</p>\n\n<p>What came up next was experimenting with snowpack and fuse-box to see which setup could work best with Fable 3 and Although, Both projects work extremely well with Fable, the snowpack project felt more compelling to me thanks to the promoted <a href="https://www.snowpack.dev/concepts/how-snowpack-works#unbundled-development">Unbundled</a> development concept. I decided to go for it and tried the <a href="https://github.com/AngelMunoz/real-world-fable">Fable Real World</a> implementation and switched webpack for snowpack and the results were kind of what I was expecting, faster builds, a simpler setup and a much faster developer loop feedback with the browser.</p>\n\n<p>Unconsciously on the back of my head was still that voice about writing something like snowpack in F#... In my mind, the people who build those kinds of tools are like people in the movies; You know they exist but, you don\'t think you are capable of doing something like it. Specially when most of my experience at that point was building UI\'s in things like Angular.</p>\n\n<p>I went ahead and started studying the snowpack source code and I found out that they were using <a href="https://esbuild.github.io/">esbuild</a> a JS/TS compiler written in Go, no wonder why it was faster than anything done in JavaScript at the time.</p>\n\n<p>Also, on the background <a href="https://vitejs.dev/">vitejs</a> was also starting to get in shape, I was looking at Evan\'s tweets from afar and getting inspired from that as well so I realized I needed to go back and see if I could go even further.</p>\n\n<ul>\n<li>What if I used esbuild as well?</li>\n<li>What if I could use esbuild to produce my prod bundle after I built my fable code?</li>\n</ul>\n\n\n<blockquote class="ltag__twitter-tweet" data-url="https://twitter.com/angel_d_munoz/status/1407072676355751938">\n      <div class="ltag__twitter-tweet__media ltag__twitter-tweet__media__video-wrapper">\n        <div class="ltag__twitter-tweet__media--video-preview">\n          <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--DLXdonkH--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://pbs.twimg.com/tweet_video_thumb/E4br8O3WEAEiLeX.jpg" alt="unknown tweet media content" loading="lazy">\n          <img src="/assets/play-butt.svg" class="ltag__twitter-tweet__play-butt" alt="Play butt" loading="lazy">\n        </div>\n        <div class="ltag__twitter-tweet__video">\n          <video loop controls>\n            <source src="https://video.twimg.com/tweet_video/E4br8O3WEAEiLeX.mp4" type="video/mp4">\n          </source></video>\n        </div>\n      </div>\n\n  <div class="ltag__twitter-tweet__main" data-url="https://twitter.com/angel_d_munoz/status/1407072676355751938">\n    <div class="ltag__twitter-tweet__header">\n      <img class="ltag__twitter-tweet__profile-image" src="https://res.cloudinary.com/practicaldev/image/fetch/s--s15CcGpw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://pbs.twimg.com/profile_images/1427821392662339584/ev-ZMAoV_normal.jpg" alt="Angel Munoz profile image" loading="lazy">\n      <div class="ltag__twitter-tweet__full-name">\n        Angel Munoz\n      </div>\n      <div class="ltag__twitter-tweet__username">\n        @angel_d_munoz\n      </div>\n      <div class="ltag__twitter-tweet__twitter-logo">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--ir1kO05j--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-f95605061196010f91e64806688390eb1a4dbc9e913682e043eb8b1e06ca484f.svg" alt="twitter logo" loading="lazy">\n      </div>\n    </div>\n    <div class="ltag__twitter-tweet__body">\n      Going back to that suave-dev server...<br>if we do add esbuild, we could actually go nodeless even  when preparing for prod stuff<br><a href="https://twitter.com/hashtag/fsharp">#fsharp</a><br>updated the scripts there<br><a href="https://t.co/LfscIPlw9s">github.com/AngelMunoz/sua…</a> \n    </div>\n    <div class="ltag__twitter-tweet__date">\n      20:27 PM - 21 Jun 2021\n    </div>\n\n\n    <div class="ltag__twitter-tweet__actions">\n      <a href="https://twitter.com/intent/tweet?in_reply_to=1407072676355751938" class="ltag__twitter-tweet__actions__button">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--fFnoeFxk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-reply-action-238fe0a37991706a6880ed13941c3efd6b371e4aefe288fe8e0db85250708bc4.svg" alt="Twitter reply action" loading="lazy">\n      </a>\n      <a href="https://twitter.com/intent/retweet?tweet_id=1407072676355751938" class="ltag__twitter-tweet__actions__button">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--k6dcrOn8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-retweet-action-632c83532a4e7de573c5c08dbb090ee18b348b13e2793175fea914827bc42046.svg" alt="Twitter retweet action" loading="lazy">\n      </a>\n      <a href="https://twitter.com/intent/like?tweet_id=1407072676355751938" class="ltag__twitter-tweet__actions__button">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--SRQc9lOp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-like-action-1ea89f4b87c7d37465b0eb78d51fcb7fe6c03a089805d7ea014ba71365be5171.svg" alt="Twitter like action" loading="lazy">\n      </a>\n    </div>\n  </div>\n</blockquote>\n\n\n<p>Turns out... I wasn\'t that crazy, after all both vite and snowpack were doing it as well!</p>\n\n<p>Around September vite got traction with the vue user base and other users as well. I also studied a bit the vite source code, and even used it for some Fable material for posts. I was trying to make some awareness of <a href="https://fable.io/Fable.Lit/">Fable.Lit</a> support for Web Components and I wanted to experiment in reality how good vite was, and boi it\'s awesome If you\'re starting new projects that depend on node tooling in my opinion, it\'s your best bet.</p>\n\n<p>Anyways, I tend to be looking at what\'s new on the web space, and by this time these... <a href="https://github.com/WICG/import-maps">Import Maps</a> thing came to my attention, it is a really nice browser feature that can be used to control the browser\'s behavior to import JavaScript files.</p>\n\n<p>Import maps can tell the browser to use "bare specifiers" (i.e. <code>import dependency from "my-dependency"</code> rather than <code>"./my-dependency.js</code>) </p>\n\n<p>Almost like "pull this import from this URL".</p>\n\n<p>Hopefully you are starting to put the pieces together as I was doing.</p>\n\n<p>Maybe... It might be possible to actually enjoy the NPM ecosystem without having to rely on the local tooling... Just maybe...</p>\n\n\n<blockquote class="ltag__twitter-tweet" data-url="https://twitter.com/angel_d_munoz/status/1438579622904582144">\n    <div class="ltag__twitter-tweet__media ltag__twitter-tweet__media__two-pics">\n      <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--bGQuh9of--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://pbs.twimg.com/media/E_bbm6uWQAQuNjI.jpg" alt="unknown tweet media content" loading="lazy">\n    </div>\n\n  <div class="ltag__twitter-tweet__main" data-url="https://twitter.com/angel_d_munoz/status/1438579622904582144">\n    <div class="ltag__twitter-tweet__header">\n      <img class="ltag__twitter-tweet__profile-image" src="https://res.cloudinary.com/practicaldev/image/fetch/s--s15CcGpw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://pbs.twimg.com/profile_images/1427821392662339584/ev-ZMAoV_normal.jpg" alt="Angel Munoz profile image" loading="lazy">\n      <div class="ltag__twitter-tweet__full-name">\n        Angel Munoz\n      </div>\n      <div class="ltag__twitter-tweet__username">\n        @angel_d_munoz\n      </div>\n      <div class="ltag__twitter-tweet__twitter-logo">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--ir1kO05j--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-f95605061196010f91e64806688390eb1a4dbc9e913682e043eb8b1e06ca484f.svg" alt="twitter logo" loading="lazy">\n      </div>\n    </div>\n    <div class="ltag__twitter-tweet__body">\n      It\'s starting to make sense if this works we would just need a couple of msbuild tasks to switch from lookup to pinned urls in prod mode and no node needed for frontend development, <a href="https://twitter.com/skypackjs">@skypackjs</a> and import maps really enable cool stuff<br><a href="https://twitter.com/hashtag/fsharp">#fsharp</a> \n    </div>\n    <div class="ltag__twitter-tweet__date">\n      19:04 PM - 16 Sep 2021\n    </div>\n\n\n    <div class="ltag__twitter-tweet__actions">\n      <a href="https://twitter.com/intent/tweet?in_reply_to=1438579622904582144" class="ltag__twitter-tweet__actions__button">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--fFnoeFxk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-reply-action-238fe0a37991706a6880ed13941c3efd6b371e4aefe288fe8e0db85250708bc4.svg" alt="Twitter reply action" loading="lazy">\n      </a>\n      <a href="https://twitter.com/intent/retweet?tweet_id=1438579622904582144" class="ltag__twitter-tweet__actions__button">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--k6dcrOn8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-retweet-action-632c83532a4e7de573c5c08dbb090ee18b348b13e2793175fea914827bc42046.svg" alt="Twitter retweet action" loading="lazy">\n      </a>\n      <a href="https://twitter.com/intent/like?tweet_id=1438579622904582144" class="ltag__twitter-tweet__actions__button">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--SRQc9lOp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-like-action-1ea89f4b87c7d37465b0eb78d51fcb7fe6c03a089805d7ea014ba71365be5171.svg" alt="Twitter like action" loading="lazy">\n      </a>\n    </div>\n  </div>\n</blockquote>\n \n\n<p>From then on, It was just about making small F# scripts to experiment PoC\'s and implementing small features.</p>\n\n<p>At this point is when I said to myself.</p>\n\n<blockquote>\n<p>It\'s time to build a Webpack alternative...</p>\n</blockquote>\n\n<p>For this... <em>FSharp.DevServer</em>... I needed to have an idea of what I wanted to implement to make it usable at least, I settled on the following set of features.</p>\n\n<ul>\n<li>Serve HTML/CSS/JS</li>\n<li>Support for Fable Projects</li>\n<li>Reload on change</li>\n<li>Install dependencies</li>\n<li>Production Bundles</li>\n<li>Transpilation on the fly</li>\n<li>Dev Proxy</li>\n<li>Plugins</li>\n<li>HMR</li>\n</ul>\n\n<p>Those are the least features necessary IMO to consider for a project like this.</p>\n\n<p>I will take you on a quick tour at how those got implemented at some point in the project.</p>\n\n<blockquote>\n<p>Keep in mind I\'m not an F# expert! I\'m just a guy with a lot of anxiety and free time so I use my code to distract myself while having a ton of fun with F# code.</p>\n</blockquote>\n\n<p>While for a proof of concept Suave did great, I switched it in favor of <a href="https://saturnframework.org/">Saturn</a> given my familiarity with it and some ASP.NET code.</p>\n<h2>\n  <a name="serve-htmlcssjs" href="#serve-htmlcssjs">\n  </a>\n  Serve HTML/CSS/JS\n</h2>\n\n<p>From most of the features, this must have been perhaps the most simple after all if you\'re using a server, it should be really simple to do right?</p>\n\n<p>Well... Yes and No... it turns out that if you serve static files they get out of the middleware chain very quick due to the order of the static middleware is in. While it was good for serving it if I wanted to reload on change or compile these files I was not going to be able to do it.<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight fsharp"><code><span class="c1">// the current devServer function has way more stuff</span>\n<span class="c1">// due the extra features that have been implemented</span>\n<span class="k">let</span> <span class="k">private</span> <span class="n">devServer</span> <span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nc">FdsConfig</span><span class="p">)</span> <span class="p">=</span>\n    <span class="k">let</span> <span class="n">withAppConfig</span> <span class="p">(</span><span class="n">appConfig</span><span class="p">:</span> <span class="nc">IApplicationBuilder</span><span class="p">)</span> <span class="p">=</span>\n        <span class="c1">// let\'s serve everything statically</span>\n        <span class="c1">// but let\'s ignore some extensions</span>\n        <span class="k">let</span> <span class="n">ignoreStatic</span> <span class="p">=</span>\n          <span class="p">[</span> <span class="s2">".js"</span>\n            <span class="s2">".css"</span>\n            <span class="s2">".module.css"</span>\n            <span class="s2">".ts"</span>\n            <span class="s2">".tsx"</span>\n            <span class="s2">".jsx"</span>\n            <span class="s2">".json"</span> <span class="p">]</span>\n        <span class="c1">// mountedDirs is a property in perla.jsonc</span>\n        <span class="c1">// that enables you to watch a partcular set of </span>\n        <span class="c1">// directories for source code</span>\n        <span class="k">for</span> <span class="n">map</span> <span class="k">in</span> <span class="n">mountedDirs</span> <span class="k">do</span>\n          <span class="k">let</span> <span class="n">staticFileOptions</span> <span class="p">=</span>\n            <span class="k">let</span> <span class="n">provider</span> <span class="p">=</span> <span class="nc">FileExtensionContentTypeProvider</span><span class="bp">()</span>\n\n            <span class="k">for</span> <span class="n">ext</span> <span class="k">in</span> <span class="n">ignoreStatic</span> <span class="k">do</span>\n              <span class="n">provider</span><span class="p">.</span><span class="nn">Mappings</span><span class="p">.</span><span class="nc">Remove</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="n">ignore</span>\n\n            <span class="k">let</span> <span class="n">options</span> <span class="p">=</span> <span class="nc">StaticFileOptions</span><span class="bp">()</span>\n\n            <span class="n">options</span><span class="p">.</span><span class="nc">ContentTypeProvider</span> <span class="p">&lt;-</span> <span class="n">provider</span>\n            <span class="c1">// in the next lines we enable local mapings</span>\n            <span class="c1">// to URL\'s e.g.</span>\n            <span class="c1">// ./src on disk -&gt; /src on the URL</span>\n            <span class="n">options</span><span class="p">.</span><span class="nc">RequestPath</span> <span class="p">&lt;-</span> <span class="nc">PathString</span><span class="p">(</span><span class="n">map</span><span class="p">.</span><span class="nc">Value</span><span class="p">)</span>\n\n            <span class="n">options</span><span class="p">.</span><span class="nc">FileProvider</span> <span class="p">&lt;-</span>\n              <span class="k">new</span> <span class="nc">PhysicalFileProvider</span><span class="p">(</span><span class="nn">Path</span><span class="p">.</span><span class="nc">GetFullPath</span><span class="p">(</span><span class="n">map</span><span class="p">.</span><span class="nc">Key</span><span class="o">))</span>\n\n            <span class="n">options</span>\n\n          <span class="n">appConfig</span><span class="p">.</span><span class="nc">UseStaticFiles</span> <span class="n">staticFileOptions</span>\n          <span class="p">|&gt;</span> <span class="n">ignore</span>\n\n        <span class="k">let</span> <span class="n">appConfig</span> <span class="p">=</span>\n          <span class="c1">// at the same time we enable transpilation</span>\n          <span class="c1">// middleware when we\'re ignoring some extensions</span>\n          <span class="n">appConfig</span><span class="p">.</span><span class="nc">UseWhen</span><span class="p">(</span>\n            <span class="nn">Middleware</span><span class="p">.</span><span class="n">transformPredicate</span> <span class="n">ignoreStatic</span><span class="p">,</span>\n            <span class="nn">Middleware</span><span class="p">.</span><span class="n">configureTransformMiddleware</span> <span class="n">config</span>\n          <span class="p">)</span>\n    <span class="c1">// set the configured options</span>\n    <span class="n">application</span> <span class="p">{</span>\n        <span class="n">app_config</span> <span class="n">withAppConfig</span>\n        <span class="n">webhost_config</span> <span class="n">withWebhostConfig</span>\n        <span class="n">use_endpoint_router</span> <span class="n">urls</span>\n    <span class="p">}</span>\n    <span class="c1">// build it</span>\n    <span class="n">app</span>\n        <span class="p">.</span><span class="nc">UseEnvironment</span><span class="p">(</span><span class="nn">Environments</span><span class="p">.</span><span class="nc">Development</span><span class="p">)</span>\n        <span class="p">.</span><span class="nc">Build</span><span class="bp">()</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>This part is just about serving files, nothing more, nothing less, that\'s the core of a dev server. </p>\n<h2>\n  <a name="support-for-fable-projects" href="#support-for-fable-projects">\n  </a>\n  Support for Fable Projects\n</h2>\n\n<p>Fable is actually not hard to support, fable is distributed as a dotnet tool, we can invoke the command with <a href="https://github.com/Tyrrrz/CliWrap">CliWrap</a> which has proven us in the PoC stage, how simple is to call a process from .NET.<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight fsharp"><code><span class="c1">// This is the actual Fable implementation</span>\n\n<span class="k">module</span> <span class="nc">Fable</span> <span class="p">=</span>\n  <span class="k">let</span> <span class="k">mutable</span> <span class="k">private</span> <span class="n">activeFable</span><span class="p">:</span> <span class="kt">int</span> <span class="n">option</span> <span class="p">=</span> <span class="nc">None</span>\n\n  <span class="c1">// this is to start/stop the fable command</span>\n  <span class="c1">// if requested by the user</span>\n  <span class="k">let</span> <span class="k">private</span> <span class="n">killActiveProcess</span> <span class="n">pid</span> <span class="p">=</span>\n    <span class="k">try</span>\n      <span class="k">let</span> <span class="n">activeProcess</span> <span class="p">=</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Diagnostics</span><span class="p">.</span><span class="nn">Process</span><span class="p">.</span><span class="nc">GetProcessById</span> <span class="n">pid</span>\n\n      <span class="n">activeProcess</span><span class="p">.</span><span class="nc">Kill</span><span class="bp">()</span>\n    <span class="k">with</span>\n    <span class="p">|</span> <span class="n">ex</span> <span class="p">-&gt;</span> <span class="n">printfn</span> <span class="o">$</span><span class="s2">"Failed to Kill Procees with PID: [{pid}]</span><span class="se">\\n</span><span class="s2">{ex.Message}"</span>\n\n  <span class="c1">// Helper functions to add arguments to the fable command</span>\n\n  <span class="k">let</span> <span class="k">private</span> <span class="n">addOutDir</span>\n    <span class="p">(</span><span class="n">outdir</span><span class="p">:</span> <span class="kt">string</span> <span class="n">option</span><span class="p">)</span>\n    <span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="nn">Builders</span><span class="p">.</span><span class="nc">ArgumentsBuilder</span><span class="p">)</span>\n    <span class="p">=</span>\n    <span class="k">match</span> <span class="n">outdir</span> <span class="k">with</span>\n    <span class="p">|</span> <span class="nc">Some</span> <span class="n">outdir</span> <span class="p">-&gt;</span> <span class="n">args</span><span class="p">.</span><span class="nc">Add</span> <span class="o">$</span><span class="s2">"-o {outdir}"</span>\n    <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span> <span class="n">args</span>\n\n  <span class="k">let</span> <span class="k">private</span> <span class="n">addExtension</span>\n    <span class="p">(</span><span class="n">extension</span><span class="p">:</span> <span class="kt">string</span> <span class="n">option</span><span class="p">)</span>\n    <span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="nn">Builders</span><span class="p">.</span><span class="nc">ArgumentsBuilder</span><span class="p">)</span>\n    <span class="p">=</span>\n    <span class="k">match</span> <span class="n">extension</span> <span class="k">with</span>\n    <span class="p">|</span> <span class="nc">Some</span> <span class="n">extension</span> <span class="p">-&gt;</span> <span class="n">args</span><span class="p">.</span><span class="nc">Add</span> <span class="o">$</span><span class="s2">"-e {extension}"</span>\n    <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span> <span class="n">args</span>\n\n  <span class="k">let</span> <span class="k">private</span> <span class="n">addWatch</span> <span class="p">(</span><span class="n">watch</span><span class="p">:</span> <span class="kt">bool</span> <span class="n">option</span><span class="p">)</span> <span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="nn">Builders</span><span class="p">.</span><span class="nc">ArgumentsBuilder</span><span class="p">)</span> <span class="p">=</span>\n    <span class="k">match</span> <span class="n">watch</span> <span class="k">with</span>\n    <span class="p">|</span> <span class="nc">Some</span> <span class="bp">true</span> <span class="p">-&gt;</span> <span class="n">args</span><span class="p">.</span><span class="nc">Add</span> <span class="o">$</span><span class="s2">"--watch"</span>\n    <span class="p">|</span> <span class="nc">Some</span> <span class="bp">false</span>\n    <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span> <span class="n">args</span>\n\n  <span class="c1">// we can fire up fable either as a background process</span>\n  <span class="c1">// or before calling esbuild for production</span>\n  <span class="k">let</span> <span class="n">fableCmd</span> <span class="p">(</span><span class="n">isWatch</span><span class="p">:</span> <span class="kt">bool</span> <span class="n">option</span><span class="p">)</span> <span class="p">=</span>\n\n    <span class="k">fun</span> <span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nc">FableConfig</span><span class="p">)</span> <span class="p">-&gt;</span>\n      <span class="k">let</span> <span class="n">execBinName</span> <span class="p">=</span>\n        <span class="k">if</span> <span class="nn">Env</span><span class="p">.</span><span class="n">isWindows</span> <span class="k">then</span>\n          <span class="s2">"dotnet.exe"</span>\n        <span class="k">else</span>\n          <span class="s2">"dotnet"</span>\n\n      <span class="nn">Cli</span>\n        <span class="p">.</span><span class="nc">Wrap</span><span class="p">(</span><span class="n">execBinName</span><span class="p">)</span>\n        <span class="p">.</span><span class="nc">WithArguments</span><span class="p">(</span><span class="k">fun</span> <span class="n">args</span> <span class="p">-&gt;</span>\n          <span class="n">args</span>\n            <span class="p">.</span><span class="nc">Add</span><span class="p">(</span><span class="s2">"fable"</span><span class="p">)</span>\n            <span class="p">.</span><span class="nc">Add</span><span class="p">(</span><span class="n">defaultArg</span> <span class="n">config</span><span class="p">.</span><span class="n">project</span> <span class="s2">"./src/App.fsproj"</span><span class="p">)</span>\n          <span class="p">|&gt;</span> <span class="n">addWatch</span> <span class="n">isWatch</span>\n          <span class="p">|&gt;</span> <span class="n">addOutDir</span> <span class="n">config</span><span class="p">.</span><span class="n">outDir</span>\n          <span class="p">|&gt;</span> <span class="n">addExtension</span> <span class="n">config</span><span class="p">.</span><span class="n">extension</span>\n          <span class="p">|&gt;</span> <span class="n">ignore</span><span class="p">)</span>\n        <span class="c1">// we don\'t do a lot, we simply re-direct the stdio to the console</span>\n        <span class="p">.</span><span class="nc">WithStandardErrorPipe</span><span class="p">(</span><span class="nn">PipeTarget</span><span class="p">.</span><span class="nc">ToStream</span><span class="p">(</span><span class="nn">Console</span><span class="p">.</span><span class="nc">OpenStandardError</span><span class="bp">()</span><span class="o">))</span>\n        <span class="p">.</span><span class="nc">WithStandardOutputPipe</span><span class="p">(</span>\n          <span class="nn">PipeTarget</span><span class="p">.</span><span class="nc">ToStream</span><span class="p">(</span><span class="nn">Console</span><span class="p">.</span><span class="nc">OpenStandardOutput</span><span class="bp">()</span><span class="p">)</span>\n        <span class="p">)</span>\n\n  <span class="k">let</span> <span class="n">stopFable</span> <span class="bp">()</span> <span class="p">=</span>\n    <span class="k">match</span> <span class="n">activeFable</span> <span class="k">with</span>\n    <span class="p">|</span> <span class="nc">Some</span> <span class="n">pid</span> <span class="p">-&gt;</span> <span class="n">killActiveProcess</span> <span class="n">pid</span>\n    <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span> <span class="n">printfn</span> <span class="s2">"No active Fable found"</span>\n\n  <span class="k">let</span> <span class="n">startFable</span>\n    <span class="p">(</span><span class="n">getCommand</span><span class="p">:</span> <span class="nc">FableConfig</span> <span class="n">option</span> <span class="p">-&gt;</span> <span class="nc">Command</span><span class="p">)</span>\n    <span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nc">FableConfig</span> <span class="n">option</span><span class="p">)</span>\n    <span class="p">=</span>\n    <span class="n">task</span> <span class="p">{</span>\n      <span class="c1">// Execute and wait for it to finish</span>\n      <span class="k">let</span> <span class="n">cmdResult</span> <span class="p">=</span> <span class="n">getCommand</span><span class="p">(</span><span class="n">config</span><span class="o">).</span><span class="nc">ExecuteAsync</span><span class="bp">()</span>\n      <span class="n">activeFable</span> <span class="p">&lt;-</span> <span class="nc">Some</span> <span class="n">cmdResult</span><span class="p">.</span><span class="nc">ProcessId</span>\n\n      <span class="k">return</span><span class="o">!</span> <span class="n">cmdResult</span><span class="p">.</span><span class="nc">Task</span>\n    <span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>Keeping the process ID on memory might not be the best idea and there can be better ways to handle that but at least for now it works just fine.</p>\n\n<p>Calling the <code>startFable</code> function with fable options, will make fable run on the background, this allows us to have fable output JS files that we will be able to serve.</p>\n<h2>\n  <a name="reload-on-change" href="#reload-on-change">\n  </a>\n  Reload on change\n</h2>\n\n<p>Reloading on change was an interesting feature to do, first of all I needed a file watcher and I have had heard before that the .NET one wasn\'t really that great, I also needed to communicate with the frontend when something changed in the backend.</p>\n\n<p>For the file watcher, I tried to search for good alternatives, but to be honest in the end I decided to go with the one in the BCL.</p>\n\n<p>I was kind of scared though how would I manage multiple notifications and events without making it a mess? I had No idea... Thankfully <a href="http://fsprojects.github.io/FSharp.Control.Reactive/">FSharp.Control.Reactive</a> was found and is just what I needed. This library allows you to make observables from events and has a bunch of nice utility functions to work with stream like collections if you\'ve used RxJS or RX.NET you will feel at home with it.<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight fsharp"><code>\n  <span class="k">let</span> <span class="n">getFileWatcher</span> <span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nc">WatchConfig</span><span class="p">)</span> <span class="p">=</span>\n    <span class="k">let</span> <span class="n">watchers</span> <span class="p">=</span>\n      <span class="c1">// monitor a particular list of  addresses</span>\n      <span class="p">(</span><span class="n">defaultArg</span> <span class="n">config</span><span class="p">.</span><span class="n">directories</span> <span class="o">([</span> <span class="s2">"./src"</span> <span class="p">]</span> <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">ofList</span><span class="o">))</span>\n      <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">dir</span> <span class="p">-&gt;</span>\n        <span class="c1">// for each address create a file watcher</span>\n        <span class="k">let</span> <span class="n">fsw</span> <span class="p">=</span> <span class="k">new</span> <span class="nc">FileSystemWatcher</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span>\n        <span class="n">fsw</span><span class="p">.</span><span class="nc">IncludeSubdirectories</span> <span class="p">&lt;-</span> <span class="bp">true</span>\n        <span class="n">fsw</span><span class="p">.</span><span class="nc">NotifyFilter</span> <span class="p">&lt;-</span> <span class="nn">NotifyFilters</span><span class="p">.</span><span class="nc">FileName</span> <span class="o">|||</span> <span class="nn">NotifyFilters</span><span class="p">.</span><span class="nc">Size</span>\n\n        <span class="k">let</span> <span class="n">filters</span> <span class="p">=</span>\n          <span class="n">defaultArg</span>\n            <span class="n">config</span><span class="p">.</span><span class="n">extensions</span>\n            <span class="p">(</span><span class="nn">Seq</span><span class="p">.</span><span class="n">ofList</span> <span class="p">[</span> <span class="s2">"*.js"</span>\n                          <span class="s2">"*.css"</span>\n                          <span class="s2">"*.ts"</span>\n                          <span class="s2">"*.tsx"</span>\n                          <span class="s2">"*.jsx"</span>\n                          <span class="s2">"*.json"</span> <span class="o">])</span>\n        <span class="c1">// ensure you\'re monitoring all of the</span>\n        <span class="c1">// extensions you want to reload on change</span>\n        <span class="k">for</span> <span class="n">filter</span> <span class="k">in</span> <span class="n">filters</span> <span class="k">do</span>\n          <span class="n">fsw</span><span class="p">.</span><span class="nn">Filters</span><span class="p">.</span><span class="nc">Add</span><span class="p">(</span><span class="n">filter</span><span class="p">)</span>\n        <span class="c1">// and ensure you will rise events for them :)</span>\n        <span class="n">fsw</span><span class="p">.</span><span class="nc">EnableRaisingEvents</span> <span class="p">&lt;-</span> <span class="bp">true</span>\n        <span class="n">fsw</span><span class="p">)</span>\n\n\n    <span class="k">let</span> <span class="n">subs</span> <span class="p">=</span>\n      <span class="n">watchers</span>\n      <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">watcher</span> <span class="p">-&gt;</span>\n        <span class="c1">// for each watche react to the following events</span>\n        <span class="c1">// Renamed</span>\n        <span class="c1">// Changed</span>\n        <span class="c1">// Deleted</span>\n        <span class="c1">// Created</span>\n        <span class="p">[</span> <span class="n">watcher</span><span class="p">.</span><span class="nc">Renamed</span>\n          <span class="c1">// To prevent overflows and weird behaviors</span>\n          <span class="c1">// ensure to throttle the events</span>\n          <span class="p">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">throttle</span> <span class="p">(</span><span class="nn">TimeSpan</span><span class="p">.</span><span class="nc">FromMilliseconds</span><span class="p">(</span><span class="mi">400</span><span class="o">.))</span>\n          <span class="p">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">e</span> <span class="p">-&gt;</span>\n            <span class="p">{</span> <span class="n">oldName</span> <span class="p">=</span> <span class="nc">Some</span> <span class="n">e</span><span class="p">.</span><span class="nc">OldName</span>\n              <span class="nc">ChangeType</span> <span class="p">=</span> <span class="nc">Renamed</span>\n              <span class="n">name</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nc">Name</span>\n              <span class="n">path</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nc">FullPath</span> <span class="o">})</span>\n          <span class="n">watcher</span><span class="p">.</span><span class="nc">Changed</span>\n          <span class="p">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">throttle</span> <span class="p">(</span><span class="nn">TimeSpan</span><span class="p">.</span><span class="nc">FromMilliseconds</span><span class="p">(</span><span class="mi">400</span><span class="o">.))</span>\n          <span class="p">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">e</span> <span class="p">-&gt;</span>\n            <span class="p">{</span> <span class="n">oldName</span> <span class="p">=</span> <span class="nc">None</span>\n              <span class="nc">ChangeType</span> <span class="p">=</span> <span class="nc">Changed</span>\n              <span class="n">name</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nc">Name</span>\n              <span class="n">path</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nc">FullPath</span> <span class="o">})</span>\n          <span class="n">watcher</span><span class="p">.</span><span class="nc">Deleted</span>\n          <span class="p">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">throttle</span> <span class="p">(</span><span class="nn">TimeSpan</span><span class="p">.</span><span class="nc">FromMilliseconds</span><span class="p">(</span><span class="mi">400</span><span class="o">.))</span>\n          <span class="p">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">e</span> <span class="p">-&gt;</span>\n            <span class="p">{</span> <span class="n">oldName</span> <span class="p">=</span> <span class="nc">None</span>\n              <span class="nc">ChangeType</span> <span class="p">=</span> <span class="nc">Deleted</span>\n              <span class="n">name</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nc">Name</span>\n              <span class="n">path</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nc">FullPath</span> <span class="o">})</span>\n          <span class="n">watcher</span><span class="p">.</span><span class="nc">Created</span>\n          <span class="p">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">throttle</span> <span class="p">(</span><span class="nn">TimeSpan</span><span class="p">.</span><span class="nc">FromMilliseconds</span><span class="p">(</span><span class="mi">400</span><span class="o">.))</span>\n          <span class="p">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">e</span> <span class="p">-&gt;</span>\n            <span class="p">{</span> <span class="n">oldName</span> <span class="p">=</span> <span class="nc">None</span>\n              <span class="nc">ChangeType</span> <span class="p">=</span> <span class="nc">Created</span>\n              <span class="n">name</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nc">Name</span>\n              <span class="n">path</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nc">FullPath</span> <span class="o">})</span> <span class="p">]</span>\n        <span class="c1">// Merge these observables in a single one</span>\n        <span class="p">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">mergeSeq</span><span class="p">)</span>\n\n    <span class="p">{</span> <span class="k">new</span> <span class="nc">IFileWatcher</span> <span class="k">with</span>\n        <span class="k">override</span> <span class="o">_.</span><span class="nc">Dispose</span><span class="bp">()</span> <span class="p">:</span> <span class="kt">unit</span> <span class="p">=</span>\n          <span class="n">watchers</span>\n          <span class="c1">// when disposing, dispose every watcher you may have around</span>\n          <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">iter</span> <span class="p">(</span><span class="k">fun</span> <span class="n">watcher</span> <span class="p">-&gt;</span> <span class="n">watcher</span><span class="p">.</span><span class="nc">Dispose</span><span class="bp">()</span><span class="p">)</span>\n\n        <span class="k">override</span> <span class="o">_.</span><span class="nc">FileChanged</span><span class="p">:</span> <span class="nc">IObservable</span><span class="p">&lt;</span><span class="nc">FileChangedEvent</span><span class="p">&gt;</span> <span class="p">=</span>\n          <span class="c1">// merge the the merged observables into a single one!!!</span>\n          <span class="nn">Observable</span><span class="p">.</span><span class="n">mergeSeq</span> <span class="n">subs</span> <span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>With this setup you can easily observe changes to multiple directories and multiple extensions it might not be the most efficient way to do it, but It at least got me started with it, now that I had a way to know when something changed I needed to tell the browser what had happened.</p>\n\n<p>For that I chose SSE (Server Sent Events) which is a really cool way to do real time notifications from the server exclusively without having to implement web sockets it\'s just an HTTP call which can be terminated (or not).<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight fsharp"><code>\n  <span class="k">let</span> <span class="k">private</span> <span class="nc">Sse</span> <span class="p">(</span><span class="n">watchConfig</span><span class="p">:</span> <span class="nc">WatchConfig</span><span class="p">)</span> <span class="n">next</span> <span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="nc">HttpContext</span><span class="p">)</span> <span class="p">=</span>\n    <span class="n">task</span> <span class="p">{</span>\n      <span class="k">let</span> <span class="n">logger</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">GetLogger</span><span class="p">(</span><span class="s2">"Perla:SSE"</span><span class="p">)</span>\n      <span class="n">logger</span><span class="p">.</span><span class="nc">LogInformation</span> <span class="o">$</span><span class="s2">"LiveReload Client Connected"</span>\n      <span class="c1">// set up the correct headers</span>\n      <span class="n">ctx</span><span class="p">.</span><span class="nc">SetHttpHeader</span><span class="p">(</span><span class="s2">"Content-Type"</span><span class="p">,</span> <span class="s2">"text/event-stream"</span><span class="p">)</span>\n      <span class="n">ctx</span><span class="p">.</span><span class="nc">SetHttpHeader</span><span class="p">(</span><span class="s2">"Cache-Control"</span><span class="p">,</span> <span class="s2">"no-cache"</span><span class="p">)</span>\n      <span class="n">ctx</span><span class="p">.</span><span class="nc">SetStatusCode</span> <span class="mi">200</span>\n\n      <span class="c1">// send the first event</span>\n      <span class="k">let</span> <span class="n">res</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">Response</span>\n      <span class="k">do</span><span class="o">!</span> <span class="n">res</span><span class="p">.</span><span class="nc">WriteAsync</span><span class="o">($</span><span class="s2">"id:{ctx.Connection.Id}</span><span class="se">\\n</span><span class="s2">data:{DateTime.Now}</span><span class="se">\\n\\n</span><span class="s2">"</span><span class="p">)</span>\n      <span class="k">do</span><span class="o">!</span> <span class="n">res</span><span class="p">.</span><span class="nn">Body</span><span class="p">.</span><span class="nc">FlushAsync</span><span class="bp">()</span>\n\n      <span class="c1">// get the observable of file changes</span>\n      <span class="k">let</span> <span class="n">watcher</span> <span class="p">=</span> <span class="nn">Fs</span><span class="p">.</span><span class="n">getFileWatcher</span> <span class="n">watchConfig</span>\n\n      <span class="n">logger</span><span class="p">.</span><span class="nc">LogInformation</span> <span class="o">$</span><span class="s2">"Watching %A{watchConfig.directories} for changes"</span>\n\n      <span class="k">let</span> <span class="n">onChangeSub</span> <span class="p">=</span>\n        <span class="n">watcher</span><span class="p">.</span><span class="nc">FileChanged</span>\n        <span class="p">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="k">event</span> <span class="p">-&gt;</span>\n          <span class="n">task</span> <span class="p">{</span>\n            <span class="k">match</span> <span class="nn">Path</span><span class="p">.</span><span class="nc">GetExtension</span> <span class="k">event</span><span class="p">.</span><span class="n">name</span> <span class="k">with</span>\n            <span class="p">|</span> <span class="nc">Css</span> <span class="p">-&gt;</span>\n              <span class="c1">// if the change was on a CSS file send the new content</span>\n              <span class="k">let</span><span class="o">!</span> <span class="n">content</span> <span class="p">=</span> <span class="nn">File</span><span class="p">.</span><span class="nc">ReadAllTextAsync</span> <span class="k">event</span><span class="p">.</span><span class="n">path</span>\n\n              <span class="k">let</span> <span class="n">data</span> <span class="p">=</span>\n                <span class="nn">Json</span><span class="p">.</span><span class="nc">ToTextMinified</span><span class="p">(</span>\n                  <span class="o">{|</span> <span class="n">oldName</span> <span class="p">=</span>\n                      <span class="k">event</span><span class="p">.</span><span class="n">oldName</span>\n                      <span class="p">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">value</span> <span class="p">-&gt;</span>\n                        <span class="k">match</span> <span class="n">value</span> <span class="k">with</span>\n                        <span class="p">|</span> <span class="nc">Css</span> <span class="p">-&gt;</span> <span class="n">value</span>\n                        <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="s2">""</span><span class="p">)</span>\n                     <span class="n">name</span> <span class="p">=</span> <span class="k">event</span><span class="p">.</span><span class="n">path</span>\n                     <span class="n">content</span> <span class="p">=</span> <span class="n">content</span> <span class="o">|}</span>\n                <span class="p">)</span>\n              <span class="c1">// CSS HMR was basically free!</span>\n              <span class="k">do</span><span class="o">!</span> <span class="n">res</span><span class="p">.</span><span class="nc">WriteAsync</span> <span class="o">$</span><span class="s2">"event:replace-css</span><span class="se">\\n</span><span class="s2">data:{data}</span><span class="se">\\n\\n</span><span class="s2">"</span>\n              <span class="k">return</span><span class="o">!</span> <span class="n">res</span><span class="p">.</span><span class="nn">Body</span><span class="p">.</span><span class="nc">FlushAsync</span><span class="bp">()</span>\n            <span class="c1">// if it\'s any other file well... just reload</span>\n            <span class="p">|</span> <span class="nc">Typescript</span>\n            <span class="p">|</span> <span class="nc">Javascript</span>\n            <span class="p">|</span> <span class="nc">Jsx</span>\n            <span class="p">|</span> <span class="nc">Json</span>\n            <span class="p">|</span> <span class="nc">Other</span> <span class="p">_</span> <span class="p">-&gt;</span>\n              <span class="k">let</span> <span class="n">data</span> <span class="p">=</span>\n                <span class="nn">Json</span><span class="p">.</span><span class="nc">ToTextMinified</span><span class="p">(</span>\n                  <span class="o">{|</span> <span class="n">oldName</span> <span class="p">=</span> <span class="k">event</span><span class="p">.</span><span class="n">oldName</span>\n                     <span class="n">name</span> <span class="p">=</span> <span class="k">event</span><span class="p">.</span><span class="n">name</span> <span class="o">|}</span>\n                <span class="p">)</span>\n\n              <span class="n">logger</span><span class="p">.</span><span class="nc">LogInformation</span> <span class="o">$</span><span class="s2">"LiveReload File Changed: {event.name}"</span>\n              <span class="k">do</span><span class="o">!</span> <span class="n">res</span><span class="p">.</span><span class="nc">WriteAsync</span> <span class="o">$</span><span class="s2">"event:reload</span><span class="se">\\n</span><span class="s2">data:{data}</span><span class="se">\\n\\n</span><span class="s2">"</span>\n              <span class="k">return</span><span class="o">!</span> <span class="n">res</span><span class="p">.</span><span class="nn">Body</span><span class="p">.</span><span class="nc">FlushAsync</span><span class="bp">()</span>\n          <span class="o">})</span>\n        <span class="c1">// ensure the task gets done</span>\n        <span class="p">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">switchTask</span>\n        <span class="p">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">subscribe</span> <span class="n">ignore</span>\n      <span class="c1">// if the client closes the browser</span>\n      <span class="c1">// then dispose these resources</span>\n      <span class="n">ctx</span><span class="p">.</span><span class="nn">RequestAborted</span><span class="p">.</span><span class="nc">Register</span> <span class="p">(</span><span class="k">fun</span> <span class="p">_</span> <span class="p">-&gt;</span>\n        <span class="n">watcher</span><span class="p">.</span><span class="nc">Dispose</span><span class="bp">()</span>\n        <span class="n">onChangeSub</span><span class="p">.</span><span class="nc">Dispose</span><span class="bp">()</span><span class="p">)</span>\n      <span class="p">|&gt;</span> <span class="n">ignore</span>\n\n      <span class="c1">// keep the connection alive</span>\n      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>\n        <span class="c1">// TBH there must be a better way to do it</span>\n        <span class="c1">// but since this is not critical, it works just fine</span>\n        <span class="k">do</span><span class="o">!</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">Sleep</span><span class="p">(</span><span class="nn">TimeSpan</span><span class="p">.</span><span class="nc">FromSeconds</span> <span class="mi">1</span><span class="o">.)</span>\n\n      <span class="k">return</span><span class="o">!</span> <span class="n">text</span> <span class="s2">""</span> <span class="n">next</span> <span class="n">ctx</span>\n    <span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>At this time, I also <a href="https://dev.to/tunaxor/server-sent-events-with-saturn-and-fsharp-m6b">published about SSE</a> on my blog, I really felt it was a really cool thing and decided to share it with the rest of the world :)</p>\n<h2>\n  <a name="install-dependencies" href="#install-dependencies">\n  </a>\n  Install dependencies\n</h2>\n\n<p>I was really undecided if I wanted to pursue a webpack alernative because</p>\n\n<ul>\n<li>How can you install dependencies without npm?</li>\n<li>Do you really want to do\n\n<ul>\n<li><code>import { useState } from \'https://cdn.skypack.dev/pin/react@v17.0.1-yH0aYV1FOvoIPeKBbHxg/mode=imports,min/optimized/react.js\'</code></li>\n</ul>\n</li>\n</ul>\n\n<p>On every damned file? oh no no no, I don\'t think so... Enter the Import Maps, this feature (along esbuild) was the thing that made me realize it was actually possible to ditch out node/webpack/npm entirely (at least in a local and direct way) instead of doing that ugly import from above, if you can provide a import map with your dependencies the rest should be relatively easy<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight html"><code><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"importmap"</span><span class="nt">&gt;</span>\n  <span class="p">{</span>\n    <span class="dl">"</span><span class="s2">imports</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>\n      <span class="dl">"</span><span class="s2">moment</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">https://ga.jspm.io/npm:moment@2.29.1/moment.js</span><span class="dl">"</span><span class="p">,</span>\n      <span class="dl">"</span><span class="s2">lodash</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">https://cdn.skypack.dev/lodash</span><span class="dl">"</span>\n    <span class="p">}</span>\n  <span class="p">}</span>\n<span class="nt">&lt;/script&gt;</span>\n<span class="c">&lt;!-- Allows you to do the next  --&gt;</span>\n<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"module"</span><span class="nt">&gt;</span>\n  <span class="k">import</span> <span class="nx">moment</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">moment</span><span class="dl">"</span><span class="p">;</span>\n  <span class="k">import</span> <span class="nx">lodash</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">lodash</span><span class="dl">"</span><span class="p">;</span>\n<span class="nt">&lt;/script&gt;</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<blockquote class="ltag__twitter-tweet" data-url="https://twitter.com/angel_d_munoz/status/1439457103433936897">\n    <div class="ltag__twitter-tweet__media ltag__twitter-tweet__media__two-pics">\n      <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--Q7FakYrf--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://pbs.twimg.com/media/E_n3i0OWYAQ4Wcs.png" alt="unknown tweet media content" loading="lazy">\n    </div>\n\n  <div class="ltag__twitter-tweet__main" data-url="https://twitter.com/angel_d_munoz/status/1439457103433936897">\n    <div class="ltag__twitter-tweet__header">\n      <img class="ltag__twitter-tweet__profile-image" src="https://res.cloudinary.com/practicaldev/image/fetch/s--s15CcGpw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://pbs.twimg.com/profile_images/1427821392662339584/ev-ZMAoV_normal.jpg" alt="Angel Munoz profile image" loading="lazy">\n      <div class="ltag__twitter-tweet__full-name">\n        Angel Munoz\n      </div>\n      <div class="ltag__twitter-tweet__username">\n        @angel_d_munoz\n      </div>\n      <div class="ltag__twitter-tweet__twitter-logo">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--ir1kO05j--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-f95605061196010f91e64806688390eb1a4dbc9e913682e043eb8b1e06ca484f.svg" alt="twitter logo" loading="lazy">\n      </div>\n    </div>\n    <div class="ltag__twitter-tweet__body">\n      Here\'s something towards a node\'less frontend development for <a href="https://twitter.com/hashtag/fsharp">#fsharp</a> with help of <a href="https://twitter.com/skypackjs">@skypackjs</a> <br>The cli tool "installs" a package (i.e. grabs a skypack lookup url) and saves: import map, lock, dependency this import map is added to the index file \n    </div>\n    <div class="ltag__twitter-tweet__date">\n      05:11 AM - 19 Sep 2021\n    </div>\n\n\n    <div class="ltag__twitter-tweet__actions">\n      <a href="https://twitter.com/intent/tweet?in_reply_to=1439457103433936897" class="ltag__twitter-tweet__actions__button">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--fFnoeFxk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-reply-action-238fe0a37991706a6880ed13941c3efd6b371e4aefe288fe8e0db85250708bc4.svg" alt="Twitter reply action" loading="lazy">\n      </a>\n      <a href="https://twitter.com/intent/retweet?tweet_id=1439457103433936897" class="ltag__twitter-tweet__actions__button">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--k6dcrOn8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-retweet-action-632c83532a4e7de573c5c08dbb090ee18b348b13e2793175fea914827bc42046.svg" alt="Twitter retweet action" loading="lazy">\n      </a>\n      <a href="https://twitter.com/intent/like?tweet_id=1439457103433936897" class="ltag__twitter-tweet__actions__button">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--SRQc9lOp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-like-action-1ea89f4b87c7d37465b0eb78d51fcb7fe6c03a089805d7ea014ba71365be5171.svg" alt="Twitter like action" loading="lazy">\n      </a>\n    </div>\n  </div>\n</blockquote>\n \n\n<p>So here I was trying to replicate a version of <code>package.json</code> this ended up implementing the <code>perla.jsonc.lock</code> file which is not precisely a <em>lock</em> file, while the URL\'s there are certainly the pined and production versions of those packages, it\'s in reality the <em><strong>import map</strong></em> in disguise, to get that information though I had to investigate how to do it. Once again I decided to study snowpack since it\'s the only frontend dev tool I know it has this kind of mechanism (remote sources), after some investigation and some PoC\'s I also stumbled upon JSPM\'s recently released <a href="https://generator.jspm.io/">Import Map Generator</a> which is basically what I wanted to do! Skypack, JSPM and Unpkg offer reliable CDN services for production with all of these investigations and gathered knowledge I went to implement fetching dependencies and "<em>installing</em>" them with the dev server tool.<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight fsharp"><code>\n<span class="p">[&lt;</span><span class="nc">RequireQualifiedAccessAttribute</span><span class="p">&gt;]</span>\n<span class="k">module</span> <span class="k">internal</span> <span class="nc">Http</span> <span class="p">=</span>\n  <span class="k">open</span> <span class="nc">Flurl</span>\n  <span class="k">open</span> <span class="nn">Flurl</span><span class="p">.</span><span class="nc">Http</span>\n\n  <span class="p">[&lt;</span><span class="nc">Literal</span><span class="p">&gt;]</span>\n  <span class="k">let</span> <span class="nc">SKYPACK_CDN</span> <span class="p">=</span> <span class="s2">"https://cdn.skypack.dev"</span>\n\n  <span class="p">[&lt;</span><span class="nc">Literal</span><span class="p">&gt;]</span>\n  <span class="k">let</span> <span class="nc">SKYPACK_API</span> <span class="p">=</span> <span class="s2">"https://api.skypack.dev/v1"</span>\n\n  <span class="p">[&lt;</span><span class="nc">Literal</span><span class="p">&gt;]</span>\n  <span class="k">let</span> <span class="nc">JSPM_API</span> <span class="p">=</span> <span class="s2">"https://api.jspm.io/generate"</span>\n\n  <span class="k">let</span> <span class="k">private</span> <span class="n">getSkypackInfo</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">alias</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">=</span>\n    <span class="c1">// FsToolkit.ErrorHandling FTW</span>\n    <span class="n">taskResult</span> <span class="p">{</span>\n      <span class="k">try</span>\n        <span class="k">let</span> <span class="n">info</span> <span class="p">=</span> <span class="o">{|</span> <span class="n">lookUp</span> <span class="p">=</span> <span class="o">$</span><span class="s2">"%s{name}"</span> <span class="o">|}</span>\n        <span class="k">let</span><span class="o">!</span> <span class="n">res</span> <span class="p">=</span> <span class="o">$</span><span class="s2">"{SKYPACK_CDN}/{info.lookUp}"</span><span class="p">.</span><span class="nc">GetAsync</span><span class="bp">()</span>\n\n        <span class="k">if</span> <span class="n">res</span><span class="p">.</span><span class="nc">StatusCode</span> <span class="o">&gt;=</span> <span class="mi">400</span> <span class="k">then</span>\n          <span class="k">return</span><span class="o">!</span> <span class="nc">PackageNotFoundException</span> <span class="p">|&gt;</span> <span class="nc">Error</span>\n\n        <span class="k">let</span> <span class="k">mutable</span> <span class="n">pinnedUrl</span> <span class="p">=</span> <span class="s2">""</span>\n        <span class="k">let</span> <span class="k">mutable</span> <span class="n">importUrl</span> <span class="p">=</span> <span class="s2">""</span>\n        <span class="c1">// try to get the pinned URL from the headers</span>\n        <span class="k">let</span> <span class="n">info</span> <span class="p">=</span>\n          <span class="k">if</span>\n            <span class="n">res</span><span class="p">.</span><span class="nn">Headers</span><span class="p">.</span><span class="nc">TryGetFirst</span><span class="p">(</span><span class="s2">"x-pinned-url"</span><span class="p">,</span> <span class="p">&amp;</span><span class="n">pinnedUrl</span><span class="p">)</span>\n            <span class="p">|&gt;</span> <span class="k">not</span>\n          <span class="k">then</span>\n            <span class="o">{|</span> <span class="n">info</span> <span class="k">with</span> <span class="n">pin</span> <span class="p">=</span> <span class="nc">None</span> <span class="o">|}</span>\n          <span class="k">else</span>\n            <span class="o">{|</span> <span class="n">info</span> <span class="k">with</span> <span class="n">pin</span> <span class="p">=</span> <span class="nc">Some</span> <span class="n">pinnedUrl</span> <span class="o">|}</span>\n\n        <span class="c1">// and the imports as well</span>\n        <span class="k">let</span> <span class="n">info</span> <span class="p">=</span>\n          <span class="k">if</span>\n            <span class="n">res</span><span class="p">.</span><span class="nn">Headers</span><span class="p">.</span><span class="nc">TryGetFirst</span><span class="p">(</span><span class="s2">"x-import-url"</span><span class="p">,</span> <span class="p">&amp;</span><span class="n">importUrl</span><span class="p">)</span>\n            <span class="p">|&gt;</span> <span class="k">not</span>\n          <span class="k">then</span>\n            <span class="o">{|</span> <span class="n">info</span> <span class="k">with</span> <span class="n">import</span> <span class="p">=</span> <span class="nc">None</span> <span class="o">|}</span>\n          <span class="k">else</span>\n            <span class="o">{|</span> <span class="n">info</span> <span class="k">with</span> <span class="n">import</span> <span class="p">=</span> <span class="nc">Some</span> <span class="n">importUrl</span> <span class="o">|}</span>\n\n        <span class="k">return</span>\n          <span class="c1">// generate the corresponding import map entry</span>\n          <span class="p">[</span> <span class="n">alias</span><span class="p">,</span> <span class="o">$</span><span class="s2">"{SKYPACK_CDN}{info.pin |&gt; Option.defaultValue info.lookUp}"</span> <span class="o">],</span>\n          <span class="c1">// skypack doesn\'t handle any import maps so the scopes will always be empty</span>\n          <span class="bp">[]</span>\n      <span class="k">with</span>\n      <span class="p">|</span> <span class="o">:?</span> <span class="nn">Flurl</span><span class="p">.</span><span class="nn">Http</span><span class="p">.</span><span class="nc">FlurlHttpException</span> <span class="k">as</span> <span class="n">ex</span> <span class="p">-&gt;</span>\n        <span class="k">match</span> <span class="n">ex</span><span class="p">.</span><span class="nc">StatusCode</span> <span class="p">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">ofNullable</span> <span class="k">with</span>\n        <span class="p">|</span> <span class="nc">Some</span> <span class="n">code</span> <span class="k">when</span> <span class="n">code</span> <span class="o">&gt;=</span> <span class="mi">400</span> <span class="p">-&gt;</span>\n          <span class="k">return</span><span class="o">!</span> <span class="nc">PackageNotFoundException</span> <span class="p">|&gt;</span> <span class="nc">Error</span>\n        <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="bp">()</span>\n\n        <span class="k">return</span><span class="o">!</span> <span class="n">ex</span> <span class="p">:&gt;</span> <span class="nc">Exception</span> <span class="p">|&gt;</span> <span class="nc">Error</span>\n      <span class="p">|</span> <span class="n">ex</span> <span class="p">-&gt;</span> <span class="k">return</span><span class="o">!</span> <span class="n">ex</span> <span class="p">|&gt;</span> <span class="nc">Error</span>\n    <span class="p">}</span>\n\n  <span class="k">let</span> <span class="n">getJspmInfo</span> <span class="n">name</span> <span class="n">alias</span> <span class="n">source</span> <span class="p">=</span>\n    <span class="n">taskResult</span> <span class="p">{</span>\n      <span class="k">let</span> <span class="n">queryParams</span> <span class="p">=</span>\n        <span class="o">{|</span> <span class="n">install</span> <span class="p">=</span> <span class="p">[|</span> <span class="o">$</span><span class="s2">"{name}"</span> <span class="p">|]</span>\n           <span class="n">env</span> <span class="p">=</span> <span class="s2">"browser"</span>\n           <span class="n">provider</span> <span class="p">=</span>\n           <span class="c1">// JSPM offer various reliable sources</span>\n           <span class="c1">// to get your dependencies</span>\n            <span class="k">match</span> <span class="n">source</span> <span class="k">with</span>\n            <span class="p">|</span> <span class="nn">Source</span><span class="p">.</span><span class="nc">Skypack</span> <span class="p">-&gt;</span> <span class="s2">"skypack"</span>\n            <span class="p">|</span> <span class="nn">Source</span><span class="p">.</span><span class="nc">Jspm</span> <span class="p">-&gt;</span> <span class="s2">"jspm"</span>\n            <span class="p">|</span> <span class="nn">Source</span><span class="p">.</span><span class="nc">Jsdelivr</span> <span class="p">-&gt;</span> <span class="s2">"jsdelivr"</span>\n            <span class="p">|</span> <span class="nn">Source</span><span class="p">.</span><span class="nc">Unpkg</span> <span class="p">-&gt;</span> <span class="s2">"unpkg"</span>\n            <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span>\n              <span class="n">printfn</span>\n                <span class="o">$</span><span class="s2">"Warn: An unknown provider has been specied: [{source}] defaulting to jspm"</span>\n\n              <span class="s2">"jspm"</span> <span class="o">|}</span>\n\n      <span class="k">try</span>\n        <span class="k">let</span><span class="o">!</span> <span class="n">res</span> <span class="p">=</span>\n          <span class="nn">JSPM_API</span>\n            <span class="p">.</span><span class="nc">SetQueryParams</span><span class="p">(</span><span class="n">queryParams</span><span class="p">)</span>\n            <span class="p">.</span><span class="nc">GetJsonAsync</span><span class="p">&lt;</span><span class="nc">JspmResponse</span><span class="o">&gt;()</span>\n\n        <span class="k">let</span> <span class="n">scopes</span> <span class="p">=</span>\n          <span class="c1">// F# type serialization hits again!</span>\n          <span class="c1">// the JSPM response may include a scope object or not</span>\n          <span class="c1">// so try to safely check if it exists or not</span>\n          <span class="k">match</span> <span class="n">res</span><span class="p">.</span><span class="n">map</span><span class="p">.</span><span class="n">scopes</span> <span class="p">:&gt;</span> <span class="n">obj</span> <span class="p">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">ofObj</span> <span class="k">with</span>\n          <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">empty</span>\n          <span class="p">|</span> <span class="nc">Some</span> <span class="n">value</span> <span class="p">-&gt;</span> <span class="n">value</span> <span class="o">:?&gt;</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="nc">Scope</span><span class="p">&gt;</span>\n\n        <span class="k">return</span>\n          <span class="c1">// generate the corresponding import map</span>\n          <span class="c1">// entries as well as the scopes</span>\n          <span class="n">res</span><span class="p">.</span><span class="n">map</span><span class="p">.</span><span class="n">imports</span>\n          <span class="p">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">toList</span>\n          <span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">alias</span><span class="p">,</span> <span class="n">v</span><span class="o">),</span>\n          <span class="n">scopes</span> <span class="p">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">toList</span>\n      <span class="k">with</span>\n      <span class="p">|</span> <span class="o">:?</span> <span class="nn">Flurl</span><span class="p">.</span><span class="nn">Http</span><span class="p">.</span><span class="nc">FlurlHttpException</span> <span class="k">as</span> <span class="n">ex</span> <span class="p">-&gt;</span>\n        <span class="k">match</span> <span class="n">ex</span><span class="p">.</span><span class="nc">StatusCode</span> <span class="p">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">ofNullable</span> <span class="k">with</span>\n        <span class="p">|</span> <span class="nc">Some</span> <span class="n">code</span> <span class="k">when</span> <span class="n">code</span> <span class="o">&gt;=</span> <span class="mi">400</span> <span class="p">-&gt;</span>\n          <span class="k">return</span><span class="o">!</span> <span class="nc">PackageNotFoundException</span> <span class="p">|&gt;</span> <span class="nc">Error</span>\n        <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="bp">()</span>\n\n        <span class="k">return</span><span class="o">!</span> <span class="n">ex</span> <span class="p">:&gt;</span> <span class="nc">Exception</span> <span class="p">|&gt;</span> <span class="nc">Error</span>\n    <span class="p">}</span>\n\n  <span class="k">let</span> <span class="n">getPackageUrlInfo</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">alias</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nc">Source</span><span class="p">)</span> <span class="p">=</span>\n    <span class="k">match</span> <span class="n">source</span> <span class="k">with</span>\n    <span class="p">|</span> <span class="nn">Source</span><span class="p">.</span><span class="nc">Skypack</span> <span class="p">-&gt;</span> <span class="n">getSkypackInfo</span> <span class="n">name</span> <span class="n">alias</span>\n    <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="n">getJspmInfo</span> <span class="n">name</span> <span class="n">alias</span> <span class="n">source</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>This was a relatively low effort to implement but it did require finding a way to gather these resources so they can be mapped to json objects. This approach also allows you yo import different version fo the same package in the same application! that can be useful when you want to migrate dependencies slowly rolling them out.</p>\n<h2>\n  <a name="production-bundles" href="#production-bundles">\n  </a>\n  Production Bundles\n</h2>\n\n<p>Just as Installing dependencies, having a production ready build is critical This is where <a href="https://esbuild.github.io/">esbuild</a> finally comes into the picture it is a crucial piece of the puzzle. Esbuild while it\'s written in go and offers a npm package, it provides a single executable binary which can be used in a lot of platforms and and architectures, it distributes itself through the npm registry so it\'s about downloading the package in the correct way and just executing it like we did for the fable command.<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight fsharp"><code><span class="k">let</span> <span class="n">esbuildJsCmd</span> <span class="p">(</span><span class="n">entryPoint</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nc">BuildConfig</span><span class="p">)</span> <span class="p">=</span>\n\n  <span class="k">let</span> <span class="n">dirName</span> <span class="p">=</span>\n    <span class="p">(</span><span class="nn">Path</span><span class="p">.</span><span class="nc">GetDirectoryName</span> <span class="n">entryPoint</span><span class="p">)</span>\n      <span class="p">.</span><span class="nc">Split</span><span class="p">(</span><span class="nn">Path</span><span class="p">.</span><span class="nc">DirectorySeparatorChar</span><span class="p">)</span>\n    <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">last</span>\n\n  <span class="k">let</span> <span class="n">outDir</span> <span class="p">=</span>\n    <span class="k">match</span> <span class="n">config</span><span class="p">.</span><span class="n">outDir</span> <span class="k">with</span>\n    <span class="p">|</span> <span class="nc">Some</span> <span class="n">outdir</span> <span class="p">-&gt;</span> <span class="nn">Path</span><span class="p">.</span><span class="nc">Combine</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">dirName</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="nc">Some</span>\n    <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span> <span class="nn">Path</span><span class="p">.</span><span class="nc">Combine</span><span class="p">(</span><span class="s2">"./dist"</span><span class="p">,</span> <span class="n">dirName</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="nc">Some</span>\n\n  <span class="k">let</span> <span class="n">execBin</span> <span class="p">=</span> <span class="n">defaultArg</span> <span class="n">config</span><span class="p">.</span><span class="n">esBuildPath</span> <span class="n">esbuildExec</span>\n\n  <span class="k">let</span> <span class="n">fileLoaders</span> <span class="p">=</span> <span class="n">getDefaultLoders</span> <span class="n">config</span>\n\n  <span class="nn">Cli</span>\n    <span class="p">.</span><span class="nc">Wrap</span><span class="p">(</span><span class="n">execBin</span><span class="p">)</span>\n    <span class="p">.</span><span class="nc">WithStandardErrorPipe</span><span class="p">(</span><span class="nn">PipeTarget</span><span class="p">.</span><span class="nc">ToStream</span><span class="p">(</span><span class="nn">Console</span><span class="p">.</span><span class="nc">OpenStandardError</span><span class="bp">()</span><span class="o">))</span>\n    <span class="p">.</span><span class="nc">WithStandardOutputPipe</span><span class="p">(</span><span class="nn">PipeTarget</span><span class="p">.</span><span class="nc">ToStream</span><span class="p">(</span><span class="nn">Console</span><span class="p">.</span><span class="nc">OpenStandardOutput</span><span class="bp">()</span><span class="o">))</span>\n    <span class="c1">// CliWrap simply allows us to add arguments to commands very easy</span>\n    <span class="p">.</span><span class="nc">WithArguments</span><span class="p">(</span><span class="k">fun</span> <span class="n">args</span> <span class="p">-&gt;</span>\n      <span class="n">args</span><span class="p">.</span><span class="nc">Add</span><span class="p">(</span><span class="n">entryPoint</span><span class="p">)</span>\n      <span class="p">|&gt;</span> <span class="n">addEsExternals</span> <span class="n">config</span><span class="p">.</span><span class="n">externals</span>\n      <span class="p">|&gt;</span> <span class="n">addIsBundle</span> <span class="n">config</span><span class="p">.</span><span class="n">bundle</span>\n      <span class="p">|&gt;</span> <span class="n">addTarget</span> <span class="n">config</span><span class="p">.</span><span class="n">target</span>\n      <span class="p">|&gt;</span> <span class="n">addDefaultFileLoaders</span> <span class="n">fileLoaders</span>\n      <span class="p">|&gt;</span> <span class="n">addMinify</span> <span class="n">config</span><span class="p">.</span><span class="n">minify</span>\n      <span class="p">|&gt;</span> <span class="n">addFormat</span> <span class="n">config</span><span class="p">.</span><span class="n">format</span>\n      <span class="p">|&gt;</span> <span class="n">addInjects</span> <span class="n">config</span><span class="p">.</span><span class="n">injects</span>\n      <span class="p">|&gt;</span> <span class="n">addOutDir</span> <span class="n">outDir</span>\n      <span class="p">|&gt;</span> <span class="n">ignore</span><span class="p">)</span>\n\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>the CLI API from esbuild is pretty simple to be honest and is really effective when it comes to transpilation the benefits are that it not just transpiles Javascript, it also transpiles typescript, jsx and tsx files. Adding to those features esbuild is blazing fast.</p>\n<h1>\n  <a name="transpilation-on-the-fly" href="#transpilation-on-the-fly">\n  </a>\n  Transpilation on the fly\n</h1>\n\n<p>The dev server not only needs to serve JS content to the browser, often it needs to serve Typescript/JSX/TSX as well, and as we found earlier in the post if you serve static content your options for transforming or manipulating these request are severely limited, so I had to make particular middlewares to enable compiling single files on the fly.<br>\nlet\'s check a little bit how these are somewhat laid out on Perla<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight fsharp"><code><span class="p">[&lt;</span><span class="nc">RequireQualifiedAccess</span><span class="p">&gt;]</span>\n<span class="k">module</span> <span class="nc">Middleware</span> <span class="p">=</span>\n    <span class="c1">// this function helps us determine a particular extension is in the request path</span>\n    <span class="c1">// if it is we  will use one of the middlewares below on the calling site.</span>\n    <span class="k">let</span> <span class="n">transformPredicate</span> <span class="p">(</span><span class="n">extensions</span><span class="p">:</span> <span class="kt">string</span> <span class="kt">list</span><span class="p">)</span> <span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="nc">HttpContext</span><span class="p">)</span> <span class="p">=</span> <span class="o">...</span>\n\n    <span class="k">let</span> <span class="n">cssImport</span>\n        <span class="p">(</span><span class="n">mountedDirs</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="o">&gt;)</span>\n        <span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="nc">HttpContext</span><span class="p">)</span>\n        <span class="p">(</span><span class="n">next</span><span class="p">:</span> <span class="nc">Func</span><span class="p">&lt;</span><span class="nc">Task</span><span class="o">&gt;)</span> <span class="p">=</span> <span class="o">...</span>\n\n    <span class="k">let</span> <span class="n">jsonImport</span>\n        <span class="p">(</span><span class="n">mountedDirs</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="o">&gt;)</span>\n        <span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="nc">HttpContext</span><span class="p">)</span>\n        <span class="p">(</span><span class="n">next</span><span class="p">:</span> <span class="nc">Func</span><span class="p">&lt;</span><span class="nc">Task</span><span class="o">&gt;)</span> <span class="p">=</span> <span class="o">...</span>\n\n    <span class="k">let</span> <span class="n">jsImport</span>\n        <span class="p">(</span><span class="n">buildConfig</span><span class="p">:</span> <span class="nc">BuildConfig</span> <span class="n">option</span><span class="p">)</span>\n        <span class="p">(</span><span class="n">mountedDirs</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="o">&gt;)</span>\n        <span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="nc">HttpContext</span><span class="p">)</span>\n        <span class="p">(</span><span class="n">next</span><span class="p">:</span> <span class="nc">Func</span><span class="p">&lt;</span><span class="nc">Task</span><span class="o">&gt;)</span> <span class="p">=</span>\n        <span class="n">task</span> <span class="p">{</span>\n        <span class="k">let</span> <span class="n">logger</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">GetLogger</span><span class="p">(</span><span class="s2">"Perla Middleware"</span><span class="p">)</span>\n\n        <span class="k">if</span>\n            <span class="c1">// for the moment, we just serve the JS as is and don\'t process it</span>\n            <span class="n">ctx</span><span class="p">.</span><span class="nn">Request</span><span class="p">.</span><span class="nn">Path</span><span class="p">.</span><span class="nn">Value</span><span class="p">.</span><span class="nc">Contains</span><span class="p">(</span><span class="s2">"~perla~"</span><span class="p">)</span>\n            <span class="o">||</span> <span class="n">ctx</span><span class="p">.</span><span class="nn">Request</span><span class="p">.</span><span class="nn">Path</span><span class="p">.</span><span class="nn">Value</span><span class="p">.</span><span class="nc">Contains</span><span class="p">(</span><span class="s2">".js"</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="k">not</span>\n        <span class="k">then</span>\n            <span class="k">return</span><span class="o">!</span> <span class="n">next</span><span class="p">.</span><span class="nc">Invoke</span><span class="bp">()</span>\n        <span class="k">else</span>\n\n            <span class="k">let</span> <span class="n">path</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nn">Request</span><span class="p">.</span><span class="nn">Path</span><span class="p">.</span><span class="nc">Value</span>\n            <span class="n">logger</span><span class="p">.</span><span class="nc">LogInformation</span><span class="o">($</span><span class="s2">"Serving {path}"</span><span class="p">)</span>\n\n            <span class="k">let</span> <span class="n">baseDir</span><span class="p">,</span> <span class="n">baseName</span> <span class="p">=</span>\n                <span class="c1">// check if we\'re actually monitoring this directory and this file extension</span>\n                <span class="n">mountedDirs</span>\n                <span class="p">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="p">_</span> <span class="n">v</span> <span class="p">-&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="nc">IsNullOrWhiteSpace</span> <span class="n">v</span> <span class="p">|&gt;</span> <span class="k">not</span><span class="p">)</span>\n                <span class="p">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">toSeq</span>\n                <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">find</span> <span class="p">(</span><span class="k">fun</span> <span class="o">(_,</span> <span class="n">v</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">path</span><span class="p">.</span><span class="nc">StartsWith</span><span class="p">(</span><span class="n">v</span><span class="o">))</span>\n\n            <span class="c1">// find the file on disk</span>\n            <span class="k">let</span> <span class="n">filePath</span> <span class="p">=</span>\n                <span class="k">let</span> <span class="n">fileName</span> <span class="p">=</span>\n                    <span class="n">path</span><span class="p">.</span><span class="nc">Replace</span><span class="o">($</span><span class="s2">"{baseName}/"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="nn">StringComparison</span><span class="p">.</span><span class="nc">InvariantCulture</span><span class="p">)</span>\n\n                <span class="nn">Path</span><span class="p">.</span><span class="nc">Combine</span><span class="p">(</span><span class="n">baseDir</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>\n            <span class="c1">// we will serve javascript regardless of what we find on disk</span>\n            <span class="n">ctx</span><span class="p">.</span><span class="nc">SetContentType</span> <span class="s2">"text/javascript"</span>\n\n            <span class="k">try</span>\n                <span class="k">if</span> <span class="nn">Path</span><span class="p">.</span><span class="nc">GetExtension</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span> <span class="p">&lt;&gt;</span> <span class="s2">".js"</span> <span class="k">then</span>\n                    <span class="k">return</span> <span class="n">failwith</span> <span class="s2">"Not a JS file, Try looking with another extension."</span>\n                <span class="c1">// if the file exists on disk</span>\n                <span class="c1">// and has a js extension then just send it as is</span>\n                <span class="c1">// the browser should be able to interpret it</span>\n                <span class="k">let</span><span class="o">!</span> <span class="n">content</span> <span class="p">=</span> <span class="nn">File</span><span class="p">.</span><span class="nc">ReadAllBytesAsync</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>\n                <span class="k">do</span><span class="o">!</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">WriteBytesAsync</span> <span class="n">content</span> <span class="p">:&gt;</span> <span class="nc">Task</span>\n            <span class="k">with</span>\n            <span class="p">|</span> <span class="n">ex</span> <span class="p">-&gt;</span>\n                <span class="k">let</span><span class="o">!</span> <span class="n">fileData</span> <span class="p">=</span> <span class="nn">Esbuild</span><span class="p">.</span><span class="n">tryCompileFile</span> <span class="n">filePath</span> <span class="n">buildConfig</span>\n\n                <span class="k">match</span> <span class="n">fileData</span> <span class="k">with</span>\n                <span class="p">|</span> <span class="nc">Ok</span> <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span> <span class="p">-&gt;</span>\n                    <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="nc">IsNullOrWhiteSpace</span> <span class="n">stderr</span> <span class="p">|&gt;</span> <span class="k">not</span> <span class="k">then</span>\n                        <span class="c1">// In the SSE code, we added (later on)</span>\n                        <span class="c1">// an observer for compilation errors and send a message to the client,</span>\n                        <span class="c1">// this should trigger an "overlay" on the client side</span>\n                        <span class="nn">Fs</span><span class="p">.</span><span class="nc">PublishCompileErr</span> <span class="n">stderr</span>\n                        <span class="k">do</span><span class="o">!</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">WriteBytesAsync</span> <span class="o">[||]</span> <span class="p">:&gt;</span> <span class="nc">Task</span>\n                    <span class="k">else</span>\n                        <span class="c1">// if the file got compiled then just write the file to the body</span>\n                        <span class="c1">// of the request</span>\n                        <span class="k">let</span> <span class="n">content</span> <span class="p">=</span> <span class="nn">Encoding</span><span class="p">.</span><span class="nn">UTF8</span><span class="p">.</span><span class="nc">GetBytes</span> <span class="n">stdout</span>\n                        <span class="k">do</span><span class="o">!</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">WriteBytesAsync</span> <span class="n">content</span> <span class="p">:&gt;</span> <span class="nc">Task</span>\n                <span class="p">|</span> <span class="nc">Error</span> <span class="n">err</span> <span class="p">-&gt;</span>\n                    <span class="c1">// anything else, just send a 500</span>\n                    <span class="n">ctx</span><span class="p">.</span><span class="nc">SetStatusCode</span> <span class="mi">500</span>\n                    <span class="k">do</span><span class="o">!</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">WriteTextAsync</span> <span class="n">err</span><span class="p">.</span><span class="nc">Message</span> <span class="p">:&gt;</span> <span class="nc">Task</span>\n        <span class="p">}</span>\n        <span class="p">:&gt;</span> <span class="nc">Task</span>\n\n    <span class="k">let</span> <span class="n">configureTransformMiddleware</span>\n        <span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nc">FdsConfig</span><span class="p">)</span>\n        <span class="p">(</span><span class="n">appConfig</span><span class="p">:</span> <span class="nc">IApplicationBuilder</span><span class="p">)</span> <span class="p">=</span>\n        <span class="k">let</span> <span class="n">serverConfig</span> <span class="p">=</span>\n            <span class="n">defaultArg</span> <span class="n">config</span><span class="p">.</span><span class="n">devServer</span> <span class="p">(</span><span class="nn">DevServerConfig</span><span class="p">.</span><span class="nc">DefaultConfig</span><span class="bp">()</span><span class="p">)</span>\n\n        <span class="k">let</span> <span class="n">mountedDirs</span> <span class="p">=</span> <span class="n">defaultArg</span> <span class="n">serverConfig</span><span class="p">.</span><span class="n">mountDirectories</span> <span class="nn">Map</span><span class="p">.</span><span class="n">empty</span>\n\n        <span class="n">appConfig</span>\n            <span class="p">.</span><span class="nc">Use</span><span class="p">(</span><span class="nc">Func</span><span class="p">&lt;</span><span class="nc">HttpContext</span><span class="p">,</span> <span class="nc">Func</span><span class="p">&lt;</span><span class="nc">Task</span><span class="o">&gt;,</span> <span class="nc">Task</span><span class="o">&gt;(</span><span class="n">jsonImport</span> <span class="n">mountedDirs</span><span class="o">))</span>\n            <span class="p">.</span><span class="nc">Use</span><span class="p">(</span><span class="nc">Func</span><span class="p">&lt;</span><span class="nc">HttpContext</span><span class="p">,</span> <span class="nc">Func</span><span class="p">&lt;</span><span class="nc">Task</span><span class="o">&gt;,</span> <span class="nc">Task</span><span class="o">&gt;(</span><span class="n">cssImport</span> <span class="n">mountedDirs</span><span class="o">))</span>\n            <span class="p">.</span><span class="nc">Use</span><span class="p">(</span>\n                <span class="nc">Func</span><span class="p">&lt;</span><span class="nc">HttpContext</span><span class="p">,</span> <span class="nc">Func</span><span class="p">&lt;</span><span class="nc">Task</span><span class="o">&gt;,</span> <span class="nc">Task</span><span class="o">&gt;(</span><span class="n">jsImport</span> <span class="n">config</span><span class="p">.</span><span class="n">build</span> <span class="n">mountedDirs</span><span class="p">)</span>\n            <span class="p">)</span>\n            <span class="p">|&gt;</span> <span class="n">ignore</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>It is a pretty simple module (I want to think) that only has some functions that deal with the content of the files and return any compiled result if neededm otherwise just send the file.</p>\n\n<p>Now... Let\'s take a look at the magic behind <code>let! fileData = Esbuild.tryCompileFile filePath buildConfig</code> to be honest I didn\'t really know what I was doing, the main line of thought was just to try and find the content on disk and try the next extension if it didn\'t work. Hah! well <a href="https://res.cloudinary.com/practicaldev/image/fetch/s--QddMIzt5--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://th.bing.com/th/id/OIP.XBALsTMB2KdavcvdRAlpuwHaFD%3Fpid%3DImgDet%26rs%3D1" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--QddMIzt5--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://th.bing.com/th/id/OIP.XBALsTMB2KdavcvdRAlpuwHaFD%3Fpid%3DImgDet%26rs%3D1" alt="as long as it works" loading="lazy" width="474" height="323"></a><br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight fsharp"><code><span class="k">let</span> <span class="n">tryCompileFile</span> <span class="n">filepath</span> <span class="n">config</span> <span class="p">=</span>\n  <span class="n">taskResult</span> <span class="p">{</span>\n    <span class="k">let</span> <span class="n">config</span> <span class="p">=</span> <span class="p">(</span><span class="n">defaultArg</span> <span class="n">config</span> <span class="p">(</span><span class="nn">BuildConfig</span><span class="p">.</span><span class="nc">DefaultConfig</span><span class="bp">()</span><span class="o">))</span>\n    <span class="c1">// since we\'re using</span>\n    <span class="c1">// FsToolkit.ErrorHandling if the operation fails it will</span>\n    <span class="c1">// "early return" meaning it won\'t continue the success path</span>\n    <span class="k">let</span><span class="o">!</span> <span class="n">res</span> <span class="p">=</span> <span class="nn">Fs</span><span class="p">.</span><span class="n">tryReadFile</span> <span class="n">filepath</span>\n    <span class="k">let</span> <span class="n">strout</span> <span class="p">=</span> <span class="nc">StringBuilder</span><span class="bp">()</span>\n    <span class="k">let</span> <span class="n">strerr</span> <span class="p">=</span> <span class="nc">StringBuilder</span><span class="bp">()</span>\n    <span class="k">let</span> <span class="o">(_,</span> <span class="n">loader</span><span class="p">)</span> <span class="p">=</span> <span class="n">res</span>\n\n    <span class="k">let</span> <span class="n">cmd</span> <span class="p">=</span> <span class="n">buildSingleFileCmd</span> <span class="n">config</span> <span class="p">(</span><span class="n">strout</span><span class="p">,</span> <span class="n">strerr</span><span class="p">)</span> <span class="n">res</span>\n    <span class="c1">// execute esbuild on the file</span>\n    <span class="k">do</span><span class="o">!</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="nc">ExecuteAsync</span><span class="bp">()</span><span class="o">).</span><span class="nc">Task</span> <span class="p">:&gt;</span> <span class="nc">Task</span>\n\n    <span class="k">let</span> <span class="n">strout</span> <span class="p">=</span> <span class="n">strout</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span>\n    <span class="k">let</span> <span class="n">strerr</span> <span class="p">=</span> <span class="n">strerr</span><span class="p">.</span><span class="nc">ToString</span><span class="bp">()</span>\n\n    <span class="k">let</span> <span class="n">strout</span> <span class="p">=</span>\n      <span class="k">match</span> <span class="n">loader</span> <span class="k">with</span>\n      <span class="p">|</span> <span class="nc">Jsx</span>\n      <span class="p">|</span> <span class="nc">Tsx</span> <span class="p">-&gt;</span>\n        <span class="k">try</span>\n          <span class="c1">// if the file needs injects (e.g automatic "import React from \'react\'" in JSX files)</span>\n          <span class="k">let</span> <span class="n">injects</span> <span class="p">=</span>\n            <span class="n">defaultArg</span> <span class="n">config</span><span class="p">.</span><span class="n">injects</span> <span class="p">(</span><span class="nn">Seq</span><span class="p">.</span><span class="n">empty</span><span class="p">)</span>\n            <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="nn">File</span><span class="p">.</span><span class="nc">ReadAllText</span>\n\n          <span class="c1">// add those right here</span>\n          <span class="k">let</span> <span class="n">injects</span> <span class="p">=</span> <span class="nn">String</span><span class="p">.</span><span class="nc">Join</span><span class="p">(</span><span class="sc">\'\\n\'</span><span class="p">,</span> <span class="n">injects</span><span class="p">)</span>\n          <span class="o">$</span><span class="s2">"{injects}</span><span class="se">\\n</span><span class="s2">{strout}"</span>\n        <span class="k">with</span>\n        <span class="p">|</span> <span class="n">ex</span> <span class="p">-&gt;</span>\n          <span class="n">printfn</span> <span class="o">$</span><span class="s2">"Perla Serve: failed to inject, {ex.Message}"</span>\n          <span class="n">strout</span>\n      <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="n">strout</span>\n    <span class="c1">// return the compilation results</span>\n    <span class="c1">// the transpiled output and the error if any</span>\n    <span class="k">return</span> <span class="p">(</span><span class="n">strout</span><span class="p">,</span> <span class="n">strerr</span><span class="p">)</span>\n  <span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>Surely thats a lot of things to do for a single file, I\'m sure it must be quite slow right? Well... It turns out that <strong>.NET</strong> and <strong>Go</strong> are quite quite feaking fast</p>\n\n\n<blockquote class="ltag__twitter-tweet" data-url="https://twitter.com/angel_d_munoz/status/1444508310393212934">\n      <div class="ltag__twitter-tweet__media">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--VvhW-jDa--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://pbs.twimg.com/media/FAvrtN5X0AABTQ8.png" alt="unknown tweet media content" loading="lazy">\n      </div>\n\n  <div class="ltag__twitter-tweet__main" data-url="https://twitter.com/angel_d_munoz/status/1444508310393212934">\n    <div class="ltag__twitter-tweet__header">\n      <img class="ltag__twitter-tweet__profile-image" src="https://res.cloudinary.com/practicaldev/image/fetch/s--s15CcGpw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://pbs.twimg.com/profile_images/1427821392662339584/ev-ZMAoV_normal.jpg" alt="Angel Munoz profile image" loading="lazy">\n      <div class="ltag__twitter-tweet__full-name">\n        Angel Munoz\n      </div>\n      <div class="ltag__twitter-tweet__username">\n        @angel_d_munoz\n      </div>\n      <div class="ltag__twitter-tweet__twitter-logo">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--ir1kO05j--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-f95605061196010f91e64806688390eb1a4dbc9e913682e043eb8b1e06ca484f.svg" alt="twitter logo" loading="lazy">\n      </div>\n    </div>\n    <div class="ltag__twitter-tweet__body">\n      .NET6 is really fast even for my not optimized sloppy <a href="https://twitter.com/hashtag/fsharp">#fsharp</a> code<br>I\'m doing a bunch of IO/async operations without peformance in mind plus my weird mental logic and yet both esbuild transform + middleware stuff  + IO + tasks<br>and yet each request takes between 10-20ms \n    </div>\n    <div class="ltag__twitter-tweet__date">\n      03:43 AM - 03 Oct 2021\n    </div>\n\n\n    <div class="ltag__twitter-tweet__actions">\n      <a href="https://twitter.com/intent/tweet?in_reply_to=1444508310393212934" class="ltag__twitter-tweet__actions__button">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--fFnoeFxk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-reply-action-238fe0a37991706a6880ed13941c3efd6b371e4aefe288fe8e0db85250708bc4.svg" alt="Twitter reply action" loading="lazy">\n      </a>\n      <a href="https://twitter.com/intent/retweet?tweet_id=1444508310393212934" class="ltag__twitter-tweet__actions__button">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--k6dcrOn8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-retweet-action-632c83532a4e7de573c5c08dbb090ee18b348b13e2793175fea914827bc42046.svg" alt="Twitter retweet action" loading="lazy">\n      </a>\n      <a href="https://twitter.com/intent/like?tweet_id=1444508310393212934" class="ltag__twitter-tweet__actions__button">\n        <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--SRQc9lOp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/twitter-like-action-1ea89f4b87c7d37465b0eb78d51fcb7fe6c03a089805d7ea014ba71365be5171.svg" alt="Twitter like action" loading="lazy">\n      </a>\n    </div>\n  </div>\n</blockquote>\n \n\n<p>each request takes around 10-20ms and I\'m pretty sure it can be improved once the phase of heavy development settles down and the code base stabilizes a little bit more.</p>\n<h2>\n  <a name="dev-proxy" href="#dev-proxy">\n  </a>\n  Dev Proxy\n</h2>\n\n<p>This one is pretty new, a dev proxy is somewhat necessary specially when you will host your applications on your own server so you are very likely to have URLs like <code>/api/my-endpoint</code> rather than <code>http://my-api.com/api/my-endpoint</code> it also helps you target different environments with a single configuration change, in this case it was not really complex thanks to <a href="https://twitter.com/Yaurthek">@Yaurthek</a> who hinted at me one <a href="https://microsoft.github.io/reverse-proxy/articles/direct-forwarding.html">Yarp</a> implementation of a dev proxy, so I ended up basing my work on that.</p>\n\n<p>The whole idea here is to read a json file with some <code>origin -&gt; target</code> mappings and then just adding a proxy to the server application.<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight fsharp"><code>\n  <span class="k">let</span> <span class="k">private</span> <span class="n">getHttpClientAndForwarder</span> <span class="bp">()</span> <span class="p">=</span>\n    <span class="c1">// this socket handler is actually disposable</span>\n    <span class="c1">// but since technically I will only use one in the whole application</span>\n    <span class="c1">// I won\'t need to dispose it</span>\n    <span class="k">let</span> <span class="n">socketsHandler</span> <span class="p">=</span> <span class="k">new</span> <span class="nc">SocketsHttpHandler</span><span class="bp">()</span>\n    <span class="n">socketsHandler</span><span class="p">.</span><span class="nc">UseProxy</span> <span class="p">&lt;-</span> <span class="bp">false</span>\n    <span class="n">socketsHandler</span><span class="p">.</span><span class="nc">AllowAutoRedirect</span> <span class="p">&lt;-</span> <span class="bp">false</span>\n    <span class="n">socketsHandler</span><span class="p">.</span><span class="nc">AutomaticDecompression</span> <span class="p">&lt;-</span> <span class="nn">DecompressionMethods</span><span class="p">.</span><span class="nc">None</span>\n    <span class="n">socketsHandler</span><span class="p">.</span><span class="nc">UseCookies</span> <span class="p">&lt;-</span> <span class="bp">false</span>\n    <span class="k">let</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nc">HttpMessageInvoker</span><span class="p">(</span><span class="n">socketsHandler</span><span class="p">)</span>\n    <span class="k">let</span> <span class="n">reqConfig</span> <span class="p">=</span> <span class="nc">ForwarderRequestConfig</span><span class="bp">()</span>\n    <span class="n">reqConfig</span><span class="p">.</span><span class="nc">ActivityTimeout</span> <span class="p">&lt;-</span> <span class="nn">TimeSpan</span><span class="p">.</span><span class="nc">FromSeconds</span><span class="p">(</span><span class="mi">100</span><span class="o">.)</span>\n    <span class="n">client</span><span class="p">,</span> <span class="n">reqConfig</span>\n\n  <span class="k">let</span> <span class="k">private</span> <span class="n">getProxyHandler</span>\n    <span class="p">(</span><span class="n">target</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span>\n    <span class="p">(</span><span class="n">httpClient</span><span class="p">:</span> <span class="nc">HttpMessageInvoker</span><span class="p">)</span>\n    <span class="p">(</span><span class="n">forwardConfig</span><span class="p">:</span> <span class="nc">ForwarderRequestConfig</span><span class="p">)</span>\n    <span class="p">:</span> <span class="nc">Func</span><span class="p">&lt;</span><span class="nc">HttpContext</span><span class="p">,</span> <span class="nc">IHttpForwarder</span><span class="p">,</span> <span class="nc">Task</span><span class="p">&gt;</span> <span class="p">=</span>\n    <span class="c1">// this is actually using .NET6 Minimal API\'s from asp.net!</span>\n    <span class="k">let</span> <span class="n">toFunc</span> <span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="nc">HttpContext</span><span class="p">)</span> <span class="p">(</span><span class="n">forwarder</span><span class="p">:</span> <span class="nc">IHttpForwarder</span><span class="p">)</span> <span class="p">=</span>\n      <span class="n">task</span> <span class="p">{</span>\n        <span class="k">let</span> <span class="n">logger</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">GetLogger</span><span class="p">(</span><span class="s2">"Perla Proxy"</span><span class="p">)</span>\n        <span class="k">let</span><span class="o">!</span> <span class="n">error</span> <span class="p">=</span> <span class="n">forwarder</span><span class="p">.</span><span class="nc">SendAsync</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">httpClient</span><span class="p">,</span> <span class="n">forwardConfig</span><span class="p">)</span>\n\n        <span class="c1">// report the errors to the log as a warning</span>\n        <span class="c1">// since we don\'t need to die if a request fails</span>\n        <span class="k">if</span> <span class="n">error</span> <span class="p">&lt;&gt;</span> <span class="nn">ForwarderError</span><span class="p">.</span><span class="nc">None</span> <span class="k">then</span>\n          <span class="k">let</span> <span class="n">errorFeat</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">GetForwarderErrorFeature</span><span class="bp">()</span>\n          <span class="k">let</span> <span class="n">ex</span> <span class="p">=</span> <span class="n">errorFeat</span><span class="p">.</span><span class="nc">Exception</span>\n          <span class="n">logger</span><span class="p">.</span><span class="nc">LogWarning</span><span class="o">($</span><span class="s2">"{ex.Message}"</span><span class="p">)</span>\n      <span class="p">}</span>\n      <span class="p">:&gt;</span> <span class="nc">Task</span>\n    <span class="nc">Func</span><span class="p">&lt;</span><span class="nc">HttpContext</span><span class="p">,</span> <span class="nc">IHttpForwarder</span><span class="p">,</span> <span class="nc">Task</span><span class="o">&gt;(</span><span class="n">toFunc</span><span class="p">)</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>And then somewher inside the aspnet application configuration<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight fsharp"><code><span class="k">match</span> <span class="n">getProxyConfig</span> <span class="k">with</span>\n<span class="p">|</span> <span class="nc">Some</span> <span class="n">proxyConfig</span> <span class="p">-&gt;</span>\n    <span class="n">appConfig</span>\n    <span class="p">.</span><span class="nc">UseRouting</span><span class="bp">()</span>\n    <span class="p">.</span><span class="nc">UseEndpoints</span><span class="p">(</span><span class="k">fun</span> <span class="n">endpoints</span> <span class="p">-&gt;</span>\n        <span class="k">let</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reqConfig</span><span class="p">)</span> <span class="p">=</span> <span class="n">getHttpClientAndForwarder</span> <span class="bp">()</span>\n        <span class="c1">// for each mapping add the url add an endpoint</span>\n        <span class="k">for</span> <span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="k">in</span> <span class="n">proxyConfig</span> <span class="p">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">toSeq</span> <span class="k">do</span>\n            <span class="k">let</span> <span class="n">handler</span> <span class="p">=</span> <span class="n">getProxyHandler</span> <span class="n">target</span> <span class="n">client</span> <span class="n">reqConfig</span>\n            <span class="n">endpoints</span><span class="p">.</span><span class="nc">Map</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="n">ignore</span><span class="p">)</span>\n<span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span> <span class="n">appConfig</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>That\'s it! At least on my initial testing it seems to work fine, I would need to have some feedback on the feature to know if this is actually working for more complex use cases.</p>\n<h2>\n  <a name="future-and-experimental-things" href="#future-and-experimental-things">\n  </a>\n  Future and Experimental things\n</h2>\n\n<p>What you have seen so far (and some other minor features) are already inside Perla, they are working and they try to provide you a seamless experience for building Single Page Applications however there are still missing pieces for a complete experience. For example Perla doesn\'t support Sass or Less at the moment and Sass is a pretty common way to write styles on big frontend projects, we are not able to parse out <code>.Vue</code> files or anything else that is not HTML/CSS/JS/TS/JSX/TSX, We do support HMR for CSS files since that is not a complex mechanism but, HMR for JS/TS/JSX/TSX files is not there yet sady. Fear not that We\'re looking for a way to provide these at some point in time.</p>\n<h2>\n  <a name="plugins" href="#plugins">\n  </a>\n  Plugins\n</h2>\n\n<p>I\'m a fan of <code>.fsx</code> files, F# scripts are pretty flexible and since F# 5.0 they are even more powerful than ever allowing you to pull dependencies directly from NuGet without any extra command.</p>\n\n<p>The main goal for the author and user experiences is somewhat like this</p>\n\n<p>As an Author:</p>\n\n<ul>\n<li>Write an <code>.fsx</code> script</li>\n<li>Upload it to gist/github</li>\n<li>Profit</li>\n</ul>\n\n<p>As a User:</p>\n\n<ul>\n<li>Add an entry yo tour "plugins" section</li>\n<li>Profit</li>\n</ul>\n\n<p>Implementation details are more complex though...</p>\n\n<p>My vision is somewhere along the following lines</p>\n\n<ul>\n<li>get a request for a different file e.g. sass files</li>\n<li>if the file is not part of the default supported extensions\n\n<ul>\n<li>Call a function that will parse the content of that file</li>\n<li>get the transpiled content or the compilation error (just like we saw above with the js middleware)</li>\n<li>return the valid HTML/CSS/JS content to the browser</li>\n</ul>\n</li>\n</ul>\n\n<p>To get there I want to leverage the [FSharp.Compiler.Services] NuGet Package to start an F# interactive session that runs over the life of the server,</p>\n\n<ul>\n<li>Start the server, also if there are plugins in the plugin section, start the fsi session.</li>\n<li>load the plugins, download them to a known location in disk, or even just get the strings without downloading the file to disk</li>\n<li>execute the contents on the fsi session and grab a particular set of functions\n\n<ul>\n<li>These functions can be part of a life cycle which may possible be something like</li>\n<li>on load // when HMR is enabled</li>\n<li>on change // when HMR is enabled</li>\n<li>on transform // when the file is requested</li>\n<li>on build // when the production build is executed</li>\n</ul>\n</li>\n<li>call the functions in the plugins section whenever needed</li>\n</ul>\n\n<p>Starting an FSI session is not a complex task let\'s take a look.</p>\n\n<p>let\'s say we have the following script:<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight fsharp"><code><span class="p">#</span><span class="n">r</span> <span class="s2">"nuget: LibSassHost, 1.3.3"</span>\n<span class="p">#</span><span class="n">r</span> <span class="s2">"nuget: LibSassHost.Native.linux-x64, 1.3.3"</span>\n\n<span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">IO</span>\n<span class="k">open</span> <span class="nc">LibSassHost</span>\n\n<span class="k">let</span> <span class="n">compileSassFile</span> <span class="p">=</span>\n  <span class="k">let</span> <span class="p">_</span><span class="n">compileSassFile</span> <span class="p">(</span><span class="n">filePath</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">=</span>\n    <span class="k">let</span> <span class="n">filename</span> <span class="p">=</span> <span class="nn">Path</span><span class="p">.</span><span class="nc">GetFileName</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>\n    <span class="k">let</span> <span class="n">result</span> <span class="p">=</span> <span class="nn">SassCompiler</span><span class="p">.</span><span class="nc">Compile</span><span class="p">(</span><span class="nn">File</span><span class="p">.</span><span class="nc">ReadAllText</span><span class="p">(</span><span class="n">filePath</span><span class="o">))</span>\n    <span class="p">[|</span><span class="n">filename</span><span class="p">;</span> <span class="n">result</span><span class="p">.</span><span class="nc">CompiledContent</span> <span class="p">|]</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>In this file we\'re able to provide a function that when given a file path, it will try to compile a <code>.scss</code> file into it\'s <code>.css</code> equivalent, to be able to execute that in Perla, we need a module that does somewhat like this:<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight fsharp"><code><span class="p">#</span><span class="n">r</span> <span class="s2">"nuget: FSharp.Compiler.Service, 41.0.1"</span>\n\n<span class="k">open</span> <span class="nc">System</span>\n<span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">IO</span>\n<span class="k">open</span> <span class="nn">FSharp</span><span class="p">.</span><span class="nn">Compiler</span><span class="p">.</span><span class="nn">Interactive</span><span class="p">.</span><span class="nc">Shell</span>\n\n<span class="k">module</span> <span class="nc">ScriptedContent</span> <span class="p">=</span>\n\n    <span class="k">let</span> <span class="n">tryGetSassPluginFunction</span> <span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="kt">string</span><span class="o">):</span> <span class="p">(</span><span class="kt">string</span> <span class="p">-&gt;</span> <span class="kt">string</span><span class="p">)</span> <span class="n">option</span> <span class="p">=</span>\n        <span class="k">let</span> <span class="n">defConfig</span> <span class="p">=</span>\n            <span class="nn">FsiEvaluationSession</span><span class="p">.</span><span class="nc">GetDefaultConfiguration</span><span class="bp">()</span>\n\n        <span class="k">let</span> <span class="n">argv</span> <span class="p">=</span>\n            <span class="p">[|</span> <span class="s2">"fsi.exe"</span>\n               <span class="s2">"--noninteractive"</span>\n               <span class="s2">"--nologo"</span>\n               <span class="s2">"--gui-"</span> <span class="p">|]</span>\n\n        <span class="k">use</span> <span class="n">stdIn</span> <span class="p">=</span> <span class="k">new</span> <span class="nc">StringReader</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>\n        <span class="k">use</span> <span class="n">stdOut</span> <span class="p">=</span> <span class="k">new</span> <span class="nc">StringWriter</span><span class="bp">()</span>\n        <span class="k">use</span> <span class="n">stdErr</span> <span class="p">=</span> <span class="k">new</span> <span class="nc">StringWriter</span><span class="bp">()</span>\n\n        <span class="k">use</span> <span class="n">session</span> <span class="p">=</span>\n            <span class="nn">FsiEvaluationSession</span><span class="p">.</span><span class="nc">Create</span><span class="p">(</span><span class="n">defConfig</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">stdIn</span><span class="p">,</span> <span class="n">stdOut</span><span class="p">,</span> <span class="n">stdErr</span><span class="p">,</span> <span class="bp">true</span><span class="p">)</span>\n        <span class="n">session</span><span class="p">.</span><span class="nc">EvalInteractionNonThrowing</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="n">ignore</span>\n\n        <span class="k">match</span> <span class="n">session</span><span class="p">.</span><span class="nc">TryFindBoundValue</span> <span class="s2">"compileSassFile"</span> <span class="k">with</span>\n        <span class="p">|</span> <span class="nc">Some</span> <span class="n">bound</span> <span class="p">-&gt;</span>\n            <span class="c1">// If there\'s a value with that name on the script try to grab it</span>\n            <span class="k">match</span> <span class="n">bound</span><span class="p">.</span><span class="nn">Value</span><span class="p">.</span><span class="nc">ReflectionValue</span> <span class="k">with</span>\n            <span class="c1">// ensure it fits the signature we are expecting</span>\n            <span class="p">|</span> <span class="o">:?</span> <span class="nc">FSharpFunc</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span> <span class="k">as</span> <span class="n">compileSassFile</span> <span class="p">-&gt;</span>\n              <span class="nc">Some</span> <span class="n">compileSassFile</span>\n            <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="nc">None</span>\n        <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span> <span class="nc">None</span>\n\n<span class="k">let</span> <span class="n">content</span> <span class="p">=</span> <span class="nn">File</span><span class="p">.</span><span class="nc">ReadAllText</span><span class="p">(</span><span class="s2">"./path/to/sass-plugin.fsx"</span><span class="p">)</span>\n<span class="c1">// this is where it get\'s nice, we can also fetch the scritps from the cloud</span>\n<span class="c1">// let! content = Http.getFromGithub("AngelMunoz/Perla.Sass")</span>\n<span class="k">match</span> <span class="nn">ScriptedContent</span><span class="p">.</span><span class="n">tryGetSassPluginFunction</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="k">with</span>\n<span class="p">|</span> <span class="nc">Some</span> <span class="n">plugin</span> <span class="p">-&gt;</span>\n  <span class="k">let</span> <span class="n">css</span> <span class="p">=</span> <span class="n">plugin</span> <span class="s2">"./path/to/file.scss"</span>\n  <span class="n">printfn</span> <span class="o">$</span><span class="s2">"Resulting CSS:</span><span class="se">\\n</span><span class="s2">{css}"</span>\n<span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span> <span class="n">printfn</span> <span class="s2">"No plugin was found on the script"</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>This is more-less what I have in mind, it has a few downsides though</p>\n\n<ul>\n<li>Convention based naming</li>\n<li>Badly written plugins might leak memory or make Perla\'s performance to slow down</li>\n<li>Script distribution is a real concern, there\'s no clear way to do it as of now</li>\n<li>Security concerns when executing code with Perla\'s permissions on the user\'s behalf</li>\n</ul>\n\n<p>And many others that I might not be looking after.</p>\n\n<p>Being able to author plugins and process any kind of file into something Perla can use to enhance the consumer experience is just worth it though, for example just look at the vast amount of webpack and vite plugins. The use cases are there for anyone to fulfill them .</p>\n<h3>\n  <a name="hmr" href="#hmr">\n  </a>\n  HMR\n</h3>\n\n<p>This is the golden apple I\'m not entirely sure how to tackle...<br>\n<a href="https://github.com/snowpackjs/esm-hmr">There\'s an HMR spec</a> that I will follow for that since that\'s what snowpack/vite\'s HMR is based on, libraries like <a href="https://fable.io/Fable.Lit/">Fable.Lit</a>, or <a href="https://elmish.github.io/hmr/">Elmish.HMR</a> are working towards being compatible with vite\'s HMR, so if Perla can make it work like them, then we won\'t even need to write any specific code for Perla.</p>\n\n<p>I can talk however of CSS HMR, This is a pretty simple change to support given that CSS changes are automatically propagated in the browser, it basically does half of the HMR for us.</p>\n\n<p>Perla does the following:</p>\n\n<ul>\n<li>Sees <code>import "./app.css</code>\n</li>\n<li>Runs the <code>cssImport</code> middleware function I hinted at earlier and returns a ~CSS~ Javascript file that injects a script tag on the head of the page.\n</li>\n</ul>\n<div class="highlight js-code-highlight">\n<pre class="highlight fsharp"><code>  <span class="k">let</span> <span class="n">cssImport</span>\n    <span class="p">(</span><span class="n">mountedDirs</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="o">&gt;)</span>\n    <span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="nc">HttpContext</span><span class="p">)</span>\n    <span class="p">(</span><span class="n">next</span><span class="p">:</span> <span class="nc">Func</span><span class="p">&lt;</span><span class="nc">Task</span><span class="o">&gt;)</span>\n    <span class="p">=</span>\n    <span class="n">task</span> <span class="p">{</span>\n      <span class="c1">// skip non-css files</span>\n      <span class="k">if</span> <span class="n">ctx</span><span class="p">.</span><span class="nn">Request</span><span class="p">.</span><span class="nn">Path</span><span class="p">.</span><span class="nn">Value</span><span class="p">.</span><span class="nc">Contains</span><span class="p">(</span><span class="s2">".css"</span><span class="p">)</span> <span class="p">|&gt;</span> <span class="k">not</span> <span class="k">then</span>\n        <span class="k">return</span><span class="o">!</span> <span class="n">next</span><span class="p">.</span><span class="nc">Invoke</span><span class="bp">()</span>\n      <span class="k">else</span>\n\n        <span class="k">let</span> <span class="n">logger</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">GetLogger</span><span class="p">(</span><span class="s2">"Perla Middleware"</span><span class="p">)</span>\n        <span class="k">let</span> <span class="n">path</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nn">Request</span><span class="p">.</span><span class="nn">Path</span><span class="p">.</span><span class="nc">Value</span>\n\n        <span class="k">let</span> <span class="n">baseDir</span><span class="p">,</span> <span class="n">baseName</span> <span class="p">=</span>\n          <span class="n">mountedDirs</span>\n          <span class="p">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="p">_</span> <span class="n">v</span> <span class="p">-&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="nc">IsNullOrWhiteSpace</span> <span class="n">v</span> <span class="p">|&gt;</span> <span class="k">not</span><span class="p">)</span>\n          <span class="p">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">toSeq</span>\n          <span class="p">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">find</span> <span class="p">(</span><span class="k">fun</span> <span class="o">(_,</span> <span class="n">v</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">path</span><span class="p">.</span><span class="nc">StartsWith</span><span class="p">(</span><span class="n">v</span><span class="o">))</span>\n\n        <span class="k">let</span> <span class="n">filePath</span> <span class="p">=</span>\n          <span class="k">let</span> <span class="n">fileName</span> <span class="p">=</span>\n            <span class="n">path</span><span class="p">.</span><span class="nc">Replace</span><span class="o">($</span><span class="s2">"{baseName}/"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="nn">StringComparison</span><span class="p">.</span><span class="nc">InvariantCulture</span><span class="p">)</span>\n\n          <span class="nn">Path</span><span class="p">.</span><span class="nc">Combine</span><span class="p">(</span><span class="n">baseDir</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>\n\n        <span class="n">logger</span><span class="p">.</span><span class="nc">LogInformation</span><span class="p">(</span><span class="s2">"Transforming CSS"</span><span class="p">)</span>\n\n        <span class="k">let</span><span class="o">!</span> <span class="n">content</span> <span class="p">=</span> <span class="nn">File</span><span class="p">.</span><span class="nc">ReadAllTextAsync</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>\n        <span class="c1">// return the JS code to insert the CSS content in a style tag</span>\n        <span class="k">let</span> <span class="n">newContent</span> <span class="p">=</span>\n          <span class="o">$</span><span class="s2">"""\nconst css = `{content}`\nconst style = document.createElement(\'style\')\nstyle.innerHTML = css\nstyle.setAttribute("</span><span class="n">filename</span><span class="s2">", "</span><span class="p">{</span><span class="n">filePath</span><span class="p">}</span><span class="s2">");\ndocument.head.appendChild(style)"""</span>\n\n        <span class="n">ctx</span><span class="p">.</span><span class="nc">SetContentType</span> <span class="s2">"text/javascript"</span>\n        <span class="k">do</span><span class="o">!</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">WriteStringAsync</span> <span class="n">newContent</span> <span class="p">:&gt;</span> <span class="nc">Task</span>\n    <span class="p">}</span>\n    <span class="p">:&gt;</span> <span class="nc">Task</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>In the SSE handler function we observe for file changes in disk and depending on the content we do the corresponding update<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight fsharp"><code><span class="n">watcher</span><span class="p">.</span><span class="nc">FileChanged</span>\n<span class="p">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="k">event</span> <span class="p">-&gt;</span>\n  <span class="n">task</span> <span class="p">{</span>\n    <span class="k">match</span> <span class="nn">Path</span><span class="p">.</span><span class="nc">GetExtension</span> <span class="k">event</span><span class="p">.</span><span class="n">name</span> <span class="k">with</span>\n    <span class="p">|</span> <span class="nc">Css</span> <span class="p">-&gt;</span>\n      <span class="c1">// a CSS file was changed, read all of the content</span>\n      <span class="k">let</span><span class="o">!</span> <span class="n">content</span> <span class="p">=</span> <span class="nn">File</span><span class="p">.</span><span class="nc">ReadAllTextAsync</span> <span class="k">event</span><span class="p">.</span><span class="n">path</span>\n\n      <span class="k">let</span> <span class="n">data</span> <span class="p">=</span>\n        <span class="nn">Json</span><span class="p">.</span><span class="nc">ToTextMinified</span><span class="p">(</span>\n          <span class="o">{|</span> <span class="n">oldName</span> <span class="p">=</span>\n              <span class="k">event</span><span class="p">.</span><span class="n">oldName</span>\n              <span class="p">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">value</span> <span class="p">-&gt;</span>\n                <span class="k">match</span> <span class="n">value</span> <span class="k">with</span>\n                <span class="p">|</span> <span class="nc">Css</span> <span class="p">-&gt;</span> <span class="n">value</span>\n                <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="s2">""</span><span class="p">)</span>\n              <span class="n">name</span> <span class="p">=</span> <span class="k">event</span><span class="p">.</span><span class="n">path</span>\n              <span class="n">content</span> <span class="p">=</span> <span class="n">content</span> <span class="o">|}</span>\n        <span class="p">)</span>\n      <span class="c1">// Send the SSE Message to the client with the new CSS content</span>\n      <span class="k">do</span><span class="o">!</span> <span class="n">res</span><span class="p">.</span><span class="nc">WriteAsync</span> <span class="o">$</span><span class="s2">"event:replace-css</span><span class="se">\\n</span><span class="s2">data:{data}</span><span class="se">\\n\\n</span><span class="s2">"</span>\n      <span class="k">return</span><span class="o">!</span> <span class="n">res</span><span class="p">.</span><span class="nn">Body</span><span class="p">.</span><span class="nc">FlushAsync</span><span class="bp">()</span>\n    <span class="p">|</span> <span class="nc">Typescript</span>\n    <span class="p">|</span> <span class="nc">Javascript</span>\n    <span class="p">|</span> <span class="nc">Jsx</span>\n    <span class="p">|</span> <span class="nc">Json</span>\n    <span class="p">|</span> <span class="nc">Other</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="c1">//... other content ...</span>\n  <span class="o">})</span>\n<span class="p">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">switchTask</span>\n<span class="p">|&gt;</span> <span class="nn">Observable</span><span class="p">.</span><span class="n">subscribe</span> <span class="n">ignore</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>To handle these updates we use two cool things, <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers">WebWorkers</a> and a simple scripts, the live reload script has this content<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight javascript"><code><span class="c1">// initiate worker</span>\n<span class="kd">const</span> <span class="nx">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Worker</span><span class="p">(</span><span class="dl">"</span><span class="s2">/~perla~/worker.js</span><span class="dl">"</span><span class="p">);</span>\n<span class="c1">// connect to the SSE endpoint</span>\n<span class="nx">worker</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span> <span class="na">event</span><span class="p">:</span> <span class="dl">"</span><span class="s2">connect</span><span class="dl">"</span> <span class="p">});</span>\n\n<span class="kd">function</span> <span class="nx">replaceCssContent</span><span class="p">({</span> <span class="nx">oldName</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">content</span> <span class="p">})</span> <span class="p">{</span>\n  <span class="kd">const</span> <span class="nx">css</span> <span class="o">=</span> <span class="nx">content</span><span class="p">?.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">(?:\\\\</span><span class="sr">r</span><span class="se">\\\\</span><span class="sr">n|</span><span class="se">\\\\</span><span class="sr">r|</span><span class="se">\\\\</span><span class="sr">n</span><span class="se">)</span><span class="sr">/g</span><span class="p">,</span> <span class="dl">"</span><span class="se">\\n</span><span class="dl">"</span><span class="p">)</span> <span class="o">||</span> <span class="dl">""</span><span class="p">;</span>\n  <span class="kd">const</span> <span class="nx">findBy</span> <span class="o">=</span> <span class="nx">oldName</span> <span class="o">||</span> <span class="nx">name</span><span class="p">;</span>\n\n  <span class="c1">// find the style tag with the particular name</span>\n  <span class="kd">const</span> <span class="nx">style</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">`[filename="</span><span class="p">${</span><span class="nx">findBy</span><span class="p">}</span><span class="s2">"]`</span><span class="p">);</span>\n  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">style</span><span class="p">)</span> <span class="p">{</span>\n    <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="dl">"</span><span class="s2">Unable to find</span><span class="dl">"</span><span class="p">,</span> <span class="nx">oldName</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>\n    <span class="k">return</span><span class="p">;</span>\n  <span class="p">}</span>\n  <span class="c1">// replace the content</span>\n  <span class="nx">style</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">css</span><span class="p">;</span>\n  <span class="nx">style</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">filename</span><span class="dl">"</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>\n<span class="p">}</span>\n\n<span class="kd">function</span> <span class="nx">showOverlay</span><span class="p">({</span> <span class="nx">error</span> <span class="p">})</span> <span class="p">{</span>\n  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">show overlay</span><span class="dl">"</span><span class="p">);</span>\n<span class="p">}</span>\n\n<span class="c1">// react to the worker messages</span>\n<span class="nx">worker</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">({</span> <span class="nx">data</span> <span class="p">})</span> <span class="p">{</span>\n  <span class="k">switch</span> <span class="p">(</span><span class="nx">data</span><span class="p">?.</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>\n    <span class="k">case</span> <span class="dl">"</span><span class="s2">reload</span><span class="dl">"</span><span class="p">:</span>\n      <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span>\n    <span class="k">case</span> <span class="dl">"</span><span class="s2">replace-css</span><span class="dl">"</span><span class="p">:</span>\n      <span class="k">return</span> <span class="nx">replaceCssContent</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>\n    <span class="k">case</span> <span class="dl">"</span><span class="s2">compile-err</span><span class="dl">"</span><span class="p">:</span>\n      <span class="k">return</span> <span class="nx">showOverlay</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>\n    <span class="nl">default</span><span class="p">:</span>\n      <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Unknown message:</span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>\n  <span class="p">}</span>\n<span class="p">});</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>Inside our Worker the code is very very similar<br>\n</p>\n<div class="highlight js-code-highlight">\n<pre class="highlight javascript"><code><span class="kd">let</span> <span class="nx">source</span><span class="p">;</span>\n\n<span class="kd">const</span> <span class="nx">tryParse</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="k">try</span> <span class="p">{</span>\n    <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="o">||</span> <span class="p">{};</span>\n  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>\n    <span class="k">return</span> <span class="p">{};</span>\n  <span class="p">}</span>\n<span class="p">};</span>\n\n<span class="kd">function</span> <span class="nx">connectToSource</span><span class="p">()</span> <span class="p">{</span>\n  <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>\n  <span class="c1">//connect to the SSE endpoint</span>\n  <span class="nx">source</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventSource</span><span class="p">(</span><span class="dl">"</span><span class="s2">/~perla~/sse</span><span class="dl">"</span><span class="p">);</span>\n  <span class="nx">source</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">open</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>\n    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Connected</span><span class="dl">"</span><span class="p">);</span>\n  <span class="p">});</span>\n  <span class="c1">// react to file reloads</span>\n  <span class="nx">source</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">reload</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>\n    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Reloading, file changed: </span><span class="dl">"</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>\n    <span class="nb">self</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>\n      <span class="na">event</span><span class="p">:</span> <span class="dl">"</span><span class="s2">reload</span><span class="dl">"</span><span class="p">,</span>\n    <span class="p">});</span>\n  <span class="p">});</span>\n  <span class="c1">// if the server sends a `replace-css` event</span>\n  <span class="c1">// notify the main thread about it</span>\n  <span class="c1">// Yes! web workers run on background threads!</span>\n  <span class="nx">source</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">replace-css</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>\n    <span class="kd">const</span> <span class="p">{</span> <span class="nx">oldName</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">content</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">tryParse</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>\n    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Css Changed: </span><span class="p">${</span><span class="nx">oldName</span> <span class="p">?</span> <span class="nx">oldName</span> <span class="p">:</span> <span class="nx">name</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>\n    <span class="nb">self</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>\n      <span class="na">event</span><span class="p">:</span> <span class="dl">"</span><span class="s2">replace-css</span><span class="dl">"</span><span class="p">,</span>\n      <span class="nx">oldName</span><span class="p">,</span>\n      <span class="nx">name</span><span class="p">,</span>\n      <span class="nx">content</span><span class="p">,</span>\n    <span class="p">});</span>\n  <span class="p">});</span>\n\n  <span class="nx">source</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">compile-err</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>\n    <span class="kd">const</span> <span class="p">{</span> <span class="nx">error</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">tryParse</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>\n    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>\n    <span class="nb">self</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>\n      <span class="na">event</span><span class="p">:</span> <span class="dl">"</span><span class="s2">compile-err</span><span class="dl">"</span><span class="p">,</span>\n      <span class="nx">error</span><span class="p">,</span>\n    <span class="p">});</span>\n  <span class="p">});</span>\n<span class="p">}</span>\n\n<span class="nb">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">({</span> <span class="nx">data</span> <span class="p">})</span> <span class="p">{</span>\n  <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">?.</span><span class="nx">event</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">connect</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>\n    <span class="nx">connectToSource</span><span class="p">();</span>\n  <span class="p">}</span>\n<span class="p">});</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>And that\'s how the CSS HMR works in Perla and it is instant, in less than a blink of an eye! Well... maybe not but pretty close to it.</p>\n\n<p>For the JS side I\'m still not sure how this will work given that I might need to have a mapping in both sides of the files I have and what is their current version.</p>\n<h2>\n  <a name="whats-next" href="#whats-next">\n  </a>\n  What\'s next?\n</h2>\n\n<p>Whew! That was a lot! but shows how to build each part of the Webpack alternative I\'ve been working on Called <a href="https://perla-docs.web.app/">Perla</a> there are still some gaps though</p>\n\n<ul>\n<li>Project Scaffolding</li>\n</ul>\n\n<p>This will be an important step for adoption I believe, generating certain files, or even starter projects to reduce the onboarding complexity is vital, so this is likely the next step for me (even before the HMR)</p>\n\n<ul>\n<li>Unit/E2E Testing</li>\n</ul>\n\n<p>Node based test runners won\'t work naturally since we\'re not using node! So this is an area to investigate, for E2E I already have the thought of using playwright, for unit tests I\'m not sure yet but I guess I\'d be able to pick something similar or simply have a test framework that runs entirely on the browser.</p>\n\n<ul>\n<li>Import map ergonomics</li>\n</ul>\n\n<p>Some times, you must edit by hand the import map (<code>perla.jsonc.lock</code>) to get dependencies like <code>import fp from \'lodash/fp\'</code> with the import maps the browser knows what to do with <code>lodash</code> but not <code>lodash/fp</code> so an edit must be made, this requires you to understand how these dependencies work and how you need to write the import map, it\'s an area I\'d love to make as simple as possible</p>\n\n<ul>\n<li>Typescript Types for dependencies</li>\n</ul>\n\n<p>Typescript (and related Editors/IDEs like vscode and webstorm) rely on the presence of node_modules to pick typings from disk, It would be nice if typescript worked with the URI style imports for typings that would fix a lot of issues.</p>\n\n<ul>\n<li>Library/Build only mode</li>\n</ul>\n\n<p>There might be certain cases where you would like to author a library either for you and your team, perhaps you only need the JS files and a package.json to share the sources, while not a priority it\'s something it\'s worth looking at.</p>\n\n<ul>\n<li>Improve the <em>Install</em> story</li>\n</ul>\n\n<p>The goal is run a single line command, get your stuff installed in place regardless of if you have .NET or not</p>\n<h2>\n  <a name="closing-thoughts" href="#closing-thoughts">\n  </a>\n  Closing thoughts...\n</h2>\n\n<p>So those are some of the things I might have on my plate for next, of course if I receive feedback on this project I may prioritize some things over the others but rather than doing it all for myself, I wish to share this and make it a community effort to continue to improve the Frontend tooling story that doesn\'t rely on complex patterns and extremely weird and cryptic errors, hundreds of hours spent in configuration, something as simple that you feel confident enough to trust and use :)</p>\n\n<blockquote>\n<p>by the way, this is the repository in question :) <br>\n</p>\n<div class="ltag-github-readme-tag">\n  <div class="readme-overview">\n    <h2>\n      <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--566lAguM--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev.to/assets/github-logo-5a155e1f9a670af7944dd5e12375bc76ed542ea80224905ecaf878b9157cdefc.svg" alt="GitHub logo" loading="lazy">\n      <a href="https://github.com/AngelMunoz">\n        AngelMunoz\n      </a> / <a style="font-weight: 600;" href="https://github.com/AngelMunoz/Perla">\n        Perla\n      </a>\n    </h2>\n    <h3>\n      A cross-platform tool for unbundled front-end development that doesn\'t depend on Node or requires you to install a complex toolchain\n    </h3>\n  </div>\n  <div class="ltag-github-body">\n    \n<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><h1 dir="auto">\nPerla Dev Server</h1>\n<blockquote>\n<p dir="auto">Check the samples <a href="https://github.com/AngelMunoz/perla-samples">https://github.com/AngelMunoz/perla-samples</a></p>\n</blockquote>\n<p dir="auto">Perla is a cross-platform single executable binary CLI Tool for a Development Server of Single Page Applications.</p>\n<p dir="auto">If that sounds like something nice, <a href="https://perla-docs.web.app/" rel="nofollow">Check The docs!</a></p>\n<h2 dir="auto">\nStatus</h2>\n<p dir="auto">This project is in development, current goals at this point are:</p>\n<ul class="contains-task-list">\n<li class="task-list-item">\n Remove npm/node out of the equation.</li>\n<li class="task-list-item">\n For F# users, seamless fable integration.</li>\n<li class="task-list-item">\n A Fast and easy to use Development server</li>\n<li class="task-list-item">\n Build for production using esbuild.</li>\n<li class="task-list-item">\n Binary Release for users outside .NET</li>\n<li class="task-list-item">\n HMR (for other than CSS)</li>\n<li class="task-list-item">\n Plugin System</li>\n</ul>\n<p dir="auto">For more information check the Issues tab.</p>\n<h2 dir="auto">\nExisting tools</h2>\n<p dir="auto">If you actually use and like nodejs, then you would be better taking a look at the tools that inspired this repository</p>\n<ul dir="auto">\n<li><a href="https://vitejs.dev/" rel="nofollow">vite</a></li>\n<li><a href="https://www.snowpack.dev/" rel="nofollow">snowpack</a></li>\n</ul>\n<p dir="auto">These tools have a bigger community and rely on an even bigger ecosystem plus they support plugins via npm so if you\'re using node stick with them they are a better choice\nPerla\'s unbundled…</p></article></div>\n  </div>\n  <div class="gh-btn-container"><a class="gh-btn" href="https://github.com/AngelMunoz/Perla">View on GitHub</a></div>\n</div>\n\n\n<br>\n</blockquote>\n\n<p>And with all due respect, I really thank the maintainers of snowpack,esbuild, and vite who make an incredible job at reducing the complexity of frontend tooling as well, they inspired me AND if you\'re a loving node user please look at their projects ditch webpack enough so they also reflect back and simplify their setups!</p>\n\n<p>For the .NET community I wish to spark a little of interest to look outside and build tooling for other communities, I think it is a really nice way to introduce .NET with the rest of the world and new devs be it with F#, C# or VB, I think .NET is an amazing platform for that. This has been a really good learning exercise and at the same time a project I believe in so, I will try to spend more time and push it to as much as I can.</p>\n\n<p>I\'ll see you on the next one :)</p>\n\n',n.body_markdown='[fable]: https://fable.io/\n[parcel]: https://parceljs.org/\n[fuse-box]: https://fuse-box.org/\n[webpack]: https://webpack.js.org/\n[cliwrap]: https://github.com/Tyrrrz/CliWrap\n[fable real world]: https://github.com/AngelMunoz/real-world-fable\n[snowpack]: https://www.snowpack.dev/\n[vitejs]: https://vitejs.dev/\n[unbundled]: https://www.snowpack.dev/concepts/how-snowpack-works#unbundled-development\n[import maps]: https://github.com/WICG/import-maps\n[suave]: https://suave.io/\n[saturn]: https://saturnframework.org/\n[esbuild]: https://esbuild.github.io/\n[published about SSE]: https://dev.to/tunaxor/server-sent-events-with-saturn-and-fsharp-m6b\n[Import Map Generator]: https://generator.jspm.io/\n[Yarp]: https://microsoft.github.io/reverse-proxy/articles/direct-forwarding.html\n[There\'s an HMR spec]: https://github.com/snowpackjs/esm-hmr\n[Elmish.HMR]: https://elmish.github.io/hmr/\n[Fable.Lit]: https://fable.io/Fable.Lit/\n[WebWorkers]: https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers\n[Perla]: https://perla-docs.web.app/\n[esm modules]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules\n[FSharp.Control.Reactive]: http://fsprojects.github.io/FSharp.Control.Reactive/\n[@Yaurthek]: https://twitter.com/Yaurthek\n\nFable 3 made something I was not aware for some time, it moved to emitting ESM Modules and leaving babel and other stuff behind for users to set up.\nIt was around June that I was really mad at compilation times with [Fable] projects, After being in the JS/Node ecosystems for years I wondered what could be done to improve that situation.\n\n{% twitter 1404250352338325510 %}\n\nAt the time I had been exploring alternatives to [Webpack] like [fuse-box], [parcel], and [esbuild]. Around the same time I was made aware aware that browsers had already implemented [ESM modules], so technically as long as you produced HTML, CSS, and JS you didn\'t need any kind of pre-processing at all.\n\nThis shouldn\'t be that hard, I just needed a server that well... served the HTML/CSS/JS files right?\nI went to my desktop, created an F# script added a couple of libraries like [Suave] and [CliWrap] so I could call the `dotnet fable` command from my F# code and make it compile my Fable files.\n\nTaking out some code I came up with this PoC:\n\n```fsharp\n// I omited more code above for brevity\nlet stdinAsyncSeq () =\n    let readFromStdin () =\n        Console.In.ReadLineAsync() |> Async.AwaitTask\n\n    asyncSeq {\n        // I wanted to think this is a "clever"\n        // way to keep it running\n        while true do\n            let! value = readFromStdin ()\n            value\n    }\n    |> AsyncSeq.distinctUntilChanged\n    |> AsyncSeq.iterAsync onStdinAsync\n\nlet app =\n    choose [ path "/"\n             >=> GET\n             // send the index file\n             >=> Files.browseFileHome "index.html"\n             // serve static files\n             GET >=> Files.browseHome\n             RequestErrors.NOT_FOUND "Not Found"\n             // SPA like fallback\n             >=> redirect "/" ]\n\nlet config (publicPath: string option) =\n    let path =\n        Path.GetFullPath(\n            match publicPath with\n            | Some "built" -> "./dist"\n            | _ -> "./public"\n        )\n\n    printfn $"Serving content from {path}"\n    // configure the suave server instance\n    { defaultConfig with\n          bindings = [ HttpBinding.createSimple HTTP "0.0.0.0" 3000 ]\n          homeFolder = Some path\n          compressedFilesFolder = Some(Path.GetFullPath "./.compressed") }\n// let\'s make it run!\nstdinAsyncSeq () |> Async.Start\n// dotnet fsi suave.fsx built to show how bundled files work\nstartWebServer (config (fsi.CommandLineArgs |> Array.tryLast)) app\n```\nNow, I could have my suave server and my Fable compiler running on the background. I could see my files being served in my browser I could make changes, press F5 and see them working.\n\n{% twitter 1404300942648954882 %}\n\nCool it worked... Yay!... sure, with my attention span for some things I simply didn\'t think too much about it, or so I thought.\n\nWhat came up next was experimenting with snowpack and fuse-box to see which setup could work best with Fable 3 and Although, Both projects work extremely well with Fable, the snowpack project felt more compelling to me thanks to the promoted [Unbundled] development concept. I decided to go for it and tried the [Fable Real World] implementation and switched webpack for snowpack and the results were kind of what I was expecting, faster builds, a simpler setup and a much faster developer loop feedback with the browser.\n\nUnconsciously on the back of my head was still that voice about writing something like snowpack in F#... In my mind, the people who build those kinds of tools are like people in the movies; You know they exist but, you don\'t think you are capable of doing something like it. Specially when most of my experience at that point was building UI\'s in things like Angular.\n\nI went ahead and started studying the snowpack source code and I found out that they were using [esbuild] a JS/TS compiler written in Go, no wonder why it was faster than anything done in JavaScript at the time.\n\nAlso, on the background [vitejs] was also starting to get in shape, I was looking at Evan\'s tweets from afar and getting inspired from that as well so I realized I needed to go back and see if I could go even further.\n\n- What if I used esbuild as well?\n- What if I could use esbuild to produce my prod bundle after I built my fable code?\n\n{% twitter 1407072676355751938 %}\n\nTurns out... I wasn\'t that crazy, after all both vite and snowpack were doing it as well!\n\nAround September vite got traction with the vue user base and other users as well. I also studied a bit the vite source code, and even used it for some Fable material for posts. I was trying to make some awareness of [Fable.Lit] support for Web Components and I wanted to experiment in reality how good vite was, and boi it\'s awesome If you\'re starting new projects that depend on node tooling in my opinion, it\'s your best bet.\n\nAnyways, I tend to be looking at what\'s new on the web space, and by this time these... [Import Maps] thing came to my attention, it is a really nice browser feature that can be used to control the browser\'s behavior to import JavaScript files.\n\nImport maps can tell the browser to use "bare specifiers" (i.e. `import dependency from "my-dependency"` rather than `"./my-dependency.js`) \n\nAlmost like "pull this import from this URL".\n\nHopefully you are starting to put the pieces together as I was doing.\n\nMaybe... It might be possible to actually enjoy the NPM ecosystem without having to rely on the local tooling... Just maybe...\n\n{% twitter 1438579622904582144 %} \n\nFrom then on, It was just about making small F# scripts to experiment PoC\'s and implementing small features.\n\nAt this point is when I said to myself.\n\n> It\'s time to build a Webpack alternative...\n\nFor this... _FSharp.DevServer_... I needed to have an idea of what I wanted to implement to make it usable at least, I settled on the following set of features.\n\n- Serve HTML/CSS/JS\n- Support for Fable Projects\n- Reload on change\n- Install dependencies\n- Production Bundles\n- Transpilation on the fly\n- Dev Proxy\n- Plugins\n- HMR\n\nThose are the least features necessary IMO to consider for a project like this.\n\nI will take you on a quick tour at how those got implemented at some point in the project.\n\n> Keep in mind I\'m not an F# expert! I\'m just a guy with a lot of anxiety and free time so I use my code to distract myself while having a ton of fun with F# code.\n\nWhile for a proof of concept Suave did great, I switched it in favor of [Saturn] given my familiarity with it and some ASP.NET code.\n\n## Serve HTML/CSS/JS\n\nFrom most of the features, this must have been perhaps the most simple after all if you\'re using a server, it should be really simple to do right?\n\nWell... Yes and No... it turns out that if you serve static files they get out of the middleware chain very quick due to the order of the static middleware is in. While it was good for serving it if I wanted to reload on change or compile these files I was not going to be able to do it.\n\n```fsharp\n// the current devServer function has way more stuff\n// due the extra features that have been implemented\nlet private devServer (config: FdsConfig) =\n    let withAppConfig (appConfig: IApplicationBuilder) =\n        // let\'s serve everything statically\n        // but let\'s ignore some extensions\n        let ignoreStatic =\n          [ ".js"\n            ".css"\n            ".module.css"\n            ".ts"\n            ".tsx"\n            ".jsx"\n            ".json" ]\n        // mountedDirs is a property in perla.jsonc\n        // that enables you to watch a partcular set of \n        // directories for source code\n        for map in mountedDirs do\n          let staticFileOptions =\n            let provider = FileExtensionContentTypeProvider()\n\n            for ext in ignoreStatic do\n              provider.Mappings.Remove(ext) |> ignore\n\n            let options = StaticFileOptions()\n\n            options.ContentTypeProvider <- provider\n            // in the next lines we enable local mapings\n            // to URL\'s e.g.\n            // ./src on disk -> /src on the URL\n            options.RequestPath <- PathString(map.Value)\n\n            options.FileProvider <-\n              new PhysicalFileProvider(Path.GetFullPath(map.Key))\n\n            options\n\n          appConfig.UseStaticFiles staticFileOptions\n          |> ignore\n\n        let appConfig =\n          // at the same time we enable transpilation\n          // middleware when we\'re ignoring some extensions\n          appConfig.UseWhen(\n            Middleware.transformPredicate ignoreStatic,\n            Middleware.configureTransformMiddleware config\n          )\n    // set the configured options\n    application {\n        app_config withAppConfig\n        webhost_config withWebhostConfig\n        use_endpoint_router urls\n    }\n    // build it\n    app\n        .UseEnvironment(Environments.Development)\n        .Build()\n```\n\nThis part is just about serving files, nothing more, nothing less, that\'s the core of a dev server. \n\n## Support for Fable Projects\n\nFable is actually not hard to support, fable is distributed as a dotnet tool, we can invoke the command with [CliWrap] which has proven us in the PoC stage, how simple is to call a process from .NET.\n\n```fsharp\n// This is the actual Fable implementation\n\nmodule Fable =\n  let mutable private activeFable: int option = None\n\n  // this is to start/stop the fable command\n  // if requested by the user\n  let private killActiveProcess pid =\n    try\n      let activeProcess = System.Diagnostics.Process.GetProcessById pid\n\n      activeProcess.Kill()\n    with\n    | ex -> printfn $"Failed to Kill Procees with PID: [{pid}]\\n{ex.Message}"\n\n  // Helper functions to add arguments to the fable command\n\n  let private addOutDir\n    (outdir: string option)\n    (args: Builders.ArgumentsBuilder)\n    =\n    match outdir with\n    | Some outdir -> args.Add $"-o {outdir}"\n    | None -> args\n\n  let private addExtension\n    (extension: string option)\n    (args: Builders.ArgumentsBuilder)\n    =\n    match extension with\n    | Some extension -> args.Add $"-e {extension}"\n    | None -> args\n\n  let private addWatch (watch: bool option) (args: Builders.ArgumentsBuilder) =\n    match watch with\n    | Some true -> args.Add $"--watch"\n    | Some false\n    | None -> args\n\n  // we can fire up fable either as a background process\n  // or before calling esbuild for production\n  let fableCmd (isWatch: bool option) =\n\n    fun (config: FableConfig) ->\n      let execBinName =\n        if Env.isWindows then\n          "dotnet.exe"\n        else\n          "dotnet"\n\n      Cli\n        .Wrap(execBinName)\n        .WithArguments(fun args ->\n          args\n            .Add("fable")\n            .Add(defaultArg config.project "./src/App.fsproj")\n          |> addWatch isWatch\n          |> addOutDir config.outDir\n          |> addExtension config.extension\n          |> ignore)\n        // we don\'t do a lot, we simply re-direct the stdio to the console\n        .WithStandardErrorPipe(PipeTarget.ToStream(Console.OpenStandardError()))\n        .WithStandardOutputPipe(\n          PipeTarget.ToStream(Console.OpenStandardOutput())\n        )\n\n  let stopFable () =\n    match activeFable with\n    | Some pid -> killActiveProcess pid\n    | None -> printfn "No active Fable found"\n\n  let startFable\n    (getCommand: FableConfig option -> Command)\n    (config: FableConfig option)\n    =\n    task {\n      // Execute and wait for it to finish\n      let cmdResult = getCommand(config).ExecuteAsync()\n      activeFable <- Some cmdResult.ProcessId\n\n      return! cmdResult.Task\n    }\n```\n\nKeeping the process ID on memory might not be the best idea and there can be better ways to handle that but at least for now it works just fine.\n\nCalling the `startFable` function with fable options, will make fable run on the background, this allows us to have fable output JS files that we will be able to serve.\n\n## Reload on change\n\nReloading on change was an interesting feature to do, first of all I needed a file watcher and I have had heard before that the .NET one wasn\'t really that great, I also needed to communicate with the frontend when something changed in the backend.\n\nFor the file watcher, I tried to search for good alternatives, but to be honest in the end I decided to go with the one in the BCL.\n\nI was kind of scared though how would I manage multiple notifications and events without making it a mess? I had No idea... Thankfully [FSharp.Control.Reactive] was found and is just what I needed. This library allows you to make observables from events and has a bunch of nice utility functions to work with stream like collections if you\'ve used RxJS or RX.NET you will feel at home with it.\n\n```fsharp\n\n  let getFileWatcher (config: WatchConfig) =\n    let watchers =\n      // monitor a particular list of  addresses\n      (defaultArg config.directories ([ "./src" ] |> Seq.ofList))\n      |> Seq.map (fun dir ->\n        // for each address create a file watcher\n        let fsw = new FileSystemWatcher(dir)\n        fsw.IncludeSubdirectories <- true\n        fsw.NotifyFilter <- NotifyFilters.FileName ||| NotifyFilters.Size\n\n        let filters =\n          defaultArg\n            config.extensions\n            (Seq.ofList [ "*.js"\n                          "*.css"\n                          "*.ts"\n                          "*.tsx"\n                          "*.jsx"\n                          "*.json" ])\n        // ensure you\'re monitoring all of the\n        // extensions you want to reload on change\n        for filter in filters do\n          fsw.Filters.Add(filter)\n        // and ensure you will rise events for them :)\n        fsw.EnableRaisingEvents <- true\n        fsw)\n\n\n    let subs =\n      watchers\n      |> Seq.map (fun watcher ->\n        // for each watche react to the following events\n        // Renamed\n        // Changed\n        // Deleted\n        // Created\n        [ watcher.Renamed\n          // To prevent overflows and weird behaviors\n          // ensure to throttle the events\n          |> Observable.throttle (TimeSpan.FromMilliseconds(400.))\n          |> Observable.map (fun e ->\n            { oldName = Some e.OldName\n              ChangeType = Renamed\n              name = e.Name\n              path = e.FullPath })\n          watcher.Changed\n          |> Observable.throttle (TimeSpan.FromMilliseconds(400.))\n          |> Observable.map (fun e ->\n            { oldName = None\n              ChangeType = Changed\n              name = e.Name\n              path = e.FullPath })\n          watcher.Deleted\n          |> Observable.throttle (TimeSpan.FromMilliseconds(400.))\n          |> Observable.map (fun e ->\n            { oldName = None\n              ChangeType = Deleted\n              name = e.Name\n              path = e.FullPath })\n          watcher.Created\n          |> Observable.throttle (TimeSpan.FromMilliseconds(400.))\n          |> Observable.map (fun e ->\n            { oldName = None\n              ChangeType = Created\n              name = e.Name\n              path = e.FullPath }) ]\n        // Merge these observables in a single one\n        |> Observable.mergeSeq)\n\n    { new IFileWatcher with\n        override _.Dispose() : unit =\n          watchers\n          // when disposing, dispose every watcher you may have around\n          |> Seq.iter (fun watcher -> watcher.Dispose())\n\n        override _.FileChanged: IObservable<FileChangedEvent> =\n          // merge the the merged observables into a single one!!!\n          Observable.mergeSeq subs }\n```\n\nWith this setup you can easily observe changes to multiple directories and multiple extensions it might not be the most efficient way to do it, but It at least got me started with it, now that I had a way to know when something changed I needed to tell the browser what had happened.\n\nFor that I chose SSE (Server Sent Events) which is a really cool way to do real time notifications from the server exclusively without having to implement web sockets it\'s just an HTTP call which can be terminated (or not).\n\n```fsharp\n\n  let private Sse (watchConfig: WatchConfig) next (ctx: HttpContext) =\n    task {\n      let logger = ctx.GetLogger("Perla:SSE")\n      logger.LogInformation $"LiveReload Client Connected"\n      // set up the correct headers\n      ctx.SetHttpHeader("Content-Type", "text/event-stream")\n      ctx.SetHttpHeader("Cache-Control", "no-cache")\n      ctx.SetStatusCode 200\n\n      // send the first event\n      let res = ctx.Response\n      do! res.WriteAsync($"id:{ctx.Connection.Id}\\ndata:{DateTime.Now}\\n\\n")\n      do! res.Body.FlushAsync()\n\n      // get the observable of file changes\n      let watcher = Fs.getFileWatcher watchConfig\n\n      logger.LogInformation $"Watching %A{watchConfig.directories} for changes"\n\n      let onChangeSub =\n        watcher.FileChanged\n        |> Observable.map (fun event ->\n          task {\n            match Path.GetExtension event.name with\n            | Css ->\n              // if the change was on a CSS file send the new content\n              let! content = File.ReadAllTextAsync event.path\n\n              let data =\n                Json.ToTextMinified(\n                  {| oldName =\n                      event.oldName\n                      |> Option.map (fun value ->\n                        match value with\n                        | Css -> value\n                        | _ -> "")\n                     name = event.path\n                     content = content |}\n                )\n              // CSS HMR was basically free!\n              do! res.WriteAsync $"event:replace-css\\ndata:{data}\\n\\n"\n              return! res.Body.FlushAsync()\n            // if it\'s any other file well... just reload\n            | Typescript\n            | Javascript\n            | Jsx\n            | Json\n            | Other _ ->\n              let data =\n                Json.ToTextMinified(\n                  {| oldName = event.oldName\n                     name = event.name |}\n                )\n\n              logger.LogInformation $"LiveReload File Changed: {event.name}"\n              do! res.WriteAsync $"event:reload\\ndata:{data}\\n\\n"\n              return! res.Body.FlushAsync()\n          })\n        // ensure the task gets done\n        |> Observable.switchTask\n        |> Observable.subscribe ignore\n      // if the client closes the browser\n      // then dispose these resources\n      ctx.RequestAborted.Register (fun _ ->\n        watcher.Dispose()\n        onChangeSub.Dispose())\n      |> ignore\n\n      // keep the connection alive\n      while true do\n        // TBH there must be a better way to do it\n        // but since this is not critical, it works just fine\n        do! Async.Sleep(TimeSpan.FromSeconds 1.)\n\n      return! text "" next ctx\n    }\n```\n\nAt this time, I also [published about SSE] on my blog, I really felt it was a really cool thing and decided to share it with the rest of the world :)\n\n## Install dependencies\n\nI was really undecided if I wanted to pursue a webpack alernative because\n\n- How can you install dependencies without npm?\n- Do you really want to do\n  - `import { useState } from \'https://cdn.skypack.dev/pin/react@v17.0.1-yH0aYV1FOvoIPeKBbHxg/mode=imports,min/optimized/react.js\'`\n\nOn every damned file? oh no no no, I don\'t think so... Enter the Import Maps, this feature (along esbuild) was the thing that made me realize it was actually possible to ditch out node/webpack/npm entirely (at least in a local and direct way) instead of doing that ugly import from above, if you can provide a import map with your dependencies the rest should be relatively easy\n\n```html\n<script type="importmap">\n  {\n    "imports": {\n      "moment": "https://ga.jspm.io/npm:moment@2.29.1/moment.js",\n      "lodash": "https://cdn.skypack.dev/lodash"\n    }\n  }\n<\/script>\n\x3c!-- Allows you to do the next  --\x3e\n<script type="module">\n  import moment from "moment";\n  import lodash from "lodash";\n<\/script>\n```\n\n{% twitter 1439457103433936897 %} \n\nSo here I was trying to replicate a version of `package.json` this ended up implementing the `perla.jsonc.lock` file which is not precisely a _lock_ file, while the URL\'s there are certainly the pined and production versions of those packages, it\'s in reality the _**import map**_ in disguise, to get that information though I had to investigate how to do it. Once again I decided to study snowpack since it\'s the only frontend dev tool I know it has this kind of mechanism (remote sources), after some investigation and some PoC\'s I also stumbled upon JSPM\'s recently released [Import Map Generator] which is basically what I wanted to do! Skypack, JSPM and Unpkg offer reliable CDN services for production with all of these investigations and gathered knowledge I went to implement fetching dependencies and "_installing_" them with the dev server tool.\n\n```fsharp\n\n[<RequireQualifiedAccessAttribute>]\nmodule internal Http =\n  open Flurl\n  open Flurl.Http\n\n  [<Literal>]\n  let SKYPACK_CDN = "https://cdn.skypack.dev"\n\n  [<Literal>]\n  let SKYPACK_API = "https://api.skypack.dev/v1"\n\n  [<Literal>]\n  let JSPM_API = "https://api.jspm.io/generate"\n\n  let private getSkypackInfo (name: string) (alias: string) =\n    // FsToolkit.ErrorHandling FTW\n    taskResult {\n      try\n        let info = {| lookUp = $"%s{name}" |}\n        let! res = $"{SKYPACK_CDN}/{info.lookUp}".GetAsync()\n\n        if res.StatusCode >= 400 then\n          return! PackageNotFoundException |> Error\n\n        let mutable pinnedUrl = ""\n        let mutable importUrl = ""\n        // try to get the pinned URL from the headers\n        let info =\n          if\n            res.Headers.TryGetFirst("x-pinned-url", &pinnedUrl)\n            |> not\n          then\n            {| info with pin = None |}\n          else\n            {| info with pin = Some pinnedUrl |}\n\n        // and the imports as well\n        let info =\n          if\n            res.Headers.TryGetFirst("x-import-url", &importUrl)\n            |> not\n          then\n            {| info with import = None |}\n          else\n            {| info with import = Some importUrl |}\n\n        return\n          // generate the corresponding import map entry\n          [ alias, $"{SKYPACK_CDN}{info.pin |> Option.defaultValue info.lookUp}" ],\n          // skypack doesn\'t handle any import maps so the scopes will always be empty\n          []\n      with\n      | :? Flurl.Http.FlurlHttpException as ex ->\n        match ex.StatusCode |> Option.ofNullable with\n        | Some code when code >= 400 ->\n          return! PackageNotFoundException |> Error\n        | _ -> ()\n\n        return! ex :> Exception |> Error\n      | ex -> return! ex |> Error\n    }\n\n  let getJspmInfo name alias source =\n    taskResult {\n      let queryParams =\n        {| install = [| $"{name}" |]\n           env = "browser"\n           provider =\n           // JSPM offer various reliable sources\n           // to get your dependencies\n            match source with\n            | Source.Skypack -> "skypack"\n            | Source.Jspm -> "jspm"\n            | Source.Jsdelivr -> "jsdelivr"\n            | Source.Unpkg -> "unpkg"\n            | _ ->\n              printfn\n                $"Warn: An unknown provider has been specied: [{source}] defaulting to jspm"\n\n              "jspm" |}\n\n      try\n        let! res =\n          JSPM_API\n            .SetQueryParams(queryParams)\n            .GetJsonAsync<JspmResponse>()\n\n        let scopes =\n          // F# type serialization hits again!\n          // the JSPM response may include a scope object or not\n          // so try to safely check if it exists or not\n          match res.map.scopes :> obj |> Option.ofObj with\n          | None -> Map.empty\n          | Some value -> value :?> Map<string, Scope>\n\n        return\n          // generate the corresponding import map\n          // entries as well as the scopes\n          res.map.imports\n          |> Map.toList\n          |> List.map (fun (k, v) -> alias, v),\n          scopes |> Map.toList\n      with\n      | :? Flurl.Http.FlurlHttpException as ex ->\n        match ex.StatusCode |> Option.ofNullable with\n        | Some code when code >= 400 ->\n          return! PackageNotFoundException |> Error\n        | _ -> ()\n\n        return! ex :> Exception |> Error\n    }\n\n  let getPackageUrlInfo (name: string) (alias: string) (source: Source) =\n    match source with\n    | Source.Skypack -> getSkypackInfo name alias\n    | _ -> getJspmInfo name alias source\n```\n\nThis was a relatively low effort to implement but it did require finding a way to gather these resources so they can be mapped to json objects. This approach also allows you yo import different version fo the same package in the same application! that can be useful when you want to migrate dependencies slowly rolling them out.\n\n## Production Bundles\n\nJust as Installing dependencies, having a production ready build is critical This is where [esbuild] finally comes into the picture it is a crucial piece of the puzzle. Esbuild while it\'s written in go and offers a npm package, it provides a single executable binary which can be used in a lot of platforms and and architectures, it distributes itself through the npm registry so it\'s about downloading the package in the correct way and just executing it like we did for the fable command.\n\n```fsharp\nlet esbuildJsCmd (entryPoint: string) (config: BuildConfig) =\n\n  let dirName =\n    (Path.GetDirectoryName entryPoint)\n      .Split(Path.DirectorySeparatorChar)\n    |> Seq.last\n\n  let outDir =\n    match config.outDir with\n    | Some outdir -> Path.Combine(outdir, dirName) |> Some\n    | None -> Path.Combine("./dist", dirName) |> Some\n\n  let execBin = defaultArg config.esBuildPath esbuildExec\n\n  let fileLoaders = getDefaultLoders config\n\n  Cli\n    .Wrap(execBin)\n    .WithStandardErrorPipe(PipeTarget.ToStream(Console.OpenStandardError()))\n    .WithStandardOutputPipe(PipeTarget.ToStream(Console.OpenStandardOutput()))\n    // CliWrap simply allows us to add arguments to commands very easy\n    .WithArguments(fun args ->\n      args.Add(entryPoint)\n      |> addEsExternals config.externals\n      |> addIsBundle config.bundle\n      |> addTarget config.target\n      |> addDefaultFileLoaders fileLoaders\n      |> addMinify config.minify\n      |> addFormat config.format\n      |> addInjects config.injects\n      |> addOutDir outDir\n      |> ignore)\n\n```\n\nthe CLI API from esbuild is pretty simple to be honest and is really effective when it comes to transpilation the benefits are that it not just transpiles Javascript, it also transpiles typescript, jsx and tsx files. Adding to those features esbuild is blazing fast.\n\n# Transpilation on the fly\n\nThe dev server not only needs to serve JS content to the browser, often it needs to serve Typescript/JSX/TSX as well, and as we found earlier in the post if you serve static content your options for transforming or manipulating these request are severely limited, so I had to make particular middlewares to enable compiling single files on the fly.\nlet\'s check a little bit how these are somewhat laid out on Perla\n\n```fsharp\n[<RequireQualifiedAccess>]\nmodule Middleware =\n    // this function helps us determine a particular extension is in the request path\n    // if it is we  will use one of the middlewares below on the calling site.\n    let transformPredicate (extensions: string list) (ctx: HttpContext) = ...\n\n    let cssImport\n        (mountedDirs: Map<string, string>)\n        (ctx: HttpContext)\n        (next: Func<Task>) = ...\n\n    let jsonImport\n        (mountedDirs: Map<string, string>)\n        (ctx: HttpContext)\n        (next: Func<Task>) = ...\n\n    let jsImport\n        (buildConfig: BuildConfig option)\n        (mountedDirs: Map<string, string>)\n        (ctx: HttpContext)\n        (next: Func<Task>) =\n        task {\n        let logger = ctx.GetLogger("Perla Middleware")\n\n        if\n            // for the moment, we just serve the JS as is and don\'t process it\n            ctx.Request.Path.Value.Contains("~perla~")\n            || ctx.Request.Path.Value.Contains(".js") |> not\n        then\n            return! next.Invoke()\n        else\n\n            let path = ctx.Request.Path.Value\n            logger.LogInformation($"Serving {path}")\n\n            let baseDir, baseName =\n                // check if we\'re actually monitoring this directory and this file extension\n                mountedDirs\n                |> Map.filter (fun _ v -> String.IsNullOrWhiteSpace v |> not)\n                |> Map.toSeq\n                |> Seq.find (fun (_, v) -> path.StartsWith(v))\n\n            // find the file on disk\n            let filePath =\n                let fileName =\n                    path.Replace($"{baseName}/", "", StringComparison.InvariantCulture)\n\n                Path.Combine(baseDir, fileName)\n            // we will serve javascript regardless of what we find on disk\n            ctx.SetContentType "text/javascript"\n\n            try\n                if Path.GetExtension(filePath) <> ".js" then\n                    return failwith "Not a JS file, Try looking with another extension."\n                // if the file exists on disk\n                // and has a js extension then just send it as is\n                // the browser should be able to interpret it\n                let! content = File.ReadAllBytesAsync(filePath)\n                do! ctx.WriteBytesAsync content :> Task\n            with\n            | ex ->\n                let! fileData = Esbuild.tryCompileFile filePath buildConfig\n\n                match fileData with\n                | Ok (stdout, stderr) ->\n                    if String.IsNullOrWhiteSpace stderr |> not then\n                        // In the SSE code, we added (later on)\n                        // an observer for compilation errors and send a message to the client,\n                        // this should trigger an "overlay" on the client side\n                        Fs.PublishCompileErr stderr\n                        do! ctx.WriteBytesAsync [||] :> Task\n                    else\n                        // if the file got compiled then just write the file to the body\n                        // of the request\n                        let content = Encoding.UTF8.GetBytes stdout\n                        do! ctx.WriteBytesAsync content :> Task\n                | Error err ->\n                    // anything else, just send a 500\n                    ctx.SetStatusCode 500\n                    do! ctx.WriteTextAsync err.Message :> Task\n        }\n        :> Task\n\n    let configureTransformMiddleware\n        (config: FdsConfig)\n        (appConfig: IApplicationBuilder) =\n        let serverConfig =\n            defaultArg config.devServer (DevServerConfig.DefaultConfig())\n\n        let mountedDirs = defaultArg serverConfig.mountDirectories Map.empty\n\n        appConfig\n            .Use(Func<HttpContext, Func<Task>, Task>(jsonImport mountedDirs))\n            .Use(Func<HttpContext, Func<Task>, Task>(cssImport mountedDirs))\n            .Use(\n                Func<HttpContext, Func<Task>, Task>(jsImport config.build mountedDirs)\n            )\n            |> ignore\n```\n\nIt is a pretty simple module (I want to think) that only has some functions that deal with the content of the files and return any compiled result if neededm otherwise just send the file.\n\nNow... Let\'s take a look at the magic behind `let! fileData = Esbuild.tryCompileFile filePath buildConfig` to be honest I didn\'t really know what I was doing, the main line of thought was just to try and find the content on disk and try the next extension if it didn\'t work. Hah! well ![as long as it works](https://th.bing.com/th/id/OIP.XBALsTMB2KdavcvdRAlpuwHaFD?pid=ImgDet&rs=1)\n\n```fsharp\nlet tryCompileFile filepath config =\n  taskResult {\n    let config = (defaultArg config (BuildConfig.DefaultConfig()))\n    // since we\'re using\n    // FsToolkit.ErrorHandling if the operation fails it will\n    // "early return" meaning it won\'t continue the success path\n    let! res = Fs.tryReadFile filepath\n    let strout = StringBuilder()\n    let strerr = StringBuilder()\n    let (_, loader) = res\n\n    let cmd = buildSingleFileCmd config (strout, strerr) res\n    // execute esbuild on the file\n    do! (cmd.ExecuteAsync()).Task :> Task\n\n    let strout = strout.ToString()\n    let strerr = strerr.ToString()\n\n    let strout =\n      match loader with\n      | Jsx\n      | Tsx ->\n        try\n          // if the file needs injects (e.g automatic "import React from \'react\'" in JSX files)\n          let injects =\n            defaultArg config.injects (Seq.empty)\n            |> Seq.map File.ReadAllText\n\n          // add those right here\n          let injects = String.Join(\'\\n\', injects)\n          $"{injects}\\n{strout}"\n        with\n        | ex ->\n          printfn $"Perla Serve: failed to inject, {ex.Message}"\n          strout\n      | _ -> strout\n    // return the compilation results\n    // the transpiled output and the error if any\n    return (strout, strerr)\n  }\n```\n\nSurely thats a lot of things to do for a single file, I\'m sure it must be quite slow right? Well... It turns out that **.NET** and **Go** are quite quite feaking fast\n\n{% twitter 1444508310393212934 %} \n\neach request takes around 10-20ms and I\'m pretty sure it can be improved once the phase of heavy development settles down and the code base stabilizes a little bit more.\n\n## Dev Proxy\n\nThis one is pretty new, a dev proxy is somewhat necessary specially when you will host your applications on your own server so you are very likely to have URLs like `/api/my-endpoint` rather than `http://my-api.com/api/my-endpoint` it also helps you target different environments with a single configuration change, in this case it was not really complex thanks to [@Yaurthek] who hinted at me one [Yarp] implementation of a dev proxy, so I ended up basing my work on that.\n\nThe whole idea here is to read a json file with some `origin -> target` mappings and then just adding a proxy to the server application.\n\n```fsharp\n\n  let private getHttpClientAndForwarder () =\n    // this socket handler is actually disposable\n    // but since technically I will only use one in the whole application\n    // I won\'t need to dispose it\n    let socketsHandler = new SocketsHttpHandler()\n    socketsHandler.UseProxy <- false\n    socketsHandler.AllowAutoRedirect <- false\n    socketsHandler.AutomaticDecompression <- DecompressionMethods.None\n    socketsHandler.UseCookies <- false\n    let client = new HttpMessageInvoker(socketsHandler)\n    let reqConfig = ForwarderRequestConfig()\n    reqConfig.ActivityTimeout <- TimeSpan.FromSeconds(100.)\n    client, reqConfig\n\n  let private getProxyHandler\n    (target: string)\n    (httpClient: HttpMessageInvoker)\n    (forwardConfig: ForwarderRequestConfig)\n    : Func<HttpContext, IHttpForwarder, Task> =\n    // this is actually using .NET6 Minimal API\'s from asp.net!\n    let toFunc (ctx: HttpContext) (forwarder: IHttpForwarder) =\n      task {\n        let logger = ctx.GetLogger("Perla Proxy")\n        let! error = forwarder.SendAsync(ctx, target, httpClient, forwardConfig)\n\n        // report the errors to the log as a warning\n        // since we don\'t need to die if a request fails\n        if error <> ForwarderError.None then\n          let errorFeat = ctx.GetForwarderErrorFeature()\n          let ex = errorFeat.Exception\n          logger.LogWarning($"{ex.Message}")\n      }\n      :> Task\n    Func<HttpContext, IHttpForwarder, Task>(toFunc)\n```\n\nAnd then somewher inside the aspnet application configuration\n\n```fsharp\nmatch getProxyConfig with\n| Some proxyConfig ->\n    appConfig\n    .UseRouting()\n    .UseEndpoints(fun endpoints ->\n        let (client, reqConfig) = getHttpClientAndForwarder ()\n        // for each mapping add the url add an endpoint\n        for (from, target) in proxyConfig |> Map.toSeq do\n            let handler = getProxyHandler target client reqConfig\n            endpoints.Map(from, handler) |> ignore)\n| None -> appConfig\n```\n\nThat\'s it! At least on my initial testing it seems to work fine, I would need to have some feedback on the feature to know if this is actually working for more complex use cases.\n\n## Future and Experimental things\n\nWhat you have seen so far (and some other minor features) are already inside Perla, they are working and they try to provide you a seamless experience for building Single Page Applications however there are still missing pieces for a complete experience. For example Perla doesn\'t support Sass or Less at the moment and Sass is a pretty common way to write styles on big frontend projects, we are not able to parse out `.Vue` files or anything else that is not HTML/CSS/JS/TS/JSX/TSX, We do support HMR for CSS files since that is not a complex mechanism but, HMR for JS/TS/JSX/TSX files is not there yet sady. Fear not that We\'re looking for a way to provide these at some point in time.\n\n## Plugins\n\nI\'m a fan of `.fsx` files, F# scripts are pretty flexible and since F# 5.0 they are even more powerful than ever allowing you to pull dependencies directly from NuGet without any extra command.\n\nThe main goal for the author and user experiences is somewhat like this\n\nAs an Author:\n\n- Write an `.fsx` script\n- Upload it to gist/github\n- Profit\n\nAs a User:\n\n- Add an entry yo tour "plugins" section\n- Profit\n\nImplementation details are more complex though...\n\nMy vision is somewhere along the following lines\n\n- get a request for a different file e.g. sass files\n- if the file is not part of the default supported extensions\n  - Call a function that will parse the content of that file\n  - get the transpiled content or the compilation error (just like we saw above with the js middleware)\n  - return the valid HTML/CSS/JS content to the browser\n\nTo get there I want to leverage the [FSharp.Compiler.Services] NuGet Package to start an F# interactive session that runs over the life of the server,\n\n- Start the server, also if there are plugins in the plugin section, start the fsi session.\n- load the plugins, download them to a known location in disk, or even just get the strings without downloading the file to disk\n- execute the contents on the fsi session and grab a particular set of functions\n  - These functions can be part of a life cycle which may possible be something like\n    - on load // when HMR is enabled\n    - on change // when HMR is enabled\n    - on transform // when the file is requested\n    - on build // when the production build is executed\n- call the functions in the plugins section whenever needed\n\nStarting an FSI session is not a complex task let\'s take a look.\n\nlet\'s say we have the following script:\n\n```fsharp\n#r "nuget: LibSassHost, 1.3.3"\n#r "nuget: LibSassHost.Native.linux-x64, 1.3.3"\n\nopen System.IO\nopen LibSassHost\n\nlet compileSassFile =\n  let _compileSassFile (filePath: string) =\n    let filename = Path.GetFileName(filePath)\n    let result = SassCompiler.Compile(File.ReadAllText(filePath))\n    [|filename; result.CompiledContent |]\n```\n\nIn this file we\'re able to provide a function that when given a file path, it will try to compile a `.scss` file into it\'s `.css` equivalent, to be able to execute that in Perla, we need a module that does somewhat like this:\n\n```fsharp\n#r "nuget: FSharp.Compiler.Service, 41.0.1"\n\nopen System\nopen System.IO\nopen FSharp.Compiler.Interactive.Shell\n\nmodule ScriptedContent =\n\n    let tryGetSassPluginFunction (content: string): (string -> string) option =\n        let defConfig =\n            FsiEvaluationSession.GetDefaultConfiguration()\n\n        let argv =\n            [| "fsi.exe"\n               "--noninteractive"\n               "--nologo"\n               "--gui-" |]\n\n        use stdIn = new StringReader("")\n        use stdOut = new StringWriter()\n        use stdErr = new StringWriter()\n\n        use session =\n            FsiEvaluationSession.Create(defConfig, argv, stdIn, stdOut, stdErr, true)\n        session.EvalInteractionNonThrowing(content) |> ignore\n\n        match session.TryFindBoundValue "compileSassFile" with\n        | Some bound ->\n            // If there\'s a value with that name on the script try to grab it\n            match bound.Value.ReflectionValue with\n            // ensure it fits the signature we are expecting\n            | :? FSharpFunc<string, string> as compileSassFile ->\n              Some compileSassFile\n            | _ -> None\n        | None -> None\n\nlet content = File.ReadAllText("./path/to/sass-plugin.fsx")\n// this is where it get\'s nice, we can also fetch the scritps from the cloud\n// let! content = Http.getFromGithub("AngelMunoz/Perla.Sass")\nmatch ScriptedContent.tryGetSassPluginFunction(content) with\n| Some plugin ->\n  let css = plugin "./path/to/file.scss"\n  printfn $"Resulting CSS:\\n{css}"\n| None -> printfn "No plugin was found on the script"\n```\n\nThis is more-less what I have in mind, it has a few downsides though\n\n- Convention based naming\n- Badly written plugins might leak memory or make Perla\'s performance to slow down\n- Script distribution is a real concern, there\'s no clear way to do it as of now\n- Security concerns when executing code with Perla\'s permissions on the user\'s behalf\n\nAnd many others that I might not be looking after.\n\nBeing able to author plugins and process any kind of file into something Perla can use to enhance the consumer experience is just worth it though, for example just look at the vast amount of webpack and vite plugins. The use cases are there for anyone to fulfill them .\n\n### HMR\n\nThis is the golden apple I\'m not entirely sure how to tackle...\n[There\'s an HMR spec] that I will follow for that since that\'s what snowpack/vite\'s HMR is based on, libraries like [Fable.Lit], or [Elmish.HMR] are working towards being compatible with vite\'s HMR, so if Perla can make it work like them, then we won\'t even need to write any specific code for Perla.\n\nI can talk however of CSS HMR, This is a pretty simple change to support given that CSS changes are automatically propagated in the browser, it basically does half of the HMR for us.\n\nPerla does the following:\n\n- Sees `import "./app.css`\n- Runs the `cssImport` middleware function I hinted at earlier and returns a ~CSS~ Javascript file that injects a script tag on the head of the page.\n\n```fsharp\n  let cssImport\n    (mountedDirs: Map<string, string>)\n    (ctx: HttpContext)\n    (next: Func<Task>)\n    =\n    task {\n      // skip non-css files\n      if ctx.Request.Path.Value.Contains(".css") |> not then\n        return! next.Invoke()\n      else\n\n        let logger = ctx.GetLogger("Perla Middleware")\n        let path = ctx.Request.Path.Value\n\n        let baseDir, baseName =\n          mountedDirs\n          |> Map.filter (fun _ v -> String.IsNullOrWhiteSpace v |> not)\n          |> Map.toSeq\n          |> Seq.find (fun (_, v) -> path.StartsWith(v))\n\n        let filePath =\n          let fileName =\n            path.Replace($"{baseName}/", "", StringComparison.InvariantCulture)\n\n          Path.Combine(baseDir, fileName)\n\n        logger.LogInformation("Transforming CSS")\n\n        let! content = File.ReadAllTextAsync(filePath)\n        // return the JS code to insert the CSS content in a style tag\n        let newContent =\n          $"""\nconst css = `{content}`\nconst style = document.createElement(\'style\')\nstyle.innerHTML = css\nstyle.setAttribute("filename", "{filePath}");\ndocument.head.appendChild(style)"""\n\n        ctx.SetContentType "text/javascript"\n        do! ctx.WriteStringAsync newContent :> Task\n    }\n    :> Task\n```\n\nIn the SSE handler function we observe for file changes in disk and depending on the content we do the corresponding update\n\n```fsharp\nwatcher.FileChanged\n|> Observable.map (fun event ->\n  task {\n    match Path.GetExtension event.name with\n    | Css ->\n      // a CSS file was changed, read all of the content\n      let! content = File.ReadAllTextAsync event.path\n\n      let data =\n        Json.ToTextMinified(\n          {| oldName =\n              event.oldName\n              |> Option.map (fun value ->\n                match value with\n                | Css -> value\n                | _ -> "")\n              name = event.path\n              content = content |}\n        )\n      // Send the SSE Message to the client with the new CSS content\n      do! res.WriteAsync $"event:replace-css\\ndata:{data}\\n\\n"\n      return! res.Body.FlushAsync()\n    | Typescript\n    | Javascript\n    | Jsx\n    | Json\n    | Other _ -> //... other content ...\n  })\n|> Observable.switchTask\n|> Observable.subscribe ignore\n```\n\nTo handle these updates we use two cool things, [WebWorkers] and a simple scripts, the live reload script has this content\n\n```javascript\n// initiate worker\nconst worker = new Worker("/~perla~/worker.js");\n// connect to the SSE endpoint\nworker.postMessage({ event: "connect" });\n\nfunction replaceCssContent({ oldName, name, content }) {\n  const css = content?.replace(/(?:\\\\r\\\\n|\\\\r|\\\\n)/g, "\\n") || "";\n  const findBy = oldName || name;\n\n  // find the style tag with the particular name\n  const style = document.querySelector(`[filename="${findBy}"]`);\n  if (!style) {\n    console.warn("Unable to find", oldName, name);\n    return;\n  }\n  // replace the content\n  style.innerHTML = css;\n  style.setAttribute("filename", name);\n}\n\nfunction showOverlay({ error }) {\n  console.log("show overlay");\n}\n\n// react to the worker messages\nworker.addEventListener("message", function ({ data }) {\n  switch (data?.event) {\n    case "reload":\n      return window.location.reload();\n    case "replace-css":\n      return replaceCssContent(data);\n    case "compile-err":\n      return showOverlay(data);\n    default:\n      return console.log("Unknown message:", data);\n  }\n});\n```\n\nInside our Worker the code is very very similar\n\n```javascript\nlet source;\n\nconst tryParse = (string) => {\n  try {\n    return JSON.parse(string) || {};\n  } catch (err) {\n    return {};\n  }\n};\n\nfunction connectToSource() {\n  if (source) return;\n  //connect to the SSE endpoint\n  source = new EventSource("/~perla~/sse");\n  source.addEventListener("open", function (event) {\n    console.log("Connected");\n  });\n  // react to file reloads\n  source.addEventListener("reload", function (event) {\n    console.log("Reloading, file changed: ", event.data);\n    self.postMessage({\n      event: "reload",\n    });\n  });\n  // if the server sends a `replace-css` event\n  // notify the main thread about it\n  // Yes! web workers run on background threads!\n  source.addEventListener("replace-css", function (event) {\n    const { oldName, name, content } = tryParse(event.data);\n    console.log(`Css Changed: ${oldName ? oldName : name}`);\n    self.postMessage({\n      event: "replace-css",\n      oldName,\n      name,\n      content,\n    });\n  });\n\n  source.addEventListener("compile-err", function (event) {\n    const { error } = tryParse(event.data);\n    console.error(error);\n    self.postMessage({\n      event: "compile-err",\n      error,\n    });\n  });\n}\n\nself.addEventListener("message", function ({ data }) {\n  if (data?.event === "connect") {\n    connectToSource();\n  }\n});\n```\n\nAnd that\'s how the CSS HMR works in Perla and it is instant, in less than a blink of an eye! Well... maybe not but pretty close to it.\n\nFor the JS side I\'m still not sure how this will work given that I might need to have a mapping in both sides of the files I have and what is their current version.\n\n## What\'s next?\n\nWhew! That was a lot! but shows how to build each part of the Webpack alternative I\'ve been working on Called [Perla] there are still some gaps though\n\n- Project Scaffolding\n\n  This will be an important step for adoption I believe, generating certain files, or even starter projects to reduce the onboarding complexity is vital, so this is likely the next step for me (even before the HMR)\n\n- Unit/E2E Testing\n\n  Node based test runners won\'t work naturally since we\'re not using node! So this is an area to investigate, for E2E I already have the thought of using playwright, for unit tests I\'m not sure yet but I guess I\'d be able to pick something similar or simply have a test framework that runs entirely on the browser.\n\n- Import map ergonomics\n\n  Some times, you must edit by hand the import map (`perla.jsonc.lock`) to get dependencies like `import fp from \'lodash/fp\'` with the import maps the browser knows what to do with `lodash` but not `lodash/fp` so an edit must be made, this requires you to understand how these dependencies work and how you need to write the import map, it\'s an area I\'d love to make as simple as possible\n\n- Typescript Types for dependencies\n\n  Typescript (and related Editors/IDEs like vscode and webstorm) rely on the presence of node_modules to pick typings from disk, It would be nice if typescript worked with the URI style imports for typings that would fix a lot of issues.\n\n- Library/Build only mode\n\n  There might be certain cases where you would like to author a library either for you and your team, perhaps you only need the JS files and a package.json to share the sources, while not a priority it\'s something it\'s worth looking at.\n\n- Improve the _Install_ story\n\n  The goal is run a single line command, get your stuff installed in place regardless of if you have .NET or not\n\n## Closing thoughts...\n\nSo those are some of the things I might have on my plate for next, of course if I receive feedback on this project I may prioritize some things over the others but rather than doing it all for myself, I wish to share this and make it a community effort to continue to improve the Frontend tooling story that doesn\'t rely on complex patterns and extremely weird and cryptic errors, hundreds of hours spent in configuration, something as simple that you feel confident enough to trust and use :)\n> by the way, this is the repository in question :) \n> {% github AngelMunoz/Perla %}\n\nAnd with all due respect, I really thank the maintainers of snowpack,esbuild, and vite who make an incredible job at reducing the complexity of frontend tooling as well, they inspired me AND if you\'re a loving node user please look at their projects ditch webpack enough so they also reflect back and simplify their setups!\n\nFor the .NET community I wish to spark a little of interest to look outside and build tooling for other communities, I think it is a really nice way to introduce .NET with the rest of the world and new devs be it with F#, C# or VB, I think .NET is an amazing platform for that. This has been a really good learning exercise and at the same time a project I believe in so, I will try to spend more time and push it to as much as I can.\n\nI\'ll see you on the next one :)\n',n.user={name:"Angel Daniel Munoz Gonzalez",username:"tunaxor",twitter_username:"angel_d_munoz",github_username:"AngelMunoz",website_url:"https://blog.tunaxor.me",profile_image:"https://res.cloudinary.com/practicaldev/image/fetch/s--NpYP9EQw--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/35800/b392acdc-d3fc-4ab0-a1cc-4d200e1a4582.jpg",profile_image_90:"https://res.cloudinary.com/practicaldev/image/fetch/s--Rgq5VG2S--/c_fill,f_auto,fl_progressive,h_90,q_auto,w_90/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/35800/b392acdc-d3fc-4ab0-a1cc-4d200e1a4582.jpg"},{layout:"default",data:[{}],fetch:{"data-v-70afb46a:0":{article:n}},error:s,state:{currentArticle:n},serverRendered:!0,routePath:"/tunaxor/902440",config:{_app:{basePath:"/nuxtstop/",assetsPath:"/nuxtstop/_nuxt/",cdnURL:s}}}}(null,{},"2021-12-17T01:18:58Z")</script><script src="/nuxtstop/_nuxt/f6e87fb.js" defer></script><script src="/nuxtstop/_nuxt/dc9ce94.js" defer></script><script src="/nuxtstop/_nuxt/6474719.js" defer></script><script src="/nuxtstop/_nuxt/9b75090.js" defer></script><script src="/nuxtstop/_nuxt/18df600.js" defer></script>
  </body>
</html>
