<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Implementing Blue/Green Deployments with Azure Web Apps for Containers</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="Using Nuxt.js fetch() hook to build dev.to with a new look"><meta data-n-head="ssr" name="format-detection" content="telephone=no"><base href="/nuxtstop/"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,500,600&display=swap"><link rel="preload" href="/nuxtstop/_nuxt/f6e87fb.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/6474719.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/9b75090.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/18df600.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/dc9ce94.js" as="script"><style data-vue-ssr-id="c650fd98:0 af4684f0:0 a9c71758:0 dcafa518:0 4b9cec49:0 b093d766:0 9d98bcb4:0 6b6a11ea:0 0248ed80:0 ea8e4264:0">html{box-sizing:border-box;font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}*,:after,:before{box-sizing:inherit}html{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}*,:after,:before{border:0 solid #e0e0e0}blockquote,body,dd,dl,figure,h1,h2,h3,h4,h5,h6,p,pre{margin:0}button{background:0 0;padding:0}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}hr{border-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:inherit;opacity:.5}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:inherit;opacity:.5}input::placeholder,textarea::placeholder{color:inherit;opacity:.5}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit;font-family:sans-serif}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit;font-family:inherit;font-size:100%}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;overflow:auto;word-break:break-word;white-space:normal}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}html{height:100%;font-size:18px;-ms-overflow-style:scrollbar;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}@media(min-width:640px){html{font-size:20px}}body{height:100%;min-width:320px;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:400;line-height:1.5;color:#000;background-color:#eff4f7;-webkit-text-rendering:optimizeLegibility;text-rendering:optimizeLegibility;font-synthesis:none;font-kerning:normal;font-feature-settings:"normal","kern";-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-overflow-scrolling:touch;overflow-x:hidden;overflow-y:scroll}h1,h2,h3,h4,h5,h6{color:#000;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:600;font-feature-settings:"normal";line-height:1.2}pre{background:#29292e;border-radius:2px;overflow:auto;padding:1rem;color:#eff1f9;line-height:1.42em;font-size:13px}@media screen and (min-width:380px){pre{font-size:15px}}pre code{background:#29292e;color:#eff0f9;white-space:pre}div.highlight pre.highlight code{font-size:inherit;padding:0}div.inner-comment div.body div.highlight pre.highlight{background:#29292e}div.inner-comment div.body div.highlight pre.highlight code{font-size:inherit;white-space:inherit;background:inherit;color:inherit}.highlight .hll{background-color:#49483e}.highlight{background:#29292e;color:#f8f8f2}.highlight .c{color:grey}.highlight .err{text-shadow:0 0 7px #f9690e}.highlight .k{color:#f39c12}.highlight .l{color:plum}.highlight .n{color:#f8f8f2}.highlight .o{color:#f9690e}.highlight .p{color:#f8f8f2}.highlight .c1,.highlight .ch,.highlight .cm,.highlight .cp,.highlight .cpf,.highlight .cs{color:grey}.highlight .gd{color:#f9690e}.highlight .ge{font-style:italic}.highlight .gi{color:#7ed07e}.highlight .gs{font-weight:700}.highlight .gu{color:grey}.highlight .kc,.highlight .kd{color:#f39c12}.highlight .kn{color:#f9690e}.highlight .kp,.highlight .kr,.highlight .kt{color:#f39c12}.highlight .ld{color:#f2ca27}.highlight .m{color:plum}.highlight .s{color:#f2ca27}.highlight .na{color:#7ed07e}.highlight .nb{color:#f8f8f2}.highlight .nc{color:#7ed07e}.highlight .no{color:#f39c12}.highlight .nd{color:#7ed07e}.highlight .ni{color:#f8f8f2}.highlight .ne,.highlight .nf{color:#7ed07e}.highlight .nl,.highlight .nn{color:#f8f8f2}.highlight .nx{color:#7ed07e}.highlight .py{color:#f8f8f2}.highlight .nt{color:#f9690e}.highlight .nv{color:#f8f8f2}.highlight .ow{color:#f9690e}.highlight .w{color:#f8f8f2}.highlight .mb,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo{color:plum}.highlight .dl,.highlight .s2,.highlight .sa,.highlight .sb,.highlight .sc,.highlight .sd{color:#f2ca27}.highlight .se{color:plum}.highlight .s1,.highlight .sh,.highlight .si,.highlight .sr,.highlight .ss,.highlight .sx{color:#f2ca27}.highlight .bp{color:#f8f8f2}.highlight .fm{color:#7ed07e}.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{color:#f8f8f2}.highlight .il{color:plum}.vue-content-placeholders-heading__img,.vue-content-placeholders-heading__subtitle,.vue-content-placeholders-heading__title,.vue-content-placeholders-img,.vue-content-placeholders-text__line{background:#bfcdec!important}.vue-content-placeholders-is-animated .vue-content-placeholders-heading__img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__subtitle:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__title:before,.vue-content-placeholders-is-animated .vue-content-placeholders-img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-text__line:before{background:linear-gradient(90deg,transparent 0,#d3ddf9 15%,transparent 30%)!important}header[data-v-27046cca]{max-width:1280px;margin:auto;padding:1rem;height:6rem;border-bottom:1px solid rgba(0,0,0,.2)}header .logo-wrapper[data-v-27046cca],header[data-v-27046cca]{display:flex;align-items:center;justify-content:space-between}header .logo-wrapper[data-v-27046cca]{margin:0 .5rem}header .logo-wrapper svg[data-v-27046cca]{width:3rem;height:100%}header .logo-wrapper .name-wrapper[data-v-27046cca]{margin-left:.6em}header .logo-wrapper .name-wrapper .subtitle[data-v-27046cca]{font-size:1rem}header .logo-wrapper .name-wrapper .app-name[data-v-27046cca]{font-weight:700;font-size:2.25rem;line-height:1.25}header nav[data-v-27046cca]{letter-spacing:-.025rem;font-weight:600;text-transform:uppercase}header nav ul[data-v-27046cca]{display:flex}header nav ul li[data-v-27046cca]{margin:0 .5rem}header nav ul li a[data-v-27046cca]{box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;padding:.25rem 1rem;border-radius:.5rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}header nav ul li a[data-v-27046cca]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header nav ul li a.nuxt-link-exact-active[data-v-27046cca]{cursor:default}header nav ul li a.nuxt-link-exact-active[data-v-27046cca],header nav ul li a[data-v-27046cca]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}.page-wrapper[data-v-10d06ee8]{max-width:1280px;margin:auto;padding:1rem}.article-content-wrapper[data-v-10d06ee8]{display:flex;flex-direction:column;align-items:center;margin:auto auto 2rem}@media(min-width:1024px){.article-content-wrapper[data-v-10d06ee8]{align-items:normal;flex-direction:row}}.article-content-wrapper .article-block[data-v-10d06ee8]{width:100%;max-width:880px}@media(min-width:1024px){.article-content-wrapper .article-block[data-v-10d06ee8]{margin-right:1rem;width:66.66666%;margin-bottom:2rem}}.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{max-width:880px;width:100%;position:relative}@media(min-width:1024px){.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{display:block;width:33.33333%}}.article-content-wrapper .aside-username-wrapper .aside-username-block[data-v-10d06ee8]{position:-webkit-sticky;position:sticky;top:1rem}@media(min-width:1280px){.comments-block[data-v-10d06ee8]{margin:.5rem}}article[data-v-70afb46a]{padding:.5rem;border-radius:1rem}header h1[data-v-70afb46a],header[data-v-70afb46a]{margin-bottom:1rem}header h1[data-v-70afb46a]{font-size:2.25rem;letter-spacing:-.025rem}header .tags[data-v-70afb46a]{display:flex;flex-wrap:wrap;margin-bottom:1.5rem}header .tags .tag[data-v-70afb46a]{font-weight:500;line-height:1;padding:.5rem;margin:0 .5rem .5rem 0;border-radius:.25rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db}header .tags .tag[data-v-70afb46a]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header .tags .tag[data-v-70afb46a]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}header .image-wrapper[data-v-70afb46a]{position:relative;padding-bottom:56.25%;background-color:#d4dfe8;margin-bottom:1.5rem;border-radius:.5rem;overflow:hidden}@media(min-width:834px){header .image-wrapper[data-v-70afb46a]{margin-bottom:1.5rem}}header .image-wrapper img[data-v-70afb46a]{position:absolute;top:0;left:0;width:100%;height:100%;-o-object-fit:cover;object-fit:cover}header .meta[data-v-70afb46a]{line-height:1;font-size:.875rem;text-transform:uppercase;font-weight:500;letter-spacing:-.025rem;display:flex;align-items:center;justify-content:space-between}header .meta .scl[data-v-70afb46a]{display:flex}header .meta .scl span[data-v-70afb46a]{display:flex;align-items:center;margin-right:1rem}header .meta .scl span svg[data-v-70afb46a]{margin-right:.25rem}header .meta .scl .comments[data-v-70afb46a]{cursor:pointer}[data-v-70afb46a] .content .ltag__user{display:none}[data-v-70afb46a] .content iframe{max-width:100%}[data-v-70afb46a] .content h1{font-size:1.875rem}[data-v-70afb46a] .content h1,[data-v-70afb46a] .content h2{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h2{font-size:1.5rem}[data-v-70afb46a] .content h3{font-size:1.25rem}[data-v-70afb46a] .content h3,[data-v-70afb46a] .content h4{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h4{font-size:1rem}[data-v-70afb46a] .content a{color:#6e87d2}[data-v-70afb46a] .content p{margin-bottom:1rem;line-height:1.4}[data-v-70afb46a] .content p code{background-color:#d2f3e1;border-radius:.25rem;padding:.25rem}[data-v-70afb46a] .content img{width:100%;border-radius:.5rem}[data-v-70afb46a] .content .highlight{margin-bottom:1rem;border-radius:.5rem}[data-v-70afb46a] .content ul{list-style:numeral;margin-bottom:1rem}[data-v-70afb46a] .content ul li p{margin-bottom:0}[data-v-70afb46a] .content ol{margin-bottom:1rem}aside[data-v-37984f8c]{padding:1rem;background-color:#dfe8ef;border-radius:1rem}aside .username-heading[data-v-37984f8c]{display:flex;margin-bottom:1rem}aside .username-heading[data-v-37984f8c]:hover{color:#6e87d2}aside .username-heading img[data-v-37984f8c]{width:3rem;height:3rem;border-radius:50%;margin-right:1rem}aside .username-heading .text[data-v-37984f8c]{display:flex;flex-direction:column;justify-content:center}aside .username-heading .text a[data-v-37984f8c]{line-height:1}aside .username-heading .text a[data-v-37984f8c]:first-child{font-size:1.25rem;font-weight:500;letter-spacing:-.025rem;margin-bottom:.25rem}aside .username-heading .text a[data-v-37984f8c]:last-child{color:#999;font-size:.875rem}aside .username-heading.loading[data-v-37984f8c]{display:block}aside .f-button[data-v-37984f8c]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}aside .f-button[data-v-37984f8c]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}aside .f-button[data-v-37984f8c]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}aside .info>div[data-v-37984f8c]{margin-bottom:.5rem}aside .info .title[data-v-37984f8c]{font-size:.666666rem;letter-spacing:-.0125rem;font-weight:500;color:#999;text-transform:uppercase;margin-bottom:.1rem}aside .info .content[data-v-37984f8c]{font-size:.875rem;line-height:1.4}.add-comment[data-v-8c4375bc]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}.add-comment[data-v-8c4375bc]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}.add-comment[data-v-8c4375bc]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}footer[data-v-22cb8fd0]{padding:2rem;text-align:center;display:flex;align-items:center;justify-content:center}footer span[data-v-22cb8fd0]{display:inline-block;line-height:1;text-transform:uppercase;letter-spacing:-.025rem;font-size:.75rem;font-weight:500}footer a svg[data-v-22cb8fd0]{width:3rem;height:3rem;margin:0 .5rem}footer a .nuxt-icon[data-v-22cb8fd0]{width:2.5rem;height:2.5rem;margin:0 .25rem}</style>
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><div id="__layout"><div><header data-v-27046cca><a href="/nuxtstop/" class="logo-wrapper nuxt-link-active" data-v-27046cca><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-27046cca><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-27046cca></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-27046cca></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-27046cca></path></svg> <div class="name-wrapper" data-v-27046cca><span class="app-name" data-v-27046cca>Nuxtstop</span> <p class="subtitle" data-v-27046cca>For all things nuxt.js</p></div></a> <nav data-v-27046cca><ul data-v-27046cca><li data-v-27046cca><a href="/nuxtstop/" class="nuxt-link-active" data-v-27046cca>
          New
        </a></li><li data-v-27046cca><a href="/nuxtstop/top" data-v-27046cca>
          Top
        </a></li></ul></nav></header> <div class="page-wrapper" data-v-10d06ee8><div class="article-content-wrapper" data-v-10d06ee8><article data-fetch-key="data-v-70afb46a:0" class="article-block" data-v-70afb46a data-v-10d06ee8><header data-v-70afb46a><h1 data-v-70afb46a>Implementing Blue/Green Deployments with Azure Web Apps for Containers</h1> <div class="tags" data-v-70afb46a><a href="/nuxtstop/t/azure" class="tag" data-v-70afb46a>
          #azure
        </a><a href="/nuxtstop/t/containers" class="tag" data-v-70afb46a>
          #containers
        </a><a href="/nuxtstop/t/tutorial" class="tag" data-v-70afb46a>
          #tutorial
        </a><a href="/nuxtstop/t/docker" class="tag" data-v-70afb46a>
          #docker
        </a></div> <div class="image-wrapper" data-v-70afb46a><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--WHgXst6p--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/9nj9q3w4tuyzim17p9nu.png" alt="Implementing Blue/Green Deployments with Azure Web Apps for Containers" data-v-70afb46a></div> <div class="meta" data-v-70afb46a><div class="scl" data-v-70afb46a><span data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M16.4444 3C14.6733 3 13.0333 3.94162 12 5.34C10.9667 3.94162 9.32667 3 7.55556 3C4.49222 3 2 5.52338 2 8.625C2 14.8024 11.0267 20.586 11.4122 20.829C11.5922 20.9426 11.7956 21 12 21C12.2044 21 12.4078 20.9426 12.5878 20.829C12.9733 20.586 22 14.8024 22 8.625C22 5.52338 19.5078 3 16.4444 3Z" fill="#FF0000" data-v-70afb46a data-v-70afb46a></path></svg>
            14
          </span> <span class="comments" data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M6.11765 22H4.94118L5.64706 21.05C6.11765 20.3969 6.41176 19.5656 6.58824 18.5563C3.64706 17.1906 2 14.6375 2 11.3125C2 6.20625 5.82353 3 12 3C18.1765 3 22 6.20625 22 11.3125C22 16.5375 18.2353 19.625 12 19.625H11.5882C10.6471 20.7531 9 22 6.11765 22ZM12 4.1875C6.47059 4.1875 3.17647 6.85937 3.17647 11.3125C3.17647 15.1125 5.47059 16.8938 7.41177 17.6656L7.82353 17.8437L7.76471 18.3187C7.64706 19.2687 7.47059 20.1 7.11765 20.8125C9.05882 20.575 10.1765 19.5656 10.8235 18.7344L11 18.4969H12C19.9412 18.4969 20.8235 13.5094 20.8235 11.3719C20.8235 6.85938 17.5294 4.1875 12 4.1875Z" fill="black" data-v-70afb46a data-v-70afb46a></path></svg>
            0
          </span></div> <time data-v-70afb46a>Feb 26</time></div></header> <div class="content" data-v-70afb46a><p>Application uptime is critical for our cloud applications. Using Azure App Service slots, we can implement the Blue/Green deployment pattern to validate that new versions of our application will perform as expected in a production environment, without causing downtime to our existing version of our application. With App Service slots, we can deploy new versions of our container images to our Green slot, run tests against that slot to ensure that everything is working and then direct incoming traffic to our updated container image.</p>

<p>In this article, I'll explain what Blue/Green Deployments are and show you how can implement Blue/Green deployments for your App Services that host your containers. This includes:</p>

<ul>
<li>Creating our Azure resources with Bicep.</li>
<li>Deploying our resources with GitHub Actions.</li>
<li>Pushing our container image to Azure Container Registry.</li>
<li>Pulling our container image into our App Service Blue Slot.</li>
<li>Swapping from the Blue slot into our Green Slot.</li>
</ul>

<p>Throughout this article, I'll be referring to code that you can find in this GitHub <a href="https://github.com/willvelida/azure-apps-for-containers-bluegreen-poc">repo</a>. If you want to follow along, or use that repo as a base for experimenting with Blue/Green deployments with App Service, please feel free to fork it and have a play around with it! If you see something wrong or want to make an improvement to it, PRs are welcome! 😊</p>

<h2>
  <a name="what-are-bluegreen-deployments" href="#what-are-bluegreen-deployments">
  </a>
  What are Blue/Green Deployments?
</h2>

<p>As I mentioned, ensuring that our applications are highly available is critical for applications running in the cloud. There are a couple of strategies that we can implement to ensure HA for our apps, such as spinning up our application in a different region in case of a regional-disaster affecting the datacenter where our app is hosted or using high availability configurations. With both of these options, there are time and cost implications that we would need to consider.</p>

<p>We can ensure high availability when deploying our application. With Blue/Green deployments, we can deploy a new version of our application next to the existing one.</p>

<p>Imagine you're working on an application and you build a container image that packages the new version of your app. With Blue/Green deployments, we can deploy the new image to the Blue slot alongside our Green slot. Production traffic is still being routed to Green slot, but now that our new version has been deployed to the Blue slot, we can run tests against the Blue slot in a production environment to ensure that the new image works as expected. If everything works, we can swap the image from the blue slot to the green slot, redirecting our production traffic to our new image, which happens with no visible downtime for our users. </p>

<p>Should anything not work as expected, we can abandon the deployment of our new container image without affecting our users, since traffic will be redirected to our green slot containing our exiting image.</p>

<p>In Azure App Service, we can set up staging environments using deployment slots. By using Blue/Green deployments, we can warm up instances in a slot before we swap slots to production traffic, eliminating downtime for our application.</p>

<p>Please note, that your App Service Plan must be either at the <strong>Standard</strong>, <strong>Premium</strong> or <strong>Isolated</strong> tier. </p>

<h2>
  <a name="preparing-our-infrastructure" href="#preparing-our-infrastructure">
  </a>
  Preparing our infrastructure
</h2>

<p>Let's start off by setting up our infrastructure pipeline. Here, I want to create my App Service that has both a blue and green slot, an Azure Container Registry to store my images, then I want to be able to deploy my Bicep template using GitHub Actions.</p>

<h3>
  <a name="creating-our-azure-resources" href="#creating-our-azure-resources">
  </a>
  Creating our Azure Resources
</h3>

<p>First, let's create the Azure Container Registry that we need to store our container images. We can do this in Bicep like so:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>param registryName string
param registryLocation string
param registrySku string

resource containerRegistry 'Microsoft.ContainerRegistry/registries@2021-09-01' = {
  name: registryName
  location: registryLocation
  sku: {
    name: registrySku
  }
  identity: {
    type: 'SystemAssigned'
  }
}
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Here, we're giving our container registry a name, location and sku which we will pass through as parameters.</p>

<p>The important thing to note here is that we're creating a <a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-authentication-managed-identity">System Assigned Managed Identity for our Container Registry</a>. So rather than enabling admin access on this Container Registry, we'll be using a managed identity for our ACR which will allow us to assign permissions and roles for the ACR without having to supply registry credentials. </p>

<p>There are a number of ways that we can authenticate with Azure Container Registry, so I'd encourage you to check <a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-authentication?tabs=azure-cli">this guide</a> out to see what options are best for your scenario.</p>

<p>Next up. we'll create our App Service Plan. To do this, we can write the following Bicep code:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>param appServicePlanName string
param appServicePlanLocation string
param appServicePlanSkuName string
param appServicePlanCapacity int

resource appServicePlan 'Microsoft.Web/serverfarms@2021-02-01' = {
  name: appServicePlanName
  location: appServicePlanLocation
  sku: {
    name: appServicePlanSkuName
    capacity: appServicePlanCapacity
  }
  kind: 'linux'
  properties: {
    reserved: true
  }
}

output appServicePlanId string = appServicePlan.id
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>We're running our containers on Linux, so we'll need to provision a Linux App Service Plan. I've parameterized the App Plan Sku name, but as I mentioned before, deployment slots are only available at <strong>Standard</strong> or above plan. Since we're provisioning a Linux plan, we'll need to set the <code>reserved</code> property to true.</p>

<p>To see the full Bicep reference template for App Service Plans, check out this <a href="https://docs.microsoft.com/en-us/azure/templates/microsoft.web/2019-08-01/serverfarms?tabs=bicep">page</a>.</p>

<p>With our App Plan template complete, we can start to create our Bicep template for our App Service with both Blue and Green slots.</p>

<p>Here is our full Bicep file for our App Service. Don't worry! we will break this down:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>@description('Name of the app service plan')
param appServiceName string

@description('Location of the app service plan')
param appServiceLocation string

@description('Name of the slot that we want to create in our App Service')
param appServiceSlotName string

@description('The Server Farm Id for our App Plan')
param serverFarmId string

@description('Name of the Azure Container Registry that this App will pull images from')
param acrName string

@description('The docker image and tag')
param dockerImageAndTag string = '/hellobluegreenwebapp:latest'

// This is the ACR Pull Role Definition Id: https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#acrpull
var acrPullRoleDefinitionId = subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')

var appSettings = [
  {
    name: 'WEBSITES_ENABLE_APP_SERVICE_STORAGE'
    value: 'false'
  }
  {
    name: 'WEBSITES_PORT'
    value: '80'
  }
  {
    name: 'DOCKER_REGISTRY_SERVER_URL'
    value: 'https://${containerRegistry.properties.loginServer}'
  }
]

resource containerRegistry 'Microsoft.ContainerRegistry/registries@2021-09-01' existing = {
  name: acrName
}

resource appService 'Microsoft.Web/sites@2021-02-01' = {
  name: appServiceName
  location: appServiceLocation
  kind: 'app,linux,container'
  properties: {
    serverFarmId: serverFarmId
    siteConfig: {
      appSettings: appSettings
      acrUseManagedIdentityCreds: true
      linuxFxVersion: 'DOCKER|${containerRegistry.properties.loginServer}/${dockerImageAndTag}'
    }
  }
  identity: {
    type: 'SystemAssigned'
  }

  resource blueSlot 'slots' = {
    name: appServiceSlotName
    location: appServiceLocation
    kind: 'app,linux,container'
    properties: {
      serverFarmId: serverFarmId
      siteConfig: {
        acrUseManagedIdentityCreds: true
        appSettings: appSettings
      }
    }
    identity: {
      type: 'SystemAssigned'
    }
  }
}

resource appServiceAcrPullRoleAssignment 'Microsoft.Authorization/roleAssignments@2020-08-01-preview' = {
  scope: containerRegistry
  name: guid(containerRegistry.id, appService.id, acrPullRoleDefinitionId)
  properties: {
    principalId: appService.identity.principalId
    roleDefinitionId: acrPullRoleDefinitionId
    principalType: 'ServicePrincipal'
  }
}

resource appServiceSlotAcrPullRoleAssignment 'Microsoft.Authorization/roleAssignments@2020-08-01-preview' = {
  scope: containerRegistry
  name: guid(containerRegistry.id, appService::blueSlot.id, acrPullRoleDefinitionId)
  properties: {
    principalId: appService::blueSlot.identity.principalId
    roleDefinitionId: acrPullRoleDefinitionId
    principalType: 'ServicePrincipal'
  }
}
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<ul>
<li>Let's start with our parameters. We'll need to import both the App Service Plan and the Docker Registry into this Bicep file, so I've added some parameters that we can use in the template. This may be scope creep for this tutorial, but say we have Container Registries across our different environments (DEV, UAT, Prod) and different app service plans, we can provision new App Services that use our different resources across our different environments taking this approach.</li>
<li>We then create a variable for our <em>AcrPull</em> role definition. We do this by getting the unique identifier for a resource using the

<code>subscriptionResourceId</code>

<a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/template-functions-resource#subscriptionresourceid">function</a>.
- We create another variable for our App Settings. For our example, both our Blue and Green slot will need to have the same app settings. We could use different app settings for our slots if we needed/wanted to, but for simplicity, I've created a variable and applied them to both slots just so I don't have to repeat myself.
- Our Container Registry needs to be imported so I can reference it in our App Service. All we need to do here is to create a resource block for our Container Registry and use the keyword <code>existing</code>. We reference the name of our registry using a parameter.</li>
</ul>

<p>For our App Service, we give it a name and location. We also need to provide the following information:</p>

<ul>
<li>First we set the <code>kind</code> property to <code>app,linux,container</code>. This tells the App Service that we want to host Linux Containers.</li>
<li>In the properties section, we set the <code>serverFarmId</code> to the Id of our Server Farm. We're setting this as a parameter, so if we wanted to use this module for other App Services, we could deploy it to another App Service Plan.</li>
<li>For our site config section, we set the <code>appSettings</code> to the App Settings we defined earlier, the <code>acrUseManagedIdentityCreds</code> property tells the App Service that we want to use the managed identity credentials to pull images from our container registry. We finally set the <code>linuxFxVersion</code> to <code>DOCKER|${containerRegistry.properties.loginServer}/${dockerImageAndTag}</code>. This sets the Linux App Framework and version.</li>
<li>We finally create a System Managed Identity for this App Service and the Blue slot. We'll need this for our role assignments.</li>
</ul>

<p>We then create two role assignments that allow our App Service Blue and Green slot to pull images from our container registry. The <code>roleDefinitionId</code> uses the <em>AcrPull</em> role definition we defined in our variable at the start, and the <code>scope</code> property assigns this role to the App Service over our Azure Container Registry. </p>

<p>To learn more about how we can create role assignments using Bicep, check out this <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/scenarios-rbac">article</a>.</p>

<p>With our modules created, we can now write up our <code>main.bicep</code> file like so:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>param webAppName string = uniqueString(resourceGroup().id)
param acrName string = toLower('acr${webAppName}')
param acrSku string
param appServicePlanName string = toLower('asp-${webAppName}')
param appServiceName string = toLower('asp-${webAppName}')
param appServicePlanSkuName string
param appServicePlanInstanceCount int

var appServiceSlotName = 'blue'

param location string = resourceGroup().location

module containerRegistry 'containerRegistry.bicep' = {
  name: 'containerRegistry'
  params: {
    registryLocation: location 
    registryName: acrName
    registrySku: acrSku
  }
}

module appServicePlan 'appServicePlan.bicep' = {
  name: 'appServicePlan'
  params: {
    appServicePlanLocation: location
    appServicePlanName: appServicePlanName
    appServicePlanSkuName: appServicePlanSkuName
    appServicePlanCapacity: appServicePlanInstanceCount
  }
}

module appService 'appService.bicep' = {
  name: 'appService'
  params: {
    appServiceLocation: location 
    appServiceName: appServiceName
    serverFarmId: appServicePlan.outputs.appServicePlanId
    appServiceSlotName: appServiceSlotName
    acrName: acrName
  }
}
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>We'll also need a parameters file. We can create a <code>parameters.json</code> file like so:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight json"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"$schema"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"contentVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0.0"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"acrSku"</span><span class="p">:{</span><span class="w">
            </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Basic"</span><span class="w">   
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"appServicePlanSkuName"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"S1"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"appServicePlanInstanceCount"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<h3>
  <a name="deploying-our-resources-with-github-actions" href="#deploying-our-resources-with-github-actions">
  </a>
  Deploying our resources with GitHub Actions
</h3>

<p>Now that our Bicep code has been written, we can deploy it using GitHub Actions. Before we can do this, we'll need to set up a couple of things.</p>

<p>First let's set up a resource group that we'll deploy our resources to. We can do this by running the following AZ CLI command:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight shell"><code>az group create <span class="nt">-n</span> &lt;resource-group-name> <span class="nt">-l</span> &lt;location>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>With our resource group created, we'll need to generate a Service Principal that will allow our GitHub Action workflow to deploy resources to Azure. We can do so by running the following:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight shell"><code>az ad sp create-for-rbac <span class="nt">--name</span> yourApp <span class="nt">--role</span> owner <span class="nt">--scopes</span> /subscriptions/<span class="o">{</span>subscription-id<span class="o">}</span>/resourceGroups/exampleRG <span class="nt">--sdk-auth</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Use your resource group name and subscription Id in the command. The output of this command will generate a JSON object that you'll need to copy. It should look similar to this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight json"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"clientId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;GUID>"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"clientSecret"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;GUID>"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"subscriptionId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;GUID>"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"tenantId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;GUID>"</span><span class="p">,</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>We need to save this JSON ouput as a <strong>Secret</strong> in our GitHub repo. You can do this by selecting <strong>Settings</strong> then <strong>Secrets</strong> and clicking on <strong>New</strong> to create the secret. We'll need to create the following secrets:</p>

<div class="table-wrapper-paragraph"><table>
<thead>
<tr>
<th><strong>Secret</strong></th>
<th><strong>Value</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>RESOURCE_GROUP</td>
<td>Name of the resource group that we're deploying resources to</td>
</tr>
<tr>
<td>AZURE_CREDENTIALS</td>
<td>The entire JSON output that was generated as part of the service principal creation step</td>
</tr>
</tbody>
</table></div>

<p>Now that we have our secrets, we can create the following workflow file that will deploy our resources:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight yaml"><code><span class="na">name</span><span class="pi">:</span> <span class="s">Deploy Azure Infrastructure</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">deploy/*'</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>

<span class="na">jobs</span><span class="pi">:</span>

  <span class="na">lint</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run Bicep Linter</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">az bicep build --file ./deploy/main.bicep</span>

  <span class="na">validate</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/login@v1</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">Sign in to Azure</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">creds</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_CREDENTIALS }}</span>

      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/arm-deploy@v1</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">Run preflight validation</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">deploymentName</span><span class="pi">:</span> <span class="s">${{ github.run_number }}</span>
          <span class="na">resourceGroupName</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_RG }}</span>
          <span class="na">template</span><span class="pi">:</span> <span class="s">./deploy/main.bicep</span>
          <span class="na">parameters</span><span class="pi">:</span> <span class="s">./deploy/parameters.json</span>
          <span class="na">deploymentMode</span><span class="pi">:</span> <span class="s">Validate</span>

  <span class="na">preview</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">lint</span><span class="pi">,</span> <span class="nv">validate</span><span class="pi">]</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/login@v1</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">Sign in to Azure</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">creds</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_CREDENTIALS }}</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">Azure/cli@v1</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">Run what-if</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">inlineScript</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">az deployment group what-if --resource-group ${{ secrets.AZURE_RG }} --template-file ./deploy/main.bicep --parameters ./deploy/parameters.json</span>
  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">Dev</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="s">preview</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>

      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/login@v1</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">creds</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_CREDENTIALS }}</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Deploy Bicep File</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/arm-deploy@v1</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">subscriptionId</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_SUBSCRIPTION }}</span>
          <span class="na">resourceGroupName</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_RG }}</span>
          <span class="na">template</span><span class="pi">:</span> <span class="s">./deploy/main.bicep</span>
          <span class="na">parameters</span><span class="pi">:</span> <span class="s">./deploy/parameters.json</span>
          <span class="na">failOnStdErr</span><span class="pi">:</span> <span class="no">false</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>This file does the following:</p>

<ul>
<li>We first validate our file to ensure that it's a valid Bicep template.</li>
<li>We then run a preview job on our Bicep template to see what will be deployed as part of our workflow.</li>
<li>We then run a deploy stage that uses a manual approval step. This is done by putting the <code>environment</code> parameter in this stage. When we approve this deployment, the stage deploys our Bicep template using the parameters file to deploy our resources to Azure.</li>
</ul>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--Pt6CE8pA--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ohx45qizicipbuuy8nig.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--Pt6CE8pA--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ohx45qizicipbuuy8nig.png" alt="Our Bicep GitHub Actions Deployment Pipeline" loading="lazy" width="880" height="376"></a></p>

<p>If we head into Azure, we can see that our resources have been created:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--o2iB1W3M--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/p1pxji0jcaa4dzi3tyqu.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--o2iB1W3M--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/p1pxji0jcaa4dzi3tyqu.png" alt="Our required resources" loading="lazy" width="880" height="97"></a></p>

<h2>
  <a name="deploying-our-container-to-app-service" href="#deploying-our-container-to-app-service">
  </a>
  Deploying our container to App Service
</h2>

<p>We have our Container Registry and App Service ready to go in Azure! We just need to allow our GitHub Action to push and push images to our Azure Container Registry.</p>

<p>First, we need to get the resource Id of our container registry. We can do this by running the following command (Replace <code>&lt;registry-name></code> with the name of your Azure Container Registry):<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight shell"><code><span class="nv">registryId</span><span class="o">=</span><span class="si">$(</span>az acr show <span class="nt">--name</span> &lt;registry-name> <span class="nt">--query</span> <span class="nb">id</span> <span class="nt">--output</span> tsv<span class="si">)</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Now that we have our resource Id, we can use the following AZ CLI command to assign the AcrPush role (Replace <code>&lt;ClientId></code> with the client ID of your service principal):<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight shell"><code>az role assignment create <span class="nt">--assignee</span> &lt;ClientId> <span class="nt">--scope</span> <span class="nv">$registryId</span> <span class="nt">--role</span> AcrPush
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Once our role has been created, we can set up the following secrets in GitHub Actions that we'll need to use in our GitHub Action workflow file:</p>

<div class="table-wrapper-paragraph"><table>
<thead>
<tr>
<th><strong>Secret</strong></th>
<th><strong>Value</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>REGISTRY_LOGIN_SERVER</td>
<td>The login server name of your registry (all lowercase). Example: myregistry.azurecr.io</td>
</tr>
<tr>
<td>REGISTRY_USERNAME</td>
<td>The <code>clientId</code> from the JSON output from the service principal creation</td>
</tr>
<tr>
<td>REGISTRY_PASSWORD</td>
<td>The <code>clientSecret</code> from the JSON output from the service principal creation</td>
</tr>
</tbody>
</table></div>

<h3>
  <a name="pushing-our-container-image-to-azure-container-registry" href="#pushing-our-container-image-to-azure-container-registry">
  </a>
  Pushing our container image to Azure Container Registry
</h3>

<p>We can now create our workflow file. This file will do quite a bit so let's focus on pushing our Container Image to Azure Container Registry to begin with.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight yaml"><code><span class="na">name</span><span class="pi">:</span> <span class="s">Build and Deploy Container Image to App Service</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>

<span class="na">defaults</span><span class="pi">:</span>
  <span class="na">run</span><span class="pi">:</span>
    <span class="na">working-directory</span><span class="pi">:</span> <span class="s">./src</span>

<span class="c1"># Note: The use of :latest for the container image is not recommeded for production environments.</span>
<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build-container-image</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Checkout</span><span class="nv"> </span><span class="s">GitHub</span><span class="nv"> </span><span class="s">Action'</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@main</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Login</span><span class="nv"> </span><span class="s">via</span><span class="nv"> </span><span class="s">Azure</span><span class="nv"> </span><span class="s">CLI'</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/login@v1</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">creds</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_CREDENTIALS }}</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Build</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">Push</span><span class="nv"> </span><span class="s">Image</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">ACR'</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/docker-login@v1</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">login-server</span><span class="pi">:</span> <span class="s">${{ secrets.REGISTRY_LOGIN_SERVER }}</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">${{ secrets.REGISTRY_USERNAME }}</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">${{ secrets.REGISTRY_PASSWORD }}</span>
    <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">docker build . -t ${{ secrets.REGISTRY_LOGIN_SERVER }}/hellobluegreenwebapp:latest</span>
        <span class="s">docker push ${{ secrets.REGISTRY_LOGIN_SERVER }}/hellobluegreenwebapp:latest</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>We login to Azure using our Service Principal connection and then log into our Azure Container Registry. Once that's successfull, we build and push our container image to our ACR.</p>

<p>You can view the Dockerfile that I'm using <a href="https://github.com/willvelida/azure-apps-for-containers-bluegreen-poc/blob/main/src/Dockerfile">here</a>.</p>

<p>One thing to note here is the image tag that we're using. This is a basic demo, so I'm just using <code>latest</code>. For your container images, make sure you follow <a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-image-tag-version">best practices</a>.</p>

<p>Once this has been built and pushed to our Azure Container Registry, we should be able to see our container image by navigating to our ACR, and searching for the image under <strong>Repositories</strong></p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--qLJTV-jc--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/mso197gg71xiifeq97c2.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--qLJTV-jc--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/mso197gg71xiifeq97c2.png" alt="Our deployed image to ACR" loading="lazy" width="880" height="291"></a></p>

<h3>
  <a name="deploying-our-app-to-the-blue-slot" href="#deploying-our-app-to-the-blue-slot">
  </a>
  Deploying our App to the Blue slot
</h3>

<p>Once our image has been pushed to Azure Container Registry, we can deploy it to our Blue slot. In the snippet below, we log into Azure, then retrieve our Application name using a inline script and set it to a output variable that we can use in a later step in this stage.</p>

<p>We then deploy our image to our Blue slot using the output variable we set as the App name, with the image that we've pushed to our ACR and explicity tell the task to deploy the image to our <code>blue</code> slot:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight yaml"><code><span class="na">deploy-to-blue-slot</span><span class="pi">:</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="s">build-container-image</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Checkout</span><span class="nv"> </span><span class="s">GitHub</span><span class="nv"> </span><span class="s">Action'</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@main</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Login</span><span class="nv"> </span><span class="s">via</span><span class="nv"> </span><span class="s">Azure</span><span class="nv"> </span><span class="s">CLI'</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/login@v1</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">creds</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_CREDENTIALS }}</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Get</span><span class="nv"> </span><span class="s">App</span><span class="nv"> </span><span class="s">Name'</span>
      <span class="na">id</span><span class="pi">:</span> <span class="s">getwebappname</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">a=$(az webapp list -g ${{ secrets.AZURE_RG }} --query '[].{Name:name}' -o tsv)</span>
        <span class="s">echo "::set-output name=appName::$a"</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Deploy</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">Blue</span><span class="nv"> </span><span class="s">Slot'</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/webapps-deploy@v2</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">app-name</span><span class="pi">:</span> <span class="s">${{ steps.getwebappname.outputs.appName }}</span>
        <span class="na">images</span><span class="pi">:</span> <span class="s">${{ secrets.REGISTRY_LOGIN_SERVER }}/hellobluegreenwebapp:latest</span>
        <span class="na">slot-name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">blue'</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<h3>
  <a name="verify-that-the-blue-slot-works" href="#verify-that-the-blue-slot-works">
  </a>
  Verify that the blue slot works
</h3>

<p>n this sample, we can verify whether or not our deployment to the blue slot was successful by simply navigating to the blue slot of our App Service.</p>

<p>The URL for our blue slot will take the following format:</p>

<p><code>https://&lt;name-of-app-service>-&lt;slot-name>.azurewebsites.net</code></p>

<p>In this sample, we're just deploying to our blue slot and manually verifying whether or not our container image deployed successfully. In production scenarios, we'll need to include tasks, such as automation tests, to ensure that our deployed container image works as expected before we deploy to our production slot.</p>

<p>In our GitHub actions, we should see the URL to our blue slot like so:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--f7WNlYPQ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7rgoaenoilkfbfvidg17.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--f7WNlYPQ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7rgoaenoilkfbfvidg17.png" alt="GitHub Action showing Blue Slot url" loading="lazy" width="880" height="231"></a></p>

<p>We can use this URL to navigate to the blue slot and see that our image has been successfully deployed:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--M5QyXYf4--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/fbizpl4qnkh5vturnskb.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--M5QyXYf4--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/fbizpl4qnkh5vturnskb.png" alt="Blue slot screenshot" loading="lazy" width="880" height="230"></a></p>

<p>If we navigate to our green slot, we see that nothing has been deployed yet! Let's swap the slots now.</p>

<h3>
  <a name="swap-to-green-slot" href="#swap-to-green-slot">
  </a>
  Swap to Green slot
</h3>

<p>Once we have verified that our deployment to the blue slot has been successful, we can deploy our container image to the green slot. We can do this using the following job in our GitHub Actions workflow:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight yaml"><code><span class="na">swap-to-green-slot</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">Dev</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="s">deploy-to-blue-slot</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Checkout</span><span class="nv"> </span><span class="s">GitHub</span><span class="nv"> </span><span class="s">Action'</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@main</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Login</span><span class="nv"> </span><span class="s">via</span><span class="nv"> </span><span class="s">Azure</span><span class="nv"> </span><span class="s">CLI'</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/login@v1</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">creds</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_CREDENTIALS }}</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Get</span><span class="nv"> </span><span class="s">App</span><span class="nv"> </span><span class="s">Name'</span>
      <span class="na">id</span><span class="pi">:</span> <span class="s">getwebappname</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">a=$(az webapp list -g ${{ secrets.AZURE_RG }} --query '[].{Name:name}' -o tsv)</span>
        <span class="s">echo "::set-output name=appName::$a"</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Swap</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">green</span><span class="nv"> </span><span class="s">slot'</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">Azure/cli@v1</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">inlineScript</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">az webapp deployment slot swap --slot 'blue' --resource-group ${{ secrets.AZURE_RG }} --name ${{ steps.getwebappname.outputs.appName }}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>In this job, we use environments to manually approve the deployment to our production slot provided that our deployment to the blue slot was successful. We can assign a user or users that need to approve the deployment before this job runs.</p>

<p>In this sample, we just use this as a manual approval step. In production scenarios, it's a good idea to run automation tests to ensure that your new container image works as expected before deploying to your production slots.</p>

<p>To learn more about how environments work in GitHub Actions, check out the following <a href="https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment">documentation</a>.</p>

<p>Finally, we initiate the swap to the production slot by using the AZ CLI. Here are just swapping from our blue slot into our green slot. To learn more about how we can work with slots using the AZ CLI, please review the following <a href="https://docs.microsoft.com/en-us/cli/azure/webapp/deployment/slot?view=azure-cli-latest#commands">documentation</a>.</p>

<p>As with out green slot, we should get a URL. Since this is our production slot, our URL won't have a slot name within it's URL.</p>

<p>Navigate to the URL and you can see that we've successful swapped to our green slot!</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--avmAXbxJ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/b2on46d641ctbn4t49ro.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--avmAXbxJ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/b2on46d641ctbn4t49ro.png" alt="Our shiny new production app" loading="lazy" width="880" height="136"></a></p>

<h2>
  <a name="conclusion" href="#conclusion">
  </a>
  Conclusion
</h2>

<p>If you're deploying containers to Azure App Service, hopefully this has helped you see that you can use Blue/Green deployments to achieve zero-downtime deployments for your container images.</p>

<p>This was a basic example, so in your production scenarios you'll want to run comprehensive automation tests against your blue slot before swapping to the green slot. </p>

<p>If you have any questions, feel free to reach out to me on twitter <a href="https://twitter.com/willvelida">@willvelida</a></p>

<p>Until next time, Happy coding! 🤓🖥️</p>

</div></article> <div class="aside-username-wrapper" data-v-10d06ee8><aside class="aside-username-block" data-v-37984f8c data-v-10d06ee8><div class="username-heading loading" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-heading" data-v-37984f8c><div class="vue-content-placeholders-heading__img"></div> <div class="vue-content-placeholders-heading__content"><div class="vue-content-placeholders-heading__title"></div> <div class="vue-content-placeholders-heading__subtitle"></div></div></div></div></div> <div class="info" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-text" data-v-37984f8c><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div></div></div></div></aside></div></div> <div class="comments-block" data-v-8c4375bc data-v-10d06ee8><!----> <a href="https://dev.to/willvelida/implementing-bluegreen-deployments-with-azure-web-apps-for-containers-1gpd" target="_blank" rel="nofollow noopener noreferer" class="add-comment" data-v-8c4375bc>
    Add comment
  </a></div></div> <footer data-v-22cb8fd0><span data-v-22cb8fd0>Built with</span> <a href="https://nuxtjs.org" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="nuxt-icon" data-v-22cb8fd0 data-v-22cb8fd0><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a> <span data-v-22cb8fd0>&</span> <a href="https://docs.dev.to/api" rel="nofollow noopener" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-22cb8fd0 data-v-22cb8fd0><path d="M1.5726 5.13748C1.42945 5.20622 1.2411 5.36661 1.15822 5.48117C1 5.69503 1 5.74849 1 11.8739C1 17.9993 1 18.0528 1.15822 18.2667C1.2411 18.3812 1.42945 18.5416 1.5726 18.6104C1.8137 18.7402 2.46164 18.7478 12 18.7478C21.5384 18.7478 22.1863 18.7402 22.4274 18.6104C22.5706 18.5416 22.7589 18.3812 22.8418 18.2667C23 18.0528 23 17.9993 23 11.8739C23 5.74849 23 5.69503 22.8418 5.48117C22.7589 5.36661 22.5706 5.20622 22.4274 5.13748C22.1863 5.00764 21.5384 5 12 5C2.46164 5 1.8137 5.00764 1.5726 5.13748ZM7.7055 8.2613C8.0822 8.45989 8.59454 9.0098 8.77536 9.40694C8.89589 9.66664 8.91095 9.94922 8.91095 12.0649C8.91095 14.3104 8.90344 14.4478 8.75275 14.7839C8.51919 15.288 8.16506 15.6546 7.68288 15.899C7.26096 16.1052 7.22328 16.1128 5.7315 16.1358L4.20206 16.1663V12.1031V8.04744L5.80684 8.07035C7.27602 8.09327 7.42672 8.10854 7.7055 8.2613ZM13.6952 8.89521V9.73538H12.4521H11.2089V10.4991V11.2629H11.9623H12.7158V12.1031V12.9432H11.9623H11.2089V13.707V14.4708H12.4521H13.6952V15.3109V16.151H12C10.1315 16.151 10.0411 16.1358 9.67191 15.6928L9.47603 15.4484V12.1336C9.47603 8.46752 9.46851 8.49807 9.95069 8.20783C10.1692 8.07035 10.3425 8.05508 11.9473 8.05508H13.6952V8.89521ZM16.5658 10.3769C16.8897 11.6295 17.1685 12.6912 17.176 12.7293C17.1911 12.7675 17.4699 11.7441 17.8014 10.461C18.1254 9.17017 18.4343 8.1009 18.4795 8.08563C18.5247 8.06271 18.9541 8.06271 19.4288 8.07035L20.3028 8.09327L19.376 11.6219C18.8713 13.5542 18.4117 15.2269 18.3664 15.3261C18.0123 16.0135 17.274 16.3343 16.7164 16.0441C16.4528 15.899 16.0911 15.4865 15.9705 15.1887C15.9254 15.0665 15.4884 13.4549 15.0062 11.6142C14.524 9.76593 14.1171 8.20783 14.0945 8.15437C14.0644 8.07035 14.2301 8.05508 15.0212 8.07035L15.9856 8.09327L16.5658 10.3769Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M5.93491 12.103V14.4707H6.27394C6.66574 14.4707 7.01983 14.3103 7.1404 14.0965C7.18559 14.0048 7.21575 13.2105 7.21575 12.0648V10.1783L6.99725 9.95683C6.80133 9.76591 6.71847 9.73535 6.35683 9.73535H5.93491V12.103Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a></footer></div></div></div><script>window.__NUXT__=function(n,e,s,a,t){return a.type_of="article",a.id=1002020,a.title="Implementing Blue/Green Deployments with Azure Web Apps for Containers",a.description="Using Deployment slots, we can perform Blue/Green deployments in Azure App Service to achieve zero-downtime deployments for our containerized workloads.",a.readable_publish_date="Feb 26",a.slug="implementing-bluegreen-deployments-with-azure-web-apps-for-containers-1gpd",a.path="/willvelida/implementing-bluegreen-deployments-with-azure-web-apps-for-containers-1gpd",a.url=t,a.comments_count=0,a.public_reactions_count=14,a.collection_id=n,a.published_timestamp=e,a.positive_reactions_count=14,a.cover_image="https://res.cloudinary.com/practicaldev/image/fetch/s--WHgXst6p--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/9nj9q3w4tuyzim17p9nu.png",a.social_image="https://res.cloudinary.com/practicaldev/image/fetch/s--kI2GNytp--/c_imagga_scale,f_auto,fl_progressive,h_500,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/9nj9q3w4tuyzim17p9nu.png",a.canonical_url=t,a.created_at=e,a.edited_at="2022-02-26T05:58:34Z",a.crossposted_at=n,a.published_at=e,a.last_comment_at=e,a.reading_time_minutes=14,a.tag_list="azure, containers, tutorial, docker",a.tags=["azure","containers","tutorial","docker"],a.body_html='<p>Application uptime is critical for our cloud applications. Using Azure App Service slots, we can implement the Blue/Green deployment pattern to validate that new versions of our application will perform as expected in a production environment, without causing downtime to our existing version of our application. With App Service slots, we can deploy new versions of our container images to our Green slot, run tests against that slot to ensure that everything is working and then direct incoming traffic to our updated container image.</p>\n\n<p>In this article, I\'ll explain what Blue/Green Deployments are and show you how can implement Blue/Green deployments for your App Services that host your containers. This includes:</p>\n\n<ul>\n<li>Creating our Azure resources with Bicep.</li>\n<li>Deploying our resources with GitHub Actions.</li>\n<li>Pushing our container image to Azure Container Registry.</li>\n<li>Pulling our container image into our App Service Blue Slot.</li>\n<li>Swapping from the Blue slot into our Green Slot.</li>\n</ul>\n\n<p>Throughout this article, I\'ll be referring to code that you can find in this GitHub <a href="https://github.com/willvelida/azure-apps-for-containers-bluegreen-poc">repo</a>. If you want to follow along, or use that repo as a base for experimenting with Blue/Green deployments with App Service, please feel free to fork it and have a play around with it! If you see something wrong or want to make an improvement to it, PRs are welcome! 😊</p>\n\n<h2>\n  <a name="what-are-bluegreen-deployments" href="#what-are-bluegreen-deployments">\n  </a>\n  What are Blue/Green Deployments?\n</h2>\n\n<p>As I mentioned, ensuring that our applications are highly available is critical for applications running in the cloud. There are a couple of strategies that we can implement to ensure HA for our apps, such as spinning up our application in a different region in case of a regional-disaster affecting the datacenter where our app is hosted or using high availability configurations. With both of these options, there are time and cost implications that we would need to consider.</p>\n\n<p>We can ensure high availability when deploying our application. With Blue/Green deployments, we can deploy a new version of our application next to the existing one.</p>\n\n<p>Imagine you\'re working on an application and you build a container image that packages the new version of your app. With Blue/Green deployments, we can deploy the new image to the Blue slot alongside our Green slot. Production traffic is still being routed to Green slot, but now that our new version has been deployed to the Blue slot, we can run tests against the Blue slot in a production environment to ensure that the new image works as expected. If everything works, we can swap the image from the blue slot to the green slot, redirecting our production traffic to our new image, which happens with no visible downtime for our users. </p>\n\n<p>Should anything not work as expected, we can abandon the deployment of our new container image without affecting our users, since traffic will be redirected to our green slot containing our exiting image.</p>\n\n<p>In Azure App Service, we can set up staging environments using deployment slots. By using Blue/Green deployments, we can warm up instances in a slot before we swap slots to production traffic, eliminating downtime for our application.</p>\n\n<p>Please note, that your App Service Plan must be either at the <strong>Standard</strong>, <strong>Premium</strong> or <strong>Isolated</strong> tier. </p>\n\n<h2>\n  <a name="preparing-our-infrastructure" href="#preparing-our-infrastructure">\n  </a>\n  Preparing our infrastructure\n</h2>\n\n<p>Let\'s start off by setting up our infrastructure pipeline. Here, I want to create my App Service that has both a blue and green slot, an Azure Container Registry to store my images, then I want to be able to deploy my Bicep template using GitHub Actions.</p>\n\n<h3>\n  <a name="creating-our-azure-resources" href="#creating-our-azure-resources">\n  </a>\n  Creating our Azure Resources\n</h3>\n\n<p>First, let\'s create the Azure Container Registry that we need to store our container images. We can do this in Bicep like so:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>param registryName string\nparam registryLocation string\nparam registrySku string\n\nresource containerRegistry \'Microsoft.ContainerRegistry/registries@2021-09-01\' = {\n  name: registryName\n  location: registryLocation\n  sku: {\n    name: registrySku\n  }\n  identity: {\n    type: \'SystemAssigned\'\n  }\n}\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Here, we\'re giving our container registry a name, location and sku which we will pass through as parameters.</p>\n\n<p>The important thing to note here is that we\'re creating a <a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-authentication-managed-identity">System Assigned Managed Identity for our Container Registry</a>. So rather than enabling admin access on this Container Registry, we\'ll be using a managed identity for our ACR which will allow us to assign permissions and roles for the ACR without having to supply registry credentials. </p>\n\n<p>There are a number of ways that we can authenticate with Azure Container Registry, so I\'d encourage you to check <a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-authentication?tabs=azure-cli">this guide</a> out to see what options are best for your scenario.</p>\n\n<p>Next up. we\'ll create our App Service Plan. To do this, we can write the following Bicep code:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>param appServicePlanName string\nparam appServicePlanLocation string\nparam appServicePlanSkuName string\nparam appServicePlanCapacity int\n\nresource appServicePlan \'Microsoft.Web/serverfarms@2021-02-01\' = {\n  name: appServicePlanName\n  location: appServicePlanLocation\n  sku: {\n    name: appServicePlanSkuName\n    capacity: appServicePlanCapacity\n  }\n  kind: \'linux\'\n  properties: {\n    reserved: true\n  }\n}\n\noutput appServicePlanId string = appServicePlan.id\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>We\'re running our containers on Linux, so we\'ll need to provision a Linux App Service Plan. I\'ve parameterized the App Plan Sku name, but as I mentioned before, deployment slots are only available at <strong>Standard</strong> or above plan. Since we\'re provisioning a Linux plan, we\'ll need to set the <code>reserved</code> property to true.</p>\n\n<p>To see the full Bicep reference template for App Service Plans, check out this <a href="https://docs.microsoft.com/en-us/azure/templates/microsoft.web/2019-08-01/serverfarms?tabs=bicep">page</a>.</p>\n\n<p>With our App Plan template complete, we can start to create our Bicep template for our App Service with both Blue and Green slots.</p>\n\n<p>Here is our full Bicep file for our App Service. Don\'t worry! we will break this down:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>@description(\'Name of the app service plan\')\nparam appServiceName string\n\n@description(\'Location of the app service plan\')\nparam appServiceLocation string\n\n@description(\'Name of the slot that we want to create in our App Service\')\nparam appServiceSlotName string\n\n@description(\'The Server Farm Id for our App Plan\')\nparam serverFarmId string\n\n@description(\'Name of the Azure Container Registry that this App will pull images from\')\nparam acrName string\n\n@description(\'The docker image and tag\')\nparam dockerImageAndTag string = \'/hellobluegreenwebapp:latest\'\n\n// This is the ACR Pull Role Definition Id: https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#acrpull\nvar acrPullRoleDefinitionId = subscriptionResourceId(\'Microsoft.Authorization/roleDefinitions\', \'7f951dda-4ed3-4680-a7ca-43fe172d538d\')\n\nvar appSettings = [\n  {\n    name: \'WEBSITES_ENABLE_APP_SERVICE_STORAGE\'\n    value: \'false\'\n  }\n  {\n    name: \'WEBSITES_PORT\'\n    value: \'80\'\n  }\n  {\n    name: \'DOCKER_REGISTRY_SERVER_URL\'\n    value: \'https://${containerRegistry.properties.loginServer}\'\n  }\n]\n\nresource containerRegistry \'Microsoft.ContainerRegistry/registries@2021-09-01\' existing = {\n  name: acrName\n}\n\nresource appService \'Microsoft.Web/sites@2021-02-01\' = {\n  name: appServiceName\n  location: appServiceLocation\n  kind: \'app,linux,container\'\n  properties: {\n    serverFarmId: serverFarmId\n    siteConfig: {\n      appSettings: appSettings\n      acrUseManagedIdentityCreds: true\n      linuxFxVersion: \'DOCKER|${containerRegistry.properties.loginServer}/${dockerImageAndTag}\'\n    }\n  }\n  identity: {\n    type: \'SystemAssigned\'\n  }\n\n  resource blueSlot \'slots\' = {\n    name: appServiceSlotName\n    location: appServiceLocation\n    kind: \'app,linux,container\'\n    properties: {\n      serverFarmId: serverFarmId\n      siteConfig: {\n        acrUseManagedIdentityCreds: true\n        appSettings: appSettings\n      }\n    }\n    identity: {\n      type: \'SystemAssigned\'\n    }\n  }\n}\n\nresource appServiceAcrPullRoleAssignment \'Microsoft.Authorization/roleAssignments@2020-08-01-preview\' = {\n  scope: containerRegistry\n  name: guid(containerRegistry.id, appService.id, acrPullRoleDefinitionId)\n  properties: {\n    principalId: appService.identity.principalId\n    roleDefinitionId: acrPullRoleDefinitionId\n    principalType: \'ServicePrincipal\'\n  }\n}\n\nresource appServiceSlotAcrPullRoleAssignment \'Microsoft.Authorization/roleAssignments@2020-08-01-preview\' = {\n  scope: containerRegistry\n  name: guid(containerRegistry.id, appService::blueSlot.id, acrPullRoleDefinitionId)\n  properties: {\n    principalId: appService::blueSlot.identity.principalId\n    roleDefinitionId: acrPullRoleDefinitionId\n    principalType: \'ServicePrincipal\'\n  }\n}\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<ul>\n<li>Let\'s start with our parameters. We\'ll need to import both the App Service Plan and the Docker Registry into this Bicep file, so I\'ve added some parameters that we can use in the template. This may be scope creep for this tutorial, but say we have Container Registries across our different environments (DEV, UAT, Prod) and different app service plans, we can provision new App Services that use our different resources across our different environments taking this approach.</li>\n<li>We then create a variable for our <em>AcrPull</em> role definition. We do this by getting the unique identifier for a resource using the\n\n<code>subscriptionResourceId</code>\n\n<a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/template-functions-resource#subscriptionresourceid">function</a>.\n- We create another variable for our App Settings. For our example, both our Blue and Green slot will need to have the same app settings. We could use different app settings for our slots if we needed/wanted to, but for simplicity, I\'ve created a variable and applied them to both slots just so I don\'t have to repeat myself.\n- Our Container Registry needs to be imported so I can reference it in our App Service. All we need to do here is to create a resource block for our Container Registry and use the keyword <code>existing</code>. We reference the name of our registry using a parameter.</li>\n</ul>\n\n<p>For our App Service, we give it a name and location. We also need to provide the following information:</p>\n\n<ul>\n<li>First we set the <code>kind</code> property to <code>app,linux,container</code>. This tells the App Service that we want to host Linux Containers.</li>\n<li>In the properties section, we set the <code>serverFarmId</code> to the Id of our Server Farm. We\'re setting this as a parameter, so if we wanted to use this module for other App Services, we could deploy it to another App Service Plan.</li>\n<li>For our site config section, we set the <code>appSettings</code> to the App Settings we defined earlier, the <code>acrUseManagedIdentityCreds</code> property tells the App Service that we want to use the managed identity credentials to pull images from our container registry. We finally set the <code>linuxFxVersion</code> to <code>DOCKER|${containerRegistry.properties.loginServer}/${dockerImageAndTag}</code>. This sets the Linux App Framework and version.</li>\n<li>We finally create a System Managed Identity for this App Service and the Blue slot. We\'ll need this for our role assignments.</li>\n</ul>\n\n<p>We then create two role assignments that allow our App Service Blue and Green slot to pull images from our container registry. The <code>roleDefinitionId</code> uses the <em>AcrPull</em> role definition we defined in our variable at the start, and the <code>scope</code> property assigns this role to the App Service over our Azure Container Registry. </p>\n\n<p>To learn more about how we can create role assignments using Bicep, check out this <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/scenarios-rbac">article</a>.</p>\n\n<p>With our modules created, we can now write up our <code>main.bicep</code> file like so:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight plaintext"><code>param webAppName string = uniqueString(resourceGroup().id)\nparam acrName string = toLower(\'acr${webAppName}\')\nparam acrSku string\nparam appServicePlanName string = toLower(\'asp-${webAppName}\')\nparam appServiceName string = toLower(\'asp-${webAppName}\')\nparam appServicePlanSkuName string\nparam appServicePlanInstanceCount int\n\nvar appServiceSlotName = \'blue\'\n\nparam location string = resourceGroup().location\n\nmodule containerRegistry \'containerRegistry.bicep\' = {\n  name: \'containerRegistry\'\n  params: {\n    registryLocation: location \n    registryName: acrName\n    registrySku: acrSku\n  }\n}\n\nmodule appServicePlan \'appServicePlan.bicep\' = {\n  name: \'appServicePlan\'\n  params: {\n    appServicePlanLocation: location\n    appServicePlanName: appServicePlanName\n    appServicePlanSkuName: appServicePlanSkuName\n    appServicePlanCapacity: appServicePlanInstanceCount\n  }\n}\n\nmodule appService \'appService.bicep\' = {\n  name: \'appService\'\n  params: {\n    appServiceLocation: location \n    appServiceName: appServiceName\n    serverFarmId: appServicePlan.outputs.appServicePlanId\n    appServiceSlotName: appServiceSlotName\n    acrName: acrName\n  }\n}\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>We\'ll also need a parameters file. We can create a <code>parameters.json</code> file like so:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight json"><code><span class="p">{</span><span class="w">\n    </span><span class="nl">"$schema"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#"</span><span class="p">,</span><span class="w">\n    </span><span class="nl">"contentVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0.0"</span><span class="p">,</span><span class="w">\n    </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">\n        </span><span class="nl">"acrSku"</span><span class="p">:{</span><span class="w">\n            </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Basic"</span><span class="w">   \n        </span><span class="p">},</span><span class="w">\n        </span><span class="nl">"appServicePlanSkuName"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">\n            </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"S1"</span><span class="w">\n        </span><span class="p">},</span><span class="w">\n        </span><span class="nl">"appServicePlanInstanceCount"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">\n            </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">\n        </span><span class="p">}</span><span class="w">\n    </span><span class="p">}</span><span class="w">\n</span><span class="p">}</span><span class="w">\n</span></code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<h3>\n  <a name="deploying-our-resources-with-github-actions" href="#deploying-our-resources-with-github-actions">\n  </a>\n  Deploying our resources with GitHub Actions\n</h3>\n\n<p>Now that our Bicep code has been written, we can deploy it using GitHub Actions. Before we can do this, we\'ll need to set up a couple of things.</p>\n\n<p>First let\'s set up a resource group that we\'ll deploy our resources to. We can do this by running the following AZ CLI command:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight shell"><code>az group create <span class="nt">-n</span> &lt;resource-group-name&gt; <span class="nt">-l</span> &lt;location&gt;\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>With our resource group created, we\'ll need to generate a Service Principal that will allow our GitHub Action workflow to deploy resources to Azure. We can do so by running the following:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight shell"><code>az ad sp create-for-rbac <span class="nt">--name</span> yourApp <span class="nt">--role</span> owner <span class="nt">--scopes</span> /subscriptions/<span class="o">{</span>subscription-id<span class="o">}</span>/resourceGroups/exampleRG <span class="nt">--sdk-auth</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Use your resource group name and subscription Id in the command. The output of this command will generate a JSON object that you\'ll need to copy. It should look similar to this:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight json"><code><span class="p">{</span><span class="w">\n    </span><span class="nl">"clientId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;GUID&gt;"</span><span class="p">,</span><span class="w">\n    </span><span class="nl">"clientSecret"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;GUID&gt;"</span><span class="p">,</span><span class="w">\n    </span><span class="nl">"subscriptionId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;GUID&gt;"</span><span class="p">,</span><span class="w">\n    </span><span class="nl">"tenantId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;GUID&gt;"</span><span class="p">,</span><span class="w">\n</span><span class="p">}</span><span class="w">\n</span></code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>We need to save this JSON ouput as a <strong>Secret</strong> in our GitHub repo. You can do this by selecting <strong>Settings</strong> then <strong>Secrets</strong> and clicking on <strong>New</strong> to create the secret. We\'ll need to create the following secrets:</p>\n\n<div class="table-wrapper-paragraph"><table>\n<thead>\n<tr>\n<th><strong>Secret</strong></th>\n<th><strong>Value</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>RESOURCE_GROUP</td>\n<td>Name of the resource group that we\'re deploying resources to</td>\n</tr>\n<tr>\n<td>AZURE_CREDENTIALS</td>\n<td>The entire JSON output that was generated as part of the service principal creation step</td>\n</tr>\n</tbody>\n</table></div>\n\n<p>Now that we have our secrets, we can create the following workflow file that will deploy our resources:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight yaml"><code><span class="na">name</span><span class="pi">:</span> <span class="s">Deploy Azure Infrastructure</span>\n\n<span class="na">on</span><span class="pi">:</span>\n  <span class="na">push</span><span class="pi">:</span>\n    <span class="na">paths</span><span class="pi">:</span>\n      <span class="pi">-</span> <span class="s1">\'</span><span class="s">deploy/*\'</span>\n  <span class="na">workflow_dispatch</span><span class="pi">:</span>\n\n<span class="na">jobs</span><span class="pi">:</span>\n\n  <span class="na">lint</span><span class="pi">:</span>\n    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>\n    <span class="na">steps</span><span class="pi">:</span>\n      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>\n      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run Bicep Linter</span>\n        <span class="na">run</span><span class="pi">:</span> <span class="s">az bicep build --file ./deploy/main.bicep</span>\n\n  <span class="na">validate</span><span class="pi">:</span>\n    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>\n    <span class="na">steps</span><span class="pi">:</span>\n      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>\n      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/login@v1</span>\n        <span class="na">name</span><span class="pi">:</span> <span class="s">Sign in to Azure</span>\n        <span class="na">with</span><span class="pi">:</span>\n          <span class="na">creds</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_CREDENTIALS }}</span>\n\n      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/arm-deploy@v1</span>\n        <span class="na">name</span><span class="pi">:</span> <span class="s">Run preflight validation</span>\n        <span class="na">with</span><span class="pi">:</span>\n          <span class="na">deploymentName</span><span class="pi">:</span> <span class="s">${{ github.run_number }}</span>\n          <span class="na">resourceGroupName</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_RG }}</span>\n          <span class="na">template</span><span class="pi">:</span> <span class="s">./deploy/main.bicep</span>\n          <span class="na">parameters</span><span class="pi">:</span> <span class="s">./deploy/parameters.json</span>\n          <span class="na">deploymentMode</span><span class="pi">:</span> <span class="s">Validate</span>\n\n  <span class="na">preview</span><span class="pi">:</span>\n    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>\n    <span class="na">needs</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">lint</span><span class="pi">,</span> <span class="nv">validate</span><span class="pi">]</span>\n    <span class="na">steps</span><span class="pi">:</span>\n      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>\n      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/login@v1</span>\n        <span class="na">name</span><span class="pi">:</span> <span class="s">Sign in to Azure</span>\n        <span class="na">with</span><span class="pi">:</span>\n          <span class="na">creds</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_CREDENTIALS }}</span>\n      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">Azure/cli@v1</span>\n        <span class="na">name</span><span class="pi">:</span> <span class="s">Run what-if</span>\n        <span class="na">with</span><span class="pi">:</span>\n          <span class="na">inlineScript</span><span class="pi">:</span> <span class="pi">|</span>\n            <span class="s">az deployment group what-if --resource-group ${{ secrets.AZURE_RG }} --template-file ./deploy/main.bicep --parameters ./deploy/parameters.json</span>\n  <span class="na">deploy</span><span class="pi">:</span>\n    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>\n    <span class="na">environment</span><span class="pi">:</span> <span class="s">Dev</span>\n    <span class="na">needs</span><span class="pi">:</span> <span class="s">preview</span>\n    <span class="na">steps</span><span class="pi">:</span>\n      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>\n\n      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/login@v1</span>\n        <span class="na">with</span><span class="pi">:</span>\n          <span class="na">creds</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_CREDENTIALS }}</span>\n\n      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Deploy Bicep File</span>\n        <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/arm-deploy@v1</span>\n        <span class="na">with</span><span class="pi">:</span>\n          <span class="na">subscriptionId</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_SUBSCRIPTION }}</span>\n          <span class="na">resourceGroupName</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_RG }}</span>\n          <span class="na">template</span><span class="pi">:</span> <span class="s">./deploy/main.bicep</span>\n          <span class="na">parameters</span><span class="pi">:</span> <span class="s">./deploy/parameters.json</span>\n          <span class="na">failOnStdErr</span><span class="pi">:</span> <span class="no">false</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>This file does the following:</p>\n\n<ul>\n<li>We first validate our file to ensure that it\'s a valid Bicep template.</li>\n<li>We then run a preview job on our Bicep template to see what will be deployed as part of our workflow.</li>\n<li>We then run a deploy stage that uses a manual approval step. This is done by putting the <code>environment</code> parameter in this stage. When we approve this deployment, the stage deploys our Bicep template using the parameters file to deploy our resources to Azure.</li>\n</ul>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--Pt6CE8pA--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ohx45qizicipbuuy8nig.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--Pt6CE8pA--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ohx45qizicipbuuy8nig.png" alt="Our Bicep GitHub Actions Deployment Pipeline" loading="lazy" width="880" height="376"></a></p>\n\n<p>If we head into Azure, we can see that our resources have been created:</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--o2iB1W3M--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/p1pxji0jcaa4dzi3tyqu.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--o2iB1W3M--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/p1pxji0jcaa4dzi3tyqu.png" alt="Our required resources" loading="lazy" width="880" height="97"></a></p>\n\n<h2>\n  <a name="deploying-our-container-to-app-service" href="#deploying-our-container-to-app-service">\n  </a>\n  Deploying our container to App Service\n</h2>\n\n<p>We have our Container Registry and App Service ready to go in Azure! We just need to allow our GitHub Action to push and push images to our Azure Container Registry.</p>\n\n<p>First, we need to get the resource Id of our container registry. We can do this by running the following command (Replace <code>&lt;registry-name&gt;</code> with the name of your Azure Container Registry):<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight shell"><code><span class="nv">registryId</span><span class="o">=</span><span class="si">$(</span>az acr show <span class="nt">--name</span> &lt;registry-name&gt; <span class="nt">--query</span> <span class="nb">id</span> <span class="nt">--output</span> tsv<span class="si">)</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Now that we have our resource Id, we can use the following AZ CLI command to assign the AcrPush role (Replace <code>&lt;ClientId&gt;</code> with the client ID of your service principal):<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight shell"><code>az role assignment create <span class="nt">--assignee</span> &lt;ClientId&gt; <span class="nt">--scope</span> <span class="nv">$registryId</span> <span class="nt">--role</span> AcrPush\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Once our role has been created, we can set up the following secrets in GitHub Actions that we\'ll need to use in our GitHub Action workflow file:</p>\n\n<div class="table-wrapper-paragraph"><table>\n<thead>\n<tr>\n<th><strong>Secret</strong></th>\n<th><strong>Value</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>REGISTRY_LOGIN_SERVER</td>\n<td>The login server name of your registry (all lowercase). Example: myregistry.azurecr.io</td>\n</tr>\n<tr>\n<td>REGISTRY_USERNAME</td>\n<td>The <code>clientId</code> from the JSON output from the service principal creation</td>\n</tr>\n<tr>\n<td>REGISTRY_PASSWORD</td>\n<td>The <code>clientSecret</code> from the JSON output from the service principal creation</td>\n</tr>\n</tbody>\n</table></div>\n\n<h3>\n  <a name="pushing-our-container-image-to-azure-container-registry" href="#pushing-our-container-image-to-azure-container-registry">\n  </a>\n  Pushing our container image to Azure Container Registry\n</h3>\n\n<p>We can now create our workflow file. This file will do quite a bit so let\'s focus on pushing our Container Image to Azure Container Registry to begin with.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight yaml"><code><span class="na">name</span><span class="pi">:</span> <span class="s">Build and Deploy Container Image to App Service</span>\n\n<span class="na">on</span><span class="pi">:</span>\n  <span class="na">workflow_dispatch</span><span class="pi">:</span>\n\n<span class="na">defaults</span><span class="pi">:</span>\n  <span class="na">run</span><span class="pi">:</span>\n    <span class="na">working-directory</span><span class="pi">:</span> <span class="s">./src</span>\n\n<span class="c1"># Note: The use of :latest for the container image is not recommeded for production environments.</span>\n<span class="na">jobs</span><span class="pi">:</span>\n  <span class="na">build-container-image</span><span class="pi">:</span>\n    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>\n    <span class="na">steps</span><span class="pi">:</span>\n    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">\'</span><span class="s">Checkout</span><span class="nv"> </span><span class="s">GitHub</span><span class="nv"> </span><span class="s">Action\'</span>\n      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@main</span>\n\n    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">\'</span><span class="s">Login</span><span class="nv"> </span><span class="s">via</span><span class="nv"> </span><span class="s">Azure</span><span class="nv"> </span><span class="s">CLI\'</span>\n      <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/login@v1</span>\n      <span class="na">with</span><span class="pi">:</span>\n        <span class="na">creds</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_CREDENTIALS }}</span>\n\n    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">\'</span><span class="s">Build</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">Push</span><span class="nv"> </span><span class="s">Image</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">ACR\'</span>\n      <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/docker-login@v1</span>\n      <span class="na">with</span><span class="pi">:</span>\n        <span class="na">login-server</span><span class="pi">:</span> <span class="s">${{ secrets.REGISTRY_LOGIN_SERVER }}</span>\n        <span class="na">username</span><span class="pi">:</span> <span class="s">${{ secrets.REGISTRY_USERNAME }}</span>\n        <span class="na">password</span><span class="pi">:</span> <span class="s">${{ secrets.REGISTRY_PASSWORD }}</span>\n    <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>\n        <span class="s">docker build . -t ${{ secrets.REGISTRY_LOGIN_SERVER }}/hellobluegreenwebapp:latest</span>\n        <span class="s">docker push ${{ secrets.REGISTRY_LOGIN_SERVER }}/hellobluegreenwebapp:latest</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>We login to Azure using our Service Principal connection and then log into our Azure Container Registry. Once that\'s successfull, we build and push our container image to our ACR.</p>\n\n<p>You can view the Dockerfile that I\'m using <a href="https://github.com/willvelida/azure-apps-for-containers-bluegreen-poc/blob/main/src/Dockerfile">here</a>.</p>\n\n<p>One thing to note here is the image tag that we\'re using. This is a basic demo, so I\'m just using <code>latest</code>. For your container images, make sure you follow <a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-image-tag-version">best practices</a>.</p>\n\n<p>Once this has been built and pushed to our Azure Container Registry, we should be able to see our container image by navigating to our ACR, and searching for the image under <strong>Repositories</strong></p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--qLJTV-jc--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/mso197gg71xiifeq97c2.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--qLJTV-jc--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/mso197gg71xiifeq97c2.png" alt="Our deployed image to ACR" loading="lazy" width="880" height="291"></a></p>\n\n<h3>\n  <a name="deploying-our-app-to-the-blue-slot" href="#deploying-our-app-to-the-blue-slot">\n  </a>\n  Deploying our App to the Blue slot\n</h3>\n\n<p>Once our image has been pushed to Azure Container Registry, we can deploy it to our Blue slot. In the snippet below, we log into Azure, then retrieve our Application name using a inline script and set it to a output variable that we can use in a later step in this stage.</p>\n\n<p>We then deploy our image to our Blue slot using the output variable we set as the App name, with the image that we\'ve pushed to our ACR and explicity tell the task to deploy the image to our <code>blue</code> slot:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight yaml"><code><span class="na">deploy-to-blue-slot</span><span class="pi">:</span>\n    <span class="na">needs</span><span class="pi">:</span> <span class="s">build-container-image</span>\n    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>\n    <span class="na">steps</span><span class="pi">:</span>\n    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">\'</span><span class="s">Checkout</span><span class="nv"> </span><span class="s">GitHub</span><span class="nv"> </span><span class="s">Action\'</span>\n      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@main</span>\n\n    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">\'</span><span class="s">Login</span><span class="nv"> </span><span class="s">via</span><span class="nv"> </span><span class="s">Azure</span><span class="nv"> </span><span class="s">CLI\'</span>\n      <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/login@v1</span>\n      <span class="na">with</span><span class="pi">:</span>\n        <span class="na">creds</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_CREDENTIALS }}</span>\n\n    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">\'</span><span class="s">Get</span><span class="nv"> </span><span class="s">App</span><span class="nv"> </span><span class="s">Name\'</span>\n      <span class="na">id</span><span class="pi">:</span> <span class="s">getwebappname</span>\n      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>\n        <span class="s">a=$(az webapp list -g ${{ secrets.AZURE_RG }} --query \'[].{Name:name}\' -o tsv)</span>\n        <span class="s">echo "::set-output name=appName::$a"</span>\n\n    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">\'</span><span class="s">Deploy</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">Blue</span><span class="nv"> </span><span class="s">Slot\'</span>\n      <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/webapps-deploy@v2</span>\n      <span class="na">with</span><span class="pi">:</span>\n        <span class="na">app-name</span><span class="pi">:</span> <span class="s">${{ steps.getwebappname.outputs.appName }}</span>\n        <span class="na">images</span><span class="pi">:</span> <span class="s">${{ secrets.REGISTRY_LOGIN_SERVER }}/hellobluegreenwebapp:latest</span>\n        <span class="na">slot-name</span><span class="pi">:</span> <span class="s1">\'</span><span class="s">blue\'</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<h3>\n  <a name="verify-that-the-blue-slot-works" href="#verify-that-the-blue-slot-works">\n  </a>\n  Verify that the blue slot works\n</h3>\n\n<p>n this sample, we can verify whether or not our deployment to the blue slot was successful by simply navigating to the blue slot of our App Service.</p>\n\n<p>The URL for our blue slot will take the following format:</p>\n\n<p><code>https://&lt;name-of-app-service&gt;-&lt;slot-name&gt;.azurewebsites.net</code></p>\n\n<p>In this sample, we\'re just deploying to our blue slot and manually verifying whether or not our container image deployed successfully. In production scenarios, we\'ll need to include tasks, such as automation tests, to ensure that our deployed container image works as expected before we deploy to our production slot.</p>\n\n<p>In our GitHub actions, we should see the URL to our blue slot like so:</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--f7WNlYPQ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7rgoaenoilkfbfvidg17.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--f7WNlYPQ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7rgoaenoilkfbfvidg17.png" alt="GitHub Action showing Blue Slot url" loading="lazy" width="880" height="231"></a></p>\n\n<p>We can use this URL to navigate to the blue slot and see that our image has been successfully deployed:</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--M5QyXYf4--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/fbizpl4qnkh5vturnskb.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--M5QyXYf4--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/fbizpl4qnkh5vturnskb.png" alt="Blue slot screenshot" loading="lazy" width="880" height="230"></a></p>\n\n<p>If we navigate to our green slot, we see that nothing has been deployed yet! Let\'s swap the slots now.</p>\n\n<h3>\n  <a name="swap-to-green-slot" href="#swap-to-green-slot">\n  </a>\n  Swap to Green slot\n</h3>\n\n<p>Once we have verified that our deployment to the blue slot has been successful, we can deploy our container image to the green slot. We can do this using the following job in our GitHub Actions workflow:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight yaml"><code><span class="na">swap-to-green-slot</span><span class="pi">:</span>\n    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>\n    <span class="na">environment</span><span class="pi">:</span> <span class="s">Dev</span>\n    <span class="na">needs</span><span class="pi">:</span> <span class="s">deploy-to-blue-slot</span>\n    <span class="na">steps</span><span class="pi">:</span>\n    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">\'</span><span class="s">Checkout</span><span class="nv"> </span><span class="s">GitHub</span><span class="nv"> </span><span class="s">Action\'</span>\n      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@main</span>\n\n    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">\'</span><span class="s">Login</span><span class="nv"> </span><span class="s">via</span><span class="nv"> </span><span class="s">Azure</span><span class="nv"> </span><span class="s">CLI\'</span>\n      <span class="na">uses</span><span class="pi">:</span> <span class="s">azure/login@v1</span>\n      <span class="na">with</span><span class="pi">:</span>\n        <span class="na">creds</span><span class="pi">:</span> <span class="s">${{ secrets.AZURE_CREDENTIALS }}</span>\n\n    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">\'</span><span class="s">Get</span><span class="nv"> </span><span class="s">App</span><span class="nv"> </span><span class="s">Name\'</span>\n      <span class="na">id</span><span class="pi">:</span> <span class="s">getwebappname</span>\n      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>\n        <span class="s">a=$(az webapp list -g ${{ secrets.AZURE_RG }} --query \'[].{Name:name}\' -o tsv)</span>\n        <span class="s">echo "::set-output name=appName::$a"</span>\n\n    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">\'</span><span class="s">Swap</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">green</span><span class="nv"> </span><span class="s">slot\'</span>\n      <span class="na">uses</span><span class="pi">:</span> <span class="s">Azure/cli@v1</span>\n      <span class="na">with</span><span class="pi">:</span>\n        <span class="na">inlineScript</span><span class="pi">:</span> <span class="pi">|</span>\n          <span class="s">az webapp deployment slot swap --slot \'blue\' --resource-group ${{ secrets.AZURE_RG }} --name ${{ steps.getwebappname.outputs.appName }}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>In this job, we use environments to manually approve the deployment to our production slot provided that our deployment to the blue slot was successful. We can assign a user or users that need to approve the deployment before this job runs.</p>\n\n<p>In this sample, we just use this as a manual approval step. In production scenarios, it\'s a good idea to run automation tests to ensure that your new container image works as expected before deploying to your production slots.</p>\n\n<p>To learn more about how environments work in GitHub Actions, check out the following <a href="https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment">documentation</a>.</p>\n\n<p>Finally, we initiate the swap to the production slot by using the AZ CLI. Here are just swapping from our blue slot into our green slot. To learn more about how we can work with slots using the AZ CLI, please review the following <a href="https://docs.microsoft.com/en-us/cli/azure/webapp/deployment/slot?view=azure-cli-latest#commands">documentation</a>.</p>\n\n<p>As with out green slot, we should get a URL. Since this is our production slot, our URL won\'t have a slot name within it\'s URL.</p>\n\n<p>Navigate to the URL and you can see that we\'ve successful swapped to our green slot!</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--avmAXbxJ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/b2on46d641ctbn4t49ro.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--avmAXbxJ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/b2on46d641ctbn4t49ro.png" alt="Our shiny new production app" loading="lazy" width="880" height="136"></a></p>\n\n<h2>\n  <a name="conclusion" href="#conclusion">\n  </a>\n  Conclusion\n</h2>\n\n<p>If you\'re deploying containers to Azure App Service, hopefully this has helped you see that you can use Blue/Green deployments to achieve zero-downtime deployments for your container images.</p>\n\n<p>This was a basic example, so in your production scenarios you\'ll want to run comprehensive automation tests against your blue slot before swapping to the green slot. </p>\n\n<p>If you have any questions, feel free to reach out to me on twitter <a href="https://twitter.com/willvelida">@willvelida</a></p>\n\n<p>Until next time, Happy coding! 🤓🖥️</p>\n\n',a.body_markdown="---\ntitle: Implementing Blue/Green Deployments with Azure Web Apps for Containers\npublished: true\ndescription: Using Deployment slots, we can perform Blue/Green deployments in Azure App Service to achieve zero-downtime deployments for our containerized workloads.\ntags: azure,containers,tutorial,docker\ncover_image: https://dev-to-uploads.s3.amazonaws.com/uploads/articles/9nj9q3w4tuyzim17p9nu.png\n---\nApplication uptime is critical for our cloud applications. Using Azure App Service slots, we can implement the Blue/Green deployment pattern to validate that new versions of our application will perform as expected in a production environment, without causing downtime to our existing version of our application. With App Service slots, we can deploy new versions of our container images to our Green slot, run tests against that slot to ensure that everything is working and then direct incoming traffic to our updated container image.\n\nIn this article, I'll explain what Blue/Green Deployments are and show you how can implement Blue/Green deployments for your App Services that host your containers. This includes:\n\n- Creating our Azure resources with Bicep.\n- Deploying our resources with GitHub Actions.\n- Pushing our container image to Azure Container Registry.\n- Pulling our container image into our App Service Blue Slot.\n- Swapping from the Blue slot into our Green Slot.\n\nThroughout this article, I'll be referring to code that you can find in this GitHub [repo](https://github.com/willvelida/azure-apps-for-containers-bluegreen-poc). If you want to follow along, or use that repo as a base for experimenting with Blue/Green deployments with App Service, please feel free to fork it and have a play around with it! If you see something wrong or want to make an improvement to it, PRs are welcome! 😊\n\n## What are Blue/Green Deployments?\n\nAs I mentioned, ensuring that our applications are highly available is critical for applications running in the cloud. There are a couple of strategies that we can implement to ensure HA for our apps, such as spinning up our application in a different region in case of a regional-disaster affecting the datacenter where our app is hosted or using high availability configurations. With both of these options, there are time and cost implications that we would need to consider.\n\nWe can ensure high availability when deploying our application. With Blue/Green deployments, we can deploy a new version of our application next to the existing one.\n\nImagine you're working on an application and you build a container image that packages the new version of your app. With Blue/Green deployments, we can deploy the new image to the Blue slot alongside our Green slot. Production traffic is still being routed to Green slot, but now that our new version has been deployed to the Blue slot, we can run tests against the Blue slot in a production environment to ensure that the new image works as expected. If everything works, we can swap the image from the blue slot to the green slot, redirecting our production traffic to our new image, which happens with no visible downtime for our users. \n\nShould anything not work as expected, we can abandon the deployment of our new container image without affecting our users, since traffic will be redirected to our green slot containing our exiting image.\n\nIn Azure App Service, we can set up staging environments using deployment slots. By using Blue/Green deployments, we can warm up instances in a slot before we swap slots to production traffic, eliminating downtime for our application.\n\nPlease note, that your App Service Plan must be either at the **Standard**, **Premium** or **Isolated** tier. \n\n## Preparing our infrastructure\n\nLet's start off by setting up our infrastructure pipeline. Here, I want to create my App Service that has both a blue and green slot, an Azure Container Registry to store my images, then I want to be able to deploy my Bicep template using GitHub Actions.\n\n### Creating our Azure Resources\n\nFirst, let's create the Azure Container Registry that we need to store our container images. We can do this in Bicep like so:\n\n```bicep\nparam registryName string\nparam registryLocation string\nparam registrySku string\n\nresource containerRegistry 'Microsoft.ContainerRegistry/registries@2021-09-01' = {\n  name: registryName\n  location: registryLocation\n  sku: {\n    name: registrySku\n  }\n  identity: {\n    type: 'SystemAssigned'\n  }\n}\n```\n\nHere, we're giving our container registry a name, location and sku which we will pass through as parameters.\n\nThe important thing to note here is that we're creating a [System Assigned Managed Identity for our Container Registry](https://docs.microsoft.com/en-us/azure/container-registry/container-registry-authentication-managed-identity). So rather than enabling admin access on this Container Registry, we'll be using a managed identity for our ACR which will allow us to assign permissions and roles for the ACR without having to supply registry credentials. \n\nThere are a number of ways that we can authenticate with Azure Container Registry, so I'd encourage you to check [this guide](https://docs.microsoft.com/en-us/azure/container-registry/container-registry-authentication?tabs=azure-cli) out to see what options are best for your scenario.\n\nNext up. we'll create our App Service Plan. To do this, we can write the following Bicep code:\n\n```bicep\nparam appServicePlanName string\nparam appServicePlanLocation string\nparam appServicePlanSkuName string\nparam appServicePlanCapacity int\n\nresource appServicePlan 'Microsoft.Web/serverfarms@2021-02-01' = {\n  name: appServicePlanName\n  location: appServicePlanLocation\n  sku: {\n    name: appServicePlanSkuName\n    capacity: appServicePlanCapacity\n  }\n  kind: 'linux'\n  properties: {\n    reserved: true\n  }\n}\n\noutput appServicePlanId string = appServicePlan.id\n```\n\nWe're running our containers on Linux, so we'll need to provision a Linux App Service Plan. I've parameterized the App Plan Sku name, but as I mentioned before, deployment slots are only available at **Standard** or above plan. Since we're provisioning a Linux plan, we'll need to set the ``reserved`` property to true.\n\nTo see the full Bicep reference template for App Service Plans, check out this [page](https://docs.microsoft.com/en-us/azure/templates/microsoft.web/2019-08-01/serverfarms?tabs=bicep).\n\nWith our App Plan template complete, we can start to create our Bicep template for our App Service with both Blue and Green slots.\n\nHere is our full Bicep file for our App Service. Don't worry! we will break this down:\n\n```bicep\n@description('Name of the app service plan')\nparam appServiceName string\n\n@description('Location of the app service plan')\nparam appServiceLocation string\n\n@description('Name of the slot that we want to create in our App Service')\nparam appServiceSlotName string\n\n@description('The Server Farm Id for our App Plan')\nparam serverFarmId string\n\n@description('Name of the Azure Container Registry that this App will pull images from')\nparam acrName string\n\n@description('The docker image and tag')\nparam dockerImageAndTag string = '/hellobluegreenwebapp:latest'\n\n// This is the ACR Pull Role Definition Id: https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#acrpull\nvar acrPullRoleDefinitionId = subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')\n\nvar appSettings = [\n  {\n    name: 'WEBSITES_ENABLE_APP_SERVICE_STORAGE'\n    value: 'false'\n  }\n  {\n    name: 'WEBSITES_PORT'\n    value: '80'\n  }\n  {\n    name: 'DOCKER_REGISTRY_SERVER_URL'\n    value: 'https://${containerRegistry.properties.loginServer}'\n  }\n]\n\nresource containerRegistry 'Microsoft.ContainerRegistry/registries@2021-09-01' existing = {\n  name: acrName\n}\n\nresource appService 'Microsoft.Web/sites@2021-02-01' = {\n  name: appServiceName\n  location: appServiceLocation\n  kind: 'app,linux,container'\n  properties: {\n    serverFarmId: serverFarmId\n    siteConfig: {\n      appSettings: appSettings\n      acrUseManagedIdentityCreds: true\n      linuxFxVersion: 'DOCKER|${containerRegistry.properties.loginServer}/${dockerImageAndTag}'\n    }\n  }\n  identity: {\n    type: 'SystemAssigned'\n  }\n\n  resource blueSlot 'slots' = {\n    name: appServiceSlotName\n    location: appServiceLocation\n    kind: 'app,linux,container'\n    properties: {\n      serverFarmId: serverFarmId\n      siteConfig: {\n        acrUseManagedIdentityCreds: true\n        appSettings: appSettings\n      }\n    }\n    identity: {\n      type: 'SystemAssigned'\n    }\n  }\n}\n\nresource appServiceAcrPullRoleAssignment 'Microsoft.Authorization/roleAssignments@2020-08-01-preview' = {\n  scope: containerRegistry\n  name: guid(containerRegistry.id, appService.id, acrPullRoleDefinitionId)\n  properties: {\n    principalId: appService.identity.principalId\n    roleDefinitionId: acrPullRoleDefinitionId\n    principalType: 'ServicePrincipal'\n  }\n}\n\nresource appServiceSlotAcrPullRoleAssignment 'Microsoft.Authorization/roleAssignments@2020-08-01-preview' = {\n  scope: containerRegistry\n  name: guid(containerRegistry.id, appService::blueSlot.id, acrPullRoleDefinitionId)\n  properties: {\n    principalId: appService::blueSlot.identity.principalId\n    roleDefinitionId: acrPullRoleDefinitionId\n    principalType: 'ServicePrincipal'\n  }\n}\n```\n\n- Let's start with our parameters. We'll need to import both the App Service Plan and the Docker Registry into this Bicep file, so I've added some parameters that we can use in the template. This may be scope creep for this tutorial, but say we have Container Registries across our different environments (DEV, UAT, Prod) and different app service plans, we can provision new App Services that use our different resources across our different environments taking this approach.\n- We then create a variable for our *AcrPull* role definition. We do this by getting the unique identifier for a resource using the ```subscriptionResourceId``` [function](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/template-functions-resource#subscriptionresourceid).\n- We create another variable for our App Settings. For our example, both our Blue and Green slot will need to have the same app settings. We could use different app settings for our slots if we needed/wanted to, but for simplicity, I've created a variable and applied them to both slots just so I don't have to repeat myself.\n- Our Container Registry needs to be imported so I can reference it in our App Service. All we need to do here is to create a resource block for our Container Registry and use the keyword ``existing``. We reference the name of our registry using a parameter.\n\nFor our App Service, we give it a name and location. We also need to provide the following information:\n\n- First we set the ``kind`` property to ``app,linux,container``. This tells the App Service that we want to host Linux Containers.\n- In the properties section, we set the ``serverFarmId`` to the Id of our Server Farm. We're setting this as a parameter, so if we wanted to use this module for other App Services, we could deploy it to another App Service Plan.\n- For our site config section, we set the ``appSettings`` to the App Settings we defined earlier, the ``acrUseManagedIdentityCreds`` property tells the App Service that we want to use the managed identity credentials to pull images from our container registry. We finally set the ``linuxFxVersion`` to ``DOCKER|${containerRegistry.properties.loginServer}/${dockerImageAndTag}``. This sets the Linux App Framework and version.\n- We finally create a System Managed Identity for this App Service and the Blue slot. We'll need this for our role assignments.\n\nWe then create two role assignments that allow our App Service Blue and Green slot to pull images from our container registry. The ``roleDefinitionId`` uses the *AcrPull* role definition we defined in our variable at the start, and the ``scope`` property assigns this role to the App Service over our Azure Container Registry. \n\nTo learn more about how we can create role assignments using Bicep, check out this [article](https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/scenarios-rbac).\n\nWith our modules created, we can now write up our ``main.bicep`` file like so:\n\n```bicep\nparam webAppName string = uniqueString(resourceGroup().id)\nparam acrName string = toLower('acr${webAppName}')\nparam acrSku string\nparam appServicePlanName string = toLower('asp-${webAppName}')\nparam appServiceName string = toLower('asp-${webAppName}')\nparam appServicePlanSkuName string\nparam appServicePlanInstanceCount int\n\nvar appServiceSlotName = 'blue'\n\nparam location string = resourceGroup().location\n\nmodule containerRegistry 'containerRegistry.bicep' = {\n  name: 'containerRegistry'\n  params: {\n    registryLocation: location \n    registryName: acrName\n    registrySku: acrSku\n  }\n}\n\nmodule appServicePlan 'appServicePlan.bicep' = {\n  name: 'appServicePlan'\n  params: {\n    appServicePlanLocation: location\n    appServicePlanName: appServicePlanName\n    appServicePlanSkuName: appServicePlanSkuName\n    appServicePlanCapacity: appServicePlanInstanceCount\n  }\n}\n\nmodule appService 'appService.bicep' = {\n  name: 'appService'\n  params: {\n    appServiceLocation: location \n    appServiceName: appServiceName\n    serverFarmId: appServicePlan.outputs.appServicePlanId\n    appServiceSlotName: appServiceSlotName\n    acrName: acrName\n  }\n}\n```\n\nWe'll also need a parameters file. We can create a ``parameters.json`` file like so:\n\n```json\n{\n    \"$schema\": \"https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#\",\n    \"contentVersion\": \"1.0.0.0\",\n    \"parameters\": {\n        \"acrSku\":{\n            \"value\": \"Basic\"   \n        },\n        \"appServicePlanSkuName\": {\n            \"value\": \"S1\"\n        },\n        \"appServicePlanInstanceCount\": {\n            \"value\": 1\n        }\n    }\n}\n```\n\n### Deploying our resources with GitHub Actions\n\nNow that our Bicep code has been written, we can deploy it using GitHub Actions. Before we can do this, we'll need to set up a couple of things.\n\nFirst let's set up a resource group that we'll deploy our resources to. We can do this by running the following AZ CLI command:\n\n```bash\naz group create -n <resource-group-name> -l <location>\n```\n\nWith our resource group created, we'll need to generate a Service Principal that will allow our GitHub Action workflow to deploy resources to Azure. We can do so by running the following:\n\n```bash\naz ad sp create-for-rbac --name yourApp --role owner --scopes /subscriptions/{subscription-id}/resourceGroups/exampleRG --sdk-auth\n```\n\nUse your resource group name and subscription Id in the command. The output of this command will generate a JSON object that you'll need to copy. It should look similar to this:\n\n```json\n{\n    \"clientId\": \"<GUID>\",\n    \"clientSecret\": \"<GUID>\",\n    \"subscriptionId\": \"<GUID>\",\n    \"tenantId\": \"<GUID>\",\n}\n```\n\nWe need to save this JSON ouput as a **Secret** in our GitHub repo. You can do this by selecting **Settings** then **Secrets** and clicking on **New** to create the secret. We'll need to create the following secrets:\n\n| **Secret** | **Value** |\n| ---------- | --------- |\n| RESOURCE_GROUP | Name of the resource group that we're deploying resources to |\n| AZURE_CREDENTIALS | The entire JSON output that was generated as part of the service principal creation step |\n\nNow that we have our secrets, we can create the following workflow file that will deploy our resources:\n\n```yaml\nname: Deploy Azure Infrastructure\n\non:\n  push:\n    paths:\n      - 'deploy/*'\n  workflow_dispatch:\n\njobs:\n\n  lint:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v2\n      - name: Run Bicep Linter\n        run: az bicep build --file ./deploy/main.bicep\n\n  validate:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v2\n      - uses: azure/login@v1\n        name: Sign in to Azure\n        with:\n          creds: ${{ secrets.AZURE_CREDENTIALS }}\n      \n      - uses: azure/arm-deploy@v1\n        name: Run preflight validation\n        with:\n          deploymentName: ${{ github.run_number }}\n          resourceGroupName: ${{ secrets.AZURE_RG }}\n          template: ./deploy/main.bicep\n          parameters: ./deploy/parameters.json\n          deploymentMode: Validate\n\n  preview:\n    runs-on: ubuntu-latest\n    needs: [lint, validate]\n    steps:\n      - uses: actions/checkout@v2\n      - uses: azure/login@v1\n        name: Sign in to Azure\n        with:\n          creds: ${{ secrets.AZURE_CREDENTIALS }}\n      - uses: Azure/cli@v1\n        name: Run what-if\n        with:\n          inlineScript: |\n            az deployment group what-if --resource-group ${{ secrets.AZURE_RG }} --template-file ./deploy/main.bicep --parameters ./deploy/parameters.json\n  deploy:\n    runs-on: ubuntu-latest\n    environment: Dev\n    needs: preview\n    steps:\n      - uses: actions/checkout@v2\n\n      - uses: azure/login@v1\n        with:\n          creds: ${{ secrets.AZURE_CREDENTIALS }}\n        \n      - name: Deploy Bicep File\n        uses: azure/arm-deploy@v1\n        with:\n          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION }}\n          resourceGroupName: ${{ secrets.AZURE_RG }}\n          template: ./deploy/main.bicep\n          parameters: ./deploy/parameters.json\n          failOnStdErr: false\n```\n\nThis file does the following:\n\n- We first validate our file to ensure that it's a valid Bicep template.\n- We then run a preview job on our Bicep template to see what will be deployed as part of our workflow.\n- We then run a deploy stage that uses a manual approval step. This is done by putting the ``environment`` parameter in this stage. When we approve this deployment, the stage deploys our Bicep template using the parameters file to deploy our resources to Azure.\n\n![Our Bicep GitHub Actions Deployment Pipeline](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ohx45qizicipbuuy8nig.png)\n\nIf we head into Azure, we can see that our resources have been created:\n\n![Our required resources](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/p1pxji0jcaa4dzi3tyqu.png)\n\n## Deploying our container to App Service\n\nWe have our Container Registry and App Service ready to go in Azure! We just need to allow our GitHub Action to push and push images to our Azure Container Registry.\n\nFirst, we need to get the resource Id of our container registry. We can do this by running the following command (Replace ``<registry-name>`` with the name of your Azure Container Registry):\n\n```bash\nregistryId=$(az acr show --name <registry-name> --query id --output tsv)\n```\nNow that we have our resource Id, we can use the following AZ CLI command to assign the AcrPush role (Replace ``<ClientId>`` with the client ID of your service principal):\n\n```bash\naz role assignment create --assignee <ClientId> --scope $registryId --role AcrPush\n```\n\nOnce our role has been created, we can set up the following secrets in GitHub Actions that we'll need to use in our GitHub Action workflow file:\n\n| **Secret** | **Value** |\n| ---------- | --------- |\n| REGISTRY_LOGIN_SERVER | The login server name of your registry (all lowercase). Example: myregistry.azurecr.io |\n| REGISTRY_USERNAME | The ``clientId`` from the JSON output from the service principal creation |\n| REGISTRY_PASSWORD | The ``clientSecret`` from the JSON output from the service principal creation |\n\n### Pushing our container image to Azure Container Registry\n\nWe can now create our workflow file. This file will do quite a bit so let's focus on pushing our Container Image to Azure Container Registry to begin with. \n\n```yaml\nname: Build and Deploy Container Image to App Service\n\non:\n  workflow_dispatch:\n\ndefaults:\n  run:\n    working-directory: ./src\n\n# Note: The use of :latest for the container image is not recommeded for production environments.\njobs:\n  build-container-image:\n    runs-on: ubuntu-latest\n    steps:\n    - name: 'Checkout GitHub Action'\n      uses: actions/checkout@main\n      \n    - name: 'Login via Azure CLI'\n      uses: azure/login@v1\n      with:\n        creds: ${{ secrets.AZURE_CREDENTIALS }}\n    \n    - name: 'Build and Push Image to ACR'\n      uses: azure/docker-login@v1\n      with:\n        login-server: ${{ secrets.REGISTRY_LOGIN_SERVER }}\n        username: ${{ secrets.REGISTRY_USERNAME }}\n        password: ${{ secrets.REGISTRY_PASSWORD }}\n    - run: |\n        docker build . -t ${{ secrets.REGISTRY_LOGIN_SERVER }}/hellobluegreenwebapp:latest\n        docker push ${{ secrets.REGISTRY_LOGIN_SERVER }}/hellobluegreenwebapp:latest\n```\n\nWe login to Azure using our Service Principal connection and then log into our Azure Container Registry. Once that's successfull, we build and push our container image to our ACR.\n\nYou can view the Dockerfile that I'm using [here](https://github.com/willvelida/azure-apps-for-containers-bluegreen-poc/blob/main/src/Dockerfile).\n\nOne thing to note here is the image tag that we're using. This is a basic demo, so I'm just using ``latest``. For your container images, make sure you follow [best practices](https://docs.microsoft.com/en-us/azure/container-registry/container-registry-image-tag-version).\n\nOnce this has been built and pushed to our Azure Container Registry, we should be able to see our container image by navigating to our ACR, and searching for the image under **Repositories**\n\n![Our deployed image to ACR](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/mso197gg71xiifeq97c2.png)\n\n### Deploying our App to the Blue slot\n\nOnce our image has been pushed to Azure Container Registry, we can deploy it to our Blue slot. In the snippet below, we log into Azure, then retrieve our Application name using a inline script and set it to a output variable that we can use in a later step in this stage.\n\nWe then deploy our image to our Blue slot using the output variable we set as the App name, with the image that we've pushed to our ACR and explicity tell the task to deploy the image to our ``blue`` slot:\n\n```yaml\ndeploy-to-blue-slot:\n    needs: build-container-image\n    runs-on: ubuntu-latest\n    steps:\n    - name: 'Checkout GitHub Action'\n      uses: actions/checkout@main\n      \n    - name: 'Login via Azure CLI'\n      uses: azure/login@v1\n      with:\n        creds: ${{ secrets.AZURE_CREDENTIALS }}\n\n    - name: 'Get App Name'\n      id: getwebappname\n      run: |\n        a=$(az webapp list -g ${{ secrets.AZURE_RG }} --query '[].{Name:name}' -o tsv)\n        echo \"::set-output name=appName::$a\"\n\n    - name: 'Deploy to Blue Slot'\n      uses: azure/webapps-deploy@v2\n      with:\n        app-name: ${{ steps.getwebappname.outputs.appName }}\n        images: ${{ secrets.REGISTRY_LOGIN_SERVER }}/hellobluegreenwebapp:latest\n        slot-name: 'blue'\n```\n\n### Verify that the blue slot works\n\nn this sample, we can verify whether or not our deployment to the blue slot was successful by simply navigating to the blue slot of our App Service.\n\nThe URL for our blue slot will take the following format:\n\n``https://<name-of-app-service>-<slot-name>.azurewebsites.net``\n\nIn this sample, we're just deploying to our blue slot and manually verifying whether or not our container image deployed successfully. In production scenarios, we'll need to include tasks, such as automation tests, to ensure that our deployed container image works as expected before we deploy to our production slot.\n\nIn our GitHub actions, we should see the URL to our blue slot like so:\n\n![GitHub Action showing Blue Slot url](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7rgoaenoilkfbfvidg17.png)\n\nWe can use this URL to navigate to the blue slot and see that our image has been successfully deployed:\n\n![Blue slot screenshot](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/fbizpl4qnkh5vturnskb.png)\n\nIf we navigate to our green slot, we see that nothing has been deployed yet! Let's swap the slots now.\n\n### Swap to Green slot\n\nOnce we have verified that our deployment to the blue slot has been successful, we can deploy our container image to the green slot. We can do this using the following job in our GitHub Actions workflow:\n\n```yaml\nswap-to-green-slot:\n    runs-on: ubuntu-latest\n    environment: Dev\n    needs: deploy-to-blue-slot\n    steps:\n    - name: 'Checkout GitHub Action'\n      uses: actions/checkout@main\n      \n    - name: 'Login via Azure CLI'\n      uses: azure/login@v1\n      with:\n        creds: ${{ secrets.AZURE_CREDENTIALS }}\n\n    - name: 'Get App Name'\n      id: getwebappname\n      run: |\n        a=$(az webapp list -g ${{ secrets.AZURE_RG }} --query '[].{Name:name}' -o tsv)\n        echo \"::set-output name=appName::$a\"\n\n    - name: 'Swap to green slot'\n      uses: Azure/cli@v1\n      with:\n        inlineScript: |\n          az webapp deployment slot swap --slot 'blue' --resource-group ${{ secrets.AZURE_RG }} --name ${{ steps.getwebappname.outputs.appName }}\n```\n\nIn this job, we use environments to manually approve the deployment to our production slot provided that our deployment to the blue slot was successful. We can assign a user or users that need to approve the deployment before this job runs.\n\nIn this sample, we just use this as a manual approval step. In production scenarios, it's a good idea to run automation tests to ensure that your new container image works as expected before deploying to your production slots.\n\nTo learn more about how environments work in GitHub Actions, check out the following [documentation](https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment).\n\nFinally, we initiate the swap to the production slot by using the AZ CLI. Here are just swapping from our blue slot into our green slot. To learn more about how we can work with slots using the AZ CLI, please review the following [documentation](https://docs.microsoft.com/en-us/cli/azure/webapp/deployment/slot?view=azure-cli-latest#commands).\n\nAs with out green slot, we should get a URL. Since this is our production slot, our URL won't have a slot name within it's URL.\n\nNavigate to the URL and you can see that we've successful swapped to our green slot!\n\n![Our shiny new production app](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/b2on46d641ctbn4t49ro.png)\n\n## Conclusion\n\nIf you're deploying containers to Azure App Service, hopefully this has helped you see that you can use Blue/Green deployments to achieve zero-downtime deployments for your container images.\n\nThis was a basic example, so in your production scenarios you'll want to run comprehensive automation tests against your blue slot before swapping to the green slot. \n\nIf you have any questions, feel free to reach out to me on twitter [@willvelida](https://twitter.com/willvelida)\n\nUntil next time, Happy coding! 🤓🖥️\n\n",a.user={name:"Will Velida",username:s,twitter_username:s,github_username:s,website_url:"https://www.willvelida.com/",profile_image:"https://res.cloudinary.com/practicaldev/image/fetch/s--ZPE8_RYt--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/35069/dd0e9793-31a0-4578-9a0c-aa07426276b4.jpeg",profile_image_90:"https://res.cloudinary.com/practicaldev/image/fetch/s--o3pStKL8--/c_fill,f_auto,fl_progressive,h_90,q_auto,w_90/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/35069/dd0e9793-31a0-4578-9a0c-aa07426276b4.jpeg"},{layout:"default",data:[{}],fetch:{"data-v-70afb46a:0":{article:a}},error:n,state:{currentArticle:a},serverRendered:!0,routePath:"/willvelida/1002020",config:{_app:{basePath:"/nuxtstop/",assetsPath:"/nuxtstop/_nuxt/",cdnURL:n}}}}(null,"2022-02-26T05:25:41Z","willvelida",{},"https://dev.to/willvelida/implementing-bluegreen-deployments-with-azure-web-apps-for-containers-1gpd")</script><script src="/nuxtstop/_nuxt/f6e87fb.js" defer></script><script src="/nuxtstop/_nuxt/dc9ce94.js" defer></script><script src="/nuxtstop/_nuxt/6474719.js" defer></script><script src="/nuxtstop/_nuxt/9b75090.js" defer></script><script src="/nuxtstop/_nuxt/18df600.js" defer></script>
  </body>
</html>
