<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>The "DeRxJSViewModel Pattern": The E=mc^2 of State Management [Part 1]</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="Using Nuxt.js fetch() hook to build dev.to with a new look"><meta data-n-head="ssr" name="format-detection" content="telephone=no"><base href="/nuxtstop/"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,500,600&display=swap"><link rel="preload" href="/nuxtstop/_nuxt/f6e87fb.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/6474719.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/9b75090.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/18df600.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/dc9ce94.js" as="script"><style data-vue-ssr-id="c650fd98:0 af4684f0:0 a9c71758:0 dcafa518:0 4b9cec49:0 b093d766:0 9d98bcb4:0 6b6a11ea:0 0248ed80:0 ea8e4264:0">html{box-sizing:border-box;font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}*,:after,:before{box-sizing:inherit}html{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}*,:after,:before{border:0 solid #e0e0e0}blockquote,body,dd,dl,figure,h1,h2,h3,h4,h5,h6,p,pre{margin:0}button{background:0 0;padding:0}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}hr{border-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:inherit;opacity:.5}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:inherit;opacity:.5}input::placeholder,textarea::placeholder{color:inherit;opacity:.5}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit;font-family:sans-serif}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit;font-family:inherit;font-size:100%}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;overflow:auto;word-break:break-word;white-space:normal}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}html{height:100%;font-size:18px;-ms-overflow-style:scrollbar;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}@media(min-width:640px){html{font-size:20px}}body{height:100%;min-width:320px;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:400;line-height:1.5;color:#000;background-color:#eff4f7;-webkit-text-rendering:optimizeLegibility;text-rendering:optimizeLegibility;font-synthesis:none;font-kerning:normal;font-feature-settings:"normal","kern";-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-overflow-scrolling:touch;overflow-x:hidden;overflow-y:scroll}h1,h2,h3,h4,h5,h6{color:#000;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:600;font-feature-settings:"normal";line-height:1.2}pre{background:#29292e;border-radius:2px;overflow:auto;padding:1rem;color:#eff1f9;line-height:1.42em;font-size:13px}@media screen and (min-width:380px){pre{font-size:15px}}pre code{background:#29292e;color:#eff0f9;white-space:pre}div.highlight pre.highlight code{font-size:inherit;padding:0}div.inner-comment div.body div.highlight pre.highlight{background:#29292e}div.inner-comment div.body div.highlight pre.highlight code{font-size:inherit;white-space:inherit;background:inherit;color:inherit}.highlight .hll{background-color:#49483e}.highlight{background:#29292e;color:#f8f8f2}.highlight .c{color:grey}.highlight .err{text-shadow:0 0 7px #f9690e}.highlight .k{color:#f39c12}.highlight .l{color:plum}.highlight .n{color:#f8f8f2}.highlight .o{color:#f9690e}.highlight .p{color:#f8f8f2}.highlight .c1,.highlight .ch,.highlight .cm,.highlight .cp,.highlight .cpf,.highlight .cs{color:grey}.highlight .gd{color:#f9690e}.highlight .ge{font-style:italic}.highlight .gi{color:#7ed07e}.highlight .gs{font-weight:700}.highlight .gu{color:grey}.highlight .kc,.highlight .kd{color:#f39c12}.highlight .kn{color:#f9690e}.highlight .kp,.highlight .kr,.highlight .kt{color:#f39c12}.highlight .ld{color:#f2ca27}.highlight .m{color:plum}.highlight .s{color:#f2ca27}.highlight .na{color:#7ed07e}.highlight .nb{color:#f8f8f2}.highlight .nc{color:#7ed07e}.highlight .no{color:#f39c12}.highlight .nd{color:#7ed07e}.highlight .ni{color:#f8f8f2}.highlight .ne,.highlight .nf{color:#7ed07e}.highlight .nl,.highlight .nn{color:#f8f8f2}.highlight .nx{color:#7ed07e}.highlight .py{color:#f8f8f2}.highlight .nt{color:#f9690e}.highlight .nv{color:#f8f8f2}.highlight .ow{color:#f9690e}.highlight .w{color:#f8f8f2}.highlight .mb,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo{color:plum}.highlight .dl,.highlight .s2,.highlight .sa,.highlight .sb,.highlight .sc,.highlight .sd{color:#f2ca27}.highlight .se{color:plum}.highlight .s1,.highlight .sh,.highlight .si,.highlight .sr,.highlight .ss,.highlight .sx{color:#f2ca27}.highlight .bp{color:#f8f8f2}.highlight .fm{color:#7ed07e}.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{color:#f8f8f2}.highlight .il{color:plum}.vue-content-placeholders-heading__img,.vue-content-placeholders-heading__subtitle,.vue-content-placeholders-heading__title,.vue-content-placeholders-img,.vue-content-placeholders-text__line{background:#bfcdec!important}.vue-content-placeholders-is-animated .vue-content-placeholders-heading__img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__subtitle:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__title:before,.vue-content-placeholders-is-animated .vue-content-placeholders-img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-text__line:before{background:linear-gradient(90deg,transparent 0,#d3ddf9 15%,transparent 30%)!important}header[data-v-27046cca]{max-width:1280px;margin:auto;padding:1rem;height:6rem;border-bottom:1px solid rgba(0,0,0,.2)}header .logo-wrapper[data-v-27046cca],header[data-v-27046cca]{display:flex;align-items:center;justify-content:space-between}header .logo-wrapper[data-v-27046cca]{margin:0 .5rem}header .logo-wrapper svg[data-v-27046cca]{width:3rem;height:100%}header .logo-wrapper .name-wrapper[data-v-27046cca]{margin-left:.6em}header .logo-wrapper .name-wrapper .subtitle[data-v-27046cca]{font-size:1rem}header .logo-wrapper .name-wrapper .app-name[data-v-27046cca]{font-weight:700;font-size:2.25rem;line-height:1.25}header nav[data-v-27046cca]{letter-spacing:-.025rem;font-weight:600;text-transform:uppercase}header nav ul[data-v-27046cca]{display:flex}header nav ul li[data-v-27046cca]{margin:0 .5rem}header nav ul li a[data-v-27046cca]{box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;padding:.25rem 1rem;border-radius:.5rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}header nav ul li a[data-v-27046cca]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header nav ul li a.nuxt-link-exact-active[data-v-27046cca]{cursor:default}header nav ul li a.nuxt-link-exact-active[data-v-27046cca],header nav ul li a[data-v-27046cca]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}.page-wrapper[data-v-10d06ee8]{max-width:1280px;margin:auto;padding:1rem}.article-content-wrapper[data-v-10d06ee8]{display:flex;flex-direction:column;align-items:center;margin:auto auto 2rem}@media(min-width:1024px){.article-content-wrapper[data-v-10d06ee8]{align-items:normal;flex-direction:row}}.article-content-wrapper .article-block[data-v-10d06ee8]{width:100%;max-width:880px}@media(min-width:1024px){.article-content-wrapper .article-block[data-v-10d06ee8]{margin-right:1rem;width:66.66666%;margin-bottom:2rem}}.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{max-width:880px;width:100%;position:relative}@media(min-width:1024px){.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{display:block;width:33.33333%}}.article-content-wrapper .aside-username-wrapper .aside-username-block[data-v-10d06ee8]{position:-webkit-sticky;position:sticky;top:1rem}@media(min-width:1280px){.comments-block[data-v-10d06ee8]{margin:.5rem}}article[data-v-70afb46a]{padding:.5rem;border-radius:1rem}header h1[data-v-70afb46a],header[data-v-70afb46a]{margin-bottom:1rem}header h1[data-v-70afb46a]{font-size:2.25rem;letter-spacing:-.025rem}header .tags[data-v-70afb46a]{display:flex;flex-wrap:wrap;margin-bottom:1.5rem}header .tags .tag[data-v-70afb46a]{font-weight:500;line-height:1;padding:.5rem;margin:0 .5rem .5rem 0;border-radius:.25rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db}header .tags .tag[data-v-70afb46a]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header .tags .tag[data-v-70afb46a]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}header .image-wrapper[data-v-70afb46a]{position:relative;padding-bottom:56.25%;background-color:#d4dfe8;margin-bottom:1.5rem;border-radius:.5rem;overflow:hidden}@media(min-width:834px){header .image-wrapper[data-v-70afb46a]{margin-bottom:1.5rem}}header .image-wrapper img[data-v-70afb46a]{position:absolute;top:0;left:0;width:100%;height:100%;-o-object-fit:cover;object-fit:cover}header .meta[data-v-70afb46a]{line-height:1;font-size:.875rem;text-transform:uppercase;font-weight:500;letter-spacing:-.025rem;display:flex;align-items:center;justify-content:space-between}header .meta .scl[data-v-70afb46a]{display:flex}header .meta .scl span[data-v-70afb46a]{display:flex;align-items:center;margin-right:1rem}header .meta .scl span svg[data-v-70afb46a]{margin-right:.25rem}header .meta .scl .comments[data-v-70afb46a]{cursor:pointer}[data-v-70afb46a] .content .ltag__user{display:none}[data-v-70afb46a] .content iframe{max-width:100%}[data-v-70afb46a] .content h1{font-size:1.875rem}[data-v-70afb46a] .content h1,[data-v-70afb46a] .content h2{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h2{font-size:1.5rem}[data-v-70afb46a] .content h3{font-size:1.25rem}[data-v-70afb46a] .content h3,[data-v-70afb46a] .content h4{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h4{font-size:1rem}[data-v-70afb46a] .content a{color:#6e87d2}[data-v-70afb46a] .content p{margin-bottom:1rem;line-height:1.4}[data-v-70afb46a] .content p code{background-color:#d2f3e1;border-radius:.25rem;padding:.25rem}[data-v-70afb46a] .content img{width:100%;border-radius:.5rem}[data-v-70afb46a] .content .highlight{margin-bottom:1rem;border-radius:.5rem}[data-v-70afb46a] .content ul{list-style:numeral;margin-bottom:1rem}[data-v-70afb46a] .content ul li p{margin-bottom:0}[data-v-70afb46a] .content ol{margin-bottom:1rem}aside[data-v-37984f8c]{padding:1rem;background-color:#dfe8ef;border-radius:1rem}aside .username-heading[data-v-37984f8c]{display:flex;margin-bottom:1rem}aside .username-heading[data-v-37984f8c]:hover{color:#6e87d2}aside .username-heading img[data-v-37984f8c]{width:3rem;height:3rem;border-radius:50%;margin-right:1rem}aside .username-heading .text[data-v-37984f8c]{display:flex;flex-direction:column;justify-content:center}aside .username-heading .text a[data-v-37984f8c]{line-height:1}aside .username-heading .text a[data-v-37984f8c]:first-child{font-size:1.25rem;font-weight:500;letter-spacing:-.025rem;margin-bottom:.25rem}aside .username-heading .text a[data-v-37984f8c]:last-child{color:#999;font-size:.875rem}aside .username-heading.loading[data-v-37984f8c]{display:block}aside .f-button[data-v-37984f8c]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}aside .f-button[data-v-37984f8c]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}aside .f-button[data-v-37984f8c]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}aside .info>div[data-v-37984f8c]{margin-bottom:.5rem}aside .info .title[data-v-37984f8c]{font-size:.666666rem;letter-spacing:-.0125rem;font-weight:500;color:#999;text-transform:uppercase;margin-bottom:.1rem}aside .info .content[data-v-37984f8c]{font-size:.875rem;line-height:1.4}.add-comment[data-v-8c4375bc]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}.add-comment[data-v-8c4375bc]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}.add-comment[data-v-8c4375bc]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}footer[data-v-22cb8fd0]{padding:2rem;text-align:center;display:flex;align-items:center;justify-content:center}footer span[data-v-22cb8fd0]{display:inline-block;line-height:1;text-transform:uppercase;letter-spacing:-.025rem;font-size:.75rem;font-weight:500}footer a svg[data-v-22cb8fd0]{width:3rem;height:3rem;margin:0 .5rem}footer a .nuxt-icon[data-v-22cb8fd0]{width:2.5rem;height:2.5rem;margin:0 .25rem}</style>
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><div id="__layout"><div><header data-v-27046cca><a href="/nuxtstop/" class="logo-wrapper nuxt-link-active" data-v-27046cca><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-27046cca><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-27046cca></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-27046cca></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-27046cca></path></svg> <div class="name-wrapper" data-v-27046cca><span class="app-name" data-v-27046cca>Nuxtstop</span> <p class="subtitle" data-v-27046cca>For all things nuxt.js</p></div></a> <nav data-v-27046cca><ul data-v-27046cca><li data-v-27046cca><a href="/nuxtstop/" class="nuxt-link-active" data-v-27046cca>
          New
        </a></li><li data-v-27046cca><a href="/nuxtstop/top" data-v-27046cca>
          Top
        </a></li></ul></nav></header> <div class="page-wrapper" data-v-10d06ee8><div class="article-content-wrapper" data-v-10d06ee8><article data-fetch-key="data-v-70afb46a:0" class="article-block" data-v-70afb46a data-v-10d06ee8><header data-v-70afb46a><h1 data-v-70afb46a>The "DeRxJSViewModel Pattern": The E=mc^2 of State Management [Part 1]</h1> <div class="tags" data-v-70afb46a><a href="/nuxtstop/t/rxjs" class="tag" data-v-70afb46a>
          #rxjs
        </a><a href="/nuxtstop/t/typescript" class="tag" data-v-70afb46a>
          #typescript
        </a><a href="/nuxtstop/t/tdd" class="tag" data-v-70afb46a>
          #tdd
        </a><a href="/nuxtstop/t/nx" class="tag" data-v-70afb46a>
          #nx
        </a></div> <div class="image-wrapper" data-v-70afb46a><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--sI654xZQ--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/y69zi8zela4vqt38ztnd.png" alt='The "DeRxJSViewModel Pattern": The E=mc^2 of State Management [Part 1]' data-v-70afb46a></div> <div class="meta" data-v-70afb46a><div class="scl" data-v-70afb46a><span data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M16.4444 3C14.6733 3 13.0333 3.94162 12 5.34C10.9667 3.94162 9.32667 3 7.55556 3C4.49222 3 2 5.52338 2 8.625C2 14.8024 11.0267 20.586 11.4122 20.829C11.5922 20.9426 11.7956 21 12 21C12.2044 21 12.4078 20.9426 12.5878 20.829C12.9733 20.586 22 14.8024 22 8.625C22 5.52338 19.5078 3 16.4444 3Z" fill="#FF0000" data-v-70afb46a data-v-70afb46a></path></svg>
            15
          </span> <span class="comments" data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M6.11765 22H4.94118L5.64706 21.05C6.11765 20.3969 6.41176 19.5656 6.58824 18.5563C3.64706 17.1906 2 14.6375 2 11.3125C2 6.20625 5.82353 3 12 3C18.1765 3 22 6.20625 22 11.3125C22 16.5375 18.2353 19.625 12 19.625H11.5882C10.6471 20.7531 9 22 6.11765 22ZM12 4.1875C6.47059 4.1875 3.17647 6.85937 3.17647 11.3125C3.17647 15.1125 5.47059 16.8938 7.41177 17.6656L7.82353 17.8437L7.76471 18.3187C7.64706 19.2687 7.47059 20.1 7.11765 20.8125C9.05882 20.575 10.1765 19.5656 10.8235 18.7344L11 18.4969H12C19.9412 18.4969 20.8235 13.5094 20.8235 11.3719C20.8235 6.85938 17.5294 4.1875 12 4.1875Z" fill="black" data-v-70afb46a data-v-70afb46a></path></svg>
            0
          </span></div> <time data-v-70afb46a>Oct 8 '21</time></div></header> <div class="content" data-v-70afb46a><h2>
  <a name="part-1-creating-a-blue-print-setting-up-tdd-and-test-specs-to-be-certain-that-our-code-is-built-to-spec" href="#part-1-creating-a-blue-print-setting-up-tdd-and-test-specs-to-be-certain-that-our-code-is-built-to-spec">
  </a>
  Part 1: Creating a Blue Print, setting up TDD and Test Specs to Be CERTAIN that Our Code is Built to Spec.
</h2>

<h3>
  <a name="what-well-learn-in-this-article" href="#what-well-learn-in-this-article">
  </a>
  What we'll learn in this article
</h3>

<p>Hi everyone! 👋</p>

<p>Today, I'm going to share and analyze a pattern that I've become quite fond of recently for managing state management in a way that is truly domain agnostic.</p>

<p>We'll do this by first discussing a new pattern for implementing state management code using RxJS in this article. In a follow up article (that I've committed to releasing next friday), we'll demonstrate its "domain agnosticism" by using the same code to create a small app in vanilla JS [by which I simply mean "JS without a framework/library"], Angular, and React.</p>

<p>There's something of a prerequisite of some more basic JS knowledge, and familiarity with RxJS would helpful here, but my goal is for this to be accessible for junior and senior engineers alike!</p>

<p>Also before we proceed, [not-so-]coincidentally, I've recently published a new npm package to the registry that we'll be using in this series: <a href="https://www.npmjs.com/package/@derxjs/view-model">🎉🎉🎉 @derxjs/view-model 🎉🎉🎉</a>.</p>

<p><a href="https://www.npmjs.com/package/@derxjs/view-model"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--FNN3j4tt--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/qob5vohblg6w4gg4n2sq.png" alt="The @derxjs logo" loading="lazy"></a></p>

<p>Installing the package is not necessary for this article, but I'm very excited for <a href="https://www.npmjs.com/package/@derxjs/view-model#user-content-derxjs-roadmap">our roadmap</a> as I think that this had the potential to be a huge <code>E = mc^2</code> moment (more on that later!), so I highly recommend that you check it out. </p>

<p>Here's how the work will break down:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--mEXBzXnr--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/uw9ogp9c165j1dail32y.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--mEXBzXnr--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/uw9ogp9c165j1dail32y.png" alt="Breaking Down the Work into tasks" loading="lazy"></a></p>

<p>First part we'll need to do is create TS types, which will serve as our blueprint for the lego blocks.</p>

<p>From there, it doesn't really matter which of the 5 second-tier tasks we take on next, but in some order, we're going to:</p>

<ul>
<li>create our ViewModel tests</li>
<li>build out the ViewModel implementation</li>
<li>create a "vanilla" JS app</li>
<li>create an Angular app</li>
<li>create a React app</li>
</ul>

<p>In another world, we could even potentially have 5 different developers each working on these tasks in parallel if we had the resources for that!</p>

<p>Unfortunately, my brain (and articles in general) is for the most part only single threaded, [insert huberman labs link on double focus] so instead, our path through these tasks is going to look like this:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--XSksMTXB--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ynlcclvx2w8ei7ee2gsz.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--XSksMTXB--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ynlcclvx2w8ei7ee2gsz.png" alt="Our Path Through The tasks" loading="lazy"></a></p>

<p>In this article, we'll create our <code>@derxjs/view-model</code> TS types, then write out our tests, and then finally use TDD to implement our spec with absolute confidence that we built what we set out to build.</p>

<p>Next week, we'll put this all to good use, creating 3 webapps with 3 different frameworks.</p>

<p>So without further ado..... let's do this!!!</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--aZ-m7rN8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://c.tenor.com/Joc-buLiXcsAAAAd/disney-pixar.gif" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--aZ-m7rN8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://c.tenor.com/Joc-buLiXcsAAAAd/disney-pixar.gif" alt="Adventure is out there!" loading="lazy" data-animated="true"></a></p>

<h3>
  <a name="establishing-our-tools" href="#establishing-our-tools">
  </a>
  Establishing our tools
</h3>

<p>[This section is designed more for junior developers - please feel free to skip these if you're already familiar with Ts and Observables and RxJS]</p>

<h4>
  <a name="typescript" href="#typescript">
  </a>
  Typescript
</h4>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--NR5IHa4V--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/x1o4adep3myqjl4y228v.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--NR5IHa4V--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/x1o4adep3myqjl4y228v.png" alt="Typescript Logo" loading="lazy"></a></p>

<p>For this article, we'll be using <a href="https://www.typescriptlang.org/docs/handbook/interfaces.html">Typescript interfaces</a> to help us think about our problem, and to help us to architect a solution. In the context of our view model pattern, Typescript will allow us to create a "shape" of the view model data that our particular "domains" (think vanilla JS, Angular, and React) will leverage to create our html from that data (this is also known as "templating").</p>

<p>Think of TS as a blueprint that we'll use early on in our development process to lay out our problem, that we'll continue to leverage and keep us honest as we actually build our solution out.</p>

<h4>
  <a name="rxjs" href="#rxjs">
  </a>
  RxJS
</h4>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--adsn4nnC--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/fq1ikg9rkvpoecq7rsyi.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--adsn4nnC--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/fq1ikg9rkvpoecq7rsyi.png" alt="RxJS Logo" loading="lazy"></a></p>

<p><a href="https://rxjs.dev/">RxJS</a> is a library we'll use to compose observable event streams (or <code>Observable</code>s) in our code. I advise that it's best to think of <code>Observable</code>s as "Timelines".</p>

<p>RxJS also introduces the idea of an "operator" as a function that takes an <code>Observable</code> and returns a new <code>Observable</code>. In the context of our "<code>Observable</code>s as 'Timelines'" mental model then, an operator is a function that takes a "Timeline" as input, and returns a new "Timeline" as output.</p>

<p><iframe width="710" height="399" src="https://www.youtube.com/embed/Wj7ffKH9GnU" allowfullscreen loading="lazy">
</iframe>
<br>
(^ this is a talk  I gave on <code>Observable</code>s as "Timelines" at RxJS Live 2021.)</p>

<p>The “Pro’s” of RxJS are:</p>

<ul>
<li>Extreme precision and control over code</li>
<li>ability to write tests with a higher order of magnitude of precision</li>
<li>Declarative, expressive, powerful code</li>
<li>Huge potential for composability</li>
<li>A perfect mental model and toolset for frontend web development (essentially a flurry of user-generated events with no guaranteed sequence)</li>
</ul>

<p>The “Con’s”: </p>

<ul>
<li>Takes a long time to fully understand</li>
<li>Even if YOU make the investment to learn it, hard to pass that buck off onto the next developer to use our code [makes it difficult to scale]</li>
<li>Many complicated/confusing dimensions

<ul>
<li>"Observable joining strategies" (merge, switch, exhaust, concat)</li>
<li>Hot vs. Cold vs. Luke-Warm (cold observable sourced with a hot observable)</li>
<li>Behavior vs. Replay vs. plain vs. "Async" emmission strategy</li>
</ul>
</li>
<li>“Dangerous”

<ul>
<li>Risk of “leaky subscriptions”</li>
<li>Risk of wrong implementation bugs</li>
<li>Risk of poor implementation leading to even worse code (the only thing worse than complicated imperative code is a complicated mess of imperative code with a healthy chunk of “reactive” code mixed in)</li>
</ul>
</li>
<li>They flood the call stack, making debugging untennable (this is especially unfortunate as bugs in your RxJS code are probably the kind of bugs that we need good debugging tools for the MOST)</li>
</ul>

<p>In many ways, the pattern recommended in this article (and supported on @derxjs packages) is designed to squeeze all the awesome benefits out of RxJS, while avoiding all the nasty pitfalls:</p>

<ul>
<li>Our view model function will take as input an <code>Observable</code> of our user's events</li>
<li>It will return as output a single  <code>Observable</code> of our <code>ViewModel</code> interface</li>
<li>We'll build out extensive, precise test suite BEFORE starting our implementation to ensure that we're developing EXACTLY what we set out to build.</li>
<li>We'll use operators inside of our implementation to compose the transition of the input <code>Observable</code>s to the output <code>Observable</code>
</li>
</ul>
<h3>
  <a name="what-is-the-derxjs-view-model-pattern" href="#what-is-the-derxjs-view-model-pattern">
  </a>
  What is the "DeRxJS View Model" Pattern?
</h3>

<p>The basic idea for the "DeRxJS View Model" pattern is:</p>

<ul>
<li>Pass Observables in (along with maybe a few functions or pieces of data)</li>
<li>Get a single Observable out</li>
<li>Use your framework of choice for templating (turning the output Observable from #2 into html).</li>
</ul>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--kHU_8poP--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/4js0csir90fph4tpm21j.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--kHU_8poP--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/4js0csir90fph4tpm21j.png" alt="Diagram of the DeRxJS View Model Pattern" loading="lazy"></a></p>
<h4>
  <a name="the-raw-e-mc2-endraw-of-state-management" href="#the-raw-e-mc2-endraw-of-state-management">
  </a>
  The <code>E = mc^2</code> of State Management
</h4>


<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">rxjs</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">type</span> <span class="nx">DeRxJSViewModel</span><span class="o">&lt;</span><span class="nx">InputType</span><span class="p">,</span> <span class="nx">ViewModelType</span><span class="o">></span> <span class="o">=</span> <span class="p">(</span>
  <span class="nx">inputs</span><span class="p">:</span> <span class="nx">InputType</span>
<span class="p">)</span> <span class="o">=></span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">ViewModelType</span><span class="o">></span><span class="p">;</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>


<p>^ The core of my <code>@derxjs</code> approach are these 5 lines of Typescript code. It's deceptively simple, but my hypothesis is, this pattern is elegant enough to encompass any && all possible state management requirements. It's a powerful core that has lots of potential as a pattern and mental model - as well as potential tools and utility code we can build on top of it!</p>

<p>To use this type, simply install the package (<code>npm i @derxjs/view-model</code>) and import the type into your code (<code>import { DeRxJSViewModel } from '@derxjs/view-model';</code>) [don't worry, I'll show it in use in our actual code snippets as well!].</p>

<p>If you want to opt out though - you can always just copy these 5 lines of code, and be on your merry way :).</p>
<h3>
  <a name="introducing-the-problem-tic-tac-toe" href="#introducing-the-problem-tic-tac-toe">
  </a>
  Introducing the problem: Tic Tac Toe
</h3>

<p>Our example problem for today: creating a Tic Tac Toe game.</p>
<h4>
  <a name="lets-break-this-idea-down-to-a-rough-spec-in-english" href="#lets-break-this-idea-down-to-a-rough-spec-in-english">
  </a>
  Let's break this idea down to a rough spec in English:
</h4>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--_5rvXT6z--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://media.makeameme.org/created/stand-back-i-bf0dce.jpg" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--_5rvXT6z--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://media.makeameme.org/created/stand-back-i-bf0dce.jpg" alt="Stand back. I am writing a spec" loading="lazy"></a></p>
<h5>
  <a name="presentational-concerns" href="#presentational-concerns">
  </a>
  Presentational concerns
</h5>

<ul>
<li>The user will need to see a 3x3 grid that will operate as our game board. We'll make this a 3x3 grid of buttons, and we'll need in our view model some way of modeling/structuring this data.</li>
<li>We'll want to allow the user to reset the game at anypoint (even while the computer is "thinking"). This should empty the board and make it their turn.</li>
</ul>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--BTIYvJ8R--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/pnh99w31ohy7g5oo9qrz.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--BTIYvJ8R--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/pnh99w31ohy7g5oo9qrz.png" alt="Alt Text" loading="lazy"></a></p>
<h5>
  <a name="logical-concerns" href="#logical-concerns">
  </a>
  Logical concerns
</h5>

<ul>
<li>We'll want to introduce the idea of "turns" to the game. During the user's turn, they should be allowed to click a button, but after clicking a button, they shouldn't be allowed to move until the computer opponent makes a move. We'll also want to make this feedback prominent to the user.</li>
<li>We'll need some AI for our computer opponent. As cool as it would be to use some GPT-3 here, instead, let's opt for a Random Number Generator (RNG) to act in the place of our AI, and we'll simulate our AI thinking by adding in a delay of 2 seconds before the computer player makes their move.</li>
<li>If the game is over (if either our player or the computer wins, or if the board is full and neither player won) we'll want to inform the user, and they'll need hit restart to play again.</li>
</ul>
<h4>
  <a name="creating-a-typescript-blue-print" href="#creating-a-typescript-blue-print">
  </a>
  Creating a Typescript blue print
</h4>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--c63ZNX8V--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://getsynapse.com/wp-content/uploads/2019/09/blueprint.jpg" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--c63ZNX8V--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://getsynapse.com/wp-content/uploads/2019/09/blueprint.jpg" alt="Image of a Blueprint" loading="lazy"></a></p>

<p>Let's start by identifying the parameters of our system. The way I tend to think about this problem, the inputs come down to:</p>

<ol>
<li>the user's events selecting spaces on the board.</li>
<li>the user's events selecting the "restart game" option.</li>
<li>a function that will act as the ai that will define how our computer player will act.</li>
</ol>

<p>We can visualize the first 2 of these as Timelines, so we'll represent them as Observables - for the selection of spaces by the user, we'll represent that event with an object that states the column and row the user selected, and for the reset button clicks, the contents of the event actually doesn't matter much (just the fact that it happened is really all we need!).</p>

<p>For our ai, we'll define it as some function that will take a  given <code>Board</code> and the computer's letter (x or o) and return the <code>SpaceCoordinates</code> for the space the computer will choose. This way we can pass in a determinist <code>ai</code> function for reliable testing of our code [but we'll see more on this later!!].</p>

<p>Let's transpose these to actual Typescript now:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="kr">interface</span> <span class="nx">TicTacToeViewModelParams</span> <span class="p">{</span>
  <span class="nx">userSpaceClickEvents$</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">SpaceCoordinates</span><span class="o">></span><span class="p">;</span>
  <span class="nx">userResetClickEvents$</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="k">void</span><span class="o">></span><span class="p">;</span>
  <span class="nl">ai</span><span class="p">:</span> <span class="nx">TicTacToeAi</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">SpaceCoordinates</span> <span class="p">{</span>
  <span class="nl">row</span><span class="p">:</span> <span class="nx">BoardIndex</span><span class="p">;</span>
  <span class="nl">column</span><span class="p">:</span> <span class="nx">BoardIndex</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">BoardIndex</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">|</span> <span class="mi">2</span><span class="p">;</span>

<span class="kd">type</span> <span class="nx">TicTacToeAi</span> <span class="o">=</span> <span class="p">(</span><span class="nx">params</span><span class="p">:</span> <span class="nx">AiParams</span><span class="p">)</span> <span class="o">=></span> <span class="nx">SpaceCoordinates</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">AiParams</span> <span class="p">{</span>
  <span class="nl">board</span><span class="p">:</span> <span class="nx">Board</span><span class="p">;</span>
  <span class="nl">aiLetter</span><span class="p">:</span> <span class="dl">'</span><span class="s1">o</span><span class="dl">'</span> <span class="o">|</span> <span class="dl">'</span><span class="s1">x</span><span class="dl">'</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Board</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">[</span><span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">],</span>
  <span class="p">[</span><span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">],</span>
  <span class="p">[</span><span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">],</span>
<span class="p">];</span>

<span class="kd">type</span> <span class="nx">SpaceContent</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">x</span><span class="dl">'</span> <span class="o">|</span> <span class="dl">'</span><span class="s1">o</span><span class="dl">'</span> <span class="o">|</span> <span class="dl">''</span><span class="p">;</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Next up, we'll create an interface for our View Model itself. We'll represent this with a <code>board</code> property that should contain a 3x3 array of either x's, o's, or empty spaces. The other thing we'll need is a <code>turn</code> property that will tell us if it's our turn, the computer's turn, or if the game is over.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="kr">interface</span> <span class="nx">TicTacToeViewModel</span> <span class="p">{</span>
  <span class="nl">board</span><span class="p">:</span> <span class="nx">Board</span><span class="p">;</span>
  <span class="nl">turn</span><span class="p">:</span> <span class="nx">Turn</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Turn</span> <span class="o">=</span>
  <span class="o">|</span> <span class="dl">'</span><span class="s1">your turn</span><span class="dl">'</span>
  <span class="o">|</span> <span class="s2">`computer's turn`</span>
  <span class="o">|</span> <span class="dl">'</span><span class="s1">game over - you win</span><span class="dl">'</span>
  <span class="o">|</span> <span class="dl">'</span><span class="s1">game over - you lose</span><span class="dl">'</span>
  <span class="o">|</span> <span class="s2">`game over - it's a tie`</span><span class="p">;</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>The last step is to combine these into a function that takes our inputs and returns an <code>Observable</code> of our view model. Let's set out that function's signature now!<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">DeRxJSViewModel</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@derxjs/view-model</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">ticTacToeViewModel$</span><span class="p">:</span> <span class="nx">DeRxJSViewModel</span><span class="o">&lt;</span>
  <span class="nx">TicTacToeViewModelParams</span><span class="p">,</span>
  <span class="nx">TicTacToeViewModel</span>
<span class="o">></span> <span class="o">=</span> <span class="p">({</span>
  <span class="nx">userSpaceClickEvents$</span><span class="p">,</span>
  <span class="nx">userResetClickEvents$</span><span class="p">,</span>
  <span class="nx">ai</span>
<span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
  <span class="c1">// implementation to go here</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>That about does it for our blueprint! Here's a rough blue print that matches our DeRxJS diagram from before:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--ueZd7K51--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/wijfnob15pdcu89b5vfc.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--ueZd7K51--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/wijfnob15pdcu89b5vfc.png" alt="Alt Text" loading="lazy"></a></p>

<p>As we mentioned prior, one of the best things architecturally about having done this work is we have 3 independent paths we could follow from here:</p>

<ul>
<li>implementing the function</li>
<li>templating our component (in any of the 3 frameworks)</li>
<li>writing tests for our function!</li>
</ul>

<p>To reiterate: in another scenario, we could even potentially have 3 different developers each working on a different branch of these three things at once.</p>

<p>Since our brains are mostly single-threaded though, let's start with writing tests for our function, then implementing the function, then templating!</p>

<h3>
  <a name="tdd-and-setting-up-our-timeline-tests-for-our-view-model" href="#tdd-and-setting-up-our-timeline-tests-for-our-view-model">
  </a>
  TDD and setting up our Timeline Tests for our View Model
</h3>

<p>For a sneak peak of this in real code, go check out the example .spec file in the @derxjs repo (maybe go give us a start there too if you feel like it! :))</p>

<p>So, let's break this concept down && use some cool visualizations in the process. Before we get into that, let's address one big hairy issue about our specific system: RNG.</p>

<p>Our spec requires that the ai choose a valid space at random. The AI being random immediately throws off a key component of a reliable test suite: being deterministic (or "the same thing happening EVERY time").</p>

<p>Luckily, we thought of this before designing our system :). Because the <code>ai()</code> function is passed in as a parameter to our function, we can pass in a "deterministic AI" to our view model for our test, and then a "random AI" to our actual implementation (we could also come up with some other cool "flavors" of AI if we wanted - feel free to take this code and go nuts with it if you like! Would be cool to see someone come up with an "I always lose" AI.)</p>

<p>To get this, let's quickly draft out this ai function:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="kd">const</span> <span class="nx">testAiFunction</span><span class="p">:</span> <span class="nx">TicTacToeAi</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">board</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">i</span> <span class="k">of</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="k">as</span> <span class="kd">const</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">j</span> <span class="k">of</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="k">as</span> <span class="kd">const</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]</span> <span class="o">===</span> <span class="dl">''</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="nx">i</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="nx">j</span> <span class="p">};</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Ai was passed a full board. This should never happen</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">};</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>We should see the following behavior from this AI:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--J6qWBkj---/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/g1elo3vr39eqw8iqyx7n.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--J6qWBkj---/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/g1elo3vr39eqw8iqyx7n.png" alt="Alt Text" loading="lazy"></a></p>

<p>Very cool. By leveraging functions (for the people who like terminology, this is technically a "higher order function" as the DeRxJSViewModel is a function that took this <code>ai()</code> function as a parameter), we can see that we are able to pretty effortlessly make our system very highly configurable! If we wanted to - we could actually have passed in an <code>async</code> function (or a function that returns a <code>Promise</code>) here as well, and built in the 2 second delay right into our AI for even more configurability, but I think this is enough complexity for now.</p>

<p>Btw - if you thought passing functions was cool - just wait until what we can do when passing in observables as input!!</p>

<h4>
  <a name="the-test-suite" href="#the-test-suite">
  </a>
  The Test Suite
</h4>

<p>We want to build out a test to cover our system. In general, we want to make sure we hit most of our edge cases and then maybe run the whole way through a couple times.</p>

<p>It's usually nice to start with a nice basic base-case, so let's start with an empty board where the user never makes any actions:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--npYtM4I9--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/9vzlm2zgmjwsam939tzp.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--npYtM4I9--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/9vzlm2zgmjwsam939tzp.png" alt="Alt Text" loading="lazy"></a></p>

<p>(Since we'll always use the same <code>ai()</code> function for every test, I've skipped that in the diagrams) but as we can see, this very basic test shows that with no user events, we start out with an empty board, and that board never changes.</p>

<p>Here's the code for this exact scenario:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">with no user events, the board stays empty</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=></span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">firstUserState</span> <span class="o">=</span> <span class="nx">createInitialViewModel</span><span class="p">();</span>
    <span class="nx">testScheduler</span><span class="p">.</span><span class="nx">run</span><span class="p">(({</span> <span class="nx">cold</span><span class="p">,</span> <span class="nx">expectObservable</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">userBoardClicks</span> <span class="o">=</span> <span class="nx">cold</span><span class="o">&lt;</span><span class="nx">SpaceCoordinates</span><span class="o">></span><span class="p">(</span><span class="dl">'</span><span class="s1">------</span><span class="dl">'</span><span class="p">);</span>
      <span class="kd">const</span> <span class="nx">userResetClicks</span> <span class="o">=</span> <span class="nx">cold</span><span class="o">&lt;</span><span class="k">void</span><span class="o">></span><span class="p">(</span><span class="dl">'</span><span class="s1">------</span><span class="dl">'</span><span class="p">);</span>
      <span class="kd">const</span> <span class="nx">expected</span> <span class="o">=</span> <span class="nx">cold</span><span class="p">(</span><span class="dl">'</span><span class="s1">a-----</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">a</span><span class="p">:</span> <span class="nx">firstUserState</span> <span class="p">});</span>
      <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">ticTacToeViewModel$</span><span class="p">({</span>
        <span class="nx">userSpaceClickEvents</span><span class="na">$</span><span class="p">:</span> <span class="nx">userBoardClicks</span><span class="p">,</span>
        <span class="nx">userResetClickEvents</span><span class="na">$</span><span class="p">:</span> <span class="nx">userResetClicks</span><span class="p">,</span>
        <span class="na">ai</span><span class="p">:</span> <span class="nx">testAiFunction</span><span class="p">,</span>
      <span class="p">});</span>
      <span class="nx">expectObservable</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expected</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Notice the ASCII art syntax!! While it's not bad here, I think it gets a bit of a bad rap for being a bit cumbersome to work with, and not without good reason! I was helping out with trying to line up these ASCII art kind of tests on the rxjs codebase, so I can vouch that it's not fun! (I think I got through 3 operators before I gave up :()</p>

<p>(@derxjs is working on a nice gui tool to "draw" out these timelines and spit out working jest .spec.ts files - but that's an article for another time)</p>

<p>Also notice the <code>testScheduler</code>! We'll touch on this in the next example: </p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--v7CsZQNp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/4xwl0b2r4o5tmzfws4uf.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--v7CsZQNp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/4xwl0b2r4o5tmzfws4uf.png" alt="Alt Text" loading="lazy"></a></p>

<p>So in this example, we can see the player chooses the center square - note the dotted vertical line! This shows us how the timelines are aligned horizontally so that  the moment we observe the user select the middle square, we should immediately observe a new state in our UI - reflecting an 'x' in that square and showing that it is now the 'computer's' turn to move. Then 2 seconds later (2 seconds of "virtual time" thanks to our TestScheduler!!) we should see our AI move to that first open slot in the top left corner, and it should now be our player's turn again.</p>

<p>So to recap: our timeline test is showing us that for the given inputs (the two observables/timelines) here's the expected timeline.</p>

<p>Remember when we discussed the expressive power of the <code>ai()</code> function as a parameter to our tic-tac-toe system? These observable inputs are actually bringing in with them AN INFINITE NUMBER OF POTENTIAL FUTURES, EVENTS, AND COMBINATIONS OF EVENTS</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--qM6Qx4xE--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://c.tenor.com/qU7kKSP7JgsAAAAM/big-brain-lateralus.gif" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--qM6Qx4xE--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://c.tenor.com/qU7kKSP7JgsAAAAM/big-brain-lateralus.gif" alt="infinite worlds" loading="lazy" data-animated="true"></a></p>

<p>and our viewModel function is [attempting] to WRANGLE EVERY SINGLE LAST ONE of them and handle them appropriately, and RxJS is masterful at allowing us to do so.</p>

<p>Part of the reason I'm so long on these timeline tests are because of how good they are at setting a mental model - and especially with RxJS code being so difficult to debug, these marble tests become even MORE valuable! After all, you don't have to debug what ain't broke!</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--UhRIyWQ0--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://c.tenor.com/xnDaGHW7i9QAAAAC/hm-hmm.gif" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--UhRIyWQ0--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://c.tenor.com/xnDaGHW7i9QAAAAC/hm-hmm.gif" alt="You don't have to debug what ain't broke!" loading="lazy" data-animated="true"></a></p>

<p>Here's the code for this test (notice things starting to get a bit more hairy!<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">computer player makes a move 1999ms after the player selects a square</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=></span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">initialState</span> <span class="o">=</span> <span class="nx">createInitialViewModel</span><span class="p">();</span>
    <span class="kd">const</span> <span class="na">userClick</span><span class="p">:</span> <span class="nx">SpaceCoordinates</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="na">column</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="kd">const</span> <span class="na">afterUserClick</span><span class="p">:</span> <span class="nx">TicTacToeViewModel</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">board</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">],</span>
        <span class="p">[</span><span class="dl">''</span><span class="p">,</span> <span class="dl">'</span><span class="s1">x</span><span class="dl">'</span><span class="p">,</span> <span class="dl">''</span><span class="p">],</span>
        <span class="p">[</span><span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">],</span>
      <span class="p">],</span>
      <span class="na">turn</span><span class="p">:</span> <span class="s2">`computer's turn`</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="kd">const</span> <span class="na">afterComputerMoves</span><span class="p">:</span> <span class="nx">TicTacToeViewModel</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">board</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="dl">'</span><span class="s1">o</span><span class="dl">'</span><span class="p">,</span> <span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">],</span>
        <span class="p">[</span><span class="dl">''</span><span class="p">,</span> <span class="dl">'</span><span class="s1">x</span><span class="dl">'</span><span class="p">,</span> <span class="dl">''</span><span class="p">],</span>
        <span class="p">[</span><span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">],</span>
      <span class="p">],</span>
      <span class="na">turn</span><span class="p">:</span> <span class="s2">`your turn`</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="nx">testScheduler</span><span class="p">.</span><span class="nx">run</span><span class="p">(({</span> <span class="nx">cold</span><span class="p">,</span> <span class="nx">expectObservable</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">userBoardClicks</span> <span class="o">=</span> <span class="nx">cold</span><span class="o">&lt;</span><span class="nx">SpaceCoordinates</span><span class="o">></span><span class="p">(</span><span class="dl">'</span><span class="s1">---a----</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">a</span><span class="p">:</span> <span class="nx">userClick</span><span class="p">,</span>
      <span class="p">});</span>
      <span class="kd">const</span> <span class="nx">userResetClicks</span> <span class="o">=</span> <span class="nx">cold</span><span class="o">&lt;</span><span class="k">void</span><span class="o">></span><span class="p">(</span><span class="dl">'</span><span class="s1">------</span><span class="dl">'</span><span class="p">);</span>
      <span class="kd">const</span> <span class="nx">expected</span> <span class="o">=</span> <span class="nx">cold</span><span class="p">(</span><span class="dl">'</span><span class="s1">a--b 1999ms c</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">a</span><span class="p">:</span> <span class="nx">initialState</span><span class="p">,</span>
        <span class="na">b</span><span class="p">:</span> <span class="nx">afterUserClick</span><span class="p">,</span>
        <span class="na">c</span><span class="p">:</span> <span class="nx">afterComputerMoves</span><span class="p">,</span>
      <span class="p">});</span>
      <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">ticTacToeViewModel$</span><span class="p">({</span>
        <span class="nx">userSpaceClickEvents</span><span class="na">$</span><span class="p">:</span> <span class="nx">userBoardClicks</span><span class="p">,</span>
        <span class="nx">userResetClickEvents</span><span class="na">$</span><span class="p">:</span> <span class="nx">userResetClicks</span><span class="p">,</span>
        <span class="na">ai</span><span class="p">:</span> <span class="nx">testAiFunction</span><span class="p">,</span>
      <span class="p">});</span>
      <span class="nx">expectObservable</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expected</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Let's move onto the next case: make sure that nothing happens when a player clicks on an already filled square (and also that nothing happens 2 seconds AFTER the user clicks that filled square.... for hopefully evident reasons!!)</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--xNK0zEeM--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/asko0aira49br3e19kuk.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--xNK0zEeM--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/asko0aira49br3e19kuk.png" alt="Alt Text" loading="lazy"></a></p>

<p>code:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">user click does nothing on an already filled square</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=></span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">initialState</span> <span class="o">=</span> <span class="nx">createInitialViewModel</span><span class="p">();</span>
    <span class="kd">const</span> <span class="na">userClicksCenterSquare</span><span class="p">:</span> <span class="nx">SpaceCoordinates</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="na">column</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="kd">const</span> <span class="na">afterUserClick</span><span class="p">:</span> <span class="nx">TicTacToeViewModel</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">board</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">],</span>
        <span class="p">[</span><span class="dl">''</span><span class="p">,</span> <span class="dl">'</span><span class="s1">x</span><span class="dl">'</span><span class="p">,</span> <span class="dl">''</span><span class="p">],</span>
        <span class="p">[</span><span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">],</span>
      <span class="p">],</span>
      <span class="na">turn</span><span class="p">:</span> <span class="s2">`computer's turn`</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="kd">const</span> <span class="na">afterComputerMoves</span><span class="p">:</span> <span class="nx">TicTacToeViewModel</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">board</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="dl">'</span><span class="s1">o</span><span class="dl">'</span><span class="p">,</span> <span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">],</span>
        <span class="p">[</span><span class="dl">''</span><span class="p">,</span> <span class="dl">'</span><span class="s1">x</span><span class="dl">'</span><span class="p">,</span> <span class="dl">''</span><span class="p">],</span>
        <span class="p">[</span><span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">],</span>
      <span class="p">],</span>
      <span class="na">turn</span><span class="p">:</span> <span class="s2">`your turn`</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="kd">const</span> <span class="na">userClicksComputersSquare</span><span class="p">:</span> <span class="nx">SpaceCoordinates</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">row</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="na">column</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="nx">testScheduler</span><span class="p">.</span><span class="nx">run</span><span class="p">(({</span> <span class="nx">cold</span><span class="p">,</span> <span class="nx">expectObservable</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">userBoardClicks</span> <span class="o">=</span> <span class="nx">cold</span><span class="o">&lt;</span><span class="nx">SpaceCoordinates</span><span class="o">></span><span class="p">(</span><span class="dl">'</span><span class="s1">---a 3s a-b-aaaa-bbbb-</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">a</span><span class="p">:</span> <span class="nx">userClicksCenterSquare</span><span class="p">,</span>
        <span class="na">b</span><span class="p">:</span> <span class="nx">userClicksComputersSquare</span><span class="p">,</span>
      <span class="p">});</span>
      <span class="kd">const</span> <span class="nx">userResetClicks</span> <span class="o">=</span> <span class="nx">cold</span><span class="o">&lt;</span><span class="k">void</span><span class="o">></span><span class="p">(</span><span class="dl">'</span><span class="s1">------</span><span class="dl">'</span><span class="p">);</span>
      <span class="kd">const</span> <span class="nx">expected</span> <span class="o">=</span> <span class="nx">cold</span><span class="p">(</span><span class="dl">'</span><span class="s1">a--b 1999ms c</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">a</span><span class="p">:</span> <span class="nx">initialState</span><span class="p">,</span>
        <span class="na">b</span><span class="p">:</span> <span class="nx">afterUserClick</span><span class="p">,</span>
        <span class="na">c</span><span class="p">:</span> <span class="nx">afterComputerMoves</span><span class="p">,</span>
      <span class="p">});</span>
      <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">ticTacToeViewModel$</span><span class="p">({</span>
        <span class="nx">userSpaceClickEvents</span><span class="na">$</span><span class="p">:</span> <span class="nx">userBoardClicks</span><span class="p">,</span>
        <span class="nx">userResetClickEvents</span><span class="na">$</span><span class="p">:</span> <span class="nx">userResetClicks</span><span class="p">,</span>
        <span class="na">ai</span><span class="p">:</span> <span class="nx">testAiFunction</span><span class="p">,</span>
      <span class="p">});</span>
      <span class="nx">expectObservable</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expected</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Notice our output looks the same, even though our user is spamming those selected squares!</p>

<p>Next up: The reset button works</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--ckFjE1aq--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1l3trc7oxnc1msmr2wo2.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--ckFjE1aq--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1l3trc7oxnc1msmr2wo2.png" alt="Alt Text" loading="lazy"></a><br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">reset button works</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=></span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">initialState</span> <span class="o">=</span> <span class="nx">createInitialViewModel</span><span class="p">();</span>
    <span class="kd">const</span> <span class="na">userClicksCenterSquare</span><span class="p">:</span> <span class="nx">SpaceCoordinates</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="na">column</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="kd">const</span> <span class="na">afterUserClick</span><span class="p">:</span> <span class="nx">TicTacToeViewModel</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">board</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">],</span>
        <span class="p">[</span><span class="dl">''</span><span class="p">,</span> <span class="dl">'</span><span class="s1">x</span><span class="dl">'</span><span class="p">,</span> <span class="dl">''</span><span class="p">],</span>
        <span class="p">[</span><span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">],</span>
      <span class="p">],</span>
      <span class="na">turn</span><span class="p">:</span> <span class="s2">`computer's turn`</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="kd">const</span> <span class="na">afterComputerMoves</span><span class="p">:</span> <span class="nx">TicTacToeViewModel</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">board</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="dl">'</span><span class="s1">o</span><span class="dl">'</span><span class="p">,</span> <span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">],</span>
        <span class="p">[</span><span class="dl">''</span><span class="p">,</span> <span class="dl">'</span><span class="s1">x</span><span class="dl">'</span><span class="p">,</span> <span class="dl">''</span><span class="p">],</span>
        <span class="p">[</span><span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">],</span>
      <span class="p">],</span>
      <span class="na">turn</span><span class="p">:</span> <span class="s2">`your turn`</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="nx">testScheduler</span><span class="p">.</span><span class="nx">run</span><span class="p">(({</span> <span class="nx">cold</span><span class="p">,</span> <span class="nx">expectObservable</span> <span class="p">})</span> <span class="o">=></span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">userBoardClicks</span> <span class="o">=</span> <span class="nx">cold</span><span class="o">&lt;</span><span class="nx">SpaceCoordinates</span><span class="o">></span><span class="p">(</span><span class="dl">'</span><span class="s1">---a------</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">a</span><span class="p">:</span> <span class="nx">userClicksCenterSquare</span><span class="p">,</span>
      <span class="p">});</span>
      <span class="kd">const</span> <span class="nx">userResetClicks</span> <span class="o">=</span> <span class="nx">cold</span><span class="o">&lt;</span><span class="k">void</span><span class="o">></span><span class="p">(</span><span class="dl">'</span><span class="s1">---- 1999ms ---a</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">a</span><span class="p">:</span> <span class="kc">undefined</span> <span class="p">});</span>
      <span class="kd">const</span> <span class="nx">expected</span> <span class="o">=</span> <span class="nx">cold</span><span class="p">(</span><span class="dl">'</span><span class="s1">a--b 1999ms c--a</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">a</span><span class="p">:</span> <span class="nx">initialState</span><span class="p">,</span>
        <span class="na">b</span><span class="p">:</span> <span class="nx">afterUserClick</span><span class="p">,</span>
        <span class="na">c</span><span class="p">:</span> <span class="nx">afterComputerMoves</span><span class="p">,</span>
      <span class="p">});</span>
      <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">ticTacToeViewModel$</span><span class="p">({</span>
        <span class="nx">userSpaceClickEvents</span><span class="na">$</span><span class="p">:</span> <span class="nx">userBoardClicks</span><span class="p">,</span>
        <span class="nx">userResetClickEvents</span><span class="na">$</span><span class="p">:</span> <span class="nx">userResetClicks</span><span class="p">,</span>
        <span class="na">ai</span><span class="p">:</span> <span class="nx">testAiFunction</span><span class="p">,</span>
      <span class="p">});</span>
      <span class="nx">expectObservable</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expected</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Fairly straight-forward - but it will be a good marker to let us know if the most basic functionality of resetting our game is working properly</p>

<p>Next one is around the same reset case, with a twist: the user can reset the game while the computer is "thinking" (making sure that the move the computer would have made is appropriately "cancelled"!)</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--RsZwSrUl--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/0o83nc4a46a0d2jh2yla.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--RsZwSrUl--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/0o83nc4a46a0d2jh2yla.png" alt="Alt Text" loading="lazy"></a></p>

<p>I think that covers it for most of the potential edge cases of our system! For good measure, I'd also throw a couple fully-played out games as well just to be sure that we can make it all the way through a game without issues (I'm not gonna diagram those out here, but you can see it in action for yourself in <a href="https://github.com/ZackDeRose/derxjs/blob/main/libs/examples/tic-tac-toe-view-model-implementation/src/lib/view-model.spec.ts">the @derxjs codebase :)</a>)</p>

<p>Run the test suite now if you like:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight shell"><code>git clone https://github.com/ZackDeRose/derxjs.git
<span class="nb">cd </span>derxjs
npm i
npx nx <span class="nb">test </span>examples-tic-tac-toe-view-model-implementation
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<h3>
  <a name="implementing-our-derxjs-view-model-pattern" href="#implementing-our-derxjs-view-model-pattern">
  </a>
  Implementing our "DeRxJS View Model" Pattern
</h3>

<p>Alright, so we've got a fully fleshed out spec at this point - time to implement!</p>

<p>(Btw - if you want to give yourself a fun challenge now - go clone my derxjs repo and erase the contents of <code>tic-tac-tow-view-model-implementation/src/lib/view-model.spec</code>, and see if you can get the tests to pass before reading this section!)</p>

<p>We could honestly go a couple ways with this specific problem (in particular a 'state machine' approach would be a great fit for this - and I hope to do a proper XState implementation [maybe even a @derxjs/xstate package somewhere down the line!!] at some point in the future).</p>

<p>But because it's a pretty common pattern, we'll look at a "reducer" solution here!</p>

<p>If you're familiar with the JavaScript Array.reduce() method, that's a great place to start:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="kd">const</span> <span class="nx">foo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>

<span class="kd">function</span> <span class="nx">sum</span><span class="p">(</span><span class="nx">arr</span><span class="p">:</span> <span class="kr">number</span><span class="p">[]):</span> <span class="kr">number</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span>
    <span class="p">(</span><span class="nx">accumulator</span><span class="p">,</span> <span class="nx">arrayItem</span><span class="p">)</span> <span class="o">=></span> <span class="nx">accumulator</span> <span class="o">+</span> <span class="nx">arrayItem</span><span class="p">,</span>
    <span class="mi">0</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">sum</span><span class="p">(</span><span class="nx">foo</span><span class="p">));</span> <span class="c1">// 10</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>In this code, we used <code>reduce</code> to "reduce the contents of the array down to a single value: their sum." Notice that this too is a higher-order function (since it takes a function as a parameter), making it very versatile. You can do ALOT of things with reduce.</p>

<p>We're actually interested more in the reducer function though, specifically:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="p">(</span><span class="nx">accumulator</span><span class="p">,</span> <span class="nx">arrayItem</span><span class="p">)</span> <span class="o">=></span> <span class="nx">accumulator</span> <span class="o">+</span> <span class="nx">arrayItem</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>The idea for this function is that it will loop through the list and call this function for each item; the item itself going into the <code>arrayItem</code> param, and the return value of the prior function call going into the <code>accumulator</code> param.</p>

<p>In this way, we "reduce the array down to a sum"! Pretty cool.</p>

<p>We're going to take this same concept a bit further for our tic-tac-toe example now, expanding the anaology in 2 separate dimensions:</p>

<ol>
<li>Instead of numbers, we're going to reduce some set of "observed events" (think user clicks and ai moves) down into the <code>TicTacToeViewModel</code> interface from the prior section; here it is again if you missed it:
</li>
</ol>

<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="k">export</span> <span class="kr">interface</span> <span class="nx">TicTacToeViewModel</span> <span class="p">{</span>
  <span class="nl">board</span><span class="p">:</span> <span class="nx">Board</span><span class="p">;</span>
  <span class="nl">turn</span><span class="p">:</span> <span class="nx">Turn</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">type</span> <span class="nx">Turn</span> <span class="o">=</span>
  <span class="o">|</span> <span class="dl">'</span><span class="s1">your turn</span><span class="dl">'</span>
  <span class="o">|</span> <span class="s2">`computer's turn`</span>
  <span class="o">|</span> <span class="dl">'</span><span class="s1">game over - you win</span><span class="dl">'</span>
  <span class="o">|</span> <span class="dl">'</span><span class="s1">game over - you lose</span><span class="dl">'</span>
  <span class="o">|</span> <span class="s2">`game over - it's a tie`</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">type</span> <span class="nx">SpaceContent</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">x</span><span class="dl">'</span> <span class="o">|</span> <span class="dl">'</span><span class="s1">o</span><span class="dl">'</span> <span class="o">|</span> <span class="dl">''</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">type</span> <span class="nx">Board</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">[</span><span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">],</span>
  <span class="p">[</span><span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">],</span>
  <span class="p">[</span><span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">]</span>
<span class="p">];</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<ol>
<li>Instead of synchronously iterating through a defined list and returning a value at the end of it all, we're going to asynchronously handle events immediately as they are observed, emitting a corresponding state. (this one sounds intimidating, but this one is actually quite trivial thanks to RxJS!)</li>
</ol>

<p>Before getting overwhelmed in all this, let's take a deep breath and break this down into it's pieces. The first step is to identify the events that could potentially change our <code>TicTacToeViewModel</code>.</p>

<p>Two of them are pretty clear (because they're input observables to our function!): user clicking a square, and user clicking reset.</p>

<p>Let's go ahead and wrap those up now, by creating interfaces for them that wrap their value in an object and add a 'type' property to them (we'll switch on these 'type values later on!):<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="kr">interface</span> <span class="nx">UserSpaceClickAction</span> <span class="p">{</span>
  <span class="nl">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">user space click</span><span class="dl">'</span><span class="p">;</span>
  <span class="nl">space</span><span class="p">:</span> <span class="nx">SpaceCoordinates</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// export interface SpaceCoordinates {</span>
<span class="c1">//   row: BoardIndex;</span>
<span class="c1">//   column: BoardIndex;</span>
<span class="c1">// }</span>

<span class="kr">interface</span> <span class="nx">UserResetAction</span> <span class="p">{</span>
  <span class="nl">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">user reset click</span><span class="dl">'</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>[You might see this elsewhere referred to as "tokenizing" (or "actionizing") the data.]</p>

<p>There's one more event that would change our view model though: the ai's moves:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="kr">interface</span> <span class="nx">AiAction</span> <span class="p">{</span>
  <span class="nl">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ai action</span><span class="dl">'</span><span class="p">;</span>
  <span class="nl">space</span><span class="p">:</span> <span class="nx">SpaceCoordinates</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>We'll create a <a href="https://www.typescriptlang.org/docs/handbook/unions-and-intersections.html#union-types">union type</a> of these actions via TS as well:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="kd">type</span> <span class="nx">Action</span> <span class="o">=</span> <span class="nx">UserSpaceClickAction</span> <span class="o">|</span> <span class="nx">UserResetAction</span> <span class="o">|</span> <span class="nx">AiAction</span><span class="p">;</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Think of this as "grouping" the actions into a single type, where you know an <code>Action</code> is one of the 3 possible.</p>

<p>Now we'll write the signature for our <code>reducer</code> function:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="k">export</span> <span class="kd">function</span> <span class="nx">reducer</span><span class="p">(</span>
  <span class="nx">state</span><span class="p">:</span> <span class="nx">TicTacToeViewModel</span><span class="p">,</span>
  <span class="nx">action</span><span class="p">:</span> <span class="nx">Action</span>
<span class="p">):</span> <span class="nx">TicTacToeViewModel</span> <span class="p">{</span>
  <span class="c1">// ... impl here</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Best to think of this function as "handling" an action - so if a user clicks on a button, the next state should be the same as before, but with an 'X' on the square the user selected (and also the computer's turn - or maybe the user even won with that move and we should say "You Win!!"):</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--uLBeL4Cl--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/r0zjcjm13mpseqxly743.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--uLBeL4Cl--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/r0zjcjm13mpseqxly743.png" alt="Alt Text" loading="lazy"></a></p>

<p>Or if the user clicks "reset" we should get a new board:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--DnsElyti--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/b3h5alnhis82x0d5hqxw.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--DnsElyti--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/b3h5alnhis82x0d5hqxw.png" alt="Alt Text" loading="lazy"></a></p>

<p>Or if the user clicks on an occupied square, or tries to act while it's the computer's turn, we should just stay the same.</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--YHRXm1xh--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1p6qefzwem6hww4gptx0.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--YHRXm1xh--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1p6qefzwem6hww4gptx0.png" alt="Alt Text" loading="lazy"></a></p>

<p>Hopefully these sound familiar, because these are pretty much exactly the test cases we had tested prior! ONLY! Rather than thinking about the whole flow of data (the whole timeline) instead we're focused in on the micro: handling a single action.</p>

<p>Before we actually write these functions though, let's create some utility functions for the things we'll need:<br>
</p><details>
  <summary>TicTacTo Utility Fns</summary>
  <br>

<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="kd">function</span> <span class="nx">isSpaceOccupied</span><span class="p">(</span><span class="nx">board</span><span class="p">:</span> <span class="nx">Board</span><span class="p">,</span> <span class="nx">space</span><span class="p">:</span> <span class="nx">SpaceCoordinates</span><span class="p">):</span> <span class="nx">boolean</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">board</span><span class="p">[</span><span class="nx">space</span><span class="p">.</span><span class="nx">row</span><span class="p">][</span><span class="nx">space</span><span class="p">.</span><span class="nx">column</span><span class="p">]</span> <span class="o">!==</span> <span class="dl">''</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**
 * assumes the given `space` is unoccupied!
 */</span>
<span class="kd">function</span> <span class="nx">nextBoard</span><span class="p">(</span>
  <span class="nx">board</span><span class="p">:</span> <span class="nx">Board</span><span class="p">,</span>
  <span class="nx">space</span><span class="p">:</span> <span class="nx">SpaceCoordinates</span><span class="p">,</span>
  <span class="nx">player</span><span class="p">:</span> <span class="dl">'</span><span class="s1">x</span><span class="dl">'</span> <span class="o">|</span> <span class="dl">'</span><span class="s1">o</span><span class="dl">'</span>
<span class="p">):</span> <span class="nx">Board</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">newBoard</span><span class="p">:</span> <span class="nx">Board</span> <span class="o">=</span> <span class="p">[[...</span><span class="nx">board</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[...</span><span class="nx">board</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[...</span><span class="nx">board</span><span class="p">[</span><span class="mi">2</span><span class="p">]]];</span>
  <span class="nx">newBoard</span><span class="p">[</span><span class="nx">space</span><span class="p">.</span><span class="nx">row</span><span class="p">][</span><span class="nx">space</span><span class="p">.</span><span class="nx">column</span><span class="p">]</span> <span class="o">=</span> <span class="nx">player</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">newBoard</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">isGameOver</span><span class="p">(</span>
  <span class="nx">board</span><span class="p">:</span> <span class="nx">Board</span>
<span class="p">):</span> <span class="dl">'</span><span class="s1">user wins</span><span class="dl">'</span> <span class="o">|</span> <span class="dl">'</span><span class="s1">computer wins</span><span class="dl">'</span> <span class="o">|</span> <span class="dl">'</span><span class="s1">tie game</span><span class="dl">'</span> <span class="o">|</span> <span class="kc">false</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">winningCombinations</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">SpaceCoordinates</span><span class="p">,</span>
    <span class="nx">SpaceCoordinates</span><span class="p">,</span>
    <span class="nx">SpaceCoordinates</span>
  <span class="p">][]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">2</span> <span class="p">},</span>
    <span class="p">],</span>
    <span class="p">[</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">2</span> <span class="p">},</span>
    <span class="p">],</span>
    <span class="p">[</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">2</span> <span class="p">},</span>
    <span class="p">],</span>
    <span class="p">[</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span>
    <span class="p">],</span>
    <span class="p">[</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
    <span class="p">],</span>
    <span class="p">[</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">2</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">2</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">2</span> <span class="p">},</span>
    <span class="p">],</span>
    <span class="p">[</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">2</span> <span class="p">},</span>
    <span class="p">],</span>
    <span class="p">[</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">2</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span>
    <span class="p">],</span>
  <span class="p">];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="p">[</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="p">]</span> <span class="k">of</span> <span class="nx">winningCombinations</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span>
      <span class="nx">board</span><span class="p">[</span><span class="nx">x</span><span class="p">.</span><span class="nx">row</span><span class="p">][</span><span class="nx">x</span><span class="p">.</span><span class="nx">column</span><span class="p">]</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">x</span><span class="dl">'</span> <span class="o">&&</span>
      <span class="nx">board</span><span class="p">[</span><span class="nx">y</span><span class="p">.</span><span class="nx">row</span><span class="p">][</span><span class="nx">y</span><span class="p">.</span><span class="nx">column</span><span class="p">]</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">x</span><span class="dl">'</span> <span class="o">&&</span>
      <span class="nx">board</span><span class="p">[</span><span class="nx">z</span><span class="p">.</span><span class="nx">row</span><span class="p">][</span><span class="nx">z</span><span class="p">.</span><span class="nx">column</span><span class="p">]</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">x</span><span class="dl">'</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="dl">'</span><span class="s1">user wins</span><span class="dl">'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span>
      <span class="nx">board</span><span class="p">[</span><span class="nx">x</span><span class="p">.</span><span class="nx">row</span><span class="p">][</span><span class="nx">x</span><span class="p">.</span><span class="nx">column</span><span class="p">]</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">o</span><span class="dl">'</span> <span class="o">&&</span>
      <span class="nx">board</span><span class="p">[</span><span class="nx">y</span><span class="p">.</span><span class="nx">row</span><span class="p">][</span><span class="nx">y</span><span class="p">.</span><span class="nx">column</span><span class="p">]</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">o</span><span class="dl">'</span> <span class="o">&&</span>
      <span class="nx">board</span><span class="p">[</span><span class="nx">z</span><span class="p">.</span><span class="nx">row</span><span class="p">][</span><span class="nx">z</span><span class="p">.</span><span class="nx">column</span><span class="p">]</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">o</span><span class="dl">'</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="dl">'</span><span class="s1">computer wins</span><span class="dl">'</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">board</span><span class="p">.</span><span class="nx">flat</span><span class="p">()</span> <span class="k">as</span> <span class="nx">SpaceContent</span><span class="p">[]).</span><span class="nx">some</span><span class="p">((</span><span class="nx">contents</span><span class="p">)</span> <span class="o">=></span> <span class="nx">contents</span> <span class="o">===</span> <span class="dl">''</span><span class="p">)</span>
    <span class="p">?</span> <span class="kc">false</span>
    <span class="p">:</span> <span class="dl">'</span><span class="s1">tie game</span><span class="dl">'</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">createInitialViewModel</span><span class="p">():</span> <span class="nx">TicTacToeViewModel</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">board</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">[</span><span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">],</span>
      <span class="p">[</span><span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">],</span>
      <span class="p">[</span><span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">],</span>
    <span class="p">],</span>
    <span class="na">turn</span><span class="p">:</span> <span class="dl">'</span><span class="s1">your turn</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



</details>
<p></p>

<p>Functions make for really great "Lego blocks" and now that we have all these, let's write out function (throwing the real implementation in here because too many cases to cover them all in text, but good for you to look over it and make sure it makes sense):<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="k">export</span> <span class="kd">function</span> <span class="nx">reducer</span><span class="p">(</span>
  <span class="nx">state</span><span class="p">:</span> <span class="nx">TicTacToeViewModel</span><span class="p">,</span>
  <span class="nx">action</span><span class="p">:</span> <span class="nx">Action</span>
<span class="p">):</span> <span class="nx">TicTacToeViewModel</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="dl">'</span><span class="s1">user reset click</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">createInitialViewModel</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">case</span> <span class="dl">'</span><span class="s1">user space click</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">turn</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">your turn</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">state</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isSpaceOccupied</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">board</span><span class="p">,</span> <span class="nx">action</span><span class="p">.</span><span class="nx">space</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">state</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">const</span> <span class="nx">newBoard</span> <span class="o">=</span> <span class="nx">nextBoard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">board</span><span class="p">,</span> <span class="nx">action</span><span class="p">.</span><span class="nx">space</span><span class="p">,</span> <span class="dl">'</span><span class="s1">x</span><span class="dl">'</span><span class="p">);</span>
      <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">isGameOver</span><span class="p">(</span><span class="nx">newBoard</span><span class="p">);</span>
      <span class="k">switch</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="kc">false</span><span class="p">:</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">{</span>
            <span class="na">board</span><span class="p">:</span> <span class="nx">newBoard</span><span class="p">,</span>
            <span class="na">turn</span><span class="p">:</span> <span class="s2">`computer's turn`</span><span class="p">,</span>
          <span class="p">};</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="dl">'</span><span class="s1">user wins</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">{</span>
            <span class="na">board</span><span class="p">:</span> <span class="nx">newBoard</span><span class="p">,</span>
            <span class="na">turn</span><span class="p">:</span> <span class="dl">'</span><span class="s1">game over - you win</span><span class="dl">'</span><span class="p">,</span>
          <span class="p">};</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="dl">'</span><span class="s1">tie game</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">{</span>
            <span class="na">board</span><span class="p">:</span> <span class="nx">newBoard</span><span class="p">,</span>
            <span class="na">turn</span><span class="p">:</span> <span class="s2">`game over - it's a tie`</span><span class="p">,</span>
          <span class="p">};</span>
        <span class="p">}</span>
        <span class="nl">default</span><span class="p">:</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="dl">'</span><span class="s1">should not be reached</span><span class="dl">'</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">case</span> <span class="dl">'</span><span class="s1">ai action</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">newBoard</span> <span class="o">=</span> <span class="nx">nextBoard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">board</span><span class="p">,</span> <span class="nx">action</span><span class="p">.</span><span class="nx">space</span><span class="p">,</span> <span class="dl">'</span><span class="s1">o</span><span class="dl">'</span><span class="p">);</span>
      <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">isGameOver</span><span class="p">(</span><span class="nx">newBoard</span><span class="p">);</span>
      <span class="k">switch</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="kc">false</span><span class="p">:</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">{</span>
            <span class="na">board</span><span class="p">:</span> <span class="nx">newBoard</span><span class="p">,</span>
            <span class="na">turn</span><span class="p">:</span> <span class="dl">'</span><span class="s1">your turn</span><span class="dl">'</span><span class="p">,</span>
          <span class="p">};</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="dl">'</span><span class="s1">computer wins</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">{</span>
            <span class="na">board</span><span class="p">:</span> <span class="nx">newBoard</span><span class="p">,</span>
            <span class="na">turn</span><span class="p">:</span> <span class="dl">'</span><span class="s1">game over - you lose</span><span class="dl">'</span><span class="p">,</span>
          <span class="p">};</span>
        <span class="p">}</span>
        <span class="nl">default</span><span class="p">:</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="dl">'</span><span class="s1">should not be reached</span><span class="dl">'</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Awesome!! It wouldn't be a terrible idea now to write some test for this reducer function (or even writing them before we implemented this) but since we already have our test suite set up, this is not really necessary. (Even the fact that we're using a <code>reducer</code> strategy right now is implementation detail that we don't necessarily want to preserve moving forward!)</p>

<p>The majority of our work is done now! For the sake of time, I'm going to reveal the rest of the black box of our "reducer" implementation of the <code>ticTacToeViewModel$()</code>:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--vHmOL081--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/vgjqmjoa6n2akhn0tqcr.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--vHmOL081--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/vgjqmjoa6n2akhn0tqcr.png" alt="Mostly done now!" loading="lazy"></a></p>

<p>The shape "engine" is actually quite generic to the reducer pattern (although passing in the <code>ai()</code> function is a little bit of a twist... but not that much). If you've worked with NgRx, Redux, or some similar library, it actually probably looks very familiar already!</p>

<p>This "genericism" actually makes it quite nice to "package" this flow and... maybe <a href="https://www.npmjs.com/package/@derxjs/reducer">publish it on npm</a>??? (you can check out an example implementation for this same problem [that uses this exact same reducer function we just wrote!!] in <a href="https://github.com/ZackDeRose/derxjs/blob/main/libs/examples/tic-tac-toe-view-model-implementation/src/lib/using-reducer-package.ts">the derxjs repo</a>!)</p>

<p>But in any case, let's follow the diagram and see how to translate this into code:</p>

<p>First off, we'll take our incoming user actions and use the <a href="https://rxjs.dev/api/operators/map">map</a> operator to "tokenize" or wrap them into the right <code>Action</code> type, and then <a href="https://rxjs.dev/api/operators/merge">merge</a> them down to create a single <code>actions$</code> Observable. We'll go ahead here and create out <code>actionsSubject</code> and start sharing our actions to that subject.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="kd">const</span> <span class="nx">actionsSubject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subject</span><span class="o">&lt;</span><span class="nx">Action</span><span class="o">></span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">userClickActions$</span> <span class="o">=</span> <span class="nx">userSpaceClickEvents$</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
    <span class="nx">map</span><span class="p">(</span>
      <span class="p">(</span><span class="nx">space</span><span class="p">):</span> <span class="nx">UserSpaceClickAction</span> <span class="o">=></span> <span class="p">({</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">user space click</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">space</span><span class="p">:</span> <span class="nx">space</span><span class="p">,</span>
      <span class="p">})</span>
    <span class="p">)</span>
  <span class="p">);</span>
  <span class="kd">const</span> <span class="nx">userResetActions$</span> <span class="o">=</span> <span class="nx">userResetClickEvents$</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
    <span class="nx">map</span><span class="p">(</span>
      <span class="p">():</span> <span class="nx">UserResetAction</span> <span class="o">=></span> <span class="p">({</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">user reset click</span><span class="dl">'</span><span class="p">,</span>
      <span class="p">})</span>
    <span class="p">)</span>
  <span class="p">);</span>
  <span class="kd">const</span> <span class="nx">actions$</span> <span class="o">=</span> <span class="nx">merge</span><span class="p">(</span><span class="nx">userClickActions$</span><span class="p">,</span> <span class="nx">userResetActions$</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span>
    <span class="nx">share</span><span class="p">({</span> <span class="na">connector</span><span class="p">:</span> <span class="p">()</span> <span class="o">=></span> <span class="nx">actionsSubject</span> <span class="p">})</span>
  <span class="p">);</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--cxmWf_Qh--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/sswq5echsjvb09ju5u81.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--cxmWf_Qh--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/sswq5echsjvb09ju5u81.png" alt="Alt Text" loading="lazy"></a></p>

<p>(Green shows what we've done!)</p>

<p>Next up, we're gonna hook that actions stream up with our reducer function to create our state observable. This is the <code>Observable&lt;TicTacToeViewModel></code> that we set our to make!!! But we're not done yet...<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="kd">const</span> <span class="nx">state$</span> <span class="o">=</span> <span class="nx">actions$</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
    <span class="nx">scan</span><span class="p">(</span><span class="nx">reducer</span><span class="p">,</span> <span class="nx">createInitialViewModel</span><span class="p">()),</span>
    <span class="nx">startWith</span><span class="o">&lt;</span><span class="nx">TicTacToeViewModel</span><span class="o">></span><span class="p">(</span><span class="nx">createInitialViewModel</span><span class="p">()),</span>
    <span class="nx">distinctUntilChanged</span><span class="p">()</span>
  <span class="p">);</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>^ Note how we used <a href="https://rxjs.dev/api/operators/scan">scan</a> with our reducer function here. What we're doing is feeding in all the user's actions one-by-one, and each action is running through that reducer to get to a next "TicTacToeViewModel" object, which is a super clean && easy way to get to our <code>Observable</code> of that <code>TicTacToeViewModel</code>!!! This is where RxJS really shines in my opinion!</p>

<p>Note we're also <a href="https://rxjs.dev/api/operators/startWith">starting with</a> an initialState (think just an empty board) and we're going to use <a href="https://rxjs.dev/api/operators/distinctUntilChanged">distinctUntilChanged</a> to filter out any times our state observable would emit the same state over again (since we're creating this view model for a ui - it really doesn't make sense to make the UI re-render if [for example] the user tried to click on a space that was already occupied!</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--GZPzr6fJ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/f7iudm360ag007b851y7.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--GZPzr6fJ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/f7iudm360ag007b851y7.png" alt="Alt Text" loading="lazy"></a></p>

<p>If we ran this now as is though, after the user made their first move, it would become the computer's turn, and so far, we haven't hooked up the ai piece of our code yet, so the user would just be stuck in that state....</p>

<p>This is where "effects" come into play! The idea of an effect (thinking generically in the context of DeRxJS/reducer) is that it is a function that takes our <code>actions$</code> Observable, and our <code>state$</code> Observable (or just one of them.... or NEITHER!) and returns a new Observable of actions that we're going to connect BACK into our actions Subject to <a href="https://rxjs.dev/api/operators/share">share</a> those actions back into the actions$ observable!</p>

<p>That's generically though - for our specific example, we only have the one effect that we need to worry about, and that's our AI!</p>

<p>We'll start this with the observed states, <a href="https://rxjs.dev/api/operators/filter">filter</a>ed down to only states where the turn has just changed to "computer's turn" - we'll then <a href="https://rxjs.dev/api/operators/delay">delay</a> for 2 seconds before <a href="https://rxjs.dev/api/operators/map">map</a>ping the <code>Board</code> that came with the state through our <code>ai()</code> function to get our computer's move!</p>

<p>Last step is to wrap alll that into a (switchMap)[<a href="https://rxjs.dev/api/operators/switchMap">https://rxjs.dev/api/operators/switchMap</a>] from the user reset actions! We do this so that if the user ever resets the game while the computer is "thinking", we'd "discard" that subscription, so that the computer doesn't randomly barge in 2 seconds after the last "user space click" action when it should be the user's turn!<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="kd">const</span> <span class="nx">aiActions$</span> <span class="o">=</span> <span class="nx">userResetActions$</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
    <span class="nx">startWith</span><span class="p">(</span><span class="kc">undefined</span><span class="p">),</span>
    <span class="nx">switchMap</span><span class="p">(()</span> <span class="o">=></span>
      <span class="nx">state$</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
        <span class="nx">filter</span><span class="p">((</span><span class="nx">x</span><span class="p">)</span> <span class="o">=></span> <span class="nx">x</span><span class="p">.</span><span class="nx">turn</span> <span class="o">===</span> <span class="s2">`computer's turn`</span><span class="p">),</span>
        <span class="nx">delay</span><span class="p">(</span><span class="mi">2000</span><span class="p">),</span>
        <span class="nx">map</span><span class="p">((</span><span class="nx">state</span><span class="p">)</span> <span class="o">=></span> <span class="p">({</span>
          <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ai action</span><span class="dl">'</span> <span class="k">as</span> <span class="kd">const</span><span class="p">,</span>
          <span class="na">space</span><span class="p">:</span> <span class="nx">ai</span><span class="p">({</span> <span class="na">board</span><span class="p">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">board</span><span class="p">,</span> <span class="na">aiLetter</span><span class="p">:</span> <span class="dl">'</span><span class="s1">o</span><span class="dl">'</span> <span class="p">}),</span>
        <span class="p">})),</span>
        <span class="nx">share</span><span class="p">({</span> <span class="na">connector</span><span class="p">:</span> <span class="p">()</span> <span class="o">=></span> <span class="nx">actionsSubject</span> <span class="p">})</span>
      <span class="p">)</span>
    <span class="p">)</span>
  <span class="p">);</span>

  <span class="nx">aiActions$</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">();</span>

  <span class="k">return</span> <span class="nx">state$</span><span class="p">;</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Last thing to do, subscribe to our <code>aiActions$</code> and return the <code>state$</code>!</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--7-60u0jC--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/kquhv2nweyujsrjse5lb.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--7-60u0jC--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/kquhv2nweyujsrjse5lb.png" alt="Alt Text" loading="lazy"></a></p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--DDOeAjrm--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://res.cloudinary.com/practicaldev/image/fetch/s--GBdGae-N--/c_limit%252Cf_auto%252Cfl_progressive%252Cq_66%252Cw_880/https://media4.giphy.com/media/AS6bC3bKauQnwgyrad/200.gif" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--DDOeAjrm--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://res.cloudinary.com/practicaldev/image/fetch/s--GBdGae-N--/c_limit%252Cf_auto%252Cfl_progressive%252Cq_66%252Cw_880/https://media4.giphy.com/media/AS6bC3bKauQnwgyrad/200.gif" alt="catching my breath" loading="lazy" data-animated="true"></a></p>

<p>And yes - I'm aware there's a potentially leaky subscription there on the aiActions$!</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--xMpiebQs--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7vuhxvx7wkqtms36svds.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--xMpiebQs--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7vuhxvx7wkqtms36svds.png" alt="Alt Text" loading="lazy"></a></p>

<p>I'm gonna say that's okay for now (in my mind, this "game" is all our app is, so no need to teardown...) - but be sure to checkout <a href="https://github.com/ZackDeRose/derxjs/blob/main/packages/reducer/src/lib/reducer.ts#L32">the DeRxJS/reducer source code</a> to see how we could handle that!</p>

<h3>
  <a name="closing-thoughts" href="#closing-thoughts">
  </a>
  Closing Thoughts
</h3>

<p>I'm very excited for the work we're doing here (and not just because of the upcoming DeRxJS roadmap 👀):</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--EmHbMS5Y--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1mo8ycwmx7bvp3hfdpxh.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--EmHbMS5Y--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1mo8ycwmx7bvp3hfdpxh.png" alt="Alt Text" loading="lazy"></a></p>

<p>The reason I'm excited is that (in case you didn't notice) NONE OF THE CODE WE WROTE IN THIS ARTICLE is domain-specific. Beyond just Angular/React/Vue/etc., we could take this same 'tic-tac-toe' state management code now and drop it in a mobile app/a native app/Artificial Reality/Augmented Reality/really ANY presentation layer and our state management code would be valid, and proven to be to spec!</p>

<p>I'm very excited to see where this takes us next - and I can't wait to see y'all in the next article!!</p>

<h3>
  <a name="about-the-author" href="#about-the-author">
  </a>
  About the author
</h3>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--uSdgrUbk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/idzdgnshhxtbabgvvrmw.jpg" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--uSdgrUbk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/idzdgnshhxtbabgvvrmw.jpg" alt="Zack DeRose" loading="lazy"></a></p>

<p>Zack DeRose [or DeRxJS if you like] is:</p>

<ul>
<li><a href="https://developers.google.com/community/experts/directory/profile/profile-zack-derose?hl=en">a GDE in Angular</a></li>
<li>a recent nx conf/NgConf/RxJS Live/The Angular Show/ZDS speaker</li>
<li>Creator of the <a href="https://github.com/ZackDeRose/derxjs">@derxjs OSS packages</a>
</li>
<li>Senior Engineer and Engineering Manager at <a href="https://nrwl.io/">Nrwl</a>
</li>
</ul>

<p>Checkout out my <a href="https://zackderose.dev/videos">personal website</a> for more of my dev content! And go bug <a href="https://twitter.com/jeffbcross">Jeff Cross</a>/<a href="https://twitter.com/joerjohnson">Joe Johnson</a> if you want to hire me to come help out your codebase or come help level up your team on Nx/NgRx/DeRxJS/RxJS/State Management! (I especially love building awesome stuff - and building up teams with bright developers that are eager to learn!)</p>

</div></article> <div class="aside-username-wrapper" data-v-10d06ee8><aside class="aside-username-block" data-v-37984f8c data-v-10d06ee8><div class="username-heading loading" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-heading" data-v-37984f8c><div class="vue-content-placeholders-heading__img"></div> <div class="vue-content-placeholders-heading__content"><div class="vue-content-placeholders-heading__title"></div> <div class="vue-content-placeholders-heading__subtitle"></div></div></div></div></div> <div class="info" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-text" data-v-37984f8c><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div></div></div></div></aside></div></div> <div class="comments-block" data-v-8c4375bc data-v-10d06ee8><!----> <a href="https://dev.to/zackderose/the-derxjsviewmodel-pattern-the-e-mc-2-of-state-management-part-1-3dka" target="_blank" rel="nofollow noopener noreferer" class="add-comment" data-v-8c4375bc>
    Add comment
  </a></div></div> <footer data-v-22cb8fd0><span data-v-22cb8fd0>Built with</span> <a href="https://nuxtjs.org" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="nuxt-icon" data-v-22cb8fd0 data-v-22cb8fd0><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a> <span data-v-22cb8fd0>&</span> <a href="https://docs.dev.to/api" rel="nofollow noopener" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-22cb8fd0 data-v-22cb8fd0><path d="M1.5726 5.13748C1.42945 5.20622 1.2411 5.36661 1.15822 5.48117C1 5.69503 1 5.74849 1 11.8739C1 17.9993 1 18.0528 1.15822 18.2667C1.2411 18.3812 1.42945 18.5416 1.5726 18.6104C1.8137 18.7402 2.46164 18.7478 12 18.7478C21.5384 18.7478 22.1863 18.7402 22.4274 18.6104C22.5706 18.5416 22.7589 18.3812 22.8418 18.2667C23 18.0528 23 17.9993 23 11.8739C23 5.74849 23 5.69503 22.8418 5.48117C22.7589 5.36661 22.5706 5.20622 22.4274 5.13748C22.1863 5.00764 21.5384 5 12 5C2.46164 5 1.8137 5.00764 1.5726 5.13748ZM7.7055 8.2613C8.0822 8.45989 8.59454 9.0098 8.77536 9.40694C8.89589 9.66664 8.91095 9.94922 8.91095 12.0649C8.91095 14.3104 8.90344 14.4478 8.75275 14.7839C8.51919 15.288 8.16506 15.6546 7.68288 15.899C7.26096 16.1052 7.22328 16.1128 5.7315 16.1358L4.20206 16.1663V12.1031V8.04744L5.80684 8.07035C7.27602 8.09327 7.42672 8.10854 7.7055 8.2613ZM13.6952 8.89521V9.73538H12.4521H11.2089V10.4991V11.2629H11.9623H12.7158V12.1031V12.9432H11.9623H11.2089V13.707V14.4708H12.4521H13.6952V15.3109V16.151H12C10.1315 16.151 10.0411 16.1358 9.67191 15.6928L9.47603 15.4484V12.1336C9.47603 8.46752 9.46851 8.49807 9.95069 8.20783C10.1692 8.07035 10.3425 8.05508 11.9473 8.05508H13.6952V8.89521ZM16.5658 10.3769C16.8897 11.6295 17.1685 12.6912 17.176 12.7293C17.1911 12.7675 17.4699 11.7441 17.8014 10.461C18.1254 9.17017 18.4343 8.1009 18.4795 8.08563C18.5247 8.06271 18.9541 8.06271 19.4288 8.07035L20.3028 8.09327L19.376 11.6219C18.8713 13.5542 18.4117 15.2269 18.3664 15.3261C18.0123 16.0135 17.274 16.3343 16.7164 16.0441C16.4528 15.899 16.0911 15.4865 15.9705 15.1887C15.9254 15.0665 15.4884 13.4549 15.0062 11.6142C14.524 9.76593 14.1171 8.20783 14.0945 8.15437C14.0644 8.07035 14.2301 8.05508 15.0212 8.07035L15.9856 8.09327L16.5658 10.3769Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M5.93491 12.103V14.4707H6.27394C6.66574 14.4707 7.01983 14.3103 7.1404 14.0965C7.18559 14.0048 7.21575 13.2105 7.21575 12.0648V10.1783L6.99725 9.95683C6.80133 9.76591 6.71847 9.73535 6.35683 9.73535H5.93491V12.103Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a></footer></div></div></div><script>window.__NUXT__=function(s,a,n,e,p){return n.type_of="article",n.id=849465,n.title='The "DeRxJSViewModel Pattern": The E=mc^2 of State Management [Part 1]',n.description='Using "NEXT-LEVEL TDD" to create state-management logic for a Tic Tac Toe game with a configurable AI!',n.readable_publish_date="Oct 8 '21",n.slug="the-derxjsviewmodel-pattern-the-e-mc-2-of-state-management-part-1-3dka",n.path="/zackderose/the-derxjsviewmodel-pattern-the-e-mc-2-of-state-management-part-1-3dka",n.url=e,n.comments_count=0,n.public_reactions_count=15,n.collection_id=s,n.published_timestamp=a,n.positive_reactions_count=15,n.cover_image="https://res.cloudinary.com/practicaldev/image/fetch/s--sI654xZQ--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/y69zi8zela4vqt38ztnd.png",n.social_image="https://res.cloudinary.com/practicaldev/image/fetch/s--xEsIdBIT--/c_imagga_scale,f_auto,fl_progressive,h_500,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/y69zi8zela4vqt38ztnd.png",n.canonical_url=e,n.created_at="2021-10-03T02:31:12Z",n.edited_at="2021-10-09T06:33:15Z",n.crossposted_at=s,n.published_at=a,n.last_comment_at=a,n.reading_time_minutes=23,n.tag_list="rxjs, typescript, tdd, nx",n.tags=["rxjs","typescript","tdd","nx"],n.body_html='<h2>\n  <a name="part-1-creating-a-blue-print-setting-up-tdd-and-test-specs-to-be-certain-that-our-code-is-built-to-spec" href="#part-1-creating-a-blue-print-setting-up-tdd-and-test-specs-to-be-certain-that-our-code-is-built-to-spec">\n  </a>\n  Part 1: Creating a Blue Print, setting up TDD and Test Specs to Be CERTAIN that Our Code is Built to Spec.\n</h2>\n\n<h3>\n  <a name="what-well-learn-in-this-article" href="#what-well-learn-in-this-article">\n  </a>\n  What we\'ll learn in this article\n</h3>\n\n<p>Hi everyone! 👋</p>\n\n<p>Today, I\'m going to share and analyze a pattern that I\'ve become quite fond of recently for managing state management in a way that is truly domain agnostic.</p>\n\n<p>We\'ll do this by first discussing a new pattern for implementing state management code using RxJS in this article. In a follow up article (that I\'ve committed to releasing next friday), we\'ll demonstrate its "domain agnosticism" by using the same code to create a small app in vanilla JS [by which I simply mean "JS without a framework/library"], Angular, and React.</p>\n\n<p>There\'s something of a prerequisite of some more basic JS knowledge, and familiarity with RxJS would helpful here, but my goal is for this to be accessible for junior and senior engineers alike!</p>\n\n<p>Also before we proceed, [not-so-]coincidentally, I\'ve recently published a new npm package to the registry that we\'ll be using in this series: <a href="https://www.npmjs.com/package/@derxjs/view-model">🎉🎉🎉 @derxjs/view-model 🎉🎉🎉</a>.</p>\n\n<p><a href="https://www.npmjs.com/package/@derxjs/view-model"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--FNN3j4tt--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/qob5vohblg6w4gg4n2sq.png" alt="The @derxjs logo" loading="lazy"></a></p>\n\n<p>Installing the package is not necessary for this article, but I\'m very excited for <a href="https://www.npmjs.com/package/@derxjs/view-model#user-content-derxjs-roadmap">our roadmap</a> as I think that this had the potential to be a huge <code>E = mc^2</code> moment (more on that later!), so I highly recommend that you check it out. </p>\n\n<p>Here\'s how the work will break down:</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--mEXBzXnr--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/uw9ogp9c165j1dail32y.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--mEXBzXnr--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/uw9ogp9c165j1dail32y.png" alt="Breaking Down the Work into tasks" loading="lazy"></a></p>\n\n<p>First part we\'ll need to do is create TS types, which will serve as our blueprint for the lego blocks.</p>\n\n<p>From there, it doesn\'t really matter which of the 5 second-tier tasks we take on next, but in some order, we\'re going to:</p>\n\n<ul>\n<li>create our ViewModel tests</li>\n<li>build out the ViewModel implementation</li>\n<li>create a "vanilla" JS app</li>\n<li>create an Angular app</li>\n<li>create a React app</li>\n</ul>\n\n<p>In another world, we could even potentially have 5 different developers each working on these tasks in parallel if we had the resources for that!</p>\n\n<p>Unfortunately, my brain (and articles in general) is for the most part only single threaded, [insert huberman labs link on double focus] so instead, our path through these tasks is going to look like this:</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--XSksMTXB--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ynlcclvx2w8ei7ee2gsz.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--XSksMTXB--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ynlcclvx2w8ei7ee2gsz.png" alt="Our Path Through The tasks" loading="lazy"></a></p>\n\n<p>In this article, we\'ll create our <code>@derxjs/view-model</code> TS types, then write out our tests, and then finally use TDD to implement our spec with absolute confidence that we built what we set out to build.</p>\n\n<p>Next week, we\'ll put this all to good use, creating 3 webapps with 3 different frameworks.</p>\n\n<p>So without further ado..... let\'s do this!!!</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--aZ-m7rN8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://c.tenor.com/Joc-buLiXcsAAAAd/disney-pixar.gif" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--aZ-m7rN8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://c.tenor.com/Joc-buLiXcsAAAAd/disney-pixar.gif" alt="Adventure is out there!" loading="lazy" data-animated="true"></a></p>\n\n<h3>\n  <a name="establishing-our-tools" href="#establishing-our-tools">\n  </a>\n  Establishing our tools\n</h3>\n\n<p>[This section is designed more for junior developers - please feel free to skip these if you\'re already familiar with Ts and Observables and RxJS]</p>\n\n<h4>\n  <a name="typescript" href="#typescript">\n  </a>\n  Typescript\n</h4>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--NR5IHa4V--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/x1o4adep3myqjl4y228v.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--NR5IHa4V--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/x1o4adep3myqjl4y228v.png" alt="Typescript Logo" loading="lazy"></a></p>\n\n<p>For this article, we\'ll be using <a href="https://www.typescriptlang.org/docs/handbook/interfaces.html">Typescript interfaces</a> to help us think about our problem, and to help us to architect a solution. In the context of our view model pattern, Typescript will allow us to create a "shape" of the view model data that our particular "domains" (think vanilla JS, Angular, and React) will leverage to create our html from that data (this is also known as "templating").</p>\n\n<p>Think of TS as a blueprint that we\'ll use early on in our development process to lay out our problem, that we\'ll continue to leverage and keep us honest as we actually build our solution out.</p>\n\n<h4>\n  <a name="rxjs" href="#rxjs">\n  </a>\n  RxJS\n</h4>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--adsn4nnC--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/fq1ikg9rkvpoecq7rsyi.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--adsn4nnC--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/fq1ikg9rkvpoecq7rsyi.png" alt="RxJS Logo" loading="lazy"></a></p>\n\n<p><a href="https://rxjs.dev/">RxJS</a> is a library we\'ll use to compose observable event streams (or <code>Observable</code>s) in our code. I advise that it\'s best to think of <code>Observable</code>s as "Timelines".</p>\n\n<p>RxJS also introduces the idea of an "operator" as a function that takes an <code>Observable</code> and returns a new <code>Observable</code>. In the context of our "<code>Observable</code>s as \'Timelines\'" mental model then, an operator is a function that takes a "Timeline" as input, and returns a new "Timeline" as output.</p>\n\n<p><iframe width="710" height="399" src="https://www.youtube.com/embed/Wj7ffKH9GnU" allowfullscreen loading="lazy">\n</iframe>\n<br>\n(^ this is a talk  I gave on <code>Observable</code>s as "Timelines" at RxJS Live 2021.)</p>\n\n<p>The “Pro’s” of RxJS are:</p>\n\n<ul>\n<li>Extreme precision and control over code</li>\n<li>ability to write tests with a higher order of magnitude of precision</li>\n<li>Declarative, expressive, powerful code</li>\n<li>Huge potential for composability</li>\n<li>A perfect mental model and toolset for frontend web development (essentially a flurry of user-generated events with no guaranteed sequence)</li>\n</ul>\n\n<p>The “Con’s”: </p>\n\n<ul>\n<li>Takes a long time to fully understand</li>\n<li>Even if YOU make the investment to learn it, hard to pass that buck off onto the next developer to use our code [makes it difficult to scale]</li>\n<li>Many complicated/confusing dimensions\n\n<ul>\n<li>"Observable joining strategies" (merge, switch, exhaust, concat)</li>\n<li>Hot vs. Cold vs. Luke-Warm (cold observable sourced with a hot observable)</li>\n<li>Behavior vs. Replay vs. plain vs. "Async" emmission strategy</li>\n</ul>\n</li>\n<li>“Dangerous”\n\n<ul>\n<li>Risk of “leaky subscriptions”</li>\n<li>Risk of wrong implementation bugs</li>\n<li>Risk of poor implementation leading to even worse code (the only thing worse than complicated imperative code is a complicated mess of imperative code with a healthy chunk of “reactive” code mixed in)</li>\n</ul>\n</li>\n<li>They flood the call stack, making debugging untennable (this is especially unfortunate as bugs in your RxJS code are probably the kind of bugs that we need good debugging tools for the MOST)</li>\n</ul>\n\n<p>In many ways, the pattern recommended in this article (and supported on @derxjs packages) is designed to squeeze all the awesome benefits out of RxJS, while avoiding all the nasty pitfalls:</p>\n\n<ul>\n<li>Our view model function will take as input an <code>Observable</code> of our user\'s events</li>\n<li>It will return as output a single  <code>Observable</code> of our <code>ViewModel</code> interface</li>\n<li>We\'ll build out extensive, precise test suite BEFORE starting our implementation to ensure that we\'re developing EXACTLY what we set out to build.</li>\n<li>We\'ll use operators inside of our implementation to compose the transition of the input <code>Observable</code>s to the output <code>Observable</code>\n</li>\n</ul>\n<h3>\n  <a name="what-is-the-derxjs-view-model-pattern" href="#what-is-the-derxjs-view-model-pattern">\n  </a>\n  What is the "DeRxJS View Model" Pattern?\n</h3>\n\n<p>The basic idea for the "DeRxJS View Model" pattern is:</p>\n\n<ul>\n<li>Pass Observables in (along with maybe a few functions or pieces of data)</li>\n<li>Get a single Observable out</li>\n<li>Use your framework of choice for templating (turning the output Observable from #2 into html).</li>\n</ul>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--kHU_8poP--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/4js0csir90fph4tpm21j.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--kHU_8poP--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/4js0csir90fph4tpm21j.png" alt="Diagram of the DeRxJS View Model Pattern" loading="lazy"></a></p>\n<h4>\n  <a name="the-raw-e-mc2-endraw-of-state-management" href="#the-raw-e-mc2-endraw-of-state-management">\n  </a>\n  The <code>E = mc^2</code> of State Management\n</h4>\n\n\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">rxjs</span><span class="dl">"</span><span class="p">;</span>\n\n<span class="k">export</span> <span class="kd">type</span> <span class="nx">DeRxJSViewModel</span><span class="o">&lt;</span><span class="nx">InputType</span><span class="p">,</span> <span class="nx">ViewModelType</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">(</span>\n  <span class="nx">inputs</span><span class="p">:</span> <span class="nx">InputType</span>\n<span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">ViewModelType</span><span class="o">&gt;</span><span class="p">;</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n<p>^ The core of my <code>@derxjs</code> approach are these 5 lines of Typescript code. It\'s deceptively simple, but my hypothesis is, this pattern is elegant enough to encompass any &amp;&amp; all possible state management requirements. It\'s a powerful core that has lots of potential as a pattern and mental model - as well as potential tools and utility code we can build on top of it!</p>\n\n<p>To use this type, simply install the package (<code>npm i @derxjs/view-model</code>) and import the type into your code (<code>import { DeRxJSViewModel } from \'@derxjs/view-model\';</code>) [don\'t worry, I\'ll show it in use in our actual code snippets as well!].</p>\n\n<p>If you want to opt out though - you can always just copy these 5 lines of code, and be on your merry way :).</p>\n<h3>\n  <a name="introducing-the-problem-tic-tac-toe" href="#introducing-the-problem-tic-tac-toe">\n  </a>\n  Introducing the problem: Tic Tac Toe\n</h3>\n\n<p>Our example problem for today: creating a Tic Tac Toe game.</p>\n<h4>\n  <a name="lets-break-this-idea-down-to-a-rough-spec-in-english" href="#lets-break-this-idea-down-to-a-rough-spec-in-english">\n  </a>\n  Let\'s break this idea down to a rough spec in English:\n</h4>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--_5rvXT6z--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://media.makeameme.org/created/stand-back-i-bf0dce.jpg" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--_5rvXT6z--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://media.makeameme.org/created/stand-back-i-bf0dce.jpg" alt="Stand back. I am writing a spec" loading="lazy"></a></p>\n<h5>\n  <a name="presentational-concerns" href="#presentational-concerns">\n  </a>\n  Presentational concerns\n</h5>\n\n<ul>\n<li>The user will need to see a 3x3 grid that will operate as our game board. We\'ll make this a 3x3 grid of buttons, and we\'ll need in our view model some way of modeling/structuring this data.</li>\n<li>We\'ll want to allow the user to reset the game at anypoint (even while the computer is "thinking"). This should empty the board and make it their turn.</li>\n</ul>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--BTIYvJ8R--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/pnh99w31ohy7g5oo9qrz.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--BTIYvJ8R--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/pnh99w31ohy7g5oo9qrz.png" alt="Alt Text" loading="lazy"></a></p>\n<h5>\n  <a name="logical-concerns" href="#logical-concerns">\n  </a>\n  Logical concerns\n</h5>\n\n<ul>\n<li>We\'ll want to introduce the idea of "turns" to the game. During the user\'s turn, they should be allowed to click a button, but after clicking a button, they shouldn\'t be allowed to move until the computer opponent makes a move. We\'ll also want to make this feedback prominent to the user.</li>\n<li>We\'ll need some AI for our computer opponent. As cool as it would be to use some GPT-3 here, instead, let\'s opt for a Random Number Generator (RNG) to act in the place of our AI, and we\'ll simulate our AI thinking by adding in a delay of 2 seconds before the computer player makes their move.</li>\n<li>If the game is over (if either our player or the computer wins, or if the board is full and neither player won) we\'ll want to inform the user, and they\'ll need hit restart to play again.</li>\n</ul>\n<h4>\n  <a name="creating-a-typescript-blue-print" href="#creating-a-typescript-blue-print">\n  </a>\n  Creating a Typescript blue print\n</h4>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--c63ZNX8V--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://getsynapse.com/wp-content/uploads/2019/09/blueprint.jpg" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--c63ZNX8V--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://getsynapse.com/wp-content/uploads/2019/09/blueprint.jpg" alt="Image of a Blueprint" loading="lazy"></a></p>\n\n<p>Let\'s start by identifying the parameters of our system. The way I tend to think about this problem, the inputs come down to:</p>\n\n<ol>\n<li>the user\'s events selecting spaces on the board.</li>\n<li>the user\'s events selecting the "restart game" option.</li>\n<li>a function that will act as the ai that will define how our computer player will act.</li>\n</ol>\n\n<p>We can visualize the first 2 of these as Timelines, so we\'ll represent them as Observables - for the selection of spaces by the user, we\'ll represent that event with an object that states the column and row the user selected, and for the reset button clicks, the contents of the event actually doesn\'t matter much (just the fact that it happened is really all we need!).</p>\n\n<p>For our ai, we\'ll define it as some function that will take a  given <code>Board</code> and the computer\'s letter (x or o) and return the <code>SpaceCoordinates</code> for the space the computer will choose. This way we can pass in a determinist <code>ai</code> function for reliable testing of our code [but we\'ll see more on this later!!].</p>\n\n<p>Let\'s transpose these to actual Typescript now:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="kr">interface</span> <span class="nx">TicTacToeViewModelParams</span> <span class="p">{</span>\n  <span class="nx">userSpaceClickEvents$</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">SpaceCoordinates</span><span class="o">&gt;</span><span class="p">;</span>\n  <span class="nx">userResetClickEvents$</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span><span class="p">;</span>\n  <span class="nl">ai</span><span class="p">:</span> <span class="nx">TicTacToeAi</span>\n<span class="p">}</span>\n\n<span class="kr">interface</span> <span class="nx">SpaceCoordinates</span> <span class="p">{</span>\n  <span class="nl">row</span><span class="p">:</span> <span class="nx">BoardIndex</span><span class="p">;</span>\n  <span class="nl">column</span><span class="p">:</span> <span class="nx">BoardIndex</span><span class="p">;</span>\n<span class="p">}</span>\n\n<span class="kd">type</span> <span class="nx">BoardIndex</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">|</span> <span class="mi">2</span><span class="p">;</span>\n\n<span class="kd">type</span> <span class="nx">TicTacToeAi</span> <span class="o">=</span> <span class="p">(</span><span class="nx">params</span><span class="p">:</span> <span class="nx">AiParams</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">SpaceCoordinates</span><span class="p">;</span>\n\n<span class="kr">interface</span> <span class="nx">AiParams</span> <span class="p">{</span>\n  <span class="nl">board</span><span class="p">:</span> <span class="nx">Board</span><span class="p">;</span>\n  <span class="nl">aiLetter</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">o</span><span class="dl">\'</span> <span class="o">|</span> <span class="dl">\'</span><span class="s1">x</span><span class="dl">\'</span><span class="p">;</span>\n<span class="p">}</span>\n\n<span class="kd">type</span> <span class="nx">Board</span> <span class="o">=</span> <span class="p">[</span>\n  <span class="p">[</span><span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">],</span>\n  <span class="p">[</span><span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">],</span>\n  <span class="p">[</span><span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">],</span>\n<span class="p">];</span>\n\n<span class="kd">type</span> <span class="nx">SpaceContent</span> <span class="o">=</span> <span class="dl">\'</span><span class="s1">x</span><span class="dl">\'</span> <span class="o">|</span> <span class="dl">\'</span><span class="s1">o</span><span class="dl">\'</span> <span class="o">|</span> <span class="dl">\'\'</span><span class="p">;</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Next up, we\'ll create an interface for our View Model itself. We\'ll represent this with a <code>board</code> property that should contain a 3x3 array of either x\'s, o\'s, or empty spaces. The other thing we\'ll need is a <code>turn</code> property that will tell us if it\'s our turn, the computer\'s turn, or if the game is over.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="kr">interface</span> <span class="nx">TicTacToeViewModel</span> <span class="p">{</span>\n  <span class="nl">board</span><span class="p">:</span> <span class="nx">Board</span><span class="p">;</span>\n  <span class="nl">turn</span><span class="p">:</span> <span class="nx">Turn</span><span class="p">;</span>\n<span class="p">}</span>\n\n<span class="kd">type</span> <span class="nx">Turn</span> <span class="o">=</span>\n  <span class="o">|</span> <span class="dl">\'</span><span class="s1">your turn</span><span class="dl">\'</span>\n  <span class="o">|</span> <span class="s2">`computer\'s turn`</span>\n  <span class="o">|</span> <span class="dl">\'</span><span class="s1">game over - you win</span><span class="dl">\'</span>\n  <span class="o">|</span> <span class="dl">\'</span><span class="s1">game over - you lose</span><span class="dl">\'</span>\n  <span class="o">|</span> <span class="s2">`game over - it\'s a tie`</span><span class="p">;</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>The last step is to combine these into a function that takes our inputs and returns an <code>Observable</code> of our view model. Let\'s set out that function\'s signature now!<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">DeRxJSViewModel</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">\'</span><span class="s1">@derxjs/view-model</span><span class="dl">\'</span><span class="p">;</span>\n\n<span class="k">export</span> <span class="kd">const</span> <span class="nx">ticTacToeViewModel$</span><span class="p">:</span> <span class="nx">DeRxJSViewModel</span><span class="o">&lt;</span>\n  <span class="nx">TicTacToeViewModelParams</span><span class="p">,</span>\n  <span class="nx">TicTacToeViewModel</span>\n<span class="o">&gt;</span> <span class="o">=</span> <span class="p">({</span>\n  <span class="nx">userSpaceClickEvents$</span><span class="p">,</span>\n  <span class="nx">userResetClickEvents$</span><span class="p">,</span>\n  <span class="nx">ai</span>\n<span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n  <span class="c1">// implementation to go here</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>That about does it for our blueprint! Here\'s a rough blue print that matches our DeRxJS diagram from before:</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--ueZd7K51--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/wijfnob15pdcu89b5vfc.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--ueZd7K51--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/wijfnob15pdcu89b5vfc.png" alt="Alt Text" loading="lazy"></a></p>\n\n<p>As we mentioned prior, one of the best things architecturally about having done this work is we have 3 independent paths we could follow from here:</p>\n\n<ul>\n<li>implementing the function</li>\n<li>templating our component (in any of the 3 frameworks)</li>\n<li>writing tests for our function!</li>\n</ul>\n\n<p>To reiterate: in another scenario, we could even potentially have 3 different developers each working on a different branch of these three things at once.</p>\n\n<p>Since our brains are mostly single-threaded though, let\'s start with writing tests for our function, then implementing the function, then templating!</p>\n\n<h3>\n  <a name="tdd-and-setting-up-our-timeline-tests-for-our-view-model" href="#tdd-and-setting-up-our-timeline-tests-for-our-view-model">\n  </a>\n  TDD and setting up our Timeline Tests for our View Model\n</h3>\n\n<p>For a sneak peak of this in real code, go check out the example .spec file in the @derxjs repo (maybe go give us a start there too if you feel like it! :))</p>\n\n<p>So, let\'s break this concept down &amp;&amp; use some cool visualizations in the process. Before we get into that, let\'s address one big hairy issue about our specific system: RNG.</p>\n\n<p>Our spec requires that the ai choose a valid space at random. The AI being random immediately throws off a key component of a reliable test suite: being deterministic (or "the same thing happening EVERY time").</p>\n\n<p>Luckily, we thought of this before designing our system :). Because the <code>ai()</code> function is passed in as a parameter to our function, we can pass in a "deterministic AI" to our view model for our test, and then a "random AI" to our actual implementation (we could also come up with some other cool "flavors" of AI if we wanted - feel free to take this code and go nuts with it if you like! Would be cool to see someone come up with an "I always lose" AI.)</p>\n\n<p>To get this, let\'s quickly draft out this ai function:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="kd">const</span> <span class="nx">testAiFunction</span><span class="p">:</span> <span class="nx">TicTacToeAi</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">board</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n    <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">i</span> <span class="k">of</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="k">as</span> <span class="kd">const</span><span class="p">)</span> <span class="p">{</span>\n      <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">j</span> <span class="k">of</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="k">as</span> <span class="kd">const</span><span class="p">)</span> <span class="p">{</span>\n        <span class="k">if</span> <span class="p">(</span><span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]</span> <span class="o">===</span> <span class="dl">\'\'</span><span class="p">)</span> <span class="p">{</span>\n          <span class="k">return</span> <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="nx">i</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="nx">j</span> <span class="p">};</span>\n        <span class="p">}</span>\n      <span class="p">}</span>\n    <span class="p">}</span>\n    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">\'</span><span class="s1">Ai was passed a full board. This should never happen</span><span class="dl">\'</span><span class="p">);</span>\n  <span class="p">};</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>We should see the following behavior from this AI:</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--J6qWBkj---/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/g1elo3vr39eqw8iqyx7n.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--J6qWBkj---/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/g1elo3vr39eqw8iqyx7n.png" alt="Alt Text" loading="lazy"></a></p>\n\n<p>Very cool. By leveraging functions (for the people who like terminology, this is technically a "higher order function" as the DeRxJSViewModel is a function that took this <code>ai()</code> function as a parameter), we can see that we are able to pretty effortlessly make our system very highly configurable! If we wanted to - we could actually have passed in an <code>async</code> function (or a function that returns a <code>Promise</code>) here as well, and built in the 2 second delay right into our AI for even more configurability, but I think this is enough complexity for now.</p>\n\n<p>Btw - if you thought passing functions was cool - just wait until what we can do when passing in observables as input!!</p>\n\n<h4>\n  <a name="the-test-suite" href="#the-test-suite">\n  </a>\n  The Test Suite\n</h4>\n\n<p>We want to build out a test to cover our system. In general, we want to make sure we hit most of our edge cases and then maybe run the whole way through a couple times.</p>\n\n<p>It\'s usually nice to start with a nice basic base-case, so let\'s start with an empty board where the user never makes any actions:</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--npYtM4I9--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/9vzlm2zgmjwsam939tzp.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--npYtM4I9--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/9vzlm2zgmjwsam939tzp.png" alt="Alt Text" loading="lazy"></a></p>\n\n<p>(Since we\'ll always use the same <code>ai()</code> function for every test, I\'ve skipped that in the diagrams) but as we can see, this very basic test shows that with no user events, we start out with an empty board, and that board never changes.</p>\n\n<p>Here\'s the code for this exact scenario:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="nx">test</span><span class="p">(</span><span class="dl">\'</span><span class="s1">with no user events, the board stays empty</span><span class="dl">\'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n    <span class="kd">const</span> <span class="nx">firstUserState</span> <span class="o">=</span> <span class="nx">createInitialViewModel</span><span class="p">();</span>\n    <span class="nx">testScheduler</span><span class="p">.</span><span class="nx">run</span><span class="p">(({</span> <span class="nx">cold</span><span class="p">,</span> <span class="nx">expectObservable</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n      <span class="kd">const</span> <span class="nx">userBoardClicks</span> <span class="o">=</span> <span class="nx">cold</span><span class="o">&lt;</span><span class="nx">SpaceCoordinates</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">\'</span><span class="s1">------</span><span class="dl">\'</span><span class="p">);</span>\n      <span class="kd">const</span> <span class="nx">userResetClicks</span> <span class="o">=</span> <span class="nx">cold</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">\'</span><span class="s1">------</span><span class="dl">\'</span><span class="p">);</span>\n      <span class="kd">const</span> <span class="nx">expected</span> <span class="o">=</span> <span class="nx">cold</span><span class="p">(</span><span class="dl">\'</span><span class="s1">a-----</span><span class="dl">\'</span><span class="p">,</span> <span class="p">{</span> <span class="na">a</span><span class="p">:</span> <span class="nx">firstUserState</span> <span class="p">});</span>\n      <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">ticTacToeViewModel$</span><span class="p">({</span>\n        <span class="nx">userSpaceClickEvents</span><span class="na">$</span><span class="p">:</span> <span class="nx">userBoardClicks</span><span class="p">,</span>\n        <span class="nx">userResetClickEvents</span><span class="na">$</span><span class="p">:</span> <span class="nx">userResetClicks</span><span class="p">,</span>\n        <span class="na">ai</span><span class="p">:</span> <span class="nx">testAiFunction</span><span class="p">,</span>\n      <span class="p">});</span>\n      <span class="nx">expectObservable</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expected</span><span class="p">);</span>\n    <span class="p">});</span>\n  <span class="p">});</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Notice the ASCII art syntax!! While it\'s not bad here, I think it gets a bit of a bad rap for being a bit cumbersome to work with, and not without good reason! I was helping out with trying to line up these ASCII art kind of tests on the rxjs codebase, so I can vouch that it\'s not fun! (I think I got through 3 operators before I gave up :()</p>\n\n<p>(@derxjs is working on a nice gui tool to "draw" out these timelines and spit out working jest .spec.ts files - but that\'s an article for another time)</p>\n\n<p>Also notice the <code>testScheduler</code>! We\'ll touch on this in the next example: </p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--v7CsZQNp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/4xwl0b2r4o5tmzfws4uf.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--v7CsZQNp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/4xwl0b2r4o5tmzfws4uf.png" alt="Alt Text" loading="lazy"></a></p>\n\n<p>So in this example, we can see the player chooses the center square - note the dotted vertical line! This shows us how the timelines are aligned horizontally so that  the moment we observe the user select the middle square, we should immediately observe a new state in our UI - reflecting an \'x\' in that square and showing that it is now the \'computer\'s\' turn to move. Then 2 seconds later (2 seconds of "virtual time" thanks to our TestScheduler!!) we should see our AI move to that first open slot in the top left corner, and it should now be our player\'s turn again.</p>\n\n<p>So to recap: our timeline test is showing us that for the given inputs (the two observables/timelines) here\'s the expected timeline.</p>\n\n<p>Remember when we discussed the expressive power of the <code>ai()</code> function as a parameter to our tic-tac-toe system? These observable inputs are actually bringing in with them AN INFINITE NUMBER OF POTENTIAL FUTURES, EVENTS, AND COMBINATIONS OF EVENTS</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--qM6Qx4xE--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://c.tenor.com/qU7kKSP7JgsAAAAM/big-brain-lateralus.gif" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--qM6Qx4xE--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://c.tenor.com/qU7kKSP7JgsAAAAM/big-brain-lateralus.gif" alt="infinite worlds" loading="lazy" data-animated="true"></a></p>\n\n<p>and our viewModel function is [attempting] to WRANGLE EVERY SINGLE LAST ONE of them and handle them appropriately, and RxJS is masterful at allowing us to do so.</p>\n\n<p>Part of the reason I\'m so long on these timeline tests are because of how good they are at setting a mental model - and especially with RxJS code being so difficult to debug, these marble tests become even MORE valuable! After all, you don\'t have to debug what ain\'t broke!</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--UhRIyWQ0--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://c.tenor.com/xnDaGHW7i9QAAAAC/hm-hmm.gif" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--UhRIyWQ0--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://c.tenor.com/xnDaGHW7i9QAAAAC/hm-hmm.gif" alt="You don\'t have to debug what ain\'t broke!" loading="lazy" data-animated="true"></a></p>\n\n<p>Here\'s the code for this test (notice things starting to get a bit more hairy!<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="nx">test</span><span class="p">(</span><span class="dl">\'</span><span class="s1">computer player makes a move 1999ms after the player selects a square</span><span class="dl">\'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n    <span class="kd">const</span> <span class="nx">initialState</span> <span class="o">=</span> <span class="nx">createInitialViewModel</span><span class="p">();</span>\n    <span class="kd">const</span> <span class="na">userClick</span><span class="p">:</span> <span class="nx">SpaceCoordinates</span> <span class="o">=</span> <span class="p">{</span>\n      <span class="na">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>\n      <span class="na">column</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>\n    <span class="p">};</span>\n    <span class="kd">const</span> <span class="na">afterUserClick</span><span class="p">:</span> <span class="nx">TicTacToeViewModel</span> <span class="o">=</span> <span class="p">{</span>\n      <span class="na">board</span><span class="p">:</span> <span class="p">[</span>\n        <span class="p">[</span><span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">],</span>\n        <span class="p">[</span><span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'</span><span class="s1">x</span><span class="dl">\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">],</span>\n        <span class="p">[</span><span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">],</span>\n      <span class="p">],</span>\n      <span class="na">turn</span><span class="p">:</span> <span class="s2">`computer\'s turn`</span><span class="p">,</span>\n    <span class="p">};</span>\n    <span class="kd">const</span> <span class="na">afterComputerMoves</span><span class="p">:</span> <span class="nx">TicTacToeViewModel</span> <span class="o">=</span> <span class="p">{</span>\n      <span class="na">board</span><span class="p">:</span> <span class="p">[</span>\n        <span class="p">[</span><span class="dl">\'</span><span class="s1">o</span><span class="dl">\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">],</span>\n        <span class="p">[</span><span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'</span><span class="s1">x</span><span class="dl">\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">],</span>\n        <span class="p">[</span><span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">],</span>\n      <span class="p">],</span>\n      <span class="na">turn</span><span class="p">:</span> <span class="s2">`your turn`</span><span class="p">,</span>\n    <span class="p">};</span>\n    <span class="nx">testScheduler</span><span class="p">.</span><span class="nx">run</span><span class="p">(({</span> <span class="nx">cold</span><span class="p">,</span> <span class="nx">expectObservable</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n      <span class="kd">const</span> <span class="nx">userBoardClicks</span> <span class="o">=</span> <span class="nx">cold</span><span class="o">&lt;</span><span class="nx">SpaceCoordinates</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">\'</span><span class="s1">---a----</span><span class="dl">\'</span><span class="p">,</span> <span class="p">{</span>\n        <span class="na">a</span><span class="p">:</span> <span class="nx">userClick</span><span class="p">,</span>\n      <span class="p">});</span>\n      <span class="kd">const</span> <span class="nx">userResetClicks</span> <span class="o">=</span> <span class="nx">cold</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">\'</span><span class="s1">------</span><span class="dl">\'</span><span class="p">);</span>\n      <span class="kd">const</span> <span class="nx">expected</span> <span class="o">=</span> <span class="nx">cold</span><span class="p">(</span><span class="dl">\'</span><span class="s1">a--b 1999ms c</span><span class="dl">\'</span><span class="p">,</span> <span class="p">{</span>\n        <span class="na">a</span><span class="p">:</span> <span class="nx">initialState</span><span class="p">,</span>\n        <span class="na">b</span><span class="p">:</span> <span class="nx">afterUserClick</span><span class="p">,</span>\n        <span class="na">c</span><span class="p">:</span> <span class="nx">afterComputerMoves</span><span class="p">,</span>\n      <span class="p">});</span>\n      <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">ticTacToeViewModel$</span><span class="p">({</span>\n        <span class="nx">userSpaceClickEvents</span><span class="na">$</span><span class="p">:</span> <span class="nx">userBoardClicks</span><span class="p">,</span>\n        <span class="nx">userResetClickEvents</span><span class="na">$</span><span class="p">:</span> <span class="nx">userResetClicks</span><span class="p">,</span>\n        <span class="na">ai</span><span class="p">:</span> <span class="nx">testAiFunction</span><span class="p">,</span>\n      <span class="p">});</span>\n      <span class="nx">expectObservable</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expected</span><span class="p">);</span>\n    <span class="p">});</span>\n  <span class="p">});</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Let\'s move onto the next case: make sure that nothing happens when a player clicks on an already filled square (and also that nothing happens 2 seconds AFTER the user clicks that filled square.... for hopefully evident reasons!!)</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--xNK0zEeM--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/asko0aira49br3e19kuk.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--xNK0zEeM--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/asko0aira49br3e19kuk.png" alt="Alt Text" loading="lazy"></a></p>\n\n<p>code:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="nx">test</span><span class="p">(</span><span class="dl">\'</span><span class="s1">user click does nothing on an already filled square</span><span class="dl">\'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n    <span class="kd">const</span> <span class="nx">initialState</span> <span class="o">=</span> <span class="nx">createInitialViewModel</span><span class="p">();</span>\n    <span class="kd">const</span> <span class="na">userClicksCenterSquare</span><span class="p">:</span> <span class="nx">SpaceCoordinates</span> <span class="o">=</span> <span class="p">{</span>\n      <span class="na">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>\n      <span class="na">column</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>\n    <span class="p">};</span>\n    <span class="kd">const</span> <span class="na">afterUserClick</span><span class="p">:</span> <span class="nx">TicTacToeViewModel</span> <span class="o">=</span> <span class="p">{</span>\n      <span class="na">board</span><span class="p">:</span> <span class="p">[</span>\n        <span class="p">[</span><span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">],</span>\n        <span class="p">[</span><span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'</span><span class="s1">x</span><span class="dl">\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">],</span>\n        <span class="p">[</span><span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">],</span>\n      <span class="p">],</span>\n      <span class="na">turn</span><span class="p">:</span> <span class="s2">`computer\'s turn`</span><span class="p">,</span>\n    <span class="p">};</span>\n    <span class="kd">const</span> <span class="na">afterComputerMoves</span><span class="p">:</span> <span class="nx">TicTacToeViewModel</span> <span class="o">=</span> <span class="p">{</span>\n      <span class="na">board</span><span class="p">:</span> <span class="p">[</span>\n        <span class="p">[</span><span class="dl">\'</span><span class="s1">o</span><span class="dl">\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">],</span>\n        <span class="p">[</span><span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'</span><span class="s1">x</span><span class="dl">\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">],</span>\n        <span class="p">[</span><span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">],</span>\n      <span class="p">],</span>\n      <span class="na">turn</span><span class="p">:</span> <span class="s2">`your turn`</span><span class="p">,</span>\n    <span class="p">};</span>\n    <span class="kd">const</span> <span class="na">userClicksComputersSquare</span><span class="p">:</span> <span class="nx">SpaceCoordinates</span> <span class="o">=</span> <span class="p">{</span>\n      <span class="na">row</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>\n      <span class="na">column</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>\n    <span class="p">};</span>\n    <span class="nx">testScheduler</span><span class="p">.</span><span class="nx">run</span><span class="p">(({</span> <span class="nx">cold</span><span class="p">,</span> <span class="nx">expectObservable</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n      <span class="kd">const</span> <span class="nx">userBoardClicks</span> <span class="o">=</span> <span class="nx">cold</span><span class="o">&lt;</span><span class="nx">SpaceCoordinates</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">\'</span><span class="s1">---a 3s a-b-aaaa-bbbb-</span><span class="dl">\'</span><span class="p">,</span> <span class="p">{</span>\n        <span class="na">a</span><span class="p">:</span> <span class="nx">userClicksCenterSquare</span><span class="p">,</span>\n        <span class="na">b</span><span class="p">:</span> <span class="nx">userClicksComputersSquare</span><span class="p">,</span>\n      <span class="p">});</span>\n      <span class="kd">const</span> <span class="nx">userResetClicks</span> <span class="o">=</span> <span class="nx">cold</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">\'</span><span class="s1">------</span><span class="dl">\'</span><span class="p">);</span>\n      <span class="kd">const</span> <span class="nx">expected</span> <span class="o">=</span> <span class="nx">cold</span><span class="p">(</span><span class="dl">\'</span><span class="s1">a--b 1999ms c</span><span class="dl">\'</span><span class="p">,</span> <span class="p">{</span>\n        <span class="na">a</span><span class="p">:</span> <span class="nx">initialState</span><span class="p">,</span>\n        <span class="na">b</span><span class="p">:</span> <span class="nx">afterUserClick</span><span class="p">,</span>\n        <span class="na">c</span><span class="p">:</span> <span class="nx">afterComputerMoves</span><span class="p">,</span>\n      <span class="p">});</span>\n      <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">ticTacToeViewModel$</span><span class="p">({</span>\n        <span class="nx">userSpaceClickEvents</span><span class="na">$</span><span class="p">:</span> <span class="nx">userBoardClicks</span><span class="p">,</span>\n        <span class="nx">userResetClickEvents</span><span class="na">$</span><span class="p">:</span> <span class="nx">userResetClicks</span><span class="p">,</span>\n        <span class="na">ai</span><span class="p">:</span> <span class="nx">testAiFunction</span><span class="p">,</span>\n      <span class="p">});</span>\n      <span class="nx">expectObservable</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expected</span><span class="p">);</span>\n    <span class="p">});</span>\n  <span class="p">});</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Notice our output looks the same, even though our user is spamming those selected squares!</p>\n\n<p>Next up: The reset button works</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--ckFjE1aq--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1l3trc7oxnc1msmr2wo2.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--ckFjE1aq--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1l3trc7oxnc1msmr2wo2.png" alt="Alt Text" loading="lazy"></a><br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="nx">test</span><span class="p">(</span><span class="dl">\'</span><span class="s1">reset button works</span><span class="dl">\'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>\n    <span class="kd">const</span> <span class="nx">initialState</span> <span class="o">=</span> <span class="nx">createInitialViewModel</span><span class="p">();</span>\n    <span class="kd">const</span> <span class="na">userClicksCenterSquare</span><span class="p">:</span> <span class="nx">SpaceCoordinates</span> <span class="o">=</span> <span class="p">{</span>\n      <span class="na">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>\n      <span class="na">column</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>\n    <span class="p">};</span>\n    <span class="kd">const</span> <span class="na">afterUserClick</span><span class="p">:</span> <span class="nx">TicTacToeViewModel</span> <span class="o">=</span> <span class="p">{</span>\n      <span class="na">board</span><span class="p">:</span> <span class="p">[</span>\n        <span class="p">[</span><span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">],</span>\n        <span class="p">[</span><span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'</span><span class="s1">x</span><span class="dl">\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">],</span>\n        <span class="p">[</span><span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">],</span>\n      <span class="p">],</span>\n      <span class="na">turn</span><span class="p">:</span> <span class="s2">`computer\'s turn`</span><span class="p">,</span>\n    <span class="p">};</span>\n    <span class="kd">const</span> <span class="na">afterComputerMoves</span><span class="p">:</span> <span class="nx">TicTacToeViewModel</span> <span class="o">=</span> <span class="p">{</span>\n      <span class="na">board</span><span class="p">:</span> <span class="p">[</span>\n        <span class="p">[</span><span class="dl">\'</span><span class="s1">o</span><span class="dl">\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">],</span>\n        <span class="p">[</span><span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'</span><span class="s1">x</span><span class="dl">\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">],</span>\n        <span class="p">[</span><span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">],</span>\n      <span class="p">],</span>\n      <span class="na">turn</span><span class="p">:</span> <span class="s2">`your turn`</span><span class="p">,</span>\n    <span class="p">};</span>\n    <span class="nx">testScheduler</span><span class="p">.</span><span class="nx">run</span><span class="p">(({</span> <span class="nx">cold</span><span class="p">,</span> <span class="nx">expectObservable</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>\n      <span class="kd">const</span> <span class="nx">userBoardClicks</span> <span class="o">=</span> <span class="nx">cold</span><span class="o">&lt;</span><span class="nx">SpaceCoordinates</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">\'</span><span class="s1">---a------</span><span class="dl">\'</span><span class="p">,</span> <span class="p">{</span>\n        <span class="na">a</span><span class="p">:</span> <span class="nx">userClicksCenterSquare</span><span class="p">,</span>\n      <span class="p">});</span>\n      <span class="kd">const</span> <span class="nx">userResetClicks</span> <span class="o">=</span> <span class="nx">cold</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">\'</span><span class="s1">---- 1999ms ---a</span><span class="dl">\'</span><span class="p">,</span> <span class="p">{</span> <span class="na">a</span><span class="p">:</span> <span class="kc">undefined</span> <span class="p">});</span>\n      <span class="kd">const</span> <span class="nx">expected</span> <span class="o">=</span> <span class="nx">cold</span><span class="p">(</span><span class="dl">\'</span><span class="s1">a--b 1999ms c--a</span><span class="dl">\'</span><span class="p">,</span> <span class="p">{</span>\n        <span class="na">a</span><span class="p">:</span> <span class="nx">initialState</span><span class="p">,</span>\n        <span class="na">b</span><span class="p">:</span> <span class="nx">afterUserClick</span><span class="p">,</span>\n        <span class="na">c</span><span class="p">:</span> <span class="nx">afterComputerMoves</span><span class="p">,</span>\n      <span class="p">});</span>\n      <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">ticTacToeViewModel$</span><span class="p">({</span>\n        <span class="nx">userSpaceClickEvents</span><span class="na">$</span><span class="p">:</span> <span class="nx">userBoardClicks</span><span class="p">,</span>\n        <span class="nx">userResetClickEvents</span><span class="na">$</span><span class="p">:</span> <span class="nx">userResetClicks</span><span class="p">,</span>\n        <span class="na">ai</span><span class="p">:</span> <span class="nx">testAiFunction</span><span class="p">,</span>\n      <span class="p">});</span>\n      <span class="nx">expectObservable</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expected</span><span class="p">);</span>\n    <span class="p">});</span>\n  <span class="p">});</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Fairly straight-forward - but it will be a good marker to let us know if the most basic functionality of resetting our game is working properly</p>\n\n<p>Next one is around the same reset case, with a twist: the user can reset the game while the computer is "thinking" (making sure that the move the computer would have made is appropriately "cancelled"!)</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--RsZwSrUl--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/0o83nc4a46a0d2jh2yla.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--RsZwSrUl--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/0o83nc4a46a0d2jh2yla.png" alt="Alt Text" loading="lazy"></a></p>\n\n<p>I think that covers it for most of the potential edge cases of our system! For good measure, I\'d also throw a couple fully-played out games as well just to be sure that we can make it all the way through a game without issues (I\'m not gonna diagram those out here, but you can see it in action for yourself in <a href="https://github.com/ZackDeRose/derxjs/blob/main/libs/examples/tic-tac-toe-view-model-implementation/src/lib/view-model.spec.ts">the @derxjs codebase :)</a>)</p>\n\n<p>Run the test suite now if you like:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight shell"><code>git clone https://github.com/ZackDeRose/derxjs.git\n<span class="nb">cd </span>derxjs\nnpm i\nnpx nx <span class="nb">test </span>examples-tic-tac-toe-view-model-implementation\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<h3>\n  <a name="implementing-our-derxjs-view-model-pattern" href="#implementing-our-derxjs-view-model-pattern">\n  </a>\n  Implementing our "DeRxJS View Model" Pattern\n</h3>\n\n<p>Alright, so we\'ve got a fully fleshed out spec at this point - time to implement!</p>\n\n<p>(Btw - if you want to give yourself a fun challenge now - go clone my derxjs repo and erase the contents of <code>tic-tac-tow-view-model-implementation/src/lib/view-model.spec</code>, and see if you can get the tests to pass before reading this section!)</p>\n\n<p>We could honestly go a couple ways with this specific problem (in particular a \'state machine\' approach would be a great fit for this - and I hope to do a proper XState implementation [maybe even a @derxjs/xstate package somewhere down the line!!] at some point in the future).</p>\n\n<p>But because it\'s a pretty common pattern, we\'ll look at a "reducer" solution here!</p>\n\n<p>If you\'re familiar with the JavaScript Array.reduce() method, that\'s a great place to start:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="kd">const</span> <span class="nx">foo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>\n\n<span class="kd">function</span> <span class="nx">sum</span><span class="p">(</span><span class="nx">arr</span><span class="p">:</span> <span class="kr">number</span><span class="p">[]):</span> <span class="kr">number</span> <span class="p">{</span>\n  <span class="k">return</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span>\n    <span class="p">(</span><span class="nx">accumulator</span><span class="p">,</span> <span class="nx">arrayItem</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">accumulator</span> <span class="o">+</span> <span class="nx">arrayItem</span><span class="p">,</span>\n    <span class="mi">0</span>\n  <span class="p">);</span>\n<span class="p">}</span>\n\n<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">sum</span><span class="p">(</span><span class="nx">foo</span><span class="p">));</span> <span class="c1">// 10</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>In this code, we used <code>reduce</code> to "reduce the contents of the array down to a single value: their sum." Notice that this too is a higher-order function (since it takes a function as a parameter), making it very versatile. You can do ALOT of things with reduce.</p>\n\n<p>We\'re actually interested more in the reducer function though, specifically:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="p">(</span><span class="nx">accumulator</span><span class="p">,</span> <span class="nx">arrayItem</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">accumulator</span> <span class="o">+</span> <span class="nx">arrayItem</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>The idea for this function is that it will loop through the list and call this function for each item; the item itself going into the <code>arrayItem</code> param, and the return value of the prior function call going into the <code>accumulator</code> param.</p>\n\n<p>In this way, we "reduce the array down to a sum"! Pretty cool.</p>\n\n<p>We\'re going to take this same concept a bit further for our tic-tac-toe example now, expanding the anaology in 2 separate dimensions:</p>\n\n<ol>\n<li>Instead of numbers, we\'re going to reduce some set of "observed events" (think user clicks and ai moves) down into the <code>TicTacToeViewModel</code> interface from the prior section; here it is again if you missed it:\n</li>\n</ol>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="k">export</span> <span class="kr">interface</span> <span class="nx">TicTacToeViewModel</span> <span class="p">{</span>\n  <span class="nl">board</span><span class="p">:</span> <span class="nx">Board</span><span class="p">;</span>\n  <span class="nl">turn</span><span class="p">:</span> <span class="nx">Turn</span><span class="p">;</span>\n<span class="p">}</span>\n\n<span class="k">export</span> <span class="kd">type</span> <span class="nx">Turn</span> <span class="o">=</span>\n  <span class="o">|</span> <span class="dl">\'</span><span class="s1">your turn</span><span class="dl">\'</span>\n  <span class="o">|</span> <span class="s2">`computer\'s turn`</span>\n  <span class="o">|</span> <span class="dl">\'</span><span class="s1">game over - you win</span><span class="dl">\'</span>\n  <span class="o">|</span> <span class="dl">\'</span><span class="s1">game over - you lose</span><span class="dl">\'</span>\n  <span class="o">|</span> <span class="s2">`game over - it\'s a tie`</span><span class="p">;</span>\n\n<span class="k">export</span> <span class="kd">type</span> <span class="nx">SpaceContent</span> <span class="o">=</span> <span class="dl">\'</span><span class="s1">x</span><span class="dl">\'</span> <span class="o">|</span> <span class="dl">\'</span><span class="s1">o</span><span class="dl">\'</span> <span class="o">|</span> <span class="dl">\'\'</span><span class="p">;</span>\n\n<span class="k">export</span> <span class="kd">type</span> <span class="nx">Board</span> <span class="o">=</span> <span class="p">[</span>\n  <span class="p">[</span><span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">],</span>\n  <span class="p">[</span><span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">],</span>\n  <span class="p">[</span><span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">,</span> <span class="nx">SpaceContent</span><span class="p">]</span>\n<span class="p">];</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<ol>\n<li>Instead of synchronously iterating through a defined list and returning a value at the end of it all, we\'re going to asynchronously handle events immediately as they are observed, emitting a corresponding state. (this one sounds intimidating, but this one is actually quite trivial thanks to RxJS!)</li>\n</ol>\n\n<p>Before getting overwhelmed in all this, let\'s take a deep breath and break this down into it\'s pieces. The first step is to identify the events that could potentially change our <code>TicTacToeViewModel</code>.</p>\n\n<p>Two of them are pretty clear (because they\'re input observables to our function!): user clicking a square, and user clicking reset.</p>\n\n<p>Let\'s go ahead and wrap those up now, by creating interfaces for them that wrap their value in an object and add a \'type\' property to them (we\'ll switch on these \'type values later on!):<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="kr">interface</span> <span class="nx">UserSpaceClickAction</span> <span class="p">{</span>\n  <span class="nl">type</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">user space click</span><span class="dl">\'</span><span class="p">;</span>\n  <span class="nl">space</span><span class="p">:</span> <span class="nx">SpaceCoordinates</span><span class="p">;</span>\n<span class="p">}</span>\n\n<span class="c1">// export interface SpaceCoordinates {</span>\n<span class="c1">//   row: BoardIndex;</span>\n<span class="c1">//   column: BoardIndex;</span>\n<span class="c1">// }</span>\n\n<span class="kr">interface</span> <span class="nx">UserResetAction</span> <span class="p">{</span>\n  <span class="nl">type</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">user reset click</span><span class="dl">\'</span><span class="p">;</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>[You might see this elsewhere referred to as "tokenizing" (or "actionizing") the data.]</p>\n\n<p>There\'s one more event that would change our view model though: the ai\'s moves:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="kr">interface</span> <span class="nx">AiAction</span> <span class="p">{</span>\n  <span class="nl">type</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">ai action</span><span class="dl">\'</span><span class="p">;</span>\n  <span class="nl">space</span><span class="p">:</span> <span class="nx">SpaceCoordinates</span><span class="p">;</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>We\'ll create a <a href="https://www.typescriptlang.org/docs/handbook/unions-and-intersections.html#union-types">union type</a> of these actions via TS as well:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="kd">type</span> <span class="nx">Action</span> <span class="o">=</span> <span class="nx">UserSpaceClickAction</span> <span class="o">|</span> <span class="nx">UserResetAction</span> <span class="o">|</span> <span class="nx">AiAction</span><span class="p">;</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Think of this as "grouping" the actions into a single type, where you know an <code>Action</code> is one of the 3 possible.</p>\n\n<p>Now we\'ll write the signature for our <code>reducer</code> function:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="k">export</span> <span class="kd">function</span> <span class="nx">reducer</span><span class="p">(</span>\n  <span class="nx">state</span><span class="p">:</span> <span class="nx">TicTacToeViewModel</span><span class="p">,</span>\n  <span class="nx">action</span><span class="p">:</span> <span class="nx">Action</span>\n<span class="p">):</span> <span class="nx">TicTacToeViewModel</span> <span class="p">{</span>\n  <span class="c1">// ... impl here</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Best to think of this function as "handling" an action - so if a user clicks on a button, the next state should be the same as before, but with an \'X\' on the square the user selected (and also the computer\'s turn - or maybe the user even won with that move and we should say "You Win!!"):</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--uLBeL4Cl--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/r0zjcjm13mpseqxly743.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--uLBeL4Cl--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/r0zjcjm13mpseqxly743.png" alt="Alt Text" loading="lazy"></a></p>\n\n<p>Or if the user clicks "reset" we should get a new board:</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--DnsElyti--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/b3h5alnhis82x0d5hqxw.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--DnsElyti--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/b3h5alnhis82x0d5hqxw.png" alt="Alt Text" loading="lazy"></a></p>\n\n<p>Or if the user clicks on an occupied square, or tries to act while it\'s the computer\'s turn, we should just stay the same.</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--YHRXm1xh--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1p6qefzwem6hww4gptx0.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--YHRXm1xh--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1p6qefzwem6hww4gptx0.png" alt="Alt Text" loading="lazy"></a></p>\n\n<p>Hopefully these sound familiar, because these are pretty much exactly the test cases we had tested prior! ONLY! Rather than thinking about the whole flow of data (the whole timeline) instead we\'re focused in on the micro: handling a single action.</p>\n\n<p>Before we actually write these functions though, let\'s create some utility functions for the things we\'ll need:<br>\n<details>\n  <summary>TicTacTo Utility Fns</summary>\n  <br>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="kd">function</span> <span class="nx">isSpaceOccupied</span><span class="p">(</span><span class="nx">board</span><span class="p">:</span> <span class="nx">Board</span><span class="p">,</span> <span class="nx">space</span><span class="p">:</span> <span class="nx">SpaceCoordinates</span><span class="p">):</span> <span class="nx">boolean</span> <span class="p">{</span>\n  <span class="k">return</span> <span class="nx">board</span><span class="p">[</span><span class="nx">space</span><span class="p">.</span><span class="nx">row</span><span class="p">][</span><span class="nx">space</span><span class="p">.</span><span class="nx">column</span><span class="p">]</span> <span class="o">!==</span> <span class="dl">\'\'</span><span class="p">;</span>\n<span class="p">}</span>\n\n<span class="cm">/**\n * assumes the given `space` is unoccupied!\n */</span>\n<span class="kd">function</span> <span class="nx">nextBoard</span><span class="p">(</span>\n  <span class="nx">board</span><span class="p">:</span> <span class="nx">Board</span><span class="p">,</span>\n  <span class="nx">space</span><span class="p">:</span> <span class="nx">SpaceCoordinates</span><span class="p">,</span>\n  <span class="nx">player</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">x</span><span class="dl">\'</span> <span class="o">|</span> <span class="dl">\'</span><span class="s1">o</span><span class="dl">\'</span>\n<span class="p">):</span> <span class="nx">Board</span> <span class="p">{</span>\n  <span class="kd">const</span> <span class="nx">newBoard</span><span class="p">:</span> <span class="nx">Board</span> <span class="o">=</span> <span class="p">[[...</span><span class="nx">board</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[...</span><span class="nx">board</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[...</span><span class="nx">board</span><span class="p">[</span><span class="mi">2</span><span class="p">]]];</span>\n  <span class="nx">newBoard</span><span class="p">[</span><span class="nx">space</span><span class="p">.</span><span class="nx">row</span><span class="p">][</span><span class="nx">space</span><span class="p">.</span><span class="nx">column</span><span class="p">]</span> <span class="o">=</span> <span class="nx">player</span><span class="p">;</span>\n  <span class="k">return</span> <span class="nx">newBoard</span><span class="p">;</span>\n<span class="p">}</span>\n\n<span class="kd">function</span> <span class="nx">isGameOver</span><span class="p">(</span>\n  <span class="nx">board</span><span class="p">:</span> <span class="nx">Board</span>\n<span class="p">):</span> <span class="dl">\'</span><span class="s1">user wins</span><span class="dl">\'</span> <span class="o">|</span> <span class="dl">\'</span><span class="s1">computer wins</span><span class="dl">\'</span> <span class="o">|</span> <span class="dl">\'</span><span class="s1">tie game</span><span class="dl">\'</span> <span class="o">|</span> <span class="kc">false</span> <span class="p">{</span>\n  <span class="kd">const</span> <span class="nx">winningCombinations</span><span class="p">:</span> <span class="p">[</span>\n    <span class="nx">SpaceCoordinates</span><span class="p">,</span>\n    <span class="nx">SpaceCoordinates</span><span class="p">,</span>\n    <span class="nx">SpaceCoordinates</span>\n  <span class="p">][]</span> <span class="o">=</span> <span class="p">[</span>\n    <span class="p">[</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">2</span> <span class="p">},</span>\n    <span class="p">],</span>\n    <span class="p">[</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">2</span> <span class="p">},</span>\n    <span class="p">],</span>\n    <span class="p">[</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">2</span> <span class="p">},</span>\n    <span class="p">],</span>\n    <span class="p">[</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span>\n    <span class="p">],</span>\n    <span class="p">[</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>\n    <span class="p">],</span>\n    <span class="p">[</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">2</span> <span class="p">},</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">2</span> <span class="p">},</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">2</span> <span class="p">},</span>\n    <span class="p">],</span>\n    <span class="p">[</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">2</span> <span class="p">},</span>\n    <span class="p">],</span>\n    <span class="p">[</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">2</span> <span class="p">},</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>\n      <span class="p">{</span> <span class="na">row</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">column</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span>\n    <span class="p">],</span>\n  <span class="p">];</span>\n  <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="p">[</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="p">]</span> <span class="k">of</span> <span class="nx">winningCombinations</span><span class="p">)</span> <span class="p">{</span>\n    <span class="k">if</span> <span class="p">(</span>\n      <span class="nx">board</span><span class="p">[</span><span class="nx">x</span><span class="p">.</span><span class="nx">row</span><span class="p">][</span><span class="nx">x</span><span class="p">.</span><span class="nx">column</span><span class="p">]</span> <span class="o">===</span> <span class="dl">\'</span><span class="s1">x</span><span class="dl">\'</span> <span class="o">&amp;&amp;</span>\n      <span class="nx">board</span><span class="p">[</span><span class="nx">y</span><span class="p">.</span><span class="nx">row</span><span class="p">][</span><span class="nx">y</span><span class="p">.</span><span class="nx">column</span><span class="p">]</span> <span class="o">===</span> <span class="dl">\'</span><span class="s1">x</span><span class="dl">\'</span> <span class="o">&amp;&amp;</span>\n      <span class="nx">board</span><span class="p">[</span><span class="nx">z</span><span class="p">.</span><span class="nx">row</span><span class="p">][</span><span class="nx">z</span><span class="p">.</span><span class="nx">column</span><span class="p">]</span> <span class="o">===</span> <span class="dl">\'</span><span class="s1">x</span><span class="dl">\'</span>\n    <span class="p">)</span> <span class="p">{</span>\n      <span class="k">return</span> <span class="dl">\'</span><span class="s1">user wins</span><span class="dl">\'</span><span class="p">;</span>\n    <span class="p">}</span>\n    <span class="k">if</span> <span class="p">(</span>\n      <span class="nx">board</span><span class="p">[</span><span class="nx">x</span><span class="p">.</span><span class="nx">row</span><span class="p">][</span><span class="nx">x</span><span class="p">.</span><span class="nx">column</span><span class="p">]</span> <span class="o">===</span> <span class="dl">\'</span><span class="s1">o</span><span class="dl">\'</span> <span class="o">&amp;&amp;</span>\n      <span class="nx">board</span><span class="p">[</span><span class="nx">y</span><span class="p">.</span><span class="nx">row</span><span class="p">][</span><span class="nx">y</span><span class="p">.</span><span class="nx">column</span><span class="p">]</span> <span class="o">===</span> <span class="dl">\'</span><span class="s1">o</span><span class="dl">\'</span> <span class="o">&amp;&amp;</span>\n      <span class="nx">board</span><span class="p">[</span><span class="nx">z</span><span class="p">.</span><span class="nx">row</span><span class="p">][</span><span class="nx">z</span><span class="p">.</span><span class="nx">column</span><span class="p">]</span> <span class="o">===</span> <span class="dl">\'</span><span class="s1">o</span><span class="dl">\'</span>\n    <span class="p">)</span> <span class="p">{</span>\n      <span class="k">return</span> <span class="dl">\'</span><span class="s1">computer wins</span><span class="dl">\'</span><span class="p">;</span>\n    <span class="p">}</span>\n  <span class="p">}</span>\n  <span class="k">return</span> <span class="p">(</span><span class="nx">board</span><span class="p">.</span><span class="nx">flat</span><span class="p">()</span> <span class="k">as</span> <span class="nx">SpaceContent</span><span class="p">[]).</span><span class="nx">some</span><span class="p">((</span><span class="nx">contents</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">contents</span> <span class="o">===</span> <span class="dl">\'\'</span><span class="p">)</span>\n    <span class="p">?</span> <span class="kc">false</span>\n    <span class="p">:</span> <span class="dl">\'</span><span class="s1">tie game</span><span class="dl">\'</span><span class="p">;</span>\n<span class="p">}</span>\n\n<span class="k">export</span> <span class="kd">function</span> <span class="nx">createInitialViewModel</span><span class="p">():</span> <span class="nx">TicTacToeViewModel</span> <span class="p">{</span>\n  <span class="k">return</span> <span class="p">{</span>\n    <span class="na">board</span><span class="p">:</span> <span class="p">[</span>\n      <span class="p">[</span><span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">],</span>\n      <span class="p">[</span><span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">],</span>\n      <span class="p">[</span><span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">,</span> <span class="dl">\'\'</span><span class="p">],</span>\n    <span class="p">],</span>\n    <span class="na">turn</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">your turn</span><span class="dl">\'</span><span class="p">,</span>\n  <span class="p">};</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n</details>\n</p>\n\n<p>Functions make for really great "Lego blocks" and now that we have all these, let\'s write out function (throwing the real implementation in here because too many cases to cover them all in text, but good for you to look over it and make sure it makes sense):<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="k">export</span> <span class="kd">function</span> <span class="nx">reducer</span><span class="p">(</span>\n  <span class="nx">state</span><span class="p">:</span> <span class="nx">TicTacToeViewModel</span><span class="p">,</span>\n  <span class="nx">action</span><span class="p">:</span> <span class="nx">Action</span>\n<span class="p">):</span> <span class="nx">TicTacToeViewModel</span> <span class="p">{</span>\n  <span class="k">switch</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>\n    <span class="k">case</span> <span class="dl">\'</span><span class="s1">user reset click</span><span class="dl">\'</span><span class="p">:</span> <span class="p">{</span>\n      <span class="k">return</span> <span class="nx">createInitialViewModel</span><span class="p">();</span>\n    <span class="p">}</span>\n    <span class="k">case</span> <span class="dl">\'</span><span class="s1">user space click</span><span class="dl">\'</span><span class="p">:</span> <span class="p">{</span>\n      <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">turn</span> <span class="o">!==</span> <span class="dl">\'</span><span class="s1">your turn</span><span class="dl">\'</span><span class="p">)</span> <span class="p">{</span>\n        <span class="k">return</span> <span class="nx">state</span><span class="p">;</span>\n      <span class="p">}</span>\n      <span class="k">if</span> <span class="p">(</span><span class="nx">isSpaceOccupied</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">board</span><span class="p">,</span> <span class="nx">action</span><span class="p">.</span><span class="nx">space</span><span class="p">))</span> <span class="p">{</span>\n        <span class="k">return</span> <span class="nx">state</span><span class="p">;</span>\n      <span class="p">}</span>\n      <span class="kd">const</span> <span class="nx">newBoard</span> <span class="o">=</span> <span class="nx">nextBoard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">board</span><span class="p">,</span> <span class="nx">action</span><span class="p">.</span><span class="nx">space</span><span class="p">,</span> <span class="dl">\'</span><span class="s1">x</span><span class="dl">\'</span><span class="p">);</span>\n      <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">isGameOver</span><span class="p">(</span><span class="nx">newBoard</span><span class="p">);</span>\n      <span class="k">switch</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>\n        <span class="k">case</span> <span class="kc">false</span><span class="p">:</span> <span class="p">{</span>\n          <span class="k">return</span> <span class="p">{</span>\n            <span class="na">board</span><span class="p">:</span> <span class="nx">newBoard</span><span class="p">,</span>\n            <span class="na">turn</span><span class="p">:</span> <span class="s2">`computer\'s turn`</span><span class="p">,</span>\n          <span class="p">};</span>\n        <span class="p">}</span>\n        <span class="k">case</span> <span class="dl">\'</span><span class="s1">user wins</span><span class="dl">\'</span><span class="p">:</span> <span class="p">{</span>\n          <span class="k">return</span> <span class="p">{</span>\n            <span class="na">board</span><span class="p">:</span> <span class="nx">newBoard</span><span class="p">,</span>\n            <span class="na">turn</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">game over - you win</span><span class="dl">\'</span><span class="p">,</span>\n          <span class="p">};</span>\n        <span class="p">}</span>\n        <span class="k">case</span> <span class="dl">\'</span><span class="s1">tie game</span><span class="dl">\'</span><span class="p">:</span> <span class="p">{</span>\n          <span class="k">return</span> <span class="p">{</span>\n            <span class="na">board</span><span class="p">:</span> <span class="nx">newBoard</span><span class="p">,</span>\n            <span class="na">turn</span><span class="p">:</span> <span class="s2">`game over - it\'s a tie`</span><span class="p">,</span>\n          <span class="p">};</span>\n        <span class="p">}</span>\n        <span class="nl">default</span><span class="p">:</span> <span class="p">{</span>\n          <span class="k">throw</span> <span class="dl">\'</span><span class="s1">should not be reached</span><span class="dl">\'</span><span class="p">;</span>\n        <span class="p">}</span>\n      <span class="p">}</span>\n    <span class="p">}</span>\n    <span class="k">case</span> <span class="dl">\'</span><span class="s1">ai action</span><span class="dl">\'</span><span class="p">:</span> <span class="p">{</span>\n      <span class="kd">const</span> <span class="nx">newBoard</span> <span class="o">=</span> <span class="nx">nextBoard</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">board</span><span class="p">,</span> <span class="nx">action</span><span class="p">.</span><span class="nx">space</span><span class="p">,</span> <span class="dl">\'</span><span class="s1">o</span><span class="dl">\'</span><span class="p">);</span>\n      <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">isGameOver</span><span class="p">(</span><span class="nx">newBoard</span><span class="p">);</span>\n      <span class="k">switch</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>\n        <span class="k">case</span> <span class="kc">false</span><span class="p">:</span> <span class="p">{</span>\n          <span class="k">return</span> <span class="p">{</span>\n            <span class="na">board</span><span class="p">:</span> <span class="nx">newBoard</span><span class="p">,</span>\n            <span class="na">turn</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">your turn</span><span class="dl">\'</span><span class="p">,</span>\n          <span class="p">};</span>\n        <span class="p">}</span>\n        <span class="k">case</span> <span class="dl">\'</span><span class="s1">computer wins</span><span class="dl">\'</span><span class="p">:</span> <span class="p">{</span>\n          <span class="k">return</span> <span class="p">{</span>\n            <span class="na">board</span><span class="p">:</span> <span class="nx">newBoard</span><span class="p">,</span>\n            <span class="na">turn</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">game over - you lose</span><span class="dl">\'</span><span class="p">,</span>\n          <span class="p">};</span>\n        <span class="p">}</span>\n        <span class="nl">default</span><span class="p">:</span> <span class="p">{</span>\n          <span class="k">throw</span> <span class="dl">\'</span><span class="s1">should not be reached</span><span class="dl">\'</span><span class="p">;</span>\n        <span class="p">}</span>\n      <span class="p">}</span>\n    <span class="p">}</span>\n  <span class="p">}</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Awesome!! It wouldn\'t be a terrible idea now to write some test for this reducer function (or even writing them before we implemented this) but since we already have our test suite set up, this is not really necessary. (Even the fact that we\'re using a <code>reducer</code> strategy right now is implementation detail that we don\'t necessarily want to preserve moving forward!)</p>\n\n<p>The majority of our work is done now! For the sake of time, I\'m going to reveal the rest of the black box of our "reducer" implementation of the <code>ticTacToeViewModel$()</code>:</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--vHmOL081--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/vgjqmjoa6n2akhn0tqcr.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--vHmOL081--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/vgjqmjoa6n2akhn0tqcr.png" alt="Mostly done now!" loading="lazy"></a></p>\n\n<p>The shape "engine" is actually quite generic to the reducer pattern (although passing in the <code>ai()</code> function is a little bit of a twist... but not that much). If you\'ve worked with NgRx, Redux, or some similar library, it actually probably looks very familiar already!</p>\n\n<p>This "genericism" actually makes it quite nice to "package" this flow and... maybe <a href="https://www.npmjs.com/package/@derxjs/reducer">publish it on npm</a>??? (you can check out an example implementation for this same problem [that uses this exact same reducer function we just wrote!!] in <a href="https://github.com/ZackDeRose/derxjs/blob/main/libs/examples/tic-tac-toe-view-model-implementation/src/lib/using-reducer-package.ts">the derxjs repo</a>!)</p>\n\n<p>But in any case, let\'s follow the diagram and see how to translate this into code:</p>\n\n<p>First off, we\'ll take our incoming user actions and use the <a href="https://rxjs.dev/api/operators/map">map</a> operator to "tokenize" or wrap them into the right <code>Action</code> type, and then <a href="https://rxjs.dev/api/operators/merge">merge</a> them down to create a single <code>actions$</code> Observable. We\'ll go ahead here and create out <code>actionsSubject</code> and start sharing our actions to that subject.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="kd">const</span> <span class="nx">actionsSubject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subject</span><span class="o">&lt;</span><span class="nx">Action</span><span class="o">&gt;</span><span class="p">();</span>\n<span class="kd">const</span> <span class="nx">userClickActions$</span> <span class="o">=</span> <span class="nx">userSpaceClickEvents$</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>\n    <span class="nx">map</span><span class="p">(</span>\n      <span class="p">(</span><span class="nx">space</span><span class="p">):</span> <span class="nx">UserSpaceClickAction</span> <span class="o">=&gt;</span> <span class="p">({</span>\n        <span class="na">type</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">user space click</span><span class="dl">\'</span><span class="p">,</span>\n        <span class="na">space</span><span class="p">:</span> <span class="nx">space</span><span class="p">,</span>\n      <span class="p">})</span>\n    <span class="p">)</span>\n  <span class="p">);</span>\n  <span class="kd">const</span> <span class="nx">userResetActions$</span> <span class="o">=</span> <span class="nx">userResetClickEvents$</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>\n    <span class="nx">map</span><span class="p">(</span>\n      <span class="p">():</span> <span class="nx">UserResetAction</span> <span class="o">=&gt;</span> <span class="p">({</span>\n        <span class="na">type</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">user reset click</span><span class="dl">\'</span><span class="p">,</span>\n      <span class="p">})</span>\n    <span class="p">)</span>\n  <span class="p">);</span>\n  <span class="kd">const</span> <span class="nx">actions$</span> <span class="o">=</span> <span class="nx">merge</span><span class="p">(</span><span class="nx">userClickActions$</span><span class="p">,</span> <span class="nx">userResetActions$</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span>\n    <span class="nx">share</span><span class="p">({</span> <span class="na">connector</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">actionsSubject</span> <span class="p">})</span>\n  <span class="p">);</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--cxmWf_Qh--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/sswq5echsjvb09ju5u81.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--cxmWf_Qh--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/sswq5echsjvb09ju5u81.png" alt="Alt Text" loading="lazy"></a></p>\n\n<p>(Green shows what we\'ve done!)</p>\n\n<p>Next up, we\'re gonna hook that actions stream up with our reducer function to create our state observable. This is the <code>Observable&lt;TicTacToeViewModel&gt;</code> that we set our to make!!! But we\'re not done yet...<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="kd">const</span> <span class="nx">state$</span> <span class="o">=</span> <span class="nx">actions$</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>\n    <span class="nx">scan</span><span class="p">(</span><span class="nx">reducer</span><span class="p">,</span> <span class="nx">createInitialViewModel</span><span class="p">()),</span>\n    <span class="nx">startWith</span><span class="o">&lt;</span><span class="nx">TicTacToeViewModel</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">createInitialViewModel</span><span class="p">()),</span>\n    <span class="nx">distinctUntilChanged</span><span class="p">()</span>\n  <span class="p">);</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>^ Note how we used <a href="https://rxjs.dev/api/operators/scan">scan</a> with our reducer function here. What we\'re doing is feeding in all the user\'s actions one-by-one, and each action is running through that reducer to get to a next "TicTacToeViewModel" object, which is a super clean &amp;&amp; easy way to get to our <code>Observable</code> of that <code>TicTacToeViewModel</code>!!! This is where RxJS really shines in my opinion!</p>\n\n<p>Note we\'re also <a href="https://rxjs.dev/api/operators/startWith">starting with</a> an initialState (think just an empty board) and we\'re going to use <a href="https://rxjs.dev/api/operators/distinctUntilChanged">distinctUntilChanged</a> to filter out any times our state observable would emit the same state over again (since we\'re creating this view model for a ui - it really doesn\'t make sense to make the UI re-render if [for example] the user tried to click on a space that was already occupied!</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--GZPzr6fJ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/f7iudm360ag007b851y7.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--GZPzr6fJ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/f7iudm360ag007b851y7.png" alt="Alt Text" loading="lazy"></a></p>\n\n<p>If we ran this now as is though, after the user made their first move, it would become the computer\'s turn, and so far, we haven\'t hooked up the ai piece of our code yet, so the user would just be stuck in that state....</p>\n\n<p>This is where "effects" come into play! The idea of an effect (thinking generically in the context of DeRxJS/reducer) is that it is a function that takes our <code>actions$</code> Observable, and our <code>state$</code> Observable (or just one of them.... or NEITHER!) and returns a new Observable of actions that we\'re going to connect BACK into our actions Subject to <a href="https://rxjs.dev/api/operators/share">share</a> those actions back into the actions$ observable!</p>\n\n<p>That\'s generically though - for our specific example, we only have the one effect that we need to worry about, and that\'s our AI!</p>\n\n<p>We\'ll start this with the observed states, <a href="https://rxjs.dev/api/operators/filter">filter</a>ed down to only states where the turn has just changed to "computer\'s turn" - we\'ll then <a href="https://rxjs.dev/api/operators/delay">delay</a> for 2 seconds before <a href="https://rxjs.dev/api/operators/map">map</a>ping the <code>Board</code> that came with the state through our <code>ai()</code> function to get our computer\'s move!</p>\n\n<p>Last step is to wrap alll that into a (switchMap)[<a href="https://rxjs.dev/api/operators/switchMap">https://rxjs.dev/api/operators/switchMap</a>] from the user reset actions! We do this so that if the user ever resets the game while the computer is "thinking", we\'d "discard" that subscription, so that the computer doesn\'t randomly barge in 2 seconds after the last "user space click" action when it should be the user\'s turn!<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight typescript"><code><span class="kd">const</span> <span class="nx">aiActions$</span> <span class="o">=</span> <span class="nx">userResetActions$</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>\n    <span class="nx">startWith</span><span class="p">(</span><span class="kc">undefined</span><span class="p">),</span>\n    <span class="nx">switchMap</span><span class="p">(()</span> <span class="o">=&gt;</span>\n      <span class="nx">state$</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>\n        <span class="nx">filter</span><span class="p">((</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">x</span><span class="p">.</span><span class="nx">turn</span> <span class="o">===</span> <span class="s2">`computer\'s turn`</span><span class="p">),</span>\n        <span class="nx">delay</span><span class="p">(</span><span class="mi">2000</span><span class="p">),</span>\n        <span class="nx">map</span><span class="p">((</span><span class="nx">state</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span>\n          <span class="na">type</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">ai action</span><span class="dl">\'</span> <span class="k">as</span> <span class="kd">const</span><span class="p">,</span>\n          <span class="na">space</span><span class="p">:</span> <span class="nx">ai</span><span class="p">({</span> <span class="na">board</span><span class="p">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">board</span><span class="p">,</span> <span class="na">aiLetter</span><span class="p">:</span> <span class="dl">\'</span><span class="s1">o</span><span class="dl">\'</span> <span class="p">}),</span>\n        <span class="p">})),</span>\n        <span class="nx">share</span><span class="p">({</span> <span class="na">connector</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">actionsSubject</span> <span class="p">})</span>\n      <span class="p">)</span>\n    <span class="p">)</span>\n  <span class="p">);</span>\n\n  <span class="nx">aiActions$</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">();</span>\n\n  <span class="k">return</span> <span class="nx">state$</span><span class="p">;</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Last thing to do, subscribe to our <code>aiActions$</code> and return the <code>state$</code>!</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--7-60u0jC--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/kquhv2nweyujsrjse5lb.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--7-60u0jC--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/kquhv2nweyujsrjse5lb.png" alt="Alt Text" loading="lazy"></a></p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--DDOeAjrm--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://res.cloudinary.com/practicaldev/image/fetch/s--GBdGae-N--/c_limit%252Cf_auto%252Cfl_progressive%252Cq_66%252Cw_880/https://media4.giphy.com/media/AS6bC3bKauQnwgyrad/200.gif" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--DDOeAjrm--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://res.cloudinary.com/practicaldev/image/fetch/s--GBdGae-N--/c_limit%252Cf_auto%252Cfl_progressive%252Cq_66%252Cw_880/https://media4.giphy.com/media/AS6bC3bKauQnwgyrad/200.gif" alt="catching my breath" loading="lazy" data-animated="true"></a></p>\n\n<p>And yes - I\'m aware there\'s a potentially leaky subscription there on the aiActions$!</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--xMpiebQs--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7vuhxvx7wkqtms36svds.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--xMpiebQs--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7vuhxvx7wkqtms36svds.png" alt="Alt Text" loading="lazy"></a></p>\n\n<p>I\'m gonna say that\'s okay for now (in my mind, this "game" is all our app is, so no need to teardown...) - but be sure to checkout <a href="https://github.com/ZackDeRose/derxjs/blob/main/packages/reducer/src/lib/reducer.ts#L32">the DeRxJS/reducer source code</a> to see how we could handle that!</p>\n\n<h3>\n  <a name="closing-thoughts" href="#closing-thoughts">\n  </a>\n  Closing Thoughts\n</h3>\n\n<p>I\'m very excited for the work we\'re doing here (and not just because of the upcoming DeRxJS roadmap 👀):</p>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--EmHbMS5Y--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1mo8ycwmx7bvp3hfdpxh.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--EmHbMS5Y--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1mo8ycwmx7bvp3hfdpxh.png" alt="Alt Text" loading="lazy"></a></p>\n\n<p>The reason I\'m excited is that (in case you didn\'t notice) NONE OF THE CODE WE WROTE IN THIS ARTICLE is domain-specific. Beyond just Angular/React/Vue/etc., we could take this same \'tic-tac-toe\' state management code now and drop it in a mobile app/a native app/Artificial Reality/Augmented Reality/really ANY presentation layer and our state management code would be valid, and proven to be to spec!</p>\n\n<p>I\'m very excited to see where this takes us next - and I can\'t wait to see y\'all in the next article!!</p>\n\n<h3>\n  <a name="about-the-author" href="#about-the-author">\n  </a>\n  About the author\n</h3>\n\n<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--uSdgrUbk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/idzdgnshhxtbabgvvrmw.jpg" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--uSdgrUbk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/idzdgnshhxtbabgvvrmw.jpg" alt="Zack DeRose" loading="lazy"></a></p>\n\n<p>Zack DeRose [or DeRxJS if you like] is:</p>\n\n<ul>\n<li><a href="https://developers.google.com/community/experts/directory/profile/profile-zack-derose?hl=en">a GDE in Angular</a></li>\n<li>a recent nx conf/NgConf/RxJS Live/The Angular Show/ZDS speaker</li>\n<li>Creator of the <a href="https://github.com/ZackDeRose/derxjs">@derxjs OSS packages</a>\n</li>\n<li>Senior Engineer and Engineering Manager at <a href="https://nrwl.io/">Nrwl</a>\n</li>\n</ul>\n\n<p>Checkout out my <a href="https://zackderose.dev/videos">personal website</a> for more of my dev content! And go bug <a href="https://twitter.com/jeffbcross">Jeff Cross</a>/<a href="https://twitter.com/joerjohnson">Joe Johnson</a> if you want to hire me to come help out your codebase or come help level up your team on Nx/NgRx/DeRxJS/RxJS/State Management! (I especially love building awesome stuff - and building up teams with bright developers that are eager to learn!)</p>\n\n',n.body_markdown="---\ntitle: The \"DeRxJSViewModel Pattern\": The E=mc^2 of State Management [Part 1]\npublished: true\ndescription: Using \"NEXT-LEVEL TDD\" to create state-management logic for a Tic Tac Toe game with a configurable AI!\ntags: rxjs, typescript, tdd, nx\ncover_image: https://dev-to-uploads.s3.amazonaws.com/uploads/articles/y69zi8zela4vqt38ztnd.png\n---\n\n## Part 1: Creating a Blue Print, setting up TDD and Test Specs to Be CERTAIN that Our Code is Built to Spec.\n\n### What we'll learn in this article\n\nHi everyone! 👋\n\nToday, I'm going to share and analyze a pattern that I've become quite fond of recently for managing state management in a way that is truly domain agnostic.\n\nWe'll do this by first discussing a new pattern for implementing state management code using RxJS in this article. In a follow up article (that I've committed to releasing next friday), we'll demonstrate its \"domain agnosticism\" by using the same code to create a small app in vanilla JS [by which I simply mean \"JS without a framework/library\"], Angular, and React.\n\nThere's something of a prerequisite of some more basic JS knowledge, and familiarity with RxJS would helpful here, but my goal is for this to be accessible for junior and senior engineers alike!\n\nAlso before we proceed, [not-so-]coincidentally, I've recently published a new npm package to the registry that we'll be using in this series: [🎉🎉🎉 @derxjs/view-model 🎉🎉🎉](https://www.npmjs.com/package/@derxjs/view-model).\n\n[![The @derxjs logo](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/qob5vohblg6w4gg4n2sq.png)](https://www.npmjs.com/package/@derxjs/view-model)\n\nInstalling the package is not necessary for this article, but I'm very excited for [our roadmap](https://www.npmjs.com/package/@derxjs/view-model#user-content-derxjs-roadmap) as I think that this had the potential to be a huge `E = mc^2` moment (more on that later!), so I highly recommend that you check it out. \n\nHere's how the work will break down:\n\n![Breaking Down the Work into tasks](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/uw9ogp9c165j1dail32y.png)\n\nFirst part we'll need to do is create TS types, which will serve as our blueprint for the lego blocks.\n\nFrom there, it doesn't really matter which of the 5 second-tier tasks we take on next, but in some order, we're going to:\n\n+ create our ViewModel tests\n+ build out the ViewModel implementation\n+ create a \"vanilla\" JS app\n+ create an Angular app\n+ create a React app\n\nIn another world, we could even potentially have 5 different developers each working on these tasks in parallel if we had the resources for that!\n\nUnfortunately, my brain (and articles in general) is for the most part only single threaded, [insert huberman labs link on double focus] so instead, our path through these tasks is going to look like this:\n\n![Our Path Through The tasks](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ynlcclvx2w8ei7ee2gsz.png)\n\nIn this article, we'll create our `@derxjs/view-model` TS types, then write out our tests, and then finally use TDD to implement our spec with absolute confidence that we built what we set out to build.\n\nNext week, we'll put this all to good use, creating 3 webapps with 3 different frameworks.\n\nSo without further ado..... let's do this!!!\n\n![Adventure is out there!](https://c.tenor.com/Joc-buLiXcsAAAAd/disney-pixar.gif)\n\n### Establishing our tools\n\n[This section is designed more for junior developers - please feel free to skip these if you're already familiar with Ts and Observables and RxJS]\n\n#### Typescript\n\n![Typescript Logo](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/x1o4adep3myqjl4y228v.png)\n\nFor this article, we'll be using [Typescript interfaces](https://www.typescriptlang.org/docs/handbook/interfaces.html) to help us think about our problem, and to help us to architect a solution. In the context of our view model pattern, Typescript will allow us to create a \"shape\" of the view model data that our particular \"domains\" (think vanilla JS, Angular, and React) will leverage to create our html from that data (this is also known as \"templating\").\n\nThink of TS as a blueprint that we'll use early on in our development process to lay out our problem, that we'll continue to leverage and keep us honest as we actually build our solution out.\n\n#### RxJS\n\n![RxJS Logo](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/fq1ikg9rkvpoecq7rsyi.png)\n\n[RxJS](https://rxjs.dev/) is a library we'll use to compose observable event streams (or `Observable`s) in our code. I advise that it's best to think of `Observable`s as \"Timelines\".\n\nRxJS also introduces the idea of an \"operator\" as a function that takes an `Observable` and returns a new `Observable`. In the context of our \"`Observable`s as 'Timelines'\" mental model then, an operator is a function that takes a \"Timeline\" as input, and returns a new \"Timeline\" as output.\n\n{% youtube Wj7ffKH9GnU %}\n(^ this is a talk  I gave on `Observable`s as \"Timelines\" at RxJS Live 2021.)\n\nThe “Pro’s” of RxJS are:\n+ Extreme precision and control over code\n+ ability to write tests with a higher order of magnitude of precision\n+ Declarative, expressive, powerful code\n+ Huge potential for composability\n+ A perfect mental model and toolset for frontend web development (essentially a flurry of user-generated events with no guaranteed sequence)\n\nThe “Con’s”: \n+ Takes a long time to fully understand\n+ Even if YOU make the investment to learn it, hard to pass that buck off onto the next developer to use our code [makes it difficult to scale]\n+ Many complicated/confusing dimensions\n  + \"Observable joining strategies\" (merge, switch, exhaust, concat)\n  + Hot vs. Cold vs. Luke-Warm (cold observable sourced with a hot observable)\n  + Behavior vs. Replay vs. plain vs. \"Async\" emmission strategy\n+ “Dangerous”\n  + Risk of “leaky subscriptions”\n  + Risk of wrong implementation bugs\n  + Risk of poor implementation leading to even worse code (the only thing worse than complicated imperative code is a complicated mess of imperative code with a healthy chunk of “reactive” code mixed in)\n+ They flood the call stack, making debugging untennable (this is especially unfortunate as bugs in your RxJS code are probably the kind of bugs that we need good debugging tools for the MOST)\n\nIn many ways, the pattern recommended in this article (and supported on @derxjs packages) is designed to squeeze all the awesome benefits out of RxJS, while avoiding all the nasty pitfalls:\n\n+ Our view model function will take as input an `Observable` of our user's events\n+ It will return as output a single  `Observable` of our `ViewModel` interface\n+ We'll build out extensive, precise test suite BEFORE starting our implementation to ensure that we're developing EXACTLY what we set out to build.\n+ We'll use operators inside of our implementation to compose the transition of the input `Observable`s to the output `Observable`\n\n### What is the \"DeRxJS View Model\" Pattern?\n\nThe basic idea for the \"DeRxJS View Model\" pattern is:\n\n+ Pass Observables in (along with maybe a few functions or pieces of data)\n+ Get a single Observable out\n+ Use your framework of choice for templating (turning the output Observable from #2 into html).\n\n![Diagram of the DeRxJS View Model Pattern](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/4js0csir90fph4tpm21j.png)\n\n#### The `E = mc^2` of State Management\n\n```ts\nimport { Observable } from \"rxjs\";\n\nexport type DeRxJSViewModel<InputType, ViewModelType> = (\n  inputs: InputType\n) => Observable<ViewModelType>;\n```\n\n^ The core of my `@derxjs` approach are these 5 lines of Typescript code. It's deceptively simple, but my hypothesis is, this pattern is elegant enough to encompass any && all possible state management requirements. It's a powerful core that has lots of potential as a pattern and mental model - as well as potential tools and utility code we can build on top of it!\n\nTo use this type, simply install the package (`npm i @derxjs/view-model`) and import the type into your code (`import { DeRxJSViewModel } from '@derxjs/view-model';`) [don't worry, I'll show it in use in our actual code snippets as well!].\n\nIf you want to opt out though - you can always just copy these 5 lines of code, and be on your merry way :).\n\n### Introducing the problem: Tic Tac Toe\n\nOur example problem for today: creating a Tic Tac Toe game.\n\n#### Let's break this idea down to a rough spec in English:\n\n![Stand back. I am writing a spec](https://media.makeameme.org/created/stand-back-i-bf0dce.jpg)\n\n##### Presentational concerns\n\n+ The user will need to see a 3x3 grid that will operate as our game board. We'll make this a 3x3 grid of buttons, and we'll need in our view model some way of modeling/structuring this data.\n+ We'll want to allow the user to reset the game at anypoint (even while the computer is \"thinking\"). This should empty the board and make it their turn.\n\n![Alt Text](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/pnh99w31ohy7g5oo9qrz.png)\n\n##### Logical concerns\n\n+ We'll want to introduce the idea of \"turns\" to the game. During the user's turn, they should be allowed to click a button, but after clicking a button, they shouldn't be allowed to move until the computer opponent makes a move. We'll also want to make this feedback prominent to the user.\n+ We'll need some AI for our computer opponent. As cool as it would be to use some GPT-3 here, instead, let's opt for a Random Number Generator (RNG) to act in the place of our AI, and we'll simulate our AI thinking by adding in a delay of 2 seconds before the computer player makes their move.\n+ If the game is over (if either our player or the computer wins, or if the board is full and neither player won) we'll want to inform the user, and they'll need hit restart to play again.\n\n\n#### Creating a Typescript blue print\n\n![Image of a Blueprint](https://getsynapse.com/wp-content/uploads/2019/09/blueprint.jpg)\n\nLet's start by identifying the parameters of our system. The way I tend to think about this problem, the inputs come down to:\n\n1. the user's events selecting spaces on the board.\n1. the user's events selecting the \"restart game\" option.\n1. a function that will act as the ai that will define how our computer player will act.\n\nWe can visualize the first 2 of these as Timelines, so we'll represent them as Observables - for the selection of spaces by the user, we'll represent that event with an object that states the column and row the user selected, and for the reset button clicks, the contents of the event actually doesn't matter much (just the fact that it happened is really all we need!).\n\nFor our ai, we'll define it as some function that will take a  given `Board` and the computer's letter (x or o) and return the `SpaceCoordinates` for the space the computer will choose. This way we can pass in a determinist `ai` function for reliable testing of our code [but we'll see more on this later!!].\n\nLet's transpose these to actual Typescript now:\n\n```ts\ninterface TicTacToeViewModelParams {\n  userSpaceClickEvents$: Observable<SpaceCoordinates>;\n  userResetClickEvents$: Observable<void>;\n  ai: TicTacToeAi\n}\n\ninterface SpaceCoordinates {\n  row: BoardIndex;\n  column: BoardIndex;\n}\n\ntype BoardIndex = 0 | 1 | 2;\n\ntype TicTacToeAi = (params: AiParams) => SpaceCoordinates;\n\ninterface AiParams {\n  board: Board;\n  aiLetter: 'o' | 'x';\n}\n\ntype Board = [\n  [SpaceContent, SpaceContent, SpaceContent],\n  [SpaceContent, SpaceContent, SpaceContent],\n  [SpaceContent, SpaceContent, SpaceContent],\n];\n\ntype SpaceContent = 'x' | 'o' | '';\n```\n\nNext up, we'll create an interface for our View Model itself. We'll represent this with a `board` property that should contain a 3x3 array of either x's, o's, or empty spaces. The other thing we'll need is a `turn` property that will tell us if it's our turn, the computer's turn, or if the game is over.\n\n```ts\ninterface TicTacToeViewModel {\n  board: Board;\n  turn: Turn;\n}\n\ntype Turn =\n  | 'your turn'\n  | `computer's turn`\n  | 'game over - you win'\n  | 'game over - you lose'\n  | `game over - it's a tie`;\n```\n\nThe last step is to combine these into a function that takes our inputs and returns an `Observable` of our view model. Let's set out that function's signature now!\n\n```ts\nimport { DeRxJSViewModel } from '@derxjs/view-model';\n\nexport const ticTacToeViewModel$: DeRxJSViewModel<\n  TicTacToeViewModelParams,\n  TicTacToeViewModel\n> = ({\n  userSpaceClickEvents$,\n  userResetClickEvents$,\n  ai\n}) => {\n  // implementation to go here\n}\n```\n\nThat about does it for our blueprint! Here's a rough blue print that matches our DeRxJS diagram from before:\n\n![Alt Text](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/wijfnob15pdcu89b5vfc.png)\n\nAs we mentioned prior, one of the best things architecturally about having done this work is we have 3 independent paths we could follow from here:\n\n+ implementing the function\n+ templating our component (in any of the 3 frameworks)\n+ writing tests for our function!\n\nTo reiterate: in another scenario, we could even potentially have 3 different developers each working on a different branch of these three things at once.\n\nSince our brains are mostly single-threaded though, let's start with writing tests for our function, then implementing the function, then templating!\n\n### TDD and setting up our Timeline Tests for our View Model\n\nFor a sneak peak of this in real code, go check out the example .spec file in the @derxjs repo (maybe go give us a start there too if you feel like it! :))\n\nSo, let's break this concept down && use some cool visualizations in the process. Before we get into that, let's address one big hairy issue about our specific system: RNG.\n\nOur spec requires that the ai choose a valid space at random. The AI being random immediately throws off a key component of a reliable test suite: being deterministic (or \"the same thing happening EVERY time\").\n\nLuckily, we thought of this before designing our system :). Because the `ai()` function is passed in as a parameter to our function, we can pass in a \"deterministic AI\" to our view model for our test, and then a \"random AI\" to our actual implementation (we could also come up with some other cool \"flavors\" of AI if we wanted - feel free to take this code and go nuts with it if you like! Would be cool to see someone come up with an \"I always lose\" AI.)\n\nTo get this, let's quickly draft out this ai function:\n\n```ts\nconst testAiFunction: TicTacToeAi = ({ board }) => {\n    for (const i of [0, 1, 2] as const) {\n      for (const j of [0, 1, 2] as const) {\n        if (board[i][j] === '') {\n          return { row: i, column: j };\n        }\n      }\n    }\n    throw new Error('Ai was passed a full board. This should never happen');\n  };\n```\n\nWe should see the following behavior from this AI:\n\n![Alt Text](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/g1elo3vr39eqw8iqyx7n.png)\n\nVery cool. By leveraging functions (for the people who like terminology, this is technically a \"higher order function\" as the DeRxJSViewModel is a function that took this `ai()` function as a parameter), we can see that we are able to pretty effortlessly make our system very highly configurable! If we wanted to - we could actually have passed in an `async` function (or a function that returns a `Promise`) here as well, and built in the 2 second delay right into our AI for even more configurability, but I think this is enough complexity for now.\n\nBtw - if you thought passing functions was cool - just wait until what we can do when passing in observables as input!!\n\n#### The Test Suite\n\nWe want to build out a test to cover our system. In general, we want to make sure we hit most of our edge cases and then maybe run the whole way through a couple times.\n\nIt's usually nice to start with a nice basic base-case, so let's start with an empty board where the user never makes any actions:\n\n![Alt Text](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/9vzlm2zgmjwsam939tzp.png)\n\n(Since we'll always use the same `ai()` function for every test, I've skipped that in the diagrams) but as we can see, this very basic test shows that with no user events, we start out with an empty board, and that board never changes.\n\nHere's the code for this exact scenario:\n\n```ts\ntest('with no user events, the board stays empty', () => {\n    const firstUserState = createInitialViewModel();\n    testScheduler.run(({ cold, expectObservable }) => {\n      const userBoardClicks = cold<SpaceCoordinates>('------');\n      const userResetClicks = cold<void>('------');\n      const expected = cold('a-----', { a: firstUserState });\n      const result = ticTacToeViewModel$({\n        userSpaceClickEvents$: userBoardClicks,\n        userResetClickEvents$: userResetClicks,\n        ai: testAiFunction,\n      });\n      expectObservable(result).toEqual(expected);\n    });\n  });\n```\n\nNotice the ASCII art syntax!! While it's not bad here, I think it gets a bit of a bad rap for being a bit cumbersome to work with, and not without good reason! I was helping out with trying to line up these ASCII art kind of tests on the rxjs codebase, so I can vouch that it's not fun! (I think I got through 3 operators before I gave up :()\n\n(@derxjs is working on a nice gui tool to \"draw\" out these timelines and spit out working jest .spec.ts files - but that's an article for another time)\n\nAlso notice the `testScheduler`! We'll touch on this in the next example: \n\n![Alt Text](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/4xwl0b2r4o5tmzfws4uf.png)\n\nSo in this example, we can see the player chooses the center square - note the dotted vertical line! This shows us how the timelines are aligned horizontally so that  the moment we observe the user select the middle square, we should immediately observe a new state in our UI - reflecting an 'x' in that square and showing that it is now the 'computer's' turn to move. Then 2 seconds later (2 seconds of \"virtual time\" thanks to our TestScheduler!!) we should see our AI move to that first open slot in the top left corner, and it should now be our player's turn again.\n\nSo to recap: our timeline test is showing us that for the given inputs (the two observables/timelines) here's the expected timeline.\n\nRemember when we discussed the expressive power of the `ai()` function as a parameter to our tic-tac-toe system? These observable inputs are actually bringing in with them AN INFINITE NUMBER OF POTENTIAL FUTURES, EVENTS, AND COMBINATIONS OF EVENTS\n\n![infinite worlds](https://c.tenor.com/qU7kKSP7JgsAAAAM/big-brain-lateralus.gif)\n\nand our viewModel function is [attempting] to WRANGLE EVERY SINGLE LAST ONE of them and handle them appropriately, and RxJS is masterful at allowing us to do so.\n\nPart of the reason I'm so long on these timeline tests are because of how good they are at setting a mental model - and especially with RxJS code being so difficult to debug, these marble tests become even MORE valuable! After all, you don't have to debug what ain't broke!\n\n![You don't have to debug what ain't broke!](https://c.tenor.com/xnDaGHW7i9QAAAAC/hm-hmm.gif)\n\nHere's the code for this test (notice things starting to get a bit more hairy!\n\n```ts\ntest('computer player makes a move 1999ms after the player selects a square', () => {\n    const initialState = createInitialViewModel();\n    const userClick: SpaceCoordinates = {\n      row: 1,\n      column: 1,\n    };\n    const afterUserClick: TicTacToeViewModel = {\n      board: [\n        ['', '', ''],\n        ['', 'x', ''],\n        ['', '', ''],\n      ],\n      turn: `computer's turn`,\n    };\n    const afterComputerMoves: TicTacToeViewModel = {\n      board: [\n        ['o', '', ''],\n        ['', 'x', ''],\n        ['', '', ''],\n      ],\n      turn: `your turn`,\n    };\n    testScheduler.run(({ cold, expectObservable }) => {\n      const userBoardClicks = cold<SpaceCoordinates>('---a----', {\n        a: userClick,\n      });\n      const userResetClicks = cold<void>('------');\n      const expected = cold('a--b 1999ms c', {\n        a: initialState,\n        b: afterUserClick,\n        c: afterComputerMoves,\n      });\n      const result = ticTacToeViewModel$({\n        userSpaceClickEvents$: userBoardClicks,\n        userResetClickEvents$: userResetClicks,\n        ai: testAiFunction,\n      });\n      expectObservable(result).toEqual(expected);\n    });\n  });\n```\n\nLet's move onto the next case: make sure that nothing happens when a player clicks on an already filled square (and also that nothing happens 2 seconds AFTER the user clicks that filled square.... for hopefully evident reasons!!)\n\n![Alt Text](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/asko0aira49br3e19kuk.png)\n\ncode:\n\n```ts\ntest('user click does nothing on an already filled square', () => {\n    const initialState = createInitialViewModel();\n    const userClicksCenterSquare: SpaceCoordinates = {\n      row: 1,\n      column: 1,\n    };\n    const afterUserClick: TicTacToeViewModel = {\n      board: [\n        ['', '', ''],\n        ['', 'x', ''],\n        ['', '', ''],\n      ],\n      turn: `computer's turn`,\n    };\n    const afterComputerMoves: TicTacToeViewModel = {\n      board: [\n        ['o', '', ''],\n        ['', 'x', ''],\n        ['', '', ''],\n      ],\n      turn: `your turn`,\n    };\n    const userClicksComputersSquare: SpaceCoordinates = {\n      row: 0,\n      column: 0,\n    };\n    testScheduler.run(({ cold, expectObservable }) => {\n      const userBoardClicks = cold<SpaceCoordinates>('---a 3s a-b-aaaa-bbbb-', {\n        a: userClicksCenterSquare,\n        b: userClicksComputersSquare,\n      });\n      const userResetClicks = cold<void>('------');\n      const expected = cold('a--b 1999ms c', {\n        a: initialState,\n        b: afterUserClick,\n        c: afterComputerMoves,\n      });\n      const result = ticTacToeViewModel$({\n        userSpaceClickEvents$: userBoardClicks,\n        userResetClickEvents$: userResetClicks,\n        ai: testAiFunction,\n      });\n      expectObservable(result).toEqual(expected);\n    });\n  });\n```\n\nNotice our output looks the same, even though our user is spamming those selected squares!\n\nNext up: The reset button works\n\n![Alt Text](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1l3trc7oxnc1msmr2wo2.png)\n\n```ts\ntest('reset button works', () => {\n    const initialState = createInitialViewModel();\n    const userClicksCenterSquare: SpaceCoordinates = {\n      row: 1,\n      column: 1,\n    };\n    const afterUserClick: TicTacToeViewModel = {\n      board: [\n        ['', '', ''],\n        ['', 'x', ''],\n        ['', '', ''],\n      ],\n      turn: `computer's turn`,\n    };\n    const afterComputerMoves: TicTacToeViewModel = {\n      board: [\n        ['o', '', ''],\n        ['', 'x', ''],\n        ['', '', ''],\n      ],\n      turn: `your turn`,\n    };\n    testScheduler.run(({ cold, expectObservable }) => {\n      const userBoardClicks = cold<SpaceCoordinates>('---a------', {\n        a: userClicksCenterSquare,\n      });\n      const userResetClicks = cold<void>('---- 1999ms ---a', { a: undefined });\n      const expected = cold('a--b 1999ms c--a', {\n        a: initialState,\n        b: afterUserClick,\n        c: afterComputerMoves,\n      });\n      const result = ticTacToeViewModel$({\n        userSpaceClickEvents$: userBoardClicks,\n        userResetClickEvents$: userResetClicks,\n        ai: testAiFunction,\n      });\n      expectObservable(result).toEqual(expected);\n    });\n  });\n```\n\nFairly straight-forward - but it will be a good marker to let us know if the most basic functionality of resetting our game is working properly\n\nNext one is around the same reset case, with a twist: the user can reset the game while the computer is \"thinking\" (making sure that the move the computer would have made is appropriately \"cancelled\"!)\n\n![Alt Text](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/0o83nc4a46a0d2jh2yla.png)\n\nI think that covers it for most of the potential edge cases of our system! For good measure, I'd also throw a couple fully-played out games as well just to be sure that we can make it all the way through a game without issues (I'm not gonna diagram those out here, but you can see it in action for yourself in [the @derxjs codebase :)](https://github.com/ZackDeRose/derxjs/blob/main/libs/examples/tic-tac-toe-view-model-implementation/src/lib/view-model.spec.ts))\n\nRun the test suite now if you like:\n\n```bash\ngit clone https://github.com/ZackDeRose/derxjs.git\ncd derxjs\nnpm i\nnpx nx test examples-tic-tac-toe-view-model-implementation\n```\n\n### Implementing our \"DeRxJS View Model\" Pattern\n\nAlright, so we've got a fully fleshed out spec at this point - time to implement!\n\n(Btw - if you want to give yourself a fun challenge now - go clone my derxjs repo and erase the contents of `tic-tac-tow-view-model-implementation/src/lib/view-model.spec`, and see if you can get the tests to pass before reading this section!)\n\nWe could honestly go a couple ways with this specific problem (in particular a 'state machine' approach would be a great fit for this - and I hope to do a proper XState implementation [maybe even a @derxjs/xstate package somewhere down the line!!] at some point in the future).\n\nBut because it's a pretty common pattern, we'll look at a \"reducer\" solution here!\n\nIf you're familiar with the JavaScript Array.reduce() method, that's a great place to start:\n\n```ts\nconst foo = [1,2,3,4]\n\nfunction sum(arr: number[]): number {\n  return arr.reduce(\n    (accumulator, arrayItem) => accumulator + arrayItem,\n    0\n  );\n}\n\nconsole.log(sum(foo)); // 10\n```\n\nIn this code, we used `reduce` to \"reduce the contents of the array down to a single value: their sum.\" Notice that this too is a higher-order function (since it takes a function as a parameter), making it very versatile. You can do ALOT of things with reduce.\n\nWe're actually interested more in the reducer function though, specifically:\n\n```ts\n(accumulator, arrayItem) => accumulator + arrayItem\n```\n\nThe idea for this function is that it will loop through the list and call this function for each item; the item itself going into the `arrayItem` param, and the return value of the prior function call going into the `accumulator` param.\n\nIn this way, we \"reduce the array down to a sum\"! Pretty cool.\n\nWe're going to take this same concept a bit further for our tic-tac-toe example now, expanding the anaology in 2 separate dimensions:\n\n1. Instead of numbers, we're going to reduce some set of \"observed events\" (think user clicks and ai moves) down into the `TicTacToeViewModel` interface from the prior section; here it is again if you missed it:\n\n```ts\nexport interface TicTacToeViewModel {\n  board: Board;\n  turn: Turn;\n}\n\nexport type Turn =\n  | 'your turn'\n  | `computer's turn`\n  | 'game over - you win'\n  | 'game over - you lose'\n  | `game over - it's a tie`;\n\nexport type SpaceContent = 'x' | 'o' | '';\n\nexport type Board = [\n  [SpaceContent, SpaceContent, SpaceContent],\n  [SpaceContent, SpaceContent, SpaceContent],\n  [SpaceContent, SpaceContent, SpaceContent]\n];\n```\n\n2. Instead of synchronously iterating through a defined list and returning a value at the end of it all, we're going to asynchronously handle events immediately as they are observed, emitting a corresponding state. (this one sounds intimidating, but this one is actually quite trivial thanks to RxJS!)\n\nBefore getting overwhelmed in all this, let's take a deep breath and break this down into it's pieces. The first step is to identify the events that could potentially change our `TicTacToeViewModel`.\n\nTwo of them are pretty clear (because they're input observables to our function!): user clicking a square, and user clicking reset.\n\nLet's go ahead and wrap those up now, by creating interfaces for them that wrap their value in an object and add a 'type' property to them (we'll switch on these 'type values later on!):\n\n```ts\ninterface UserSpaceClickAction {\n  type: 'user space click';\n  space: SpaceCoordinates;\n}\n\n// export interface SpaceCoordinates {\n//   row: BoardIndex;\n//   column: BoardIndex;\n// }\n\ninterface UserResetAction {\n  type: 'user reset click';\n}\n```\n\n[You might see this elsewhere referred to as \"tokenizing\" (or \"actionizing\") the data.]\n\nThere's one more event that would change our view model though: the ai's moves:\n\n```ts\ninterface AiAction {\n  type: 'ai action';\n  space: SpaceCoordinates;\n}\n```\n\nWe'll create a [union type](https://www.typescriptlang.org/docs/handbook/unions-and-intersections.html#union-types) of these actions via TS as well:\n\n```ts\ntype Action = UserSpaceClickAction | UserResetAction | AiAction;\n```\n\nThink of this as \"grouping\" the actions into a single type, where you know an `Action` is one of the 3 possible.\n\nNow we'll write the signature for our `reducer` function:\n\n```ts\nexport function reducer(\n  state: TicTacToeViewModel,\n  action: Action\n): TicTacToeViewModel {\n  // ... impl here\n}\n```\n\nBest to think of this function as \"handling\" an action - so if a user clicks on a button, the next state should be the same as before, but with an 'X' on the square the user selected (and also the computer's turn - or maybe the user even won with that move and we should say \"You Win!!\"):\n\n![Alt Text](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/r0zjcjm13mpseqxly743.png)\n\nOr if the user clicks \"reset\" we should get a new board:\n\n![Alt Text](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/b3h5alnhis82x0d5hqxw.png)\n\nOr if the user clicks on an occupied square, or tries to act while it's the computer's turn, we should just stay the same.\n\n![Alt Text](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1p6qefzwem6hww4gptx0.png)\n\nHopefully these sound familiar, because these are pretty much exactly the test cases we had tested prior! ONLY! Rather than thinking about the whole flow of data (the whole timeline) instead we're focused in on the micro: handling a single action.\n\nBefore we actually write these functions though, let's create some utility functions for the things we'll need:\n{% details TicTacTo Utility Fns %}\n```ts\nfunction isSpaceOccupied(board: Board, space: SpaceCoordinates): boolean {\n  return board[space.row][space.column] !== '';\n}\n\n/**\n * assumes the given `space` is unoccupied!\n */\nfunction nextBoard(\n  board: Board,\n  space: SpaceCoordinates,\n  player: 'x' | 'o'\n): Board {\n  const newBoard: Board = [[...board[0]], [...board[1]], [...board[2]]];\n  newBoard[space.row][space.column] = player;\n  return newBoard;\n}\n\nfunction isGameOver(\n  board: Board\n): 'user wins' | 'computer wins' | 'tie game' | false {\n  const winningCombinations: [\n    SpaceCoordinates,\n    SpaceCoordinates,\n    SpaceCoordinates\n  ][] = [\n    [\n      { row: 0, column: 0 },\n      { row: 0, column: 1 },\n      { row: 0, column: 2 },\n    ],\n    [\n      { row: 1, column: 0 },\n      { row: 1, column: 1 },\n      { row: 1, column: 2 },\n    ],\n    [\n      { row: 2, column: 0 },\n      { row: 2, column: 1 },\n      { row: 2, column: 2 },\n    ],\n    [\n      { row: 0, column: 0 },\n      { row: 1, column: 0 },\n      { row: 2, column: 0 },\n    ],\n    [\n      { row: 0, column: 1 },\n      { row: 1, column: 1 },\n      { row: 2, column: 1 },\n    ],\n    [\n      { row: 0, column: 2 },\n      { row: 1, column: 2 },\n      { row: 2, column: 2 },\n    ],\n    [\n      { row: 0, column: 0 },\n      { row: 1, column: 1 },\n      { row: 2, column: 2 },\n    ],\n    [\n      { row: 0, column: 2 },\n      { row: 1, column: 1 },\n      { row: 2, column: 0 },\n    ],\n  ];\n  for (const [x, y, z] of winningCombinations) {\n    if (\n      board[x.row][x.column] === 'x' &&\n      board[y.row][y.column] === 'x' &&\n      board[z.row][z.column] === 'x'\n    ) {\n      return 'user wins';\n    }\n    if (\n      board[x.row][x.column] === 'o' &&\n      board[y.row][y.column] === 'o' &&\n      board[z.row][z.column] === 'o'\n    ) {\n      return 'computer wins';\n    }\n  }\n  return (board.flat() as SpaceContent[]).some((contents) => contents === '')\n    ? false\n    : 'tie game';\n}\n\nexport function createInitialViewModel(): TicTacToeViewModel {\n  return {\n    board: [\n      ['', '', ''],\n      ['', '', ''],\n      ['', '', ''],\n    ],\n    turn: 'your turn',\n  };\n}\n```\n{% enddetails %}\n\nFunctions make for really great \"Lego blocks\" and now that we have all these, let's write out function (throwing the real implementation in here because too many cases to cover them all in text, but good for you to look over it and make sure it makes sense):\n\n```ts\nexport function reducer(\n  state: TicTacToeViewModel,\n  action: Action\n): TicTacToeViewModel {\n  switch (action.type) {\n    case 'user reset click': {\n      return createInitialViewModel();\n    }\n    case 'user space click': {\n      if (state.turn !== 'your turn') {\n        return state;\n      }\n      if (isSpaceOccupied(state.board, action.space)) {\n        return state;\n      }\n      const newBoard = nextBoard(state.board, action.space, 'x');\n      const result = isGameOver(newBoard);\n      switch (result) {\n        case false: {\n          return {\n            board: newBoard,\n            turn: `computer's turn`,\n          };\n        }\n        case 'user wins': {\n          return {\n            board: newBoard,\n            turn: 'game over - you win',\n          };\n        }\n        case 'tie game': {\n          return {\n            board: newBoard,\n            turn: `game over - it's a tie`,\n          };\n        }\n        default: {\n          throw 'should not be reached';\n        }\n      }\n    }\n    case 'ai action': {\n      const newBoard = nextBoard(state.board, action.space, 'o');\n      const result = isGameOver(newBoard);\n      switch (result) {\n        case false: {\n          return {\n            board: newBoard,\n            turn: 'your turn',\n          };\n        }\n        case 'computer wins': {\n          return {\n            board: newBoard,\n            turn: 'game over - you lose',\n          };\n        }\n        default: {\n          throw 'should not be reached';\n        }\n      }\n    }\n  }\n}\n```\n\nAwesome!! It wouldn't be a terrible idea now to write some test for this reducer function (or even writing them before we implemented this) but since we already have our test suite set up, this is not really necessary. (Even the fact that we're using a `reducer` strategy right now is implementation detail that we don't necessarily want to preserve moving forward!)\n\nThe majority of our work is done now! For the sake of time, I'm going to reveal the rest of the black box of our \"reducer\" implementation of the `ticTacToeViewModel$()`:\n\n![Mostly done now!](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/vgjqmjoa6n2akhn0tqcr.png)\n\nThe shape \"engine\" is actually quite generic to the reducer pattern (although passing in the `ai()` function is a little bit of a twist... but not that much). If you've worked with NgRx, Redux, or some similar library, it actually probably looks very familiar already!\n\nThis \"genericism\" actually makes it quite nice to \"package\" this flow and... maybe [publish it on npm](https://www.npmjs.com/package/@derxjs/reducer)??? (you can check out an example implementation for this same problem [that uses this exact same reducer function we just wrote!!] in [the derxjs repo](https://github.com/ZackDeRose/derxjs/blob/main/libs/examples/tic-tac-toe-view-model-implementation/src/lib/using-reducer-package.ts)!)\n\nBut in any case, let's follow the diagram and see how to translate this into code:\n\nFirst off, we'll take our incoming user actions and use the [map](https://rxjs.dev/api/operators/map) operator to \"tokenize\" or wrap them into the right `Action` type, and then [merge](https://rxjs.dev/api/operators/merge) them down to create a single `actions$` Observable. We'll go ahead here and create out `actionsSubject` and start sharing our actions to that subject.\n\n```ts\nconst actionsSubject = new Subject<Action>();\nconst userClickActions$ = userSpaceClickEvents$.pipe(\n    map(\n      (space): UserSpaceClickAction => ({\n        type: 'user space click',\n        space: space,\n      })\n    )\n  );\n  const userResetActions$ = userResetClickEvents$.pipe(\n    map(\n      (): UserResetAction => ({\n        type: 'user reset click',\n      })\n    )\n  );\n  const actions$ = merge(userClickActions$, userResetActions$).pipe(\n    share({ connector: () => actionsSubject })\n  );\n```\n\n![Alt Text](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/sswq5echsjvb09ju5u81.png)\n\n(Green shows what we've done!)\n\nNext up, we're gonna hook that actions stream up with our reducer function to create our state observable. This is the `Observable<TicTacToeViewModel>` that we set our to make!!! But we're not done yet...\n\n```ts \nconst state$ = actions$.pipe(\n    scan(reducer, createInitialViewModel()),\n    startWith<TicTacToeViewModel>(createInitialViewModel()),\n    distinctUntilChanged()\n  );\n```\n\n^ Note how we used [scan](https://rxjs.dev/api/operators/scan) with our reducer function here. What we're doing is feeding in all the user's actions one-by-one, and each action is running through that reducer to get to a next \"TicTacToeViewModel\" object, which is a super clean && easy way to get to our `Observable` of that `TicTacToeViewModel`!!! This is where RxJS really shines in my opinion!\n\nNote we're also [starting with](https://rxjs.dev/api/operators/startWith) an initialState (think just an empty board) and we're going to use [distinctUntilChanged](https://rxjs.dev/api/operators/distinctUntilChanged) to filter out any times our state observable would emit the same state over again (since we're creating this view model for a ui - it really doesn't make sense to make the UI re-render if [for example] the user tried to click on a space that was already occupied!\n\n![Alt Text](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/f7iudm360ag007b851y7.png)\n\nIf we ran this now as is though, after the user made their first move, it would become the computer's turn, and so far, we haven't hooked up the ai piece of our code yet, so the user would just be stuck in that state....\n\nThis is where \"effects\" come into play! The idea of an effect (thinking generically in the context of DeRxJS/reducer) is that it is a function that takes our `actions$` Observable, and our `state$` Observable (or just one of them.... or NEITHER!) and returns a new Observable of actions that we're going to connect BACK into our actions Subject to [share](https://rxjs.dev/api/operators/share) those actions back into the actions$ observable!\n\nThat's generically though - for our specific example, we only have the one effect that we need to worry about, and that's our AI!\n\nWe'll start this with the observed states, [filter](https://rxjs.dev/api/operators/filter)ed down to only states where the turn has just changed to \"computer's turn\" - we'll then [delay](https://rxjs.dev/api/operators/delay) for 2 seconds before [map](https://rxjs.dev/api/operators/map)ping the `Board` that came with the state through our `ai()` function to get our computer's move!\n\nLast step is to wrap alll that into a (switchMap)[https://rxjs.dev/api/operators/switchMap] from the user reset actions! We do this so that if the user ever resets the game while the computer is \"thinking\", we'd \"discard\" that subscription, so that the computer doesn't randomly barge in 2 seconds after the last \"user space click\" action when it should be the user's turn!\n\n```ts\nconst aiActions$ = userResetActions$.pipe(\n    startWith(undefined),\n    switchMap(() =>\n      state$.pipe(\n        filter((x) => x.turn === `computer's turn`),\n        delay(2000),\n        map((state) => ({\n          type: 'ai action' as const,\n          space: ai({ board: state.board, aiLetter: 'o' }),\n        })),\n        share({ connector: () => actionsSubject })\n      )\n    )\n  );\n\n  aiActions$.subscribe();\n\n  return state$;\n```\n\nLast thing to do, subscribe to our `aiActions$` and return the `state$`!\n\n![Alt Text](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/kquhv2nweyujsrjse5lb.png)\n\n![catching my breath](https://res.cloudinary.com/practicaldev/image/fetch/s--GBdGae-N--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://media4.giphy.com/media/AS6bC3bKauQnwgyrad/200.gif)\n\nAnd yes - I'm aware there's a potentially leaky subscription there on the aiActions$!\n\n![Alt Text](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7vuhxvx7wkqtms36svds.png)\n\nI'm gonna say that's okay for now (in my mind, this \"game\" is all our app is, so no need to teardown...) - but be sure to checkout [the DeRxJS/reducer source code](https://github.com/ZackDeRose/derxjs/blob/main/packages/reducer/src/lib/reducer.ts#L32) to see how we could handle that!\n\n### Closing Thoughts\n\nI'm very excited for the work we're doing here (and not just because of the upcoming DeRxJS roadmap 👀):\n\n![Alt Text](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1mo8ycwmx7bvp3hfdpxh.png)\n\nThe reason I'm excited is that (in case you didn't notice) NONE OF THE CODE WE WROTE IN THIS ARTICLE is domain-specific. Beyond just Angular/React/Vue/etc., we could take this same 'tic-tac-toe' state management code now and drop it in a mobile app/a native app/Artificial Reality/Augmented Reality/really ANY presentation layer and our state management code would be valid, and proven to be to spec!\n\nI'm very excited to see where this takes us next - and I can't wait to see y'all in the next article!!\n\n### About the author\n\n![Zack DeRose](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/idzdgnshhxtbabgvvrmw.jpg)\n\nZack DeRose [or DeRxJS if you like] is:\n+ [a GDE in Angular](https://developers.google.com/community/experts/directory/profile/profile-zack-derose?hl=en)\n+ a recent nx conf/NgConf/RxJS Live/The Angular Show/ZDS speaker\n+ Creator of the [@derxjs OSS packages](https://github.com/ZackDeRose/derxjs)\n+ Senior Engineer and Engineering Manager at [Nrwl](https://nrwl.io/)\n\nCheckout out my [personal website](https://zackderose.dev/videos) for more of my dev content! And go bug [Jeff Cross](https://twitter.com/jeffbcross)/[Joe Johnson](https://twitter.com/joerjohnson) if you want to hire me to come help out your codebase or come help level up your team on Nx/NgRx/DeRxJS/RxJS/State Management! (I especially love building awesome stuff - and building up teams with bright developers that are eager to learn!)",n.user={name:"Zack DeRose",username:p,twitter_username:p,github_username:s,website_url:"https://zackderose.dev",profile_image:"https://res.cloudinary.com/practicaldev/image/fetch/s--vINXVSah--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/126200/c43736b5-6ece-46c5-a3bd-4fb1a5e7f845.jpg",profile_image_90:"https://res.cloudinary.com/practicaldev/image/fetch/s--LvQdZXxw--/c_fill,f_auto,fl_progressive,h_90,q_auto,w_90/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/126200/c43736b5-6ece-46c5-a3bd-4fb1a5e7f845.jpg"},{layout:"default",data:[{}],fetch:{"data-v-70afb46a:0":{article:n}},error:s,state:{currentArticle:n},serverRendered:!0,routePath:"/zackderose/849465",config:{_app:{basePath:"/nuxtstop/",assetsPath:"/nuxtstop/_nuxt/",cdnURL:s}}}}(null,"2021-10-08T14:15:48Z",{},"https://dev.to/zackderose/the-derxjsviewmodel-pattern-the-e-mc-2-of-state-management-part-1-3dka","zackderose")</script><script src="/nuxtstop/_nuxt/f6e87fb.js" defer></script><script src="/nuxtstop/_nuxt/dc9ce94.js" defer></script><script src="/nuxtstop/_nuxt/6474719.js" defer></script><script src="/nuxtstop/_nuxt/9b75090.js" defer></script><script src="/nuxtstop/_nuxt/18df600.js" defer></script>
  </body>
</html>
