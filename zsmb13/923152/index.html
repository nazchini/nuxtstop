<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Adventures in Tracking Upload Progress With OkHttp and Retrofit</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="Using Nuxt.js fetch() hook to build dev.to with a new look"><meta data-n-head="ssr" name="format-detection" content="telephone=no"><base href="/nuxtstop/"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,500,600&display=swap"><link rel="preload" href="/nuxtstop/_nuxt/f6e87fb.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/6474719.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/9b75090.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/18df600.js" as="script"><link rel="preload" href="/nuxtstop/_nuxt/dc9ce94.js" as="script"><style data-vue-ssr-id="c650fd98:0 af4684f0:0 a9c71758:0 dcafa518:0 4b9cec49:0 b093d766:0 9d98bcb4:0 6b6a11ea:0 0248ed80:0 ea8e4264:0">html{box-sizing:border-box;font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}*,:after,:before{box-sizing:inherit}html{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}*,:after,:before{border:0 solid #e0e0e0}blockquote,body,dd,dl,figure,h1,h2,h3,h4,h5,h6,p,pre{margin:0}button{background:0 0;padding:0}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}hr{border-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:inherit;opacity:.5}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:inherit;opacity:.5}input::placeholder,textarea::placeholder{color:inherit;opacity:.5}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit;font-family:sans-serif}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit;font-family:inherit;font-size:100%}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;overflow:auto;word-break:break-word;white-space:normal}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}html{height:100%;font-size:18px;-ms-overflow-style:scrollbar;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}@media(min-width:640px){html{font-size:20px}}body{height:100%;min-width:320px;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:400;line-height:1.5;color:#000;background-color:#eff4f7;-webkit-text-rendering:optimizeLegibility;text-rendering:optimizeLegibility;font-synthesis:none;font-kerning:normal;font-feature-settings:"normal","kern";-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-overflow-scrolling:touch;overflow-x:hidden;overflow-y:scroll}h1,h2,h3,h4,h5,h6{color:#000;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-weight:600;font-feature-settings:"normal";line-height:1.2}pre{background:#29292e;border-radius:2px;overflow:auto;padding:1rem;color:#eff1f9;line-height:1.42em;font-size:13px}@media screen and (min-width:380px){pre{font-size:15px}}pre code{background:#29292e;color:#eff0f9;white-space:pre}div.highlight pre.highlight code{font-size:inherit;padding:0}div.inner-comment div.body div.highlight pre.highlight{background:#29292e}div.inner-comment div.body div.highlight pre.highlight code{font-size:inherit;white-space:inherit;background:inherit;color:inherit}.highlight .hll{background-color:#49483e}.highlight{background:#29292e;color:#f8f8f2}.highlight .c{color:grey}.highlight .err{text-shadow:0 0 7px #f9690e}.highlight .k{color:#f39c12}.highlight .l{color:plum}.highlight .n{color:#f8f8f2}.highlight .o{color:#f9690e}.highlight .p{color:#f8f8f2}.highlight .c1,.highlight .ch,.highlight .cm,.highlight .cp,.highlight .cpf,.highlight .cs{color:grey}.highlight .gd{color:#f9690e}.highlight .ge{font-style:italic}.highlight .gi{color:#7ed07e}.highlight .gs{font-weight:700}.highlight .gu{color:grey}.highlight .kc,.highlight .kd{color:#f39c12}.highlight .kn{color:#f9690e}.highlight .kp,.highlight .kr,.highlight .kt{color:#f39c12}.highlight .ld{color:#f2ca27}.highlight .m{color:plum}.highlight .s{color:#f2ca27}.highlight .na{color:#7ed07e}.highlight .nb{color:#f8f8f2}.highlight .nc{color:#7ed07e}.highlight .no{color:#f39c12}.highlight .nd{color:#7ed07e}.highlight .ni{color:#f8f8f2}.highlight .ne,.highlight .nf{color:#7ed07e}.highlight .nl,.highlight .nn{color:#f8f8f2}.highlight .nx{color:#7ed07e}.highlight .py{color:#f8f8f2}.highlight .nt{color:#f9690e}.highlight .nv{color:#f8f8f2}.highlight .ow{color:#f9690e}.highlight .w{color:#f8f8f2}.highlight .mb,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo{color:plum}.highlight .dl,.highlight .s2,.highlight .sa,.highlight .sb,.highlight .sc,.highlight .sd{color:#f2ca27}.highlight .se{color:plum}.highlight .s1,.highlight .sh,.highlight .si,.highlight .sr,.highlight .ss,.highlight .sx{color:#f2ca27}.highlight .bp{color:#f8f8f2}.highlight .fm{color:#7ed07e}.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{color:#f8f8f2}.highlight .il{color:plum}.vue-content-placeholders-heading__img,.vue-content-placeholders-heading__subtitle,.vue-content-placeholders-heading__title,.vue-content-placeholders-img,.vue-content-placeholders-text__line{background:#bfcdec!important}.vue-content-placeholders-is-animated .vue-content-placeholders-heading__img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__subtitle:before,.vue-content-placeholders-is-animated .vue-content-placeholders-heading__title:before,.vue-content-placeholders-is-animated .vue-content-placeholders-img:before,.vue-content-placeholders-is-animated .vue-content-placeholders-text__line:before{background:linear-gradient(90deg,transparent 0,#d3ddf9 15%,transparent 30%)!important}header[data-v-27046cca]{max-width:1280px;margin:auto;padding:1rem;height:6rem;border-bottom:1px solid rgba(0,0,0,.2)}header .logo-wrapper[data-v-27046cca],header[data-v-27046cca]{display:flex;align-items:center;justify-content:space-between}header .logo-wrapper[data-v-27046cca]{margin:0 .5rem}header .logo-wrapper svg[data-v-27046cca]{width:3rem;height:100%}header .logo-wrapper .name-wrapper[data-v-27046cca]{margin-left:.6em}header .logo-wrapper .name-wrapper .subtitle[data-v-27046cca]{font-size:1rem}header .logo-wrapper .name-wrapper .app-name[data-v-27046cca]{font-weight:700;font-size:2.25rem;line-height:1.25}header nav[data-v-27046cca]{letter-spacing:-.025rem;font-weight:600;text-transform:uppercase}header nav ul[data-v-27046cca]{display:flex}header nav ul li[data-v-27046cca]{margin:0 .5rem}header nav ul li a[data-v-27046cca]{box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;padding:.25rem 1rem;border-radius:.5rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}header nav ul li a[data-v-27046cca]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header nav ul li a.nuxt-link-exact-active[data-v-27046cca]{cursor:default}header nav ul li a.nuxt-link-exact-active[data-v-27046cca],header nav ul li a[data-v-27046cca]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}.page-wrapper[data-v-10d06ee8]{max-width:1280px;margin:auto;padding:1rem}.article-content-wrapper[data-v-10d06ee8]{display:flex;flex-direction:column;align-items:center;margin:auto auto 2rem}@media(min-width:1024px){.article-content-wrapper[data-v-10d06ee8]{align-items:normal;flex-direction:row}}.article-content-wrapper .article-block[data-v-10d06ee8]{width:100%;max-width:880px}@media(min-width:1024px){.article-content-wrapper .article-block[data-v-10d06ee8]{margin-right:1rem;width:66.66666%;margin-bottom:2rem}}.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{max-width:880px;width:100%;position:relative}@media(min-width:1024px){.article-content-wrapper .aside-username-wrapper[data-v-10d06ee8]{display:block;width:33.33333%}}.article-content-wrapper .aside-username-wrapper .aside-username-block[data-v-10d06ee8]{position:-webkit-sticky;position:sticky;top:1rem}@media(min-width:1280px){.comments-block[data-v-10d06ee8]{margin:.5rem}}article[data-v-70afb46a]{padding:.5rem;border-radius:1rem}header h1[data-v-70afb46a],header[data-v-70afb46a]{margin-bottom:1rem}header h1[data-v-70afb46a]{font-size:2.25rem;letter-spacing:-.025rem}header .tags[data-v-70afb46a]{display:flex;flex-wrap:wrap;margin-bottom:1.5rem}header .tags .tag[data-v-70afb46a]{font-weight:500;line-height:1;padding:.5rem;margin:0 .5rem .5rem 0;border-radius:.25rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db}header .tags .tag[data-v-70afb46a]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}header .tags .tag[data-v-70afb46a]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}header .image-wrapper[data-v-70afb46a]{position:relative;padding-bottom:56.25%;background-color:#d4dfe8;margin-bottom:1.5rem;border-radius:.5rem;overflow:hidden}@media(min-width:834px){header .image-wrapper[data-v-70afb46a]{margin-bottom:1.5rem}}header .image-wrapper img[data-v-70afb46a]{position:absolute;top:0;left:0;width:100%;height:100%;-o-object-fit:cover;object-fit:cover}header .meta[data-v-70afb46a]{line-height:1;font-size:.875rem;text-transform:uppercase;font-weight:500;letter-spacing:-.025rem;display:flex;align-items:center;justify-content:space-between}header .meta .scl[data-v-70afb46a]{display:flex}header .meta .scl span[data-v-70afb46a]{display:flex;align-items:center;margin-right:1rem}header .meta .scl span svg[data-v-70afb46a]{margin-right:.25rem}header .meta .scl .comments[data-v-70afb46a]{cursor:pointer}[data-v-70afb46a] .content .ltag__user{display:none}[data-v-70afb46a] .content iframe{max-width:100%}[data-v-70afb46a] .content h1{font-size:1.875rem}[data-v-70afb46a] .content h1,[data-v-70afb46a] .content h2{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h2{font-size:1.5rem}[data-v-70afb46a] .content h3{font-size:1.25rem}[data-v-70afb46a] .content h3,[data-v-70afb46a] .content h4{margin-top:2rem;margin-bottom:1rem;letter-spacing:-.025rem}[data-v-70afb46a] .content h4{font-size:1rem}[data-v-70afb46a] .content a{color:#6e87d2}[data-v-70afb46a] .content p{margin-bottom:1rem;line-height:1.4}[data-v-70afb46a] .content p code{background-color:#d2f3e1;border-radius:.25rem;padding:.25rem}[data-v-70afb46a] .content img{width:100%;border-radius:.5rem}[data-v-70afb46a] .content .highlight{margin-bottom:1rem;border-radius:.5rem}[data-v-70afb46a] .content ul{list-style:numeral;margin-bottom:1rem}[data-v-70afb46a] .content ul li p{margin-bottom:0}[data-v-70afb46a] .content ol{margin-bottom:1rem}aside[data-v-37984f8c]{padding:1rem;background-color:#dfe8ef;border-radius:1rem}aside .username-heading[data-v-37984f8c]{display:flex;margin-bottom:1rem}aside .username-heading[data-v-37984f8c]:hover{color:#6e87d2}aside .username-heading img[data-v-37984f8c]{width:3rem;height:3rem;border-radius:50%;margin-right:1rem}aside .username-heading .text[data-v-37984f8c]{display:flex;flex-direction:column;justify-content:center}aside .username-heading .text a[data-v-37984f8c]{line-height:1}aside .username-heading .text a[data-v-37984f8c]:first-child{font-size:1.25rem;font-weight:500;letter-spacing:-.025rem;margin-bottom:.25rem}aside .username-heading .text a[data-v-37984f8c]:last-child{color:#999;font-size:.875rem}aside .username-heading.loading[data-v-37984f8c]{display:block}aside .f-button[data-v-37984f8c]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}aside .f-button[data-v-37984f8c]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}aside .f-button[data-v-37984f8c]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}aside .info>div[data-v-37984f8c]{margin-bottom:.5rem}aside .info .title[data-v-37984f8c]{font-size:.666666rem;letter-spacing:-.0125rem;font-weight:500;color:#999;text-transform:uppercase;margin-bottom:.1rem}aside .info .content[data-v-37984f8c]{font-size:.875rem;line-height:1.4}.add-comment[data-v-8c4375bc]{display:block;width:100%;padding:.5rem;border-radius:.5rem;box-shadow:-4px -4px 8px #f8fafe,4px 4px 8px #ced2db;text-transform:uppercase;text-align:center;font-weight:600;letter-spacing:-.025rem;margin-bottom:1rem}.add-comment[data-v-8c4375bc]:hover{background:linear-gradient(135deg,rgba(0,0,0,.09),hsla(0,0%,100%,0))}.add-comment[data-v-8c4375bc]:active{background:0 0;box-shadow:inset -4px -4px 8px #f0f3f9,inset 4px 4px 8px #ced2db,inset -1px -1px 4px #8e8e8e}footer[data-v-22cb8fd0]{padding:2rem;text-align:center;display:flex;align-items:center;justify-content:center}footer span[data-v-22cb8fd0]{display:inline-block;line-height:1;text-transform:uppercase;letter-spacing:-.025rem;font-size:.75rem;font-weight:500}footer a svg[data-v-22cb8fd0]{width:3rem;height:3rem;margin:0 .5rem}footer a .nuxt-icon[data-v-22cb8fd0]{width:2.5rem;height:2.5rem;margin:0 .25rem}</style>
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><div id="__layout"><div><header data-v-27046cca><a href="/nuxtstop/" class="logo-wrapper nuxt-link-active" data-v-27046cca><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-27046cca><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-27046cca></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-27046cca></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-27046cca></path></svg> <div class="name-wrapper" data-v-27046cca><span class="app-name" data-v-27046cca>Nuxtstop</span> <p class="subtitle" data-v-27046cca>For all things nuxt.js</p></div></a> <nav data-v-27046cca><ul data-v-27046cca><li data-v-27046cca><a href="/nuxtstop/" class="nuxt-link-active" data-v-27046cca>
          New
        </a></li><li data-v-27046cca><a href="/nuxtstop/top" data-v-27046cca>
          Top
        </a></li></ul></nav></header> <div class="page-wrapper" data-v-10d06ee8><div class="article-content-wrapper" data-v-10d06ee8><article data-fetch-key="data-v-70afb46a:0" class="article-block" data-v-70afb46a data-v-10d06ee8><header data-v-70afb46a><h1 data-v-70afb46a>Adventures in Tracking Upload Progress With OkHttp and Retrofit</h1> <div class="tags" data-v-70afb46a><a href="/nuxtstop/t/android" class="tag" data-v-70afb46a>
          #android
        </a><a href="/nuxtstop/t/networking" class="tag" data-v-70afb46a>
          #networking
        </a><a href="/nuxtstop/t/okhttp" class="tag" data-v-70afb46a>
          #okhttp
        </a><a href="/nuxtstop/t/retrofit" class="tag" data-v-70afb46a>
          #retrofit
        </a></div> <div class="image-wrapper" data-v-70afb46a><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--6mHQlo-r--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/wt8jnffbqdogyc9wpaod.png" alt="Adventures in Tracking Upload Progress With OkHttp and Retrofit" data-v-70afb46a></div> <div class="meta" data-v-70afb46a><div class="scl" data-v-70afb46a><span data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M16.4444 3C14.6733 3 13.0333 3.94162 12 5.34C10.9667 3.94162 9.32667 3 7.55556 3C4.49222 3 2 5.52338 2 8.625C2 14.8024 11.0267 20.586 11.4122 20.829C11.5922 20.9426 11.7956 21 12 21C12.2044 21 12.4078 20.9426 12.5878 20.829C12.9733 20.586 22 14.8024 22 8.625C22 5.52338 19.5078 3 16.4444 3Z" fill="#FF0000" data-v-70afb46a data-v-70afb46a></path></svg>
            41
          </span> <span class="comments" data-v-70afb46a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-70afb46a data-v-70afb46a><path d="M6.11765 22H4.94118L5.64706 21.05C6.11765 20.3969 6.41176 19.5656 6.58824 18.5563C3.64706 17.1906 2 14.6375 2 11.3125C2 6.20625 5.82353 3 12 3C18.1765 3 22 6.20625 22 11.3125C22 16.5375 18.2353 19.625 12 19.625H11.5882C10.6471 20.7531 9 22 6.11765 22ZM12 4.1875C6.47059 4.1875 3.17647 6.85937 3.17647 11.3125C3.17647 15.1125 5.47059 16.8938 7.41177 17.6656L7.82353 17.8437L7.76471 18.3187C7.64706 19.2687 7.47059 20.1 7.11765 20.8125C9.05882 20.575 10.1765 19.5656 10.8235 18.7344L11 18.4969H12C19.9412 18.4969 20.8235 13.5094 20.8235 11.3719C20.8235 6.85938 17.5294 4.1875 12 4.1875Z" fill="black" data-v-70afb46a data-v-70afb46a></path></svg>
            1
          </span></div> <time data-v-70afb46a>Dec 10 '21</time></div></header> <div class="content" data-v-70afb46a><p>This article tells the story of how Stream’s Android team refined our progress tracking process during file uploads in the <a href="https://github.com/GetStream/stream-chat-android/">Stream Chat Android SDK</a>.</p>

<p>Our original implementation to track file upload progress worked, but it had some in-code usability and UX issues that we wanted to clean up. </p>

<p>The following account gives an up-close look into the process we had, the problems we encountered, and what we did to improve. </p>

<blockquote>
<p><strong>Warning:</strong> As this is a story of mistakes we made and then corrected over time, <strong>do not</strong> use any of the initial or intermediate forms of code here in your own projects, only the final fixed version. 😉</p>
</blockquote>

<h2>
  <a name="uploading-files-with-retrofit" href="#uploading-files-with-retrofit">
  </a>
  Uploading Files With Retrofit
</h2>

<p>First things first, let's see how you can upload a file to an API using <a href="https://square.github.io/retrofit/">Retrofit</a>. Most APIs will expect a multipart form to contain the file data. You can declare a method inside a Retrofit interface like the one below to support that operation:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight kotlin"><code><span class="nd">@Multipart</span>
<span class="nd">@POST</span><span class="p">(</span><span class="s">"/channels/{type}/{id}/file"</span><span class="p">)</span>
<span class="k">fun</span> <span class="nf">sendFile</span><span class="p">(</span>
    <span class="nd">@Path</span><span class="p">(</span><span class="s">"type"</span><span class="p">)</span> <span class="n">channelType</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="nd">@Path</span><span class="p">(</span><span class="s">"id"</span><span class="p">)</span> <span class="n">channelId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="nd">@Part</span> <span class="n">file</span><span class="p">:</span> <span class="nc">MultipartBody</span><span class="p">.</span><span class="nc">Part</span><span class="p">,</span>
<span class="p">):</span> <span class="nc">RetrofitCall</span><span class="p">&lt;</span><span class="nc">UploadFileResponse</span><span class="p">></span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>To invoke this method, you can create a <code>Part</code> by using the <code>createFormData</code> function, like so:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight kotlin"><code><span class="k">fun</span> <span class="nf">sendFile</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="nc">File</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">part</span> <span class="p">=</span> <span class="nc">MultipartBody</span><span class="p">.</span><span class="nc">Part</span><span class="p">.</span><span class="nf">createFormData</span><span class="p">(</span><span class="s">"file"</span><span class="p">,</span> <span class="n">file</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                   <span class="n">file</span><span class="p">.</span><span class="nf">asRequestBody</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="nf">getMediaType</span><span class="p">()))</span>
    <span class="n">retrofitCdnApi</span>
        <span class="p">.</span><span class="nf">sendFile</span><span class="p">(</span><span class="n">channelType</span><span class="p">,</span> <span class="n">channelId</span><span class="p">,</span> <span class="n">part</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">enqueue</span><span class="p">(</span><span class="o">..</span><span class="p">.)</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Then you just <code>enqueue</code> the Retrofit <code>Call</code> to run it, and done! That's a basic, working file upload.</p>

<h2>
  <a name="counting-in-the-request-body" href="#counting-in-the-request-body">
  </a>
  Counting in the Request Body
</h2>

<p>Time to add progress tracking. For our initial implementation, we used this callback interface:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight kotlin"><code><span class="k">public</span> <span class="kd">interface</span> <span class="nc">ProgressCallback</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">fun</span> <span class="nf">onProgress</span><span class="p">(</span><span class="n">progress</span><span class="p">:</span> <span class="nc">Long</span><span class="p">)</span>
    <span class="k">public</span> <span class="k">fun</span> <span class="nf">onSuccess</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span>
    <span class="k">public</span> <span class="k">fun</span> <span class="nf">onError</span><span class="p">(</span><span class="n">error</span><span class="p">:</span> <span class="nc">ChatError</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>We then created a <code>ProgressRequestBody</code> class, most likely based on <a href="https://stackoverflow.com/a/33384551/4465208">this StackOverflow answer</a>. </p>

<p>This wraps a <code>file</code> and a <code>callback</code>, and implements the OkHttp <a href="https://square.github.io/okhttp/4.x/okhttp/okhttp3/-request-body/"><code>RequestBody</code></a> class.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight kotlin"><code><span class="k">internal</span> <span class="kd">class</span> <span class="nc">ProgressRequestBody</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">file</span><span class="p">:</span> <span class="nc">File</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">callback</span><span class="p">:</span> <span class="nc">ProgressCallback</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">RequestBody</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">contentType</span><span class="p">():</span> <span class="nc">MediaType</span> <span class="p">=</span> <span class="n">file</span><span class="p">.</span><span class="nf">getMediaType</span><span class="p">()</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">contentLength</span><span class="p">():</span> <span class="nc">Long</span> <span class="p">=</span> <span class="n">file</span><span class="p">.</span><span class="nf">length</span><span class="p">()</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">writeTo</span><span class="p">(</span><span class="n">sink</span><span class="p">:</span> <span class="nc">BufferedSink</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">total</span> <span class="p">=</span> <span class="n">file</span><span class="p">.</span><span class="nf">length</span><span class="p">()</span>
        <span class="kd">val</span> <span class="py">buffer</span> <span class="p">=</span> <span class="nc">ByteArray</span><span class="p">(</span><span class="nc">DEFAULT_BUFFER_SIZE</span><span class="p">)</span>
        <span class="kd">var</span> <span class="py">uploaded</span> <span class="p">=</span> <span class="mi">0L</span>
        <span class="nc">FileInputStream</span><span class="p">(</span><span class="n">file</span><span class="p">).</span><span class="nf">use</span> <span class="p">{</span> <span class="n">fis</span> <span class="p">-></span>
            <span class="kd">var</span> <span class="py">read</span><span class="p">:</span> <span class="nc">Int</span>
            <span class="kd">val</span> <span class="py">handler</span> <span class="p">=</span> <span class="nc">Handler</span><span class="p">(</span><span class="nc">Looper</span><span class="p">.</span><span class="nf">getMainLooper</span><span class="p">())</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">fis</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">buffer</span><span class="p">).</span><span class="nf">also</span> <span class="p">{</span> <span class="n">read</span> <span class="p">=</span> <span class="n">it</span> <span class="p">}</span> <span class="p">!=</span> <span class="p">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">handler</span><span class="p">.</span><span class="nf">post</span> <span class="p">{</span>
                    <span class="n">callback</span><span class="p">.</span><span class="nf">onProgress</span><span class="p">((</span><span class="mi">100</span> <span class="p">*</span> <span class="n">uploaded</span> <span class="p">/</span> <span class="n">total</span><span class="p">))</span>
                <span class="p">}</span>
                <span class="n">uploaded</span> <span class="p">+=</span> <span class="n">read</span><span class="p">.</span><span class="nf">toLong</span><span class="p">()</span>
                <span class="n">sink</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">read</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kd">val</span> <span class="py">DEFAULT_BUFFER_SIZE</span> <span class="p">=</span> <span class="mi">2048</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Whenever <code>writeTo</code> is invoked to write this <code>RequestBody</code> to the network, we loop through the contents of the file manually, write the bytes, and invoke the <code>callback</code>, calculating the percentage of the upload completed so far.</p>

<p>This requires a modification to our API invocation, as we now have to create a <code>ProgressRequestBody</code> that we then embed in our <code>Part</code>, which will — remember this — contain the <code>ProgressCallback</code> instance that was passed in.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight kotlin"><code><span class="k">fun</span> <span class="nf">sendFile</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="nc">File</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="nc">ProgressCallback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">progressBody</span> <span class="p">=</span> <span class="nc">ProgressRequestBody</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">part</span> <span class="p">=</span> <span class="nc">MultipartBody</span><span class="p">.</span><span class="nc">Part</span><span class="p">.</span><span class="nf">createFormData</span><span class="p">(</span><span class="s">"file"</span><span class="p">,</span> <span class="n">file</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">progressBody</span><span class="p">)</span>

    <span class="n">retrofitCdnApi</span>
        <span class="p">.</span><span class="nf">sendFile</span><span class="p">(</span><span class="n">channelType</span><span class="p">,</span> <span class="n">channelId</span><span class="p">,</span> <span class="n">part</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">enqueue</span><span class="p">(</span><span class="nc">RetroProgressCallback</span><span class="p">(</span><span class="n">callback</span><span class="p">))</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>We also pass the callback to the <code>enqueue</code> call via a wrapper to adapt it to a Retrofit <a href="https://square.github.io/retrofit/2.x/retrofit/retrofit2/Callback.html"><code>Callback</code></a>, which will run the <code>onFailure</code> and <code>onSuccess</code> methods of our original callback as needed.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight kotlin"><code><span class="k">internal</span> <span class="kd">class</span> <span class="nc">RetroProgressCallback</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">callback</span><span class="p">:</span> <span class="nc">ProgressCallback</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">Callback</span><span class="p">&lt;</span><span class="nc">UploadFileResponse</span><span class="p">></span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onFailure</span><span class="p">(</span><span class="n">call</span><span class="p">:</span> <span class="nc">Call</span><span class="p">&lt;</span><span class="nc">UploadFileResponse</span><span class="p">>,</span> <span class="n">t</span><span class="p">:</span> <span class="nc">Throwable</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">callback</span><span class="p">.</span><span class="nf">onError</span><span class="p">(</span><span class="nc">ChatError</span><span class="p">(</span><span class="n">cause</span> <span class="p">=</span> <span class="n">t</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onResponse</span><span class="p">(</span>
        <span class="n">call</span><span class="p">:</span> <span class="nc">Call</span><span class="p">&lt;</span><span class="nc">UploadFileResponse</span><span class="p">>,</span>
        <span class="n">response</span><span class="p">:</span> <span class="n">retrofit2</span><span class="p">.</span><span class="nc">Response</span><span class="p">&lt;</span><span class="nc">UploadFileResponse</span><span class="p">></span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">body</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">body</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">onFailure</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="nc">RuntimeException</span><span class="p">(</span><span class="s">"File response is null"</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">callback</span><span class="p">.</span><span class="nf">onSuccess</span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="n">file</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>If you want to explore this implementation, you can find the old version of our code <a href="https://github.com/GetStream/stream-chat-android/tree/c592028765a7b541503c4a0976775cfd823c57f1/stream-chat-android-client/src/main/java/io/getstream/chat/android/client/api">here in the GitHub history</a>.</p>

<h2>
  <a name="counting-with-a-custom-sink-implementation" href="#counting-with-a-custom-sink-implementation">
  </a>
  Counting With a Custom Sink Implementation
</h2>

<p>This is okay, but we can make it a lot nicer. For this change, we essentially took the implementation from <a href="https://medium.com/@PaulinaSadowska/display-progress-of-multipart-request-with-retrofit-and-rxjava-23a4a779e6ba">Paulina Sadowska's post about the topic</a>.</p>

<p>The improvement is to (instead of handling a <code>FileInputStream</code> manually) create a custom OkHttp <a href="https://square.github.io/okio/2.x/okio/okio/-sink/index.html"><code>Sink</code></a> implementation (based on the handy <a href="https://square.github.io/okio/2.x/okio/okio/-forwarding-sink/index.html"><code>ForwardingSink</code></a>), which will perform the counting and corresponding progress callbacks for us. </p>

<p>We'll also make <code>ProgressRequestBody</code> wrap a <code>RequestBody</code> and delegate to it whenever it needs to behave like a <code>RequestBody</code>.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight kotlin"><code><span class="k">internal</span> <span class="kd">class</span> <span class="nc">ProgressRequestBody</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">delegate</span><span class="p">:</span> <span class="nc">RequestBody</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">callback</span><span class="p">:</span> <span class="nc">ProgressCallback</span><span class="p">,</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">RequestBody</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">contentType</span><span class="p">():</span> <span class="nc">MediaType</span><span class="p">?</span> <span class="p">=</span> <span class="n">delegate</span><span class="p">.</span><span class="nf">contentType</span><span class="p">()</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">contentLength</span><span class="p">():</span> <span class="nc">Long</span> <span class="p">=</span> <span class="n">delegate</span><span class="p">.</span><span class="nf">contentLength</span><span class="p">()</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">writeTo</span><span class="p">(</span><span class="n">sink</span><span class="p">:</span> <span class="nc">BufferedSink</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">countingSink</span> <span class="p">=</span> <span class="nc">CountingSink</span><span class="p">(</span><span class="n">sink</span><span class="p">).</span><span class="nf">buffer</span><span class="p">()</span>
        <span class="n">delegate</span><span class="p">.</span><span class="nf">writeTo</span><span class="p">(</span><span class="n">countingSink</span><span class="p">)</span>
        <span class="n">countingSink</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">inner</span> <span class="kd">class</span> <span class="nc">CountingSink</span><span class="p">(</span><span class="n">delegate</span><span class="p">:</span> <span class="nc">Sink</span><span class="p">)</span> <span class="p">:</span> <span class="nc">ForwardingSink</span><span class="p">(</span><span class="n">delegate</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">private</span> <span class="kd">val</span> <span class="py">handler</span> <span class="p">=</span> <span class="nc">Handler</span><span class="p">(</span><span class="nc">Looper</span><span class="p">.</span><span class="nf">getMainLooper</span><span class="p">())</span>
        <span class="k">private</span> <span class="kd">val</span> <span class="py">total</span> <span class="p">=</span> <span class="nf">contentLength</span><span class="p">()</span>
        <span class="k">private</span> <span class="kd">var</span> <span class="py">uploaded</span> <span class="p">=</span> <span class="mi">0L</span>

        <span class="k">override</span> <span class="k">fun</span> <span class="nf">write</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nc">Buffer</span><span class="p">,</span> <span class="n">byteCount</span><span class="p">:</span> <span class="nc">Long</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">super</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">byteCount</span><span class="p">)</span>
            <span class="n">uploaded</span> <span class="p">+=</span> <span class="n">byteCount</span>

                        <span class="n">handler</span><span class="p">.</span><span class="nf">post</span> <span class="p">{</span> <span class="n">callback</span><span class="p">.</span><span class="nf">onProgress</span><span class="p">(</span><span class="n">uploaded</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>For this improvement, we've updated our <code>ProgressCallback</code> interface to take the more meaningful <code>bytesUploaded</code> and <code>totalBytes</code> values during progress updates instead of a percentage. </p>

<p>(We also added KDoc at this point to make the interface more obvious, which you can check out <a href="https://github.com/GetStream/stream-chat-android/blob/main/stream-chat-android-client/src/main/java/io/getstream/chat/android/client/utils/ProgressCallback.kt">in the GitHub repo</a>.)<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight kotlin"><code><span class="k">public</span> <span class="kd">interface</span> <span class="nc">ProgressCallback</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">fun</span> <span class="nf">onProgress</span><span class="p">(</span><span class="n">bytesUploaded</span><span class="p">:</span> <span class="nc">Long</span><span class="p">,</span> <span class="n">totalBytes</span><span class="p">:</span> <span class="nc">Long</span><span class="p">)</span>
    <span class="k">public</span> <span class="k">fun</span> <span class="nf">onSuccess</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nc">String</span><span class="p">?)</span>
    <span class="k">public</span> <span class="k">fun</span> <span class="nf">onError</span><span class="p">(</span><span class="n">error</span><span class="p">:</span> <span class="nc">ChatError</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>On the call site, we can now create a simple <code>RequestBody</code> first, and then wrap it with the <code>ProgressRequestBody</code> implementation:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight kotlin"><code><span class="kd">val</span> <span class="py">body</span> <span class="p">=</span> <span class="n">file</span><span class="p">.</span><span class="nf">asRequestBody</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="nf">getMediaType</span><span class="p">())</span>
<span class="kd">val</span> <span class="py">progressBody</span> <span class="p">=</span> <span class="nc">ProgressRequestBody</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
<span class="kd">val</span> <span class="py">part</span> <span class="p">=</span> <span class="nc">MultipartBody</span><span class="p">.</span><span class="nc">Part</span><span class="p">.</span><span class="nf">createFormData</span><span class="p">(</span><span class="s">"file"</span><span class="p">,</span> <span class="n">file</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">progressBody</span><span class="p">)</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<h2>
  <a name="the-logging-problem" href="#the-logging-problem">
  </a>
  The Logging Problem
</h2>

<p>A major problem we encountered was that we had several interceptors added to the <code>OkHttpClient</code> that we used for these uploads. The configuration looked something like this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight kotlin"><code><span class="nf">baseClientBuilder</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">connectTimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="nc">TimeUnit</span><span class="p">.</span><span class="nc">MILLISECONDS</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">writeTimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="nc">TimeUnit</span><span class="p">.</span><span class="nc">MILLISECONDS</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">readTimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="nc">TimeUnit</span><span class="p">.</span><span class="nc">MILLISECONDS</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">addInterceptor</span><span class="p">(</span><span class="nc">ApiKeyInterceptor</span><span class="p">(</span><span class="o">..</span><span class="p">.))</span>
    <span class="p">.</span><span class="nf">addInterceptor</span><span class="p">(</span><span class="nc">HeadersInterceptor</span><span class="p">(</span><span class="o">..</span><span class="p">.))</span>
    <span class="p">.</span><span class="nf">addInterceptor</span><span class="p">(</span><span class="nc">TokenAuthInterceptor</span><span class="p">(</span><span class="o">..</span><span class="p">.))</span>
    <span class="p">.</span><span class="nf">addInterceptor</span><span class="p">(</span><span class="nc">HttpLoggingInterceptor</span><span class="p">())</span>
    <span class="p">.</span><span class="nf">addInterceptor</span><span class="p">(</span>
         <span class="nc">CurlInterceptor</span> <span class="p">{</span> <span class="n">message</span> <span class="p">-></span>
             <span class="nf">logger</span><span class="p">().</span><span class="nf">logI</span><span class="p">(</span><span class="s">"CURL"</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
         <span class="p">}</span>
    <span class="p">)</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>This is natural, and lots of apps have setups like this. What's notable here is that <code>HttpLoggingInterceptor</code> and <code>CurlInterceptor</code> will both log the request and call <code>requestBody.writeTo()</code> internally to do that. </p>

<p>In the case of our file upload calls, this method is what contains our progress tracking implementation.</p>

<p>The end result is that whenever we make an upload call, we'll run the progress callback three times in a row: twice for the logging, and once when it's actually written to the network. </p>

<p>This results in an... <em>interesting</em> experience for the user looking at the UI, where progress goes something like this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight kotlin"><code><span class="mi">0</span> <span class="mi">15</span> <span class="mi">45</span> <span class="mi">50</span> <span class="mi">100</span> <span class="mi">0</span> <span class="mi">25</span> <span class="mi">37</span> <span class="mi">57</span> <span class="mi">87</span> <span class="mi">100</span> <span class="mi">0</span> <span class="mi">20</span> <span class="mi">67</span> <span class="mi">100</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<blockquote>
<p>This only happened in debug builds, as we had the logging disabled in release builds, but it was still a problem.</p>
</blockquote>

<p>Fixing this wasn't simple, as we wanted to keep these logging interceptors around. After some elaboration, <a href="https://github.com/GetStream/stream-chat-android/pull/2342#discussion_r709018104">we begrudgingly added an ugly, ugly workaround</a>, like this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight kotlin"><code><span class="k">internal</span> <span class="kd">class</span> <span class="nc">ProgressRequestBody</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">delegate</span><span class="p">:</span> <span class="nc">RequestBody</span><span class="p">,</span> <span class="o">..</span><span class="p">.</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">RequestBody</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="py">writeCount</span> <span class="p">=</span> <span class="mi">0</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">writeTo</span><span class="p">(</span><span class="n">sink</span><span class="p">:</span> <span class="nc">BufferedSink</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">writeCount</span> <span class="p">>=</span> <span class="n">progressUpdatesToSkip</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">val</span> <span class="py">countingSink</span> <span class="p">=</span> <span class="nc">CountingSink</span><span class="p">(</span><span class="n">sink</span><span class="p">).</span><span class="nf">buffer</span><span class="p">()</span>
            <span class="n">delegate</span><span class="p">.</span><span class="nf">writeTo</span><span class="p">(</span><span class="n">countingSink</span><span class="p">)</span>
            <span class="n">countingSink</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">delegate</span><span class="p">.</span><span class="nf">writeTo</span><span class="p">(</span><span class="n">sink</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">writeCount</span><span class="p">++</span>
    <span class="p">}</span>

    <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
        <span class="k">private</span> <span class="kd">val</span> <span class="py">progressUpdatesToSkip</span> <span class="p">=</span> <span class="mi">2</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>As you can see, we simply hardcoded that the first two times when the <code>ProgressRequestBody</code> is written, it shouldn't invoke callbacks.</p>

<p>What made this worse is that this value wasn't actually <code>2</code> like I assumed, because as mentioned above, we only log with these interceptors in debug builds. </p>

<p>This meant that we had to make this a <code>var</code> and set it dynamically. In release builds it'd be <code>0</code>, and in debug builds, we'd increment it to <code>2</code>. Ouch.</p>

<p>That's bad enough, but then we also had the requirement to allow our users to set their own <code>OkHttpClient</code> instances for the SDK to use, where they could also add more interceptors of their own, which may or may not invoke <code>writeTo</code> in the request body (one or more times!). </p>

<p>We could've somehow provided an additional API where they can increment <code>progressUpdatesToSkip</code> to account for this, but then they could also have interceptors that will <em>sometimes</em> read the body but not at other times, based on some dynamic condition... There's clearly no winning with this approach, and it's an awful rabbit hole to go down.</p>

<p>So, to quote myself from the workaround PR linked above:</p>

<blockquote>
<p>A real solution would be intercepting the call with an OkHttp network interceptor, but we can't pass in individual callbacks per different Retrofit upload calls with that approach (at least not easily).</p>
</blockquote>

<p>So the problem was that we had no way to get the <code>callback</code> value from the call site that invokes the Retrofit method down to the interceptor attached to the underlying OkHttp client.</p>

<p>Turns out, thankfully, that I was wrong about that!</p>

<h2>
  <a name="okhttp-tags" href="#okhttp-tags">
  </a>
  OkHttp Tags
</h2>

<p>Enter OkHttp's <a href="https://square.github.io/okhttp/4.x/okhttp/okhttp3/-request/-builder/tag/">tags API</a> (many thanks to <a href="https://twitter.com/jessewilson">Jesse Wilson</a> for showing me this!). With this API, the library allows you to add arbitrary tags (objects) to your requests when building them. </p>

<p>As the <a href="https://square.github.io/okhttp/4.x/okhttp/okhttp3/-request/-builder/tag/">docs</a> say, you can:</p>

<blockquote>
<p>Use this API to attach timing, debugging, or other application data to a request so that you may read it in interceptors, event listeners, or callbacks.</p>
</blockquote>

<p>When building the <code>Request</code>, you can pass in a <code>Class</code> as a key and then an object of that type as the associated value:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight kotlin"><code><span class="kd">val</span> <span class="py">request</span> <span class="p">=</span> <span class="nc">Request</span><span class="p">.</span><span class="nc">Builder</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">requestBody</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">tag</span><span class="p">(</span><span class="nc">ProgressCallback</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">build</span><span class="p">()</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>And then later you can read these values from the <code>Request</code>:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight kotlin"><code><span class="kd">val</span> <span class="py">cb</span><span class="p">:</span> <span class="nc">ProgressCallback</span><span class="p">?</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">tag</span><span class="p">(</span><span class="nc">ProgressCallback</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>One small problem is that in our file upload code we create a <code>RequestBody</code> manually, but not the actual <code>Request</code> object, as that's created under the hood by Retrofit. </p>

<p>Thankfully, the tagging API is also exposed through Retrofit, so you can add tags to methods using the <a href="https://square.github.io/retrofit/2.x/retrofit/retrofit2/http/Tag.html"><code>@Tag</code> annotation</a> on parameters. We'll use this in the next section!</p>

<h2>
  <a name="the-lastinterceptorswaparoo" href="#the-lastinterceptorswaparoo">
  </a>
  The last-interceptor-swaparoo
</h2>

<p>The strategy then is the following:</p>

<ol>
<li>Add the <code>ProgressCallback</code> instance as a tag when making the Retrofit call.</li>
<li>Create an interceptor <em>at the end of the interceptor chain</em> that will check each outgoing request and wrap its <code>RequestBody</code> into a <code>ProgressRequestBody</code> if the callback is present on it.</li>
</ol>

<p>First, we'll update the Retrofit interface to accept a <code>progressCallback</code> parameter that will be used as a tag:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight kotlin"><code><span class="nd">@Multipart</span>
<span class="nd">@POST</span><span class="p">(</span><span class="s">"/channels/{type}/{id}/file"</span><span class="p">)</span>
<span class="k">fun</span> <span class="nf">sendFile</span><span class="p">(</span>
    <span class="nd">@Path</span><span class="p">(</span><span class="s">"type"</span><span class="p">)</span> <span class="n">channelType</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="nd">@Path</span><span class="p">(</span><span class="s">"id"</span><span class="p">)</span> <span class="n">channelId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="nd">@Part</span> <span class="n">file</span><span class="p">:</span> <span class="nc">MultipartBody</span><span class="p">.</span><span class="nc">Part</span><span class="p">,</span>
    <span class="nd">@Tag</span> <span class="n">progressCallback</span><span class="p">:</span> <span class="nc">ProgressCallback</span><span class="p">?,</span>
<span class="p">):</span> <span class="nc">RetrofitCall</span><span class="p">&lt;</span><span class="nc">UploadFileResponse</span><span class="p">></span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Then, we'll implement the interceptor that reads this tag and performs the wrapping of the <code>RequestBody</code> if needed:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight kotlin"><code><span class="k">internal</span> <span class="kd">class</span> <span class="nc">ProgressInterceptor</span> <span class="p">:</span> <span class="nc">Interceptor</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">intercept</span><span class="p">(</span><span class="n">chain</span><span class="p">:</span> <span class="nc">Interceptor</span><span class="p">.</span><span class="nc">Chain</span><span class="p">):</span> <span class="nc">Response</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">request</span> <span class="p">=</span> <span class="n">chain</span><span class="p">.</span><span class="nf">request</span><span class="p">()</span>

        <span class="kd">val</span> <span class="py">progressCallback</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">tag</span><span class="p">(</span><span class="nc">ProgressCallback</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">progressCallback</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">chain</span><span class="p">.</span><span class="nf">proceed</span><span class="p">(</span><span class="nf">wrapRequest</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">progressCallback</span><span class="p">))</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">chain</span><span class="p">.</span><span class="nf">proceed</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">wrapRequest</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="nc">Request</span><span class="p">,</span> <span class="n">progressCallback</span><span class="p">:</span> <span class="nc">ProgressCallback</span><span class="p">):</span> <span class="nc">Request</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">request</span><span class="p">.</span><span class="nf">newBuilder</span><span class="p">()</span>
            <span class="c1">// Assume that any request tagged with a ProgressCallback is a POST</span>
            <span class="c1">// request and has a non-null body            </span>
            <span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="nc">ProgressRequestBody</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">body</span><span class="o">!!</span><span class="p">,</span> <span class="n">progressCallback</span><span class="p">))</span>
            <span class="p">.</span><span class="nf">build</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Finally, we'll add this interceptor to our <code>OkHttpClient</code>, making sure it's the last one added. </p>

<p>We'll add it as a <a href="https://square.github.io/okhttp/interceptors/#network-interceptors">network interceptor</a>, as we want it to be as close to the actual upload as possible, and it doesn't need to be involved in requests that don't go out to the network.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight kotlin"><code><span class="k">return</span> <span class="nf">baseClientBuilder</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">addInterceptor</span><span class="p">(</span><span class="o">..</span><span class="p">.)</span>
    <span class="p">.</span><span class="nf">addInterceptor</span><span class="p">(</span><span class="o">..</span><span class="p">.)</span>
    <span class="p">.</span><span class="nf">addNetworkInterceptor</span><span class="p">(</span><span class="nc">ProgressInterceptor</span><span class="p">())</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>This way nothing that previous interceptors do with the request will interfere with the progress reporting, as they'll still have the original <code>RequestBody</code> to work with, and the special progress-tracking wrapper is only added at the very last moment before it actually goes out to the network.</p>

<p>If you want to see this last change in detail, check out <a href="https://github.com/GetStream/stream-chat-android/pull/2386">the corresponding PR on GitHub</a>.</p>

<h2>
  <a name="wrapup" href="#wrapup">
  </a>
  Wrap-Up
</h2>

<p>So that's the implementation we ended up with for now! You can find all of this code in the <a href="https://github.com/GetStream/stream-chat-android/">Chat Android SDK's GitHub repository</a> if you want to look at it in a real project.</p>

<p>There is one remaining issue with this progress tracking: Whenever the body gets written, it's only written into local buffers, and what we track is how fast we're writing to that buffer. This then still needs to make it over the network, which can take some time. </p>

<p>So the upload progress tends to get to 100% relatively quickly and then the request will remain pending for a while as the network call completes. </p>

<p>This is as close to the socket (so to say) as we can get with these APIs. For a bit more info and references, see <a href="https://github.com/GetStream/stream-chat-android/pull/2342#discussion_r709021729">this GitHub discussion</a>.</p>

<p>If you want to learn more about how Okio (and OkHttp, Retrofit, and Moshi) work super efficiently with data, watch <a href="https://www.youtube.com/watch?v=WvyScM_S88c">A Few Ok Libraries by Jake Wharton</a>. For an introduction to Moshi, check out <a href="https://zsmb.co/appearances/droidcon-london-2021/">Say Hi to Moshi</a>.</p>

</div></article> <div class="aside-username-wrapper" data-v-10d06ee8><aside class="aside-username-block" data-v-37984f8c data-v-10d06ee8><div class="username-heading loading" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-heading" data-v-37984f8c><div class="vue-content-placeholders-heading__img"></div> <div class="vue-content-placeholders-heading__content"><div class="vue-content-placeholders-heading__title"></div> <div class="vue-content-placeholders-heading__subtitle"></div></div></div></div></div> <div class="info" data-v-37984f8c><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-37984f8c><div class="vue-content-placeholders-text" data-v-37984f8c><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div></div></div></div></aside></div></div> <div class="comments-block" data-v-8c4375bc data-v-10d06ee8><!----> <a href="https://dev.to/zsmb13/adventures-in-tracking-upload-progress-with-okhttp-and-retrofit-1gff" target="_blank" rel="nofollow noopener noreferer" class="add-comment" data-v-8c4375bc>
    Add comment
  </a></div></div> <footer data-v-22cb8fd0><span data-v-22cb8fd0>Built with</span> <a href="https://nuxtjs.org" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="nuxt-icon" data-v-22cb8fd0 data-v-22cb8fd0><path d="M13.5599 8.54348L12.8055 9.87164L10.2257 5.3282L2.306 19.274H7.66815C7.66815 20.0075 8.25298 20.6021 8.97441 20.6021H2.306C1.83937 20.6021 1.40822 20.3489 1.17494 19.9379C0.941664 19.527 0.941687 19.0208 1.175 18.6099L9.09469 4.66412C9.32802 4.25316 9.75926 4 10.226 4C10.6926 4 11.1239 4.25316 11.3572 4.66412L13.5599 8.54348V8.54348Z" fill="#00C58E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M19.2769 18.6099L14.3143 9.87165L13.5599 8.54348L12.8055 9.87165L7.84343 18.6099C7.61011 19.0208 7.61009 19.527 7.84337 19.9379C8.07665 20.3489 8.50779 20.6021 8.97443 20.6021H18.1443C18.611 20.6021 19.0424 20.3491 19.2758 19.9382C19.5092 19.5272 19.5092 19.0209 19.2758 18.6099H19.2769ZM8.97443 19.274L13.5599 11.1998L18.1443 19.274H8.97443H8.97443Z" fill="#2F495E" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M22.825 19.938C22.5917 20.3489 22.1606 20.6021 21.694 20.6021H18.1443C18.8657 20.6021 19.4505 20.0075 19.4505 19.274H21.6913L15.3331 8.07696L14.3142 9.87164L13.5599 8.54348L14.2021 7.41287C14.4354 7.00192 14.8667 6.74875 15.3334 6.74875C15.8001 6.74875 16.2313 7.00192 16.4646 7.41287L22.825 18.6099C23.0583 19.0208 23.0583 19.5271 22.825 19.938V19.938Z" fill="#108775" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a> <span data-v-22cb8fd0>&</span> <a href="https://docs.dev.to/api" rel="nofollow noopener" target="_blank" data-v-22cb8fd0><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-22cb8fd0 data-v-22cb8fd0><path d="M1.5726 5.13748C1.42945 5.20622 1.2411 5.36661 1.15822 5.48117C1 5.69503 1 5.74849 1 11.8739C1 17.9993 1 18.0528 1.15822 18.2667C1.2411 18.3812 1.42945 18.5416 1.5726 18.6104C1.8137 18.7402 2.46164 18.7478 12 18.7478C21.5384 18.7478 22.1863 18.7402 22.4274 18.6104C22.5706 18.5416 22.7589 18.3812 22.8418 18.2667C23 18.0528 23 17.9993 23 11.8739C23 5.74849 23 5.69503 22.8418 5.48117C22.7589 5.36661 22.5706 5.20622 22.4274 5.13748C22.1863 5.00764 21.5384 5 12 5C2.46164 5 1.8137 5.00764 1.5726 5.13748ZM7.7055 8.2613C8.0822 8.45989 8.59454 9.0098 8.77536 9.40694C8.89589 9.66664 8.91095 9.94922 8.91095 12.0649C8.91095 14.3104 8.90344 14.4478 8.75275 14.7839C8.51919 15.288 8.16506 15.6546 7.68288 15.899C7.26096 16.1052 7.22328 16.1128 5.7315 16.1358L4.20206 16.1663V12.1031V8.04744L5.80684 8.07035C7.27602 8.09327 7.42672 8.10854 7.7055 8.2613ZM13.6952 8.89521V9.73538H12.4521H11.2089V10.4991V11.2629H11.9623H12.7158V12.1031V12.9432H11.9623H11.2089V13.707V14.4708H12.4521H13.6952V15.3109V16.151H12C10.1315 16.151 10.0411 16.1358 9.67191 15.6928L9.47603 15.4484V12.1336C9.47603 8.46752 9.46851 8.49807 9.95069 8.20783C10.1692 8.07035 10.3425 8.05508 11.9473 8.05508H13.6952V8.89521ZM16.5658 10.3769C16.8897 11.6295 17.1685 12.6912 17.176 12.7293C17.1911 12.7675 17.4699 11.7441 17.8014 10.461C18.1254 9.17017 18.4343 8.1009 18.4795 8.08563C18.5247 8.06271 18.9541 8.06271 19.4288 8.07035L20.3028 8.09327L19.376 11.6219C18.8713 13.5542 18.4117 15.2269 18.3664 15.3261C18.0123 16.0135 17.274 16.3343 16.7164 16.0441C16.4528 15.899 16.0911 15.4865 15.9705 15.1887C15.9254 15.0665 15.4884 13.4549 15.0062 11.6142C14.524 9.76593 14.1171 8.20783 14.0945 8.15437C14.0644 8.07035 14.2301 8.05508 15.0212 8.07035L15.9856 8.09327L16.5658 10.3769Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path><path d="M5.93491 12.103V14.4707H6.27394C6.66574 14.4707 7.01983 14.3103 7.1404 14.0965C7.18559 14.0048 7.21575 13.2105 7.21575 12.0648V10.1783L6.99725 9.95683C6.80133 9.76591 6.71847 9.73535 6.35683 9.73535H5.93491V12.103Z" fill="black" data-v-22cb8fd0 data-v-22cb8fd0></path></svg></a></footer></div></div></div><script>window.__NUXT__=function(s,a,n,p){return a.type_of="article",a.id=923152,a.title="Adventures in Tracking Upload Progress With OkHttp and Retrofit",a.description="This article tells the story of how Stream’s Android team refined our progress tracking process...",a.readable_publish_date="Dec 10 '21",a.slug="adventures-in-tracking-upload-progress-with-okhttp-and-retrofit-1gff",a.path="/zsmb13/adventures-in-tracking-upload-progress-with-okhttp-and-retrofit-1gff",a.url="https://dev.to/zsmb13/adventures-in-tracking-upload-progress-with-okhttp-and-retrofit-1gff",a.comments_count=1,a.public_reactions_count=41,a.collection_id=s,a.published_timestamp=n,a.positive_reactions_count=41,a.cover_image="https://res.cloudinary.com/practicaldev/image/fetch/s--6mHQlo-r--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/wt8jnffbqdogyc9wpaod.png",a.social_image="https://res.cloudinary.com/practicaldev/image/fetch/s--MPDJvsJh--/c_imagga_scale,f_auto,fl_progressive,h_500,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/wt8jnffbqdogyc9wpaod.png",a.canonical_url="https://getstream.io/blog/android-upload-progress/",a.created_at="2021-12-10T19:17:40Z",a.edited_at=s,a.crossposted_at=s,a.published_at=n,a.last_comment_at="2021-12-13T04:35:52Z",a.reading_time_minutes=9,a.tag_list="android, networking, okhttp, retrofit",a.tags=["android","networking","okhttp","retrofit"],a.body_html='<p>This article tells the story of how Stream’s Android team refined our progress tracking process during file uploads in the <a href="https://github.com/GetStream/stream-chat-android/">Stream Chat Android SDK</a>.</p>\n\n<p>Our original implementation to track file upload progress worked, but it had some in-code usability and UX issues that we wanted to clean up. </p>\n\n<p>The following account gives an up-close look into the process we had, the problems we encountered, and what we did to improve. </p>\n\n<blockquote>\n<p><strong>Warning:</strong> As this is a story of mistakes we made and then corrected over time, <strong>do not</strong> use any of the initial or intermediate forms of code here in your own projects, only the final fixed version. 😉</p>\n</blockquote>\n\n<h2>\n  <a name="uploading-files-with-retrofit" href="#uploading-files-with-retrofit">\n  </a>\n  Uploading Files With Retrofit\n</h2>\n\n<p>First things first, let\'s see how you can upload a file to an API using <a href="https://square.github.io/retrofit/">Retrofit</a>. Most APIs will expect a multipart form to contain the file data. You can declare a method inside a Retrofit interface like the one below to support that operation:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight kotlin"><code><span class="nd">@Multipart</span>\n<span class="nd">@POST</span><span class="p">(</span><span class="s">"/channels/{type}/{id}/file"</span><span class="p">)</span>\n<span class="k">fun</span> <span class="nf">sendFile</span><span class="p">(</span>\n    <span class="nd">@Path</span><span class="p">(</span><span class="s">"type"</span><span class="p">)</span> <span class="n">channelType</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>\n    <span class="nd">@Path</span><span class="p">(</span><span class="s">"id"</span><span class="p">)</span> <span class="n">channelId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>\n    <span class="nd">@Part</span> <span class="n">file</span><span class="p">:</span> <span class="nc">MultipartBody</span><span class="p">.</span><span class="nc">Part</span><span class="p">,</span>\n<span class="p">):</span> <span class="nc">RetrofitCall</span><span class="p">&lt;</span><span class="nc">UploadFileResponse</span><span class="p">&gt;</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>To invoke this method, you can create a <code>Part</code> by using the <code>createFormData</code> function, like so:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight kotlin"><code><span class="k">fun</span> <span class="nf">sendFile</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="nc">File</span><span class="p">)</span> <span class="p">{</span>\n    <span class="kd">val</span> <span class="py">part</span> <span class="p">=</span> <span class="nc">MultipartBody</span><span class="p">.</span><span class="nc">Part</span><span class="p">.</span><span class="nf">createFormData</span><span class="p">(</span><span class="s">"file"</span><span class="p">,</span> <span class="n">file</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>\n                   <span class="n">file</span><span class="p">.</span><span class="nf">asRequestBody</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="nf">getMediaType</span><span class="p">()))</span>\n    <span class="n">retrofitCdnApi</span>\n        <span class="p">.</span><span class="nf">sendFile</span><span class="p">(</span><span class="n">channelType</span><span class="p">,</span> <span class="n">channelId</span><span class="p">,</span> <span class="n">part</span><span class="p">)</span>\n        <span class="p">.</span><span class="nf">enqueue</span><span class="p">(</span><span class="o">..</span><span class="p">.)</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Then you just <code>enqueue</code> the Retrofit <code>Call</code> to run it, and done! That\'s a basic, working file upload.</p>\n\n<h2>\n  <a name="counting-in-the-request-body" href="#counting-in-the-request-body">\n  </a>\n  Counting in the Request Body\n</h2>\n\n<p>Time to add progress tracking. For our initial implementation, we used this callback interface:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight kotlin"><code><span class="k">public</span> <span class="kd">interface</span> <span class="nc">ProgressCallback</span> <span class="p">{</span>\n    <span class="k">public</span> <span class="k">fun</span> <span class="nf">onProgress</span><span class="p">(</span><span class="n">progress</span><span class="p">:</span> <span class="nc">Long</span><span class="p">)</span>\n    <span class="k">public</span> <span class="k">fun</span> <span class="nf">onSuccess</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span>\n    <span class="k">public</span> <span class="k">fun</span> <span class="nf">onError</span><span class="p">(</span><span class="n">error</span><span class="p">:</span> <span class="nc">ChatError</span><span class="p">)</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>We then created a <code>ProgressRequestBody</code> class, most likely based on <a href="https://stackoverflow.com/a/33384551/4465208">this StackOverflow answer</a>. </p>\n\n<p>This wraps a <code>file</code> and a <code>callback</code>, and implements the OkHttp <a href="https://square.github.io/okhttp/4.x/okhttp/okhttp3/-request-body/"><code>RequestBody</code></a> class.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight kotlin"><code><span class="k">internal</span> <span class="kd">class</span> <span class="nc">ProgressRequestBody</span><span class="p">(</span>\n    <span class="k">private</span> <span class="kd">val</span> <span class="py">file</span><span class="p">:</span> <span class="nc">File</span><span class="p">,</span>\n    <span class="k">private</span> <span class="kd">val</span> <span class="py">callback</span><span class="p">:</span> <span class="nc">ProgressCallback</span>\n<span class="p">)</span> <span class="p">:</span> <span class="nc">RequestBody</span><span class="p">()</span> <span class="p">{</span>\n    <span class="k">override</span> <span class="k">fun</span> <span class="nf">contentType</span><span class="p">():</span> <span class="nc">MediaType</span> <span class="p">=</span> <span class="n">file</span><span class="p">.</span><span class="nf">getMediaType</span><span class="p">()</span>\n\n    <span class="k">override</span> <span class="k">fun</span> <span class="nf">contentLength</span><span class="p">():</span> <span class="nc">Long</span> <span class="p">=</span> <span class="n">file</span><span class="p">.</span><span class="nf">length</span><span class="p">()</span>\n\n    <span class="k">override</span> <span class="k">fun</span> <span class="nf">writeTo</span><span class="p">(</span><span class="n">sink</span><span class="p">:</span> <span class="nc">BufferedSink</span><span class="p">)</span> <span class="p">{</span>\n        <span class="kd">val</span> <span class="py">total</span> <span class="p">=</span> <span class="n">file</span><span class="p">.</span><span class="nf">length</span><span class="p">()</span>\n        <span class="kd">val</span> <span class="py">buffer</span> <span class="p">=</span> <span class="nc">ByteArray</span><span class="p">(</span><span class="nc">DEFAULT_BUFFER_SIZE</span><span class="p">)</span>\n        <span class="kd">var</span> <span class="py">uploaded</span> <span class="p">=</span> <span class="mi">0L</span>\n        <span class="nc">FileInputStream</span><span class="p">(</span><span class="n">file</span><span class="p">).</span><span class="nf">use</span> <span class="p">{</span> <span class="n">fis</span> <span class="p">-&gt;</span>\n            <span class="kd">var</span> <span class="py">read</span><span class="p">:</span> <span class="nc">Int</span>\n            <span class="kd">val</span> <span class="py">handler</span> <span class="p">=</span> <span class="nc">Handler</span><span class="p">(</span><span class="nc">Looper</span><span class="p">.</span><span class="nf">getMainLooper</span><span class="p">())</span>\n            <span class="k">while</span> <span class="p">(</span><span class="n">fis</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">buffer</span><span class="p">).</span><span class="nf">also</span> <span class="p">{</span> <span class="n">read</span> <span class="p">=</span> <span class="n">it</span> <span class="p">}</span> <span class="p">!=</span> <span class="p">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>\n                <span class="n">handler</span><span class="p">.</span><span class="nf">post</span> <span class="p">{</span>\n                    <span class="n">callback</span><span class="p">.</span><span class="nf">onProgress</span><span class="p">((</span><span class="mi">100</span> <span class="p">*</span> <span class="n">uploaded</span> <span class="p">/</span> <span class="n">total</span><span class="p">))</span>\n                <span class="p">}</span>\n                <span class="n">uploaded</span> <span class="p">+=</span> <span class="n">read</span><span class="p">.</span><span class="nf">toLong</span><span class="p">()</span>\n                <span class="n">sink</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">read</span><span class="p">)</span>\n            <span class="p">}</span>\n        <span class="p">}</span>\n    <span class="p">}</span>\n\n    <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>\n        <span class="k">private</span> <span class="k">const</span> <span class="kd">val</span> <span class="py">DEFAULT_BUFFER_SIZE</span> <span class="p">=</span> <span class="mi">2048</span>\n    <span class="p">}</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Whenever <code>writeTo</code> is invoked to write this <code>RequestBody</code> to the network, we loop through the contents of the file manually, write the bytes, and invoke the <code>callback</code>, calculating the percentage of the upload completed so far.</p>\n\n<p>This requires a modification to our API invocation, as we now have to create a <code>ProgressRequestBody</code> that we then embed in our <code>Part</code>, which will — remember this — contain the <code>ProgressCallback</code> instance that was passed in.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight kotlin"><code><span class="k">fun</span> <span class="nf">sendFile</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="nc">File</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="nc">ProgressCallback</span><span class="p">)</span> <span class="p">{</span>\n    <span class="kd">val</span> <span class="py">progressBody</span> <span class="p">=</span> <span class="nc">ProgressRequestBody</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>\n    <span class="kd">val</span> <span class="py">part</span> <span class="p">=</span> <span class="nc">MultipartBody</span><span class="p">.</span><span class="nc">Part</span><span class="p">.</span><span class="nf">createFormData</span><span class="p">(</span><span class="s">"file"</span><span class="p">,</span> <span class="n">file</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">progressBody</span><span class="p">)</span>\n\n    <span class="n">retrofitCdnApi</span>\n        <span class="p">.</span><span class="nf">sendFile</span><span class="p">(</span><span class="n">channelType</span><span class="p">,</span> <span class="n">channelId</span><span class="p">,</span> <span class="n">part</span><span class="p">)</span>\n        <span class="p">.</span><span class="nf">enqueue</span><span class="p">(</span><span class="nc">RetroProgressCallback</span><span class="p">(</span><span class="n">callback</span><span class="p">))</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>We also pass the callback to the <code>enqueue</code> call via a wrapper to adapt it to a Retrofit <a href="https://square.github.io/retrofit/2.x/retrofit/retrofit2/Callback.html"><code>Callback</code></a>, which will run the <code>onFailure</code> and <code>onSuccess</code> methods of our original callback as needed.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight kotlin"><code><span class="k">internal</span> <span class="kd">class</span> <span class="nc">RetroProgressCallback</span><span class="p">(</span>\n    <span class="k">private</span> <span class="kd">val</span> <span class="py">callback</span><span class="p">:</span> <span class="nc">ProgressCallback</span>\n<span class="p">)</span> <span class="p">:</span> <span class="nc">Callback</span><span class="p">&lt;</span><span class="nc">UploadFileResponse</span><span class="p">&gt;</span> <span class="p">{</span>\n    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onFailure</span><span class="p">(</span><span class="n">call</span><span class="p">:</span> <span class="nc">Call</span><span class="p">&lt;</span><span class="nc">UploadFileResponse</span><span class="p">&gt;,</span> <span class="n">t</span><span class="p">:</span> <span class="nc">Throwable</span><span class="p">)</span> <span class="p">{</span>\n        <span class="n">callback</span><span class="p">.</span><span class="nf">onError</span><span class="p">(</span><span class="nc">ChatError</span><span class="p">(</span><span class="n">cause</span> <span class="p">=</span> <span class="n">t</span><span class="p">))</span>\n    <span class="p">}</span>\n\n    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onResponse</span><span class="p">(</span>\n        <span class="n">call</span><span class="p">:</span> <span class="nc">Call</span><span class="p">&lt;</span><span class="nc">UploadFileResponse</span><span class="p">&gt;,</span>\n        <span class="n">response</span><span class="p">:</span> <span class="n">retrofit2</span><span class="p">.</span><span class="nc">Response</span><span class="p">&lt;</span><span class="nc">UploadFileResponse</span><span class="p">&gt;</span>\n    <span class="p">)</span> <span class="p">{</span>\n        <span class="kd">val</span> <span class="py">body</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">()</span>\n        <span class="k">if</span> <span class="p">(</span><span class="n">body</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>\n            <span class="nf">onFailure</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="nc">RuntimeException</span><span class="p">(</span><span class="s">"File response is null"</span><span class="p">))</span>\n        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>\n            <span class="n">callback</span><span class="p">.</span><span class="nf">onSuccess</span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="n">file</span><span class="p">)</span>\n        <span class="p">}</span>\n    <span class="p">}</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>If you want to explore this implementation, you can find the old version of our code <a href="https://github.com/GetStream/stream-chat-android/tree/c592028765a7b541503c4a0976775cfd823c57f1/stream-chat-android-client/src/main/java/io/getstream/chat/android/client/api">here in the GitHub history</a>.</p>\n\n<h2>\n  <a name="counting-with-a-custom-sink-implementation" href="#counting-with-a-custom-sink-implementation">\n  </a>\n  Counting With a Custom Sink Implementation\n</h2>\n\n<p>This is okay, but we can make it a lot nicer. For this change, we essentially took the implementation from <a href="https://medium.com/@PaulinaSadowska/display-progress-of-multipart-request-with-retrofit-and-rxjava-23a4a779e6ba">Paulina Sadowska\'s post about the topic</a>.</p>\n\n<p>The improvement is to (instead of handling a <code>FileInputStream</code> manually) create a custom OkHttp <a href="https://square.github.io/okio/2.x/okio/okio/-sink/index.html"><code>Sink</code></a> implementation (based on the handy <a href="https://square.github.io/okio/2.x/okio/okio/-forwarding-sink/index.html"><code>ForwardingSink</code></a>), which will perform the counting and corresponding progress callbacks for us. </p>\n\n<p>We\'ll also make <code>ProgressRequestBody</code> wrap a <code>RequestBody</code> and delegate to it whenever it needs to behave like a <code>RequestBody</code>.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight kotlin"><code><span class="k">internal</span> <span class="kd">class</span> <span class="nc">ProgressRequestBody</span><span class="p">(</span>\n    <span class="k">private</span> <span class="kd">val</span> <span class="py">delegate</span><span class="p">:</span> <span class="nc">RequestBody</span><span class="p">,</span>\n    <span class="k">private</span> <span class="kd">val</span> <span class="py">callback</span><span class="p">:</span> <span class="nc">ProgressCallback</span><span class="p">,</span>\n<span class="p">)</span> <span class="p">:</span> <span class="nc">RequestBody</span><span class="p">()</span> <span class="p">{</span>\n    <span class="k">override</span> <span class="k">fun</span> <span class="nf">contentType</span><span class="p">():</span> <span class="nc">MediaType</span><span class="p">?</span> <span class="p">=</span> <span class="n">delegate</span><span class="p">.</span><span class="nf">contentType</span><span class="p">()</span>\n    <span class="k">override</span> <span class="k">fun</span> <span class="nf">contentLength</span><span class="p">():</span> <span class="nc">Long</span> <span class="p">=</span> <span class="n">delegate</span><span class="p">.</span><span class="nf">contentLength</span><span class="p">()</span>\n\n    <span class="k">override</span> <span class="k">fun</span> <span class="nf">writeTo</span><span class="p">(</span><span class="n">sink</span><span class="p">:</span> <span class="nc">BufferedSink</span><span class="p">)</span> <span class="p">{</span>\n        <span class="kd">val</span> <span class="py">countingSink</span> <span class="p">=</span> <span class="nc">CountingSink</span><span class="p">(</span><span class="n">sink</span><span class="p">).</span><span class="nf">buffer</span><span class="p">()</span>\n        <span class="n">delegate</span><span class="p">.</span><span class="nf">writeTo</span><span class="p">(</span><span class="n">countingSink</span><span class="p">)</span>\n        <span class="n">countingSink</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>\n    <span class="p">}</span>\n\n    <span class="k">private</span> <span class="k">inner</span> <span class="kd">class</span> <span class="nc">CountingSink</span><span class="p">(</span><span class="n">delegate</span><span class="p">:</span> <span class="nc">Sink</span><span class="p">)</span> <span class="p">:</span> <span class="nc">ForwardingSink</span><span class="p">(</span><span class="n">delegate</span><span class="p">)</span> <span class="p">{</span>\n        <span class="k">private</span> <span class="kd">val</span> <span class="py">handler</span> <span class="p">=</span> <span class="nc">Handler</span><span class="p">(</span><span class="nc">Looper</span><span class="p">.</span><span class="nf">getMainLooper</span><span class="p">())</span>\n        <span class="k">private</span> <span class="kd">val</span> <span class="py">total</span> <span class="p">=</span> <span class="nf">contentLength</span><span class="p">()</span>\n        <span class="k">private</span> <span class="kd">var</span> <span class="py">uploaded</span> <span class="p">=</span> <span class="mi">0L</span>\n\n        <span class="k">override</span> <span class="k">fun</span> <span class="nf">write</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nc">Buffer</span><span class="p">,</span> <span class="n">byteCount</span><span class="p">:</span> <span class="nc">Long</span><span class="p">)</span> <span class="p">{</span>\n            <span class="k">super</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">byteCount</span><span class="p">)</span>\n            <span class="n">uploaded</span> <span class="p">+=</span> <span class="n">byteCount</span>\n\n                        <span class="n">handler</span><span class="p">.</span><span class="nf">post</span> <span class="p">{</span> <span class="n">callback</span><span class="p">.</span><span class="nf">onProgress</span><span class="p">(</span><span class="n">uploaded</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span> <span class="p">}</span>\n        <span class="p">}</span>\n    <span class="p">}</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>For this improvement, we\'ve updated our <code>ProgressCallback</code> interface to take the more meaningful <code>bytesUploaded</code> and <code>totalBytes</code> values during progress updates instead of a percentage. </p>\n\n<p>(We also added KDoc at this point to make the interface more obvious, which you can check out <a href="https://github.com/GetStream/stream-chat-android/blob/main/stream-chat-android-client/src/main/java/io/getstream/chat/android/client/utils/ProgressCallback.kt">in the GitHub repo</a>.)<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight kotlin"><code><span class="k">public</span> <span class="kd">interface</span> <span class="nc">ProgressCallback</span> <span class="p">{</span>\n    <span class="k">public</span> <span class="k">fun</span> <span class="nf">onProgress</span><span class="p">(</span><span class="n">bytesUploaded</span><span class="p">:</span> <span class="nc">Long</span><span class="p">,</span> <span class="n">totalBytes</span><span class="p">:</span> <span class="nc">Long</span><span class="p">)</span>\n    <span class="k">public</span> <span class="k">fun</span> <span class="nf">onSuccess</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nc">String</span><span class="p">?)</span>\n    <span class="k">public</span> <span class="k">fun</span> <span class="nf">onError</span><span class="p">(</span><span class="n">error</span><span class="p">:</span> <span class="nc">ChatError</span><span class="p">)</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>On the call site, we can now create a simple <code>RequestBody</code> first, and then wrap it with the <code>ProgressRequestBody</code> implementation:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight kotlin"><code><span class="kd">val</span> <span class="py">body</span> <span class="p">=</span> <span class="n">file</span><span class="p">.</span><span class="nf">asRequestBody</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="nf">getMediaType</span><span class="p">())</span>\n<span class="kd">val</span> <span class="py">progressBody</span> <span class="p">=</span> <span class="nc">ProgressRequestBody</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>\n<span class="kd">val</span> <span class="py">part</span> <span class="p">=</span> <span class="nc">MultipartBody</span><span class="p">.</span><span class="nc">Part</span><span class="p">.</span><span class="nf">createFormData</span><span class="p">(</span><span class="s">"file"</span><span class="p">,</span> <span class="n">file</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">progressBody</span><span class="p">)</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<h2>\n  <a name="the-logging-problem" href="#the-logging-problem">\n  </a>\n  The Logging Problem\n</h2>\n\n<p>A major problem we encountered was that we had several interceptors added to the <code>OkHttpClient</code> that we used for these uploads. The configuration looked something like this:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight kotlin"><code><span class="nf">baseClientBuilder</span><span class="p">()</span>\n    <span class="p">.</span><span class="nf">connectTimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="nc">TimeUnit</span><span class="p">.</span><span class="nc">MILLISECONDS</span><span class="p">)</span>\n    <span class="p">.</span><span class="nf">writeTimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="nc">TimeUnit</span><span class="p">.</span><span class="nc">MILLISECONDS</span><span class="p">)</span>\n    <span class="p">.</span><span class="nf">readTimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="nc">TimeUnit</span><span class="p">.</span><span class="nc">MILLISECONDS</span><span class="p">)</span>\n    <span class="p">.</span><span class="nf">addInterceptor</span><span class="p">(</span><span class="nc">ApiKeyInterceptor</span><span class="p">(</span><span class="o">..</span><span class="p">.))</span>\n    <span class="p">.</span><span class="nf">addInterceptor</span><span class="p">(</span><span class="nc">HeadersInterceptor</span><span class="p">(</span><span class="o">..</span><span class="p">.))</span>\n    <span class="p">.</span><span class="nf">addInterceptor</span><span class="p">(</span><span class="nc">TokenAuthInterceptor</span><span class="p">(</span><span class="o">..</span><span class="p">.))</span>\n    <span class="p">.</span><span class="nf">addInterceptor</span><span class="p">(</span><span class="nc">HttpLoggingInterceptor</span><span class="p">())</span>\n    <span class="p">.</span><span class="nf">addInterceptor</span><span class="p">(</span>\n         <span class="nc">CurlInterceptor</span> <span class="p">{</span> <span class="n">message</span> <span class="p">-&gt;</span>\n             <span class="nf">logger</span><span class="p">().</span><span class="nf">logI</span><span class="p">(</span><span class="s">"CURL"</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>\n         <span class="p">}</span>\n    <span class="p">)</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>This is natural, and lots of apps have setups like this. What\'s notable here is that <code>HttpLoggingInterceptor</code> and <code>CurlInterceptor</code> will both log the request and call <code>requestBody.writeTo()</code> internally to do that. </p>\n\n<p>In the case of our file upload calls, this method is what contains our progress tracking implementation.</p>\n\n<p>The end result is that whenever we make an upload call, we\'ll run the progress callback three times in a row: twice for the logging, and once when it\'s actually written to the network. </p>\n\n<p>This results in an... <em>interesting</em> experience for the user looking at the UI, where progress goes something like this:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight kotlin"><code><span class="mi">0</span> <span class="mi">15</span> <span class="mi">45</span> <span class="mi">50</span> <span class="mi">100</span> <span class="mi">0</span> <span class="mi">25</span> <span class="mi">37</span> <span class="mi">57</span> <span class="mi">87</span> <span class="mi">100</span> <span class="mi">0</span> <span class="mi">20</span> <span class="mi">67</span> <span class="mi">100</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<blockquote>\n<p>This only happened in debug builds, as we had the logging disabled in release builds, but it was still a problem.</p>\n</blockquote>\n\n<p>Fixing this wasn\'t simple, as we wanted to keep these logging interceptors around. After some elaboration, <a href="https://github.com/GetStream/stream-chat-android/pull/2342#discussion_r709018104">we begrudgingly added an ugly, ugly workaround</a>, like this:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight kotlin"><code><span class="k">internal</span> <span class="kd">class</span> <span class="nc">ProgressRequestBody</span><span class="p">(</span>\n    <span class="k">private</span> <span class="kd">val</span> <span class="py">delegate</span><span class="p">:</span> <span class="nc">RequestBody</span><span class="p">,</span> <span class="o">..</span><span class="p">.</span>\n<span class="p">)</span> <span class="p">:</span> <span class="nc">RequestBody</span><span class="p">()</span> <span class="p">{</span>\n\n    <span class="kd">var</span> <span class="py">writeCount</span> <span class="p">=</span> <span class="mi">0</span>\n\n    <span class="k">override</span> <span class="k">fun</span> <span class="nf">writeTo</span><span class="p">(</span><span class="n">sink</span><span class="p">:</span> <span class="nc">BufferedSink</span><span class="p">)</span> <span class="p">{</span>\n        <span class="k">if</span> <span class="p">(</span><span class="n">writeCount</span> <span class="p">&gt;=</span> <span class="n">progressUpdatesToSkip</span><span class="p">)</span> <span class="p">{</span>\n            <span class="kd">val</span> <span class="py">countingSink</span> <span class="p">=</span> <span class="nc">CountingSink</span><span class="p">(</span><span class="n">sink</span><span class="p">).</span><span class="nf">buffer</span><span class="p">()</span>\n            <span class="n">delegate</span><span class="p">.</span><span class="nf">writeTo</span><span class="p">(</span><span class="n">countingSink</span><span class="p">)</span>\n            <span class="n">countingSink</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>\n        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>\n            <span class="n">delegate</span><span class="p">.</span><span class="nf">writeTo</span><span class="p">(</span><span class="n">sink</span><span class="p">)</span>\n        <span class="p">}</span>\n\n        <span class="n">writeCount</span><span class="p">++</span>\n    <span class="p">}</span>\n\n    <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>\n        <span class="k">private</span> <span class="kd">val</span> <span class="py">progressUpdatesToSkip</span> <span class="p">=</span> <span class="mi">2</span>\n    <span class="p">}</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>As you can see, we simply hardcoded that the first two times when the <code>ProgressRequestBody</code> is written, it shouldn\'t invoke callbacks.</p>\n\n<p>What made this worse is that this value wasn\'t actually <code>2</code> like I assumed, because as mentioned above, we only log with these interceptors in debug builds. </p>\n\n<p>This meant that we had to make this a <code>var</code> and set it dynamically. In release builds it\'d be <code>0</code>, and in debug builds, we\'d increment it to <code>2</code>. Ouch.</p>\n\n<p>That\'s bad enough, but then we also had the requirement to allow our users to set their own <code>OkHttpClient</code> instances for the SDK to use, where they could also add more interceptors of their own, which may or may not invoke <code>writeTo</code> in the request body (one or more times!). </p>\n\n<p>We could\'ve somehow provided an additional API where they can increment <code>progressUpdatesToSkip</code> to account for this, but then they could also have interceptors that will <em>sometimes</em> read the body but not at other times, based on some dynamic condition... There\'s clearly no winning with this approach, and it\'s an awful rabbit hole to go down.</p>\n\n<p>So, to quote myself from the workaround PR linked above:</p>\n\n<blockquote>\n<p>A real solution would be intercepting the call with an OkHttp network interceptor, but we can\'t pass in individual callbacks per different Retrofit upload calls with that approach (at least not easily).</p>\n</blockquote>\n\n<p>So the problem was that we had no way to get the <code>callback</code> value from the call site that invokes the Retrofit method down to the interceptor attached to the underlying OkHttp client.</p>\n\n<p>Turns out, thankfully, that I was wrong about that!</p>\n\n<h2>\n  <a name="okhttp-tags" href="#okhttp-tags">\n  </a>\n  OkHttp Tags\n</h2>\n\n<p>Enter OkHttp\'s <a href="https://square.github.io/okhttp/4.x/okhttp/okhttp3/-request/-builder/tag/">tags API</a> (many thanks to <a href="https://twitter.com/jessewilson">Jesse Wilson</a> for showing me this!). With this API, the library allows you to add arbitrary tags (objects) to your requests when building them. </p>\n\n<p>As the <a href="https://square.github.io/okhttp/4.x/okhttp/okhttp3/-request/-builder/tag/">docs</a> say, you can:</p>\n\n<blockquote>\n<p>Use this API to attach timing, debugging, or other application data to a request so that you may read it in interceptors, event listeners, or callbacks.</p>\n</blockquote>\n\n<p>When building the <code>Request</code>, you can pass in a <code>Class</code> as a key and then an object of that type as the associated value:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight kotlin"><code><span class="kd">val</span> <span class="py">request</span> <span class="p">=</span> <span class="nc">Request</span><span class="p">.</span><span class="nc">Builder</span><span class="p">()</span>\n    <span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">requestBody</span><span class="p">)</span>\n    <span class="p">.</span><span class="nf">tag</span><span class="p">(</span><span class="nc">ProgressCallback</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>\n    <span class="p">.</span><span class="nf">build</span><span class="p">()</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>And then later you can read these values from the <code>Request</code>:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight kotlin"><code><span class="kd">val</span> <span class="py">cb</span><span class="p">:</span> <span class="nc">ProgressCallback</span><span class="p">?</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">tag</span><span class="p">(</span><span class="nc">ProgressCallback</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>One small problem is that in our file upload code we create a <code>RequestBody</code> manually, but not the actual <code>Request</code> object, as that\'s created under the hood by Retrofit. </p>\n\n<p>Thankfully, the tagging API is also exposed through Retrofit, so you can add tags to methods using the <a href="https://square.github.io/retrofit/2.x/retrofit/retrofit2/http/Tag.html"><code>@Tag</code> annotation</a> on parameters. We\'ll use this in the next section!</p>\n\n<h2>\n  <a name="the-lastinterceptorswaparoo" href="#the-lastinterceptorswaparoo">\n  </a>\n  The last-interceptor-swaparoo\n</h2>\n\n<p>The strategy then is the following:</p>\n\n<ol>\n<li>Add the <code>ProgressCallback</code> instance as a tag when making the Retrofit call.</li>\n<li>Create an interceptor <em>at the end of the interceptor chain</em> that will check each outgoing request and wrap its <code>RequestBody</code> into a <code>ProgressRequestBody</code> if the callback is present on it.</li>\n</ol>\n\n<p>First, we\'ll update the Retrofit interface to accept a <code>progressCallback</code> parameter that will be used as a tag:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight kotlin"><code><span class="nd">@Multipart</span>\n<span class="nd">@POST</span><span class="p">(</span><span class="s">"/channels/{type}/{id}/file"</span><span class="p">)</span>\n<span class="k">fun</span> <span class="nf">sendFile</span><span class="p">(</span>\n    <span class="nd">@Path</span><span class="p">(</span><span class="s">"type"</span><span class="p">)</span> <span class="n">channelType</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>\n    <span class="nd">@Path</span><span class="p">(</span><span class="s">"id"</span><span class="p">)</span> <span class="n">channelId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>\n    <span class="nd">@Part</span> <span class="n">file</span><span class="p">:</span> <span class="nc">MultipartBody</span><span class="p">.</span><span class="nc">Part</span><span class="p">,</span>\n    <span class="nd">@Tag</span> <span class="n">progressCallback</span><span class="p">:</span> <span class="nc">ProgressCallback</span><span class="p">?,</span>\n<span class="p">):</span> <span class="nc">RetrofitCall</span><span class="p">&lt;</span><span class="nc">UploadFileResponse</span><span class="p">&gt;</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Then, we\'ll implement the interceptor that reads this tag and performs the wrapping of the <code>RequestBody</code> if needed:<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight kotlin"><code><span class="k">internal</span> <span class="kd">class</span> <span class="nc">ProgressInterceptor</span> <span class="p">:</span> <span class="nc">Interceptor</span> <span class="p">{</span>\n    <span class="k">override</span> <span class="k">fun</span> <span class="nf">intercept</span><span class="p">(</span><span class="n">chain</span><span class="p">:</span> <span class="nc">Interceptor</span><span class="p">.</span><span class="nc">Chain</span><span class="p">):</span> <span class="nc">Response</span> <span class="p">{</span>\n        <span class="kd">val</span> <span class="py">request</span> <span class="p">=</span> <span class="n">chain</span><span class="p">.</span><span class="nf">request</span><span class="p">()</span>\n\n        <span class="kd">val</span> <span class="py">progressCallback</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">tag</span><span class="p">(</span><span class="nc">ProgressCallback</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>\n        <span class="k">if</span> <span class="p">(</span><span class="n">progressCallback</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>\n            <span class="k">return</span> <span class="n">chain</span><span class="p">.</span><span class="nf">proceed</span><span class="p">(</span><span class="nf">wrapRequest</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">progressCallback</span><span class="p">))</span>\n        <span class="p">}</span>\n\n        <span class="k">return</span> <span class="n">chain</span><span class="p">.</span><span class="nf">proceed</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>\n    <span class="p">}</span>\n\n    <span class="k">private</span> <span class="k">fun</span> <span class="nf">wrapRequest</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="nc">Request</span><span class="p">,</span> <span class="n">progressCallback</span><span class="p">:</span> <span class="nc">ProgressCallback</span><span class="p">):</span> <span class="nc">Request</span> <span class="p">{</span>\n        <span class="k">return</span> <span class="n">request</span><span class="p">.</span><span class="nf">newBuilder</span><span class="p">()</span>\n            <span class="c1">// Assume that any request tagged with a ProgressCallback is a POST</span>\n            <span class="c1">// request and has a non-null body            </span>\n            <span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="nc">ProgressRequestBody</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">body</span><span class="o">!!</span><span class="p">,</span> <span class="n">progressCallback</span><span class="p">))</span>\n            <span class="p">.</span><span class="nf">build</span><span class="p">()</span>\n    <span class="p">}</span>\n<span class="p">}</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>Finally, we\'ll add this interceptor to our <code>OkHttpClient</code>, making sure it\'s the last one added. </p>\n\n<p>We\'ll add it as a <a href="https://square.github.io/okhttp/interceptors/#network-interceptors">network interceptor</a>, as we want it to be as close to the actual upload as possible, and it doesn\'t need to be involved in requests that don\'t go out to the network.<br>\n</p>\n\n<div class="highlight js-code-highlight">\n<pre class="highlight kotlin"><code><span class="k">return</span> <span class="nf">baseClientBuilder</span><span class="p">()</span>\n    <span class="p">.</span><span class="nf">addInterceptor</span><span class="p">(</span><span class="o">..</span><span class="p">.)</span>\n    <span class="p">.</span><span class="nf">addInterceptor</span><span class="p">(</span><span class="o">..</span><span class="p">.)</span>\n    <span class="p">.</span><span class="nf">addNetworkInterceptor</span><span class="p">(</span><span class="nc">ProgressInterceptor</span><span class="p">())</span>\n</code></pre>\n<div class="highlight__panel js-actions-panel">\n<div class="highlight__panel-action js-fullscreen-code-action">\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>\n    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>\n</svg>\n\n    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>\n    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>\n</svg>\n\n</div>\n</div>\n</div>\n\n\n\n<p>This way nothing that previous interceptors do with the request will interfere with the progress reporting, as they\'ll still have the original <code>RequestBody</code> to work with, and the special progress-tracking wrapper is only added at the very last moment before it actually goes out to the network.</p>\n\n<p>If you want to see this last change in detail, check out <a href="https://github.com/GetStream/stream-chat-android/pull/2386">the corresponding PR on GitHub</a>.</p>\n\n<h2>\n  <a name="wrapup" href="#wrapup">\n  </a>\n  Wrap-Up\n</h2>\n\n<p>So that\'s the implementation we ended up with for now! You can find all of this code in the <a href="https://github.com/GetStream/stream-chat-android/">Chat Android SDK\'s GitHub repository</a> if you want to look at it in a real project.</p>\n\n<p>There is one remaining issue with this progress tracking: Whenever the body gets written, it\'s only written into local buffers, and what we track is how fast we\'re writing to that buffer. This then still needs to make it over the network, which can take some time. </p>\n\n<p>So the upload progress tends to get to 100% relatively quickly and then the request will remain pending for a while as the network call completes. </p>\n\n<p>This is as close to the socket (so to say) as we can get with these APIs. For a bit more info and references, see <a href="https://github.com/GetStream/stream-chat-android/pull/2342#discussion_r709021729">this GitHub discussion</a>.</p>\n\n<p>If you want to learn more about how Okio (and OkHttp, Retrofit, and Moshi) work super efficiently with data, watch <a href="https://www.youtube.com/watch?v=WvyScM_S88c">A Few Ok Libraries by Jake Wharton</a>. For an introduction to Moshi, check out <a href="https://zsmb.co/appearances/droidcon-london-2021/">Say Hi to Moshi</a>.</p>\n\n',a.body_markdown="This article tells the story of how Stream’s Android team refined our progress tracking process during file uploads in the [Stream Chat Android SDK](https://github.com/GetStream/stream-chat-android/).\n\nOur original implementation to track file upload progress worked, but it had some in-code usability and UX issues that we wanted to clean up. \n\nThe following account gives an up-close look into the process we had, the problems we encountered, and what we did to improve. \n\n> **Warning:** As this is a story of mistakes we made and then corrected over time, **do not** use any of the initial or intermediate forms of code here in your own projects, only the final fixed version. 😉\n\n## Uploading Files With Retrofit\n\nFirst things first, let's see how you can upload a file to an API using [Retrofit](https://square.github.io/retrofit/). Most APIs will expect a multipart form to contain the file data. You can declare a method inside a Retrofit interface like the one below to support that operation: \n\n```kotlin\n@Multipart\n@POST(\"/channels/{type}/{id}/file\")\nfun sendFile(\n    @Path(\"type\") channelType: String,\n    @Path(\"id\") channelId: String,\n    @Part file: MultipartBody.Part,\n): RetrofitCall<UploadFileResponse>\n```\n\nTo invoke this method, you can create a `Part` by using the `createFormData` function, like so:\n\n```kotlin\nfun sendFile(file: File) {\n    val part = MultipartBody.Part.createFormData(\"file\", file.name,\n                   file.asRequestBody(file.getMediaType()))\n    retrofitCdnApi\n        .sendFile(channelType, channelId, part)\n        .enqueue(...)\n}\n```\n\nThen you just `enqueue` the Retrofit `Call` to run it, and done! That's a basic, working file upload.\n\n## Counting in the Request Body\n\nTime to add progress tracking. For our initial implementation, we used this callback interface:\n\n```kotlin\npublic interface ProgressCallback {\n    public fun onProgress(progress: Long)\n    public fun onSuccess(file: String)\n    public fun onError(error: ChatError)\n}\n```\n\nWe then created a `ProgressRequestBody` class, most likely based on [this StackOverflow answer](https://stackoverflow.com/a/33384551/4465208). \n\nThis wraps a `file` and a `callback`, and implements the OkHttp [`RequestBody`](https://square.github.io/okhttp/4.x/okhttp/okhttp3/-request-body/) class.\n\n```kotlin\ninternal class ProgressRequestBody(\n    private val file: File,\n    private val callback: ProgressCallback\n) : RequestBody() {\n    override fun contentType(): MediaType = file.getMediaType()\n\n    override fun contentLength(): Long = file.length()\n\n    override fun writeTo(sink: BufferedSink) {\n        val total = file.length()\n        val buffer = ByteArray(DEFAULT_BUFFER_SIZE)\n        var uploaded = 0L\n        FileInputStream(file).use { fis ->\n            var read: Int\n            val handler = Handler(Looper.getMainLooper())\n            while (fis.read(buffer).also { read = it } != -1) {\n                handler.post {\n                    callback.onProgress((100 * uploaded / total))\n                }\n                uploaded += read.toLong()\n                sink.write(buffer, 0, read)\n            }\n        }\n    }\n\n    companion object {\n        private const val DEFAULT_BUFFER_SIZE = 2048\n    }\n}\n```\n\nWhenever `writeTo` is invoked to write this `RequestBody` to the network, we loop through the contents of the file manually, write the bytes, and invoke the `callback`, calculating the percentage of the upload completed so far.\n\nThis requires a modification to our API invocation, as we now have to create a `ProgressRequestBody` that we then embed in our `Part`, which will — remember this — contain the `ProgressCallback` instance that was passed in.\n\n```kotlin\nfun sendFile(file: File, callback: ProgressCallback) {\n    val progressBody = ProgressRequestBody(file, callback)\n    val part = MultipartBody.Part.createFormData(\"file\", file.name, progressBody)\n\n    retrofitCdnApi\n        .sendFile(channelType, channelId, part)\n        .enqueue(RetroProgressCallback(callback))\n}\n```\n\nWe also pass the callback to the `enqueue` call via a wrapper to adapt it to a Retrofit [`Callback`](https://square.github.io/retrofit/2.x/retrofit/retrofit2/Callback.html), which will run the `onFailure` and `onSuccess` methods of our original callback as needed.\n\n```kotlin\ninternal class RetroProgressCallback(\n    private val callback: ProgressCallback\n) : Callback<UploadFileResponse> {\n    override fun onFailure(call: Call<UploadFileResponse>, t: Throwable) {\n        callback.onError(ChatError(cause = t))\n    }\n\n    override fun onResponse(\n        call: Call<UploadFileResponse>,\n        response: retrofit2.Response<UploadFileResponse>\n    ) {\n        val body = response.body()\n        if (body == null) {\n            onFailure(call, RuntimeException(\"File response is null\"))\n        } else {\n            callback.onSuccess(body.file)\n        }\n    }\n}\n```\n\nIf you want to explore this implementation, you can find the old version of our code [here in the GitHub history](https://github.com/GetStream/stream-chat-android/tree/c592028765a7b541503c4a0976775cfd823c57f1/stream-chat-android-client/src/main/java/io/getstream/chat/android/client/api).\n\n## Counting With a Custom Sink Implementation\n\nThis is okay, but we can make it a lot nicer. For this change, we essentially took the implementation from [Paulina Sadowska's post about the topic](https://medium.com/@PaulinaSadowska/display-progress-of-multipart-request-with-retrofit-and-rxjava-23a4a779e6ba).\n\nThe improvement is to (instead of handling a `FileInputStream` manually) create a custom OkHttp [`Sink`](https://square.github.io/okio/2.x/okio/okio/-sink/index.html) implementation (based on the handy [`ForwardingSink`](https://square.github.io/okio/2.x/okio/okio/-forwarding-sink/index.html)), which will perform the counting and corresponding progress callbacks for us. \n\nWe'll also make `ProgressRequestBody` wrap a `RequestBody` and delegate to it whenever it needs to behave like a `RequestBody`.\n\n```kotlin\ninternal class ProgressRequestBody(\n    private val delegate: RequestBody,\n    private val callback: ProgressCallback,\n) : RequestBody() {\n    override fun contentType(): MediaType? = delegate.contentType()\n    override fun contentLength(): Long = delegate.contentLength()\n\n    override fun writeTo(sink: BufferedSink) {\n        val countingSink = CountingSink(sink).buffer()\n        delegate.writeTo(countingSink)\n        countingSink.flush()\n    }\n\n    private inner class CountingSink(delegate: Sink) : ForwardingSink(delegate) {\n        private val handler = Handler(Looper.getMainLooper())\n        private val total = contentLength()\n        private var uploaded = 0L\n\n        override fun write(source: Buffer, byteCount: Long) {\n            super.write(source, byteCount)\n            uploaded += byteCount\n\n\t\t\t\t\t\thandler.post { callback.onProgress(uploaded, total) }\n        }\n    }\n}\n```\n\nFor this improvement, we've updated our `ProgressCallback` interface to take the more meaningful `bytesUploaded` and `totalBytes` values during progress updates instead of a percentage. \n\n(We also added KDoc at this point to make the interface more obvious, which you can check out [in the GitHub repo](https://github.com/GetStream/stream-chat-android/blob/main/stream-chat-android-client/src/main/java/io/getstream/chat/android/client/utils/ProgressCallback.kt).)\n\n```kotlin\npublic interface ProgressCallback {\n    public fun onProgress(bytesUploaded: Long, totalBytes: Long)\n    public fun onSuccess(url: String?)\n    public fun onError(error: ChatError)\n}\n```\n\nOn the call site, we can now create a simple `RequestBody` first, and then wrap it with the `ProgressRequestBody` implementation:\n\n```kotlin\nval body = file.asRequestBody(file.getMediaType())\nval progressBody = ProgressRequestBody(body, callback)\nval part = MultipartBody.Part.createFormData(\"file\", file.name, progressBody)\n```\n\n## The Logging Problem\n\nA major problem we encountered was that we had several interceptors added to the `OkHttpClient` that we used for these uploads. The configuration looked something like this:\n\n```kotlin\nbaseClientBuilder()\n    .connectTimeout(timeout, TimeUnit.MILLISECONDS)\n    .writeTimeout(timeout, TimeUnit.MILLISECONDS)\n    .readTimeout(timeout, TimeUnit.MILLISECONDS)\n    .addInterceptor(ApiKeyInterceptor(...))\n    .addInterceptor(HeadersInterceptor(...))\n    .addInterceptor(TokenAuthInterceptor(...))\n    .addInterceptor(HttpLoggingInterceptor())\n    .addInterceptor(\n         CurlInterceptor { message ->\n             logger().logI(\"CURL\", message)\n         }\n    )\n```\n\nThis is natural, and lots of apps have setups like this. What's notable here is that `HttpLoggingInterceptor` and `CurlInterceptor` will both log the request and call `requestBody.writeTo()` internally to do that. \n\nIn the case of our file upload calls, this method is what contains our progress tracking implementation.\n\nThe end result is that whenever we make an upload call, we'll run the progress callback three times in a row: twice for the logging, and once when it's actually written to the network. \n\nThis results in an... *interesting* experience for the user looking at the UI, where progress goes something like this:\n\n```kotlin\n0 15 45 50 100 0 25 37 57 87 100 0 20 67 100\n```\n\n> This only happened in debug builds, as we had the logging disabled in release builds, but it was still a problem.\n\nFixing this wasn't simple, as we wanted to keep these logging interceptors around. After some elaboration, [we begrudgingly added an ugly, ugly workaround](https://github.com/GetStream/stream-chat-android/pull/2342#discussion_r709018104), like this:\n\n```kotlin\ninternal class ProgressRequestBody(\n    private val delegate: RequestBody, ...\n) : RequestBody() {\n\n    var writeCount = 0\n\n    override fun writeTo(sink: BufferedSink) {\n        if (writeCount >= progressUpdatesToSkip) {\n            val countingSink = CountingSink(sink).buffer()\n            delegate.writeTo(countingSink)\n            countingSink.flush()\n        } else {\n            delegate.writeTo(sink)\n        }\n        \n        writeCount++\n    }\n\n    companion object {\n        private val progressUpdatesToSkip = 2\n    }\n}\n```\n\nAs you can see, we simply hardcoded that the first two times when the `ProgressRequestBody` is written, it shouldn't invoke callbacks.\n\nWhat made this worse is that this value wasn't actually `2` like I assumed, because as mentioned above, we only log with these interceptors in debug builds. \n\nThis meant that we had to make this a `var` and set it dynamically. In release builds it'd be `0`, and in debug builds, we'd increment it to `2`. Ouch.\n\nThat's bad enough, but then we also had the requirement to allow our users to set their own `OkHttpClient` instances for the SDK to use, where they could also add more interceptors of their own, which may or may not invoke `writeTo` in the request body (one or more times!). \n\nWe could've somehow provided an additional API where they can increment `progressUpdatesToSkip` to account for this, but then they could also have interceptors that will *sometimes* read the body but not at other times, based on some dynamic condition... There's clearly no winning with this approach, and it's an awful rabbit hole to go down.\n\nSo, to quote myself from the workaround PR linked above:\n\n> A real solution would be intercepting the call with an OkHttp network interceptor, but we can't pass in individual callbacks per different Retrofit upload calls with that approach (at least not easily).\n\nSo the problem was that we had no way to get the `callback` value from the call site that invokes the Retrofit method down to the interceptor attached to the underlying OkHttp client.\n\nTurns out, thankfully, that I was wrong about that!\n\n## OkHttp Tags\n\nEnter OkHttp's [tags API](https://square.github.io/okhttp/4.x/okhttp/okhttp3/-request/-builder/tag/) (many thanks to [Jesse Wilson](https://twitter.com/jessewilson) for showing me this!). With this API, the library allows you to add arbitrary tags (objects) to your requests when building them. \n\nAs the [docs](https://square.github.io/okhttp/4.x/okhttp/okhttp3/-request/-builder/tag/) say, you can:\n\n> Use this API to attach timing, debugging, or other application data to a request so that you may read it in interceptors, event listeners, or callbacks.\n\nWhen building the `Request`, you can pass in a `Class` as a key and then an object of that type as the associated value:\n\n```kotlin\nval request = Request.Builder()\n    .post(requestBody)\n    .tag(ProgressCallback::class.java, callback)\n    .build()\n```\n\nAnd then later you can read these values from the `Request`:\n\n```kotlin\nval cb: ProgressCallback? = request.tag(ProgressCallback::class.java)\n```\n\nOne small problem is that in our file upload code we create a `RequestBody` manually, but not the actual `Request` object, as that's created under the hood by Retrofit. \n\nThankfully, the tagging API is also exposed through Retrofit, so you can add tags to methods using the [`@Tag` annotation](https://square.github.io/retrofit/2.x/retrofit/retrofit2/http/Tag.html) on parameters. We'll use this in the next section!\n\n## The last-interceptor-swaparoo\n\nThe strategy then is the following:\n\n1. Add the `ProgressCallback` instance as a tag when making the Retrofit call.\n2. Create an interceptor *at the end of the interceptor chain* that will check each outgoing request and wrap its `RequestBody` into a `ProgressRequestBody` if the callback is present on it.\n\nFirst, we'll update the Retrofit interface to accept a `progressCallback` parameter that will be used as a tag:\n\n```kotlin\n@Multipart\n@POST(\"/channels/{type}/{id}/file\")\nfun sendFile(\n    @Path(\"type\") channelType: String,\n    @Path(\"id\") channelId: String,\n    @Part file: MultipartBody.Part,\n    @Tag progressCallback: ProgressCallback?,\n): RetrofitCall<UploadFileResponse>\n```\n\nThen, we'll implement the interceptor that reads this tag and performs the wrapping of the `RequestBody` if needed:\n\n```kotlin\ninternal class ProgressInterceptor : Interceptor {\n    override fun intercept(chain: Interceptor.Chain): Response {\n        val request = chain.request()\n\n        val progressCallback = request.tag(ProgressCallback::class.java)\n        if (progressCallback != null) {\n            return chain.proceed(wrapRequest(request, progressCallback))\n        }\n\n        return chain.proceed(request)\n    }\n\n    private fun wrapRequest(request: Request, progressCallback: ProgressCallback): Request {\n        return request.newBuilder()\n            // Assume that any request tagged with a ProgressCallback is a POST\n            // request and has a non-null body            \n            .post(ProgressRequestBody(request.body!!, progressCallback))\n            .build()\n    }\n}\n```\n\nFinally, we'll add this interceptor to our `OkHttpClient`, making sure it's the last one added. \n\nWe'll add it as a [network interceptor](https://square.github.io/okhttp/interceptors/#network-interceptors), as we want it to be as close to the actual upload as possible, and it doesn't need to be involved in requests that don't go out to the network.\n\n```kotlin\nreturn baseClientBuilder()\n    .addInterceptor(...)\n    .addInterceptor(...)\n    .addNetworkInterceptor(ProgressInterceptor())\n```\n\nThis way nothing that previous interceptors do with the request will interfere with the progress reporting, as they'll still have the original `RequestBody` to work with, and the special progress-tracking wrapper is only added at the very last moment before it actually goes out to the network.\n\nIf you want to see this last change in detail, check out [the corresponding PR on GitHub](https://github.com/GetStream/stream-chat-android/pull/2386).\n\n## Wrap-Up\n\nSo that's the implementation we ended up with for now! You can find all of this code in the [Chat Android SDK's GitHub repository](https://github.com/GetStream/stream-chat-android/) if you want to look at it in a real project.\n\nThere is one remaining issue with this progress tracking: Whenever the body gets written, it's only written into local buffers, and what we track is how fast we're writing to that buffer. This then still needs to make it over the network, which can take some time. \n\nSo the upload progress tends to get to 100% relatively quickly and then the request will remain pending for a while as the network call completes. \n\nThis is as close to the socket (so to say) as we can get with these APIs. For a bit more info and references, see [this GitHub discussion](https://github.com/GetStream/stream-chat-android/pull/2342#discussion_r709021729).\n\nIf you want to learn more about how Okio (and OkHttp, Retrofit, and Moshi) work super efficiently with data, watch [A Few Ok Libraries by Jake Wharton](https://www.youtube.com/watch?v=WvyScM_S88c). For an introduction to Moshi, check out [Say Hi to Moshi](https://zsmb.co/appearances/droidcon-london-2021/).\n",a.user={name:"Márton Braun",username:p,twitter_username:p,github_username:s,website_url:"https://zsmb.co/",profile_image:"https://res.cloudinary.com/practicaldev/image/fetch/s---cKEDUW6--/c_fill,f_auto,fl_progressive,h_640,q_auto,w_640/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/573503/8c864b9c-99a5-441e-bb89-7612b1391357.png",profile_image_90:"https://res.cloudinary.com/practicaldev/image/fetch/s---S6YA-il--/c_fill,f_auto,fl_progressive,h_90,q_auto,w_90/https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/573503/8c864b9c-99a5-441e-bb89-7612b1391357.png"},{layout:"default",data:[{}],fetch:{"data-v-70afb46a:0":{article:a}},error:s,state:{currentArticle:a},serverRendered:!0,routePath:"/zsmb13/923152",config:{_app:{basePath:"/nuxtstop/",assetsPath:"/nuxtstop/_nuxt/",cdnURL:s}}}}(null,{},"2021-12-10T19:19:09Z","zsmb13")</script><script src="/nuxtstop/_nuxt/f6e87fb.js" defer></script><script src="/nuxtstop/_nuxt/dc9ce94.js" defer></script><script src="/nuxtstop/_nuxt/6474719.js" defer></script><script src="/nuxtstop/_nuxt/9b75090.js" defer></script><script src="/nuxtstop/_nuxt/18df600.js" defer></script>
  </body>
</html>
